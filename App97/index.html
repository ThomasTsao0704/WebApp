<!DOCTYPE html><html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>每日個股選股器（單檔本機版）</title>
<meta name="description" content="離線本機使用的台股每日篩選器。載入 CSV 後可依條件過濾、排序、查看走勢，並可儲存自訂條件。">
<style>
  :root { --bg:#0b1020; --fg:#e9eef7; --muted:#a9b6d6; --card:#121831; --accent:#7aa2ff; --ok:#2ecc71; --warn:#f39c12; --bad:#e74c3c; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial; background:var(--bg); color:var(--fg)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,16,32,.98),rgba(11,16,32,.7));backdrop-filter: blur(8px);border-bottom:1px solid #1d2442}
  .wrap{max-width:1280px;margin:0 auto;padding:14px 16px}
  h1{font-size:20px;margin:0 0 8px 0;letter-spacing:.4px}
  .toolbar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:end}
  .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
  .controls > label{display:flex;flex-direction:column;gap:6px;background:var(--card);border:1px solid #1d2442;border-radius:12px;padding:8px 10px;color:var(--fg)}
  input,select,button{font:inherit}
  input,select{background:#121a36;border:1px solid #2b345b;color:var(--fg);border-radius:10px;padding:8px 10px}
  button{cursor:pointer;border:1px solid #273157;background:#1a2140;border-radius:10px;padding:8px 12px;color:var(--fg)}
  button.primary{background:linear-gradient(180deg,#1f4fff,#0e37c9);border-color:#0e37c9;color:white}
  button.ghost{background:transparent;border-color:#33406c}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
  .card{background:var(--card);border:1px solid #1d2442;border-radius:16px;padding:12px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #33406c;background:#121a36;color:var(--muted)}
  .mt6{margin-top:6px} .mt8{margin-top:8px} .mt12{margin-top:12px} .mt16{margin-top:16px}
  .sticky{position:sticky;top:84px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 6px;border-bottom:1px dashed #263055;text-align:right;white-space:nowrap}
  th{position:sticky;top:0;background:#151c39;z-index:1; user-select:none; cursor:pointer}
  td.left,th.left{text-align:left}
  tr:hover{background:#151c39}
  .pos{color:var(--ok)} .neg{color:var(--bad)}
  .kv{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  .kv > label{display:flex;gap:6px;align-items:center;justify-content:space-between;background:#121a36;border:1px solid #2b345b;border-radius:10px;padding:8px}
  .kv input{width:90px}
  .switch{display:flex;align-items:center;gap:8px}
  .switch input{width:auto}
  .badge{border:1px solid #2b345b;background:#0f1631;border-radius:999px;font-size:12px;padding:2px 8px;color:var(--muted)}
  footer{opacity:.75;padding:20px 0;text-align:center;font-size:12px}
  @media (max-width: 1100px){ .grid{grid-template-columns:1fr} .sticky{position:static} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>每日個股選股器（單檔本機版）</h1>
    <div class="toolbar">
      <div class="controls">
        <label>載入 CSV<input id="file" type="file" accept=".csv" /></label>
        <label>關鍵字（代碼/商品）<input id="q" type="text" placeholder="如：2330 或 台積電" /></label>
        <label>日期（起）<input id="d1" type="date" /></label>
        <label>日期（迄）<input id="d2" type="date" /></label>
      </div>
      <div class="row">
        <button id="btn-strong" class="ghost" title="漲跌幅≥%、量≥、且收盤>均價[1+2+3]">強勢股</button>
        <button id="btn-break" class="ghost" title="收盤 ≥ 52H價 × 0.98">近高突破</button>
        <button id="btn-reset" class="ghost">重置條件</button>
        <button id="btn-save" class="ghost">儲存條件</button>
        <button id="btn-load" class="ghost">載入條件</button>
        <button id="btn-export" class="primary">匯出結果 CSV</button>
      </div>
      <div class="row mt6 hint">使用方式：選擇含「代碼、商品、Date、收盤價、漲跌幅、成交量、內盤量、外盤量、52H價、均價[...]」欄位的每日 CSV。可拖曳檔案到頁面。</div>
    </div><div class="row mt12">
  <div class="kv" style="flex:1">
    <label><span>漲跌幅 ≥ %</span><input id="chgMin" type="number" step="0.1" placeholder="例如 2"></label>
    <label><span>成交量 ≥</span><input id="volMin" type="number" step="100" placeholder="例如 500"></label>
    <label><span>外盤比 ≥</span><input id="buyRatioMin" type="number" step="0.01" placeholder="0.6 表 60%"></label>
    <label><span>收盤 ≥</span><input id="closeMin" type="number" step="0.01" placeholder="最低價"></label>
    <label><span>收盤 ≤</span><input id="closeMax" type="number" step="0.01" placeholder="最高價"></label>
    <label style="grid-column:1/-1"><span>自訂欄位（區間）</span>
      <span>
        <select id="colSel" style="min-width:220px"></select>
        介於 <input id="colMin" type="number" step="0.01" style="width:100px"> ～ <input id="colMax" type="number" step="0.01" style="width:100px">
      </span>
    </label>
  </div>
  <div class="card" style="min-width:280px">
    <div class="switch"><input type="checkbox" id="chkBull" /><label for="chkBull">多頭排列：收盤價 ＞ 均價[1] ＞ 均價[1+2] ＞ 均價[1+2+3]</label></div>
    <div class="switch mt8"><input type="checkbox" id="chkLastOnly" checked /><label for="chkLastOnly">每檔只取最近一日（預設）</label></div>
    <div class="mt8 hint">可同時勾選條件，表格可點欄位標題排序。</div>
  </div>
</div>

  </div>
</header><div class="wrap grid">
  <section class="card" aria-label="結果表格">
    <div class="row">
      <div class="pill">結果 <span id="count">0</span> 檔</div>
      <div class="pill">資料列 <span id="rows">0</span></div>
      <div class="pill">日期範圍 <span id="range">—</span></div>
      <div class="badge" id="note"></div>
    </div>
    <div class="mt12" style="overflow:auto; max-height: 70vh;">
      <table id="tbl"><thead></thead><tbody></tbody></table>
    </div>
  </section>  <aside class="card sticky" aria-label="走勢圖">
    <h3 style="margin:0 0 8px 0">走勢圖（點表格某檔）</h3>
    <canvas id="chartPrice" height="240" aria-label="價格與成交量"></canvas>
    <div class="hint mt8">顯示選中個股之「收盤價」與「成交量」。</div>
  </aside>
</div><footer>Made for 本機離線分析 · 建議以乾淨表頭的 CSV 載入 · v2</footer><script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script><script>
let raw = [];      // 原始資料列（CSV 全部）
let byCode = {};   // 依代碼分組
let header = [];   // 欄位
let chart;         // Chart.js 實例

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

function parseNumber(x){
  if (x===null || x===undefined) return null;
  if (typeof x === 'number') return isFinite(x)?x:null;
  let s = (''+x).replace(/[ ,%]/g,'').trim();
  if (!s || s==='-' || s.toLowerCase()==='nan') return null;
  const v = Number(s);
  return isFinite(v) ? v : null;
}

function toDate(s){
  if(!s) return null;
  if (s instanceof Date) return s;
  const str = String(s).trim();
  if(/^\d{8}$/.test(str)) return new Date(str.slice(0,4)+'-'+str.slice(4,6)+'-'+str.slice(6,8));
  if(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(str)) return new Date(str);
  const d = new Date(str);
  return isNaN(d.getTime()) ? null : d;
}

function guessDateKey(cols){
  const keys = ['Date','日期','交易日期'];
  for (const k of keys){
    const m = cols.find(c => c && c.toLowerCase().includes(k.toLowerCase()));
    if (m) return m;
  }
  return cols.find(c=>/date|日/.test(c?.toLowerCase?.()||'')) || cols[0];
}

function calcDerived(row){
  const o = Object.assign({}, row);
  const inVol = parseNumber(row['內盤量']);
  const outVol = parseNumber(row['外盤量']);
  if (inVol!=null || outVol!=null){
    const a = (inVol||0)+(outVol||0);
    o['外盤比'] = a>0 ? (outVol||0)/a : null;
  }
  const hi52 = parseNumber(row['52H價']);
  const close = parseNumber(row['收盤價']);
  if (hi52!=null && close!=null){
    o['距離52H%'] = (close/hi52-1)*100;
  }
  return o;
}

function renderTable(rows){
  const thead = $('#tbl thead'), tbody = $('#tbl tbody');
  thead.innerHTML = ''; tbody.innerHTML='';
  if (!rows.length) return;

  const fixed = ['代碼','商品','Date','收盤價','漲跌幅','成交量','外盤比','距離52H%'];
  const extra = header.filter(h => !fixed.includes(h));
  const cols = [...fixed, ...extra];

  const tr = document.createElement('tr');
  for (const h of cols){
    const th = document.createElement('th');
    th.textContent = h; th.className = (h==='代碼'||h==='商品')?'left':'';
    th.onclick = () => {
      const dir = th.dataset.dir==='asc'?'desc':'asc';
      rows.sort((a,b)=>{
        const av = parseNumber(a[h]);
        const bv = parseNumber(b[h]);
        if (av==null && bv==null){
          const as = String(a[h]??''); const bs = String(b[h]??'');
          return dir==='asc'? as.localeCompare(bs, 'zh-Hant') : bs.localeCompare(as, 'zh-Hant');
        }
        const A = av ?? -1e15, B = bv ?? -1e15;
        return dir==='asc'? A-B : B-A;
      });
      th.dataset.dir = dir;
      renderTable(rows);
    };
    tr.appendChild(th);
  }
  thead.appendChild(tr);

  for (const r of rows){
    const tr = document.createElement('tr');
    tr.onclick = ()=> showChart(r['代碼']);
    for (const h of cols){
      const td = document.createElement('td');
      let v = r[h];
      if (h==='代碼'||h==='商品') td.className='left';
      if (h==='漲跌幅' || h==='距離52H%'){
        const nv = parseNumber(v); td.classList.add(nv>=0?'pos':'neg');
        v = nv==null? '': nv.toFixed(2)+'%';
      }
      if (h==='外盤比'){
        const nv = parseNumber(v); v = nv==null? '': (nv*100).toFixed(1)+'%';
      }
      td.textContent = v==null? '' : v;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function showChart(code){
  const dk = guessDateKey(header);
  const list = (byCode[code]||[]).slice().sort((a,b)=> toDate(a[dk]) - toDate(b[dk]));
  const labels = list.map(d => d[dk]);
  const closes = list.map(d => parseNumber(d['收盤價']));
  const vols = list.map(d => parseNumber(d['成交量']));

  const ctx = $('#chartPrice').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[ {label:`${code} 收盤價`, data:closes, yAxisID:'y'}, {label:`${code} 成交量`, data:vols, yAxisID:'y1'} ] },
    options:{ responsive:true, interaction:{mode:'index',intersect:false}, stacked:false, plugins:{legend:{display:true}}, scales:{ y:{type:'linear', position:'left'}, y1:{type:'linear', position:'right', grid:{drawOnChartArea:false}} } }
  });
}

function updateStats(rows){
  $('#rows').text(raw.length.toLocaleString());
  $('#count').text(new Set(rows.map(r=>r['代碼'])).size);
  const dk = guessDateKey(header);
  const dates = raw.map(r => toDate(r[dk])).filter(Boolean).sort((a,b)=>a-b);
  if (dates.length){
    const min = dates[0], max = dates[dates.length-1];
    const fmt = d => d.toISOString().slice(0,10);
    $('#range').text(`${fmt(min)} ~ ${fmt(max)}`);
  } else $('#range').text('—');
}

function afterRenderPostFilters(){
  // 後置條件：強勢股 / 近高突破 / 多頭排列
  const tbody = $('#tbl tbody');
  const rows = [...tbody.querySelectorAll('tr')];
  const ths = [...$('#tbl thead th')];
  const idxBy = (name) => ths.findIndex(th => th.textContent===name || th.textContent.includes(name));

  // 多頭排列（收盤 > MA1 > MA12 > MA123）
  if ($('#chkBull').checked){
    const ixC = idxBy('收盤價');
    const ix1 = idxBy('均價[1]');
    const ix12 = idxBy('均價[1+2]');
    const ix123 = idxBy('均價[1+2+3]');
    if (ixC>-1 && ix1>-1 && ix12>-1 && ix123>-1){
      rows.forEach(tr=>{
        const c = parseNumber(tr.children[ixC].textContent);
        const m1 = parseNumber(tr.children[ix1].textContent);
        const m12 = parseNumber(tr.children[ix12].textContent);
        const m123 = parseNumber(tr.children[ix123].textContent);
        if (!(c>m1 && m1>m12 && m12>m123)) tr.remove();
      });
    }
  }
}

function applyFilters(){
  if (!raw.length) return;
  const q = $('#q').value.trim();
  const d1 = $('#d1').value ? new Date($('#d1').value) : null;
  const d2 = $('#d2').value ? new Date($('#d2').value) : null;
  const chgMin = parseNumber($('#chgMin').value);
  const volMin = parseNumber($('#volMin').value);
  const cMin = parseNumber($('#closeMin').value);
  const cMax = parseNumber($('#closeMax').value);
  const brMin = parseNumber($('#buyRatioMin').value);
  const col = $('#colSel').value;
  const colMin = parseNumber($('#colMin').value);
  const colMax = parseNumber($('#colMax').value);
  const lastOnly = $('#chkLastOnly').checked;

  const dk = guessDateKey(header);
  let rows = [];
  if (lastOnly){
    const mapLatest = new Map();
    for (const r of raw){
      const code = r['代碼'];
      const dt = toDate(r[dk]);
      const ex = mapLatest.get(code);
      if (!ex || (dt && dt>ex._dt)){
        const rr = calcDerived(r); rr._dt = dt; mapLatest.set(code, rr);
      }
    }
    rows = [...mapLatest.values()];
  } else {
    rows = raw.map(calcDerived);
  }

  rows = rows.filter(r=>{
    if (q){
      const s = (String(r['代碼']||'')+' '+String(r['商品']||'')).toLowerCase();
      if (!s.includes(q.toLowerCase())) return false;
    }
    const dt = r._dt ?? toDate(r[dk]);
    if (d1 && dt && dt<d1) return false;
    if (d2 && dt && dt>d2) return false;
    if (chgMin!=null){ const v = parseNumber(r['漲跌幅']); if (!(v!=null && v>=chgMin)) return false; }
    if (volMin!=null){ const v = parseNumber(r['成交量']); if (!(v!=null && v>=volMin)) return false; }
    if (cMin!=null || cMax!=null){
      const v = parseNumber(r['收盤價']);
      if (cMin!=null && !(v!=null && v>=cMin)) return false;
      if (cMax!=null && !(v!=null && v<=cMax)) return false;
    }
    if (brMin!=null){ const v = parseNumber(r['外盤比']); if (!(v!=null && v>=brMin)) return false; }
    if (col && (colMin!=null || colMax!=null)){
      const v = parseNumber(r[col]);
      if (colMin!=null && !(v!=null && v>=colMin)) return false;
      if (colMax!=null && !(v!=null && v<=colMax)) return false;
    }
    return true;
  });

  // 預設排序：漲跌幅 由大到小
  rows.sort((a,b)=> (parseNumber(b['漲跌幅'])??-1e12) - (parseNumber(a['漲跌幅'])??-1e12));

  updateStats(rows);
  renderTable(rows);
  afterRenderPostFilters();
  $('#note').textContent = lastOnly? '以最新一日為主' : '顯示所有日期資料列';
}

function loadCSV(file){
  Papa.parse(file, {
    header:true,
    skipEmptyLines:true,
    transformHeader: h => (h||'').replace(/\ufeff/g,'').trim(),
    complete: (res)=>{
      raw = res.data.map(r=>{
        if (r['Date']===undefined && r['日期']!==undefined) r['Date']=r['日期'];
        return r;
      }).filter(r => r['代碼'] && r['商品']);
      header = res.meta.fields.filter(Boolean);

      // 填入自訂欄位選單
      const sel = $('#colSel'); sel.innerHTML='';
      header.forEach(h => {
        if (!['代碼','商品','Date','日期'].includes(h)){
          const opt = document.createElement('option'); opt.value=h; opt.textContent=h; sel.appendChild(opt);
        }
      });

      // 建 byCode
      byCode = {};
      const dk = guessDateKey(header);
      for (const r of raw){
        const code = r['代碼']; if (!byCode[code]) byCode[code]=[]; byCode[code].push(r);
        r._dt = toDate(r[dk]);
      }

      // 估日期範圍
      const dates = raw.map(r => r._dt).filter(Boolean).sort((a,b)=>a-b);
      if (dates.length){
        $('#d1').value = dates[Math.max(0, dates.length-60)].toISOString().slice(0,10);
        $('#d2').value = dates[dates.length-1].toISOString().slice(0,10);
      }

      applyFilters();
    }
  });
}

$('#file').addEventListener('change', e=>{ if (e.target.files?.length) loadCSV(e.target.files[0]); });
$('#q,#d1,#d2,#chgMin,#volMin,#closeMin,#closeMax,#buyRatioMin,#colSel,#colMin,#colMax,#chkBull,#chkLastOnly').forEach?.call($$('input,select'), el => {
  el.addEventListener('input', applyFilters);
});

// 快捷條件
$('#btn-strong').onclick = () => {
  if ($('#chgMin').value==='') $('#chgMin').value='2';
  if ($('#volMin').value==='') $('#volMin').value='500';
  $('#chkBull').checked = false; // 預設不強制多頭排列
  // 收盤價 > 均價[1+2+3] 以後置檢查實作：先渲染再篩
  applyFilters();
  const ths = [...$('#tbl thead th')];
  const ixClose = ths.findIndex(th => th.textContent==='收盤價');
  const ixMA = ths.findIndex(th => th.textContent.includes('均價[1+2+3]'));
  if (ixClose>-1 && ixMA>-1){
    const rows = [...$('#tbl tbody tr')];
    rows.forEach(tr => {
      const c = parseNumber(tr.children[ixClose]?.textContent);
      const m = parseNumber(tr.children[ixMA]?.textContent);
      if (!(c!=null && m!=null && c>m)) tr.remove();
    });
  }
};
$('#btn-break').onclick = () => {
  applyFilters();
  const ths = [...$('#tbl thead th')];
  const ixClose = ths.findIndex(th=>th.textContent==='收盤價');
  const ix52 = ths.findIndex(th=>th.textContent.includes('52H價'));
  if (ixClose>-1 && ix52>-1){
    const rows = [...$('#tbl tbody tr')];
    rows.forEach(tr=>{
      const c = parseNumber(tr.children[ixClose]?.textContent);
      const h = parseNumber(tr.children[ix52]?.textContent);
      if (!(c!=null && h!=null && c >= h*0.98)) tr.remove();
    });
  }
};
$('#btn-reset').onclick = () => {
  $$('#q,#d1,#d2,#chgMin,#volMin,#closeMin,#closeMax,#buyRatioMin,#colMin,#colMax').forEach(i=> i.value='');
  $('#chkBull').checked=false; $('#chkLastOnly').checked=true; applyFilters();
};

// 儲存/載入條件（localStorage）
function currentFilters(){
  return {
    q:$('#q').value, d1:$('#d1').value, d2:$('#d2').value,
    chgMin:$('#chgMin').value, volMin:$('#volMin').value,
    closeMin:$('#closeMin').value, closeMax:$('#closeMax').value,
    buyRatioMin:$('#buyRatioMin').value,
    colSel:$('#colSel').value, colMin:$('#colMin').value, colMax:$('#colMax').value,
    bull:$('#chkBull').checked, lastOnly:$('#chkLastOnly').checked
  };
}
function applySaved(f){
  if (!f) return;
  $('#q').value=f.q||''; $('#d1').value=f.d1||''; $('#d2').value=f.d2||'';
  $('#chgMin').value=f.chgMin||''; $('#volMin').value=f.volMin||'';
  $('#closeMin').value=f.closeMin||''; $('#closeMax').value=f.closeMax||'';
  $('#buyRatioMin').value=f.buyRatioMin||'';
  // colSel 必須等 CSV 載入後才有選項，如無則略過
  if ($('#colSel').options.length){ $('#colSel').value=f.colSel||''; }
  $('#colMin').value=f.colMin||''; $('#colMax').value=f.colMax||'';
  $('#chkBull').checked=!!f.bull; $('#chkLastOnly').checked=!!f.lastOnly;
}
$('#btn-save').onclick = () => {
  const name = prompt('儲存為條件名稱（例如：強勢＋近高）：');
  if (!name) return;
  const all = JSON.parse(localStorage.getItem('stock_filters')||'{}');
  all[name] = currentFilters();
  localStorage.setItem('stock_filters', JSON.stringify(all));
  alert('已儲存：'+name);
};
$('#btn-load').onclick = () => {
  const all = JSON.parse(localStorage.getItem('stock_filters')||'{}');
  const names = Object.keys(all);
  if (!names.length){ alert('尚無已儲存的條件'); return; }
  const name = prompt('輸入要載入的條件名稱\n可用：\n- '+names.join('\n- '));
  if (!name || !all[name]) return;
  applySaved(all[name]);
  applyFilters();
};

// 匯出結果 CSV（取目前畫面表格資料）
$('#btn-export').onclick = () => {
  const ths = [...$('#tbl thead th')].map(th=>th.textContent);
  const rows = [...$('#tbl tbody tr')].map(tr=> [...tr.children].map(td=> td.textContent));
  if (!rows.length){ alert('目前沒有可匯出的結果'); return; }
  let csv = ths.join(',') + '\n' + rows.map(r => r.map(x => '"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='選股結果.csv'; a.click();
  URL.revokeObjectURL(url);
};

// 拖曳上傳
window.addEventListener('dragover', e=>{e.preventDefault();});
window.addEventListener('drop', e=>{ e.preventDefault(); if (e.dataTransfer.files?.length) loadCSV(e.dataTransfer.files[0]); });
</script></body>
</html>
