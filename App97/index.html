<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>股票選股分析器（含多檔比較＋策略）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js + time adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold text-gray-800 mb-8 flex items-center gap-3">
      <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
      </svg>
      股票選股分析器
    </h1>

    <!-- 上傳 -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <label class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg p-8 cursor-pointer hover:border-blue-500 transition-colors">
        <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
        </svg>
        <span class="text-gray-600 mb-1">上傳股票數據檔</span>
        <span class="text-sm text-gray-400">支援 Tab/逗號分隔、含引號欄位</span>
        <input type="file" id="fileInput" accept=".csv,.txt" class="hidden">
      </label>
      <p id="uploadStatus" class="mt-4 text-center text-green-600 font-medium hidden"></p>
      <p id="uploadError" class="mt-2 text-center text-red-600 font-medium hidden"></p>
    </div>

    <!-- 篩選 + 策略 -->
    <div id="filterSection" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
          </svg>
          選股條件設定
        </h2>
        <div class="flex items-center gap-2">
          <input id="q" type="text" placeholder="搜尋代碼/商品關鍵字…" class="w-64 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          <button id="exportBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium">匯出篩選結果 CSV</button>
        </div>
      </div>

      <!-- 基本條件 -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">最低收盤價</label>
          <input type="number" id="minPrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如: 50">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">最高收盤價</label>
          <input type="number" id="maxPrice" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如: 200">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">最低漲跌幅 (%)</label>
          <input type="number" id="minChange" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如: 5">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">最高漲跌幅 (%)</label>
          <input type="number" id="maxChange" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如: -3">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">最低成交量</label>
          <input type="number" id="minVolume" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如: 1000">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">最低振幅 (%)</label>
          <input type="number" id="minAmplitude" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="例如: 3">
        </div>
      </div>

      <!-- 策略條件（可複選） -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">策略條件（可多選組合）</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="st_maBull" class="scale-110">均線多頭排列：SMA5 &gt; SMA10 &gt; SMA20</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="st_volUp" class="scale-110">放量上漲：漲幅&gt;0 且 量&gt;20日均量×1.5</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="st_break52h" class="scale-110">突破 52H：距離52H ≥ 0%</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" id="st_golden" class="scale-110">黃金交叉：EMA12 &gt; EMA26（當日）</label>
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">排序方式</label>
        <select id="sortBy" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="code">股票代碼（小→大）</option>
          <option value="change">漲跌幅（高→低）</option>
          <option value="volume">成交量（高→低）</option>
          <option value="amplitude">振幅（高→低）</option>
          <option value="price">收盤價（高→低）</option>
          <option value="value">成交金額（高→低）</option>
          <option value="dist52h">距離52H%（高→低）</option>
        </select>
      </div>

      <div class="flex gap-3 mt-4">
        <button id="applyBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">套用篩選</button>
        <button id="resetBtn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium">重置條件</button>
      </div>
    </div>

    <!-- 比較區 -->
    <div id="compareSection" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"></path>
          </svg>
          比較清單（Ctrl＋點擊表格列可加入，最多 5 檔）
        </h2>
        <div class="text-sm text-gray-500">提示：再次 Ctrl＋點擊同一檔可移除</div>
      </div>

      <!-- 圖表控制列 -->
      <div class="flex flex-col lg:flex-row gap-3 items-start lg:items-center justify-between mb-3">
        <div id="compareList" class="flex flex-wrap gap-2"></div>
        <div class="flex flex-wrap items-center gap-3">
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">圖表尺度</span>
            <select id="scaleMode" class="px-2 py-1 border rounded">
              <option value="close">收盤價</option>
              <option value="norm">基準化 100</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">主圖標的</span>
            <select id="primaryCode" class="px-2 py-1 border rounded min-w-[7rem]">
              <option value="">（自動）</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">疊圖指標</span>
            <label class="inline-flex items-center gap-1 text-sm"><input id="ov_sma" type="checkbox" class="scale-110">SMA(5/10/20)</label>
            <label class="inline-flex items-center gap-1 text-sm"><input id="ov_ema" type="checkbox" class="scale-110">EMA(12/26)</label>
            <label class="inline-flex items-center gap-1 text-sm"><input id="ov_bb" type="checkbox" class="scale-110">布林(20,2)</label>
          </div>
        </div>
      </div>

      <div class="mt-4 relative" style="height: 360px;">
        <canvas id="compareChart"></canvas>
      </div>
    </div>

    <!-- 結果 -->
    <div id="resultSection" class="bg-white rounded-xl shadow-lg p-6 hidden">
      <div class="flex items-end justify-between gap-3 mb-4">
        <h2 id="resultTitle" class="text-xl font-bold text-gray-800"></h2>
        <div id="summary" class="text-sm text-gray-500"></div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b-2 border-gray-200">
              <th class="px-4 py-3 text-left font-semibold text-gray-700">代碼</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">商品</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-700">收盤價</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-700">漲跌幅</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-700">振幅</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-700">成交量</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-700">成交金額</th>
              <th class="px-4 py-3 text-right font-semibold text-gray-700">距離52H%</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== 工具 =====
    const $ = (id) => document.getElementById(id);
    const fmtInt = (n) => Number.isFinite(n) ? Math.round(n).toLocaleString() : '';
    const fmtMoney = (n) => Number.isFinite(n) ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '';
    const fmtPrice = (n) => Number.isFinite(n) ? n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
    const fmtPct = (n) => (Number.isFinite(n) ? (n.toFixed(2) + '%') : '');

    function normalizeNumericString(s = '') {
      const map = { '０': '0', '１': '1', '２': '2', '３': '3', '４': '4', '５': '5', '６': '6', '７': '7', '８': '8', '９': '9', '．': '.', '，': ',' };
      s = String(s).trim().replace(/[０-９．，]/g, ch => map[ch] ?? ch);
      s = s.replace(/,/g, '').replace(/％/g, '%');
      return s;
    }
    function toNumber(s) {
      if (s === null || s === undefined) return NaN;
      s = normalizeNumericString(s);
      if (/%$/.test(s)) s = s.replace('%', '');
      const v = parseFloat(s);
      return Number.isFinite(v) ? v : NaN;
    }
    function escapeHtml(s = '') {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
    function parseDate(d) {
      if (!d) return null;
      const s = String(d).trim().replace(/[.]/g, '-').replace(/\//g, '-');
      const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (!m) return null;
      const [_, y, mo, da] = m;
      const dt = new Date(Number(y), Number(mo) - 1, Number(da));
      return isNaN(+dt) ? null : dt;
    }

    const COLOR_POOL = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f'];

    const HEADER_ALIASES = {
      '代碼': ['代碼','股票代碼','股票代號','證券代號','Code','code'],
      '商品': ['商品','名稱','證券名稱','公司','Name','name'],
      '收盤價': ['收盤價','收盤','收盤(元)','Close','close','收盤價(元)'],
      '漲跌幅': ['漲跌幅','漲跌(%)','漲幅%','漲跌幅%','Change%','pct_change','漲幅'],
      '振幅': ['振幅','振幅%','Amplitude%','amplitude'],
      '成交量': ['成交量','成交股數','Volume','volume'],
      '成交金額(元)': ['成交金額(元)','成交金額','成交金額元','Value','金額','成交金額(千)'],
      '日期': ['日期','Date','date','交易日','時間'],
      '52H價': ['52H價','52週高','52週最高','52W High','52WH','52WHigh']
    };
    function buildHeaderMap(headers) {
      const map = {};
      for (const std in HEADER_ALIASES) {
        const aliases = HEADER_ALIASES[std].map(s => s.toLowerCase());
        const hitIdx = headers.findIndex(h => aliases.includes(String(h).toLowerCase()));
        if (hitIdx >= 0) map[std] = headers[hitIdx];
      }
      return map;
    }

    // === CSV/TSV ===
    function detectDelimiter(sampleText) {
      const line = sampleText.split(/\r?\n/).find(x => x.trim()) || '';
      return (line.includes('\t')) ? '\t' : ',';
    }
    function parseDelimited(text, delimiter) {
      const lines = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
      const rows = [];
      for (const line of lines) {
        if (!line.trim()) continue;
        const out = [];
        let cur = '', inQuotes = false;
        for (let i=0;i<line.length;i++){
          const ch=line[i];
          if (ch === '"'){
            if (inQuotes && line[i+1] === '"'){ cur+='"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if (ch===delimiter && !inQuotes){
            out.push(cur); cur='';
          } else {
            cur+=ch;
          }
        }
        out.push(cur);
        rows.push(out.map(s=>s.trim()));
      }
      return rows;
    }

    // === 狀態 ===
    let rawRows = [];
    let stockData = [];         // 每列(日)一筆：含 rolling 計算欄位
    let filteredData = [];
    let keyMap = {};
    let seriesByCode = new Map();  // code -> [{t,y,vol,name,origRowRef}]
    let compareSet = new Set();    // 最多 5 檔
    let colorByCode = new Map();
    let chart;
    let scaleMode = 'close';       // 'close' | 'norm'

    // DOM
    const fileInput = $('fileInput');
    const uploadStatus = $('uploadStatus');
    const uploadError = $('uploadError');
    const filterSection = $('filterSection');
    const resultSection = $('resultSection');
    const compareSection = $('compareSection');
    const resultTitle = $('resultTitle');
    const resultBody = $('resultBody');
    const summary = $('summary');
    const primaryCodeSel = $('primaryCode');

    // ===== Rolling & 指標 =====
    function SMA(arr, w){
      const out = Array(arr.length).fill(NaN);
      let sum=0;
      for (let i=0;i<arr.length;i++){
        const v = arr[i];
        sum += Number.isFinite(v)?v:0;
        if (i>=w) sum -= Number.isFinite(arr[i-w])?arr[i-w]:0;
        if (i>=w-1){
          // 若窗口內含 NaN 太多會失真，這裡簡化為遇到 NaN 當 0；可再強化
          out[i] = sum / w;
        }
      }
      return out;
    }
    function EMA(arr, w){
      const out = Array(arr.length).fill(NaN);
      const k = 2/(w+1);
      let prev = NaN;
      for (let i=0;i<arr.length;i++){
        const v = arr[i];
        if (!Number.isFinite(v)) { out[i]=Number.NaN; continue; }
        if (!Number.isFinite(prev)) prev = v;  // 起始用當前值
        prev = v * k + prev * (1-k);
        out[i] = prev;
      }
      return out;
    }
    function BB(arr, w=20, m=2){
      // 以 SMA 為中軌，標準差為帶寬
      const out = { mid:Array(arr.length).fill(NaN), upper:Array(arr.length).fill(NaN), lower:Array(arr.length).fill(NaN) };
      const mid = SMA(arr, w);
      for (let i=0;i<arr.length;i++){
        if (i<w-1 || !Number.isFinite(mid[i])) continue;
        let sum=0, sum2=0, n=0;
        for (let j=i-w+1;j<=i;j++){
          const v=arr[j]; if(!Number.isFinite(v)) continue;
          sum += v; sum2 += v*v; n++;
        }
        if (n>=2){
          const mean = sum/n;
          const sd = Math.sqrt(Math.max(0, (sum2/n - mean*mean)));
          out.mid[i]=mid[i];
          out.upper[i]=mid[i]+m*sd;
          out.lower[i]=mid[i]-m*sd;
        }
      }
      return out;
    }

    function sum(arr){ return arr.reduce((a,b)=>a+(Number.isFinite(b)?b:0),0); }
    function avg(arr){ const v=arr.filter(Number.isFinite); return v.length?sum(v)/v.length:0; }

    // === 上傳處理 ===
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      uploadError.classList.add('hidden'); uploadError.textContent = '';

      try {
        const text = await file.text();
        const delimiter = detectDelimiter(text);
        const rows = parseDelimited(text, delimiter);
        rawRows = rows.filter(r => r.some(c => String(c).trim() !== ''));

        // 找表頭
        let headerRowIdx = 0;
        let headers = [];
        for (let i=0;i<Math.min(8,rawRows.length);i++){
          const cols = rawRows[i].map(s=>s.trim());
          if (cols.some(c=>/收盤價|漲跌幅|代碼|名稱|成交量|Close|Volume/i.test(c))){
            headerRowIdx=i; headers=cols; break;
          }
        }
        if (!headers.length){ headers = rawRows[0].map(s=>s.trim()); headerRowIdx=0; }

        keyMap = buildHeaderMap(headers);

        // 轉成物件列
        const dataRows = rawRows.slice(headerRowIdx+1);
        stockData = dataRows.map(r=>{
          const obj={};
          const get = (stdKey) => {
            const original = keyMap[stdKey];
            if (!original) return '';
            const idx = headers.indexOf(original);
            return r[idx] ?? '';
          };
          obj['代碼']=get('代碼');
          obj['商品']=get('商品');
          obj['收盤價']=toNumber(get('收盤價'));
          obj['漲跌幅']=toNumber(get('漲跌幅'));
          obj['振幅']=toNumber(get('振幅'));
          obj['成交量']=toNumber(get('成交量'));
          let v=get('成交金額(元)'); let val=toNumber(v);
          if (/千/.test(String(keyMap['成交金額(元)']||'')) && Number.isFinite(val)) val*=1000;
          obj['成交金額(元)']=val;
          obj['日期']=get('日期');
          obj['日期Date']=parseDate(obj['日期']);
          const h52 = toNumber(get('52H價'));
          obj['52H價']=Number.isFinite(h52)?h52:NaN;
          obj['距離52H%']=(Number.isFinite(obj['收盤價']) && Number.isFinite(obj['52H價']) && obj['52H價']>0)
            ? ((obj['收盤價']/obj['52H價']-1)*100) : NaN;
          return obj;
        }).filter(x=>x['代碼'] || Number.isFinite(x['收盤價']));

        // 建立 timeseries 與 rolling 指標
        seriesByCode = new Map();
        const byCode = new Map();
        for (const row of stockData){
          const code = String(row['代碼']||'').trim();
          if (!code) continue;
          if (!(row['日期Date'] instanceof Date)) continue;
          if (!Number.isFinite(row['收盤價'])) continue;
          if (!byCode.has(code)) byCode.set(code, []);
          byCode.get(code).push(row);
        }
        // 逐檔排序並計算 rolling
        for (const [code, arr] of byCode){
          arr.sort((a,b)=>a['日期Date']-b['日期Date']);
          const closes = arr.map(x=>x['收盤價']);
          const vols   = arr.map(x=>Number.isFinite(x['成交量'])?x['成交量']:NaN);

          const sma5 = SMA(closes,5);
          const sma10= SMA(closes,10);
          const sma20= SMA(closes,20);
          const ema12= EMA(closes,12);
          const ema26= EMA(closes,26);
          const vma20= SMA(vols,20);
          const bb20 = BB(closes,20,2);

          for (let i=0;i<arr.length;i++){
            arr[i]['SMA5']=sma5[i];
            arr[i]['SMA10']=sma10[i];
            arr[i]['SMA20']=sma20[i];
            arr[i]['EMA12']=ema12[i];
            arr[i]['EMA26']=ema26[i];
            arr[i]['VOL_MA20']=vma20[i];
            arr[i]['BB_MID']=bb20.mid[i];
            arr[i]['BB_UP']=bb20.upper[i];
            arr[i]['BB_LO']=bb20.lower[i];
            // 黃金交叉旗標（當日狀態）；更嚴謹可檢查前一日相對關係變化
            arr[i]['GOLDEN'] = Number.isFinite(ema12[i]) && Number.isFinite(ema26[i]) && ema12[i] > ema26[i];
          }

          // 建圖用序列
          seriesByCode.set(code, arr.map(x=>({
            t: x['日期Date'], y: x['收盤價'], vol: x['成交量'], name: x['商品']||code, ref:x
          })));
        }

        filteredData = stockData.slice();

        uploadStatus.textContent = `✓ 已載入 ${stockData.length} 列（偵測分隔符：${delimiter === '\t' ? 'Tab' : '逗號'}，可 Ctrl＋點擊表格列加入比較）`;
        uploadStatus.classList.remove('hidden');
        filterSection.classList.remove('hidden');
        compareSection.classList.remove('hidden');
        $('q').value = '';
        compareSet.clear(); colorByCode.clear();
        refreshPrimarySelect();
        displayResults();
        renderCompareList();
        initOrUpdateChart();
      } catch(err){
        console.error(err);
        uploadError.textContent = '檔案讀取或解析失敗：' + (err?.message || err);
        uploadError.classList.remove('hidden');
      }
    });

    // === 基本操作 ===
    $('applyBtn').addEventListener('click', applyFilters);
    $('resetBtn').addEventListener('click', () => {
      ['minPrice','maxPrice','minChange','maxChange','minVolume','minAmplitude'].forEach(id=>$(id).value='');
      ['st_maBull','st_volUp','st_break52h','st_golden'].forEach(id=>$(id).checked=false);
      $('sortBy').value='code';
      $('q').value='';
      filteredData = stockData.slice();
      displayResults();
    });
    $('q').addEventListener('input', ()=>applyFilters(false));
    $('exportBtn').addEventListener('click', exportCSV);

    $('sortBy').addEventListener('change', ()=>{ sortNow(); displayResults(); });

    $('scaleMode').addEventListener('change', (e)=>{ scaleMode=e.target.value; initOrUpdateChart(); });
    $('ov_sma').addEventListener('change', ()=>initOrUpdateChart());
    $('ov_ema').addEventListener('change', ()=>initOrUpdateChart());
    $('ov_bb').addEventListener('change', ()=>initOrUpdateChart());
    $('primaryCode').addEventListener('change', ()=>initOrUpdateChart());

    // === 篩選含策略 ===
    function applyFilters(reSort=true){
      const minPrice = toNumber($('minPrice').value);
      const maxPrice = toNumber($('maxPrice').value);
      const minChange= toNumber($('minChange').value);
      const maxChange= toNumber($('maxChange').value);
      const minVolume= toNumber($('minVolume').value);
      const minAmplitude= toNumber($('minAmplitude').value);
      const q = $('q').value.trim();

      const st_maBull = $('st_maBull').checked;
      const st_volUp  = $('st_volUp').checked;
      const st_break52h = $('st_break52h').checked;
      const st_golden = $('st_golden').checked;

      filteredData = stockData.filter(s=>{
        if (q){
          const hay = `${s['代碼']||''} ${s['商品']||''}`.toLowerCase();
          if (!hay.includes(q.toLowerCase())) return false;
        }
        if (Number.isFinite(minPrice) && !(s['收盤價'] >= minPrice)) return false;
        if (Number.isFinite(maxPrice) && !(s['收盤價'] <= maxPrice)) return false;
        if (Number.isFinite(minChange)&& !(s['漲跌幅'] >= minChange)) return false;
        if (Number.isFinite(maxChange)&& !(s['漲跌幅'] <= maxChange)) return false;
        if (Number.isFinite(minVolume)&& !(s['成交量'] >= minVolume)) return false;
        if (Number.isFinite(minAmplitude)&& !(s['振幅'] >= minAmplitude)) return false;

        // 策略條件（AND 組合）
        if (st_maBull){
          const ok = Number.isFinite(s['SMA5']) && Number.isFinite(s['SMA10']) && Number.isFinite(s['SMA20']) && (s['SMA5']>s['SMA10'] && s['SMA10']>s['SMA20']);
          if (!ok) return false;
        }
        if (st_volUp){
          const ok = Number.isFinite(s['漲跌幅']) && s['漲跌幅']>0
                  && Number.isFinite(s['成交量']) && Number.isFinite(s['VOL_MA20'])
                  && s['成交量'] > s['VOL_MA20']*1.5;
          if (!ok) return false;
        }
        if (st_break52h){
          if (!(Number.isFinite(s['距離52H%']) && s['距離52H%']>=0)) return false;
        }
        if (st_golden){
          const ok = s['GOLDEN']===true;
          if (!ok) return false;
        }

        return true;
      });

      if (reSort) sortNow();
      displayResults();
    }

    function sortNow(){
      const sortBy = $('sortBy').value;
      filteredData.sort((a,b)=>{
        switch(sortBy){
          case 'change': return (b['漲跌幅'] ?? -Infinity) - (a['漲跌幅'] ?? -Infinity);
          case 'volume': return (b['成交量'] ?? -Infinity) - (a['成交量'] ?? -Infinity);
          case 'amplitude': return (b['振幅'] ?? -Infinity) - (a['振幅'] ?? -Infinity);
          case 'price': return (b['收盤價'] ?? -Infinity) - (a['收盤價'] ?? -Infinity);
          case 'value': return (b['成交金額(元)'] ?? -Infinity) - (a['成交金額(元)'] ?? -Infinity);
          case 'dist52h': return (b['距離52H%'] ?? -Infinity) - (a['距離52H%'] ?? -Infinity);
          default: return String(a['代碼']||'').localeCompare(String(b['代碼']||''), 'zh-Hant-u-nu-hanidec');
        }
      });
    }

    function displayResults(){
      resultSection.classList.remove('hidden');
      const count = filteredData.length;
      resultTitle.textContent = `篩選結果（${count} 列）`;

      const pos = filteredData.filter(x=> (x['漲跌幅']??0) > 0).length;
      const neg = filteredData.filter(x=> (x['漲跌幅']??0) < 0).length;
      const avgChg = avg(filteredData.map(x=>x['漲跌幅'])).toFixed(2);
      const totVol = sum(filteredData.map(x=>x['成交量']));
      const totVal = sum(filteredData.map(x=>x['成交金額(元)']));
      summary.textContent = `上漲：${pos}、下跌：${neg}、平均漲跌幅：${avgChg}%、合計量：${fmtInt(totVol)}、合計金額：${fmtMoney(totVal)}`;

      resultBody.innerHTML = filteredData.map(stock=>{
        const code = stock['代碼'] ?? '';
        const name = stock['商品'] ?? '';
        const price= fmtPrice(stock['收盤價']);
        const chg  = stock['漲跌幅'];
        const amp  = stock['振幅'];
        const vol  = fmtInt(stock['成交量']);
        const val  = fmtMoney(stock['成交金額(元)']);
        const dist52 = stock['距離52H%'];

        const changeColor = Number.isFinite(chg) ? (chg>0?'text-red-600':(chg<0?'text-green-600':'text-gray-600')) : 'text-gray-400';
        const iconUp = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>';
        const iconDown = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>';
        const trendIcon = Number.isFinite(chg)?(chg>0?iconUp:(chg<0?iconDown:'')):'';
        const selected = compareSet.has(code) ? 'bg-blue-50' : '';

        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${selected}" data-code="${escapeHtml(code)}">
            <td class="px-4 py-3 font-medium">${escapeHtml(code)}</td>
            <td class="px-4 py-3">${escapeHtml(name)}</td>
            <td class="px-4 py-3 text-right">${price||''}</td>
            <td class="px-4 py-3 text-right font-medium ${changeColor}">
              <div class="flex items-center justify-end gap-1">${trendIcon}${Number.isFinite(chg)?fmtPct(chg):''}</div>
            </td>
            <td class="px-4 py-3 text-right">${Number.isFinite(amp)?fmtPct(amp):''}</td>
            <td class="px-4 py-3 text-right">${vol}</td>
            <td class="px-4 py-3 text-right">${val}</td>
            <td class="px-4 py-3 text-right ${Number.isFinite(dist52)?(dist52>=0?'text-red-600':'text-green-600'):'text-gray-400'}">
              ${Number.isFinite(dist52)?fmtPct(dist52):''}
            </td>
          </tr>`;
      }).join('');

      // Ctrl+點擊加入/移除比較
      resultBody.onclick = (ev)=>{
        const tr = ev.target.closest('tr[data-code]'); if(!tr) return;
        if (!ev.ctrlKey) return;
        const code = tr.getAttribute('data-code');
        toggleCompare(code);
      };
    }

    function exportCSV(){
      if (!filteredData.length) return;
      const headers = ['代碼','商品','收盤價','漲跌幅','振幅','成交量','成交金額(元)','距離52H%','日期','52H價','SMA5','SMA10','SMA20','EMA12','EMA26','VOL_MA20'];
      const lines=[headers.join(',')];
      for (const r of filteredData){
        const row = [
          r['代碼']??'',
          r['商品']??'',
          Number.isFinite(r['收盤價'])?r['收盤價']:'',
          Number.isFinite(r['漲跌幅'])?r['漲跌幅']:'',
          Number.isFinite(r['振幅'])?r['振幅']:'',
          Number.isFinite(r['成交量'])?r['成交量']:'',
          Number.isFinite(r['成交金額(元)'])?r['成交金額(元)']:'',
          Number.isFinite(r['距離52H%'])?r['距離52H%']:'',
          r['日期']??'',
          Number.isFinite(r['52H價'])?r['52H價']:'',
          r['SMA5']??'',
          r['SMA10']??'',
          r['SMA20']??'',
          r['EMA12']??'',
          r['EMA26']??'',
          r['VOL_MA20']??'',
        ].map(val=>{
          const s=String(val??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
        }).join(',');
        lines.push(row);
      }
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='filtered_stocks.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // === 比較清單 ===
    function toggleCompare(code){
      if (!code) return;
      if (compareSet.has(code)) compareSet.delete(code);
      else {
        if (compareSet.size >= 5){ alert('比較清單最多 5 檔。請先移除部分標的。'); return; }
        compareSet.add(code);
        if (!colorByCode.has(code)){
          const used = new Set([...colorByCode.values()]);
          const color = COLOR_POOL.find(c=>!used.has(c)) || COLOR_POOL[compareSet.size % COLOR_POOL.length];
          colorByCode.set(code,color);
        }
      }
      renderCompareList();
      refreshPrimarySelect();
      highlightSelectedRows();
      initOrUpdateChart();
    }

    function highlightSelectedRows(){
      document.querySelectorAll('#resultBody tr[data-code]').forEach(tr=>{
        const code = tr.getAttribute('data-code');
        tr.classList.toggle('bg-blue-50', compareSet.has(code));
      });
    }

    function renderCompareList(){
      const wrap = $('compareList');
      wrap.innerHTML = '';
      if (compareSet.size === 0){
        wrap.innerHTML = `<span class="text-gray-500 text-sm">尚未選擇標的。請在下方表格「按住 Ctrl 並點擊」列來加入。</span>`;
        return;
      }
      for (const code of compareSet){
        const color = colorByCode.get(code)||'#1f77b4';
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 px-3 py-1 rounded-full border';
        div.style.borderColor = color;
        div.innerHTML = `
          <span class="inline-block w-3 h-3 rounded-full" style="background:${color}"></span>
          <span class="font-medium">${escapeHtml(code)}</span>
          <button class="text-xs px-2 py-0.5 rounded bg-gray-100 hover:bg-gray-200" data-act="toggle" data-code="${escapeHtml(code)}">顯示/隱藏</button>
          <button class="text-xs px-2 py-0.5 rounded bg-red-100 text-red-700 hover:bg-red-200" data-act="remove" data-code="${escapeHtml(code)}">移除</button>
        `;
        wrap.appendChild(div);
      }
      wrap.onclick = (ev)=>{
        const btn = ev.target.closest('button[data-act]'); if(!btn) return;
        const act = btn.getAttribute('data-act'); const code = btn.getAttribute('data-code');
        if (act==='remove'){
          compareSet.delete(code);
          renderCompareList();
          refreshPrimarySelect();
          highlightSelectedRows();
          initOrUpdateChart();
        } else if (act==='toggle'){
          if (!chart) return;
          const ds = chart.data.datasets.find(d=>d.label===code);
          if (ds){ ds.hidden = !ds.hidden; chart.update(); }
        }
      };
    }

    function refreshPrimarySelect(){
      const sel = primaryCodeSel;
      const cur = sel.value;
      sel.innerHTML = `<option value="">（自動）</option>` + [...compareSet].map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      // 保留原選擇
      if (cur && compareSet.has(cur)) sel.value = cur; else sel.value = '';
    }

    // === 圖表 ===
    function initOrUpdateChart(){
      const ctx = $('compareChart').getContext('2d');
      const datasets = [];

      // 收盤線
      for (const code of compareSet){
        const arr = seriesByCode.get(code)||[];
        if (!arr.length) continue;
        const color = colorByCode.get(code)||'#1f77b4';
        let data = arr.map(p=>({ x:p.t, y:p.y }));
        if (scaleMode==='norm'){
          // 以該檔「第一筆有價」為 100
          const first = data.find(d=>Number.isFinite(d.y));
          if (first){
            const base = first.y;
            data = data.map(d=>({ x:d.x, y: Number.isFinite(d.y)? d.y/base*100 : NaN }));
          }
        }
        datasets.push({
          label: code, data, borderColor: color, backgroundColor: color, fill:false,
          tension:0.15, pointRadius:0, borderWidth:2
        });
      }

      // 疊圖指標：僅主圖標的
      const ovSMA = $('ov_sma').checked;
      const ovEMA = $('ov_ema').checked;
      const ovBB  = $('ov_bb').checked;
      const primary = primaryCodeSel.value || [...compareSet][0];
      if (primary){
        const arr = seriesByCode.get(primary)||[];
        if (arr.length){
          // 取對應序列
          const closes = arr.map(p=>p.ref['收盤價']);
          const dates  = arr.map(p=>p.t);
          const addLine = (label, series, dash=[6,4])=>{
            let data = series.map((y,i)=>({x:dates[i], y}));
            if (scaleMode==='norm'){
              const first = closes.find(v=>Number.isFinite(v));
              const base = first;
              if (Number.isFinite(base)){
                data = series.map((v,i)=>({x:dates[i], y: Number.isFinite(v)? v/base*100 : NaN}));
              }
            }
            datasets.push({
              label: `${primary} ${label}`,
              data, borderColor:'#444', borderDash:dash, pointRadius:0, borderWidth:1.5, fill:false
            });
          };
          if (ovSMA){
            const s5 = arr.map(p=>p.ref['SMA5']);
            const s10= arr.map(p=>p.ref['SMA10']);
            const s20= arr.map(p=>p.ref['SMA20']);
            addLine('SMA5', s5, [4,3]);
            addLine('SMA10',s10,[8,4]);
            addLine('SMA20',s20,[12,4]);
          }
          if (ovEMA){
            const e12= arr.map(p=>p.ref['EMA12']);
            const e26= arr.map(p=>p.ref['EMA26']);
            addLine('EMA12', e12, [2,2]);
            addLine('EMA26', e26, [10,3]);
          }
          if (ovBB){
            const mid= arr.map(p=>p.ref['BB_MID']);
            const up = arr.map(p=>p.ref['BB_UP']);
            const lo = arr.map(p=>p.ref['BB_LO']);
            addLine('BB_mid', mid, [1,0]); // 實線
            datasets[datasets.length-1].borderWidth = 1;
            addLine('BB_up', up, [5,3]);
            addLine('BB_lo', lo, [5,3]);
          }
        }
      }

      const yTitle = (scaleMode==='close')?'收盤價':'基準化（=100）';

      const config = {
        type:'line',
        data:{ datasets },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{ type:'time', time:{ unit:'day', tooltipFormat:'yyyy-MM-dd' }, ticks:{ maxRotation:0, autoSkip:true }},
            y:{ title:{ display:true, text:yTitle }, ticks:{ beginAtZero:false } }
          },
          plugins:{
            legend:{ position:'top' },
            tooltip:{
              mode:'nearest', intersect:false,
              callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${fmtPrice(ctx.parsed.y)}` }
            }
          }
        }
      };
      if (!chart){ chart = new Chart(ctx, config); }
      else { chart.data = config.data; chart.options=scalesOptionsTo(config.options); chart.update(); }
    }
    // 小工具：複製 options 給既有圖（避免直接重綁物件參照）
    function scalesOptionsTo(opt){ return JSON.parse(JSON.stringify(opt)); }

    // 初始化可視區塊
    (function ensureSections(){ resultSection.classList.remove('hidden'); compareSection.classList.remove('hidden'); })();

  </script>
</body>
</html>
