<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£ä¸Šå¸‚æ«ƒå…¬å¸ç‡Ÿæ”¶åˆ†æ App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            padding: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .search-controls {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        select, button {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.875rem;
            outline: none;
        }

        select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #2563eb;
        }

        .chart-container {
            margin: 24px 0;
            height: 400px;
            position: relative;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .search-controls {
                flex-direction: column;
            }
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .analysis-value {
            font-weight: 600;
        }

        .positive {
            color: #059669;
        }

        .negative {
            color: #dc2626;
        }

        .sparkline {
            display: flex;
            align-items: end;
            gap: 1px;
            height: 20px;
            margin-top: 4px;
        }

        .sparkline-bar {
            flex: 1;
            min-width: 2px;
            background-color: #3b82f6;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th, td {
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            text-align: center;
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        .year-cell {
            background-color: #f3f4f6;
            font-weight: bold;
            vertical-align: middle;
        }

        .total-cell {
            background-color: #f3f4f6;
            font-weight: bold;
        }

        .growth-positive {
            color: #059669;
            font-size: 0.75rem;
        }

        .growth-negative {
            color: #dc2626;
            font-size: 0.75rem;
        }

        .mini-chart {
            display: flex;
            align-items: end;
            gap: 1px;
            height: 24px;
            margin-top: 4px;
        }

        .mini-bar {
            flex: 1;
            min-width: 2px;
            background-color: #f97316;
        }

        .no-data {
            color: #9ca3af;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .subsection-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1d4ed8;
            margin-bottom: 8px;
        }

        .yearly-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .yearly-sparkline {
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card header">
            <h1>ğŸ“Š å°ç£ä¸Šå¸‚æ«ƒå…¬å¸ç‡Ÿæ”¶åˆ†æ App</h1>
            <div class="search-controls">
                <div class="control-group">
                    <label>ğŸ” é¸æ“‡å…¬å¸ï¼š</label>
                    <select id="companySelect">
                        <option value="2330">2330 - å°ç©é›»</option>
                        <option value="2303">2303 - è¯é›»</option>
                        <option value="2454">2454 - è¯ç™¼ç§‘</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ğŸ“… æ™‚é–“å€é–“ï¼š</label>
                    <select id="dateRangeSelect">
                        <option value="6">è¿‘6å€‹æœˆ</option>
                        <option value="12">è¿‘1å¹´</option>
                        <option value="24">è¿‘2å¹´</option>
                        <option value="36">è¿‘3å¹´</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ç‡Ÿæ”¶åœ–è¡¨ -->
        <div class="card">
            <h2 class="section-title">ğŸ“ˆ <span id="companyName">å°ç©é›»</span> æœˆç‡Ÿæ”¶è¶¨å‹¢</h2>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- æˆé•·åˆ†æèˆ‡ç´¯ç©ç¸½è¨ˆ -->
        <div class="grid">
            <!-- æˆé•·åˆ†æ -->
            <div class="card">
                <h3 class="section-title">ğŸ“Š æˆé•·åˆ†æ</h3>
                <div id="analysisData">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </div>
            </div>

            <!-- ç´¯ç©ç¸½è¨ˆåˆ†æ -->
            <div class="card">
                <h3 class="section-title">ğŸ“ˆ ç´¯ç©ç¸½è¨ˆåˆ†æ</h3>
                <div>
                    <h4 class="subsection-title" id="accumulatedTitle">å¹´åº¦ç´¯ç©ç¸½è¨ˆ</h4>
                    <div id="yearlyAccumulated">
                        <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </div>
                </div>
                <hr style="margin: 16px 0;">
                <div class="analysis-item">
                    <span>ç•¶å¹´åº¦ç¸½è¨ˆï¼š</span>
                    <span class="analysis-value" style="color: #1d4ed8; font-size: 1.125rem;" id="currentYearTotal">
                        <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                    </span>
                </div>
            </div>
        </div>

        <!-- è©³ç´°ç‡Ÿæ”¶åˆ†æè¡¨æ ¼ -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 class="section-title" style="margin-bottom: 0;">ğŸ“‹ è©³ç´°ç‡Ÿæ”¶åˆ†æè¡¨æ ¼</h3>
                <button onclick="exportCSV()">ğŸ”½ åŒ¯å‡º CSV</button>
            </div>
            <div class="table-container">
                <table id="detailedTable">
                    <!-- å‹•æ…‹ç”Ÿæˆå…§å®¹ -->
                </table>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ“¬è³‡æ–™
        const mockData = {
            "2330": {
                "ä»£ç¢¼": "2330",
                "å…¬å¸": "å°ç©é›»",
                "ç”¢æ¥­": "åŠå°é«”",
                "ç‡Ÿæ”¶": [
                    { "å¹´æœˆ": "2021-01", "é‡‘é¡": 127740 },
                    { "å¹´æœˆ": "2021-02", "é‡‘é¡": 122280 },
                    { "å¹´æœˆ": "2021-03", "é‡‘é¡": 129880 },
                    { "å¹´æœˆ": "2021-04", "é‡‘é¡": 134370 },
                    { "å¹´æœˆ": "2021-05", "é‡‘é¡": 132920 },
                    { "å¹´æœˆ": "2021-06", "é‡‘é¡": 133090 },
                    { "å¹´æœˆ": "2021-07", "é‡‘é¡": 143490 },
                    { "å¹´æœˆ": "2021-08", "é‡‘é¡": 148900 },
                    { "å¹´æœˆ": "2021-09", "é‡‘é¡": 145240 },
                    { "å¹´æœˆ": "2021-10", "é‡‘é¡": 143040 },
                    { "å¹´æœˆ": "2021-11", "é‡‘é¡": 155750 },
                    { "å¹´æœˆ": "2021-12", "é‡‘é¡": 151890 },
                    { "å¹´æœˆ": "2022-01", "é‡‘é¡": 157570 },
                    { "å¹´æœˆ": "2022-02", "é‡‘é¡": 134510 },
                    { "å¹´æœˆ": "2022-03", "é‡‘é¡": 157610 },
                    { "å¹´æœˆ": "2022-04", "é‡‘é¡": 175930 },
                    { "å¹´æœˆ": "2022-05", "é‡‘é¡": 181900 },
                    { "å¹´æœˆ": "2022-06", "é‡‘é¡": 181000 },
                    { "å¹´æœˆ": "2022-07", "é‡‘é¡": 182020 },
                    { "å¹´æœˆ": "2022-08", "é‡‘é¡": 200850 },
                    { "å¹´æœˆ": "2022-09", "é‡‘é¡": 203010 },
                    { "å¹´æœˆ": "2022-10", "é‡‘é¡": 201850 },
                    { "å¹´æœˆ": "2022-11", "é‡‘é¡": 166590 },
                    { "å¹´æœˆ": "2022-12", "é‡‘é¡": 162790 },
                    { "å¹´æœˆ": "2023-01", "é‡‘é¡": 165090 },
                    { "å¹´æœˆ": "2023-02", "é‡‘é¡": 180820 },
                    { "å¹´æœˆ": "2023-03", "é‡‘é¡": 180880 },
                    { "å¹´æœˆ": "2023-04", "é‡‘é¡": 169980 },
                    { "å¹´æœˆ": "2023-05", "é‡‘é¡": 155290 },
                    { "å¹´æœˆ": "2023-06", "é‡‘é¡": 151740 },
                    { "å¹´æœˆ": "2023-07", "é‡‘é¡": 164770 },
                    { "å¹´æœˆ": "2023-08", "é‡‘é¡": 171850 },
                    { "å¹´æœˆ": "2023-09", "é‡‘é¡": 170110 },
                    { "å¹´æœˆ": "2023-10", "é‡‘é¡": 207870 },
                    { "å¹´æœˆ": "2023-11", "é‡‘é¡": 196180 },
                    { "å¹´æœˆ": "2023-12", "é‡‘é¡": 215850 },
                    { "å¹´æœˆ": "2024-01", "é‡‘é¡": 195760 },
                    { "å¹´æœˆ": "2024-02", "é‡‘é¡": 183950 },
                    { "å¹´æœˆ": "2024-03", "é‡‘é¡": 195330 },
                    { "å¹´æœˆ": "2024-04", "é‡‘é¡": 196250 },
                    { "å¹´æœˆ": "2024-05", "é‡‘é¡": 229630 },
                    { "å¹´æœˆ": "2024-06", "é‡‘é¡": 207870 },
                    { "å¹´æœˆ": "2024-07", "é‡‘é¡": 256950 }
                ]
            },
            "2303": {
                "ä»£ç¢¼": "2303",
                "å…¬å¸": "è¯é›»",
                "ç”¢æ¥­": "åŠå°é«”",
                "ç‡Ÿæ”¶": [
                    { "å¹´æœˆ": "2021-01", "é‡‘é¡": 50480 },
                    { "å¹´æœˆ": "2021-02", "é‡‘é¡": 48960 },
                    { "å¹´æœˆ": "2021-03", "é‡‘é¡": 53440 },
                    { "å¹´æœˆ": "2021-04", "é‡‘é¡": 54280 },
                    { "å¹´æœˆ": "2021-05", "é‡‘é¡": 56230 },
                    { "å¹´æœˆ": "2021-06", "é‡‘é¡": 57890 },
                    { "å¹´æœˆ": "2021-07", "é‡‘é¡": 59440 },
                    { "å¹´æœˆ": "2021-08", "é‡‘é¡": 61230 },
                    { "å¹´æœˆ": "2021-09", "é‡‘é¡": 62110 },
                    { "å¹´æœˆ": "2021-10", "é‡‘é¡": 62850 },
                    { "å¹´æœˆ": "2021-11", "é‡‘é¡": 64120 },
                    { "å¹´æœˆ": "2021-12", "é‡‘é¡": 65890 },
                    { "å¹´æœˆ": "2022-01", "é‡‘é¡": 64850 },
                    { "å¹´æœˆ": "2022-02", "é‡‘é¡": 56890 },
                    { "å¹´æœˆ": "2022-03", "é‡‘é¡": 65320 },
                    { "å¹´æœˆ": "2022-04", "é‡‘é¡": 64280 },
                    { "å¹´æœˆ": "2022-05", "é‡‘é¡": 62890 },
                    { "å¹´æœˆ": "2022-06", "é‡‘é¡": 59640 },
                    { "å¹´æœˆ": "2022-07", "é‡‘é¡": 56780 },
                    { "å¹´æœˆ": "2022-08", "é‡‘é¡": 54230 },
                    { "å¹´æœˆ": "2022-09", "é‡‘é¡": 52890 },
                    { "å¹´æœˆ": "2022-10", "é‡‘é¡": 50120 },
                    { "å¹´æœˆ": "2022-11", "é‡‘é¡": 48560 },
                    { "å¹´æœˆ": "2022-12", "é‡‘é¡": 46890 },
                    { "å¹´æœˆ": "2023-01", "é‡‘é¡": 45230 },
                    { "å¹´æœˆ": "2023-02", "é‡‘é¡": 44560 },
                    { "å¹´æœˆ": "2023-03", "é‡‘é¡": 46780 },
                    { "å¹´æœˆ": "2023-04", "é‡‘é¡": 48120 },
                    { "å¹´æœˆ": "2023-05", "é‡‘é¡": 49340 },
                    { "å¹´æœˆ": "2023-06", "é‡‘é¡": 50890 },
                    { "å¹´æœˆ": "2023-07", "é‡‘é¡": 52340 },
                    { "å¹´æœˆ": "2023-08", "é‡‘é¡": 53780 },
                    { "å¹´æœˆ": "2023-09", "é‡‘é¡": 54890 },
                    { "å¹´æœˆ": "2023-10", "é‡‘é¡": 56230 },
                    { "å¹´æœˆ": "2023-11", "é‡‘é¡": 57890 },
                    { "å¹´æœˆ": "2023-12", "é‡‘é¡": 59340 },
                    { "å¹´æœˆ": "2024-01", "é‡‘é¡": 57230 },
                    { "å¹´æœˆ": "2024-02", "é‡‘é¡": 56890 },
                    { "å¹´æœˆ": "2024-03", "é‡‘é¡": 58340 },
                    { "å¹´æœˆ": "2024-04", "é‡‘é¡": 59780 },
                    { "å¹´æœˆ": "2024-05", "é‡‘é¡": 61230 },
                    { "å¹´æœˆ": "2024-06", "é‡‘é¡": 62890 },
                    { "å¹´æœˆ": "2024-07", "é‡‘é¡": 64120 }
                ]
            },
            "2454": {
                "ä»£ç¢¼": "2454",
                "å…¬å¸": "è¯ç™¼ç§‘",
                "ç”¢æ¥­": "åŠå°é«”",
                "ç‡Ÿæ”¶": [
                    { "å¹´æœˆ": "2021-01", "é‡‘é¡": 105440 },
                    { "å¹´æœˆ": "2021-02", "é‡‘é¡": 98230 },
                    { "å¹´æœˆ": "2021-03", "é‡‘é¡": 113440 },
                    { "å¹´æœˆ": "2021-04", "é‡‘é¡": 114280 },
                    { "å¹´æœˆ": "2021-05", "é‡‘é¡": 116230 },
                    { "å¹´æœˆ": "2021-06", "é‡‘é¡": 117890 },
                    { "å¹´æœˆ": "2021-07", "é‡‘é¡": 119440 },
                    { "å¹´æœˆ": "2021-08", "é‡‘é¡": 121230 },
                    { "å¹´æœˆ": "2021-09", "é‡‘é¡": 122110 },
                    { "å¹´æœˆ": "2021-10", "é‡‘é¡": 126850 },
                    { "å¹´æœˆ": "2021-11", "é‡‘é¡": 134120 },
                    { "å¹´æœˆ": "2021-12", "é‡‘é¡": 145890 },
                    { "å¹´æœˆ": "2022-01", "é‡‘é¡": 144850 },
                    { "å¹´æœˆ": "2022-02", "é‡‘é¡": 126890 },
                    { "å¹´æœˆ": "2022-03", "é‡‘é¡": 145320 },
                    { "å¹´æœˆ": "2022-04", "é‡‘é¡": 139280 },
                    { "å¹´æœˆ": "2022-05", "é‡‘é¡": 142890 },
                    { "å¹´æœˆ": "2022-06", "é‡‘é¡": 139640 },
                    { "å¹´æœˆ": "2022-07", "é‡‘é¡": 126780 },
                    { "å¹´æœˆ": "2022-08", "é‡‘é¡": 124230 },
                    { "å¹´æœˆ": "2022-09", "é‡‘é¡": 122890 },
                    { "å¹´æœˆ": "2022-10", "é‡‘é¡": 120120 },
                    { "å¹´æœˆ": "2022-11", "é‡‘é¡": 118560 },
                    { "å¹´æœˆ": "2022-12", "é‡‘é¡": 116890 },
                    { "å¹´æœˆ": "2023-01", "é‡‘é¡": 115230 },
                    { "å¹´æœˆ": "2023-02", "é‡‘é¡": 114560 },
                    { "å¹´æœˆ": "2023-03", "é‡‘é¡": 116780 },
                    { "å¹´æœˆ": "2023-04", "é‡‘é¡": 118120 },
                    { "å¹´æœˆ": "2023-05", "é‡‘é¡": 119340 },
                    { "å¹´æœˆ": "2023-06", "é‡‘é¡": 120890 },
                    { "å¹´æœˆ": "2023-07", "é‡‘é¡": 122340 },
                    { "å¹´æœˆ": "2023-08", "é‡‘é¡": 123780 },
                    { "å¹´æœˆ": "2023-09", "é‡‘é¡": 124890 },
                    { "å¹´æœˆ": "2023-10", "é‡‘é¡": 126230 },
                    { "å¹´æœˆ": "2023-11", "é‡‘é¡": 127890 },
                    { "å¹´æœˆ": "2023-12", "é‡‘é¡": 139340 },
                    { "å¹´æœˆ": "2024-01", "é‡‘é¡": 137230 },
                    { "å¹´æœˆ": "2024-02", "é‡‘é¡": 136890 },
                    { "å¹´æœˆ": "2024-03", "é‡‘é¡": 138340 },
                    { "å¹´æœˆ": "2024-04", "é‡‘é¡": 139780 },
                    { "å¹´æœˆ": "2024-05", "é‡‘é¡": 141230 },
                    { "å¹´æœˆ": "2024-06", "é‡‘é¡": 142890 },
                    { "å¹´æœˆ": "2024-07", "é‡‘é¡": 144120 }
                ]
            }
        };

        let currentChart = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateAnalysis();
            
            document.getElementById('companySelect').addEventListener('change', updateAnalysis);
            document.getElementById('dateRangeSelect').addEventListener('change', updateAnalysis);
        });

        // å‰µå»ºsparkline
        function createSparkline(data, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const maxValue = Math.max(...data.map(d => d.é‡‘é¡));
            const minValue = Math.min(...data.map(d => d.é‡‘é¡));
            const range = maxValue - minValue;
            
            container.innerHTML = '';
            container.className = 'sparkline';
            
            data.forEach((item, index) => {
                const normalizedValue = range === 0 ? 0.5 : (item.é‡‘é¡ - minValue) / range;
                const barHeight = Math.max(2, normalizedValue * 18);
                
                const bar = document.createElement('div');
                bar.className = 'sparkline-bar';
                bar.style.height = `${barHeight}px`;
                bar.title = `${item.å¹´æœˆ}: ${item.é‡‘é¡.toLocaleString()}`;
                
                container.appendChild(bar);
            });
        }

        // æ›´æ–°åˆ†æ
        function updateAnalysis() {
            const selectedCompany = document.getElementById('companySelect').value;
            const dateRange = parseInt(document.getElementById('dateRangeSelect').value);
            const companyData = mockData[selectedCompany];
            
            if (!companyData) return;
            
            // æ›´æ–°å…¬å¸åç¨±
            document.getElementById('companyName').textContent = companyData.å…¬å¸;
            
            // ç²å–æ•¸æ“š
            const revenues = companyData.ç‡Ÿæ”¶;
            const filteredData = revenues.slice(-dateRange);
            const latest = filteredData[filteredData.length - 1];
            const previous = filteredData[filteredData.length - 2];
            
            // è¨ˆç®—æˆé•·ç‡
            const mom = previous ? ((latest.é‡‘é¡ - previous.é‡‘é¡) / previous.é‡‘é¡ * 100) : 0;
            
            // æ‰¾å»å¹´åŒæœŸ
            const latestDate = new Date(latest.å¹´æœˆ + '-01');
            const lastYearMonth = `${latestDate.getFullYear() - 1}-${String(latestDate.getMonth() + 1).padStart(2, '0')}`;
            const lastYearData = revenues.find(r => r.å¹´æœˆ === lastYearMonth);
            const yoy = lastYearData ? ((latest.é‡‘é¡ - lastYearData.é‡‘é¡) / lastYearData.é‡‘é¡ * 100) : 0;
            
            const average = filteredData.reduce((sum, r) => sum + r.é‡‘é¡, 0) / filteredData.length;
            const max = Math.max(...filteredData.map(r => r.é‡‘é¡));
            const min = Math.min(...filteredData.map(r => r.é‡‘é¡));
            
            // è¨ˆç®—å¹´åº¦æ•¸æ“š
            const currentYear = latestDate.getFullYear();
            const currentMonth = latestDate.getMonth() + 1;
            
            // æ›´æ–°æˆé•·åˆ†æ
            document.getElementById('analysisData').innerHTML = `
                <div class="analysis-item">
                    <span>æœ€æ–°æœˆç‡Ÿæ”¶ï¼š</span>
                    <span class="analysis-value">$${latest.é‡‘é¡.toLocaleString()} åƒå…ƒ</span>
                </div>
                <div class="analysis-item">
                    <span>ä¸Šæœˆç’°æ¯”ï¼š</span>
                    <span class="analysis-value ${mom >= 0 ? 'positive' : 'negative'}">
                        ${mom >= 0 ? '+' : ''}${mom.toFixed(2)}%
                    </span>
                </div>
                <div class="analysis-item">
                    <span>å»å¹´åŒæœŸï¼š</span>
                    <span class="analysis-value ${yoy >= 0 ? 'positive' : 'negative'}">
                        ${yoy >= 0 ? '+' : ''}${yoy.toFixed(2)}%
                    </span>
                </div>
                <div class="analysis-item">
                    <span>æœŸé–“å¹³å‡ï¼š</span>
                    <span class="analysis-value">$${Math.round(average).toLocaleString()} åƒå…ƒ</span>
                </div>
                <div class="analysis-item">
                    <span>æœŸé–“æœ€é«˜ï¼š</span>
                    <span class="analysis-value positive">$${max.toLocaleString()} åƒå…ƒ</span>
                </div>
                <div class="analysis-item">
                    <span>æœŸé–“æœ€ä½ï¼š</span>
                    <span class="analysis-value negative">$${min.toLocaleString()} åƒå…ƒ</span>
                </div>
            `;
            
            // è¨ˆç®—ç´¯ç©ç¸½è¨ˆ
            const yearlyAccumulated = {};
            for (let year = 2021; year <= currentYear; year++) {
                const yearData = revenues.filter(r => {
                    const [y, m] = r.å¹´æœˆ.split('-');
                    return parseInt(y) === year && parseInt(m) <= currentMonth;
                });
                yearlyAccumulated[year] = {
                    total: yearData.reduce((sum, r) => sum + r.é‡‘é¡, 0),
                    data: yearData
                };
            }
            
            // æ›´æ–°ç´¯ç©ç¸½è¨ˆæ¨™é¡Œ
            document.getElementById('accumulatedTitle').textContent = 
                `å¹´åº¦ç´¯ç©ç¸½è¨ˆ (è‡³${currentYear}-${String(currentMonth).padStart(2, '0')})`;
            
            // æ›´æ–°å¹´åº¦ç´¯ç©æ•¸æ“š
            let yearlyHtml = '';
            Object.entries(yearlyAccumulated)
                .sort(([a], [b]) => parseInt(b) - parseInt(a))
                .forEach(([year, data]) => {
                    yearlyHtml += `
                        <div class="yearly-item">
                            <div>
                                <span style="font-weight: 500;">${year}å¹´ï¼š</span>
                                <span style="font-size: 0.875rem;">$${data.total.toLocaleString()} åƒå…ƒ</span>
                            </div>
                            <div class="yearly-sparkline" id="sparkline-${year}"></div>
                        </div>
                    `;
                });
            
            document.getElementById('yearlyAccumulated').innerHTML = yearlyHtml;
            
            // å‰µå»ºsparklines
            Object.entries(yearlyAccumulated).forEach(([year, data]) => {
                createSparkline(data.data, `sparkline-${year}`);
            });
            
            // è¨ˆç®—ç•¶å¹´åº¦ç¸½è¨ˆ
            const currentYearTotal = revenues
                .filter(r => r.å¹´æœˆ.startsWith(currentYear.toString()))
                .reduce((sum, r) => sum + r.é‡‘é¡, 0);
            
            document.getElementById('currentYearTotal').textContent = 
                `$${currentYearTotal.toLocaleString()} åƒå…ƒ`;
            
            // æ›´æ–°åœ–è¡¨
            updateChart(filteredData);
            
            // æ›´æ–°è©³ç´°è¡¨æ ¼
            updateDetailedTable(companyData);
        }

        // æ›´æ–°åœ–è¡¨
        function updateChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.å¹´æœˆ),
                    datasets: [{
                        label: 'ç‡Ÿæ”¶ (åƒå…ƒ)',
                        data: data.map(item => item.é‡‘é¡),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000).toFixed(0) + 'M';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å¹´æœˆ'
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°è©³ç´°è¡¨æ ¼
        function updateDetailedTable(companyData) {
            const revenues = companyData.ç‡Ÿæ”¶;
            
            // æŒ‰å¹´ä»½åˆ†çµ„
            const yearlyData = {};
            revenues.forEach(item => {
                const [year, month] = item.å¹´æœˆ.split('-');
                if (!yearlyData[year]) {
                    yearlyData[year] = {};
                }
                yearlyData[year][month] = item.é‡‘é¡;
            });
            
            const years = Object.keys(yearlyData).sort((a, b) => b - a);
            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            
            // è¨ˆç®—å¹´åº¦ç¸½è¨ˆ
            const getYearTotal = (year) => {
                return Object.values(yearlyData[year] || {}).reduce((sum, val) => sum + val, 0);
            };
            
            // è¨ˆç®—ç´¯ç©ç¸½è¨ˆ
            const getAccumulatedTotal = (year) => {
                let latestMonth = 0;
                revenues.forEach(item => {
                    const [y, m] = item.å¹´æœˆ.split('-');
                    latestMonth = Math.max(latestMonth, parseInt(m));
                });
                
                if (latestMonth === 0) latestMonth = 12;
                
                let total = 0;
                for (let m = 1; m <= latestMonth; m++) {
                    const monthStr = String(m).padStart(2, '0');
                    if (yearlyData[year] && yearlyData[year][monthStr]) {
                        total += yearlyData[year][monthStr];
                    }
                }
                return total;
            };
            
            // è¨ˆç®—ç’°æ¯”æˆé•·ç‡
            const getMoMGrowth = (year, month) => {
                const currentValue = yearlyData[year]?.[month];
                if (!currentValue) return null;
                
                let prevValue = null;
                const monthNum = parseInt(month);
                
                if (monthNum === 1) {
                    prevValue = yearlyData[year - 1]?.['12'];
                } else {
                    const prevMonth = String(monthNum - 1).padStart(2, '0');
                    prevValue = yearlyData[year]?.[prevMonth];
                }
                
                return prevValue ? ((currentValue - prevValue) / prevValue * 100) : null;
            };
            
            // è¨ˆç®—å¹´æ¯”æˆé•·ç‡
            const getYoYGrowth = (year, month) => {
                const currentValue = yearlyData[year]?.[month];
                const lastYearValue = yearlyData[year - 1]?.[month];
                
                if (!currentValue || !lastYearValue) return null;
                return ((currentValue - lastYearValue) / lastYearValue * 100);
            };
            
            // å‰µå»ºè¿·ä½ æŸ±ç‹€åœ–HTML
            const createMiniChart = (year) => {
                const data = months.map(month => yearlyData[year]?.[month] || 0);
                const maxValue = Math.max(...data.filter(v => v > 0));
                
                let chartHtml = '<div class="mini-chart">';
                data.forEach((value, index) => {
                    const height = value > 0 ? Math.max(2, (value / maxValue) * 20) : 0;
                    chartHtml += `<div class="mini-bar" style="height: ${height}px;" title="${months[index]}æœˆ: ${value.toLocaleString()}"></div>`;
                });
                chartHtml += '</div>';
                return chartHtml;
            };
            
            // ç”Ÿæˆè¡¨æ ¼HTML
            let tableHtml = `
                <thead>
                    <tr style="background-color: #f9fafb;">
                        <th style="font-weight: 600;">å¹´åº¦</th>
                        ${months.map(month => `<th style="min-width: 80px; font-weight: 600;">${month}</th>`).join('')}
                        <th style="font-weight: 600;">12æœˆ</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            years.forEach(year => {
                const yearTotal = getYearTotal(year);
                const accumulatedTotal = getAccumulatedTotal(year);
                
                // å¹´åº¦ç‡Ÿæ”¶æ•¸æ“šè¡Œ
                tableHtml += `
                    <tr style="background-color: white;">
                        <td class="year-cell" rowspan="3">
                            <div style="font-size: 1.125rem;">${year}</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px;">
                                ${accumulatedTotal.toLocaleString()}
                            </div>
                        </td>
                `;
                
                months.forEach(month => {
                    const value = yearlyData[year]?.[month];
                    tableHtml += `
                        <td>
                            ${value ? `<div style="font-weight: 500;">${Math.round(value / 100) / 10}</div>` : '<div class="no-data">â€”</div>'}
                        </td>
                    `;
                });
                
                tableHtml += `
                        <td class="total-cell">
                            <div style="font-weight: bold; color: #1d4ed8;">
                                ${Math.round(yearTotal / 100000)}
                            </div>
                            ${createMiniChart(year)}
                        </td>
                    </tr>
                `;
                
                // ç’°æ¯”æˆé•·ç‡è¡Œ
                tableHtml += '<tr style="background-color: #f9fafb;">';
                months.forEach(month => {
                    const momGrowth = getMoMGrowth(year, month);
                    if (momGrowth !== null) {
                        const className = momGrowth >= 0 ? 'growth-positive' : 'growth-negative';
                        tableHtml += `<td><span class="${className}">${momGrowth >= 0 ? '+' : ''}${momGrowth.toFixed(1)}%</span></td>`;
                    } else {
                        tableHtml += '<td><span class="no-data">â€”</span></td>';
                    }
                });
                tableHtml += `<td style="background-color: #f3f4f6; font-size: 0.75rem;">${Math.round(yearTotal / 100000)}</td></tr>`;
                
                // å¹´æ¯”æˆé•·ç‡è¡Œ
                tableHtml += '<tr style="background-color: white;">';
                months.forEach(month => {
                    const yoyGrowth = getYoYGrowth(year, month);
                    if (yoyGrowth !== null) {
                        const className = yoyGrowth >= 0 ? 'growth-positive' : 'growth-negative';
                        tableHtml += `<td><span class="${className}">${yoyGrowth >= 0 ? '+' : ''}${yoyGrowth.toFixed(1)}%</span></td>`;
                    } else {
                        tableHtml += '<td><span class="no-data">â€”</span></td>';
                    }
                });
                tableHtml += '<td style="background-color: #f3f4f6; font-size: 0.75rem;">â€”</td></tr>';
            });
            
            tableHtml += '</tbody>';
            document.getElementById('detailedTable').innerHTML = tableHtml;
        }

        // åŒ¯å‡ºCSV
        function exportCSV() {
            const selectedCompany = document.getElementById('companySelect').value;
            const dateRange = parseInt(document.getElementById('dateRangeSelect').value);
            const companyData = mockData[selectedCompany];
            
            if (!companyData) return;
            
            const filteredData = companyData.ç‡Ÿæ”¶.slice(-dateRange);
            
            const csvContent = [
                ['å¹´æœˆ', 'ç‡Ÿæ”¶(åƒå…ƒ)'],
                ...filteredData.map(item => [item.å¹´æœˆ, item.é‡‘é¡])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${companyData.å…¬å¸}_ç‡Ÿæ”¶è³‡æ–™.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>