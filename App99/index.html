<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ç®¡ç†å“¡ç™»å…¥ï¼ˆAuth-Onlyï¼‰</title>
    <style>
        * {
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            margin: 0;
            color: #111827
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1);
            padding: 20px;
            margin-bottom: 16px
        }

        h1 {
            font-size: 28px;
            margin: 8px 0 16px
        }

        h3 {
            margin: 0 0 12px
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .input {
            flex: 1;
            min-width: 180px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px
        }

        .btn {
            border: 0;
            border-radius: 8px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer
        }

        .btn-primary {
            background: #3b82f6;
            color: #fff
        }

        .btn-secondary {
            background: #6b7280;
            color: #fff
        }

        .btn-danger {
            background: #ef4444;
            color: #fff
        }

        .tag {
            font-size: 12px;
            background: #eef2ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            border-radius: 9999px;
            padding: 4px 8px
        }

        .hidden {
            display: none
        }

        .muted {
            color: #6b7280
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ” ç®¡ç†å“¡ç™»å…¥ï¼ˆAuth-Onlyï¼‰</h1>

        <!-- é€£ç·š -->
        <div class="card">
            <h3>ğŸ“¡ é€£æ¥ Apps Script</h3>
            <div class="row" style="margin-bottom:8px">
                <input id="gasUrl" class="input" placeholder="è²¼ä¸Š /exec çµå°¾çš„ Web App URL" selection="https://script.google.com/macros/s/AKfycbyKb9IupdmKVcgtDmFHvKq3YLD89kaTmLZknP65n1rw0NfHLwAIosArraOkvgu2346E/exec">
                <button id="connectBtn" class="btn btn-primary">é€£æ¥</button>
                <button id="disconnectBtn" class="btn btn-secondary hidden">ä¸­æ–·</button>
                <span id="connStatus" class="tag">æœªé€£æ¥</span>
            </div>
            <p class="muted">éƒ¨ç½²ç‚º Web æ‡‰ç”¨ç¨‹å¼ï¼ˆä»»ä½•äººï¼‰ï¼Œè¤‡è£½æœ€æ–° /exec URL è²¼ä¸Šã€‚</p>
        </div>

        <!-- ç™»å…¥ -->
        <div class="card">
            <h3>ğŸ‘¥ ç®¡ç†å“¡ç™»å…¥</h3>
            <div class="row" style="margin-bottom:8px">
                <input id="username" class="input" placeholder="å¸³è™Ÿ">
                <input id="password" type="password" class="input" placeholder="å¯†ç¢¼">
            </div>
            <div class="row">
                <button id="loginBtn" class="btn btn-primary">ç™»å…¥</button>
                <button id="logoutBtn" class="btn btn-danger" disabled>ç™»å‡º</button>
                <span id="authStatus" class="tag">æœªç™»å…¥</span>
                <span id="roleHint" class="tag">æ¬Šé™ï¼š-</span>
            </div>
        </div>

        <!-- ğŸ‘‘ Owner å·¥å…· -->
        <div id="ownerTools" class="card hidden">
            <h3>ğŸ‘‘ Owner å·¥å…·</h3>

            <div style="margin-bottom:12px">
                <strong>å»ºç«‹ç®¡ç†å“¡</strong>
                <div class="row" style="margin-top:6px">
                    <input id="oaUser" class="input" placeholder="å¸³è™Ÿ">
                    <input id="oaPass" type="password" class="input" placeholder="åˆå§‹å¯†ç¢¼">
                    <select id="oaRole" class="input" style="max-width:160px">
                        <option value="admin">admin</option>
                        <option value="editor">editor</option>
                        <option value="viewer">viewer</option>
                    </select>
                    <button id="oaCreateBtn" class="btn btn-primary">å»ºç«‹</button>
                </div>
            </div>

            <div style="margin-bottom:12px">
                <strong>èª¿æ•´è§’è‰² / å•Ÿç”¨åœç”¨</strong>
                <div class="row" style="margin-top:6px">
                    <input id="oaTarget" class="input" placeholder="ç›®æ¨™å¸³è™Ÿ">
                    <select id="oaNewRole" class="input" style="max-width:160px">
                        <option value="owner">owner</option>
                        <option value="admin">admin</option>
                        <option value="editor">editor</option>
                        <option value="viewer">viewer</option>
                    </select>
                    <button id="oaSetRoleBtn" class="btn btn-secondary">è¨­å®šè§’è‰²</button>
                </div>
                <div class="row" style="margin-top:6px">
                    <select id="oaActive" class="input" style="max-width:160px">
                        <option value="true">å•Ÿç”¨</option>
                        <option value="false">åœç”¨</option>
                    </select>
                    <button id="oaSetActiveBtn" class="btn btn-secondary">å•Ÿç”¨/åœç”¨</button>
                </div>
            </div>

            <div>
                <strong>é‡è¨­å¯†ç¢¼</strong>
                <div class="row" style="margin-top:6px">
                    <input id="oaResetUser" class="input" placeholder="ç›®æ¨™å¸³è™Ÿ">
                    <input id="oaNewPassword" type="password" class="input" placeholder="æ–°å¯†ç¢¼">
                    <button id="oaResetPassBtn" class="btn btn-danger">é‡è¨­å¯†ç¢¼</button>
                </div>
            </div>

            <p class="muted" style="margin-top:8px">åƒ… owner å¯æ“ä½œï¼›å¯†ç¢¼é›œæ¹Šèˆ‡ salt ç”±å¾Œç«¯è‡ªå‹•è™•ç†ã€‚</p>
        </div>
    </div>

    <script>
        // ===== ç‹€æ…‹ =====
        let gasUrl = localStorage.getItem('gasUrl') || '';
        let isConnected = false;
        let TOKEN = localStorage.getItem('token') || null;
        let CURRENT_USER = JSON.parse(localStorage.getItem('user') || 'null');

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', () => {
            if (gasUrl) document.getElementById('gasUrl').value = gasUrl;
            bindEvents();
            reflectAuthToUI();
            if (gasUrl) connect(true);
        });

        // ===== ç¶å®šäº‹ä»¶ =====
        function bindEvents() {
            document.getElementById('connectBtn').addEventListener('click', () => connect(false));
            document.getElementById('disconnectBtn').addEventListener('click', disconnect);

            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('logoutBtn').addEventListener('click', logout);

            document.getElementById('oaCreateBtn').addEventListener('click', onCreate);
            document.getElementById('oaSetActiveBtn').addEventListener('click', onSetActive);
            document.getElementById('oaSetRoleBtn').addEventListener('click', onSetRole);
            document.getElementById('oaResetPassBtn').addEventListener('click', onResetPass);
        }

        // ===== é€£ç·š =====
        async function connect(silent) {
            gasUrl = document.getElementById('gasUrl').value.trim() || gasUrl;
            if (!gasUrl) return alert('è«‹è¼¸å…¥ Web App /exec URL');
            try {
                const r = await fetch(gasUrl + '?action=test');
                const j = await r.json();
                if (!j.success) throw new Error('GAS å›æ‡‰é success');
                isConnected = true;
                localStorage.setItem('gasUrl', gasUrl);
                document.getElementById('connStatus').textContent = 'å·²é€£æ¥';
                document.getElementById('disconnectBtn').classList.remove('hidden');
                if (TOKEN) await whoami(true);
                if (!silent) alert('é€£ç·šæˆåŠŸ');
            } catch (e) {
                isConnected = false;
                document.getElementById('connStatus').textContent = 'æœªé€£æ¥';
                document.getElementById('disconnectBtn').classList.add('hidden');
                alert('é€£ç·šå¤±æ•—ï¼š' + e.message);
            }
        }
        function disconnect() {
            isConnected = false; gasUrl = ''; localStorage.removeItem('gasUrl');
            document.getElementById('gasUrl').value = '';
            document.getElementById('connStatus').textContent = 'æœªé€£æ¥';
            document.getElementById('disconnectBtn').classList.add('hidden');
        }

        // ===== Auth =====
        async function login() {
            if (!isConnected) return alert('è«‹å…ˆé€£ç·š');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) return alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼');
            try {
                const res = await fetch(gasUrl, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ action: 'adminLogin', data: { username, password } })
                }).then(r => r.json());
                if (!res.success) return alert('ç™»å…¥å¤±æ•—ï¼š' + (res.message || ''));
                TOKEN = res.token; CURRENT_USER = res.user;
                localStorage.setItem('token', TOKEN);
                localStorage.setItem('user', JSON.stringify(CURRENT_USER));
                reflectAuthToUI();
                alert(`ç™»å…¥æˆåŠŸï¼š${CURRENT_USER.username}ï¼ˆ${CURRENT_USER.role}ï¼‰`);
            } catch (e) { alert('ç™»å…¥éŒ¯èª¤ï¼š' + e.message); }
        }
        async function logout() {
            try {
                if (TOKEN) await fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'adminLogout', token: TOKEN }) });
            } catch (_) { }
            TOKEN = null; CURRENT_USER = null;
            localStorage.removeItem('token'); localStorage.removeItem('user');
            reflectAuthToUI();
            alert('å·²ç™»å‡º');
        }
        async function whoami(silent) {
            if (!TOKEN) { clearAuth(); reflectAuthToUI(); return; }
            try {
                const res = await fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'whoami', token: TOKEN }) }).then(r => r.json());
                if (res.success) { CURRENT_USER = res.user; localStorage.setItem('user', JSON.stringify(CURRENT_USER)); reflectAuthToUI(); }
                else { clearAuth(); reflectAuthToUI(); if (!silent) alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥'); }
            } catch (e) { if (!silent) alert('é©—è­‰å¤±æ•—ï¼š' + e.message); }
        }
        function clearAuth() { TOKEN = null; CURRENT_USER = null; localStorage.removeItem('token'); localStorage.removeItem('user'); }

        function reflectAuthToUI() {
            const authStatus = document.getElementById('authStatus');
            const roleHint = document.getElementById('roleHint');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginBtn = document.getElementById('loginBtn');
            if (CURRENT_USER) {
                authStatus.textContent = `å·²ç™»å…¥ï¼š${CURRENT_USER.username}`;
                roleHint.textContent = `æ¬Šé™ï¼š${CURRENT_USER.role}`;
                logoutBtn.disabled = false; loginBtn.disabled = true;
            } else {
                authStatus.textContent = 'æœªç™»å…¥'; roleHint.textContent = 'æ¬Šé™ï¼š-';
                logoutBtn.disabled = true; loginBtn.disabled = false;
            }
            // Owner é¢æ¿é¡¯ç¤ºæ§åˆ¶
            document.getElementById('ownerTools').classList.toggle('hidden', !(CURRENT_USER && CURRENT_USER.role === 'owner'));
        }

        // ===== Owner API Helper =====
        async function callOwnerAPI(action, data) {
            if (!isConnected) throw new Error('æœªé€£ç·š');
            if (!TOKEN || !CURRENT_USER || CURRENT_USER.role !== 'owner') throw new Error('éœ€ owner ç™»å…¥');
            const res = await fetch(gasUrl, {
                method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action, token: TOKEN, data })
            }).then(r => r.json());
            if (!res.success) throw new Error(res.message || (action + ' å¤±æ•—'));
            return res;
        }
        const ownerCreateAdmin = (u, p, r) => callOwnerAPI('createadmin', { username: u, password: p, role: r });
        const ownerSetAdminActive = (u, a) => callOwnerAPI('setadminactive', { username: u, isActive: a });
        const ownerSetAdminRole = (u, r) => callOwnerAPI('setadminrole', { username: u, role: r });
        const ownerResetAdminPassword = (u, p) => callOwnerAPI('resetadminpassword', { username: u, newPassword: p });

        // ===== Owner é¢æ¿äº‹ä»¶ =====
        async function onCreate() {
            try {
                const u = document.getElementById('oaUser').value.trim();
                const p = document.getElementById('oaPass').value;
                const r = document.getElementById('oaRole').value;
                if (!u || !p) return alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼');
                await ownerCreateAdmin(u, p, r);
                alert('å»ºç«‹æˆåŠŸ'); document.getElementById('oaUser').value = ''; document.getElementById('oaPass').value = '';
            } catch (e) { alert(e.message); }
        }
        async function onSetActive() {
            try {
                const u = document.getElementById('oaTarget').value.trim();
                const a = document.getElementById('oaActive').value === 'true';
                if (!u) return alert('è«‹è¼¸å…¥ç›®æ¨™å¸³è™Ÿ');
                await ownerSetAdminActive(u, a);
                alert(a ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨');
            } catch (e) { alert(e.message); }
        }
        async function onSetRole() {
            try {
                const u = document.getElementById('oaTarget').value.trim();
                const r = document.getElementById('oaNewRole').value;
                if (!u) return alert('è«‹è¼¸å…¥ç›®æ¨™å¸³è™Ÿ');
                await ownerSetAdminRole(u, r);
                alert('è§’è‰²å·²æ›´æ–°ç‚ºï¼š' + r);
            } catch (e) { alert(e.message); }
        }
        async function onResetPass() {
            try {
                const u = document.getElementById('oaResetUser').value.trim();
                const p = document.getElementById('oaNewPassword').value;
                if (!u || !p) return alert('è«‹è¼¸å…¥ç›®æ¨™å¸³è™Ÿèˆ‡æ–°å¯†ç¢¼');
                await ownerResetAdminPassword(u, p);
                alert('å¯†ç¢¼å·²é‡è¨­'); document.getElementById('oaNewPassword').value = '';
            } catch (e) { alert(e.message); }
        }
    </script>
</body>

</html>
