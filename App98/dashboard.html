<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä»Šæ—¥çœ‹æ¿ï½œè¨‚ä½ç¸½è¦½</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa;
      --green:#22c55e; --red:#ef4444; --amber:#f59e0b; --blue:#3b82f6; --slate:#1f2937;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
         background:linear-gradient(180deg,#0b1220 0%,#0f172a 60%,#0b1220 100%);
         color:var(--text); min-height:100vh;}
    .wrap{max-width:1280px;margin:0 auto;padding:24px;}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px;}
    .title{font-size:24px;font-weight:800;letter-spacing:.2px;display:flex;gap:12px;align-items:center}
    .title span{opacity:.75;font-weight:600;font-size:14px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:10px 14px;background:#1e293b;color:#dbeafe;
         font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:#233145;transform:translateY(-1px)}
    .btn-ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
    .btn-green{background:linear-gradient(135deg,#16a34a,#22c55e);color:white}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:12px}
    .grid{display:grid;gap:16px}
    @media(min-width:1024px){.grid-4{grid-template-columns:repeat(4,1fr)} .grid-2{grid-template-columns:2fr 1fr}}
    .card{background:rgba(17,24,39,.85);backdrop-filter:blur(6px);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .card h3{font-size:14px;text-transform:uppercase;letter-spacing:.08em;color:#93c5fd;margin-bottom:12px}
    .kpi{display:flex;align-items:flex-end;gap:12px}
    .kpi .num{font-size:36px;font-weight:900;line-height:1}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #334155;color:#cbd5e1}
    .list{display:flex;flex-direction:column;gap:10px;max-height:48vh;overflow:auto;padding-right:4px}
    .item{display:flex;justify-content:space-between;align-items:center;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px}
    .left{display:flex;align-items:center;gap:12px}
    .time{font-weight:800;color:#bfdbfe;min-width:56px;text-align:center}
    .name{font-weight:700}
    .muted{color:#94a3b8;font-size:12px}
    .badge{padding:4px 8px;border-radius:10px;font-size:12px;font-weight:700}
    .b-confirmed{background:#0a2a12;color:#86efac;border:1px solid #14532d}
    .b-checked_in{background:#0b2447;color:#93c5fd;border:1px solid #1d4ed8}
    .b-completed{background:#1f2937;color:#cbd5e1;border:1px solid #334155}
    .b-no_show{background:#3b0a0a;color:#fecaca;border:1px solid #7f1d1d}
    .b-cancelled{background:#2a0a0a;color:#fca5a5;border:1px solid #7f1d1d}
    .empty{padding:20px;text-align:center;color:#94a3b8;border:1px dashed #334155;border-radius:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .now{color:#22d3ee;font-weight:800}
    .footer{margin-top:12px;color:#94a3b8;font-size:12px;display:flex;justify-content:space-between;align-items:center}
    .select{background:#0b1220;border:1px solid #334155;border-radius:10px;color:#e5e7eb;padding:8px 10px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
    .d-free{background:#22c55e}.d-block{background:#ef4444}.d-busy{background:#f59e0b}
    .legend{display:flex;gap:12px;align-items:center}
    .hl{color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ğŸ“Š ä»Šæ—¥çœ‹æ¿ <span id="todaySpan"></span></div>
      <div class="controls">
        <div class="pill" id="refreshState">æ¯ 30 ç§’è‡ªå‹•æ›´æ–°</div>
        <select id="durationSelect" class="select" title="é è¨­ç”¨é¤æ™‚é•·(åˆ†)">
          <option value="60">60 åˆ†</option>
          <option value="90">90 åˆ†</option>
          <option value="120" selected>120 åˆ†ï¼ˆé è¨­ï¼‰</option>
          <option value="150">150 åˆ†</option>
          <option value="180">180 åˆ†</option>
        </select>
        <button id="btnRefresh" class="btn btn-ghost">ğŸ”„ ç«‹å³åˆ·æ–°</button>
        <button class="btn btn-green" onclick="openMain()">ğŸ–¥ï¸ ä¸»ç•«é¢</button>
      </div>
    </header>

    <!-- KPI å€ -->
    <section class="grid grid-4">
      <div class="card">
        <h3>ä»Šæ—¥è¨‚ä½</h3>
        <div class="kpi"><div class="num" id="kpiTotal">0</div><div class="sub">ç­†</div></div>
        <div class="footer"><div class="legend"><span class="dot d-busy"></span><span>å·²æ’ç¨‹</span></div><span id="lastUpdated"></span></div>
      </div>
      <div class="card">
        <h3>å·²åˆ° / å®Œæˆ</h3>
        <div class="kpi"><div class="num" id="kpiArrived">0</div><div class="sub">äººæ¬¡</div></div>
        <div class="row muted" id="kpiArrivedBreakdown"></div>
      </div>
      <div class="card">
        <h3>å€™è£œåå–®</h3>
        <div class="kpi"><div class="num" id="kpiWait">0</div><div class="sub">çµ„</div></div>
        <div class="row muted" id="kpiWaitNote"></div>
      </div>
      <div class="card">
        <h3>å³æ™‚å¯ç”¨åº§ä½</h3>
        <div class="kpi"><div class="num" id="kpiFree">0</div><div class="sub">å€‹</div></div>
        <div class="row legend">
          <span><span class="dot d-free"></span>å¯ç”¨</span>
          <span><span class="dot d-block"></span>å°é–</span>
          <span><span class="dot d-busy"></span>å ç”¨</span>
        </div>
      </div>
    </section>

    <!-- æ˜ç´°å€ -->
    <section class="grid grid-2" style="margin-top:16px">
      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <h3>ä»Šæ—¥è¨‚ä½æ¸…å–®</h3>
          <div class="row muted"><span class="tag" id="openNowTag">ç¾åœ¨æ™‚æ®µï¼š<span class="now" id="nowSpan">--:--</span></span></div>
        </div>
        <div id="resvList" class="list"></div>
      </div>

      <div class="card">
        <h3>å€™è£œ & å°é–</h3>
        <div class="row" style="gap:12px;margin-bottom:10px">
          <span class="tag">å€™è£œ <span id="badgeWait">0</span></span>
          <span class="tag">å°é– <span id="badgeBlock">0</span></span>
        </div>
        <div id="sideLists">
          <div style="margin-bottom:12px">
            <div class="muted" style="margin-bottom:6px">å€™è£œåå–®</div>
            <div id="waitList" class="list" style="max-height:22vh"></div>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">å°é–æ™‚æ®µ</div>
            <div id="blockList" class="list" style="max-height:22vh"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3>å³æ™‚å¯ç”¨åº§ä½ï¼ˆä»¥ç¾åœ¨æ™‚é–“ï¼‹é¸å®šç”¨é¤æ™‚é•·è©•ä¼°ï¼‰</h3>
      <div id="freeGrid" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-top:8px"></div>
    </section>
  </div>

  <script>
    // ======== åŒæºè¨­å®šï¼šè‡ªå‹•å–å¾— /exec åŸºåº• ========
    const BASE = (function(){
      // ç•¶å‰é é¢å°±æ˜¯ /exec?page=dashboardï¼Œå› æ­¤ç›´æ¥å– window.location.origin + è·¯å¾‘
      const url = new URL(window.location.href);
      // ä¿ç•™åˆ° /exec
      const path = url.pathname.endsWith('/exec') ? url.pathname : url.pathname.replace(/\/exec.*/,'/exec');
      return url.origin + path;
    })();

    // ======== å·¥å…· ========
    const fmt2 = n => String(n).padStart(2,'0');
    const todayStr = () => {
      const d = new Date();
      return d.getFullYear() + '-' + fmt2(d.getMonth()+1) + '-' + fmt2(d.getDate());
    };
    const nowHM = () => {
      const d = new Date();
      return fmt2(d.getHours()) + ':' + fmt2(d.getMinutes());
    };
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    async function safeJson(res){
      const t = await res.text();
      try{ return JSON.parse(t); } catch { return { __raw:t }; }
    }
    async function api(action, params={}){
      const qs = new URLSearchParams({action, ...params});
      const r = await fetch(`${BASE}?${qs.toString()}`, { method:'GET' });
      const j = await safeJson(r);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      if(j && j.success === false) throw new Error(j.error || 'API å¤±æ•—');
      return j.data ?? j; // å¥åº·æª¢æŸ¥å¯èƒ½å› {status:...}
    }

    // ======== ç‹€æ…‹ ========
    let RESOURCES = [];
    let DURATION_MIN = 120; // ç”±ä¸‹æ‹‰é¸å–®æ§åˆ¶
    let LAST_ID_MAP = {};   // æœ€æ–°å»ºç«‹çš„ id è¿½è¹¤ï¼ˆéå¿…è¦ï¼‰

    // ======== DOM åƒè€ƒ ========
    const $ = sel => document.querySelector(sel);
    const el = {
      todaySpan: $('#todaySpan'),
      lastUpdated: $('#lastUpdated'),
      nowSpan: $('#nowSpan'),
      kpiTotal: $('#kpiTotal'),
      kpiArrived: $('#kpiArrived'),
      kpiArrivedBreakdown: $('#kpiArrivedBreakdown'),
      kpiWait: $('#kpiWait'),
      kpiFree: $('#kpiFree'),
      badgeWait: $('#badgeWait'),
      badgeBlock: $('#badgeBlock'),
      resvList: $('#resvList'),
      waitList: $('#waitList'),
      blockList: $('#blockList'),
      freeGrid: $('#freeGrid'),
      durationSelect: $('#durationSelect'),
      btnRefresh: $('#btnRefresh'),
    };

    // ======== åˆå§‹åŒ– ========
    async function init(){
      el.todaySpan.textContent = `ï¼ˆ${todayStr()}ï¼‰`;
      el.nowSpan.textContent = nowHM();

      // åº§ä½è³‡æº
      RESOURCES = await api('getResources').catch(() => []);
      await refreshAll();

      // æ§åˆ¶é …
      el.durationSelect.addEventListener('change', () => {
        DURATION_MIN = Number(el.durationSelect.value || 120);
        refreshFreeOnly(); // åªæ›´æ–°å¯ç”¨åº§ä½æ›´å³æ™‚
      });
      el.btnRefresh.addEventListener('click', refreshAll);

      // æ¯ 30 ç§’è‡ªå‹•åˆ·æ–°
      setInterval(async ()=>{
        el.nowSpan.textContent = nowHM();
        await refreshAll();
      }, 30000);
    }

    // ======== åˆ·æ–°ç¸½ç®¡ ========
    async function refreshAll(){
      const date = todayStr();
      const [resv, wait, blocks] = await Promise.all([
        api('getReservations', {date}).catch(()=>[]),
        api('getWaitlist', {date}).catch(()=>[]),
        getBlocks(date) // å¯èƒ½å¾Œç«¯å°šæœªé–‹æ”¾ï¼Œå…§å«å®¹éŒ¯
      ]);

      renderReservations(resv);
      renderWaitlist(wait);
      renderBlocks(blocks);
      await refreshFreeOnly();

      el.lastUpdated.textContent = new Date().toLocaleTimeString('zh-TW', {hour12:false});
    }

    // åªåˆ·æ–°ã€Œå¯ç”¨åº§ä½ã€
    async function refreshFreeOnly(){
      const now = nowHM();
      const date = todayStr();
      const checks = await Promise.all(RESOURCES.map(r => api('checkAvailability', {
        resourceId: r.id, date, time: now, duration: DURATION_MIN
      }).catch(()=>({available:false, __err:true}))));

      const items = RESOURCES.map((r, i) => ({res:r, ok: !!checks[i] && checks[i].available === true}));
      renderFree(items);
      // KPIï¼šå¯ç”¨æ•¸
      el.kpiFree.textContent = items.filter(x=>x.ok).length;
    }

    // ======== å¾Œç«¯ï¼šå°é– API å…¼å®¹ ========
    async function getBlocks(date){
      try{
        const data = await api('getBlocked', {date});
        if(Array.isArray(data)) return data;
        return [];
      }catch(err){
        // å¾Œç«¯å°šæœªåŠ å…¥ getBlockedï¼šå›å‚³ç©ºé™£åˆ—ä¸¦åœ¨ç•«é¢æ¨™ç¤º 0
        console.log('getBlocked ä¸å¯ç”¨ï¼Œè«‹åœ¨ doGet ä¸­åŠ å…¥ case "getBlocked" â†’ successResponse(getBlockedPeriods("", date))');
        return [];
      }
    }

    // ======== Render å€ ========
    function renderReservations(list){
      const sorted = [...list].sort((a,b)=> (a.time||'').localeCompare(b.time||''));
      el.kpiTotal.textContent = sorted.length;

      const arrived = sorted.filter(r => r.status === 'checked_in' || r.status === 'completed');
      el.kpiArrived.textContent = arrived.length;
      const ci = sorted.filter(r=>r.status==='checked_in').length;
      const cp = sorted.filter(r=>r.status==='completed').length;
      el.kpiArrivedBreakdown.innerHTML = `
        <span class="tag">å·²åˆ°å ´ ${ci}</span>
        <span class="tag">å·²å®Œæˆ ${cp}</span>
      `;

      if(sorted.length === 0){
        el.resvList.innerHTML = `<div class="empty">ä»Šæ—¥å°šç„¡è¨‚ä½</div>`;
        return;
      }

      el.resvList.innerHTML = sorted.map(r=>{
        const res = RESOURCES.find(x=>x.id===r.resourceId);
        const seat = res ? `${res.name}` : r.resourceId;
        const badge = statusBadge(r.status);
        const note = r.notes ? `<div class="muted">ğŸ’¬ ${escapeHTML(r.notes)}</div>` : '';
        return `
          <div class="item">
            <div class="left">
              <div class="time">${r.time || '--:--'}</div>
              <div>
                <div class="name">${escapeHTML(r.customerName || '')} <span class="muted">(${r.partySize||'-'}äºº)</span></div>
                <div class="muted">${escapeHTML(seat||'')}</div>
                ${note}
              </div>
            </div>
            <div>${badge}</div>
          </div>
        `;
      }).join('');
    }

    function renderWaitlist(wait){
      el.kpiWait.textContent = wait.length;
      el.badgeWait.textContent = wait.length;
      if(wait.length === 0){
        el.waitList.innerHTML = `<div class="empty">ç„¡å€™è£œåå–®</div>`;
        return;
      }
      const s = [...wait].sort((a,b)=> (a.priority||0) - (b.priority||0));
      el.waitList.innerHTML = s.map(w=>{
        const pref = w.resourceId ? `åå¥½ï¼š${escapeHTML(w.resourceId)}` : 'ç„¡ç‰¹åˆ¥åå¥½';
        return `
          <div class="item">
            <div class="left">
              <div class="time">${w.time}</div>
              <div>
                <div class="name">${escapeHTML(w.customerName)}</div>
                <div class="muted">${w.partySize}äºº Â· ${pref}</div>
              </div>
            </div>
            <div class="badge b-confirmed">waiting</div>
          </div>
        `;
      }).join('');
    }

    function renderBlocks(blocks){
      el.badgeBlock.textContent = blocks.length;
      if(blocks.length === 0){
        el.blockList.innerHTML = `<div class="empty">ä»Šæ—¥ç„¡å°é–æ™‚æ®µ</div>`;
        return;
      }
      const s = [...blocks].sort((a,b)=> (a.startTime||'').localeCompare(b.startTime||''));
      el.blockList.innerHTML = s.map(b=>{
        const seat = b.resourceId ? findSeatName(b.resourceId) : 'å…¨å ´';
        return `
          <div class="item">
            <div class="left">
              <div class="time">${b.startTime}</div>
              <div>
                <div class="name">${escapeHTML(seat)}</div>
                <div class="muted">${b.startTime} ~ ${b.endTime}</div>
                <div class="muted">åŸå› ï¼š${escapeHTML(b.reason||'-')}</div>
              </div>
            </div>
            <div class="badge" style="background:#2a0a0a;color:#fca5a5;border:1px solid #7f1d1d">blocked</div>
          </div>
        `;
      }).join('');
    }

    function renderFree(items){
      if(items.length === 0){
        el.freeGrid.innerHTML = `<div class="empty" style="grid-column:1/-1">ç„¡åº§ä½è³‡æ–™</div>`;
        return;
      }
      el.freeGrid.innerHTML = items.map(({res, ok})=>{
        return `
          <div class="item" style="flex-direction:column;align-items:flex-start">
            <div class="row" style="justify-content:space-between;width:100%">
              <div class="name">${escapeHTML(res.name)}</div>
              <div class="muted">${res.capacity} äºº</div>
            </div>
            <div class="row" style="justify-content:space-between;width:100%;margin-top:6px">
              <div class="muted">é¡å‹ï¼š${escapeHTML(res.type||'-')}</div>
              <div class="badge ${ok?'b-confirmed':'b-no_show'}">${ok?'å¯ç”¨':'ä¸å¯ç”¨'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function statusBadge(status){
      const map = {
        confirmed: 'b-confirmed',
        checked_in: 'b-checked_in',
        completed: 'b-completed',
        no_show: 'b-no_show',
        cancelled: 'b-cancelled'
      };
      const cls = map[status] || 'b-confirmed';
      const text = ({
        confirmed:'å·²ç¢ºèª',
        checked_in:'å·²åˆ°å ´',
        completed:'å·²å®Œæˆ',
        no_show:'æœªåˆ°å ´',
        cancelled:'å·²å–æ¶ˆ'
      })[status] || status;
      return `<span class="badge ${cls}">${text}</span>`;
    }

    function findSeatName(id){
      const r = RESOURCES.find(x=>x.id===id);
      return r ? r.name : id;
    }
    function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function openMain(){ window.location.href = `${BASE}?ui=1`; }

    // å•Ÿå‹•
    (async ()=>{ await init(); })();
  </script>
</body>
</html>
