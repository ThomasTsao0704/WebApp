<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>美味餐廳 - 線上訂位系統（同源版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh
        }

        nav {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            height: 64px;
            align-items: center;
            padding: 0 1rem;
            justify-content: space-between
        }

        .nav-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827
        }

        .nav-buttons {
            display: flex;
            gap: .5rem
        }

        .nav-button {
            padding: .5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all .2s;
            height: 64px;
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .nav-button:hover {
            color: #374151
        }

        .nav-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb
        }

        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            z-index: 9999;
            justify-content: center;
            align-items: center
        }

        .loading-overlay.show {
            display: flex
        }

        .loading-spinner {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            text-align: center
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: .5rem
        }

        .hero p {
            font-size: 1.125rem;
            color: #6b7280
        }

        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
            padding: 1.5rem;
            margin-bottom: 1.5rem
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: .5rem;
            color: #111827
        }

        .grid {
            display: grid;
            gap: 1.5rem
        }

        .grid-2 {
            grid-template-columns: 1fr
        }

        @media(min-width:1024px) {
            .grid-2 {
                grid-template-columns: repeat(2, 1fr)
            }
        }

        .form-group {
            margin-bottom: 1rem
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: .5rem;
            color: #374151
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: .75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all .2s
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: 0;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, .1)
        }

        .btn {
            padding: .75rem 1.5rem;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all .2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: .5rem
        }

        .btn-primary {
            background: #2563eb;
            color: #fff
        }

        .btn-primary:hover {
            background: #1d4ed8
        }

        .btn-full {
            width: 100%;
            justify-content: center
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151
        }

        .btn-secondary:hover {
            background: #e5e7eb
        }

        .resource-card {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all .2s;
            margin-bottom: .75rem
        }

        .resource-card:hover {
            border-color: #9ca3af;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1)
        }

        .resource-card.selected {
            border-color: #2563eb;
            background: #eff6ff
        }

        .resource-name {
            font-weight: 600;
            margin-bottom: .25rem;
            color: #111827
        }

        .resource-capacity {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: .5rem
        }

        .resource-tags {
            display: flex;
            gap: .25rem;
            flex-wrap: wrap
        }

        .tag {
            padding: .25rem .5rem;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 12px;
            color: #4b5563
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: .5rem
        }

        @media(min-width:768px) {
            .time-slots {
                grid-template-columns: repeat(4, 1fr)
            }
        }

        .time-slot {
            padding: .75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all .2s
        }

        .time-slot:hover:not(.unavailable) {
            border-color: #93c5fd;
            background: #eff6ff
        }

        .time-slot.selected {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb
        }

        .time-slot.unavailable {
            background: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: .75rem
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd
        }

        .reservation-item {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0
        }

        .reservation-item:last-child {
            border-bottom: none
        }

        .reservation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: .5rem
        }

        .reservation-time {
            font-weight: 600;
            color: #111827
        }

        .reservation-details {
            font-size: 14px;
            color: #6b7280
        }

        .status-badge {
            padding: .25rem .75rem;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500
        }

        .status-confirmed {
            background: #dcfce7;
            color: #166534
        }

        .status-checked_in {
            background: #dbeafe;
            color: #1e40af
        }

        .status-completed {
            background: #f3f4f6;
            color: #4b5563
        }

        .status-no_show {
            background: #fee2e2;
            color: #991b1b
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b
        }

        .hidden {
            display: none !important
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem
        }

        .api-setup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem
        }

        .api-setup input {
            margin-top: .75rem
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>處理中...</p>
        </div>
    </div>

    <!-- 導航列 -->
    <nav>
        <div class="nav-container">
            <div class="nav-brand">🍽️ 美味餐廳</div>
            <div class="nav-buttons">
                <button class="nav-button active" onclick="switchView(event, 'customer')">👤 線上訂位</button>
                <button class="nav-button" onclick="switchView(event, 'staff')">📋 管理後台</button>
            </div>
        </div>
    </nav>

    <!-- 顧客訂位視圖 -->
    <div id="customerView" class="container">
        <!-- 同源模式預設隱藏；只有 file:// 或你想改外網時才會顯示 -->
        <div id="apiSetup" class="api-setup hidden">
            <h3 style="margin-bottom:.5rem;">⚙️ 系統設定</h3>
            <p style="font-size:14px;opacity:.9">請輸入您的 Google Apps Script API 網址</p>
            <input type="text" id="apiUrlInput" class="form-input"
                placeholder="https://script.google.com/macros/s/.../exec" style="background:#fff;color:#111827;">
            <button onclick="saveApiUrl()" class="btn btn-primary" style="margin-top:1rem;">💾 儲存設定</button>
        </div>

        <!-- 提示訊息容器 -->
        <div id="alertContainer"></div>

        <!-- 標題區 -->
        <div class="hero">
            <h1>線上訂位服務</h1>
            <p>選擇您喜歡的日期、時間和座位</p>
        </div>

        <!-- 訂位表單 -->
        <div class="grid grid-2">
            <!-- 左側：選擇區 -->
            <div>
                <div class="card">
                    <h3 class="card-title">📅 選擇日期</h3>
                    <input type="date" id="customerDate" class="form-input" onchange="onDateChange()">
                </div>

                <div class="card">
                    <h3 class="card-title">👥 用餐人數</h3>
                    <select id="partySize" class="form-select" onchange="filterResources()">
                        <option value="1">1 人</option>
                        <option value="2" selected>2 人</option>
                        <option value="3">3 人</option>
                        <option value="4">4 人</option>
                        <option value="5">5 人</option>
                        <option value="6">6 人</option>
                        <option value="7">7 人</option>
                        <option value="8">8 人</option>
                    </select>
                </div>

                <div class="card">
                    <h3 class="card-title">🪑 選擇座位</h3>
                    <div id="resourceList">
                        <div class="empty-state">
                            <div class="empty-state-icon">🔍</div>
                            <p>載入座位資料中...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：時間與表單 -->
            <div>
                <div id="timeSlotCard" class="card hidden">
                    <h3 class="card-title">⏰ 選擇時間</h3>
                    <div id="timeSlotsList" class="time-slots"></div>
                </div>

                <div id="bookingForm" class="card hidden">
                    <h3 class="card-title">📝 填寫資訊</h3>
                    <div class="form-group">
                        <label class="form-label">姓名 *</label>
                        <input type="text" id="customerName" class="form-input" placeholder="請輸入您的姓名">
                    </div>
                    <div class="form-group">
                        <label class="form-label">手機號碼 *</label>
                        <input type="tel" id="customerPhone" class="form-input" placeholder="請輸入您的手機號碼">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email（選填）</label>
                        <input type="email" id="customerEmail" class="form-input" placeholder="請輸入您的 Email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">特殊需求</label>
                        <textarea id="customerNotes" class="form-textarea" rows="3"
                            placeholder="如有特殊需求請告知我們（例如：素食、兒童座椅等）"></textarea>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="confirmReservation()">✅ 確認預約</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 員工後台視圖 -->
    <div id="staffView" class="container hidden">
        <div style="margin-bottom:2rem;">
            <h1 style="font-size:1.875rem;font-weight:700;color:#111827;margin-bottom:1rem;">預約管理</h1>
            <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                <input type="date" id="staffDate" class="form-input" style="max-width:200px;"
                    onchange="loadStaffReservations()">
                <span style="color:#6b7280;">共 <strong id="totalReservations">0</strong> 筆預約</span>
                <button class="btn btn-secondary" onclick="loadStaffReservations()">🔄 重新整理</button>
            </div>
        </div>

        <div class="card">
            <div id="staffReservationList">
                <div class="empty-state">
                    <div class="empty-state-icon">📅</div>
                    <p>載入預約資料中...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ---------------- 同源 API 偵測 ----------------
        function getBaseExecUrl() {
            const u = new URL(location.href);
            // 確保回到 /exec
            return `${u.origin}${u.pathname.replace(/\/exec.*/, '/exec')}`;
        }
        function isSameOriginUsable() { return location.protocol !== 'file:'; }

        // ---------------- 狀態 & 公用 ------------------
        let apiUrl = '';
        let resources = [];
        let selectedResource = null;
        let selectedTime = null;

        function showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('show', show); }
        function showAlert(message, type = 'success') {
            const c = document.getElementById('alertContainer');
            const el = document.createElement('div');
            el.className = `alert alert-${type}`;
            el.innerHTML = `<span style="font-size:1.25rem;">${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}</span><span>${esc(message)}</span>`;
            c.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-10px)'; el.style.transition = 'all .3s'; setTimeout(() => el.remove(), 300); }, 5000);
        }
        function esc(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

        // ---------------- API 呼叫（GET，免 preflight） ----------------
        async function callAPI(action, params = {}) {
            if (!apiUrl) { showAlert('請先設定或確認 API 網址', 'error'); return null; }
            const qs = new URLSearchParams({ action, ...params }).toString();
            const url = `${apiUrl}?${qs}`;
            showLoading(true);
            try {
                const res = await fetch(url, { method: 'GET' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const text = await res.text();
                let json; try { json = JSON.parse(text); } catch { throw new Error('回應不是 JSON：' + text.slice(0, 120)); }
                if (!json.success) throw new Error(json.error || '操作失敗');
                return json.data;
            } catch (err) {
                showAlert('API 呼叫失敗: ' + err.message, 'error');
                return null;
            } finally { showLoading(false); }
        }

        // ---------------- 初始化 ----------------
        function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('customerDate').value = today;
            document.getElementById('customerDate').min = today;
            document.getElementById('staffDate').value = today;

            const savedUrl = localStorage.getItem('gasApiUrl');
            if (savedUrl) {
                apiUrl = savedUrl;
                const el = document.getElementById('apiUrlInput'); if (el) el.value = savedUrl;
            } else if (isSameOriginUsable()) {
                apiUrl = getBaseExecUrl();
                const setup = document.getElementById('apiSetup'); if (setup) setup.classList.add('hidden');
            } else {
                const setup = document.getElementById('apiSetup'); if (setup) setup.classList.remove('hidden');
            }

            if (apiUrl) loadResources();
        }

        // 提供外部網域時手動儲存
        function saveApiUrl() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if (!url) { showAlert('請輸入 API 網址', 'error'); return; }
            if (!url.includes('script.google.com') || !url.endsWith('/exec')) {
                showAlert('請輸入有效的 Google Apps Script 網址', 'error'); return;
            }
            apiUrl = url; localStorage.setItem('gasApiUrl', url);
            document.getElementById('apiSetup').classList.add('hidden');
            showAlert('✅ API 網址已儲存', 'success'); loadResources();
        }

        // ---------------- 顧客流程 ----------------
        async function loadResources() {
            const data = await callAPI('getResources');
            if (data) { resources = data; filterResources(); }
        }

        function filterResources() {
            const partySize = parseInt(document.getElementById('partySize').value, 10);
            const filtered = resources.filter(r => Number(r.capacity) >= partySize);
            const html = filtered.map(r => `
        <div class="resource-card ${selectedResource === r.id ? 'selected' : ''}" onclick="selectResource('${esc(r.id)}')">
          <div class="resource-name">${esc(r.name)}</div>
          <div class="resource-capacity">最多 ${esc(r.capacity)} 人</div>
          <div class="resource-tags">${(r.tags || []).map(t => `<span class="tag">${esc(t)}</span>`).join('')}</div>
        </div>
      `).join('');
            document.getElementById('resourceList').innerHTML = html || `
        <div class="empty-state"><div class="empty-state-icon">😅</div><p>沒有符合條件的座位</p></div>`;
        }

        function onDateChange() {
            selectedResource = null; selectedTime = null;
            document.getElementById('timeSlotCard').classList.add('hidden');
            document.getElementById('bookingForm').classList.add('hidden');
            filterResources();
        }

        function selectResource(resourceId) {
            selectedResource = resourceId; selectedTime = null;
            filterResources(); loadTimeSlots();
            document.getElementById('timeSlotCard').classList.remove('hidden');
            document.getElementById('bookingForm').classList.add('hidden');
        }

        // 生成 11:00~21:00、每 30 分
        function generateTimeSlots() {
            const slots = []; for (let h = 11; h <= 21; h++) {
                for (let m = 0; m < 60; m += 30) {
                    slots.push(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
                }
            }
            return slots;
        }

        // 並行 + 限流加速查詢
        async function loadTimeSlots() {
            const date = document.getElementById('customerDate').value;
            const timeSlots = generateTimeSlots();
            const maxConcurrent = 8;
            const chunks = [];
            for (let i = 0; i < timeSlots.length; i += maxConcurrent) { chunks.push(timeSlots.slice(i, i + maxConcurrent)); }

            const results = {};
            for (const chunk of chunks) {
                const batch = chunk.map(time => callAPI('checkAvailability', {
                    resourceId: selectedResource, date, time, duration: 120
                }).then(r => ({ time, ok: !!(r && r.available) })).catch(() => ({ time, ok: false })));
                const settled = await Promise.all(batch);
                settled.forEach(({ time, ok }) => { results[time] = ok; });
            }

            const html = timeSlots.map(time => {
                const available = !!results[time];
                return `
          <button class="time-slot ${!available ? 'unavailable' : ''} ${selectedTime === time ? 'selected' : ''}"
                  onclick="${available ? `selectTime('${time}')` : ''}" ${!available ? 'disabled' : ''}>
            ${time}
          </button>`;
            }).join('');
            document.getElementById('timeSlotsList').innerHTML = html;
        }

        function selectTime(time) {
            selectedTime = time; loadTimeSlots();
            const form = document.getElementById('bookingForm');
            form.classList.remove('hidden'); form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function confirmReservation() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();
            const date = document.getElementById('customerDate').value;
            const partySize = parseInt(document.getElementById('partySize').value, 10);

            if (!name || !phone) { showAlert('請填寫姓名和手機號碼', 'error'); return; }

            const result = await callAPI('createReservation', {
                resourceId: selectedResource, customerName: name, phone, email,
                date, time: selectedTime, duration: 120, partySize, status: 'confirmed', notes
            });

            if (result) {
                showAlert(`🎉 預約成功！訂位編號：${esc(result.id)}`, 'success');
                // 重置表單
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('customerEmail').value = '';
                document.getElementById('customerNotes').value = '';
                selectedResource = null; selectedTime = null;
                document.getElementById('timeSlotCard').classList.add('hidden');
                document.getElementById('bookingForm').classList.add('hidden');
                filterResources();
                // 若正在看後台，順便刷新
                if (!document.getElementById('staffView').classList.contains('hidden')) {
                    loadStaffReservations();
                }
            }
        }

        // ---------------- 後台 ----------------
        async function loadStaffReservations() {
            const date = document.getElementById('staffDate').value;
            const data = await callAPI('getReservations', { date });
            if (data) {
                document.getElementById('totalReservations').textContent = data.length;
                if (data.length === 0) {
                    document.getElementById('staffReservationList').innerHTML =
                        '<div class="empty-state"><div class="empty-state-icon">📭</div><p>今日無預約</p></div>';
                    return;
                }
                const html = data.sort((a, b) => a.time.localeCompare(b.time))
                    .map(r => {
                        const res = resources.find(x => x.id === r.resourceId);
                        return `
              <div class="reservation-item">
                <div class="reservation-header">
                  <div>
                    <div class="reservation-time">${esc(r.time)} - ${esc(res?.name || r.resourceId)}</div>
                    <div class="reservation-details">${esc(r.customerName)} (${esc(r.phone)}) - ${esc(r.partySize)}人</div>
                    ${r.notes ? `<div class="reservation-details" style="margin-top:.25rem;">💬 ${esc(r.notes)}</div>` : ''}
                  </div>
                  <span class="status-badge status-${esc(r.status)}">${esc(getStatusText(r.status))}</span>
                </div>
              </div>`;
                    }).join('');
                document.getElementById('staffReservationList').innerHTML = html;
            }
        }

        function getStatusText(status) {
            const map = { 'confirmed': '已確認', 'checked_in': '已到場', 'completed': '已完成', 'no_show': '未到場', 'cancelled': '已取消' };
            return map[status] || status;
        }

        // ---------------- 視圖切換 ----------------
        function switchView(ev, view) {
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            ev.currentTarget.classList.add('active');
            document.getElementById('customerView').classList.add('hidden');
            document.getElementById('staffView').classList.add('hidden');
            document.getElementById(view + 'View').classList.remove('hidden');
            if (view === 'staff') { loadStaffReservations(); }
        }

        // ---------------- 啟動 ----------------
        window.onload = init;
    </script>
</body>

</html>
