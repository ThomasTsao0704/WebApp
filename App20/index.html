<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆé¤é»é¤ç³»çµ±</title>
    <link rel="manifest" href="#" id="manifest-placeholder">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="é»é¤ç³»çµ±">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(45deg, #2563eb, #3b82f6); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .date-display { font-size: 1rem; opacity: 0.9; }
        .install-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; display: none;
        }
        .install-btn:hover { background: rgba(255,255,255,0.3); }
        .content { padding: 30px; }
        .tabs { display: flex; margin-bottom: 30px; background: #f8fafc; border-radius: 12px; padding: 4px; }
        .tab { flex: 1; background: none; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.3s; }
        .tab.active { background: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        input, select, textarea {
            width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #2563eb; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .menu-item {
            background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .menu-item:hover { border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); }
        .menu-item.selected { border-color: #2563eb; background: #eff6ff; }
        .menu-item h3 { color: #1f2937; margin-bottom: 8px; font-size: 1.2rem; }
        .menu-item .price { color: #ef4444; font-weight: 600; font-size: 1.1rem; }
        .btn {
            background: #2563eb; color: white; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; width: 100%;
        }
        .btn:hover { background: #1d4ed8; transform: translateY(-1px); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .orders-table th, .orders-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .orders-table th { background: #f8fafc; font-weight: 600; color: #374151; }
        .orders-table tr:hover { background: #f9fafb; }
        .qr-section { background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .qr-code { background: white; padding: 20px; border-radius: 8px; display: inline-block; margin: 10px 0; }
        .employee-login { background: #fef3c7; border: 1px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .status { padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status.error { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .admin-controls { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger:hover { background: #dc2626; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="install-btn" onclick="installApp()">å®‰è£ APP</button>
            <h1>ğŸ± åˆé¤é»é¤ç³»çµ±</h1>
            <div class="date-display" id="dateDisplay"></div>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('order')">é»é¤</button>
                <button class="tab" onclick="switchTab('view')">æŸ¥çœ‹è¨‚å–®</button>
                <button class="tab" onclick="switchTab('qr')">QRç™»å…¥</button>
                <button class="tab" onclick="switchTab('admin')">ç®¡ç†</button>
            </div>

            <div id="status" class="status" style="display: none;"></div>

            <!-- é»é¤é é¢ -->
            <div id="order-tab" class="tab-content active">
                <div class="employee-login">
                    <div class="form-group">
                        <label for="employeeId">å·¥è™Ÿ</label>
                        <input type="text" id="employeeId" placeholder="è«‹è¼¸å…¥å·¥è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label for="employeeName">å§“å</label>
                        <input type="text" id="employeeName" placeholder="è«‹è¼¸å…¥å§“å">
                    </div>
                </div>

                <h3 style="margin-bottom: 20px; color: #1f2937;">é¸æ“‡é¤é»</h3>
                <div class="menu-grid" id="menuGrid"></div>

                <div class="form-group">
                    <label for="specialRequest">ç‰¹æ®Šéœ€æ±‚ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea id="specialRequest" rows="3" placeholder="ä¾‹å¦‚ï¼šä¸è¦é¦™èœã€é£¯å°‘ä¸€é»..."></textarea>
                </div>

                <button class="btn" onclick="submitOrder()">æäº¤è¨‚å–®</button>
            </div>

            <!-- æŸ¥çœ‹è¨‚å–®é é¢ -->
            <div id="view-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #1f2937;">ä»Šæ—¥è¨‚å–®</h3>
                    <button class="btn-secondary btn" style="width: auto;" onclick="loadOrders()">åˆ·æ–°</button>
                </div>
                <div id="ordersContainer">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>æ™‚é–“</th>
                                <th>å·¥è™Ÿ</th>
                                <th>å§“å</th>
                                <th>é¤é»</th>
                                <th>åƒ¹æ ¼</th>
                                <th>ç‰¹æ®Šéœ€æ±‚</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
                <div id="ordersSummary" style="margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;"></div>
            </div>

            <!-- QRç™»å…¥é é¢ -->
            <div id="qr-tab" class="tab-content">
                <div class="qr-section">
                    <h3 style="margin-bottom: 15px; color: #1f2937;">QR Code å¿«é€Ÿç™»å…¥</h3>
                    <p style="margin-bottom: 20px; color: #6b7280;">æƒæ QR Code å¿«é€Ÿå¡«å…¥å·¥è™Ÿ</p>
                    <div class="qr-code">
                        <!-- é€™è£¡æ”¹æˆ canvasï¼ˆåŸæœ¬æ˜¯ divï¼‰ -->
                        <canvas id="qrcode" width="200" height="200" style="display:block"></canvas>
                    </div>
                    <div class="form-group">
                        <label for="qrEmployeeId">ç”¢ç”Ÿå·¥è™Ÿ QR Code</label>
                        <input type="text" id="qrEmployeeId" placeholder="è¼¸å…¥å·¥è™Ÿç”¢ç”Ÿ QR Code">
                        <button class="btn" style="margin-top: 10px;" onclick="generateQR()">ç”¢ç”Ÿ QR Code</button>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†é é¢ -->
            <div id="admin-tab" class="tab-content">
                <h3 style="margin-bottom: 20px; color: #1f2937;">ç³»çµ±ç®¡ç†</h3>
                
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">è³‡æ–™ç®¡ç†</h4>
                    <div class="admin-controls">
                        <button class="btn btn-secondary" onclick="exportData()">åŒ¯å‡ºè³‡æ–™</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">åŒ¯å…¥è³‡æ–™</button>
                        <button class="btn btn-danger" onclick="clearTodayOrders()">æ¸…ç©ºä»Šæ—¥è¨‚å–®</button>
                        <button class="btn btn-danger" onclick="clearAllOrders()">æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>

                <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; border: 1px solid #0ea5e9;">
                    <h4 style="margin-bottom: 15px;">è‡ªå‹•æ¸…ç©ºè¨­å®š</h4>
                    <label>
                        <input type="checkbox" id="autoCleanEnabled" onchange="toggleAutoClean()"> 
                        æ¯æ—¥è‡ªå‹•æ¸…ç©ºå‰ä¸€å¤©çš„è¨‚å–®
                    </label>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
                        å•Ÿç”¨å¾Œï¼Œç³»çµ±æœƒåœ¨æ¯å¤©ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚è‡ªå‹•æ¸…ç©ºå‰ä¸€å¤©çš„è¨‚å–®è¨˜éŒ„
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

    <script>
        // PWA ç›¸é—œé…ç½®
        const manifest = {
            name: "åˆé¤é»é¤ç³»çµ±",
            short_name: "é»é¤ç³»çµ±",
            description: "å…§ç¶²åˆé¤é»é¤ç³»çµ±",
            start_url: "./",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#2563eb",
            icons: [
                {
                    src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMjU2M2ViIiByeD0iMzIiLz4KPHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgeD0iMzIiIHk9IjMyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KICA8cGF0aCBkPSJNMTggN2wtMS40MS0xLjQxLTYuMzQgNi4zNGMtLjM5LjM5LS4zOS4xLS4zOS0uNDlzMC0uODguMzkxLTEuMjdsMi44My0yLjgzTDEyIDZsLTEuNDEgMS40MSAyLjEzIDIuMTNjLS4zOS4zOS0uMzkgMS4wMyAwIDEuNDJsLjcxLjcxYy4zOS4zOSAxLjAzLjM5IDEuNDIgMGwyLjEzLTIuMTNMMTggN3oiLz4KICA8cGF0aCBkPSJNMiAxOWgxNXYySDJ6Ii8+CiAgPHBhdGggZD0iTTIgMTFoMTB2MkgyeiIvPgo8L3N2Zz4KPC9zdmc+",
                    sizes: "192x192",
                    type: "image/svg+xml"
                }
            ]
        };

        // å»ºç«‹ manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;

        // Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'lunch-order-v1';
                const urlsToCache = [
                    './',
                    'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                return response || fetch(event.request);
                            })
                    );
                });
            `;
            const swBlob = new Blob([swCode], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swURL);
        }

        // PWA å®‰è£æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.querySelector('.install-btn').style.display = 'block';
        });
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(() => {
                    deferredPrompt = null;
                    document.querySelector('.install-btn').style.display = 'none';
                });
            }
        }

        // ç³»çµ±é…ç½®
        const config = {
            dataFile: 'lunch_orders.json', // å…±ç”¨è³‡æ–™æª”æ¡ˆè·¯å¾‘ï¼ˆç¤ºç¯„ç‰ˆä»ç”¨ localStorageï¼‰
            menuItems: [
                { id: 1, name: 'é›è…¿ä¾¿ç•¶', price: 85 },
                { id: 2, name: 'æ’éª¨ä¾¿ç•¶', price: 80 },
                { id: 3, name: 'é­šæ’ä¾¿ç•¶', price: 90 },
                { id: 4, name: 'ç´ é£Ÿä¾¿ç•¶', price: 75 },
                { id: 5, name: 'ç‰›è‚‰éºµ', price: 120 },
                { id: 6, name: 'è±¬è‚‰éºµ', price: 100 },
                { id: 7, name: 'é™½æ˜¥éºµ', price: 60 },
                { id: 8, name: 'ç‚¸é›ä¾¿ç•¶', price: 95 }
            ]
        };

        // å…¨åŸŸè®Šæ•¸
        let selectedMenuItem = null;
        let allOrders = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDate();
            initializeMenu();
            loadOrders();
            checkAutoClean();
            loadSettings();
            
            // æª¢æŸ¥ URL åƒæ•¸ï¼ˆQR Code ç™»å…¥ï¼‰
            const urlParams = new URLSearchParams(window.location.search);
            const employeeId = urlParams.get('emp');
            if (employeeId) {
                document.getElementById('employeeId').value = employeeId;
                showStatus('å·²é€é QR Code è‡ªå‹•å¡«å…¥å·¥è™Ÿ', 'success');
            }
        });

        // æ›´æ–°æ—¥æœŸé¡¯ç¤º
        function updateDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-TW', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });
            document.getElementById('dateDisplay').textContent = dateStr;
        }

        // åˆå§‹åŒ–èœå–®
        function initializeMenu() {
            const menuGrid = document.getElementById('menuGrid');
            menuGrid.innerHTML = '';
            config.menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.onclick = () => selectMenuItem(item.id);
                menuItem.innerHTML = `<h3>${item.name}</h3><div class="price">$${item.price}</div>`;
                menuGrid.appendChild(menuItem);
            });
        }

        // é¸æ“‡é¤é»
        function selectMenuItem(itemId) {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.menu-item').classList.add('selected');
            selectedMenuItem = config.menuItems.find(item => item.id === itemId);
        }

        // åˆ‡æ›é ç±¤
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            if (tabName === 'view') loadOrders();
        }

        // æäº¤è¨‚å–®
        async function submitOrder() {
            const employeeId = document.getElementById('employeeId').value.trim();
            const employeeName = document.getElementById('employeeName').value.trim();
            const specialRequest = document.getElementById('specialRequest').value.trim();
            if (!employeeId || !employeeName) { showStatus('è«‹å¡«å…¥å·¥è™Ÿå’Œå§“å', 'error'); return; }
            if (!selectedMenuItem) { showStatus('è«‹é¸æ“‡é¤é»', 'error'); return; }

            const order = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                employeeId, employeeName,
                menuItem: selectedMenuItem,
                specialRequest,
                date: new Date().toDateString()
            };
            try {
                await saveOrder(order);
                showStatus(`è¨‚å–®æäº¤æˆåŠŸï¼${selectedMenuItem.name} - $${selectedMenuItem.price}`, 'success');
                document.getElementById('specialRequest').value = '';
                document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('selected'));
                selectedMenuItem = null;
                if (document.getElementById('view-tab').classList.contains('active')) loadOrders();
            } catch (error) {
                showStatus('è¨‚å–®æäº¤å¤±æ•—: ' + error.message, 'error');
            }
        }

        // å„²å­˜è¨‚å–®åˆ°æª”æ¡ˆï¼ˆç¤ºç¯„ç‰ˆç”¨ localStorageï¼‰
        async function saveOrder(order) {
            try {
                let orders = await loadOrdersFromFile();
                const today = new Date().toDateString();
                const existingOrder = orders.find(o =>
                    o.employeeId === order.employeeId &&
                    new Date(o.timestamp).toDateString() === today
                );
                if (existingOrder) Object.assign(existingOrder, order);
                else orders.push(order);
                await saveOrdersToFile(orders);
                allOrders = orders;
            } catch (error) {
                console.error('Save order error:', error);
                throw new Error('ç„¡æ³•å„²å­˜è¨‚å–®ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ¬Šé™');
            }
        }

        async function loadOrdersFromFile() {
            try {
                const response = await fetch(config.dataFile);
                if (response.ok) return await response.json();
                return [];
            } catch { return []; }
        }

        async function saveOrdersToFile(orders) {
            try {
                const data = JSON.stringify(orders, null, 2);
                localStorage.setItem('lunchOrders', data);
                // çœŸå¯¦ç’°å¢ƒæ‡‰æ”¹ç‚º POST åˆ°ä½ çš„æª”æ¡ˆä¼ºæœå™¨/API
            } catch { throw new Error('ç„¡æ³•å¯«å…¥æª”æ¡ˆ'); }
        }

        // è¼‰å…¥è¨‚å–®åˆ—è¡¨
        async function loadOrders() {
            try {
                const data = localStorage.getItem('lunchOrders');
                allOrders = data ? JSON.parse(data) : [];
                displayOrders();
            } catch (error) {
                showStatus('è¼‰å…¥è¨‚å–®å¤±æ•—: ' + error.message, 'error');
            }
        }

        // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
        function displayOrders() {
            const today = new Date().toDateString();
            const todayOrders = allOrders.filter(order => new Date(order.timestamp).toDateString() === today);
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            if (todayOrders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">ä»Šæ—¥å°šç„¡è¨‚å–®</td></tr>';
                document.getElementById('ordersSummary').innerHTML = '';
                return;
            }
            todayOrders.forEach(order => {
                const row = document.createElement('tr');
                const orderTime = new Date(order.timestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                row.innerHTML = `
                    <td>${orderTime}</td>
                    <td>${order.employeeId}</td>
                    <td>${order.employeeName}</td>
                    <td>${order.menuItem.name}</td>
                    <td>$${order.menuItem.price}</td>
                    <td>${order.specialRequest || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
            displayOrderSummary(todayOrders);
        }

        // é¡¯ç¤ºè¨‚å–®çµ±è¨ˆ
        function displayOrderSummary(orders) {
            const summary = {}; let totalAmount = 0;
            orders.forEach(order => {
                const itemName = order.menuItem.name;
                if (!summary[itemName]) summary[itemName] = { count: 0, price: order.menuItem.price };
                summary[itemName].count++; totalAmount += order.menuItem.price;
            });
            let summaryHtml = '<h4 style="margin-bottom: 15px;">ä»Šæ—¥çµ±è¨ˆ</h4>';
            summaryHtml += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
            Object.entries(summary).forEach(([itemName, data]) => {
                summaryHtml += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <div style="font-weight: 600;">${itemName}</div>
                        <div style="color: #6b7280;">æ•¸é‡: ${data.count}</div>
                        <div style="color: #ef4444; font-weight: 600;">å°è¨ˆ: $${data.count * data.price}</div>
                    </div>`;
            });
            summaryHtml += '</div>';
            summaryHtml += `<div style="margin-top: 15px; padding: 15px; background: #eff6ff; border-radius: 8px; text-align: center;">
                <strong>ç¸½è¨‚å–®æ•¸: ${orders.length} | ç¸½é‡‘é¡: ${totalAmount}</strong>
            </div>`;
            document.getElementById('ordersSummary').innerHTML = summaryHtml;
        }

        // âœ… QR Code ç”¢ç”Ÿï¼ˆæ”¹ç”¨ Canvas ç›®æ¨™ï¼‰
        function generateQR() {
            const employeeId = document.getElementById('qrEmployeeId').value.trim();
            if (!employeeId) { showStatus('è«‹è¼¸å…¥å·¥è™Ÿ', 'error'); return; }

            const qrData = window.location.origin + window.location.pathname + '?emp=' + encodeURIComponent(employeeId);
            const canvas = document.getElementById('qrcode');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            QRCode.toCanvas(
                canvas,
                qrData,
                { width: 200, margin: 2 },
                function (error) {
                    if (error) {
                        console.error(error);
                        showStatus('QR Code ç”¢ç”Ÿå¤±æ•—', 'error');
                    } else {
                        showStatus('QR Code ç”¢ç”ŸæˆåŠŸ', 'success');
                    }
                }
            );
        }

        // ç®¡ç†åŠŸèƒ½
        function exportData() {
            const data = { orders: allOrders, exportDate: new Date().toISOString(), version: '1.0' };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lunch_orders_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('è³‡æ–™åŒ¯å‡ºæˆåŠŸ', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.orders && Array.isArray(data.orders)) {
                        allOrders = data.orders;
                        await saveOrdersToFile(allOrders);
                        displayOrders();
                        showStatus('è³‡æ–™åŒ¯å…¥æˆåŠŸ', 'success');
                    } else {
                        showStatus('ç„¡æ•ˆçš„è³‡æ–™æ ¼å¼', 'error');
                    }
                } catch (error) {
                    showStatus('è³‡æ–™åŒ¯å…¥å¤±æ•—: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearTodayOrders() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºä»Šæ—¥æ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                const today = new Date().toDateString();
                allOrders = allOrders.filter(order => new Date(order.timestamp).toDateString() !== today);
                saveOrdersToFile(allOrders);
                displayOrders();
                showStatus('ä»Šæ—¥è¨‚å–®å·²æ¸…ç©º', 'success');
            }
        }

        function clearAllOrders() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                allOrders = [];
                saveOrdersToFile(allOrders);
                displayOrders();
                showStatus('æ‰€æœ‰è¨‚å–®å·²æ¸…ç©º', 'success');
            }
        }

        // è‡ªå‹•æ¸…ç©ºåŠŸèƒ½
        function toggleAutoClean() {
            const enabled = document.getElementById('autoCleanEnabled').checked;
            localStorage.setItem('autoCleanEnabled', enabled);
            showStatus(enabled ? 'å·²å•Ÿç”¨è‡ªå‹•æ¸…ç©º' : 'å·²åœç”¨è‡ªå‹•æ¸…ç©º', 'success');
        }
        function checkAutoClean() {
            const enabled = localStorage.getItem('autoCleanEnabled') === 'true';
            const lastCleanDate = localStorage.getItem('lastCleanDate');
            const today = new Date().toDateString();
            if (enabled && lastCleanDate !== today) {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();
                allOrders = allOrders.filter(order => new Date(order.timestamp).toDateString() !== yesterdayStr);
                saveOrdersToFile(allOrders);
                localStorage.setItem('lastCleanDate', today);
                console.log('è‡ªå‹•æ¸…ç©ºå‰ä¸€å¤©è¨‚å–®å®Œæˆ');
            }
        }
        function loadSettings() {
            const autoCleanEnabled = localStorage.getItem('autoCleanEnabled') === 'true';
            document.getElementById('autoCleanEnabled').checked = autoCleanEnabled;
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
            statusElement.style.display = 'block';
            setTimeout(() => { statusElement.style.display = 'none'; }, 3000);
        }

        // å®šæœŸåˆ·æ–°è¨‚å–®ï¼ˆå¯é¸ï¼‰
        setInterval(() => {
            if (document.getElementById('view-tab').classList.contains('active')) loadOrders();
        }, 30000);
    </script>
</body>
</html>
