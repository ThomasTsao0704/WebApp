<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›å°¾é…’è­œç€è¦½</title>

    <!-- å¤–æ›ï¼šPapaParse ä¾› CSV è§£æ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .age-warning {
            background: rgba(255, 193, 7, 0.9);
            color: #856404;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .filters {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        input[type="text"],
        select,
        input[type="number"],
        input[type="url"],
        input[type="file"],
        textarea {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        input[type="file"] {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px dashed rgba(102, 126, 234, 0.3);
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: rgba(102, 126, 234, 0.6);
            background: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .stats {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 25px;
            font-size: 0.9rem;
        }

        /* ç¸½å®¹å™¨ï¼šå¤šæ¬„ç¶²æ ¼ */
        .cocktails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* åˆ—è¡¨æ¨¡å¼ï¼šå›ºå®šå–®æ¬„ */
        .cocktails-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .cocktail-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .cocktail-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .cocktail-image {
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 12px;
            font-size: 2rem;
        }

        .cocktail-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cocktail-content {
            padding: 20px;
        }

        .cocktail-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
            flex: 1;
            margin: 0 0 8px 0;
        }

        .cocktail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.85rem;
            color: #718096;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cocktail-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 15px;
        }

        .tag {
            background: #e2e8f0;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .cocktail-details {
            margin-top: 12px;
        }

        details {
            margin-bottom: 8px;
        }

        summary {
            cursor: pointer;
            font-weight: 500;
            color: #4299e1;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        summary:hover {
            color: #313cce;
        }

        .ingredients-list,
        .instructions-list {
            padding: 12px 0;
            line-height: 1.6;
            color: #3182ce;
        }

        .instruction {
            margin-bottom: 8px;
            padding-left: 16px;
            position: relative;
        }

        .instruction::before {
            content: counter(step-counter);
            counter-increment: step-counter;
            position: absolute;
            left: 0;
            top: 0;
            background: #4299e1;
            color: rgb(255, 255, 255);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .instructions-list {
            counter-reset: step-counter;
        }

        /* å°è¦½åˆ†é  */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* è¡¨å–®æ¨£å¼ */
        .add-cocktail-form {
            text-align: left;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .form-section h3 {
            color: white;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin-bottom: 6px;
        }

        .tags-input {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tags-display {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag-chip {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .tag-chip:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        .ingredient-item,
        .instruction-item {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .ingredient-item input,
        .instruction-item input {
            flex: 1;
        }

        .add-btn,
        .remove-btn,
        .btn {
            cursor: pointer;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #2d3748;
            margin-top: 8px;
        }

        .add-btn:hover {
            background: white;
            transform: translateY(-1px);
        }

        .remove-btn {
            background: #fed7d7;
            color: #822727;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .remove-btn:hover {
            background: #fbb6ce;
        }

        .btn-primary {
            background: #4299e1;
            color: #fff;
            padding: 12px 24px;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .success-message {
            display: none;
            background: rgba(72, 187, 120, 0.9);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Topbar æ¨£å¼ */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .brand {
            font-weight: 600;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .topbar .actions {
            display: flex;
            gap: 8px;
        }

        .btn-accent {
            background: #cde1ff;
            color: #2d3748;
        }

        .btn-accent:hover {
            background: #a3d2ff;
        }

        .btn-danger {
            background: #ffd6d6;
            color: #822727;
        }

        .btn-danger:hover {
            background: #fbb6ce;
        }

        /* ç·¨è¼¯æŠ½å±œ */
        .drawer {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: min(420px, 95vw);
            background: #fff;
            box-shadow: -8px 0 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
            overflow: auto;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .drawer:not(.hidden) {
            transform: translateX(0);
        }

        .drawer.hidden {
            transform: translateX(100%);
        }

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .drawer-header h3 {
            margin: 0;
            color: #2d3748;
        }

        .edit-form label {
            display: block;
            margin: 16px 0 6px;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
        }

        .edit-form input,
        .edit-form textarea,
        .edit-form select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: white;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .drawer-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        /* åœ–ç‰‡é è¦½æ¨£å¼ */
        #imagePreview img,
        #addImagePreview img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #addImagePreview {
            padding: 8px 0;
            text-align: center;
        }

        #imagePreview {
            margin: 8px 0;
        }

        /* å‹•ç•« */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            #cocktailsContainer.cocktails-grid {
                grid-template-columns: 1fr !important;
            }

            .filter-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .view-toggle {
                justify-self: center;
            }

            h1 {
                font-size: 2rem;
            }

            .cocktails-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .topbar {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }

            .topbar .actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-tabs {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }

            .nav-btn {
                width: 200px;
            }

            .drawer {
                width: 100vw;
            }

            .form-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            .filters {
                padding: 16px;
            }

            .form-section {
                padding: 16px;
            }

            .cocktail-card {
                margin: 0;
            }
        }

        /* å¯¦ç”¨é¡åˆ¥ */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <header class="topbar">
        <div class="brand">é›å°¾é…’è­œ WebApp</div>
        <div class="actions">
            <button id="btnPickFolder" class="btn btn-accent" type="button">é¸æ“‡è³‡æ–™å¤¾</button>
            <button id="btnWriteCSV" class="btn btn-accent" type="button">å¯«å…¥ cocktails.csv</button>
            <button id="btnExport" class="btn btn-accent" type="button">åŒ¯å‡º CSV</button>
        </div>
    </header>

    <div class="container">
        <header>
            <h1>ğŸ¸ é›å°¾é…’è­œç€è¦½</h1>
            <p class="subtitle">æ¢ç´¢ç¶“å…¸èª¿é…’ï¼Œäº«å—å“å‘³æ™‚å…‰</p>
            <div class="age-warning">âš ï¸ æœªæ»¿18æ­²è«‹å‹¿é£²é…’ï¼Œé£²é…’éé‡æœ‰å®³å¥åº·</div>
            <nav class="nav-tabs">
                <button class="nav-btn active" data-page="browse" type="button">ğŸ“– ç€è¦½é…’è­œ</button>
                <button class="nav-btn" data-page="add" type="button">â• æ–°å¢é…’è­œ</button>
            </nav>
        </header>

        <!-- ç€è¦½å€ -->
        <div class="page active" id="browsePage">
            <div class="filters">
                <div class="filter-row">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é›å°¾é…’ã€åŸºé…’æˆ–æ¨™ç±¤..." />
                    <select id="categorySelect">
                        <option value="">ğŸ“‹ å…¨éƒ¨åˆ†é¡</option>
                    </select>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid" type="button">ç¶²æ ¼</button>
                        <button class="view-btn" data-view="list" type="button">åˆ—è¡¨</button>
                    </div>
                </div>
            </div>

            <div class="stats" id="stats">è¼‰å…¥ä¸­...</div>

            <div id="cocktailsContainer" class="cocktails-grid">
                <div class="loading">æ­£åœ¨è¼‰å…¥é›å°¾é…’è³‡æ–™</div>
            </div>
        </div>

        <!-- æ–°å¢å€ -->
        <div class="page" id="addPage">
            <div class="add-cocktail-form">
                <div class="success-message" id="successMessage">âœ… é›å°¾é…’è­œæ–°å¢æˆåŠŸï¼</div>

                <form id="addCocktailForm">
                    <div class="form-section">
                        <h3>ğŸ¹ åŸºæœ¬è³‡è¨Š</h3>
                        <div class="form-group">
                            <label for="cocktailTitle">é›å°¾é…’åç¨± *</label>
                            <input type="text" id="cocktailTitle" required placeholder="ä¾‹å¦‚ï¼šè«å¸Œæ‰˜ã€é¦¬ä¸å°¼" />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cocktailCategory">åˆ†é¡</label>
                                <select id="cocktailCategory">
                                    <option value="">é¸æ“‡åˆ†é¡</option>
                                    <option value="ç¶“å…¸é›å°¾é…’">ç¶“å…¸é›å°¾é…’</option>
                                    <option value="å¨å£«å¿Œèª¿é…’">å¨å£«å¿Œèª¿é…’</option>
                                    <option value="ä¼ç‰¹åŠ èª¿é…’">ä¼ç‰¹åŠ èª¿é…’</option>
                                    <option value="ç´é…’èª¿é…’">ç´é…’èª¿é…’</option>
                                    <option value="æœ—å§†é…’èª¿é…’">æœ—å§†é…’èª¿é…’</option>
                                    <option value="é¾èˆŒè˜­èª¿é…’">é¾èˆŒè˜­èª¿é…’</option>
                                    <option value="é¦™æª³èª¿é…’">é¦™æª³èª¿é…’</option>
                                    <option value="ç†±å¸¶é¢¨å‘³">ç†±å¸¶é¢¨å‘³</option>
                                    <option value="ç„¡é…’ç²¾èª¿é£²">ç„¡é…’ç²¾èª¿é£²</option>
                                    <option value="å‰µæ„èª¿é…’">å‰µæ„èª¿é…’</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="glassType">æ¯å‹</label>
                                <select id="glassType">
                                    <option value="">é¸æ“‡æ¯å‹</option>
                                    <option value="é¦¬ä¸å°¼æ¯">é¦¬ä¸å°¼æ¯</option>
                                    <option value="å¨å£«å¿Œæ¯">å¨å£«å¿Œæ¯</option>
                                    <option value="é«˜çƒæ¯">é«˜çƒæ¯</option>
                                    <option value="å²©çŸ³æ¯">å²©çŸ³æ¯</option>
                                    <option value="é¦™æª³æ¯">é¦™æª³æ¯</option>
                                    <option value="é¢¶é¢¨æ¯">é¢¶é¢¨æ¯</option>
                                    <option value="é›å°¾é…’æ¯">é›å°¾é…’æ¯</option>
                                    <option value="æŸ¯æ—æ¯">æŸ¯æ—æ¯</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="alcoholContent">é…’ç²¾æ¿ƒåº¦ (%)</label>
                                <input type="number" id="alcoholContent" min="0" max="100" step="0.1"
                                    placeholder="20.5" />
                            </div>
                            <div class="form-group">
                                <label for="difficulty">é›£åº¦ç­‰ç´š</label>
                                <select id="difficulty">
                                    <option value="">é¸æ“‡é›£åº¦</option>
                                    <option value="ç°¡å–®">ç°¡å–®</option>
                                    <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                                    <option value="å›°é›£">å›°é›£</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="servings">ä»½é‡</label>
                                <input type="number" id="servings" min="1" placeholder="1" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ·ï¸ æ¨™ç±¤</h3>
                        <div class="tags-input">
                            <input type="text" id="tagsInput" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enterï¼ˆä¾‹å¦‚ï¼šæ¸…çˆ½ã€å¤æ—¥ï¼‰" />
                            <div class="tags-display" id="tagsDisplay"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¥ƒ é…æ–™æ¸…å–®</h3>
                        <div class="ingredients-list" id="ingredientsList">
                            <div class="ingredient-item">
                                <input type="text" placeholder="ä¾‹å¦‚ï¼šç™½è˜­åœ° 60ml" required />
                                <button type="button" class="remove-btn"
                                    onclick="app.removeIngredient(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addIngredient()">â• æ–°å¢é…æ–™</button>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ´ èª¿è£½æ–¹æ³•</h3>
                        <div class="instructions-list" id="instructionsList">
                            <div class="instruction-item">
                                <span style="font-weight: bold; min-width: 30px;">1.</span>
                                <input type="text" placeholder="è©³ç´°æè¿°ç¬¬ä¸€å€‹æ­¥é©Ÿ" required />
                                <button type="button" class="remove-btn"
                                    onclick="app.removeInstruction(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addInstruction()">â• æ–°å¢æ­¥é©Ÿ</button>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</h3>
                        <div class="form-group">
                            <label for="cocktailImageFile">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</label>
                            <input type="file" id="cocktailImageFile" accept="image/*" />
                            <div id="addImagePreview" style="margin-top: 12px;"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.clearForm()">æ¸…ç©ºè¡¨å–®</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜é…’è­œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <aside id="editDrawer" class="drawer hidden" aria-hidden="true">
        <div class="drawer-header">
            <h3>ç·¨è¼¯é…’è­œ</h3>
            <button id="closeDrawer" class="btn btn-secondary" type="button">é—œé–‰</button>
        </div>
        <form id="editForm" class="edit-form">
            <label>æ¨™é¡Œ</label>
            <input name="title" type="text" required>
            <label>åˆ†é¡</label>
            <input name="category" type="text">
            <label>æ¯å‹</label>
            <input name="glass_type" type="text">
            <label>é…’ç²¾æ¿ƒåº¦ (%)</label>
            <input name="alcohol_content" type="number" min="0" max="100" step="0.1">
            <label>é›£åº¦ç­‰ç´š</label>
            <select name="difficulty">
                <option value="">é¸æ“‡é›£åº¦</option>
                <option value="ç°¡å–®">ç°¡å–®</option>
                <option value="ä¸­ç­‰">ä¸­ç­‰</option>
                <option value="å›°é›£">å›°é›£</option>
            </select>
            <label>æ¨™ç±¤ï¼ˆåˆ†è™Ÿåˆ†éš”ï¼‰</label>
            <input name="tags" type="text">
            <label>é…æ–™ï¼ˆæ¯é …ä»¥ | åˆ†éš”ï¼‰</label>
            <textarea name="ingredients" rows="3"></textarea>
            <label>èª¿è£½æ–¹æ³•ï¼ˆå¤šè¡Œï¼‰</label>
            <textarea name="instructions" rows="5"></textarea>
            <div class="grid-2">
                <div>
                    <label>ä»½é‡</label>
                    <input name="servings" type="number" min="1">
                </div>
            </div>
            <label>åœ–ç‰‡ç¶²å€æˆ–ä¸Šå‚³æ–°åœ–ç‰‡</label>
            <input name="image_url" type="text" placeholder="ç¾æœ‰åœ–ç‰‡ç¶²å€æˆ–ç›¸å°è·¯å¾‘">
            <input id="imageFile" name="image_file" type="file" accept="image/*">
            <div id="imagePreview" style="margin:8px 0;"></div>
            <div class="drawer-actions">
                <button id="saveCocktail" class="btn" type="button">å„²å­˜</button>
                <button id="deleteCocktail" class="btn btn-danger" type="button">åˆªé™¤</button>
            </div>
        </form>
    </aside>

    <script>
        // é›å°¾é…’ç¯„ä¾‹è³‡æ–™
        window.SAMPLE_CSV = `id,title,category,tags,ingredients,instructions,glass_type,alcohol_content,difficulty,servings,image_url
C001,è«å¸Œæ‰˜,æœ—å§†é…’èª¿é…’,æ¸…çˆ½;è–„è·;å¤æ—¥,ç™½æœ—å§†é…’ 60ml|æ–°é®®è–„è·è‘‰ 10ç‰‡|èŠå§†æ± 30ml|ç³–æ¼¿ 20ml|è˜‡æ‰“æ°´ é©é‡|å†°å¡Š é©é‡,åœ¨é«˜çƒæ¯ä¸­è¼•å£“è–„è·è‘‰>åŠ å…¥ç³–æ¼¿å’ŒèŠå§†æ±>å€’å…¥ç™½æœ—å§†é…’>åŠ æ»¿å†°å¡Š>æ³¨å…¥è˜‡æ‰“æ°´>è¼•æ”ªæ‹Œ>è–„è·è‘‰è£é£¾,é«˜çƒæ¯,12.5,ç°¡å–®,1,
C002,é¦¬ä¸å°¼,ç´é…’èª¿é…’,ç¶“å…¸;ä¹¾å‹;å„ªé›…,ç´é…’ 60ml|ä¹¾è‹¦è‰¾é…’ 10ml|æ©„æ¬– 1é¡†,åœ¨èª¿é…’å™¨ä¸­åŠ å…¥å†°å¡Š>å€’å…¥ç´é…’å’Œè‹¦è‰¾é…’>æ”ªæ‹Œ30ç§’>éæ¿¾å€’å…¥é¦¬ä¸å°¼æ¯>æ©„æ¬–è£é£¾,é¦¬ä¸å°¼æ¯,28.5,ä¸­ç­‰,1,
C003,ç‘ªæ ¼éº—ç‰¹,é¾èˆŒè˜­èª¿é…’,ç¶“å…¸;å¢¨è¥¿å“¥;çŸ³ç°,é¾èˆŒè˜­é…’ 60ml|æ©™é…’ 30ml|èŠå§†æ± 30ml|é¹½ é©é‡,æ¯ç·£æ²¾é¹½>åœ¨é›ªå…‹æ¯ä¸­åŠ å…¥å†°å¡Š>å€’å…¥æ‰€æœ‰ææ–™>æ–ç›ª15ç§’>éæ¿¾å€’å…¥é›å°¾é…’æ¯>èŠå§†ç‰‡è£é£¾,é›å°¾é…’æ¯,22.3,ç°¡å–®,1,
C004,å¨å£«å¿Œé…¸,å¨å£«å¿Œèª¿é…’,ç¶“å…¸;é…¸ç”œ;å¹³è¡¡,å¨å£«å¿Œ 60ml|æª¸æª¬æ± 30ml|ç³–æ¼¿ 20ml|è›‹ç™½ 1é¡†|æª¸æª¬ç‰‡ 1ç‰‡,åœ¨é›ªå…‹æ¯ä¸­åŠ å…¥æ‰€æœ‰ææ–™>ä¹¾æ–10ç§’>åŠ å†°å¡Šæ¿•æ–15ç§’>é›™é‡éæ¿¾å€’å…¥å²©çŸ³æ¯>æª¸æª¬ç‰‡è£é£¾,å²©çŸ³æ¯,18.7,ä¸­ç­‰,1,
C005,è¡€è…¥ç‘ªéº—,ä¼ç‰¹åŠ èª¿é…’,æ—©åˆé¤;é¹¹å‘³;è”¬èœ,ä¼ç‰¹åŠ  60ml|ç•ªèŒ„æ± 120ml|æª¸æª¬æ± 15ml|ä¼æ–¯ç‰¹é†¬ 3æ»´|å¡”å·´æ–¯ç§‘é†¬ 2æ»´|é¹½èƒ¡æ¤’ é©é‡|èŠ¹èœ 1æ ¹,åœ¨é«˜çƒæ¯ä¸­åŠ å…¥å†°å¡Š>å€’å…¥ä¼ç‰¹åŠ å’Œç•ªèŒ„æ±>åŠ å…¥èª¿å‘³æ–™>æ”ªæ‹Œå‡å‹»>èŠ¹èœæ¡¿è£é£¾,é«˜çƒæ¯,10.2,ç°¡å–®,1,
C006,é»›ç¶ºè‰,æœ—å§†é…’èª¿é…’,ç¶“å…¸;ç†±å¸¶;çŸ³ç°,ç™½æœ—å§†é…’ 60ml|èŠå§†æ± 30ml|ç³–æ¼¿ 20ml,åœ¨é›ªå…‹æ¯ä¸­åŠ å…¥å†°å¡Š>å€’å…¥æ‰€æœ‰ææ–™>æ–ç›ª15ç§’>éæ¿¾å€’å…¥é›å°¾é…’æ¯>èŠå§†çš®è£é£¾,é›å°¾é…’æ¯,20.5,ç°¡å–®,1,
C007,å†…æ ¼ç½—å°¼,ç´é…’èª¿é…’,ç¾©å¤§åˆ©;è‹¦ç”œ;é–‹èƒƒ,ç´é…’ 30ml|é‡‘å·´åˆ© 30ml|ç”œè‹¦è‰¾é…’ 30ml|æ©™çš® 1ç‰‡,åœ¨æ”ªæ‹Œæ¯ä¸­åŠ å…¥å†°å¡Š>å€’å…¥æ‰€æœ‰ææ–™>æ”ªæ‹Œ30ç§’>éæ¿¾å€’å…¥å²©çŸ³æ¯>æ©™çš®è£é£¾,å²©çŸ³æ¯,24.0,ç°¡å–®,1,
C008,æ›¼å“ˆé “,å¨å£«å¿Œèª¿é…’,ç¶“å…¸;æ¿ƒçƒˆ;æˆç†Ÿ,é»‘éº¥å¨å£«å¿Œ 60ml|ç”œè‹¦è‰¾é…’ 30ml|å®‰æ ¼æ–¯åœ–æ‹‰è‹¦é…’ 2dash|æ«»æ¡ƒ 1é¡†,åœ¨æ”ªæ‹Œæ¯ä¸­åŠ å…¥å†°å¡Š>å€’å…¥å¨å£«å¿Œå’Œè‹¦è‰¾é…’>åŠ è‹¦é…’>æ”ªæ‹Œ30ç§’>éæ¿¾å€’å…¥é›å°¾é…’æ¯>æ«»æ¡ƒè£é£¾,é›å°¾é…’æ¯,25.8,ä¸­ç­‰,1,`;

        class CocktailApp {
            // çµ±ä¸€å­—ä¸²æ¨™æº–åŒ–ï¼šå»ç©ºç™½ + å°å¯«
            norm(v) {
                return (v == null ? "" : String(v)).trim().toLowerCase();
            }

            constructor() {
                this.cocktails = [];
                this.filteredCocktails = [];
                this.currentView = 'grid';
                this.editTargetId = null;
                this.updateViewClass?.();
                this.pages = {
                    browse: document.getElementById('browsePage'),
                    add: document.getElementById('addPage'),
                };
                this.navButtons = Array.from(document.querySelectorAll('.nav-btn'));
                this.successMessage = null;

                // åœ–ç‰‡ blob:ObjectURL å¿«å–
                this.imageURLCache = new Map();

                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setupNavTabs();
                this.setupAddForm();
                this.setupEditDrawer();
                this.renderEmptyWithHint();

                // é‡‹æ”¾ blob URL
                window.addEventListener('beforeunload', () => {
                    for (const url of this.imageURLCache.values()) URL.revokeObjectURL(url);
                    this.imageURLCache.clear();
                });
            }

            // ç©©å®š UIï¼šé¿å…é‡ç¹ªå¾Œã€Œè·³ç‰ˆã€
            captureUIState() {
                return {
                    scrollY: window.scrollY,
                    search: document.getElementById('searchInput')?.value || '',
                    category: document.getElementById('categorySelect')?.value || '',
                    view: this.currentView
                };
            }

            restoreUIState(state) {
                if (!state) return;
                const s = document.getElementById('searchInput');
                const c = document.getElementById('categorySelect');
                if (s && s.value !== state.search) s.value = state.search;
                if (c && c.value !== state.category) c.value = state.category;
                this.currentView = state.view || 'grid';
                this.updateViewClass();
                requestAnimationFrame(() => window.scrollTo({ top: state.scrollY, left: 0, behavior: 'auto' }));
            }

            async withStableUI(updaterFn) {
                const ui = this.captureUIState();
                await Promise.resolve(updaterFn?.());
                this.render();
                this.restoreUIState(ui);
            }

            renderEmptyWithHint() {
                const stats = document.getElementById('stats');
                stats.textContent = 'è«‹å…ˆæŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ä»¥è¼‰å…¥æœ¬åœ° cocktails.csv';

                const container = document.getElementById('cocktailsContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“‚</div>
                        <h3>å°šæœªé¸æ“‡è³‡æ–™å¤¾</h3>
                        <p>è«‹é»ä¸Šæ–¹ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ï¼Œæœ¬ App å°‡è®€å–è©²è³‡æ–™å¤¾ä¸­çš„ <code>cocktails.csv</code> èˆ‡ <code>images/</code> åœ–ç‰‡ã€‚</p>
                    </div>`;
            }

            // File System Accessï¼šè³‡æ–™å¤¾é¸æ“‡èˆ‡ CSV è¼‰å…¥
            async afterFolderPicked() {
                await this.ensureCSVExists();
                await this.loadCSVFromLocal();
                this.filteredCocktails = [...this.cocktails];
                this.updateCategories();
                this.render();
            }

            async ensureCSVExists() {
                try {
                    await __cocktailsDirHandle.getFileHandle('cocktails.csv');
                } catch {
                    // ä¸å­˜åœ¨ â†’ å»ºç«‹ with headerï¼ˆå« BOM + CRLFï¼‰
                    const headers = ["id", "title", "category", "tags", "ingredients", "instructions", "glass_type", "alcohol_content", "difficulty", "servings", "image_url"];
                    const bom = "\uFEFF";
                    const csvText = bom + headers.join(",") + "\r\n";
                    const fh = await __cocktailsDirHandle.getFileHandle("cocktails.csv", { create: true });
                    await writeFile(fh, new Blob([csvText], { type: "text/csv;charset=utf-8" }));
                }
            }

            async loadCSVFromLocal() {
                try {
                    const fh = await __cocktailsDirHandle.getFileHandle('cocktails.csv');
                    const file = await fh.getFile();
                    const text = await file.text();
                    const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
                    // ç¢ºä¿æ¯ç­†éƒ½æœ‰ idï¼ˆè‹¥ç©ºæª”å°±çµ¦æ–° idï¼‰
                    this.cocktails = (parsed.data || []).map((x, i) => ({
                        ...x,
                        id: x.id && String(x.id).trim() ? x.id : this.makeId(i)
                    }));
                    if (!this.cocktails.length) {
                        this.cocktails = [];
                    }
                } catch (e) {
                    console.error('è®€å–æœ¬åœ° cocktails.csv å¤±æ•—ï¼š', e);
                    alert('è®€å–æœ¬åœ° cocktails.csv å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™æˆ–æª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚');
                    this.cocktails = [];
                }
            }

            makeId(idx = 0) {
                // ä»¥ç›®å‰é™£åˆ—é•·åº¦ + idx ç”Ÿæˆ
                return 'C' + String(this.cocktails.length + idx + 1).padStart(3, '0');
            }

            setupEventListeners() {
                const searchInput = document.getElementById('searchInput');
                const categorySelect = document.getElementById('categorySelect');
                const viewButtons = document.querySelectorAll('.view-btn');

                // æœå°‹è¼¸å…¥ï¼šinput + compositionendï¼ˆä¸­æ–‡è¼¸å…¥æ³•ï¼‰
                if (searchInput) {
                    const onSearch = () => this.filterCocktails();
                    searchInput.addEventListener('input', onSearch);
                    searchInput.addEventListener('compositionend', onSearch);
                }

                // é¡åˆ¥ç¯©é¸
                if (categorySelect) {
                    categorySelect.addEventListener('change', () => this.filterCocktails());
                }

                // æª¢è¦–åˆ‡æ›
                viewButtons.forEach((btn) => {
                    btn.addEventListener('click', (e) => {
                        viewButtons.forEach((b) => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.currentView = e.currentTarget.dataset.view;
                        this.updateViewClass();
                    });
                });
            }

            setupNavTabs() {
                this.navButtons.forEach((btn) => {
                    btn.addEventListener('click', () => {
                        this.navButtons.forEach((b) => b.classList.remove('active'));
                        btn.classList.add('active');

                        const pageKey = btn.dataset.page; // "browse" | "add"
                        Object.values(this.pages).forEach((p) => p.classList.remove('active'));
                        if (this.pages[pageKey]) this.pages[pageKey].classList.add('active');

                        if (pageKey === 'add' && this.successMessage) {
                            this.successMessage.style.display = 'none';
                        }
                    });
                });
            }

            setupAddForm() {
                const form = document.getElementById('addCocktailForm');
                this.successMessage = document.getElementById('successMessage');

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!__cocktailsDirHandle || !__imagesDirHandle) {
                        alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾ï¼Œè«‹å…ˆæŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ã€‚');
                        return;
                    }

                    const title = document.getElementById('cocktailTitle').value.trim();
                    const category = document.getElementById('cocktailCategory').value.trim();
                    const glassType = document.getElementById('glassType').value.trim();
                    const alcoholContent = document.getElementById('alcoholContent').value.trim();
                    const difficulty = document.getElementById('difficulty').value.trim();
                    const servings = document.getElementById('servings').value.trim();

                    const tagsInput = document.getElementById('tagsInput').value.trim();
                    const chips = Array.from(document.querySelectorAll('#tagsDisplay .tag-chip')).map((x) => x.dataset.tag);
                    const tags = [...chips, ...(tagsInput ? [tagsInput] : [])].join(';');

                    const ingredients = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item input'))
                        .map((i) => i.value.trim()).filter(Boolean).join('|');

                    const instructions = Array.from(document.querySelectorAll('#instructionsList .instruction-item input'))
                        .map((i) => i.value.trim()).filter(Boolean).join('>');

                    if (!title) { alert('è«‹è¼¸å…¥é›å°¾é…’åç¨±'); return; }
                    if (!ingredients) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …é…æ–™'); return; }
                    if (!instructions) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æ­¥é©Ÿ'); return; }

                    const newId = this.makeId();

                    // åƒ…æœ¬åœ°ï¼šä¸Šå‚³åœ–ç‰‡ â†’ images/ ç”¢ç”Ÿæª”å â†’ CSV å­˜ç›¸å°è·¯å¾‘
                    let imageUrl = '';
                    const imageFile = document.getElementById('cocktailImageFile').files[0];
                    if (imageFile) {
                        try {
                            const result = await saveImageToLocalFolder(imageFile, newId);
                            if (result.ok) imageUrl = result.relativePath;
                        } catch (err) {
                            console.error('åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤:', err);
                            alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼›ä½ ä»å¯ç¨å¾Œåœ¨ç·¨è¼¯ä¸­è£œä¸Šåœ–ç‰‡ã€‚');
                        }
                    }

                    const newCocktail = {
                        id: newId,
                        title,
                        category,
                        tags,
                        ingredients,
                        instructions,
                        glass_type: glassType,
                        alcohol_content: alcoholContent || '',
                        difficulty: difficulty || '',
                        servings: servings || '',
                        image_url: imageUrl,
                    };

                    await this.withStableUI(() => {
                        this.cocktails.unshift(newCocktail);
                        this.filteredCocktails = this.cocktails;
                    });

                    // ç«‹åˆ»å¯«å›æœ¬åœ° CSV
                    await writeCSVToLocal();

                    this.successMessage.style.display = 'block';
                    const browseBtn = this.navButtons.find((b) => b.dataset.page === 'browse');
                    browseBtn?.click();
                    this.clearForm();
                });

                // æ¨™ç±¤ chip
                const tagsInput = document.getElementById('tagsInput');
                const tagsDisplay = document.getElementById('tagsDisplay');
                tagsInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && tagsInput.value.trim()) {
                        e.preventDefault();
                        const tag = tagsInput.value.trim();
                        const chip = document.createElement('span');
                        chip.className = 'tag-chip';
                        chip.dataset.tag = tag;
                        chip.textContent = `#${tag} Ã—`;
                        chip.addEventListener('click', () => chip.remove());
                        tagsDisplay.appendChild(chip);
                        tagsInput.value = '';
                    }
                });

                // æ–°å¢é ï¼šåœ–ç‰‡é è¦½
                const addImageInput = document.getElementById('cocktailImageFile');
                const addImagePreview = document.getElementById('addImagePreview');
                addImageInput.addEventListener('change', (e) => {
                    addImagePreview.innerHTML = '';
                    const file = e.target.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        Object.assign(img.style, {
                            maxWidth: '200px', maxHeight: '150px', borderRadius: '8px', objectFit: 'cover'
                        });
                        addImagePreview.appendChild(img);
                    }
                });
            }

            setupEditDrawer() {
                const drawer = document.getElementById('editDrawer');
                const closeBtn = document.getElementById('closeDrawer');
                const saveBtn = document.getElementById('saveCocktail');
                const deleteBtn = document.getElementById('deleteCocktail');

                closeBtn.addEventListener('click', () => {
                    drawer.classList.add('hidden');
                    drawer.setAttribute('aria-hidden', 'true');
                    this.editTargetId = null;
                });

                saveBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (!__cocktailsDirHandle) { alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾'); return; }
                    await this.saveEditedCocktail();
                    await writeCSVToLocal(); // å„²å­˜å¾Œç«‹åˆ»å¯«å›
                });

                deleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (!__cocktailsDirHandle) { alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾'); return; }
                    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é…’è­œå—ï¼Ÿ')) {
                        this.deleteCocktail();
                        await writeCSVToLocal(); // åˆªé™¤å¾Œç«‹åˆ»å¯«å›
                    }
                });
            }

            editCocktail(id) {
                if (!__cocktailsDirHandle) { alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾'); return; }

                const cocktail = this.cocktails.find(r => r.id === id);
                if (!cocktail) return;

                this.editTargetId = id;
                const drawer = document.getElementById('editDrawer');
                const form = document.getElementById('editForm');

                form.title.value = cocktail.title || '';
                form.category.value = cocktail.category || '';
                form.glass_type.value = cocktail.glass_type || '';
                form.alcohol_content.value = cocktail.alcohol_content || '';
                form.difficulty.value = cocktail.difficulty || '';
                form.tags.value = cocktail.tags || '';
                form.ingredients.value = (cocktail.ingredients || '').replace(/\|/g, '\n');
                form.instructions.value = (cocktail.instructions || '').replace(/>/g, '\n');
                form.servings.value = cocktail.servings || '';
                form.image_url.value = cocktail.image_url || '';

                const preview = document.getElementById('imagePreview');
                preview.innerHTML = '';
                if (cocktail.image_url) {
                    this.resolveImageURL(cocktail.image_url).then(src => {
                        if (!src) return;
                        const img = document.createElement('img');
                        img.src = src;
                        Object.assign(img.style, { maxWidth: '100%', borderRadius: '8px', marginBottom: '8px' });
                        preview.appendChild(img);

                        const caption = document.createElement('div');
                        caption.textContent = 'ç›®å‰çš„åœ–ç‰‡';
                        Object.assign(caption.style, { fontSize: '0.9rem', color: '#666' });
                        preview.appendChild(caption);
                    }).catch(() => { });
                }

                drawer.classList.remove('hidden');
                drawer.setAttribute('aria-hidden', 'false');
            }

            async saveEditedCocktail() {
                const form = document.getElementById('editForm');
                const index = this.cocktails.findIndex(r => r.id === this.editTargetId);
                if (index === -1) return;

                let imageUrl = form.image_url.value.trim();

                // æ–°ä¸Šå‚³åœ–ç‰‡ â†’ è¦†è“‹/æ–°å¢
                const imageFile = document.getElementById('imageFile').files[0];
                if (imageFile) {
                    try {
                        const result = await saveImageToLocalFolder(imageFile, this.editTargetId);
                        if (result.ok) imageUrl = result.relativePath;
                    } catch (err) {
                        console.error('åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤:', err);
                        alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼›å°‡æ²¿ç”¨åŸåœ–ç‰‡ç¶²å€/è·¯å¾‘ã€‚');
                    }
                }

                this.cocktails[index] = {
                    ...this.cocktails[index],
                    title: form.title.value.trim(),
                    category: form.category.value.trim(),
                    glass_type: form.glass_type.value.trim(),
                    alcohol_content: form.alcohol_content.value || '',
                    difficulty: form.difficulty.value || '',
                    tags: form.tags.value.trim(),
                    ingredients: form.ingredients.value.trim().replace(/\n/g, '|'),
                    instructions: form.instructions.value.trim().replace(/\n/g, '>'),
                    servings: form.servings.value || '',
                    image_url: imageUrl,
                };

                await this.withStableUI(() => {
                    this.filteredCocktails = this.cocktails;
                });

                const drawer = document.getElementById('editDrawer');
                drawer.classList.add('hidden');
                drawer.setAttribute('aria-hidden', 'true');
                this.editTargetId = null;
            }

            deleteCocktail() {
                const index = this.cocktails.findIndex(r => r.id === this.editTargetId);
                if (index !== -1) {
                    this.withStableUI(() => {
                        this.cocktails.splice(index, 1);
                        this.filteredCocktails = this.cocktails;
                    });
                    const drawer = document.getElementById('editDrawer');
                    drawer.classList.add('hidden');
                    drawer.setAttribute('aria-hidden', 'true');
                    this.editTargetId = null;
                }
            }

            // å‹•æ…‹æ¬„ä½
            addIngredient() {
                const wrap = document.getElementById('ingredientsList');
                const div = document.createElement('div');
                div.className = 'ingredient-item';
                div.innerHTML = `
                    <input type="text" placeholder="ä¾‹å¦‚ï¼šç´é…’ 60ml" required />
                    <button type="button" class="remove-btn">ç§»é™¤</button>`;
                div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
                wrap.appendChild(div);
            }

            removeIngredient(btn) {
                btn.closest('.ingredient-item')?.remove();
            }

            addInstruction() {
                const wrap = document.getElementById('instructionsList');
                const idx = wrap.querySelectorAll('.instruction-item').length + 1;
                const div = document.createElement('div');
                div.className = 'instruction-item';
                div.innerHTML = `
                    <span style="font-weight:bold;min-width:30px;">${idx}.</span>
                    <input type="text" placeholder="è©³ç´°æè¿°æ­¥é©Ÿ" required />
                    <button type="button" class="remove-btn">ç§»é™¤</button>`;
                div.querySelector('.remove-btn').addEventListener('click', () => {
                    div.remove();
                    Array.from(wrap.querySelectorAll('.instruction-item span')).forEach((s, i) => (s.textContent = (i + 1) + '.'));
                });
                wrap.appendChild(div);
            }

            removeInstruction(btn) {
                btn.closest('.instruction-item')?.remove();
            }

            clearForm() {
                document.getElementById('addCocktailForm').reset();
                document.getElementById('tagsDisplay').innerHTML = '';
                document.getElementById('addImagePreview').innerHTML = '';
                document.getElementById('ingredientsList').innerHTML = `
                    <div class="ingredient-item">
                        <input type="text" placeholder="ä¾‹å¦‚ï¼šç´é…’ 60ml" required />
                        <button type="button" class="remove-btn" onclick="app.removeIngredient(this)">ç§»é™¤</button>
                    </div>`;
                document.getElementById('instructionsList').innerHTML = `
                    <div class="instruction-item">
                        <span style="font-weight: bold; min-width: 30px;">1.</span>
                        <input type="text" placeholder="è©³ç´°æè¿°ç¬¬ä¸€å€‹æ­¥é©Ÿ" required />
                        <button type="button" class="remove-btn" onclick="app.removeInstruction(this)">ç§»é™¤</button>
                    </div>`;
            }

            updateCategories() {
                const categorySelect = document.getElementById('categorySelect');
                if (!categorySelect) return;
                const categories = [...new Set(
                    this.cocktails.map(r => (r.category || '').trim()).filter(Boolean)
                )].sort();

                // æ¸…ç†èˆŠé¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹ã€Œå…¨éƒ¨ã€ï¼‰
                categorySelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());

                categories.forEach((category) => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }

            filterCocktails() {
                const ui = this.captureUIState();

                const searchTerm = this.norm(document.getElementById('searchInput')?.value || '');
                const selectedCategoryRaw = document.getElementById('categorySelect')?.value || '';
                const selectedCategory = (selectedCategoryRaw || '').trim();

                if (!Array.isArray(this.cocktails)) this.cocktails = [];

                this.filteredCocktails = this.cocktails.filter((r) => {
                    const title = this.norm(r?.title);
                    const tags = this.norm(r?.tags);
                    const ingredients = this.norm(r?.ingredients);
                    const category = (r?.category || '').trim();

                    const matchesSearch =
                        !searchTerm ||
                        title.includes(searchTerm) ||
                        tags.includes(searchTerm) ||
                        ingredients.includes(searchTerm);

                    const matchesCategory = !selectedCategory || category === selectedCategory;

                    return matchesSearch && matchesCategory;
                });

                this.render();
                this.restoreUIState(ui);
            }

            updateViewClass() {
                const container = document.getElementById('cocktailsContainer');
                container.className = this.currentView === 'grid' ? 'cocktails-grid' : 'cocktails-list';
            }

            render() {
                this.updateStats();
                this.renderCocktails();
                this.updateViewClass();
            }

            updateStats() {
                const stats = document.getElementById('stats');
                const total = this.cocktails.length;
                const showing = this.filteredCocktails.length;
                stats.textContent = `é¡¯ç¤º ${showing} / ${total} é“é›å°¾é…’è­œ`;
            }

            // åªèµ°æœ¬åœ°è³‡æ–™å¤¾ï¼šæŠŠ CSV å…§çš„ image_urlï¼ˆimages/æª”åæˆ–æª”åï¼‰è½‰ç‚º blob URL
            async resolveImageURL(value) {
                if (!value) return '';
                const v = String(value).trim();
                if (/^(data:|blob:)/i.test(v)) return v; // ä»å…è¨± data/blob
                if (!__imagesDirHandle) return ''; // å°šæœªé¸è³‡æ–™å¤¾ â†’ å…ˆä¸é¡¯ç¤º

                const name = v.replace(/^images\//i, '');
                if (this.imageURLCache.has(name)) return this.imageURLCache.get(name);

                try {
                    const fh = await __imagesDirHandle.getFileHandle(name);
                    const file = await fh.getFile();
                    const url = URL.createObjectURL(file);
                    this.imageURLCache.set(name, url);
                    return url;
                } catch (e) {
                    console.warn('æ‰¾ä¸åˆ°åœ–ç‰‡æ–¼ images/ï¼š', v);
                    return '';
                }
            }

            renderCocktails() {
                const container = document.getElementById('cocktailsContainer');
                if (this.filteredCocktails.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ”</div>
                            <h3>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é›å°¾é…’è­œ</h3>
                            <p>è©¦è‘—èª¿æ•´æœå°‹é—œéµå­—æˆ–åˆ†é¡ç¯©é¸</p>
                        </div>`;
                    return;
                }

                container.innerHTML = this.filteredCocktails.map((cocktail) => {
                    const tagsHtml = cocktail.tags
                        ? cocktail.tags.split(';').map((tag) => `<span class="tag">${tag.trim()}</span>`).join('')
                        : '';

                    const glassType = cocktail.glass_type || '';
                    const alcoholContent = cocktail.alcohol_content || '';
                    const difficulty = cocktail.difficulty || '';

                    return `
                    <div class="cocktail-card">
                        <div class="cocktail-image">
                            ${cocktail.image_url ? `<img data-img="${cocktail.id}" alt="${cocktail.title}">` : 'ğŸ¸'}
                        </div>
                        <div class="cocktail-content">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <h3 class="cocktail-title">${cocktail.title || ''}</h3>
                                <button onclick="app.editCocktail('${cocktail.id}')" class="btn" style="font-size: 0.8rem; padding: 4px 8px;">ç·¨è¼¯</button>
                            </div>
                            <div class="cocktail-meta">
                                ${glassType ? `<span class="meta-item">ğŸ¥ƒ ${glassType}</span>` : ''}
                                ${alcoholContent ? `<span class="meta-item">ğŸŒ¡ï¸ ${alcoholContent}%</span>` : ''}
                                ${difficulty ? `<span class="meta-item">â­ ${difficulty}</span>` : ''}
                                <span class="meta-item">ğŸ‘¥ ${cocktail.servings || '1'} æ¯</span>
                            </div>
                            ${tagsHtml ? `<div class="cocktail-tags">${tagsHtml}</div>` : ''}
                            <div class="cocktail-details">
                                <details>
                                    <summary>ğŸ¥ƒ é…æ–™æ¸…å–®</summary>
                                    <div class="ingredients-list">
                                        ${(cocktail.ingredients || '').split('|').map((i) => `<div>â€¢ ${i.trim()}</div>`).join('')}
                                    </div>
                                </details>
                                <details>
                                    <summary>ğŸ´ èª¿è£½æ–¹æ³•</summary>
                                    <div class="instructions-list">
                                        ${(cocktail.instructions || '').split('>').map((s) => `<div class="instruction">${s.trim()}</div>`).join('')}
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // ç•°æ­¥è£œåœ–ï¼ˆåªèƒ½åœ¨å·²é¸è³‡æ–™å¤¾å¾Œï¼‰
                if (__imagesDirHandle) {
                    this.filteredCocktails.forEach(async (cocktail) => {
                        if (!cocktail.image_url) return;
                        const imgEl = container.querySelector(`img[data-img="${cocktail.id}"]`);
                        if (!imgEl) return;
                        try {
                            const src = await this.resolveImageURL(cocktail.image_url);
                            if (src) imgEl.src = src;
                            imgEl.removeAttribute('data-img');
                        } catch (e) {
                            console.warn('åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š', cocktail.image_url, e);
                        }
                    });
                }
            }
        }

        // å•Ÿå‹•
        const app = new CocktailApp();
        window.app = app;

        // æœ¬åœ°æª”æ¡ˆç’°å¢ƒè®Šæ•¸
        let __cocktailsDirHandle = null;
        let __imagesDirHandle = null;

        async function pickCocktailsFolder() {
            if (!window.showDirectoryPicker) { alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´é¸æ“‡è³‡æ–™å¤¾ã€‚è«‹æ”¹ç”¨ Chrome/Edgeã€‚"); return; }
            try {
                __cocktailsDirHandle = await window.showDirectoryPicker({ mode: "readwrite" });
                __imagesDirHandle = await __cocktailsDirHandle.getDirectoryHandle("images", { create: true });
                alert("å·²é¸æ“‡è³‡æ–™å¤¾ï¼šä¹‹å¾Œåœ–ç‰‡æœƒå­˜åˆ° images/ï¼ŒCSV æœƒè®€/å¯«æ–¼è©²è³‡æ–™å¤¾ã€‚");
                await app.afterFolderPicked();
            } catch (e) { console.error(e); }
        }

        async function writeFile(handle, data) {
            const w = await handle.createWritable();
            await w.write(data);
            await w.close();
        }

        function extFromFilename(n) {
            const m = (n || "").match(/\.([a-zA-Z0-9]+)$/);
            return m ? m[1].toLowerCase() : "png";
        }

        async function saveImageToLocalFolder(file, cocktailId) {
            if (!__cocktailsDirHandle || !__imagesDirHandle) return { ok: false, reason: "NO_DIR" };
            const ext = extFromFilename(file.name);
            const filename = `${cocktailId}-${Date.now()}.${ext}`;
            const fh = await __imagesDirHandle.getFileHandle(filename, { create: true });
            await writeFile(fh, await file.arrayBuffer());
            return { ok: true, relativePath: `images/${filename}` };
        }

        async function writeCSVToLocal() {
            if (!__cocktailsDirHandle) { alert("å°šæœªé¸æ“‡è³‡æ–™å¤¾ã€‚è«‹å…ˆæŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ã€‚"); return; }
            const headers = ["id", "title", "category", "tags", "ingredients", "instructions", "glass_type", "alcohol_content", "difficulty", "servings", "image_url"];
            const esc = (s) => {
                if (s == null) return "";
                s = String(s);
                if (s.includes(",") || s.includes("\"") || s.includes("\n") || s.includes("\r"))
                    return `"${s.replace(/"/g, '""')}"`;
                return s;
            };
            const lines = [headers.join(",")];
            for (const r of app.cocktails) { lines.push(headers.map(h => esc(r[h])).join(",")); }

            // åŠ  BOM & CRLF
            const bom = "\uFEFF";
            const csvText = bom + lines.join("\r\n");

            const csvHandle = await __cocktailsDirHandle.getFileHandle("cocktails.csv", { create: true });
            await writeFile(csvHandle, new Blob([csvText], { type: "text/csv;charset=utf-8" }));
            alert("å·²å¯«å…¥ cocktails.csv (UTF-8 with BOM)ï¼ŒExcel é–‹å•Ÿä¸æœƒäº‚ç¢¼ã€‚");
        }

        // é ‚éƒ¨æŒ‰éˆ•ç¶å®šï¼ˆé›¢ç·šé™å®šï¼‰
        document.addEventListener("click", (ev) => {
            const t = ev.target;
            if (!t) return;
            if (t.id === "btnPickFolder") pickCocktailsFolder();
            if (t.id === "btnWriteCSV") writeCSVToLocal();
            if (t.id === "btnExport") {
                const headers = ["id", "title", "category", "tags", "ingredients", "instructions", "glass_type", "alcohol_content", "difficulty", "servings", "image_url"];
                const esc = (s) => {
                    if (s == null) return "";
                    s = String(s);
                    if (s.includes(",") || s.includes("\"") || s.includes("\n") || s.includes("\r"))
                        return `"${s.replace(/"/g, '""')}"`;
                    return s;
                };
                const lines = [headers.join(",")];
                for (const r of app.cocktails) { lines.push(headers.map(h => esc(r[h])).join(",")); }

                const bom = "\uFEFF";
                const csvText = bom + lines.join("\r\n");

                const blob = new Blob([csvText], { type: "text/csv;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = "cocktails.csv";
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        // ç·¨è¼¯æŠ½å±œï¼šæ–°åœ–ç‰‡é è¦½
        document.addEventListener("change", (ev) => {
            const t = ev.target;
            if (t && t.id === "imageFile") {
                const preview = document.getElementById("imagePreview");
                if (!preview) return;
                preview.innerHTML = "";
                const f = t.files && t.files[0];
                if (!f) return;
                const url = URL.createObjectURL(f);
                const img = document.createElement("img");
                img.src = url;
                Object.assign(img.style, { maxWidth: "100%", borderRadius: "12px" });
                preview.appendChild(img);
                const caption = document.createElement('div');
                caption.textContent = 'æ–°ä¸Šå‚³çš„åœ–ç‰‡é è¦½';
                Object.assign(caption.style, { fontSize: '0.9rem', color: '#666', marginTop: '8px' });
                preview.appendChild(caption);
            }
        });

        // æš´éœ²å…¨åŸŸ
        window.cocktails = app.cocktails;
        window.filteredCocktails = app.filteredCocktails;

        // Service Worker è¨»å†Šï¼ˆå¦‚æœéœ€è¦ï¼‰
        (function () {
            function registerSW() {
                if ("serviceWorker" in navigator) {
                    navigator.serviceWorker.register("./sw.js").catch(console.error);
                }
            }
            function onceReady(fn) {
                if (document.readyState !== "loading") fn();
                else document.addEventListener("DOMContentLoaded", fn);
            }
            onceReady(registerSW);
        })();
    </script>
</body>

</html>
