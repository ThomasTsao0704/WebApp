<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•†å“æ–™è™Ÿç®¡ç† Â· é€²éŠ·å­˜ PWA</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC";background:#0b1220;color:#e2e8f0}
    header{background:#0f172a;padding:12px;position:sticky;top:0;z-index:9;display:flex;flex-direction:column;gap:6px}
    h1{margin:0;font-size:20px;color:#0ea5e9}
    button{background:#0ea5e9;border:none;color:white;padding:6px 12px;border-radius:8px;cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid rgba(148,163,184,.3);padding:6px;text-align:left}
    tr:hover{background:rgba(148,163,184,.08)}
  </style>
</head>
<body>
<header>
  <h1>ğŸ“¦ å•†å“æ–™è™Ÿç®¡ç† Â· é€²éŠ·å­˜</h1>
  <div class="toolbar">
    <input id="q" placeholder="æœå°‹..." />
    <button onclick="document.getElementById('fileCsv').click()">åŒ¯å…¥ CSVï¼ˆè‡ªå‹•å¥—æ–™è™Ÿï¼‰</button>
    <input type="file" id="fileCsv" accept=".csv" style="display:none" />
    <button onclick="exportCSV()">åŒ¯å‡º CSV</button>
  </div>
</header>
<main>
  <h2>å•†å“æ¸…å–®</h2>
  <table>
    <thead><tr><th>ä»£è™Ÿ</th><th>å“ç‰Œ</th><th>å“å</th><th>è¦æ ¼</th><th>å–®ä½</th><th>åˆ†é¡</th><th>æœªç¨…</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
</main>
<script>
let db,SQL;
(async()=>{
  SQL = await initSqlJs({locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`});
  db=new SQL.Database();
  db.run(`CREATE TABLE IF NOT EXISTS products(
    code TEXT PRIMARY KEY,brand TEXT,name TEXT,spec TEXT,unit TEXT,category TEXT,price_excl REAL
  );`);
  try{db.run('ALTER TABLE products ADD COLUMN category TEXT');}catch(_){ }
  render();
})();

const CATEGORY_PREFIX = {
  'æ¸…æ½”ç”¨å“':'62','æ¸…æ½”':'62','æ¸…æ½”åŠ‘':'62',
  'é¤å…·ç”¨å“':'66','é¤å…·':'66','å®´æœƒç”¨å“':'66',
  'è¾¦å…¬ç”¨å“':'70','è¾¦å…¬':'70',
  'åŒ…è£ææ–™':'80','åŒ…æ':'80','åŒ…è£':'80',
  'äº”é‡‘å·¥å…·':'90','äº”é‡‘':'90','å·¥å…·':'90',
  'å…¶ä»–å•†å“':'99','å…¶ä»–':'99','æœªåˆ†é¡':'99'
};
const PREFIX_NAME = {'62':'æ¸…æ½”ç”¨å“','66':'é¤å…·ç”¨å“','70':'è¾¦å…¬ç”¨å“','80':'åŒ…è£ææ–™','90':'äº”é‡‘å·¥å…·','99':'å…¶ä»–å•†å“'};

function splitMix(mixed){
  if(!mixed) return {brand:'',name:'',spec:''};
  const parts = String(mixed).split('/').map(s=>s.trim()).filter(Boolean);
  if(parts.length===1) return {brand:'',name:parts[0],spec:''};
  if(parts.length===2) return {brand:parts[0],name:parts[1],spec:''};
  return {brand:parts[0],name:parts[1],spec:parts.slice(2).join('/')};
}
function brandAbbr(brand){
  if(!brand || brand==='-') return 'NO';
  const letters = (brand.match(/[A-Za-z0-9]/g)||[]).join('').toUpperCase();
  if(letters) return letters.slice(0,3);
  let h=0; for(let i=0;i<brand.length;i++){ h=(h*31 + brand.charCodeAt(i))>>>0; }
  const a = String.fromCharCode(65 + (h%26));
  const b = String.fromCharCode(65 + ((h>>5)%26));
  return a+b;
}
function parsePrice(s){
  if(s==null) return null;
  const t=String(s).replace(/[,$\s]/g,'').replace(/^\$/,'');
  const v=parseFloat(t);
  return isNaN(v)? null : v;
}
function inferPrefix(categoryText, oldCode){
  if(categoryText){
    for(const k in CATEGORY_PREFIX){ if(categoryText.includes(k)) return CATEGORY_PREFIX[k]; }
  }
  if(oldCode){ const m = String(oldCode).match(/^(\d{2})/); if(m) return m[1]; }
  return '99';
}
function nextSerial(prefix, abbr){
  const stmt = db.prepare("SELECT code FROM products WHERE code LIKE ? ORDER BY code DESC LIMIT 1");
  stmt.bind([`${prefix}-${abbr}-%`]);
  let max=0; while(stmt.step()){ const [code]=stmt.get(); const m=String(code).match(/-(\d{3})$/); if(m){ max=Math.max(max,parseInt(m[1],10)); } }
  stmt.free();
  return (max+1).toString().padStart(3,'0');
}

function parseCSV(text){
  return text.split(/\r?\n/).filter(l=>l.trim()).map(r=>r.split(','));
}

document.getElementById('fileCsv').addEventListener('change',async e=>{
  const text=await e.target.files[0].text();
  const lines=parseCSV(text);
  if(!lines.length) return;
  const header = lines.shift().map(h=>h.trim());
  const idxCodeOld = header.findIndex(h=>/^(è²¨å“)?ä»£è™Ÿ|å“è™Ÿ|code/i.test(h));
  const idxNameMix = header.findIndex(h=>/è²¨å“åç¨±|å“å|åç¨±/i.test(h));
  const idxUnit    = header.findIndex(h=>/è¦æ ¼å–®ä½|å–®ä½|unit/i.test(h));
  const idxPrice   = header.findIndex(h=>/å–®åƒ¹|æœªç¨…|price/i.test(h));
  const idxCat     = header.findIndex(h=>/åˆ†é¡|é¡åˆ¥|category/i.test(h));

  for(const cols of lines){
    const oldCode = idxCodeOld>=0? cols[idxCodeOld] : '';
    const mixed   = idxNameMix>=0? cols[idxNameMix] : '';
    const unit    = idxUnit>=0? cols[idxUnit] : '';
    const price   = idxPrice>=0? cols[idxPrice] : '';
    const catText = idxCat>=0? cols[idxCat] : '';

    const {brand,name,spec} = splitMix(mixed);
    const prefix = inferPrefix(catText||'', oldCode||'');
    const abbr   = brandAbbr(brand||'-');
    const serial = nextSerial(prefix, abbr);
    const code   = `${prefix}-${abbr}-${serial}`;
    const excl   = parsePrice(price);

    db.run(`INSERT OR REPLACE INTO products(code,brand,name,spec,unit,price_excl,category) VALUES(?,?,?,?,?,?,?)`,
      [code,brand||'',name||mixed||'',spec||'',unit||'',excl, PREFIX_NAME[prefix]||'å…¶ä»–å•†å“']);
  }
  render();
  alert('CSV å·²åŒ¯å…¥ä¸¦è‡ªå‹•å¥—ç”¨æ–™è™Ÿ');
  e.target.value='';
});

function exportCSV(){
  let stmt=db.prepare("SELECT code,brand,name,spec,unit,category,price_excl FROM products ORDER BY code");
  let out="ä»£è™Ÿ,å“ç‰Œ,å“å,è¦æ ¼,å–®ä½,åˆ†é¡,æœªç¨…\n";
  while(stmt.step()){
    const [c,b,n,s,u,cat,p]=stmt.get();
    out+=`${c},${b||''},${n||''},${s||''},${u||''},${cat||''},${p||''}\n`;
  }
  stmt.free();
  let blob=new Blob(["\uFEFF"+out],{type:'text/csv'});
  let a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='products_with_codes.csv';a.click();
}

function render(){
  const tbody=document.getElementById('rows');tbody.innerHTML="";
  let stmt=db.prepare("SELECT code,brand,name,spec,unit,category,price_excl FROM products ORDER BY code");
  while(stmt.step()){
    const [c,b,n,s,u,cat,p]=stmt.get();
    tbody.innerHTML+=`<tr><td>${c}</td><td>${b}</td><td>${n}</td><td>${s}</td><td>${u}</td><td>${cat}</td><td>${p}</td></tr>`;
  }
  stmt.free();
}
</script>
</body>
</html>