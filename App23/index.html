<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å•†å“æ–™è™Ÿç®¡ç† Â· é€²éŠ·å­˜ PWA</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <style>
    body{margin:0;font-family:ui-sans-serif,system-ui,"Noto Sans TC";background:#0b1220;color:#e2e8f0}
    header{background:#0f172a;padding:12px;position:sticky;top:0;z-index:9;display:flex;flex-direction:column;gap:6px}
    h1{margin:0;font-size:20px;color:#0ea5e9}
    button{background:#0ea5e9;border:none;color:white;padding:6px 12px;border-radius:8px;cursor:pointer}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid rgba(148,163,184,.3);padding:6px;text-align:left}
    tr:hover{background:rgba(148,163,184,.08)}
  </style>
</head>
<body>
<header>
  <h1>ğŸ“¦ å•†å“æ–™è™Ÿç®¡ç† Â· é€²éŠ·å­˜</h1>
  <div class="toolbar">
    <input id="q" placeholder="æœå°‹ ç·¨è™Ÿ/å» å•†/å“å/è¦æ ¼/åˆ†é¡..." />
    <button onclick="document.getElementById('fileCsv').click()">åŒ¯å…¥ CSVï¼ˆè‡ªå‹•å¥—æ–™è™Ÿï¼‰</button>
    <input type="file" id="fileCsv" accept=".csv,text/csv" style="display:none" />
    <button onclick="exportCSV()">åŒ¯å‡º CSV</button>
  </div>
</header>
<main>
  <h2>å•†å“æ¸…å–®</h2>
  <table>
    <!-- è¡¨é ­ï¼šå·²æ”¹ç‚º ç·¨è™Ÿ / å» å•† / å“å / è¦æ ¼ / å–®ä½ / åˆ†é¡ / æœªç¨… -->
    <thead><tr><th>ç·¨è™Ÿ</th><th>å» å•†</th><th>å“å</th><th>è¦æ ¼</th><th>å–®ä½</th><th>åˆ†é¡</th><th>æœªç¨…</th></tr></thead>
    <tbody id="rows"></tbody>
  </table>
</main>

<script>
// ========================
// åˆå§‹åŒ– SQLite (sql.js)
// ========================
let db,SQL;
(async()=>{
  // ä¸‹è¼‰ sql.jsï¼Œä¸¦åœ¨ç€è¦½å™¨é–‹ä¸€é¡†è¨˜æ†¶é«”è³‡æ–™åº«
  SQL = await initSqlJs({locateFile:f=>`https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`});
  db=new SQL.Database();

  // å»ºç«‹å•†å“è¡¨ï¼ˆä¸»éµï¼šcode = æ–™è™Ÿï¼‰
  db.run(`CREATE TABLE IF NOT EXISTS products(
    code TEXT PRIMARY KEY,
    brand TEXT,    -- å» å•†/å“ç‰Œ
    name  TEXT,    -- å“å
    spec  TEXT,    -- è¦æ ¼
    unit  TEXT,    -- å–®ä½
    category TEXT, -- åˆ†é¡åç¨±
    price_excl REAL -- æœªç¨…å–®åƒ¹
  );`);

  // å‘ä¸‹ç›¸å®¹ï¼šèˆŠ DB è‹¥æ²’æœ‰ category æ¬„ï¼Œå˜—è©¦æ–°å¢ï¼ˆæœ‰å°±å¿½ç•¥éŒ¯èª¤ï¼‰
  try{db.run('ALTER TABLE products ADD COLUMN category TEXT');}catch(_){}

  bindUI();
  render();
})();

// ========================================
// è¦å‰‡ï¼šè‡ªå‹•ç”¢ç”Ÿæ–™è™Ÿï¼ˆå‰ç¶´-å“ç‰Œç¸®å¯«-æµæ°´è™Ÿï¼‰
// ========================================
const CATEGORY_PREFIX = {
  'æ¸…æ½”ç”¨å“':'62','æ¸…æ½”':'62','æ¸…æ½”åŠ‘':'62',
  'é¤å…·ç”¨å“':'66','é¤å…·':'66','å®´æœƒç”¨å“':'66',
  'è¾¦å…¬ç”¨å“':'70','è¾¦å…¬':'70',
  'åŒ…è£ææ–™':'80','åŒ…æ':'80','åŒ…è£':'80',
  'äº”é‡‘å·¥å…·':'90','äº”é‡‘':'90','å·¥å…·':'90',
  'å…¶ä»–å•†å“':'99','å…¶ä»–':'99','æœªåˆ†é¡':'99'
};
const PREFIX_NAME = {'62':'æ¸…æ½”ç”¨å“','66':'é¤å…·ç”¨å“','70':'è¾¦å…¬ç”¨å“','80':'åŒ…è£ææ–™','90':'äº”é‡‘å·¥å…·','99':'å…¶ä»–å•†å“'};

// å°‡ã€Œå“ç‰Œ/å“å/è¦æ ¼ã€åˆä½µå­—ä¸²æ‹†æˆä¸‰æ¬„
function splitMix(mixed){
  if(!mixed) return {brand:'',name:'',spec:''};
  const parts = String(mixed).split('/').map(s=>s.trim()).filter(Boolean);
  if(parts.length===1) return {brand:'',name:parts[0],spec:''};
  if(parts.length===2) return {brand:parts[0],name:parts[1],spec:''};
  return {brand:parts[0],name:parts[1],spec:parts.slice(2).join('/')};
}

// ç”±å“ç‰Œç”¢ç”Ÿç¸®å¯«ï¼šæœ‰è‹±æ•¸å–å‰ä¸‰ç¢¼ï¼›ç´”ä¸­æ–‡å‰‡å“ˆå¸Œæˆ 2 ç¢¼ A~Z
function brandAbbr(brand){
  if(!brand || brand==='-') return 'NO';
  const letters = (brand.match(/[A-Za-z0-9]/g)||[]).join('').toUpperCase();
  if(letters) return letters.slice(0,3);
  let h=0; for(let i=0;i<brand.length;i++){ h=(h*31 + brand.charCodeAt(i))>>>0; }
  const a = String.fromCharCode(65 + (h%26));
  const b = String.fromCharCode(65 + ((h>>5)%26));
  return a+b;
}

// è§£æåƒ¹æ ¼å­—ä¸²æˆæ•¸å€¼
function parsePrice(s){
  if(s==null) return null;
  const t=String(s).replace(/[,$\s]/g,'').replace(/^\$/,'');
  const v=parseFloat(t);
  return isNaN(v)? null : v;
}

// ä¾ã€Œåˆ†é¡æ–‡å­—ã€æˆ–ã€ŒèˆŠä»£è™Ÿå‰2ç¢¼ã€æ¨æ–·å‰ç¶´
function inferPrefix(categoryText, oldCode){
  if(categoryText){
    for(const k in CATEGORY_PREFIX){ if(String(categoryText).includes(k)) return CATEGORY_PREFIX[k]; }
  }
  if(oldCode){ const m = String(oldCode).match(/^(\d{2})/); if(m) return m[1]; }
  return '99';
}

// åŒä¸€çµ„ã€Œå‰ç¶´-å“ç‰Œç¸®å¯«ã€ä¸‹ï¼Œæ‰¾æœ€å¤§æµæ°´è™Ÿ +1
function nextSerial(prefix, abbr){
  const stmt = db.prepare("SELECT code FROM products WHERE code LIKE ? ORDER BY code DESC LIMIT 1");
  stmt.bind([`${prefix}-${abbr}-%`]);
  let max=0; while(stmt.step()){
    const [code]=stmt.get();
    const m=String(code).match(/-(\d{3})$/);
    if(m){ max=Math.max(max,parseInt(m[1],10)); }
  }
  stmt.free();
  return (max+1).toString().padStart(3,'0');
}

// ========================================
// CSV è§£æï¼ˆæ”¯æ´å¼•è™Ÿ/é€—è™Ÿ/æ›è¡Œï¼‰
// ========================================
function parseCSV(text){
  const out=[]; let row=[],val='',inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(inQ){
      if(c==='"'){ if(text[i+1]==='"'){ val+='"'; i++; } else inQ=false; }
      else val+=c;
    }else{
      if(c==='"') inQ=true;
      else if(c===','){ row.push(val); val=''; }
      else if(c==='\n' || c==='\r'){ if(val!==''||row.length>0){ row.push(val); out.push(row); row=[]; val=''; } }
      else val+=c;
    }
  }
  if(val!==''||row.length>0){ row.push(val); out.push(row); }
  return out.filter(r=> r.some(x=>String(x).trim()!=='') );
}

// ===== åŒ¯å…¥ CSVï¼ˆåŒæ™‚æ”¯æ´å…©ç¨®æ ¼å¼ï¼Œå„ªå…ˆä½¿ç”¨åˆ†é–‹æ¬„ä½ï¼‰ =====
document.getElementById('fileCsv').addEventListener('change', async e => {
  const file = e.target.files[0]; if (!file) return;
  const text = await file.text();
  const rows = parseCSV(text); if (!rows.length) { alert('CSV æ˜¯ç©ºçš„'); return; }
  const header = rows.shift().map(h => String(h).trim());

  // æ¨™é¡ŒåŒ¹é…ï¼ˆæ“´å……åŒç¾©è©ï¼‰
  const idxCodeOld = header.findIndex(h => /^(è²¨å“)?ä»£è™Ÿ|ç·¨è™Ÿ|å“è™Ÿ|code/i.test(h));
  const idxNameMix = header.findIndex(h => /è²¨å“åç¨±|å“å|åç¨±/i.test(h));             // åˆä½µæ¬„ä½ï¼ˆæœ€å¾Œæ‰ä½¿ç”¨ï¼‰
  const idxBrand   = header.findIndex(h => /(å“ç‰Œ|å» å•†|å» ç‰Œ|ä¾›æ‡‰å•†)/i.test(h));         // åˆ†é–‹æ¬„ä½ï¼šå“ç‰Œ/å» å•†
  const idxName    = header.findIndex(h => /(å“å|åç¨±)/i.test(h));                     // åˆ†é–‹æ¬„ä½ï¼šå“å/åç¨±
  const idxSpec    = header.findIndex(h => /(è¦æ ¼(èªªæ˜)?|å‹è™Ÿ|è¦æ ¼å‹è™Ÿ)/i.test(h));     // åˆ†é–‹æ¬„ä½ï¼šè¦æ ¼/å‹è™Ÿ
  const idxUnit    = header.findIndex(h => /è¦æ ¼å–®ä½|å–®ä½|unit/i.test(h));
  const idxPrice   = header.findIndex(h => /å–®åƒ¹|æœªç¨…|price/i.test(h));
  const idxCat     = header.findIndex(h => /åˆ†é¡|é¡åˆ¥|category/i.test(h));

  rows.forEach(cols => {
    const get = i => (i >= 0 && i < cols.length ? String(cols[i]).trim() : '');

    const oldCode = get(idxCodeOld);
    const unit    = get(idxUnit);
    const price   = get(idxPrice);
    const catText = get(idxCat);

    // â€”â€” é—œéµä¿®æ­£ï¼šåªè¦åµæ¸¬åˆ°åˆ†é–‹æ¬„ä½ï¼ˆbrand/spec å…¶ä¸­ä¹‹ä¸€å­˜åœ¨ï¼‰ï¼Œå°±å„ªå…ˆèµ°åˆ†é–‹æ¨¡å¼ â€”â€”
    const hasSeparated = (idxBrand >= 0) || (idxSpec >= 0);

    let brand = '', name = '', spec = '';
    if (hasSeparated) {
      brand = get(idxBrand);
      // åç¨±æ¬„å„ªå…ˆä½¿ç”¨ã€Œå“å/åç¨±ã€ï¼Œè‹¥æ²’æä¾›å°±é€€å›åˆä½µæ¬„ä½
      name  = get(idxName) || get(idxNameMix);
      spec  = get(idxSpec);
    } else if (idxNameMix >= 0) {
      // åˆä½µæ¬„ä½æ¨¡å¼ï¼ˆå“ç‰Œ/å“å/è¦æ ¼ï¼‰
      ({ brand, name, spec } = splitMix(get(idxNameMix)));
    } else {
      // å…©ç¨®éƒ½æ²’åµæ¸¬åˆ°æ™‚ï¼Œç›¡é‡å¡å…¥åç¨±é¿å…æ•´åˆ—ç©ºç™½
      name = get(0);
    }

    const prefix = inferPrefix(catText || '', oldCode || '');
    const abbr   = brandAbbr(brand || '-');
    const serial = nextSerial(prefix, abbr);
    const code   = `${prefix}-${abbr}-${serial}`;
    const excl   = parsePrice(price);

    db.run(
      `INSERT OR REPLACE INTO products(code,brand,name,spec,unit,price_excl,category) VALUES(?,?,?,?,?,?,?)`,
      [code, brand || '', name || '', spec || '', unit || '', excl, PREFIX_NAME[prefix] || 'å…¶ä»–å•†å“']
    );
  });

  render();
  alert('CSV å·²åŒ¯å…¥ä¸¦è‡ªå‹•å¥—ç”¨æ–™è™Ÿ');
  e.target.value = '';
});


// ========================================
// åŒ¯å‡º CSVï¼ˆè¡¨é ­å·²æ”¹ç‚ºã€Œç·¨è™Ÿ,å» å•†,...ã€ï¼‰
// ========================================
function exportCSV(){
  const stmt=db.prepare("SELECT code,brand,name,spec,unit,category,price_excl FROM products ORDER BY code");
  let out="ç·¨è™Ÿ,å» å•†,å“å,è¦æ ¼,å–®ä½,åˆ†é¡,æœªç¨…\n"; // <-- é€™è£¡å·²æ›´å
  while(stmt.step()){
    const [c,b,n,s,u,cat,p]=stmt.get();
    // åŸºæœ¬ CSV è½‰ç¾©
    const cells=[c,b,n,s,u,cat,p].map(x=>{
      const t=(x==null?'' : String(x));
      return /[\",\n]/.test(t)? '"'+t.replace(/\"/g,'""')+'"' : t;
    });
    out+=cells.join(',')+"\n";
  }
  stmt.free();
  const blob=new Blob(["\uFEFF"+out],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='products_with_codes.csv';a.click();
}

// ========================================
function bindUI(){
  document.getElementById('q').addEventListener('input', render);
}

// ç•«é¢æ¸²æŸ“ + æœå°‹
function render(){
  const q=(document.getElementById('q').value||'').toLowerCase();
  const tbody=document.getElementById('rows');tbody.innerHTML="";
  const stmt=db.prepare("SELECT code,brand,name,spec,unit,category,price_excl FROM products ORDER BY code");
  while(stmt.step()){
    const [c,b,n,s,u,cat,p]=stmt.get();
    const hay = `${c} ${b||''} ${n||''} ${s||''} ${u||''} ${cat||''}`.toLowerCase();
    if(q && !hay.includes(q)) continue;
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td>${c}</td><td>${b||''}</td><td>${n||''}</td><td>${s||''}</td><td>${u||''}</td><td>${cat||''}</td><td>${p??''}</td></tr>`
    );
  }
  stmt.free();
}
</script>
</body>
</html>
