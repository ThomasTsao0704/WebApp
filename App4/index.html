<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¨™å€Ÿï¼ˆTWSEï¼‰ç•¶æœˆè³‡æ–™</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
           background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; color: #fff; margin-bottom: 20px; }
    .header h1 { font-size: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,.3); }
    .header p { opacity: .9; margin-top: 6px; }
    .update-time { display: inline-block; margin-top: 10px; padding: 6px 14px; border-radius: 20px;
                   background: rgba(255,255,255,.2); backdrop-filter: blur(10px); }
    .controls { display: flex; gap: 10px; justify-content: flex-end; margin: 14px 0; }
    button { padding: 10px 14px; font-size: 14px; border-radius: 8px; cursor: pointer; border: 2px solid #e1e5e9; transition: .2s; }
    .btn-primary { background: #667eea; color: #fff; border-color: #667eea; font-weight: 600; }
    .btn-primary:hover { background: #5a6fd8; transform: translateY(-1px); }
    .btn-soft { background: #fff; color: #333; }
    .table-section { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: hidden; }
    .section-header { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; padding: 14px 16px; font-weight: 600; }
    .table-container { max-height: 70vh; overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { position: sticky; top: 0; background: #f8f9fa; color: #666; font-size: 12px; letter-spacing: .5px;
         text-align: left; padding: 12px 10px; z-index: 1; }
    td { padding: 12px 10px; border-bottom: 1px solid #eee; }
    tr:hover { background: #f8f9ff; }
    .alert { display: none; margin: 12px 0; padding: 10px 14px; border-radius: 8px; border: 1px solid #ffeaa7; background: #fff3cd; color: #856404; }
    @media (max-width: 768px) { .header h1 { font-size: 1.6rem; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š æ¨™å€Ÿï¼ˆTWSEï¼‰ç•¶æœˆè³‡æ–™</h1>
      <p>ç›´æ¥é¡¯ç¤ºå®˜æ–¹å ±è¡¨ exchangeReport/BFIB8U ç•¶æœˆè³‡æ–™ï¼ˆç„¡ç¯©é¸/æœå°‹ï¼‰</p>
      <div class="update-time" id="lastUpdate">æœ€å¾Œæ›´æ–°ï¼šâ€”</div>
    </div>

    <div class="controls">
      <button id="btnRefresh" class="btn-primary">ğŸ”„ æ›´æ–°è³‡æ–™</button>
      <button id="btnExport" class="btn-soft">ğŸ’¾ åŒ¯å‡º CSV</button>
    </div>

    <div id="alertMsg" class="alert"></div>

    <div class="table-section">
      <div class="section-header">
        æ¨™å€Ÿç¸½è¦½ï¼ˆ<span id="totalCount">0</span> ç­†ï¼‰
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:120px">æ¨™å€Ÿæ—¥æœŸ</th>
              <th style="width:110px">è­‰åˆ¸ä»£è™Ÿ</th>
              <th>è­‰åˆ¸åç¨±</th>
              <th style="width:140px">æ¨™å€Ÿæ•¸é‡(å¼µ)</th>
              <th style="width:160px">æœ€ä½å¾—æ¨™å–®åƒ¹(%)</th>
              <th style="width:160px">æœ€é«˜å¾—æ¨™å–®åƒ¹(%)</th>
              <th style="width:140px">å¾—æ¨™æ•¸é‡(å¼µ)</th>
              <th style="width:140px">ä¸è¶³æ•¸é‡(å¼µ)</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" style="text-align:center;color:#666;padding:24px">è¼‰å…¥ç•¶æœˆè³‡æ–™ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== æ™‚é–“èˆ‡æç¤º =====
    const alertEl = document.getElementById('alertMsg');
    const nf = new Intl.NumberFormat('zh-TW');
    const pad = n => String(n).padStart(2,'0');

    function showAlert(msg, type='info') {
      alertEl.textContent = msg;
      alertEl.style.display = 'block';
      alertEl.style.background = type==='success' ? '#e8f5e9' : '#fff3cd';
      alertEl.style.borderColor = type==='success' ? '#a5d6a7' : '#ffeaa7';
      setTimeout(()=> alertEl.style.display = 'none', 2500);
    }
    function updateClock() {
      document.getElementById('lastUpdate').textContent =
        'æœ€å¾Œæ›´æ–°ï¼š' + new Date().toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    // ===== å–å¾—ã€Œç•¶æœˆã€èµ·è¨–ï¼ˆYYYYMMDDï¼‰=====
    function monthRange(today = new Date()) {
      const y = today.getFullYear(), m = today.getMonth()+1;
      const start = `${y}${pad(m)}01`;
      const endDate = new Date(y, m, 0).getDate();
      const end = `${y}${pad(m)}${pad(Math.min(today.getDate(), endDate))}`;
      return { start, end };
    }

    // ===== ä¸»è¦è³‡æ–™æŠ“å–ï¼šå…ˆ JSONï¼Œå†é€€ CSVï¼›éƒ½å¤±æ•—æ™‚å†å˜—è©¦ CSV ç¶“ç”± proxyï¼ˆåƒ…æ¸¬è©¦ï¼‰=====
    async function fetchBFIB8UMonth() {
      const { start, end } = monthRange(new Date());
      const base = 'https://www.twse.com.tw/exchangeReport/BFIB8U';

      // 1) JSON
      try {
        const url = `${base}?response=json&date=${start}&date2=${end}&stockNo=&_=${Date.now()}`;
        const r = await fetch(url, { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (j && (j.stat === 'OK' || (Array.isArray(j.data) && j.data.length))) {
            return normalizeRowsFromArray(j.fields || [], j.data || []);
          }
        }
      } catch (e) { /* ignore, fallback to CSV */ }

      // 2) CSV
      try {
        const csvUrl = `${base}?response=csv&date=${start}&date2=${end}&stockNo=&_=${Date.now()}`;
        const txt = await (await fetch(csvUrl, { cache: 'no-store' })).text();
        const rows = normalizeRowsFromCSV(txt);
        if (rows.length) return rows;
      } catch (e) { /* ignore, fallback to proxy */ }

      // 3) CSV via proxyï¼ˆé–‹ç™¼æ¸¬è©¦ç”¨ï¼›ç”Ÿç”¢å»ºè­°è‡ªå®¶å¾Œç«¯ï¼‰
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(
        `${base}?response=csv&date=${start}&date2=${end}&stockNo=`
      );
      const txt2 = await (await fetch(proxy, { cache: 'no-store' })).text();
      return normalizeRowsFromCSV(txt2);
    }

    // ===== æ¨™æº–åŒ– (JSON: fields + data[][]) =====
    function normalizeRowsFromArray(fields, rows) {
      const idx = name => fields.findIndex(f => f.includes(name));
      const iDate = idx('æ¨™å€Ÿæ—¥æœŸ'), iCode = idx('è­‰åˆ¸ä»£è™Ÿ'), iName = idx('è­‰åˆ¸åç¨±');
      const iBidQ = idx('æ¨™å€Ÿæ•¸é‡'), iLow = idx('æœ€ä½å¾—æ¨™å–®åƒ¹'), iHigh = idx('æœ€é«˜å¾—æ¨™å–®åƒ¹');
      const iWinQ = idx('å¾—æ¨™æ•¸é‡'), iLack = idx('ä¸è¶³æ•¸é‡');
      return rows.map(r => ({
        date: r[iDate] || '',
        code: r[iCode] || '',
        name: r[iName] || '',
        bidQty: +toNum(r[iBidQ]),
        low: numOrNull(r[iLow]),
        high: numOrNull(r[iHigh]),
        winQty: +toNum(r[iWinQ]),
        lackQty: +toNum(r[iLack]),
      }));
    }

    // ===== è§£æ CSV =====
    function normalizeRowsFromCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      const headIdx = lines.findIndex(l => /æ¨™å€Ÿæ—¥æœŸ.+è­‰åˆ¸ä»£è™Ÿ.+è­‰åˆ¸åç¨±/.test(l));
      if (headIdx === -1) return [];
      const headers = parseCSVLine(lines[headIdx]);
      const dataLines = lines.slice(headIdx + 1);

      const idx = re => headers.findIndex(h => re.test(h));
      const iDate = idx(/æ¨™å€Ÿæ—¥æœŸ/), iCode = idx(/è­‰åˆ¸ä»£è™Ÿ/), iName = idx(/è­‰åˆ¸åç¨±/);
      const iBidQ = idx(/æ¨™å€Ÿæ•¸é‡/), iLow = idx(/æœ€ä½å¾—æ¨™å–®åƒ¹/), iHigh = idx(/æœ€é«˜å¾—æ¨™å–®åƒ¹/);
      const iWinQ = idx(/å¾—æ¨™æ•¸é‡/), iLack = idx(/ä¸è¶³æ•¸é‡/);

      const out = [];
      for (const line of dataLines) {
        const c = parseCSVLine(line);
        if (!c.length || !c[iCode] || /èªªæ˜|åˆè¨ˆ|ç¸½ç­†æ•¸/.test(c[iCode])) continue;
        out.push({
          date: c[iDate] || '',
          code: c[iCode] || '',
          name: c[iName] || '',
          bidQty: +toNum(c[iBidQ]),
          low: numOrNull(c[iLow]),
          high: numOrNull(c[iHigh]),
          winQty: +toNum(c[iWinQ]),
          lackQty: +toNum(c[iLack]),
        });
      }
      return out;
    }

    function parseCSVLine(line) {
      const cells = line.match(/("([^"]|"")*"|[^,]+)/g) || [];
      return cells.map(s => {
        s = s.trim();
        if (s.startsWith('"') && s.endsWith('"')) s = s.slice(1, -1).replace(/""/g, '"');
        return s;
      });
    }
    const toNum = v => String(v ?? '').replace(/,/g, '');
    const numOrNull = v => {
      const n = parseFloat(String(v ?? '').replace(/,/g, ''));
      return Number.isFinite(n) ? n : null;
    };

    // ===== æ¸²æŸ“ï¼ˆä¸åšä»»ä½•ç¯©é¸/æœå°‹ï¼‰=====
    async function loadData() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#666;padding:24px">è¼‰å…¥ç•¶æœˆè³‡æ–™ä¸­â€¦</td></tr>`;
      try {
        const rows = await fetchBFIB8UMonth();

        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#c00;padding:24px">ç•¶æœˆæŸ¥ç„¡è³‡æ–™ï¼ˆæˆ–å°šæœªé–‹æ¨™ï¼‰ã€‚</td></tr>`;
          document.getElementById('totalCount').textContent = '0';
          updateClock();
          return;
        }

        // æ—¥æœŸæ–°â†’èˆŠã€ä»£è™Ÿæ’åº
        rows.sort((a, b) => (b.date.localeCompare(a.date) || a.code.localeCompare(b.code, 'zh-Hant')));

        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.date}</td>
            <td>${r.code}</td>
            <td>${r.name || '-'}</td>
            <td>${nf.format(r.bidQty)}</td>
            <td>${r.low ?? '-'}</td>
            <td>${r.high ?? '-'}</td>
            <td>${nf.format(r.winQty)}</td>
            <td>${nf.format(r.lackQty)}</td>
          </tr>
        `).join('');

        document.getElementById('totalCount').textContent = rows.length;
        updateClock();
        showAlert(`è¼‰å…¥æˆåŠŸï¼ˆ${rows.length} ç­†ï¼‰`, 'success');
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#c00;padding:24px">è¼‰å…¥å¤±æ•—</td></tr>`;
      }
    }

    // ===== åŒ¯å‡ºç›®å‰è¡¨æ ¼ç‚º CSV =====
    function exportCSV() {
      const header = ['æ¨™å€Ÿæ—¥æœŸ','è­‰åˆ¸ä»£è™Ÿ','è­‰åˆ¸åç¨±','æ¨™å€Ÿæ•¸é‡(å¼µ)','æœ€ä½å¾—æ¨™å–®åƒ¹(%)','æœ€é«˜å¾—æ¨™å–®åƒ¹(%)','å¾—æ¨™æ•¸é‡(å¼µ)','ä¸è¶³æ•¸é‡(å¼µ)'].join(',');
      const rows = Array.from(document.querySelectorAll('#tableBody tr'))
        .map(tr => Array.from(tr.children).map(td => `"${td.textContent.replace(/"/g,'""')}"`).join(','));
      const csv = [header, ...rows].join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `æ¨™å€Ÿ_ç•¶æœˆ_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      showAlert('CSV æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
    }

    // ===== ç¶å®šèˆ‡å•Ÿå‹• =====
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnRefresh').addEventListener('click', loadData);
      document.getElementById('btnExport').addEventListener('click', exportCSV);
      loadData();
    });
  </script>
</body>
</html>
