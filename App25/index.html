<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo Finance è‚¡ç¥¨åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected { background: #27ae60; }
        .status-loading { background: #f39c12; }
        .status-error { background: #e74c3c; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        .control-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .control-item select,
        .control-item input {
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #1c5a7e);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .change-positive { color: #27ae60; }
        .change-negative { color: #e74c3c; }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            overflow-x: auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .footer {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 30px;
        }

        .watchlist {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .watchlist-item:last-child {
            border-bottom: none;
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .symbol-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .symbol-price {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .control-group {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .chart-wrapper {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ“ˆ Yahoo Finance è‚¡ç¥¨åˆ†æç³»ç»Ÿ</h1>
            <p>å®æ—¶è‚¡ç¥¨æ•°æ®åˆ†æ â€¢ VWAPè®¡ç®— â€¢ æŠ€æœ¯æŒ‡æ ‡ â€¢ å®Œå…¨å…è´¹</p>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot status-connected" id="statusDot"></div>
                <span id="statusText">å‡†å¤‡å°±ç»ª</span>
            </div>
            <div>
                <span>æœ€åæ›´æ–°: </span>
                <span id="lastUpdate">--</span>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label>ğŸ“Š è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="symbolInput" placeholder="ä¾‹å¦‚: AAPL, TSLA, SPY" value="AAPL">
                </div>
                <div class="control-item">
                    <label>â° æ—¶é—´èŒƒå›´</label>
                    <select id="periodSelect">
                        <option value="1d">1å¤© (5åˆ†é’Ÿ)</option>
                        <option value="5d">5å¤© (15åˆ†é’Ÿ)</option>
                        <option value="1mo">1ä¸ªæœˆ (1å°æ—¶)</option>
                        <option value="3mo">3ä¸ªæœˆ (1å¤©)</option>
                        <option value="1y">1å¹´ (1å‘¨)</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>ğŸ“ˆ åˆ†æç±»å‹</label>
                    <select id="analysisType">
                        <option value="vwap">VWAPåˆ†æ</option>
                        <option value="price">ä»·æ ¼è¶‹åŠ¿</option>
                        <option value="volume">æˆäº¤é‡åˆ†æ</option>
                        <option value="technical">æŠ€æœ¯æŒ‡æ ‡</option>
                    </select>
                </div>
                <div class="control-item">
                    <label>ğŸ¯ æŒ‡æ•°ETF</label>
                    <select id="indexSelect">
                        <option value="">é€‰æ‹©æŒ‡æ•°ETF</option>
                        <option value="SPY">SPY (S&P 500)</option>
                        <option value="QQQ">QQQ (çº³æ–¯è¾¾å…‹100)</option>
                        <option value="DIA">DIA (é“ç¼æ–¯)</option>
                        <option value="IWM">IWM (ç½—ç´ 2000)</option>
                        <option value="VTI">VTI (å…¨å¸‚åœº)</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" id="analyzeBtn">
                    ğŸ” å¼€å§‹åˆ†æ
                </button>
                <button class="btn btn-secondary" id="addWatchlistBtn">
                    â­ æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨
                </button>
                <button class="btn btn-secondary" id="exportBtn">
                    ğŸ’¾ å¯¼å‡ºæ•°æ®
                </button>
                <button class="btn btn-secondary" id="compareBtn">
                    ğŸ”„ å¯¹æ¯”åˆ†æ
                </button>
            </div>
        </div>

        <!-- è­¦å‘Šä¿¡æ¯ -->
        <div class="alert alert-error" id="errorAlert">
            <strong>âŒ é”™è¯¯:</strong> <span id="errorMessage"></span>
        </div>
        <div class="alert alert-success" id="successAlert">
            <strong>âœ… æˆåŠŸ:</strong> <span id="successMessage"></span>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div class="loading-spinner" id="loadingSpinner"></div>

        <!-- å…³é”®æŒ‡æ ‡ -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">ğŸ’°</div>
                <div class="metric-value" id="currentPrice">--</div>
                <div class="metric-label">å½“å‰ä»·æ ¼</div>
                <div class="metric-change" id="priceChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #27ae60, #229954);">ğŸ“Š</div>
                <div class="metric-value" id="vwapValue">--</div>
                <div class="metric-label">VWAP</div>
                <div class="metric-change" id="vwapChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">ğŸ“ˆ</div>
                <div class="metric-value" id="volumeValue">--</div>
                <div class="metric-label">æˆäº¤é‡</div>
                <div class="metric-change" id="volumeChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: linear-gradient(135deg, #f39c12, #e67e22);">âš¡</div>
                <div class="metric-value" id="volatilityValue">--</div>
                <div class="metric-label">æ³¢åŠ¨ç‡</div>
                <div class="metric-change" id="volatilityChange">--</div>
            </div>
        </div>

        <!-- ä¸»å›¾è¡¨ -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">è‚¡ç¥¨ä»·æ ¼èµ°åŠ¿å›¾</div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="toggleChartType()">ğŸ“Š åˆ‡æ¢å›¾è¡¨</button>
                    <button class="btn btn-secondary" onclick="toggleFullscreen()">ğŸ” å…¨å±</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- æ¬¡è¦å›¾è¡¨ -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title">æˆäº¤é‡åˆ†æ</div>
            </div>
            <div class="chart-wrapper">
                <canvas id="volumeChart"></canvas>
            </div>
        </div>

        <!-- å…³æ³¨åˆ—è¡¨ -->
        <div class="watchlist">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“‹ è‚¡ç¥¨å…³æ³¨åˆ—è¡¨</h3>
            <div id="watchlistContent">
                <div class="watchlist-item">
                    <div class="symbol-info">
                        <div class="symbol-name">æš‚æ— å…³æ³¨è‚¡ç¥¨</div>
                        <div class="symbol-price">è¯·æ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="data-table">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“Š è¯¦ç»†æ•°æ®</h3>
            <table class="table" id="dataTable">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å¼€ç›˜ä»·</th>
                        <th>æœ€é«˜ä»·</th>
                        <th>æœ€ä½ä»·</th>
                        <th>æ”¶ç›˜ä»·</th>
                        <th>æˆäº¤é‡</th>
                        <th>VWAP</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">è¯·é€‰æ‹©è‚¡ç¥¨å¹¶ç‚¹å‡»"å¼€å§‹åˆ†æ"è·å–æ•°æ®</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- é¡µè„š -->
        <div class="footer">
            <p>ğŸ”” <strong>å…è´£å£°æ˜:</strong> æœ¬åº”ç”¨ä½¿ç”¨Yahoo Financeéå®˜æ–¹APIï¼Œæ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</p>
            <p>ğŸ“± æ”¯æŒå®æ—¶æ•°æ®è·å– â€¢ ğŸ”„ è‡ªåŠ¨è®¡ç®—æŠ€æœ¯æŒ‡æ ‡ â€¢ ğŸ’¾ æ•°æ®å¯¼å‡ºåŠŸèƒ½</p>
            <p style="margin-top: 10px;">Made with â¤ï¸ for stock analysis</p>
        </div>
    </div>

    <script>
        class YahooFinanceApp {
            constructor() {
                this.charts = {};
                this.currentData = null;
                this.watchlist = JSON.parse(localStorage.getItem('stockWatchlist') || '[]');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initCharts();
                this.loadWatchlist();
                this.updateStatus('ready', 'å‡†å¤‡å°±ç»ª');
            }

            setupEventListeners() {
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeStock());
                document.getElementById('addWatchlistBtn').addEventListener('click', () => this.addToWatchlist());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('compareBtn').addEventListener('click', () => this.compareStocks());
                document.getElementById('indexSelect').addEventListener('change', (e) => {
                    if (e.target.value) {
                        document.getElementById('symbolInput').value = e.target.value;
                    }
                });
            }

            updateStatus(type, message) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusDot.className = `status-dot status-${type}`;
                statusText.textContent = message;
                
                if (type === 'loading') {
                    document.getElementById('loadingSpinner').style.display = 'block';
                } else {
                    document.getElementById('loadingSpinner').style.display = 'none';
                }
            }

            showAlert(type, message) {
                const alertElement = document.getElementById(`${type}Alert`);
                const messageElement = document.getElementById(`${type}Message`);
                
                messageElement.textContent = message;
                alertElement.style.display = 'block';
                
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }

            async fetchYahooData(symbol) {
                const period = document.getElementById('periodSelect').value;
                const now = Math.floor(Date.now() / 1000);
                
                let period1, period2, interval;
                switch(period) {
                    case '1d':
                        period1 = now - (24 * 60 * 60);
                        period2 = now;
                        interval = '5m';
                        break;
                    case '5d':
                        period1 = now - (5 * 24 * 60 * 60);
                        period2 = now;
                        interval = '15m';
                        break;
                    case '1mo':
                        period1 = now - (30 * 24 * 60 * 60);
                        period2 = now;
                        interval = '1h';
                        break;
                    case '3mo':
                        period1 = now - (90 * 24 * 60 * 60);
                        period2 = now;
                        interval = '1d';
                        break;
                    case '1y':
                        period1 = now - (365 * 24 * 60 * 60);
                        period2 = now;
                        interval = '1wk';
                        break;
                    default:
                        period1 = now - (24 * 60 * 60);
                        period2 = now;
                        interval = '5m';
                }

                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${period1}&period2=${period2}&interval=${interval}&includePrePost=true&events=div%7Csplit`;
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.chart?.error) {
                        throw new Error(data.chart.error.description);
                    }

                    return this.processYahooData(data);
                } catch (error) {
                    throw new Error(`è·å–${symbol}æ•°æ®å¤±è´¥: ${error.message}`);
                }
            }

            processYahooData(rawData) {
                const result = rawData.chart?.result?.[0];
                if (!result) throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');

                const timestamps = result.timestamp || [];
                const quote = result.indicators?.quote?.[0] || {};
                const volumes = quote.volume || [];
                const opens = quote.open || [];
                const highs = quote.high || [];
                const lows = quote.low || [];
                const closes = quote.close || [];

                const processedData = [];
                let cumulativePriceVolume = 0;
                let cumulativeVolume = 0;

                timestamps.forEach((timestamp, index) => {
                    if (volumes[index] && closes[index] && highs[index] && lows[index]) {
                        const high = highs[index];
                        const low = lows[index];
                        const close = closes[index];
                        const volume = volumes[index];
                        const open = opens[index] || close;

                        // è®¡ç®—VWAP
                        const typicalPrice = (high + low + close) / 3;
                        const priceVolume = typicalPrice * volume;
                        cumulativePriceVolume += priceVolume;
                        cumulativeVolume += volume;
                        const vwap = cumulativeVolume > 0 ? cumulativePriceVolume / cumulativeVolume : typicalPrice;

                        processedData.push({
                            timestamp,
                            date: new Date(timestamp * 1000),
                            open,
                            high,
                            low,
                            close,
                            volume,
                            vwap,
                            typicalPrice
                        });
                    }
                });

                return {
                    symbol: result.meta?.symbol,
                    data: processedData,
                    meta: result.meta
                };
            }

            calculateTechnicalIndicators(data) {
                const prices = data.map(d => d.close);
                const volumes = data.map(d => d.volume);
                
                // ç®€å•ç§»åŠ¨å¹³å‡çº¿
                const sma20 = this.calculateSMA(prices, 20);
                const sma50 = this.calculateSMA(prices, 50);
                
                // ç›¸å¯¹å¼ºå¼±æŒ‡æ•°
                const rsi = this.calculateRSI(prices, 14);
                
                // å¸ƒæ—å¸¦
                const bollinger = this.calculateBollingerBands(prices, 20, 2);
                
                // MACD
                const macd = this.calculateMACD(prices);

                return {
                    sma20,
                    sma50,
                    rsi,
                    bollinger,
                    macd,
                    avgVolume: volumes.reduce((a, b) => a + b, 0) / volumes.length,
                    volatility: this.calculateVolatility(prices)
                };
            }

            calculateSMA(prices, period) {
                const sma = [];
                for (let i = period - 1; i < prices.length; i++) {
                    const sum = prices.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    sma.push(sum / period);
                }
                return sma;
            }

            calculateRSI(prices, period) {
                const gains = [];
                const losses = [];
                
                for (let i = 1; i < prices.length; i++) {
                    const change = prices[i] - prices[i - 1];
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? -change : 0);
                }

                const rsi = [];
                for (let i = period - 1; i < gains.length; i++) {
                    const avgGain = gains.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period;
                    const rs = avgGain / avgLoss;
                    rsi.push(100 - (100 / (1 + rs)));
                }
                
                return rsi;
            }

            calculateBollingerBands(prices, period, stdDev) {
                const sma = this.calculateSMA(prices, period);
                const bands = [];
                
                for (let i = period - 1; i < prices.length; i++) {
                    const slice = prices.slice(i - period + 1, i + 1);
                    const mean = slice.reduce((a, b) => a + b, 0) / period;
                    const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
                    const std = Math.sqrt(variance);
                    
                    bands.push({
                        middle: sma[i - period + 1],
                        upper: mean + (stdDev * std),
                        lower: mean - (stdDev * std)
                    });
                }
                
                return bands;
            }

            calculateMACD(prices) {
                const ema12 = this.calculateEMA(prices, 12);
                const ema26 = this.calculateEMA(prices, 26);
                const macdLine = [];
                
                for (let i = 0; i < Math.min(ema12.length, ema26.length); i++) {
                    macdLine.push(ema12[i] - ema26[i]);
                }
                
                const signalLine = this.calculateEMA(macdLine, 9);
                const histogram = [];
                
                for (let i = 0; i < Math.min(macdLine.length, signalLine.length); i++) {
                    histogram.push(macdLine[i] - signalLine[i]);
                }
                
                return { macdLine, signalLine, histogram };
            }

            calculateEMA(prices, period) {
                const ema = [];
                const multiplier = 2 / (period + 1);
                
                // ç¬¬ä¸€ä¸ªEMAå€¼ä½¿ç”¨SMA
                let sum = 0;
                for (let i = 0; i < period; i++) {
                    sum += prices[i];
                }
                ema.push(sum / period);
                
                // åç»­EMAå€¼
                for (let i = period; i < prices.length; i++) {
                    ema.push((prices[i] * multiplier) + (ema[ema.length - 1] * (1 - multiplier)));
                }
                
                return ema;
            }

            calculateVolatility(prices) {
                const returns = [];
                for (let i = 1; i < prices.length; i++) {
                    returns.push((prices[i] - prices[i - 1]) / prices[i - 1]);
                }
                
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                return Math.sqrt(variance * 252) * 100; // å¹´åŒ–æ³¢åŠ¨ç‡
            }

            async analyzeStock() {
                const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
                if (!symbol) {
                    this.showAlert('error', 'è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                    return;
                }

                this.updateStatus('loading', `æ­£åœ¨è·å– ${symbol} æ•°æ®...`);

                try {
                    const stockData = await this.fetchYahooData(symbol);
                    this.currentData = stockData;
                    
                    const indicators = this.calculateTechnicalIndicators(stockData.data);
                    
                    this.updateMetrics(stockData, indicators);
                    this.updateCharts(stockData, indicators);
                    this.updateDataTable(stockData.data);
                    
                    this.updateStatus('connected', `${symbol} æ•°æ®æ›´æ–°æˆåŠŸ`);
                    this.showAlert('success', `æˆåŠŸè·å– ${symbol} çš„ ${stockData.data.length} ä¸ªæ•°æ®ç‚¹`);
                    
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('zh-CN');
                    
                } catch (error) {
                    this.updateStatus('error', 'æ•°æ®è·å–å¤±è´¥');
                    this.showAlert('error', error.message);
                    console.error('åˆ†æé”™è¯¯:', error);
                }
            }

            updateMetrics(stockData, indicators) {
                const data = stockData.data;
                const latest = data[data.length - 1];
                const previous = data[data.length - 2];
                
                if (!latest) return;

                // å½“å‰ä»·æ ¼
                document.getElementById('currentPrice').textContent = `${latest.close.toFixed(2)}`;
                if (previous) {
                    const priceChange = ((latest.close - previous.close) / previous.close * 100);
                    const priceChangeElement = document.getElementById('priceChange');
                    priceChangeElement.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
                    priceChangeElement.className = `metric-change ${priceChange >= 0 ? 'change-positive' : 'change-negative'}`;
                }

                // VWAP
                document.getElementById('vwapValue').textContent = `${latest.vwap.toFixed(2)}`;
                const vwapDiff = ((latest.close - latest.vwap) / latest.vwap * 100);
                const vwapChangeElement = document.getElementById('vwapChange');
                vwapChangeElement.textContent = `${vwapDiff >= 0 ? '+' : ''}${vwapDiff.toFixed(2)}% vs VWAP`;
                vwapChangeElement.className = `metric-change ${vwapDiff >= 0 ? 'change-positive' : 'change-negative'}`;

                // æˆäº¤é‡
                const volumeInM = latest.volume / 1000000;
                document.getElementById('volumeValue').textContent = `${volumeInM.toFixed(1)}M`;
                if (indicators.avgVolume) {
                    const volumeChange = ((latest.volume - indicators.avgVolume) / indicators.avgVolume * 100);
                    const volumeChangeElement = document.getElementById('volumeChange');
                    volumeChangeElement.textContent = `${volumeChange >= 0 ? '+' : ''}${volumeChange.toFixed(0)}% vs å¹³å‡`;
                    volumeChangeElement.className = `metric-change ${volumeChange >= 0 ? 'change-positive' : 'change-negative'}`;
                }

                // æ³¢åŠ¨ç‡
                document.getElementById('volatilityValue').textContent = `${indicators.volatility.toFixed(1)}%`;
                document.getElementById('volatilityChange').textContent = 'å¹´åŒ–æ³¢åŠ¨ç‡';
            }

            initCharts() {
                // ä¸»å›¾è¡¨
                const mainCtx = document.getElementById('mainChart').getContext('2d');
                this.charts.main = new Chart(mainCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#3498db',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });

                // æˆäº¤é‡å›¾è¡¨
                const volumeCtx = document.getElementById('volumeChart').getContext('2d');
                this.charts.volume = new Chart(volumeCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }

            updateCharts(stockData, indicators) {
                const data = stockData.data;
                const analysisType = document.getElementById('analysisType').value;
                
                // æ›´æ–°å›¾è¡¨æ ‡é¢˜
                document.getElementById('chartTitle').textContent = `${stockData.symbol} - ${this.getAnalysisTypeTitle(analysisType)}`;
                
                // å‡†å¤‡æ ‡ç­¾
                const labels = data.map(d => {
                    const date = new Date(d.timestamp * 1000);
                    return date.toLocaleString('zh-CN', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                });

                // æ›´æ–°ä¸»å›¾è¡¨
                this.updateMainChart(data, indicators, analysisType, labels);
                
                // æ›´æ–°æˆäº¤é‡å›¾è¡¨
                this.updateVolumeChart(data, labels);
            }

            updateMainChart(data, indicators, analysisType, labels) {
                const datasets = [];
                
                switch(analysisType) {
                    case 'vwap':
                        datasets.push(
                            {
                                label: 'æ”¶ç›˜ä»·',
                                data: data.map(d => d.close),
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: 'VWAP',
                                data: data.map(d => d.vwap),
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        );
                        break;
                        
                    case 'price':
                        datasets.push(
                            {
                                label: 'æ”¶ç›˜ä»·',
                                data: data.map(d => d.close),
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        );
                        
                        if (indicators.sma20 && indicators.sma20.length > 0) {
                            datasets.push({
                                label: 'SMA 20',
                                data: [...new Array(data.length - indicators.sma20.length).fill(null), ...indicators.sma20],
                                borderColor: '#f39c12',
                                borderWidth: 1,
                                fill: false,
                                tension: 0.1
                            });
                        }
                        
                        if (indicators.sma50 && indicators.sma50.length > 0) {
                            datasets.push({
                                label: 'SMA 50',
                                data: [...new Array(data.length - indicators.sma50.length).fill(null), ...indicators.sma50],
                                borderColor: '#9b59b6',
                                borderWidth: 1,
                                fill: false,
                                tension: 0.1
                            });
                        }
                        break;
                        
                    case 'volume':
                        datasets.push({
                            label: 'æˆäº¤é‡',
                            data: data.map(d => d.volume),
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.3)',
                            borderWidth: 1,
                            fill: true
                        });
                        break;
                        
                    case 'technical':
                        datasets.push(
                            {
                                label: 'æ”¶ç›˜ä»·',
                                data: data.map(d => d.close),
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.1
                            }
                        );
                        
                        if (indicators.bollinger && indicators.bollinger.length > 0) {
                            const bollingerStart = data.length - indicators.bollinger.length;
                            datasets.push(
                                {
                                    label: 'å¸ƒæ—å¸¦ä¸Šè½¨',
                                    data: [...new Array(bollingerStart).fill(null), ...indicators.bollinger.map(b => b.upper)],
                                    borderColor: '#e74c3c',
                                    borderWidth: 1,
                                    fill: false,
                                    borderDash: [5, 5]
                                },
                                {
                                    label: 'å¸ƒæ—å¸¦ä¸­è½¨',
                                    data: [...new Array(bollingerStart).fill(null), ...indicators.bollinger.map(b => b.middle)],
                                    borderColor: '#f39c12',
                                    borderWidth: 1,
                                    fill: false
                                },
                                {
                                    label: 'å¸ƒæ—å¸¦ä¸‹è½¨',
                                    data: [...new Array(bollingerStart).fill(null), ...indicators.bollinger.map(b => b.lower)],
                                    borderColor: '#e74c3c',
                                    borderWidth: 1,
                                    fill: false,
                                    borderDash: [5, 5]
                                }
                            );
                        }
                        break;
                }

                this.charts.main.data.labels = labels;
                this.charts.main.data.datasets = datasets;
                this.charts.main.update();
            }

            updateVolumeChart(data, labels) {
                const volumeData = data.map(d => d.volume);
                const avgVolume = volumeData.reduce((a, b) => a + b, 0) / volumeData.length;
                
                this.charts.volume.data.labels = labels;
                this.charts.volume.data.datasets = [
                    {
                        label: 'æˆäº¤é‡',
                        data: volumeData,
                        backgroundColor: volumeData.map(v => v > avgVolume ? 'rgba(39, 174, 96, 0.6)' : 'rgba(52, 152, 219, 0.6)'),
                        borderColor: volumeData.map(v => v > avgVolume ? '#27ae60' : '#3498db'),
                        borderWidth: 1
                    },
                    {
                        label: 'å¹³å‡æˆäº¤é‡',
                        data: new Array(volumeData.length).fill(avgVolume),
                        type: 'line',
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }
                ];
                this.charts.volume.update();
            }

            updateDataTable(data) {
                const tbody = document.getElementById('dataTableBody');
                tbody.innerHTML = '';
                
                // æ˜¾ç¤ºæœ€è¿‘20æ¡æ•°æ®
                const recentData = data.slice(-20);
                
                recentData.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(item.timestamp * 1000).toLocaleString('zh-CN')}</td>
                        <td>${item.open.toFixed(2)}</td>
                        <td>${item.high.toFixed(2)}</td>
                        <td>${item.low.toFixed(2)}</td>
                        <td>${item.close.toFixed(2)}</td>
                        <td>${(item.volume / 1000000).toFixed(1)}M</td>
                        <td>${item.vwap.toFixed(2)}</td>
                    `;
                });
            }

            getAnalysisTypeTitle(type) {
                const titles = {
                    'vwap': 'VWAPåˆ†æ',
                    'price': 'ä»·æ ¼è¶‹åŠ¿åˆ†æ',
                    'volume': 'æˆäº¤é‡åˆ†æ',
                    'technical': 'æŠ€æœ¯æŒ‡æ ‡åˆ†æ'
                };
                return titles[type] || 'è‚¡ç¥¨åˆ†æ';
            }

            addToWatchlist() {
                const symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
                if (!symbol) {
                    this.showAlert('error', 'è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                    return;
                }

                if (this.watchlist.find(item => item.symbol === symbol)) {
                    this.showAlert('error', 'è¯¥è‚¡ç¥¨å·²åœ¨å…³æ³¨åˆ—è¡¨ä¸­');
                    return;
                }

                const watchlistItem = {
                    symbol,
                    addedAt: new Date().toISOString(),
                    price: this.currentData ? this.currentData.data[this.currentData.data.length - 1].close : 0
                };

                this.watchlist.push(watchlistItem);
                localStorage.setItem('stockWatchlist', JSON.stringify(this.watchlist));
                this.loadWatchlist();
                this.showAlert('success', `${symbol} å·²æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨`);
            }

            loadWatchlist() {
                const container = document.getElementById('watchlistContent');
                
                if (this.watchlist.length === 0) {
                    container.innerHTML = `
                        <div class="watchlist-item">
                            <div class="symbol-info">
                                <div class="symbol-name">æš‚æ— å…³æ³¨è‚¡ç¥¨</div>
                                <div class="symbol-price">è¯·æ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨</div>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.watchlist.map(item => `
                    <div class="watchlist-item">
                        <div class="symbol-info">
                            <div class="symbol-name">${item.symbol}</div>
                            <div class="symbol-price">${item.price.toFixed(2)}</div>
                        </div>
                        <div>
                            <button class="btn btn-secondary" onclick="app.analyzeWatchlistStock('${item.symbol}')" style="padding: 5px 10px; font-size: 12px;">åˆ†æ</button>
                            <button class="btn btn-secondary" onclick="app.removeFromWatchlist('${item.symbol}')" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            analyzeWatchlistStock(symbol) {
                document.getElementById('symbolInput').value = symbol;
                this.analyzeStock();
            }

            removeFromWatchlist(symbol) {
                this.watchlist = this.watchlist.filter(item => item.symbol !== symbol);
                localStorage.setItem('stockWatchlist', JSON.stringify(this.watchlist));
                this.loadWatchlist();
                this.showAlert('success', `${symbol} å·²ä»å…³æ³¨åˆ—è¡¨ä¸­ç§»é™¤`);
            }

            exportData() {
                if (!this.currentData) {
                    this.showAlert('error', 'æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                    return;
                }

                const data = this.currentData.data;
                const csvContent = [
                    'Date,Time,Open,High,Low,Close,Volume,VWAP',
                    ...data.map(item => {
                        const date = new Date(item.timestamp * 1000);
                        return [
                            date.toLocaleDateString('zh-CN'),
                            date.toLocaleTimeString('zh-CN'),
                            item.open.toFixed(2),
                            item.high.toFixed(2),
                            item.low.toFixed(2),
                            item.close.toFixed(2),
                            item.volume,
                            item.vwap.toFixed(2)
                        ].join(',');
                    })
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${this.currentData.symbol}_data_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                this.showAlert('success', 'æ•°æ®å¯¼å‡ºæˆåŠŸ');
            }

            compareStocks() {
                this.showAlert('success', 'å¯¹æ¯”åˆ†æåŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
            }
        }

        // å…¨å±€å‡½æ•°
        function toggleChartType() {
            if (window.app && window.app.charts.main) {
                const chart = window.app.charts.main;
                chart.config.type = chart.config.type === 'line' ? 'bar' : 'line';
                chart.update();
            }
        }

        function toggleFullscreen() {
            const chartContainer = document.querySelector('.chart-container');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                chartContainer.requestFullscreen();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new YahooFinanceApp();
        });
    </script>
</body>
</html>
