<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>美甲預約 Demo</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #fafafa;
            margin: 0;
            padding: 24px
        }

        .card {
            max-width: 720px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .08);
            padding: 20px
        }

        h1 {
            margin: 0 0 12px
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        label {
            font-size: 12px;
            color: #666;
            display: block;
            margin-bottom: 6px
        }

        input,
        select,
        button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px
        }

        button {
            cursor: pointer;
            border: 0;
            background: #6c5ce7;
            color: #fff
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .slot {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #e6e6e6;
            border-radius: 999px;
            margin: 6px 6px 0 0
        }

        .muted {
            color: #888
        }

        .ok {
            color: #2e7d32
        }

        .err {
            color: #d32f2f;
            white-space: pre-wrap
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #f1f5f9;
            margin-left: 6px;
            font-size: 12px
        }
    </style>
</head>

<body>
        <div class="card">
        <h1>美甲預約 Demo</h1>
        <p class="muted">測試你的 Google Apps Script Web App 端點（請使用 <code>/exec</code> 版本且開放任何人）</p>

        <div class="row">
            <div style="flex:1;min-width:260px">
                <input id="baseUrl" placeholder="貼上你的 Web App URL"
                    value="https://script.google.com/macros/s/AKfycbwSPkniXGyquWCJoQxUXrmJISz4kdwon8GHJMd8D7N_tOHNkHaZ6Tz7K7jSys_09MhO/exec" />
            </div>
            <div>
                <label>日期 (YYYY-MM-DD)</label>
                <input id="date" value="" placeholder="2025-09-12" />
            </div>
            <div style="align-self:end">
                <button id="checkBtn">查詢名額</button>
            </div>
        </div>

        <div id="slots"></div>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

        <div class="row">
            <div style="flex:1;min-width:160px">
                <label>姓名</label>
                <input id="name" placeholder="你的稱呼" />
            </div>
            <div>
                <label>時段</label>
                <select id="time">
                    <option value="10:00">10:00</option>
                    <option value="13:30">13:30</option>
                    <option value="16:00">16:00</option>
                </select>
            </div>
            <div>
                <label>按摩師傅</label>
                <select id="artist">
                    <option value="Thomas">Thomas</option>
                    <option value="Jim">Jim</option>
                    <option value="Andy">Andy</option>
                </select>
            </div>
            <div>
                <label>服務內容</label>
                <input id="service" placeholder="例如 日式手繪" />
            </div>
            <div style="align-self:end">
                <button id="bookBtn">預約</button>
            </div>
        </div>

        <div id="msg" class="muted"></div>

        <div id="diag" class="diag" style="display:none"></div>
    </div>
    <div class="card">
        <h1>美甲預約 Demo</h1>
        <p class="muted">測試你的 Google Apps Script Web App 端點</p>

        <div class="row">
            <div style="flex:1;min-width:160px">
                <label>部署 URL</label>
                <input id="baseUrl" placeholder="貼上你的 Web App URL"
                    value="https://script.google.com/macros/s/AKfycbwSPkniXGyquWCJoQxUXrmJISz4kdwon8GHJMd8D7N_tOHNkHaZ6Tz7K7jSys_09MhO/exec" />
            </div>
            <div>
                <label>日期 (YYYY-MM-DD)</label>
                <input id="date" value="2025-09-12" />
            </div>
            <div style="align-self:end">
                <button id="checkBtn">查詢名額</button>
            </div>
        </div>

        <div id="slots"></div>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

        <div class="row">
            <div style="flex:1;min-width:160px">
                <label>姓名</label>
                <input id="name" placeholder="你的稱呼" />
            </div>
            <div>
                <label>時段</label>
                <select id="time">
                    <option value="10:00">10:00</option>
                    <option value="13:30">13:30</option>
                    <option value="16:00">16:00</option>
                </select>
            </div>
            <div>
                <label>美甲師</label>
                <input id="artist" placeholder="例如 Amy" />
            </div>
            <div>
                <label>服務內容</label>
                <input id="service" placeholder="例如 日式手繪" />
            </div>
            <div style="align-self:end">
                <button id="bookBtn">預約</button>
            </div>
        </div>

        <div id="msg" class="muted"></div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);
        const el = {
            baseUrl: $('baseUrl'),
            date: $('date'),
            checkBtn: $('checkBtn'),
            slots: $('slots'),
            name: $('name'),
            time: $('time'),
            artist: $('artist'),
            service: $('service'),
            bookBtn: $('bookBtn'),
            msg: $('msg'),
            diag: $('diag'),
        };

        // 預設填今日（本地）
        (function initDate() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            if (!el.date.value) el.date.value = `${y}-${m}-${day}`;
        })();

        function setBusy(b) { el.checkBtn.disabled = el.bookBtn.disabled = !!b; }

        function showDiag(title, details) {
            el.diag.style.display = 'block';
            el.diag.innerHTML = `<strong>${title}</strong><br>${details}`;
        }

        function assertExecUrl(u) {
            if (!u) throw new Error('請先填「部署 URL」。');
            if (!/\/exec(\?|$)/.test(u)) throw new Error('URL 必須為 /exec（不是 /dev）。請到「部署→管理部署→網址」複製。');
        }

        function assertDate(s) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) throw new Error('日期格式需為 YYYY-MM-DD。');
        }

        async function safeJson(res) {
            // 嘗試以 JSON 解析；若失敗，回傳原始文字並標註
            const txt = await res.text();
            try { return { ok: true, json: JSON.parse(txt), raw: txt }; }
            catch (e) { return { ok: false, raw: txt }; }
        }

        async function fetchAvailability() {
            el.msg.textContent = '';
            el.slots.innerHTML = '';
            el.diag.style.display = 'none';

            const BASE_URL = el.baseUrl.value.trim();
            const date = el.date.value.trim();

            try {
                assertExecUrl(BASE_URL);
                assertDate(date);
            } catch (e) {
                el.msg.innerHTML = `<span class="err">${e.message}</span>`;
                return;
            }

            setBusy(true);
            try {
                const url = `${BASE_URL}?action=availability&date=${encodeURIComponent(date)}`;
                const res = await fetch(url, { method: 'GET' });

                if (!res.ok) {
                    const raw = await res.text();
                    showDiag(`HTTP 狀態：${res.status}`, `伺服器回應（前 400 字）:\n${raw.slice(0, 400)}`);
                    throw new Error(`查詢失敗（HTTP ${res.status}）。`);
                }

                const parsed = await safeJson(res);
                if (!parsed.ok) {
                    showDiag('回傳不是 JSON', `內容片段（前 400 字）:\n${parsed.raw.slice(0, 400)}\n\n通常是因為用了 /dev 或權限沒開放。`);
                    throw new Error('伺服器未回傳 JSON。');
                }

                const data = parsed.json;
                if (!data.ok) throw new Error(data.message || '查詢失敗');

                const slots = data.slots || {};
                const times = Object.keys(slots);
                if (times.length === 0) {
                    el.slots.innerHTML = '<div class="muted">此日無任何時段資料。</div>';
                    return;
                }

                // 以表格呈現：時段 × 師父
                const artists = Object.keys(slots[times[0]] || {});
                let html = '<table><thead><tr><th>時段</th>';
                artists.forEach(a => html += `<th>${a}</th>`);
                html += '</tr></thead><tbody>';
                times.forEach(t => {
                    html += `<tr><td><strong>${t}</strong></td>`;
                    artists.forEach(a => {
                        const s = slots[t][a] || '可約';
                        html += `<td>${s === '已預約' ? '<span class="err">已預約</span>' : '<span class="ok">可約</span>'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                el.slots.innerHTML = html;

            } catch (err) {
                el.msg.innerHTML = `<span class="err">查詢錯誤：${err.message}</span>`;
                console.error(err);
            } finally {
                setBusy(false);
            }
        }

        async function book() {
            el.msg.textContent = '';
            el.diag.style.display = 'none';
            const BASE_URL = el.baseUrl.value.trim();
            const payload = {
                name: el.name.value.trim(),
                date: el.date.value.trim(),
                time: el.time.value,
                artist: el.artist.value.trim(),
                service: el.service.value.trim()
            };

            try {
                assertExecUrl(BASE_URL);
                assertDate(payload.date);
                if (!payload.name || !payload.artist || !payload.service) {
                    throw new Error('請把姓名/美甲師/服務內容補齊。');
                }
            } catch (e) {
                el.msg.innerHTML = `<span class="err">${e.message}</span>`;
                return;
            }

            setBusy(true);
            try {
                const res = await fetch(`${BASE_URL}?action=book`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain; charset=utf-8' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const raw = await res.text();
                    showDiag(`HTTP 狀態：${res.status}`, `伺服器回應（前 400 字）:\n${raw.slice(0, 400)}`);
                    throw new Error(`預約失敗（HTTP ${res.status}）。`);
                }

                const parsed = await safeJson(res);
                if (!parsed.ok) {
                    showDiag('回傳不是 JSON', `內容片段（前 400 字）:\n${parsed.raw.slice(0, 400)}`);
                    throw new Error('伺服器未回傳 JSON。');
                }

                const data = parsed.json;
                if (!data.ok) throw new Error(data.message || '預約失敗');

                el.msg.innerHTML = `<span class="ok">預約成功！${data.date} ${data.time}（${data.artist}）</span>`;
                await fetchAvailability(); // 立即刷新畫面
            } catch (err) {
                el.msg.innerHTML = `<span class="err">${err.message}</span>`;
                console.error(err);
            } finally {
                setBusy(false);
            }
        }

        el.checkBtn.addEventListener('click', fetchAvailability);
        el.bookBtn.addEventListener('click', book);
    </script>

</body>

</html>
