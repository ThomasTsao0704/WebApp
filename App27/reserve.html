<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>美甲預約 Demo</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #fafafa;
            margin: 0;
            padding: 24px
        }

        .card {
            max-width: 720px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .08);
            padding: 20px
        }

        h1 {
            margin: 0 0 12px
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        label {
            font-size: 12px;
            color: #666;
            display: block;
            margin-bottom: 6px
        }

        input,
        select,
        button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px
        }

        button {
            cursor: pointer;
            border: 0;
            background: #6c5ce7;
            color: #fff
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .slot {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #e6e6e6;
            border-radius: 999px;
            margin: 6px 6px 0 0
        }

        .muted {
            color: #888
        }

        .ok {
            color: #2e7d32
        }

        .err {
            color: #d32f2f;
            white-space: pre-wrap
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #f1f5f9;
            margin-left: 6px;
            font-size: 12px
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>美甲預約 Demo</h1>
        <p class="muted">測試你的 Google Apps Script Web App 端點</p>

        <div class="row">
            <div style="flex:1;min-width:160px">
                <label>部署 URL</label>
                <input id="baseUrl" placeholder="貼上你的 Web App URL"
                    value="https://script.google.com/macros/s/AKfycbx0r3FU917y44DWYAztuXK-gRXEV97SeiRdO7cOw_KCsNGMoPY9JxqRg_2AVqWLRNHq/exec" />
            </div>
            <div>
                <label>日期 (YYYY-MM-DD)</label>
                <input id="date" value="2025-09-12" />
            </div>
            <div style="align-self:end">
                <button id="checkBtn">查詢名額</button>
            </div>
        </div>

        <div id="slots"></div>

        <hr style="margin:16px 0;border:none;border-top:1px solid #eee" />

        <div class="row">
            <div style="flex:1;min-width:160px">
                <label>姓名</label>
                <input id="name" placeholder="你的稱呼" />
            </div>
            <div>
                <label>時段</label>
                <select id="time">
                    <option value="10:00">10:00</option>
                    <option value="13:30">13:30</option>
                    <option value="16:00">16:00</option>
                </select>
            </div>
            <div>
                <label>美甲師</label>
                <input id="artist" placeholder="例如 Amy" />
            </div>
            <div>
                <label>服務內容</label>
                <input id="service" placeholder="例如 日式手繪" />
            </div>
            <div style="align-self:end">
                <button id="bookBtn">預約</button>
            </div>
        </div>

        <div id="msg" class="muted"></div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);
        const el = {
            baseUrl: $('baseUrl'),
            date: $('date'),
            checkBtn: $('checkBtn'),
            slots: $('slots'),
            name: $('name'),
            time: $('time'),
            artist: $('artist'),
            service: $('service'),
            bookBtn: $('bookBtn'),
            msg: $('msg'),
        };

        function setBusy(b) { el.checkBtn.disabled = el.bookBtn.disabled = !!b; }

        async function fetchAvailability() {
            el.msg.textContent = '';
            el.slots.innerHTML = '';
            const BASE_URL = el.baseUrl.value.trim();
            const date = el.date.value.trim();
            if (!BASE_URL || !date) { el.msg.textContent = '請先填「部署 URL」與「日期」'; return; }
            setBusy(true);
            try {
                const url = `${BASE_URL}?action=availability&date=${encodeURIComponent(date)}`;
                const res = await fetch(url); // GET 為 simple request，不觸發預檢
                const data = await res.json();
                if (!data.ok) throw new Error(data.message || '查詢失敗');
                const slots = data.slots || {};
                const wrapper = document.createElement('div');
                wrapper.className = 'grid';
                Object.entries(slots).forEach(([t, remain]) => {
                    const div = document.createElement('div');
                    div.className = 'slot';
                    div.innerHTML = `<strong>${t}</strong><span class="badge">${remain} 位</span>${remain > 0 ? '<span class="ok">可約</span>' : '<span class="muted">已滿</span>'}`;
                    wrapper.appendChild(div);
                });
                el.slots.appendChild(wrapper);
            } catch (err) {
                el.msg.innerHTML = `<span class="err">查詢錯誤：${err.message || err}</span>`;
            } finally { setBusy(false); }
        }

        async function book() {
            el.msg.textContent = '';
            const BASE_URL = el.baseUrl.value.trim();
            const payload = {
                name: el.name.value.trim(),
                date: el.date.value.trim(),
                time: el.time.value,
                artist: el.artist.value.trim(),
                service: el.service.value.trim()
            };
            if (!BASE_URL || !payload.name || !payload.date || !payload.time || !payload.artist || !payload.service) {
                el.msg.textContent = '請把姓名/日期/時段/美甲師/服務內容補齊';
                return;
            }
            setBusy(true);
            try {
                const res = await fetch(`${BASE_URL}?action=book`, {
                    method: 'POST',
                    // 關鍵：text/plain 避免預檢（CORS preflight）
                    headers: { 'Content-Type': 'text/plain; charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.message || '預約失敗');
                el.msg.innerHTML = `<span class="ok">預約成功！${data.date} ${data.time}；時段剩餘：${data.remain}</span>`;
                // 同步刷新名額
                await fetchAvailability();
            } catch (err) {
                el.msg.innerHTML = `<span class="err">預約錯誤：${err.message || err}</span>`;
            } finally { setBusy(false); }
        }

        el.checkBtn.addEventListener('click', fetchAvailability);
        el.bookBtn.addEventListener('click', book);

        // 預設進來就查一次（可關）
        // fetchAvailability();
    </script>
    <script>
        const BASE_URL = "https://script.google.com/macros/s/你的部署ID/exec";

        // GET 列表：查某日（可選某位美甲師）的預約
        async function listAppointments(date, artist) {
            const qs = new URLSearchParams({ action: "list", date });
            if (artist) qs.set("artist", artist);
            const res = await fetch(`${BASE_URL}?${qs.toString()}`);
            const data = await res.json();
            if (!data.ok) throw new Error(data.message || "list 失敗");
            return data; // { ok, date, artist|null, count, appointments:[...] }
        }

        // POST 預約：用 text/plain 送 JSON 字串 → 避免 CORS 預檢
        async function book({ name, date, time, artist, service }) {
            const res = await fetch(`${BASE_URL}?action=book`, {
                method: "POST",
                headers: { "Content-Type": "text/plain; charset=utf-8" },
                body: JSON.stringify({ name, date, time, artist, service })
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.message || data.code || "book 失敗");
            return data; // { ok:true, appointment:{...} }
        }

        // Demo（你可刪）
        (async () => {
            try {
                console.log("→ 試著新增一筆預約");
                const booked = await book({
                    name: "Lily",
                    date: "2025-09-12",
                    time: "13:30",
                    artist: "Amy",
                    service: "日式手繪"
                });
                console.log("book:", booked);

                console.log("→ 查詢當日所有預約");
                const list = await listAppointments("2025-09-12");
                console.log("list:", list);
            } catch (e) {
                console.error(e);
            }
        })();
    </script>

</body>

</html>