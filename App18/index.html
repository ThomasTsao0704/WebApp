<!doctype html>

<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æ¡è³¼è³‡æ–™åº« Â· PWAï¼ˆç®¡ç†åˆ†é ç‰ˆ + æ¡è³¼è»Šï¼‰</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <style>
    :root{--radius:12px;--border:#e5e7eb;--muted:#6b7280;--bg:#fafafa;--primary:#111}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    h1{font-size:1.25rem;margin:8px 0 6px}
    .sub{color:var(--muted);margin:0 0 12px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px;align-items:center}
    .tab{padding:10px 14px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button{padding:10px;border:1px solid var(--border);border-radius:10px}
    input{flex:1;min-width:120px}
    button{cursor:pointer;background:var(--primary);color:#fff}
    button.secondary{background:#fff;color:#111}
    button.ghost{background:transparent;color:#111;border-color:transparent}
    button[disabled]{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    tr:hover{background:#f7f7f7}
    .actions button{padding:6px 10px;font-size:.9rem}
    .muted{color:var(--muted);font-size:.92rem}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.85rem;color:#333;background:#fafafa}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fff}
    .badge.readonly{background:#fff}
    .badge.admin{background:#eefbf1;border-color:#b7ebc6}
    .hidden{display:none !important}
    dialog{border:none;border-radius:16px;padding:0;width:min(90vw,420px)}
    .dlg{padding:18px}
    .dlg h3{margin:0 0 10px}
    .dlg .row{margin-top:8px}
    .dlg footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .overlay::backdrop{background:rgba(0,0,0,.4)}
    /* æ¡è³¼åˆ†é ï¼šå·¦å³æ¬„ */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1.3fr .9fr} }
    .num{width:96px;text-align:right}
    .qty{width:84px;text-align:right}
    .tot{font-weight:600}
    .no-wrap{white-space:nowrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>æ¡è³¼è³‡æ–™åº«</h1>
  <p class="sub">PWA å–®æ©Ÿå¯å®‰è£ç‰ˆã€‚æœªç™»å…¥ï¼å”¯è®€ï¼›ç™»å…¥å¾Œå¯ç·¨è¼¯èˆ‡ä½¿ç”¨ç®¡ç†åˆ†é ã€‚é è¨­ PINï¼š<span class="tag">0000</span>ã€‚</p>  <div class="tabs">
    <button class="tab" data-tab="data">ğŸ“„ è³‡æ–™</button>
    <button class="tab" data-tab="cart">ğŸ§º æ¡è³¼</button>
    <button class="tab hidden" data-tab="admin" id="adminTab">ğŸ›  ç®¡ç†</button>
    <span class="right"></span>
    <span id="modeBadge" class="badge readonly">ğŸ”’ å”¯è®€æ¨¡å¼</span>
    <button id="loginBtn" class="secondary">ç®¡ç†è€…ç™»å…¥</button>
    <button id="logoutBtn" class="secondary hidden">ç™»å‡º</button>
  </div>  <!-- è³‡æ–™åˆ†é  -->  <section id="page-data">
    <div class="card">
      <div class="toolbar">
        <input id="q" type="search" placeholder="æœå°‹ï¼šç·¨è™Ÿ / å“é … / å» å•†â€¦"/>
        <button id="exportBtn">åŒ¯å‡º CSV</button>
      </div>
      <p class="muted" style="margin-top:8px">è³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼ˆé›¢ç·šå¯ç”¨ï¼‰ã€‚å¦‚éœ€å¤šäººå…±ç”¨ï¼Œå¾ŒçºŒå¯åšé›²ç«¯ç‰ˆã€‚</p>
    </div><div class="card">
  <div class="row" style="margin-bottom:8px">
    <input id="id" placeholder="ç·¨è™Ÿï¼ˆå¦‚ PR-20250828-001ï¼‰" />
    <input id="item" placeholder="å“é …ï¼ˆå‹è™Ÿ/è¦æ ¼ï¼‰" />
    <input id="unit" placeholder="å–®ä½ï¼ˆå€‹/åŒ…/ç®±â€¦ï¼‰" />
    <input id="price" placeholder="åƒ¹éŒ¢ï¼ˆæ•¸å­—ï¼‰" inputmode="decimal"/>
    <input id="vendor" placeholder="å» å•†" />
  </div>
  <div class="row">
    <button id="addBtn" disabled>æ–°å¢ / æ›´æ–°</button>
    <span class="muted">æç¤ºï¼šç›¸åŒã€Œç·¨è™Ÿã€æœƒè¦–ç‚ºæ›´æ–°åŒä¸€ç­†ã€‚</span>
  </div>
</div>

<div class="card">
  <table id="tbl">
    <thead>
      <tr><th>ç·¨è™Ÿ</th><th>å“é …</th><th>å–®ä½</th><th>åƒ¹éŒ¢</th><th>å» å•†</th><th>å‹•ä½œ</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="count" class="muted" style="margin-top:8px"></div>
</div>

  </section>  <!-- æ¡è³¼åˆ†é ï¼ˆè³¼ç‰©è»Šï¼‰ -->  <section id="page-cart" class="hidden">
    <div class="grid">
      <!-- å·¦ï¼šå¯æŒ‘é¸æ¸…å–® -->
      <div>
        <div class="card">
          <div class="toolbar">
            <input id="cartSearch" type="search" placeholder="æœå°‹å¯åŠ å…¥çš„å“é …ï¼ˆç·¨è™Ÿ / å“é … / å» å•†ï¼‰"/>
            <span class="muted">å¾è³‡æ–™åº«åŠ å…¥è‡³å³å´è³¼ç‰©è»Š</span>
          </div>
        </div>
        <div class="card">
          <table id="pickTbl">
            <thead>
              <tr><th>ç·¨è™Ÿ</th><th>å“é …</th><th class="no-wrap">å–®åƒ¹</th><th>å» å•†</th><th>åŠ å…¥</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="pickCount" class="muted" style="margin-top:8px"></div>
        </div>
      </div><!-- å³ï¼šè³¼ç‰©è»Š -->
  <div>
    <div class="card">
      <div class="toolbar">
        <strong>ğŸ§º è³¼ç‰©è»Š</strong>
        <span id="cartBadge" class="badge">0 é …</span>
        <span class="right"></span>
        <button class="secondary" id="cartClearBtn">æ¸…ç©º</button>
        <button id="copyBtn">è¤‡è£½æ¸…å–®</button>
      </div>
      <p class="muted" style="margin-top:8px">æ¸…å–®æ ¼å¼ï¼šå“é … Ã— æ•¸é‡ ï¼ å°è¨ˆï¼›æœ€å¾Œé¡¯ç¤ºåˆè¨ˆï¼Œå·²è‡ªå‹•åŠ å…¥åƒåˆ†ä½ã€‚</p>
    </div>
    <div class="card">
      <table id="cartTbl">
        <thead>
          <tr><th>å“é …</th><th class="no-wrap">å–®åƒ¹</th><th class="no-wrap">æ•¸é‡</th><th class="no-wrap">å°è¨ˆ</th><th>å‹•ä½œ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <div class="tag" id="totalTag">åˆè¨ˆï¼š0</div>
      </div>
    </div>
  </div>
</div>

  </section>  <!-- ç®¡ç†åˆ†é ï¼ˆæœªç™»å…¥å®Œå…¨éš±è—ï¼‰ -->  <section id="page-admin" class="hidden">
    <div class="card">
      <h3>ğŸ›¡ ç®¡ç†åŠŸèƒ½</h3>
      <div class="toolbar" style="margin-top:8px">
        <input id="csvFile" type="file" accept=".csv" />
        <button class="secondary" id="importBtn" disabled>å¾ CSV åŒ¯å…¥</button>
        <button class="secondary" id="clearBtn" title="æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™ï¼ˆè«‹è¬¹æ…ï¼‰" disabled>æ¸…ç©ºè³‡æ–™</button>
        <span class="right"></span>
        <button class="secondary" id="setPinBtn" disabled>è¨­å®šç®¡ç†è€… PIN</button>
      </div>
      <p class="muted" style="margin-top:8px">ç®¡ç†åˆ†é åªåœ¨ç®¡ç†è€…æ¨¡å¼ä¸­é¡¯ç¤ºï¼›æœªç™»å…¥çœ‹ä¸åˆ°æ­¤åˆ†é ã€‚</p>
    </div>
  </section>
</div><!-- ç™»å…¥å°è©±æ¡† --><dialog id="dlgLogin" class="overlay">
  <div class="dlg">
    <h3>ç®¡ç†è€…ç™»å…¥</h3>
    <p class="muted">æœ¬æ©Ÿè¼•é‡ä¿è­·ï¼›è«‹å‹¿ä½¿ç”¨å…¶ä»–æœå‹™ç›¸åŒå¯†ç¢¼ã€‚</p>
    <div class="row">
      <input id="pinInput" type="password" placeholder="è¼¸å…¥ PINï¼ˆé è¨­ 0000ï¼‰" autofocus />
    </div>
    <footer>
      <button class="secondary" id="cancelLogin">å–æ¶ˆ</button>
      <button id="confirmLogin">ç™»å…¥</button>
    </footer>
  </div>
</dialog><!-- è¨­å®š PIN å°è©±æ¡† --><dialog id="dlgSetPin" class="overlay">
  <div class="dlg">
    <h3>è¨­å®šç®¡ç†è€… PIN</h3>
    <p class="muted">åƒ…æœ¬æ©Ÿå„²å­˜ï¼›è«‹è¨˜å¥½ä½ çš„ PINã€‚</p>
    <div class="row">
      <input id="newPin1" type="password" placeholder="æ–°çš„ PINï¼ˆ4~12ä½ï¼‰" />
      <input id="newPin2" type="password" placeholder="å†è¼¸å…¥ä¸€æ¬¡" />
    </div>
    <footer>
      <button class="secondary" id="cancelSetPin">å–æ¶ˆ</button>
      <button id="confirmSetPin">è¨­å®š</button>
    </footer>
  </div>
</dialog><script>
// ---- PWA: register SW ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* ===== è³‡æ–™å±¤ ===== */
const KEY = 'procure-db-v1';
const PIN_KEY = 'procure-admin-pin';
const DEFAULT_PIN = '0000';
const CART_KEY = 'procure-cart-v1';

const $ = sel => document.querySelector(sel);
const q = $('#q'), id = $('#id'), item = $('#item'), unit = $('#unit'), price = $('#price'), vendor = $('#vendor');
const tbody = $('#tbl tbody'), count = $('#count');

const cartSearch = $('#cartSearch');
const pickTbody = $('#pickTbl tbody'), pickCount = $('#pickCount');
const cartTbody = $('#cartTbl tbody');
const totalTag = $('#totalTag');
const cartBadge = $('#cartBadge');

const loginBtn = $('#loginBtn'), logoutBtn = $('#logoutBtn'), setPinBtn = $('#setPinBtn');
const importBtn = $('#importBtn'), exportBtn = $('#exportBtn'), clearBtn = $('#clearBtn'), addBtn = $('#addBtn'), csvFile = $('#csvFile');
const modeBadge = $('#modeBadge');
const adminTabBtn = document.querySelector('.tab[data-tab="admin"]');
const tabs = document.querySelectorAll('.tab');
const pageData = $('#page-data'), pageAdmin = $('#page-admin'), pageCart = $('#page-cart');

const dlgLogin = $('#dlgLogin'), pinInput = $('#pinInput'), cancelLogin = $('#cancelLogin'), confirmLogin = $('#confirmLogin');
const dlgSetPin = $('#dlgSetPin'), newPin1 = $('#newPin1'), newPin2 = $('#newPin2'), cancelSetPin = $('#cancelSetPin'), confirmSetPin = $('#confirmSetPin');

const cartClearBtn = $('#cartClearBtn');
const copyBtn = $('#copyBtn');

const fmtMoney = n => {
  if (n === '' || n === null || n === undefined || isNaN(n)) return '';
  const v = Number(n);
  return v.toLocaleString('en-US', { maximumFractionDigits: 2 });
};
function load(){ try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
function save(rows){ localStorage.setItem(KEY, JSON.stringify(rows)); }
function getPin(){ return localStorage.getItem(PIN_KEY) || DEFAULT_PIN; }
function isAdmin(){ return sessionStorage.getItem('admin') === '1'; }
function setAdmin(on){ on ? sessionStorage.setItem('admin','1') : sessionStorage.removeItem('admin'); }

// Cart å­˜å–ï¼ˆä½¿ç”¨ sessionStorageï¼Œé—œé–‰é ç±¤å³æ¸…ç©ºï¼›å¦‚è¦ä¿ç•™å¯æ”¹ localStorageï¼‰
function loadCart(){ try { return JSON.parse(sessionStorage.getItem(CART_KEY) || '[]'); } catch { return []; } }
function saveCart(rows){ sessionStorage.setItem(CART_KEY, JSON.stringify(rows)); }

/* ===== CRUD ===== */
function upsertRow(r){
  const rows = load();
  const i = rows.findIndex(x => x.ç·¨è™Ÿ === r.ç·¨è™Ÿ);
  if (i>=0) rows[i] = r; else rows.push(r);
  save(rows); render(); renderPick(); // è³‡æ–™æ›´æ–°æ™‚ï¼ŒåŒæ­¥å·¦å´å¯æŒ‘é¸æ¸…å–®
}
function delRow(ç·¨è™Ÿ){
  const rows = load().filter(x => x.ç·¨è™Ÿ !== ç·¨è™Ÿ);
  save(rows); render(); renderPick();
}
function fillForm(r){
  id.value = r.ç·¨è™Ÿ; item.value = r.å“é …; unit.value = r.å–®ä½; price.value = r.åƒ¹éŒ¢; vendor.value = r.å» å•†;
  id.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ===== Tabs + Hash ===== */
function showTab(name){
  tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  pageData.classList.toggle('hidden', name !== 'data');
  pageAdmin.classList.toggle('hidden', name !== 'admin');
  pageCart.classList.toggle('hidden', name !== 'cart');
  if(name === 'admin' && !isAdmin()){
    location.hash = '#data';
    showTab('data');
    return;
  }
  location.hash = '#' + name;
}
function initFromHash(){
  const h = (location.hash || '#data').replace('#','');
  const target = (h === 'admin' && !isAdmin()) ? 'data' : (['data','admin','cart'].includes(h) ? h : 'data');
  showTab(target);
}

/* ===== UI & æ¬Šé™ ===== */
function applyModeUI(){
  const admin = isAdmin();
  addBtn.disabled = !admin;
  importBtn.disabled = !admin;
  clearBtn.disabled = !admin;
  setPinBtn.disabled = !admin;

  loginBtn.classList.toggle('hidden', admin);
  logoutBtn.classList.toggle('hidden', !admin);
  modeBadge.textContent = admin ? 'âœ… ç®¡ç†è€…æ¨¡å¼' : 'ğŸ”’ å”¯è®€æ¨¡å¼';
  modeBadge.classList.toggle('admin', admin);
  modeBadge.classList.toggle('readonly', !admin);

  // ç®¡ç†åˆ†é  tab é¡¯ç¤º/éš±è—
  adminTabBtn.classList.toggle('hidden', !admin);
  if(!admin && location.hash === '#admin'){ showTab('data'); }
  render();
  renderPick();
  renderCart();
}

function render(){
  const query = (q.value || '').trim().toLowerCase();
  const rows = load().sort((a,b)=> a.ç·¨è™Ÿ.localeCompare(b.ç·¨è™Ÿ));
  const filtered = rows.filter(r => {
    const blob = `${r.ç·¨è™Ÿ} ${r.å“é …} ${r.å» å•†}`.toLowerCase();
    return blob.includes(query);
  });
  const admin = isAdmin();
  tbody.innerHTML = filtered.map(r => `
    <tr>
      <td>${r.ç·¨è™Ÿ}</td>
      <td>${r.å“é …}</td>
      <td>${r.å–®ä½}</td>
      <td>${fmtMoney(r.åƒ¹éŒ¢)}</td>
      <td>${r.å» å•†}</td>
      <td class="actions">
        ${admin ? `
          <button class="secondary" data-act="edit" data-row='${encodeURIComponent(JSON.stringify(r))}'>ç·¨è¼¯</button>
          <button data-act="del" data-id="${r.ç·¨è™Ÿ.replace(/"/g,'&quot;')}">åˆªé™¤</button>
        ` : `<span class="muted">å”¯è®€</span>`}
      </td>
    </tr>
  `).join('');
  count.textContent = `å…± ${filtered.length} / ${rows.length} ç­†`;
}

// æ¡è³¼åˆ†é ï¼šå·¦å´å¯æŒ‘é¸æ¸…å–®
function renderPick(){
  const query = (cartSearch.value || '').trim().toLowerCase();
  const rows = load().sort((a,b)=> a.ç·¨è™Ÿ.localeCompare(b.ç·¨è™Ÿ));
  const filtered = rows.filter(r => `${r.ç·¨è™Ÿ} ${r.å“é …} ${r.å» å•†}`.toLowerCase().includes(query));
  pickTbody.innerHTML = filtered.map(r => `
    <tr>
      <td>${r.ç·¨è™Ÿ}</td>
      <td>${r.å“é …}</td>
      <td class="no-wrap">${fmtMoney(r.åƒ¹éŒ¢)}</td>
      <td>${r.å» å•†}</td>
      <td><button data-act="addcart" data-id="${r.ç·¨è™Ÿ.replace(/"/g,'&quot;')}">åŠ å…¥</button></td>
    </tr>
  `).join('');
  pickCount.textContent = `å¯æŒ‘é¸ï¼š${filtered.length} / ${rows.length} ç­†`;
}

// Cart æ“ä½œ
function addToCart(row){
  const cart = loadCart();
  const i = cart.findIndex(x => x.ç·¨è™Ÿ === row.ç·¨è™Ÿ);
  if(i>=0){ cart[i].æ•¸é‡ += 1; }
  else{
    cart.push({ ç·¨è™Ÿ: row.ç·¨è™Ÿ, å“é …: row.å“é …, å–®åƒ¹: Number(row.åƒ¹éŒ¢)||0, å» å•†: row.å» å•†, æ•¸é‡: 1 });
  }
  saveCart(cart); renderCart();
}
function setQty(id, qty){
  const cart = loadCart();
  const i = cart.findIndex(x => x.ç·¨è™Ÿ === id);
  if(i>=0){ cart[i].æ•¸é‡ = Math.max(0, Math.floor(qty||0)); }
  const cleaned = cart.filter(x => x.æ•¸é‡>0);
  saveCart(cleaned); renderCart();
}
function removeFromCart(id){
  const cart = loadCart().filter(x => x.ç·¨è™Ÿ !== id);
  saveCart(cart); renderCart();
}
function clearCart(){ saveCart([]); renderCart(); }

function renderCart(){
  const cart = loadCart();
  cartBadge.textContent = `${cart.length} é …`;
  cartTbody.innerHTML = cart.map(r => {
    const sub = r.å–®åƒ¹ * r.æ•¸é‡;
    return `
      <tr>
        <td>${r.å“é …}</td>
        <td class="no-wrap">${fmtMoney(r.å–®åƒ¹)}</td>
        <td class="no-wrap">
          <input class="qty" type="number" min="0" step="1" value="${r.æ•¸é‡}" data-cart-qty="${r.ç·¨è™Ÿ.replace(/"/g,'&quot;')}">
        </td>
        <td class="no-wrap tot">${fmtMoney(sub)}</td>
        <td><button class="secondary" data-act="rmcart" data-id="${r.ç·¨è™Ÿ.replace(/"/g,'&quot;')}">ç§»é™¤</button></td>
      </tr>`;
  }).join('');
  const total = cart.reduce((s,r)=> s + r.å–®åƒ¹*r.æ•¸é‡, 0);
  totalTag.textContent = `åˆè¨ˆï¼š${fmtMoney(total)}`;
}

function copySummary(){
  const cart = loadCart();
  if(cart.length===0){ alert('è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„'); return; }
  const lines = cart.map(r => `${r.å“é …} Ã— ${r.æ•¸é‡} ï¼ ${fmtMoney(r.å–®åƒ¹*r.æ•¸é‡)}`);
  const total = cart.reduce((s,r)=> s + r.å–®åƒ¹*r.æ•¸é‡, 0);
  const txt = lines.join('\n') + `\nâ€”â€”\nåˆè¨ˆï¼š${fmtMoney(total)}`;
  navigator.clipboard.writeText(txt).then(()=>{
    alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼åˆ° LINE');
  }).catch(()=>{
    // éƒ¨åˆ†ç€è¦½å™¨éœ€ä»¥é¸å–æ–¹å¼è¤‡è£½
    const ta = document.createElement('textarea');
    ta.value = txt; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼åˆ° LINE'); } finally { document.body.removeChild(ta); }
  });
}

/* ===== äº‹ä»¶ ===== */
// é€šç”¨ click ä»£ç†
document.addEventListener('click', (ev)=>{
  const t = ev.target;
  if(t.dataset.act === 'edit'){
    if(!isAdmin()){ alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥'); return; }
    const r = JSON.parse(decodeURIComponent(t.dataset.row)); fillForm(r);
  }
  if(t.dataset.act === 'del'){
    if(!isAdmin()){ alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥'); return; }
    const id = t.dataset.id;
    if(confirm(`åˆªé™¤ã€Œ${id}ã€ï¼Ÿ`)) delRow(id);
  }
  if(t.dataset.act === 'addcart'){
    const id = t.dataset.id;
    const row = load().find(x=>x.ç·¨è™Ÿ===id);
    if(row) addToCart(row);
  }
  if(t.dataset.act === 'rmcart'){
    removeFromCart(t.dataset.id);
  }
});

// è³¼ç‰©è»Šæ•¸é‡è®Šæ›´ï¼ˆinput äº‹ä»¶ä»£ç†ï¼‰
document.addEventListener('input', (ev)=>{
  const el = ev.target;
  if(el.matches('input[data-cart-qty]')){
    const id = el.getAttribute('data-cart-qty');
    setQty(id, Number(el.value));
  }
});

// Tabs
Array.from(tabs).forEach(t => t.addEventListener('click', ()=> showTab(t.dataset.tab)));
q.oninput = render;
cartSearch.oninput = renderPick;

// åŒ¯å‡º CSVï¼ˆè³‡æ–™åˆ†é ï¼‰
exportBtn.onclick = () => {
  const rows = load();
  const headers = ['ç·¨è™Ÿ','å“é …','å–®ä½','åƒ¹éŒ¢','å» å•†'];
  const csv = [headers.join(',')].concat(
    rows.map(r => headers.map(h => {
      const v = r[h] ?? '';
      const s = String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(','))
  ).join('\n');
  const blob = new Blob([`\ufeff${csv}`], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'æ¡è³¼è³‡æ–™åº«.csv';
  a.click();
};

// æ–°å¢ / æ›´æ–°ï¼ˆè³‡æ–™åˆ†é ï¼‰
addBtn.onclick = () => {
  if(!isAdmin()){ alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥'); return; }
  const r = {
    ç·¨è™Ÿ: id.value.trim(),
    å“é …: item.value.trim(),
    å–®ä½: unit.value.trim(),
    åƒ¹éŒ¢: price.value.trim()===''? '' : Number(String(price.value).replace(/,/g,'')),
    å» å•†: vendor.value.trim()
  };
  if(!r.ç·¨è™Ÿ || !r.å“é … || !r.å–®ä½ || r.åƒ¹éŒ¢==='' || isNaN(r.åƒ¹éŒ¢) || !r.å» å•†){
    alert('è«‹å®Œæ•´å¡«å¯«ï¼šç·¨è™Ÿã€å“é …ã€å–®ä½ã€åƒ¹éŒ¢ï¼ˆæ•¸å­—ï¼‰ã€å» å•†'); return;
  }
  upsertRow(r);
  item.value = unit.value = price.value = vendor.value = '';
};

// ç®¡ç†åˆ†é ï¼šæ¸…ç©ºã€åŒ¯å…¥
clearBtn.onclick = () => {
  if(!isAdmin()){ alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥'); return; }
  if (confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) { localStorage.setItem(KEY,'[]'); render(); renderPick(); }
};

importBtn.onclick = async () => {
  if(!isAdmin()){ alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥'); return; }
  const file = csvFile.files?.[0];
  if(!file){ alert('è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆ'); return; }
  const text = await file.text();
  const lines = text.replace(/^\uFEFF/,'').split(/\r?\n/).filter(x=>x.trim()!=='');
  const header = lines.shift().split(',');
  const idx = {
    ç·¨è™Ÿ: header.indexOf('ç·¨è™Ÿ'),
    å“é …: header.indexOf('å“é …'),
    å–®ä½: header.indexOf('å–®ä½'),
    åƒ¹éŒ¢: header.indexOf('åƒ¹éŒ¢'),
    å» å•†: header.indexOf('å» å•†')
  };
  if(Object.values(idx).some(v => v===-1)){ alert('CSV æ¨™é ­éœ€åŒ…å«ï¼šç·¨è™Ÿ,å“é …,å–®ä½,åƒ¹éŒ¢,å» å•†'); return; }
  const rows = lines.map(line => {
    const cols = []; let cur = ''; let inQ = false;
    for(const ch of line){
      if(ch === '"'){ inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ cols.push(cur); cur=''; } else cur += ch;
    }
    cols.push(cur);
    const priceRaw = (cols[idx.åƒ¹éŒ¢] || '').replace(/,/g,'');
    return {
      ç·¨è™Ÿ: cols[idx.ç·¨è™Ÿ] || '',
      å“é …: cols[idx.å“é …] || '',
      å–®ä½: cols[idx.å–®ä½] || '',
      åƒ¹éŒ¢: priceRaw===''? '' : Number(priceRaw),
      å» å•†: cols[idx.å» å•†] || ''
    };
  }).filter(r => r.ç·¨è™Ÿ && r.å“é … && r.å–®ä½ && r.å» å•† && r.åƒ¹éŒ¢!=='' && !isNaN(r.åƒ¹éŒ¢));
  const existing = load();
  const map = new Map(existing.map(r=>[r.ç·¨è™Ÿ,r]));
  for(const r of rows) map.set(r.ç·¨è™Ÿ,r);
  localStorage.setItem(KEY, JSON.stringify(Array.from(map.values())));
  render(); renderPick();
  alert(`åŒ¯å…¥å®Œæˆï¼š${rows.length} ç­†ï¼ˆåŒç·¨è™Ÿè¦†è“‹ï¼‰ã€‚`);
};

/* ===== ç™»å…¥æµç¨‹ ===== */
loginBtn.onclick = () => { pinInput.value=''; dlgLogin.showModal(); setTimeout(()=>pinInput.focus(), 50); };
cancelLogin.onclick = () => dlgLogin.close();
confirmLogin.onclick = () => {
  const ok = pinInput.value === getPin();
  if(!ok){ alert('PIN ä¸æ­£ç¢º'); return; }
  setAdmin(true); dlgLogin.close(); applyModeUI(); showTab('admin');
};
logoutBtn.onclick = () => { setAdmin(false); applyModeUI(); showTab('data'); };

setPinBtn.onclick = () => { newPin1.value=''; newPin2.value=''; dlgSetPin.showModal(); setTimeout(()=>newPin1.focus(),50); };
cancelSetPin.onclick = () => dlgSetPin.close();
confirmSetPin.onclick = () => {
  const p1 = newPin1.value.trim(), p2 = newPin2.value.trim();
  if(p1.length < 4 || p1.length > 12){ alert('PIN é•·åº¦éœ€ 4~12 ä½'); return; }
  if(p1 !== p2){ alert('å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´'); return; }
  localStorage.setItem(PIN_KEY, p1);
  dlgSetPin.close();
  alert('PIN å·²æ›´æ–°');
};

/* ===== é¦–æ¬¡å•Ÿå‹•ç¤ºä¾‹è³‡æ–™ ===== */
if(!localStorage.getItem(KEY)){
  localStorage.setItem(KEY, JSON.stringify([
    {"ç·¨è™Ÿ":"PR-20250828-001","å“é …":"A4 å½±å°ç´™ 80gsm","å–®ä½":"ç®±(5åŒ…)","åƒ¹éŒ¢":850,"å» å•†":"æ–‡æ–‡æ–‡å…·è¡Œ"},
    {"ç·¨è™Ÿ":"PR-20250828-002","å“é …":"é»‘è‰²ç¢³ç²‰åŒ£ TN-2380","å–®ä½":"å€‹","åƒ¹éŒ¢":1350,"å» å•†":"å®æ˜Œè€—æ"},
    {"ç·¨è™Ÿ":"PR-20250828-003","å“é …":"75å‹é¡¯ç¤ºå™¨æ”¯æ¶","å–®ä½":"åº§","åƒ¹éŒ¢":4200,"å» å•†":"å±•ç‘äº”é‡‘"},
    {"ç·¨è™Ÿ":"PR-20250828-004","å“é …":"å’–å•¡è±† ä¸­ç„™ 1kg","å–®ä½":"åŒ…","åƒ¹éŒ¢":520,"å» å•†":"å±±ä¸˜å’–å•¡"},
    {"ç·¨è™Ÿ":"PR-20250828-005","å“é …":"RJ45 ç¶²è·¯ç·š Cat6 3m","å–®ä½":"æ¢","åƒ¹éŒ¢":69,"å» å•†":"æ·è¨Šç§‘æŠ€"}
  ]));
}

/* ===== åˆå§‹åŒ– ===== */
function init(){
  applyModeUI();
  initFromHash();
  window.addEventListener('hashchange', initFromHash);
  copyBtn.addEventListener('click', copySummary);
  cartClearBtn.addEventListener('click', clearCart);
}
init();
</script></body>
</html>
