<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>採購資料庫 · PWA（管理分頁版）</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <style>
    :root{--radius:12px;--border:#e5e7eb;--muted:#6b7280;--bg:#fafafa;--primary:#111}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    h1{font-size:1.25rem;margin:8px 0 6px}
    .sub{color:var(--muted);margin:0 0 12px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px}
    .tab{padding:10px 14px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button{padding:10px;border:1px solid var(--border);border-radius:10px}
    input{flex:1;min-width:120px}
    button{cursor:pointer;background:var(--primary);color:#fff}
    button.secondary{background:#fff;color:#111}
    button.ghost{background:transparent;color:#111;border-color:transparent}
    button[disabled]{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    tr:hover{background:#f7f7f7}
    .actions button{padding:6px 10px;font-size:.9rem}
    .muted{color:var(--muted);font-size:.92rem}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.85rem;color:#333;background:#fafafa}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fff}
    .badge.readonly{background:#fff}
    .badge.admin{background:#eefbf1;border-color:#b7ebc6}
    .hidden{display:none !important}
    dialog{border:none;border-radius:16px;padding:0;width:min(90vw,420px)}
    .dlg{padding:18px}
    .dlg h3{margin:0 0 10px}
    .dlg .row{margin-top:8px}
    .dlg footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .overlay::backdrop{background:rgba(0,0,0,.4)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>採購資料庫</h1>
  <p class="sub">PWA 單機可安裝版。未登入＝唯讀；登入後可編輯與使用管理分頁。預設 PIN：<span class="tag">0000</span>。</p>

  <div class="tabs">
    <button class="tab" data-tab="data">📄 資料</button>
    <button class="tab hidden" data-tab="admin" id="adminTab">🛠 管理</button>
    <span class="right"></span>
    <span id="modeBadge" class="badge readonly">🔒 唯讀模式</span>
    <button id="loginBtn" class="secondary">管理者登入</button>
    <button id="logoutBtn" class="secondary hidden">登出</button>
  </div>

  <!-- 資料分頁 -->
  <section id="page-data">
    <div class="card">
      <div class="toolbar">
        <input id="q" type="search" placeholder="搜尋：編號 / 品項 / 廠商…"/>
        <button id="exportBtn">匯出 CSV</button>
      </div>
      <p class="muted" style="margin-top:8px">資料儲存在本機瀏覽器（離線可用）。如需多人共用，後續可做雲端版。</p>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <input id="id" placeholder="編號（如 PR-20250828-001）" />
        <input id="item" placeholder="品項（型號/規格）" />
        <input id="unit" placeholder="單位（個/包/箱…）" />
        <input id="price" placeholder="價錢（數字）" inputmode="decimal"/>
        <input id="vendor" placeholder="廠商" />
      </div>
      <div class="row">
        <button id="addBtn" disabled>新增 / 更新</button>
        <span class="muted">提示：相同「編號」會視為更新同一筆。</span>
      </div>
    </div>

    <div class="card">
      <table id="tbl">
        <thead>
          <tr><th>編號</th><th>品項</th><th>單位</th><th>價錢</th><th>廠商</th><th>動作</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="count" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- 管理分頁（未登入完全隱藏） -->
  <section id="page-admin" class="hidden">
    <div class="card">
      <h3>🛡 管理功能</h3>
      <div class="toolbar" style="margin-top:8px">
        <input id="csvFile" type="file" accept=".csv" />
        <button class="secondary" id="importBtn" disabled>從 CSV 匯入</button>
        <button class="secondary" id="clearBtn" title="清空本機資料（請謹慎）" disabled>清空資料</button>
        <span class="right"></span>
        <button class="secondary" id="setPinBtn" disabled>設定管理者 PIN</button>
      </div>
      <p class="muted" style="margin-top:8px">管理分頁只在管理者模式中顯示；未登入看不到此分頁。</p>
    </div>
  </section>
</div>

<!-- 登入對話框 -->
<dialog id="dlgLogin" class="overlay">
  <div class="dlg">
    <h3>管理者登入</h3>
    <p class="muted">本機輕量保護；請勿使用其他服務相同密碼。</p>
    <div class="row">
      <input id="pinInput" type="password" placeholder="輸入 PIN（預設 0000）" autofocus />
    </div>
    <footer>
      <button class="secondary" id="cancelLogin">取消</button>
      <button id="confirmLogin">登入</button>
    </footer>
  </div>
</dialog>

<!-- 設定 PIN 對話框 -->
<dialog id="dlgSetPin" class="overlay">
  <div class="dlg">
    <h3>設定管理者 PIN</h3>
    <p class="muted">僅本機儲存；請記好你的 PIN。</p>
    <div class="row">
      <input id="newPin1" type="password" placeholder="新的 PIN（4~12位）" />
      <input id="newPin2" type="password" placeholder="再輸入一次" />
    </div>
    <footer>
      <button class="secondary" id="cancelSetPin">取消</button>
      <button id="confirmSetPin">設定</button>
    </footer>
  </div>
</dialog>

<script>
// ---- PWA: register SW ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

/* ===== 資料層 ===== */
const KEY = 'procure-db-v1';
const PIN_KEY = 'procure-admin-pin';
const DEFAULT_PIN = '0000';

const $ = sel => document.querySelector(sel);
const q = $('#q'), id = $('#id'), item = $('#item'), unit = $('#unit'), price = $('#price'), vendor = $('#vendor');
const tbody = $('#tbl tbody'), count = $('#count');

const loginBtn = $('#loginBtn'), logoutBtn = $('#logoutBtn'), setPinBtn = $('#setPinBtn');
const importBtn = $('#importBtn'), exportBtn = $('#exportBtn'), clearBtn = $('#clearBtn'), addBtn = $('#addBtn'), csvFile = $('#csvFile');
const modeBadge = $('#modeBadge');
const adminTabBtn = document.querySelector('.tab[data-tab="admin"]');
const tabs = document.querySelectorAll('.tab');
const pageData = $('#page-data'), pageAdmin = $('#page-admin');

const dlgLogin = $('#dlgLogin'), pinInput = $('#pinInput'), cancelLogin = $('#cancelLogin'), confirmLogin = $('#confirmLogin');
const dlgSetPin = $('#dlgSetPin'), newPin1 = $('#newPin1'), newPin2 = $('#newPin2'), cancelSetPin = $('#cancelSetPin'), confirmSetPin = $('#confirmSetPin');

const fmtMoney = n => {
  if (n === '' || n === null || n === undefined || isNaN(n)) return '';
  const v = Number(n);
  return v.toLocaleString('en-US', { maximumFractionDigits: 2 });
};
function load(){ try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
function save(rows){ localStorage.setItem(KEY, JSON.stringify(rows)); }
function getPin(){ return localStorage.getItem(PIN_KEY) || DEFAULT_PIN; }
function isAdmin(){ return sessionStorage.getItem('admin') === '1'; }
function setAdmin(on){ on ? sessionStorage.setItem('admin','1') : sessionStorage.removeItem('admin'); }

/* ===== CRUD ===== */
function upsertRow(r){
  const rows = load();
  const i = rows.findIndex(x => x.編號 === r.編號);
  if (i>=0) rows[i] = r; else rows.push(r);
  save(rows); render();
}
function delRow(編號){
  const rows = load().filter(x => x.編號 !== 編號);
  save(rows); render();
}
function fillForm(r){
  id.value = r.編號; item.value = r.品項; unit.value = r.單位; price.value = r.價錢; vendor.value = r.廠商;
  id.scrollIntoView({behavior:'smooth',block:'center'});
}

/* ===== Tabs + Hash ===== */
function showTab(name){
  tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  pageData.classList.toggle('hidden', name !== 'data');
  pageAdmin.classList.toggle('hidden', name !== 'admin');
  if(name === 'admin' && !isAdmin()){
    location.hash = '#data';
    showTab('data');
    return;
  }
  location.hash = '#' + name;
}
function initFromHash(){
  const h = (location.hash || '#data').replace('#','');
  showTab(h === 'admin' && isAdmin() ? 'admin' : 'data');
}

/* ===== UI & 權限 ===== */
function applyModeUI(){
  const admin = isAdmin();
  addBtn.disabled = !admin;
  importBtn.disabled = !admin;
  clearBtn.disabled = !admin;
  setPinBtn.disabled = !admin;

  loginBtn.classList.toggle('hidden', admin);
  logoutBtn.classList.toggle('hidden', !admin);
  modeBadge.textContent = admin ? '✅ 管理者模式' : '🔒 唯讀模式';
  modeBadge.classList.toggle('admin', admin);
  modeBadge.classList.toggle('readonly', !admin);

  // 管理分頁 tab 顯示/隱藏
  adminTabBtn.classList.toggle('hidden', !admin);
  if(!admin && location.hash === '#admin'){ showTab('data'); }
  render();
}

function render(){
  const query = (q.value || '').trim().toLowerCase();
  const rows = load().sort((a,b)=> a.編號.localeCompare(b.編號));
  const filtered = rows.filter(r => {
    const blob = `${r.編號} ${r.品項} ${r.廠商}`.toLowerCase();
    return blob.includes(query);
  });
  const admin = isAdmin();
  tbody.innerHTML = filtered.map(r => `
    <tr>
      <td>${r.編號}</td>
      <td>${r.品項}</td>
      <td>${r.單位}</td>
      <td>${fmtMoney(r.價錢)}</td>
      <td>${r.廠商}</td>
      <td class="actions">
        ${admin ? `
          <button class="secondary" data-act="edit" data-row='${encodeURIComponent(JSON.stringify(r))}'>編輯</button>
          <button data-act="del" data-id="${r.編號.replace(/"/g,'&quot;')}">刪除</button>
        ` : `<span class="muted">唯讀</span>`}
      </td>
    </tr>
  `).join('');
  count.textContent = `共 ${filtered.length} / ${rows.length} 筆`;
}

/* ===== 事件 ===== */
document.addEventListener('click', (ev)=>{
  const t = ev.target;
  if(t.dataset.act === 'edit'){
    if(!isAdmin()){ alert('請先以管理者登入'); return; }
    const r = JSON.parse(decodeURIComponent(t.dataset.row)); fillForm(r);
  }
  if(t.dataset.act === 'del'){
    if(!isAdmin()){ alert('請先以管理者登入'); return; }
    const id = t.dataset.id;
    if(confirm(`刪除「${id}」？`)) delRow(id);
  }
});

tabs.forEach(t => t.addEventListener('click', ()=> showTab(t.dataset.tab)));
q.oninput = render;

exportBtn.onclick = () => {
  const rows = load();
  const headers = ['編號','品項','單位','價錢','廠商'];
  const csv = [headers.join(',')].concat(
    rows.map(r => headers.map(h => {
      const v = r[h] ?? '';
      const s = String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(','))
  ).join('\n');
  const blob = new Blob([`\ufeff${csv}`], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = '採購資料庫.csv';
  a.click();
};

addBtn.onclick = () => {
  if(!isAdmin()){ alert('請先以管理者登入'); return; }
  const r = {
    編號: id.value.trim(),
    品項: item.value.trim(),
    單位: unit.value.trim(),
    價錢: price.value.trim()===''? '' : Number(String(price.value).replace(/,/g,'')),
    廠商: vendor.value.trim()
  };
  if(!r.編號 || !r.品項 || !r.單位 || r.價錢==='' || isNaN(r.價錢) || !r.廠商){
    alert('請完整填寫：編號、品項、單位、價錢（數字）、廠商'); return;
  }
  upsertRow(r);
  item.value = unit.value = price.value = vendor.value = '';
};

clearBtn.onclick = () => {
  if(!isAdmin()){ alert('請先以管理者登入'); return; }
  if (confirm('確定要清空本機資料嗎？此動作無法復原！')) { localStorage.setItem(KEY,'[]'); render(); }
};

importBtn.onclick = async () => {
  if(!isAdmin()){ alert('請先以管理者登入'); return; }
  const file = csvFile.files?.[0];
  if(!file){ alert('請先選擇 CSV 檔案'); return; }
  const text = await file.text();
  const lines = text.replace(/^\uFEFF/,'').split(/\r?\n/).filter(x=>x.trim()!=='');
  const header = lines.shift().split(',');
  const idx = {
    編號: header.indexOf('編號'),
    品項: header.indexOf('品項'),
    單位: header.indexOf('單位'),
    價錢: header.indexOf('價錢'),
    廠商: header.indexOf('廠商')
  };
  if(Object.values(idx).some(v => v===-1)){ alert('CSV 標頭需包含：編號,品項,單位,價錢,廠商'); return; }
  const rows = lines.map(line => {
    const cols = []; let cur = ''; let inQ = false;
    for(const ch of line){
      if(ch === '"'){ inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ cols.push(cur); cur=''; } else cur += ch;
    }
    cols.push(cur);
    const priceRaw = (cols[idx.價錢] || '').replace(/,/g,'');
    return {
      編號: cols[idx.編號] || '',
      品項: cols[idx.品項] || '',
      單位: cols[idx.單位] || '',
      價錢: priceRaw===''? '' : Number(priceRaw),
      廠商: cols[idx.廠商] || ''
    };
  }).filter(r => r.編號 && r.品項 && r.單位 && r.廠商 && r.價錢!=='' && !isNaN(r.價錢));
  const existing = load();
  const map = new Map(existing.map(r=>[r.編號,r]));
  for(const r of rows) map.set(r.編號,r);
  localStorage.setItem(KEY, JSON.stringify(Array.from(map.values())));
  render();
  alert(`匯入完成：${rows.length} 筆（同編號覆蓋）。`);
};

/* ===== 登入流程 ===== */
loginBtn.onclick = () => { pinInput.value=''; dlgLogin.showModal(); setTimeout(()=>pinInput.focus(), 50); };
cancelLogin.onclick = () => dlgLogin.close();
confirmLogin.onclick = () => {
  const ok = pinInput.value === getPin();
  if(!ok){ alert('PIN 不正確'); return; }
  setAdmin(true); dlgLogin.close(); applyModeUI(); showTab('admin');
};
logoutBtn.onclick = () => { setAdmin(false); applyModeUI(); showTab('data'); };

setPinBtn.onclick = () => { newPin1.value=''; newPin2.value=''; dlgSetPin.showModal(); setTimeout(()=>newPin1.focus(),50); };
cancelSetPin.onclick = () => dlgSetPin.close();
confirmSetPin.onclick = () => {
  const p1 = newPin1.value.trim(), p2 = newPin2.value.trim();
  if(p1.length < 4 || p1.length > 12){ alert('PIN 長度需 4~12 位'); return; }
  if(p1 !== p2){ alert('兩次輸入不一致'); return; }
  localStorage.setItem(PIN_KEY, p1);
  dlgSetPin.close();
  alert('PIN 已更新');
};

/* ===== 首次啟動示例資料 ===== */
if(!localStorage.getItem(KEY)){
  localStorage.setItem(KEY, JSON.stringify([
    {"編號":"PR-20250828-001","品項":"A4 影印紙 80gsm","單位":"箱(5包)","價錢":850,"廠商":"文文文具行"},
    {"編號":"PR-20250828-002","品項":"黑色碳粉匣 TN-2380","單位":"個","價錢":1350,"廠商":"宏昌耗材"},
    {"編號":"PR-20250828-003","品項":"75吋顯示器支架","單位":"座","價錢":4200,"廠商":"展瑞五金"},
    {"編號":"PR-20250828-004","品項":"咖啡豆 中焙 1kg","單位":"包","價錢":520,"廠商":"山丘咖啡"},
    {"編號":"PR-20250828-005","品項":"RJ45 網路線 Cat6 3m","單位":"條","價錢":69,"廠商":"捷訊科技"}
  ]));
}

/* ===== 初始化 ===== */
function init(){
  applyModeUI();
  initFromHash();
  window.addEventListener('hashchange', initFromHash);
}
init();
</script>
</body>
</html>
