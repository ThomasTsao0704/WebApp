<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ¡è³¼è³‡æ–™åº« Â· æ¡è³¼ / è³‡æ–™ / ç®¡ç† Â· PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111111">
    <link rel="icon" href="icons/icon-192.png" sizes="192x192">
    <style>
        :root {
            --radius: 12px;
            --border: #e5e7eb;
            --muted: #6b7280;
            --bg: #fafafa;
            --primary: #111;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: #111
        }

        .wrap {
            max-width: 1000px;
            margin: 0 auto;
            padding: 18px
        }

        h1 {
            font-size: 1.25rem;
            margin: 8px 0 6px
        }

        .sub {
            color: var(--muted);
            margin: 0 0 12px
        }

        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
            align-items: center
        }

        .tab {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            background: #fff;
            cursor: pointer
        }

        .tab.active {
            background: #111;
            color: #fff;
            border-color: #111
        }

        .right {
            margin-left: auto
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: .85rem;
            background: #fff
        }

        .badge.readonly {
            background: #fff
        }

        .badge.admin {
            background: #eefbf1;
            border-color: #b7ebc6
        }

        .hidden {
            display: none !important
        }

        .card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .03)
        }

        .row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        input,
        button,
        select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 10px
        }

        input,
        select {
            flex: 1;
            min-width: 120px
        }

        button {
            cursor: pointer;
            background: var(--primary);
            color: #fff
        }

        button.secondary {
            background: #fff;
            color: #111
        }

        button[disabled] {
            opacity: .5;
            cursor: not-allowed
        }

        .muted {
            color: var(--muted);
            font-size: .92rem
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border: 1px solid var(--border);
            border-radius: 999px;
            font-size: .85rem;
            color: #333;
            background: #fafafa
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            text-align: left;
            vertical-align: top
        }

        tr:hover {
            background: #f7f7f7
        }

        .num {
            font-variant-numeric: tabular-nums
        }

        .table-wrap {
            overflow: auto
        }

        .actions button {
            padding: 6px 10px;
            font-size: .9rem
        }

        /* Qty control */
        .qty {
            display: flex;
            align-items: center;
            gap: 6px
        }

        .qty input {
            width: 78px;
            text-align: right;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 10px
        }

        .qty button {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #fff;
            line-height: 0
        }

        /* Grid cards */
        .summary {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 12px
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px
        }

        /* Dialog */
        dialog {
            border: none;
            border-radius: 16px;
            padding: 0;
            width: min(90vw, 420px)
        }

        .dlg {
            padding: 18px
        }

        .dlg h3 {
            margin: 0 0 10px
        }

        .dlg .row {
            margin-top: 8px
        }

        .dlg footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px
        }

        .overlay::backdrop {
            background: rgba(0, 0, 0, .4)
        }

        /* Toast */
        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: #16a34a;
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, .15);
            opacity: 0;
            transform: translateY(12px);
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease;
            font-size: .95rem
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0)
        }

        .toast.error {
            background: #dc2626
        }

        @media (max-width:700px) {
            .grid-3 {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>æ¡è³¼è³‡æ–™åº« Â· PWA</h1>
        <p class="sub">åˆ†é ï¼šğŸ›’æ¡è³¼ï¼ˆè³¼ç‰©è»Šï¼‰ï¼ğŸ“„è³‡æ–™ï¼ˆè¡¨æ ¼ï¼‰ï¼ğŸ› ç®¡ç†ï¼ˆç™»å…¥å¾Œå¯è¦‹ï¼‰ã€‚é è¨­ PINï¼š<span class="tag">0000</span>ã€‚</p>

        <div class="tabs">
            <button class="tab" data-tab="cart">ğŸ›’ æ¡è³¼</button>
            <button class="tab" data-tab="data">ğŸ“„ è³‡æ–™</button>
            <button class="tab hidden" data-tab="admin" id="adminTab">ğŸ›  ç®¡ç†</button>
            <span class="right"></span>
            <span id="modeBadge" class="badge readonly">ğŸ”’ å”¯è®€æ¨¡å¼</span>
            <button id="loginBtn" class="secondary">ç®¡ç†è€…ç™»å…¥</button>
            <button id="installBtn" class="secondary hidden" title="å®‰è£é›¢ç·š App">ğŸ“² å®‰è£ App</button>
            <button id="logoutBtn" class="secondary hidden">ç™»å‡º</button>
        </div>

        <!-- ğŸ›’ æ¡è³¼ -->
        <section id="page-cart">
            <div class="card">
                <div class="row">
                    <input id="cartQ" type="search" placeholder="æœå°‹ç·¨è™Ÿ / å“é … / å–®ä½ / å» å•†â€¦" />
                    <select id="shopFilter">
                        <option value="">å…¨éƒ¨å» å•†</option>
                    </select>
                    <button id="resetQty" class="secondary">æ¸…ç©ºæ•¸é‡</button>
                    <button id="cartExport" class="secondary">åŒ¯å‡ºï¼ˆå½™ç¸½ï¼‹è¤‡è£½ï¼‰</button>
                </div>
                <p class="muted" style="margin-top:8px">åƒ…å½±éŸ¿æœ¬æ©Ÿè³¼ç‰©è»Šæ•¸é‡ï¼›ä¸æœƒä¿®æ”¹è³‡æ–™åº«å…§å®¹ã€‚</p>
            </div>

            <div class="card table-wrap">
                <table id="cartTbl">
                    <thead>
                        <tr>
                            <th>ç·¨è™Ÿ</th>
                            <th>å“é …</th>
                            <th>å–®ä½</th>
                            <th class="num">å–®åƒ¹</th>
                            <th>å» å•†</th>
                            <th class="num">æ•¸é‡</th>
                            <th class="num">å°è¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <section class="summary">
                <div class="card">
                    <div class="row" style="align-items:center;justify-content:space-between">
                        <div>
                            <div class="muted">æœªç¨…åˆè¨ˆï¼ˆæ‰€æœ‰å“é …ï¼‰</div>
                            <div id="grandCount" class="muted" style="font-size:.9rem"></div>
                        </div>
                        <div id="grandTotal" class="num" style="font-weight:700;font-size:1.25rem">$0</div>
                    </div>
                </div>
                <div class="grid-3">
                    <div class="card">
                        <div class="muted">æ¸…é † å°è¨ˆ</div>
                        <div id="sum-qingshun" class="num" style="font-weight:700">$0</div>
                    </div>
                    <div class="card">
                        <div class="muted">å¯¶æˆ å°è¨ˆ</div>
                        <div id="sum-baocheng" class="num" style="font-weight:700">$0</div>
                    </div>
                    <div class="card">
                        <div class="muted">å·²é¸æ“‡å“é …æ•¸</div>
                        <div id="pickedCount" class="num" style="font-weight:700">0</div>
                    </div>
                </div>
            </section>
        </section>

        <!-- ğŸ“„ è³‡æ–™ -->
        <section id="page-data" class="hidden">
            <div class="card">
                <div class="row" style="margin-bottom:8px">
                    <input id="id" placeholder="ç·¨è™Ÿï¼ˆ= idï¼Œå¦‚ PR-20250828-001 æˆ– A01ï¼‰" />
                    <input id="item" placeholder="å“é …ï¼ˆå‹è™Ÿ/è¦æ ¼ï¼‰" />
                    <input id="unit" placeholder="å–®ä½ï¼ˆå€‹/åŒ…/ç®±â€¦ï¼‰" />
                    <input id="price" placeholder="åƒ¹éŒ¢ï¼ˆæ•¸å­—ï¼‰" inputmode="decimal" />
                    <input id="vendor" placeholder="å» å•†ï¼ˆ= shopï¼‰" />
                </div>
                <div class="row">
                    <button id="addBtn" disabled>æ–°å¢ / æ›´æ–°</button>
                    <span class="muted">æç¤ºï¼šç›¸åŒã€Œç·¨è™Ÿ(id)ã€æœƒè¦–ç‚ºæ›´æ–°åŒä¸€ç­†ï¼ˆéœ€ç™»å…¥ï¼‰ã€‚</span>
                </div>
            </div>

            <div class="card">
                <div class="row">
                    <input id="q" type="search" placeholder="æœå°‹ï¼šç·¨è™Ÿ / å“é … / å» å•†â€¦" />
                    <button id="exportBtn" class="secondary">åŒ¯å‡º CSVï¼ˆè³‡æ–™åº«ï¼‰</button>
                </div>
            </div>

            <div class="card table-wrap">
                <table id="tbl">
                    <thead>
                        <tr>
                            <th>ç·¨è™Ÿ</th>
                            <th>å“é …</th>
                            <th>å–®ä½</th>
                            <th class="num">åƒ¹éŒ¢</th>
                            <th>å» å•†</th>
                            <th>å‹•ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="count" class="muted" style="margin-top:8px"></div>
            </div>
        </section>

        <!-- ğŸ›  ç®¡ç† -->
        <section id="page-admin" class="hidden">
            <div class="card">
                <h3>ğŸ›¡ ç®¡ç†åŠŸèƒ½</h3>
                <div class="row" style="margin-top:8px">
                    <input id="csvFile" type="file" accept=".csv" />
                    <button class="secondary" id="importBtn" disabled>å¾ CSV åŒ¯å…¥</button>
                    <button class="secondary" id="clearBtn" title="æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™ï¼ˆè«‹è¬¹æ…ï¼‰" disabled>æ¸…ç©ºè³‡æ–™</button>
                    <button class="secondary" id="setPinBtn" disabled>è¨­å®šç®¡ç†è€… PIN</button>
                    <span class="right"></span>
                    <span id="dbInfo" class="badge">è³‡æ–™ 0 ç­†</span>
                </div>
                <p class="muted" style="margin-top:8px">
                    è³‡æ–™åº«æ¬„ä½ï¼š<code>{id,item,unit,price,shop}</code>ã€‚å¯åŒ¯å…¥ä¸­æ–‡æ¨™é ­æª”æ¡ˆï¼Œç³»çµ±æœƒè‡ªå‹•å°æ‡‰ä¸¦è½‰æ›ã€‚</p>
            </div>

            <div class="card table-wrap">
                <table id="dbTable">
                    <thead>
                        <tr>
                            <th style="width:64px">æ“ä½œ</th>
                            <th>id</th>
                            <th>item</th>
                            <th>unit</th>
                            <th class="num">price</th>
                            <th>shop</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="row" style="margin-top:10px">
                    <button id="dbAdd" class="secondary">æ–°å¢å“é …</button>
                    <button id="dbSave">å„²å­˜è®Šæ›´</button>
                    <button id="dbExport" class="secondary">åŒ¯å‡º CSV</button>
                    <button id="dbTemplate" class="secondary">ä¸‹è¼‰ CSV æ¨¡æ¿</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ç™»å…¥å°è©±æ¡† -->
    <dialog id="dlgLogin" class="overlay">
        <div class="dlg">
            <h3>ç®¡ç†è€…ç™»å…¥</h3>
            <p class="muted">æœ¬æ©Ÿè¼•é‡ä¿è­·ï¼›è«‹å‹¿ä½¿ç”¨èˆ‡å…¶ä»–æœå‹™ç›¸åŒå¯†ç¢¼ã€‚é è¨­ PINï¼š0000</p>
            <div class="row"><input id="pinInput" type="password" placeholder="è¼¸å…¥ PIN" autofocus /></div>
            <footer>
                <button class="secondary" id="cancelLogin">å–æ¶ˆ</button>
                <button id="confirmLogin">ç™»å…¥</button>
            </footer>
        </div>
    </dialog>

    <!-- è¨­å®š PIN å°è©±æ¡† -->
    <dialog id="dlgSetPin" class="overlay">
        <div class="dlg">
            <h3>è¨­å®šç®¡ç†è€… PIN</h3>
            <p class="muted">åƒ…æœ¬æ©Ÿå„²å­˜ï¼›è«‹è¨˜å¥½ä½ çš„ PINã€‚</p>
            <div class="row">
                <input id="newPin1" type="password" placeholder="æ–°çš„ PINï¼ˆ4~12ä½ï¼‰" />
                <input id="newPin2" type="password" placeholder="å†è¼¸å…¥ä¸€æ¬¡" />
            </div>
            <footer>
                <button class="secondary" id="cancelSetPin">å–æ¶ˆ</button>
                <button id="confirmSetPin">è¨­å®š</button>
            </footer>
        </div>
    </dialog>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        /* ========= PWA ========= */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
        }

        /* ========= Keys / helpers ========= */
        const LS_DB = 'cart-db-v1';
        const LS_QTY = 'cart-qty-v1';
        const LS_FACTORY = 'cart-db-factory-v1';
        const OLD_KEY = 'procure-db-v1';
        const PIN_KEY = 'procure-admin-pin';
        const DEFAULT_PIN = '0000';

        const $ = sel => document.querySelector(sel);
        const intFmt = new Intl.NumberFormat('zh-Hant-TW', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const escCSV = s => /[",\n]/.test(s) ? '"' + String(s).replaceAll('"', '""') + '"' : String(s);
        const uid = (() => { let n = 1; return (p = 'I') => `${p}${(Date.now() % 1e7).toString(36)}${n++}`; })();
        const toInt = v => Number(String(v ?? '').replace(/[$,\s]/g, '').trim()) || 0;
        const toast = (text, { error = false, duration = 1800 } = {}) => {
            const t = $('#toast'); t.textContent = text; t.classList.toggle('error', !!error);
            t.classList.add('show'); clearTimeout(toast._t); toast._t = setTimeout(() => t.classList.remove('show'), duration);
        };

        /* ========= State ========= */
        const state = { data: [], qty: {}, dirty: false };

        /* ========= Migrate old schema ========= */
        (function migrate() {
            try {
                const old = JSON.parse(localStorage.getItem(OLD_KEY) || 'null');
                if (Array.isArray(old) && old.length) {
                    const mapped = old.map(r => ({
                        id: String(r['ç·¨è™Ÿ'] || '').trim() || uid('M'),
                        item: String(r['å“é …'] || '').trim(),
                        unit: String(r['å–®ä½'] || '').trim(),
                        price: Number(r['åƒ¹éŒ¢']) || 0,
                        shop: String(r['å» å•†'] || '').trim()
                    }));
                    localStorage.setItem(LS_DB, JSON.stringify(mapped));
                    localStorage.removeItem(OLD_KEY);
                }
            } catch { }
        })();

        /* ========= Factory defaults ========= */
        const BUILTIN_DEFAULT = [
            { id: 'A01', item: 'å¸ç®¡', unit: '50æ”¯/åŒ…', price: 284, shop: 'æ¸…é †' },
            { id: 'A02', item: 'å†°ç ‚å¸ç®¡', unit: '50æ”¯/åŒ…', price: 1351, shop: 'æ¸…é †' },
            { id: 'A03', item: '9x9 ç´™å·¾', unit: '20åŒ…/ç®±', price: 1637, shop: 'æ¸…é †' },
            { id: 'A04', item: 'æŠ½å–å¼ è¡›ç”Ÿç´™', unit: '20åŒ…/ç®±', price: 1720, shop: 'æ¸…é †' },
            { id: 'A05', item: 'å»šæˆ¿ç´™å·¾', unit: '50æ”¯/åŒ…', price: 1896, shop: 'æ¸…é †' },
            { id: 'B01', item: 'ç‰›çš®ç´™ å¤–å¸¶ç›’(S)', unit: '50å€‹/æ¢', price: 1944, shop: 'å¯¶æˆ' },
            { id: 'B02', item: 'ç‰›çš®ç´™ å¤–å¸¶ç›’(L)', unit: '50å€‹/æ¢', price: 1973, shop: 'å¯¶æˆ' },
            { id: 'B03', item: 'å¤–å¸¶æ¯”è–©ç›’', unit: '50å€‹/æ¢', price: 1994, shop: 'å¯¶æˆ' }
        ];
        const loadFactory = () => {
            try { const x = JSON.parse(localStorage.getItem(LS_FACTORY) || 'null'); if (Array.isArray(x) && x.length) return x; }
            catch { }
            return BUILTIN_DEFAULT.slice();
        };

        /* ========= Load DB & qty ========= */
        (function initDB() {
            try {
                const saved = JSON.parse(localStorage.getItem(LS_DB) || 'null');
                if (Array.isArray(saved) && saved.length) { state.data = saved; }
                else { state.data = loadFactory(); }
            } catch { state.data = loadFactory(); }
        })();
        try { const q = JSON.parse(localStorage.getItem(LS_QTY) || '{}'); state.qty = (q && typeof q === 'object') ? q : {}; } catch { state.qty = {}; }
        for (const d of state.data) { if (!(d.id in state.qty)) state.qty[d.id] = 0; }

        /* ========= Admin (login/pin) ========= */
        const modeBadge = $('#modeBadge'), loginBtn = $('#loginBtn'), logoutBtn = $('#logoutBtn'), adminTabBtn = $('#adminTab');
        const dlgLogin = $('#dlgLogin'), pinInput = $('#pinInput'), cancelLogin = $('#cancelLogin'), confirmLogin = $('#confirmLogin');
        const dlgSetPin = $('#dlgSetPin'), newPin1 = $('#newPin1'), newPin2 = $('#newPin2');

        const getPin = () => localStorage.getItem(PIN_KEY) || DEFAULT_PIN;
        const isAdmin = () => sessionStorage.getItem('admin') === '1';
        const setAdmin = on => on ? sessionStorage.setItem('admin', '1') : sessionStorage.removeItem('admin');

        function applyModeUI() {
            const admin = isAdmin();
            modeBadge.textContent = admin ? 'âœ… ç®¡ç†è€…æ¨¡å¼' : 'ğŸ”’ å”¯è®€æ¨¡å¼';
            modeBadge.classList.toggle('admin', admin);
            modeBadge.classList.toggle('readonly', !admin);
            loginBtn.classList.toggle('hidden', admin);
            logoutBtn.classList.toggle('hidden', !admin);
            adminTabBtn.classList.toggle('hidden', !admin);
            // æ§åˆ¶å¯å¯«æŒ‰éˆ•
            $('#addBtn').disabled = !admin;
            $('#importBtn').disabled = !admin;
            $('#clearBtn').disabled = !admin;
            $('#setPinBtn').disabled = !admin;
            renderData(); renderDB();
        }

        /* ========= Tabs & Hash ========= */
        const tabs = document.querySelectorAll('.tab');
        const pageCart = $('#page-cart'), pageData = $('#page-data'), pageAdmin = $('#page-admin');

        function showTab(name) {
            tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
            pageCart.classList.toggle('hidden', name !== 'cart');
            pageData.classList.toggle('hidden', name !== 'data');
            pageAdmin.classList.toggle('hidden', name !== 'admin');
            if (name === 'admin' && !isAdmin()) { location.hash = '#data'; return showTab('data'); }
            location.hash = '#' + name;
        }
        function initFromHash() {
            const h = (location.hash || '#cart').slice(1);
            showTab(h === 'admin' && isAdmin() ? 'admin' : (h === 'data' ? 'data' : 'cart'));
        }
        tabs.forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));
        window.addEventListener('hashchange', initFromHash);

        /* ========= è³‡æ–™é  ========= */
        const qInp = $('#q'), id = $('#id'), item = $('#item'), unit = $('#unit'), price = $('#price'), vendor = $('#vendor');
        const tbody = $('#tbl tbody'), count = $('#count');
        const exportBtn = $('#exportBtn'), addBtn = $('#addBtn');

        function renderData() {
            const kw = (qInp.value || '').trim().toLowerCase();
            const rows = state.data.slice().sort((a, b) => String(a.id).localeCompare(String(b.id)));
            const filtered = rows.filter(r => (`${r.id} ${r.item} ${r.shop}`.toLowerCase().includes(kw)));
            const admin = isAdmin();
            tbody.innerHTML = filtered.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.item}</td>
          <td>${r.unit}</td>
          <td class="num">${intFmt.format(r.price)}</td>
          <td>${r.shop}</td>
          <td class="actions">
            ${admin ? `
              <button class="secondary" data-act="edit" data-row='${encodeURIComponent(JSON.stringify(r))}'>ç·¨è¼¯</button>
              <button data-act="del" data-id="${r.id.replace(/"/g, '&quot;')}">åˆªé™¤</button>
            ` : `<span class="muted">å”¯è®€</span>`}
          </td>
        </tr>`).join('');
            count.textContent = `å…± ${filtered.length} / ${rows.length} ç­†`;
        }
        document.addEventListener('click', (ev) => {
            const t = ev.target;
            if (t.dataset.act === 'edit') {
                if (!isAdmin()) return alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥');
                const r = JSON.parse(decodeURIComponent(t.dataset.row));
                id.value = r.id; item.value = r.item; unit.value = r.unit; price.value = r.price; vendor.value = r.shop;
                id.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            if (t.dataset.act === 'del') {
                if (!isAdmin()) return alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥');
                const rid = t.dataset.id; const i = state.data.findIndex(x => x.id === rid);
                if (i >= 0 && confirm(`åˆªé™¤ã€Œ${rid}ã€ï¼Ÿ`)) {
                    state.data.splice(i, 1); delete state.qty[rid]; saveDB(); renderData(); renderCart();
                    toast('å·²åˆªé™¤ä¸€ç­†ï¼ˆå«è³¼ç‰©è»Šæ•¸é‡ï¼‰');
                }
            }
        });
        qInp.oninput = renderData;

        // æ–°å¢/æ›´æ–°ï¼ˆå«è¦†å¯«ç¢ºèªã€æ¸…ç©ºæ¬„ä½ï¼‰
        addBtn.onclick = () => {
            if (!isAdmin()) return alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥');
            const rec = {
                id: (id.value || '').trim(),
                item: (item.value || '').trim(),
                unit: (unit.value || '').trim(),
                price: toInt(price.value || 0),
                shop: (vendor.value || '').trim()
            };
            if (!rec.item || !rec.unit || !rec.shop) {
                return alert('è«‹å®Œæ•´å¡«å¯«ï¼šå“é …ã€å–®ä½ã€å» å•†');
            }
            let i = -1;
            if (!rec.id) {
                rec.id = uid('N');
            } else {
                i = state.data.findIndex(x => x.id === rec.id);
                if (i >= 0) {
                    const ok = confirm(`ç·¨è™Ÿã€Œ${rec.id}ã€å·²å­˜åœ¨ï¼Œè¦è¦†å¯«é€™ç­†è³‡æ–™å—ï¼Ÿ`);
                    if (!ok) return;
                }
            }
            if (i >= 0) state.data[i] = rec; else state.data.push(rec);
            if (!(rec.id in state.qty)) state.qty[rec.id] = 0;
            saveDB(); renderData(); renderCart();
            toast(i >= 0 ? 'å·²æ›´æ–°ä¸€ç­†è³‡æ–™' : 'å·²æ–°å¢ä¸€ç­†è³‡æ–™');
            id.value = item.value = unit.value = price.value = vendor.value = '';
        };

        exportBtn.onclick = () => {
            const headers = ['id', 'item', 'unit', 'price', 'shop'];
            const csv = [headers.join(',')].concat(
                state.data.map(r => headers.map(h => escCSV(r[h] ?? '')).join(','))
            ).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'items.csv'; a.click();
        };

        /* ========= ç®¡ç†é  ========= */
        const dbTbody = $('#dbTable tbody');
        const dbInfo = $('#dbInfo');
        const dbAdd = $('#dbAdd'), dbSave = $('#dbSave'), dbExport = $('#dbExport'), dbTemplate = $('#dbTemplate');
        const csvFile = $('#csvFile'), importBtn = $('#importBtn'), clearBtn = $('#clearBtn'), setPinBtn = $('#setPinBtn');

        function markDirty(flag = true) { state.dirty = flag; dbInfo.textContent = `è³‡æ–™ ${state.data.length} ç­† Â· ${flag ? 'æœªå„²å­˜' : 'å·²å„²å­˜'}`; }
        function renderDB() {
            if ($('#page-admin').classList.contains('hidden')) return;
            dbTbody.innerHTML = '';
            for (const d of state.data) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td><button data-act="del" data-id="${d.id}">åˆªé™¤</button> <button class="secondary" data-act="dup" data-id="${d.id}">è¤‡è£½</button></td>
          <td><input data-f="id" value="${d.id}"></td>
          <td><input data-f="item" value="${d.item}"></td>
          <td><input data-f="unit" value="${d.unit}"></td>
          <td><input data-f="price" class="num" value="${d.price}"></td>
          <td><input data-f="shop" value="${d.shop}"></td>`;
                dbTbody.appendChild(tr);
            }
            dbTbody.querySelectorAll('button[data-act="del"]').forEach(b => b.addEventListener('click', () => {
                const id = b.dataset.id; const i = state.data.findIndex(x => x.id === id);
                if (i >= 0) { state.data.splice(i, 1); delete state.qty[id]; markDirty(); renderDB(); renderData(); renderCart(); toast('å·²åˆªé™¤ï¼ˆå«è³¼ç‰©è»Šæ•¸é‡ï¼‰'); }
            }));
            dbTbody.querySelectorAll('button[data-act="dup"]').forEach(b => b.addEventListener('click', () => {
                const id = b.dataset.id; const d = state.data.find(x => x.id === id); if (!d) return;
                const c = { ...d, id: uid('D') }; state.data.push(c); state.qty[c.id] = 0; markDirty(); renderDB(); renderData(); renderCart(); toast('å·²è¤‡è£½');
            }));
            dbTbody.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => markDirty(true)));
            markDirty(false);
        }
        function collectDB() {
            const rows = [...dbTbody.querySelectorAll('tr')].map(tr => {
                const m = Object.fromEntries([...tr.querySelectorAll('input')].map(i => [i.dataset.f, i.value]));
                return { id: (m.id || '').trim() || uid('I'), item: (m.item || '').trim(), unit: (m.unit || '').trim(), price: toInt(m.price || 0), shop: (m.shop || '').trim() };
            });
            // å»é‡ id
            const seen = new Set(); for (const r of rows) { if (seen.has(r.id)) r.id = uid('I'); seen.add(r.id); }
            state.data = rows; for (const d of state.data) { if (!(d.id in state.qty)) state.qty[d.id] = 0; }
        }

        // saveDBï¼šæ¸…ç† qty å­¤å…’
        function saveDB() {
            const valid = new Set(state.data.map(d => d.id));
            for (const k of Object.keys(state.qty)) { if (!valid.has(k)) delete state.qty[k]; }
            localStorage.setItem(LS_DB, JSON.stringify(state.data));
            localStorage.setItem(LS_QTY, JSON.stringify(state.qty));
            markDirty(false);
        }

        dbAdd.onclick = () => { state.data.push({ id: uid('N'), item: '', unit: '', price: 0, shop: '' }); markDirty(); renderDB(); };
        dbSave.onclick = () => { collectDB(); saveDB(); renderData(); renderCart(); toast('è³‡æ–™åº«å·²å„²å­˜'); };
        dbExport.onclick = () => {
            const headers = ['id', 'item', 'unit', 'price', 'shop'];
            const csv = [headers.join(',')].concat(state.data.map(r => headers.map(h => escCSV(r[h] ?? '')).join(','))).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = 'items.csv'; a.click();
        };
        dbTemplate.onclick = () => {
            const csv = 'id,item,unit,price,shop\n,å¸ç®¡,50æ”¯/åŒ…,284,æ¸…é †';
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            a.download = 'template_items.csv'; a.click();
        };
        // åŒ¯å…¥ CSVï¼ˆæ”¯æ´è‹±/ä¸­æ¨™é ­ï¼‰
        const parseCSV = (text) => {
            const rows = []; let cur = []; let val = ''; let inQ = false; text = text.replace(/\r\n?|\n/g, '\n');
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (inQ) { if (c == '"') { if (text[i + 1] == '"') { val += '"'; i++; } else inQ = false; } else val += c; }
                else {
                    if (c == '"') inQ = true; else if (c == ',') { cur.push(val); val = ''; }
                    else if (c == '\n') { cur.push(val); rows.push(cur); cur = []; val = ''; } else val += c;
                }
            } if (val.length > 0 || cur.length > 0) { cur.push(val); rows.push(cur); }
            return rows;
        };
        importBtn.onclick = () => { if (!isAdmin()) return alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥'); csvFile.click(); };
        csvFile.onchange = ev => {
            const f = ev.target.files?.[0]; if (!f) return;
            const r = new FileReader();
            r.onload = () => {
                try {
                    const lines = parseCSV(String(r.result || ''));
                    if (!lines.length) throw new Error('ç©ºæª”æ¡ˆ');
                    const header = lines.shift().map(s => String(s || '').trim().toLowerCase());
                    const idx = (...cand) => { for (const c of cand) { const k = header.indexOf(c); if (k !== -1) return k; } return -1; };
                    const ix = { id: idx('id', 'ç·¨è™Ÿ'), item: idx('item', 'å“é …'), unit: idx('unit', 'å–®ä½'), price: idx('price', 'åƒ¹éŒ¢', 'åƒ¹æ ¼'), shop: idx('shop', 'å» å•†', 'åº—å®¶', 'å•†å®¶') };
                    if (ix.item < 0 || ix.unit < 0 || ix.price < 0 || ix.shop < 0) throw new Error('ç¼ºå°‘å¿…è¦æ¬„ä½');
                    const next = [];
                    for (const row of lines) {
                        if (row.every(x => String(x).trim() === '')) continue;
                        const rec = {
                            id: (row[ix.id] || '').trim() || uid('I'),
                            item: (row[ix.item] || '').trim(),
                            unit: (row[ix.unit] || '').trim(),
                            price: toInt(row[ix.price] || 0),
                            shop: (row[ix.shop] || '').trim()
                        };
                        next.push(rec);
                    }
                    state.data = next; const q = {}; for (const d of state.data) { q[d.id] = state.qty[d.id] || 0; } state.qty = q;
                    saveDB(); renderDB(); renderData(); renderCart(); toast(`åŒ¯å…¥æˆåŠŸï¼š${state.data.length} ç­†`);
                } catch (e) { console.error(e); toast('åŒ¯å…¥å¤±æ•—ï¼šæ¬„ä½ä¸å®Œæ•´æˆ–æ ¼å¼éŒ¯èª¤', { error: true, duration: 2600 }); }
                ev.target.value = '';
            };
            r.readAsText(f, 'utf-8');
        };
        clearBtn.onclick = () => {
            if (!isAdmin()) return alert('è«‹å…ˆä»¥ç®¡ç†è€…ç™»å…¥');
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™åº«èˆ‡è³¼ç‰©è»Šæ•¸é‡ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                localStorage.setItem(LS_DB, JSON.stringify([]));
                localStorage.setItem(LS_QTY, JSON.stringify({}));
                state.data = []; state.qty = {}; renderDB(); renderData(); renderCart(); toast('å·²æ¸…ç©º');
            }
        };
        $('#setPinBtn').onclick = () => { $('#newPin1').value = ''; $('#newPin2').value = ''; dlgSetPin.showModal(); setTimeout(() => $('#newPin1').focus(), 50); };
        $('#cancelSetPin').onclick = () => dlgSetPin.close();
        $('#confirmSetPin').onclick = () => {
            const p1 = $('#newPin1').value.trim(), p2 = $('#newPin2').value.trim();
            if (p1.length < 4 || p1.length > 12) return alert('PIN é•·åº¦éœ€ 4~12 ä½');
            if (p1 !== p2) return alert('å…©æ¬¡è¼¸å…¥ä¸ä¸€è‡´');
            localStorage.setItem(PIN_KEY, p1); dlgSetPin.close(); toast('PIN å·²æ›´æ–°');
        };

        /* ========= æ¡è³¼é ï¼ˆè³¼ç‰©è»Šï¼‰ ========= */
        const cartQ = $('#cartQ'), shopFilter = $('#shopFilter'), cartTbody = $('#cartTbl tbody');
        const grandTotal = $('#grandTotal'), grandCount = $('#grandCount'), sumQS = $('#sum-qingshun'), sumBC = $('#sum-baocheng'), pickedCount = $('#pickedCount');

        function saveQty() { localStorage.setItem(LS_QTY, JSON.stringify(state.qty)); }

        // ä¿ç•™é¸æ“‡çš„å» å•†ï¼Œä¸è¦æ¯æ¬¡ render è¢«æ´—æ‰
        function populateShopFilter() {
            const prev = shopFilter.value;
            shopFilter.innerHTML = '<option value="">å…¨éƒ¨å» å•†</option>';
            const shops = [...new Set(state.data.map(d => d.shop).filter(Boolean))].sort((a, b) => a.localeCompare(b));
            for (const s of shops) {
                const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
                shopFilter.appendChild(opt);
            }
            if ([...shopFilter.options].some(o => o.value === prev)) shopFilter.value = prev;
        }

        function renderCart() {
            populateShopFilter();
            const kw = (cartQ.value || '').trim().toLowerCase();
            const shop = shopFilter.value;
            const rows = state.data.filter(d => {
                const text = `${d.id} ${d.item} ${d.unit} ${d.shop}`.toLowerCase();
                return (!kw || text.includes(kw)) && (!shop || d.shop === shop);
            });
            cartTbody.innerHTML = '';
            rows.forEach((d) => {
                const q = Number(state.qty[d.id] || 0), sub = q * d.price;
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${d.id}</td>
          <td>${d.item}</td>
          <td>${d.unit}</td>
          <td class="num">$${intFmt.format(d.price)}</td>
          <td>${d.shop}</td>
          <td class="num">
            <div class="qty">
              <button aria-label="æ¸›å°‘" data-act="dec" data-id="${d.id}">âˆ’</button>
              <input inputmode="numeric" pattern="[0-9]*" type="number" min="0" step="1" data-id="${d.id}" value="${q}" />
              <button aria-label="å¢åŠ " data-act="inc" data-id="${d.id}">ï¼‹</button>
            </div>
          </td>
          <td class="num" data-sub="${d.id}">$${intFmt.format(sub)}</td>`;
                cartTbody.appendChild(tr);
            });
            // ç¶å®šæ•¸é‡æ§ä»¶
            cartTbody.querySelectorAll('button[data-id]').forEach(b => b.addEventListener('click', () => {
                const id = b.dataset.id; const cur = Number(state.qty[id] || 0); const next = Math.max(0, cur + (b.dataset.act === 'inc' ? 1 : -1));
                state.qty[id] = next; saveQty();
                const inp = cartTbody.querySelector(`input[data-id="${id}"]`); if (inp) inp.value = next;
                const d = state.data.find(x => x.id === id); const td = cartTbody.querySelector(`[data-sub="${id}"]`);
                if (d && td) td.textContent = `$${intFmt.format(next * d.price)}`;
                recalcTotals();
            }));
            cartTbody.querySelectorAll('input[data-id]').forEach(inp => inp.addEventListener('input', () => {
                const id = inp.dataset.id; let v = Number(inp.value || 0); if (isNaN(v) || v < 0) v = 0; inp.value = v; state.qty[id] = v; saveQty();
                const d = state.data.find(x => x.id === id); const td = cartTbody.querySelector(`[data-sub="${id}"]`);
                if (d && td) td.textContent = `$${intFmt.format(v * d.price)}`;
                recalcTotals();
            }));
            recalcTotals();
        }
        function recalcTotals() {
            let grand = 0, picked = 0, sumQ = 0, sumB = 0, units = 0;
            for (const d of state.data) {
                const q = Number(state.qty[d.id] || 0); if (q > 0) { picked++; units += q; }
                const sub = q * d.price; grand += sub; if (d.shop === 'æ¸…é †') sumQ += sub; else if (d.shop === 'å¯¶æˆ') sumB += sub;
            }
            grandTotal.textContent = `$${intFmt.format(grand)}`;
            grandCount.textContent = `å…± ${units} å–®ä½ï¼ˆ${picked} å€‹å“é …ï¼‰`;
            sumQS.textContent = `$${intFmt.format(sumQ)}`;
            sumBC.textContent = `$${intFmt.format(sumB)}`;
            pickedCount.textContent = picked;
        }
        $('#resetQty').onclick = () => { if (confirm('æ¸…ç©ºæ‰€æœ‰å“é …çš„æ•¸é‡ï¼Ÿ')) { for (const k in state.qty) state.qty[k] = 0; saveQty(); renderCart(); } };
        $('#cartExport').onclick = async () => {
            let msg = ''; let total = 0;
            for (const d of state.data) { const q = Number(state.qty[d.id] || 0); if (q > 0) { const sub = q * d.price; msg += `${d.item} x ${q} = $${intFmt.format(sub)}\n`; total += sub; } }
            if (!msg) return alert('å°šæœªé¸è³¼ä»»ä½•å“é …ã€‚');
            msg += `\nåˆè¨ˆï¼š$${intFmt.format(total)}`;
            alert(msg);
            try { await navigator.clipboard.writeText(msg); toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¯ç›´æ¥è²¼åˆ° LINE'); }
            catch { toast('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½', { error: true, duration: 2600 }); }
        };
        cartQ.oninput = renderCart; shopFilter.onchange = renderCart;

        /* ========= Login flow ========= */
        loginBtn.onclick = () => { pinInput.value = ''; dlgLogin.showModal(); setTimeout(() => pinInput.focus(), 50); };
        cancelLogin.onclick = () => dlgLogin.close();
        confirmLogin.onclick = () => {
            if (pinInput.value !== (localStorage.getItem(PIN_KEY) || DEFAULT_PIN)) return alert('PIN ä¸æ­£ç¢º');
            setAdmin(true); dlgLogin.close(); applyModeUI(); showTab('admin');
        };
        logoutBtn.onclick = () => { setAdmin(false); applyModeUI(); showTab('cart'); };

        /* ========= Init ========= */
        function initialRender() { applyModeUI(); initFromHash(); renderCart(); renderData(); }
        initialRender();

        // ======== PWAï¼šå®‰è£æç¤ºèˆ‡ Service Worker ========
        let deferredPrompt = null;
        const $installBtn = document.getElementById('installBtn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            $installBtn.classList.remove('hidden');
        });
        $installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) { showToast('æ­¤è£ç½®æš«ä¸æ”¯æ´å®‰è£', { error: true }); return; }
            $installBtn.disabled = true;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') showToast('å·²é–‹å§‹å®‰è£ App');
            else showToast('å·²å–æ¶ˆå®‰è£', { error: true });
            deferredPrompt = null; $installBtn.classList.add('hidden'); $installBtn.disabled = false;
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(() => {
                    console.log('SW registered');
                }).catch(err => console.warn('SW failed', err));
            });
        }
    </script>
</body>

</html>