<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç¾é£Ÿé£Ÿè­œç€è¦½</title>

    <!-- å¤–æ›ï¼šPapaParse ä¾› CSV è§£æ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">

    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    text-align: center;
    color: white;
    margin-bottom: 30px;
}

h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-bottom: 30px;
}

.filters {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr auto;
    gap: 15px;
    align-items: center;
}

input[type="text"],
select,
input[type="number"],
input[type="url"],
input[type="file"],
textarea {
    padding: 12px 16px;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    transition: all 0.3s ease;
    width: 100%;
}

input[type="file"] {
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px dashed rgba(102, 126, 234, 0.3);
    cursor: pointer;
}

input[type="file"]:hover {
    border-color: rgba(102, 126, 234, 0.6);
    background: white;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.view-toggle {
    display: flex;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    overflow: hidden;
}

.view-btn {
    padding: 8px 16px;
    border: none;
    background: transparent;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.view-btn.active {
    background: rgba(255, 255, 255, 0.3);
}

.stats {
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 25px;
    font-size: 0.9rem;
}

/* ç¸½å®¹å™¨ï¼šå¤šæ¬„ç¶²æ ¼ */
.recipes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
}

/* åˆ—è¡¨æ¨¡å¼ï¼šå›ºå®šå–®æ¬„ */
.recipes-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
}

.recipe-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    animation: fadeIn 0.5s ease;
}

.recipe-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.recipe-image {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border-radius: 12px;
}

.recipe-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.recipe-content {
    padding: 20px;
}

.recipe-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2d3748;
    flex: 1;
    margin: 0;
}

.recipe-meta {
    display: flex;
    gap: 15px;
    margin-bottom: 12px;
    font-size: 0.85rem;
    color: #718096;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.recipe-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 15px;
}

.tag {
    background: #e2e8f0;
    color: #4a5568;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.recipe-details {
    margin-top: 12px;
}

.recipe-video {
    margin: 12px 0;
}

.recipe-video iframe {
    width: 100%;
    height: 200px;
    border-radius: 8px;
    border: none;
}

details {
    margin-bottom: 8px;
}

summary {
    cursor: pointer;
    font-weight: 500;
    color: #4299e1;
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
}

summary:hover {
    color: #313cce;
}

.ingredients-list,
.steps-list {
    padding: 12px 0;
    line-height: 1.6;
    color: #3182ce;
}

.step {
    margin-bottom: 8px;
    padding-left: 16px;
    position: relative;
}

.step::before {
    content: counter(step-counter);
    counter-increment: step-counter;
    position: absolute;
    left: 0;
    top: 0;
    background: #4299e1;
    color: rgb(255, 255, 255);
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
}

.steps-list {
    counter-reset: step-counter;
}

/* å°è¦½åˆ†é  */
.nav-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.nav-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
    font-weight: 500;
}

.nav-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.nav-btn.active {
    background: rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.page {
    display: none;
}

.page.active {
    display: block;
}

/* ç©ºç‹€æ…‹ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255, 255, 255, 0.7);
}

.empty-state .icon {
    font-size: 4rem;
    margin-bottom: 20px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: rgba(255, 255, 255, 0.8);
}

.loading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

/* è¡¨å–®æ¨£å¼ */
.add-recipe-form {
    text-align: left;
}

.form-section {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
    backdrop-filter: blur(10px);
}

.form-section h3 {
    color: white;
    margin-bottom: 16px;
    font-size: 1.1rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group label {
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    margin-bottom: 6px;
}

.tags-input {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.tags-display {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.tag-chip {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.9);
    color: #4a5568;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.tag-chip:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-1px);
}

.ingredient-item,
.step-item {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
}

.ingredient-item input,
.step-item input {
    flex: 1;
}

.add-btn,
.remove-btn,
.btn {
    cursor: pointer;
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.add-btn {
    background: rgba(255, 255, 255, 0.9);
    color: #2d3748;
    margin-top: 8px;
}

.add-btn:hover {
    background: white;
    transform: translateY(-1px);
}

.remove-btn {
    background: #fed7d7;
    color: #822727;
    padding: 6px 12px;
    font-size: 0.85rem;
}

.remove-btn:hover {
    background: #fbb6ce;
}

.btn-primary {
    background: #4299e1;
    color: #fff;
    padding: 12px 24px;
}

.btn-primary:hover {
    background: #3182ce;
    transform: translateY(-2px);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 12px 24px;
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

.success-message {
    display: none;
    background: rgba(72, 187, 120, 0.9);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

/* Topbar æ¨£å¼ */
.topbar {
    position: sticky;
    top: 0;
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.brand {
    font-weight: 600;
    color: #2d3748;
    font-size: 1.1rem;
}

.topbar .actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-accent {
    background: #cde1ff;
    color: #2d3748;
}

.btn-accent:hover {
    background: #a3d2ff;
}

.btn-danger {
    background: #ffd6d6;
    color: #822727;
}

.btn-danger:hover {
    background: #fbb6ce;
}

.btn-cancel {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-cancel:hover {
    background: #cbd5e0;
}

/* ç·¨è¼¯æŠ½å±œ */
.drawer {
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    width: min(420px, 95vw);
    background: #fff;
    box-shadow: -8px 0 30px rgba(0, 0, 0, 0.15);
    padding: 20px;
    overflow: auto;
    z-index: 1001;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.drawer:not(.hidden) {
    transform: translateX(0);
}

.drawer.hidden {
    transform: translateX(100%);
}

.drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e2e8f0;
}

.drawer-header h3 {
    margin: 0;
    color: #2d3748;
}

.close-x-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #718096;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.close-x-btn:hover {
    background: #f7fafc;
    color: #2d3748;
}

.edit-form label {
    display: block;
    margin: 16px 0 6px;
    font-size: 14px;
    font-weight: 500;
    color: #4a5568;
}

.edit-form input,
.edit-form textarea,
.edit-form select {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: white;
}

.grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.drawer-actions {
    display: flex;
    gap: 8px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #e2e8f0;
}

/* åœ–ç‰‡é è¦½æ¨£å¼ */
#imagePreview img,
#addImagePreview img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

#addImagePreview {
    padding: 8px 0;
    text-align: center;
}

#imagePreview {
    margin: 8px 0;
}

.image-upload-section {
    border: 2px dashed rgba(102, 126, 234, 0.3);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    transition: all 0.3s ease;
}

.image-upload-section:hover {
    border-color: rgba(102, 126, 234, 0.6);
    background: rgba(255, 255, 255, 0.05);
}

/* å‹•ç•« */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    #recipesContainer.recipes-grid {
        grid-template-columns: 1fr !important;
    }

    .filter-row {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .view-toggle {
        justify-self: center;
    }

    h1 {
        font-size: 2rem;
    }

    .recipes-grid {
        grid-template-columns: 1fr;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .topbar {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
    }

    .topbar .actions {
        flex-wrap: wrap;
        justify-content: center;
    }

    .nav-tabs {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .nav-btn {
        width: 200px;
    }

    .drawer {
        width: 100vw;
    }

    .form-actions {
        flex-direction: column;
    }

    .drawer-actions {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 12px;
    }

    .filters {
        padding: 16px;
    }

    .form-section {
        padding: 16px;
    }

    .recipe-card {
        margin: 0;
    }
}

/* å¯¦ç”¨é¡åˆ¥ */
.hidden {
    display: none !important;
}
</style>
</head>

<body>
    <header class="topbar">
        <div class="brand">é£Ÿè­œ WebApp</div>
        <div class="actions">
            <button id="btnPickFolder" class="btn btn-accent" type="button">é¸æ“‡è³‡æ–™å¤¾</button>
            <button id="btnWriteCSV" class="btn btn-accent" type="button">å¯«å…¥ recipes.csv</button>
            <button id="btnExport" class="btn btn-accent" type="button">åŒ¯å‡º CSV</button>
            <span id="saveStatus" style="margin-left:12px;font-size:0.85rem;color:#555;"></span>
        </div>
    </header>

    <div class="container">
        <header>
            <h1>ğŸ³ ç¾é£Ÿé£Ÿè­œç€è¦½</h1>
            <p class="subtitle">æ¢ç´¢ç¾å‘³é£Ÿè­œï¼Œäº«å—æ–™ç†æ™‚å…‰</p>
            <nav class="nav-tabs">
                <button class="nav-btn active" data-page="browse" type="button">ğŸ“– ç€è¦½é£Ÿè­œ</button>
                <button class="nav-btn" data-page="add" type="button">â• æ–°å¢é£Ÿè­œ</button>
            </nav>
        </header>

        <!-- ç€è¦½é  -->
        <div class="page active" id="browsePage">
            <div class="filters">
                <div class="filter-row">
                    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é£Ÿè­œã€é£Ÿææˆ–æ¨™ç±¤..." />
                    <select id="categorySelect">
                        <option value="">ğŸ“‹ å…¨éƒ¨åˆ†é¡</option>
                    </select>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid" type="button">ç¶²æ ¼</button>
                        <button class="view-btn" data-view="list" type="button">åˆ—è¡¨</button>
                    </div>
                </div>
            </div>

            <div class="stats" id="stats">è¼‰å…¥ä¸­...</div>

            <div id="recipesContainer" class="recipes-grid">
                <div class="loading">æ­£åœ¨è¼‰å…¥é£Ÿè­œè³‡æ–™</div>
            </div>
        </div>

        <!-- æ–°å¢é  -->
        <div class="page" id="addPage">
            <div class="add-recipe-form">
                <div class="success-message" id="successMessage">âœ… é£Ÿè­œæ–°å¢æˆåŠŸï¼</div>

                <form id="addRecipeForm">
                    <div class="form-section">
                        <h3>ğŸ“ åŸºæœ¬è³‡è¨Š</h3>
                        <div class="form-group">
                            <label for="recipeTitle">é£Ÿè­œåç¨± *</label>
                            <input type="text" id="recipeTitle" required placeholder="ä¾‹å¦‚ï¼šç•ªèŒ„è‚‰é†¬ç¾©å¤§åˆ©éºµ" />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recipeCategory">åˆ†é¡</label>
                                <select id="recipeCategory">
                                    <option value="">é¸æ“‡åˆ†é¡</option>
                                    <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
                                    <option value="ä¸­å¼">ä¸­å¼</option>
                                    <option value="æ—¥å¼">æ—¥å¼</option>
                                    <option value="éŸ“å¼">éŸ“å¼</option>
                                    <option value="è¥¿å¼">è¥¿å¼</option>
                                    <option value="æ³°å¼">æ³°å¼</option>
                                    <option value="æ¹¯å“">æ¹¯å“</option>
                                    <option value="æ²™æ‹‰">æ²™æ‹‰</option>
                                    <option value="ç”œé»">ç”œé»</option>
                                    <option value="é£²å“">é£²å“</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recipeServings">ä»½é‡</label>
                                <input type="number" id="recipeServings" min="1" placeholder="äººä»½" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="prepTime">æº–å‚™æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                                <input type="number" id="prepTime" min="0" placeholder="15" />
                            </div>
                            <div class="form-group">
                                <label for="cookTime">çƒ¹é£ªæ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                                <input type="number" id="cookTime" min="0" placeholder="30" />
                            </div>
                            <div class="form-group">
                                <label for="calories">ç†±é‡ï¼ˆå¡è·¯é‡Œï¼‰</label>
                                <input type="number" id="calories" min="0" placeholder="500" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ·ï¸ æ¨™ç±¤</h3>
                        <div class="tags-input">
                            <input type="text" id="tagsInput" placeholder="è¼¸å…¥æ¨™ç±¤å¾ŒæŒ‰ Enterï¼ˆä¾‹å¦‚ï¼šå®¶å¸¸èœï¼‰" />
                            <div class="tags-display" id="tagsDisplay"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¥ æ•™å­¸å½±ç‰‡ï¼ˆé¸å¡«ï¼‰</h3>
                        <input type="url" id="recipeYoutube" placeholder="è²¼ YouTube é€£çµï¼Œå¦‚ https://youtu.be/xxxx" />
                    </div>

                    <div class="form-section">
                        <h3>ğŸ¥¬ é£Ÿææ¸…å–®</h3>
                        <div class="ingredients-list" id="ingredientsList">
                            <div class="ingredient-item">
                                <input type="text" placeholder="ä¾‹å¦‚ï¼šç¾©å¤§åˆ©éºµ 200g" required />
                                <button type="button" class="remove-btn"
                                    onclick="app.removeIngredient(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addIngredient()">â• æ–°å¢é£Ÿæ</button>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ‘¨â€ğŸ³ è£½ä½œæ­¥é©Ÿ</h3>
                        <div class="steps-list" id="stepsList">
                            <div class="step-item">
                                <span style="font-weight: bold; min-width: 30px;">1.</span>
                                <input type="text" placeholder="è©³ç´°æè¿°ç¬¬ä¸€å€‹æ­¥é©Ÿ" required />
                                <button type="button" class="remove-btn" onclick="app.removeStep(this)">ç§»é™¤</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addStep()">â• æ–°å¢æ­¥é©Ÿ</button>
                    </div>

                    <div class="form-section">
                        <h3>ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡ï¼ˆé¸å¡«ï¼‰</h3>
                        <div class="form-group">
                            <label for="recipeImageFile">é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</label>
                            <input type="file" id="recipeImageFile" accept="image/*" />
                            <div id="addImagePreview" style="margin-top: 12px;"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.clearForm()">æ¸…ç©ºè¡¨å–®</button>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ å„²å­˜é£Ÿè­œ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <aside id="editDrawer" class="drawer hidden" aria-hidden="true">
        <div class="drawer-header">
            <h3>ç·¨è¼¯é£Ÿè­œ</h3>
            <button id="closeDrawerX" class="close-x-btn" type="button">Ã—</button>
        </div>
        <form id="editForm" class="edit-form">
            <label>æ¨™é¡Œ</label>
            <input name="title" type="text" required>
            
            <label>åˆ†é¡</label>
            <input name="category" type="text">
            
            <label>æ¨™ç±¤ï¼ˆåˆ†è™Ÿåˆ†éš”ï¼‰</label>
            <input name="tags" type="text">
            
            <label>ğŸ¥ YouTube é€£çµ</label>
            <input name="youtube_url" type="url" placeholder="https://youtu.be/xxxx">
            
            <label>é£Ÿæï¼ˆæ¯é …ä»¥ | åˆ†éš”ï¼‰</label>
            <textarea name="ingredients" rows="3"></textarea>
            
            <label>æ­¥é©Ÿï¼ˆå¤šè¡Œï¼‰</label>
            <textarea name="steps" rows="5"></textarea>
            
            <div class="grid-2">
                <div>
                    <label>æº–å‚™ï¼ˆåˆ†é˜ï¼‰</label>
                    <input name="prep_minutes" type="number" min="0">
                </div>
                <div>
                    <label>çƒ¹èª¿ï¼ˆåˆ†é˜ï¼‰</label>
                    <input name="cook_minutes" type="number" min="0">
                </div>
            </div>
            
            <div class="grid-2">
                <div>
                    <label>ä»½é‡</label>
                    <input name="servings" type="number" min="1">
                </div>
                <div>
                    <label>å¡è·¯é‡Œ</label>
                    <input name="calories" type="number" min="0">
                </div>
            </div>
            
            <label>åœ–ç‰‡ç¶²å€æˆ–ä¸Šå‚³æ–°åœ–ç‰‡</label>
            <input name="image_url" type="text" placeholder="ç¾æœ‰åœ–ç‰‡ç¶²å€æˆ–ç›¸å°è·¯å¾‘">
            <input id="imageFile" name="image_file" type="file" accept="image/*">
            
            <div id="imagePreview" style="margin:8px 0;"></div>
            
            <div class="drawer-actions">
                <button id="cancelEdit" class="btn btn-cancel" type="button">å–æ¶ˆ</button>
                <button id="saveRecipe" class="btn" type="button">å„²å­˜</button>
                <button id="deleteRecipe" class="btn btn-danger" type="button">åˆªé™¤</button>
            </div>
        </form>
    </aside>

    <script>
// data.js - ç¯„ä¾‹è³‡æ–™
window.SAMPLE_CSV = `id,title,category,tags,ingredients,steps,prep_minutes,cook_minutes,servings,calories,image_url,youtube_url
R001,ç•ªèŒ„è‚‰é†¬ç¾©å¤§åˆ©éºµ,ä¸»é£Ÿ,ç¾©å¤§åˆ©éºµ;å®¶å¸¸;ç‰›è‚‰,ç¾©å¤§åˆ©éºµ 200g|ç‰›çµè‚‰ 150g|ç•ªèŒ„ç½é ­ 1ç½|è’œé ­ 3ç“£|æ´‹è”¥ åŠé¡†|æ©„æ¬–æ²¹ 2å¤§åŒ™|é¹½ é©é‡|é»‘èƒ¡æ¤’ é©é‡,ç†±é‹ä¸‹æ©„æ¬–æ²¹>çˆ†é¦™è’œé ­æ´‹è”¥>åŠ å…¥ç‰›çµè‚‰ç‚’æ•£>å€’å…¥ç•ªèŒ„ç½é ­>èª¿å‘³ç‡‰ç…®15åˆ†é˜>ç…®å¥½çš„éºµæ¢æ‹Œå…¥é†¬æ±,15,25,2,650,,
R002,å®®ä¿é›ä¸,ä¸­å¼,å·èœ;é›è‚‰;ä¸‹é£¯,é›èƒ¸è‚‰ 300g|èŠ±ç”Ÿç±³ 50g|ä¹¾è¾£æ¤’ 8æ ¹|èŠ±æ¤’ 1èŒ¶åŒ™|è”¥ 2æ ¹|è–‘ 1å¡Š|è’œ 3ç“£|ç”ŸæŠ½ 2å¤§åŒ™|è€æŠ½ 1èŒ¶åŒ™|ç³– 1èŒ¶åŒ™|æ–™é…’ 1å¤§åŒ™|å¤ªç™½ç²‰ 1å¤§åŒ™,é›è‚‰åˆ‡ä¸é†ƒè£½>ç†±æ²¹ç‚¸èŠ±ç”Ÿç±³ç››èµ·>çˆ†é¦™è¾£æ¤’èŠ±æ¤’>ä¸‹é›ä¸ç‚’è‡³è®Šè‰²>åŠ èª¿æ–™ç‚’å‹»>æ’’å…¥èŠ±ç”Ÿç±³å’Œè”¥èŠ±,20,10,3,420,,
R003,æ³•å¼æ´‹è”¥æ¹¯,æ¹¯å“,æ³•å¼;ç´ é£Ÿ;æš–èƒƒ,æ´‹è”¥ 4é¡†|å¥¶æ²¹ 30g|éºµç²‰ 2å¤§åŒ™|é«˜æ¹¯ 1000ml|ç™½é…’ 100ml|ç™¾é‡Œé¦™ é©é‡|æœˆæ¡‚è‘‰ 2ç‰‡|é¹½ é©é‡|é»‘èƒ¡æ¤’ é©é‡|æ³•å¼éºµåŒ… é©é‡|èµ·å¸çµ² é©é‡,æ´‹è”¥åˆ‡çµ²>å¥¶æ²¹ç‚’æ´‹è”¥è‡³ç„¦ç³–è‰²>æ’’éºµç²‰ç‚’å‹»>å€’å…¥é«˜æ¹¯å’Œç™½é…’>åŠ é¦™æ–™ç…®30åˆ†é˜>èª¿å‘³>ç››ç¢—æ”¾éºµåŒ…å’Œèµ·å¸>çƒ¤ç®±çƒ¤è‡³èµ·å¸èåŒ–,10,45,4,280,,`;

class RecipeApp {

  // çµ±ä¸€å­—ä¸²æ¨™æº–åŒ–ï¼šå»ç©ºç™½ + å°å¯«
  norm(v) {
    return (v == null ? "" : String(v)).trim().toLowerCase();
  }

  constructor() {
    this.recipes = [];
    this.filteredRecipes = [];
    this.currentView = 'grid';
    this.editTargetId = null;
    this.updateViewClass?.();  // åˆå§‹å°±å¥—ä¸Š grid
    this.pages = {
      browse: document.getElementById('browsePage'),
      add: document.getElementById('addPage'),
    };
    this.navButtons = Array.from(document.querySelectorAll('.nav-btn'));
    this.successMessage = null;

    // åœ–ç‰‡ blob:ObjectURL å¿«å–
    this.imageURLCache = new Map();

    this.init();
  }

  async init() {
    this.setupEventListeners();
    this.setupNavTabs();
    this.setupAddForm();
    this.setupEditDrawer();
    
    // å˜—è©¦è‡ªå‹•è¼‰å…¥ä¹‹å‰è¨˜ä½çš„è³‡æ–™å¤¾
    const remembered = await this.loadRememberedFolder();
    if (!remembered) {
      this.renderEmptyWithHint();
    }

    // é‡‹æ”¾ blob URL
    window.addEventListener('beforeunload', () => {
      for (const url of this.imageURLCache.values()) URL.revokeObjectURL(url);
      this.imageURLCache.clear();
    });
  }

  // ---------- è³‡æ–™å¤¾è¨˜æ†¶èˆ‡æ¬Šé™ç®¡ç† ----------
  async loadRememberedFolder() {
    if (!window.showDirectoryPicker) return false;
    
    try {
      // å˜—è©¦ä½¿ç”¨ IndexedDB å„²å­˜çš„ handle (Chrome 86+)
      if ('storage' in navigator && 'getDirectory' in navigator.storage) {
        const storedHandle = await this.getStoredDirectoryHandle();
        if (storedHandle) {
          try {
            // æ¸¬è©¦æ¬Šé™
            const testPermission = await storedHandle.queryPermission({ mode: 'readwrite' });
            if (testPermission === 'granted') {
              __recipesDirHandle = storedHandle;
              __imagesDirHandle = await __recipesDirHandle.getDirectoryHandle("images", { create: true });
              await this.afterFolderPicked();
              
              const saveStatus = document.getElementById('saveStatus');
              if (saveStatus) {
                saveStatus.textContent = 'âœ” è‡ªå‹•è¼‰å…¥å·²è¨˜ä½çš„è³‡æ–™å¤¾';
                saveStatus.style.color = '#059669';
              }
              return true;
            }
          } catch (e) {
            console.warn('ç„¡æ³•ä½¿ç”¨å·²å„²å­˜çš„è³‡æ–™å¤¾æ¬Šé™:', e);
          }
        }
      }
      
      // å‚™ç”¨ï¼šé¡¯ç¤ºä¸Šæ¬¡ä½¿ç”¨çš„è³‡æ–™å¤¾æç¤º
      const rememberedHandle = localStorage.getItem('recipe-folder-handle');
      if (rememberedHandle) {
        const folderInfo = JSON.parse(rememberedHandle);
        if (folderInfo && folderInfo.name) {
          const stats = document.getElementById('stats');
          stats.innerHTML = `ä¸Šæ¬¡ä½¿ç”¨çš„è³‡æ–™å¤¾ï¼š<strong>${folderInfo.name}</strong><br>è«‹é‡æ–°é¸æ“‡åŒä¸€å€‹è³‡æ–™å¤¾ä»¥é–‹å§‹ä½¿ç”¨ã€‚`;
          return false;
        }
      }
    } catch (error) {
      console.warn('ç„¡æ³•è¼‰å…¥è¨˜ä½çš„è³‡æ–™å¤¾:', error);
    }
    return false;
  }

  async getStoredDirectoryHandle() {
    try {
      return await new Promise((resolve, reject) => {
        const request = indexedDB.open('RecipeAppDB', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['folders'], 'readonly');
          const store = transaction.objectStore('folders');
          const getRequest = store.get('mainFolder');
          getRequest.onsuccess = () => resolve(getRequest.result?.handle);
          getRequest.onerror = () => resolve(null);
        };
        request.onupgradeneeded = () => {
          const db = request.result;
          if (!db.objectStoreNames.contains('folders')) {
            db.createObjectStore('folders');
          }
        };
      });
    } catch (error) {
      console.warn('ç„¡æ³•å¾ IndexedDB å–å¾—è³‡æ–™å¤¾:', error);
      return null;
    }
  }

  async storeDirectoryHandle(handle) {
    try {
      return await new Promise((resolve, reject) => {
        const request = indexedDB.open('RecipeAppDB', 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          const db = request.result;
          const transaction = db.transaction(['folders'], 'readwrite');
          const store = transaction.objectStore('folders');
          store.put({ handle: handle }, 'mainFolder');
          transaction.oncomplete = () => resolve(true);
          transaction.onerror = () => reject(transaction.error);
        };
        request.onupgradeneeded = () => {
          const db = request.result;
          if (!db.objectStoreNames.contains('folders')) {
            db.createObjectStore('folders');
          }
        };
      });
    } catch (error) {
      console.warn('ç„¡æ³•å„²å­˜è³‡æ–™å¤¾åˆ° IndexedDB:', error);
      return false;
    }
  }

  rememberFolder(handle) {
    try {
      // å„²å­˜åˆ° IndexedDB (è¼ƒæ–°ç€è¦½å™¨)
      this.storeDirectoryHandle(handle).catch(() => {
        console.warn('ç„¡æ³•å°‡è³‡æ–™å¤¾å„²å­˜åˆ° IndexedDB');
      });
      
      // å‚™ç”¨ï¼šè¨˜ä½è³‡æ–™å¤¾åç¨±åˆ° localStorage
      const folderInfo = {
        name: handle.name,
        timestamp: Date.now()
      };
      localStorage.setItem('recipe-folder-handle', JSON.stringify(folderInfo));
    } catch (error) {
      console.warn('ç„¡æ³•è¨˜ä½è³‡æ–™å¤¾:', error);
    }
  }

  // ---------- ç©©å®š UIï¼šé¿å…é‡ç¹ªå¾Œã€Œè·³ç‰ˆã€ ----------
  captureUIState() {
    return {
      scrollY: window.scrollY,
      search: document.getElementById('searchInput')?.value || '',
      category: document.getElementById('categorySelect')?.value || '',
      view: this.currentView
    };
  }
  restoreUIState(state) {
    if (!state) return;
    const s = document.getElementById('searchInput');
    const c = document.getElementById('categorySelect');
    if (s && s.value !== state.search) s.value = state.search;
    if (c && c.value !== state.category) c.value = state.category;
    this.currentView = state.view || 'grid';
    this.updateViewClass();
    requestAnimationFrame(() => window.scrollTo({ top: state.scrollY, left: 0, behavior: 'auto' }));
  }
  async withStableUI(updaterFn) {
    const ui = this.captureUIState();
    await Promise.resolve(updaterFn?.());
    this.render();
    this.restoreUIState(ui);
  }
  // ---------------------------------------------------

  renderEmptyWithHint() {
    const stats = document.getElementById('stats');
    stats.textContent = 'è«‹å…ˆæŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ä»¥è¼‰å…¥æœ¬åœ° recipes.csv';

    const container = document.getElementById('recipesContainer');
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">ğŸ“‚</div>
        <h3>å°šæœªé¸æ“‡è³‡æ–™å¤¾</h3>
        <p>è«‹é»ä¸Šæ–¹ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ï¼Œæœ¬ App å°‡è®€å–è©²è³‡æ–™å¤¾ä¸­çš„ <code>recipes.csv</code> èˆ‡ <code>images/</code> åœ–ç‰‡ã€‚</p>
      </div>`;
  }

  // ====== File System Accessï¼šè³‡æ–™å¤¾é¸æ“‡èˆ‡ CSV è¼‰å…¥ ======
  async afterFolderPicked() {
    await this.ensureCSVExists();     // è‹¥æ²’æœ‰ recipes.csv å°±å»ºç«‹
    await this.loadCSVFromLocal();    // è®€å…¥æœ¬åœ° CSV
    this.filteredRecipes = [...this.recipes];
    this.updateCategories();
    this.render();
  }

  async ensureCSVExists() {
    try {
      const fh = await __recipesDirHandle.getFileHandle('recipes.csv');
      // æª”æ¡ˆå­˜åœ¨ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºç©ºæª”æ¡ˆ
      const file = await fh.getFile();
      const text = await file.text();
      
      // å¦‚æœæª”æ¡ˆå®Œå…¨ç©ºç™½æˆ–åªæœ‰ BOMï¼Œæ‰å‰µå»ºæ¨™é¡Œåˆ—
      const cleanText = text.replace(/^\uFEFF/, '').trim(); // ç§»é™¤ BOM
      if (!cleanText) {
        console.log('ç™¼ç¾ç©ºçš„ recipes.csvï¼Œæ·»åŠ æ¨™é¡Œåˆ—');
        const headers = ["id","title","category","tags","ingredients","steps","prep_minutes","cook_minutes","servings","calories","image_url","youtube_url"];
        const bom = "\uFEFF";
        const csvText = bom + headers.join(",") + "\r\n";
        await writeFile(fh, new Blob([csvText], { type: "text/csv;charset=utf-8" }));
      }
    } catch (e) {
      if (e.name === 'NotFoundError') {
        // æª”æ¡ˆä¸å­˜åœ¨ â†’ å»ºç«‹ with headerï¼ˆå« BOM + CRLFï¼‰
        console.log('recipes.csv ä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°æª”æ¡ˆ');
        const headers = ["id","title","category","tags","ingredients","steps","prep_minutes","cook_minutes","servings","calories","image_url","youtube_url"];
        const bom = "\uFEFF";
        const csvText = bom + headers.join(",") + "\r\n";
        const fh = await __recipesDirHandle.getFileHandle("recipes.csv", { create: true });
        await writeFile(fh, new Blob([csvText], { type: "text/csv;charset=utf-8" }));
      } else {
        console.error('æª¢æŸ¥ CSV æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
        throw e;
      }
    }
  }

  async loadCSVFromLocal() {
    try {
      const fh = await __recipesDirHandle.getFileHandle('recipes.csv');
      const file = await fh.getFile();
      const text = await file.text();
      
      console.log('è¼‰å…¥ CSV æª”æ¡ˆå¤§å°:', text.length, 'å­—å…ƒ');
      
      if (!text || text.trim().length === 0) {
        console.log('CSV æª”æ¡ˆæ˜¯ç©ºçš„');
        this.recipes = [];
        return;
      }
      
      const parsed = Papa.parse(text, { 
        header: true, 
        skipEmptyLines: true,
        transformHeader: (header) => header.trim() // æ¸…ç†æ¨™é¡Œ
      });
      
      if (parsed.errors && parsed.errors.length > 0) {
        console.warn('CSV è§£æè­¦å‘Š:', parsed.errors);
      }
      
      // ç¢ºä¿æ¯ç­†éƒ½æœ‰ idï¼ˆè‹¥ç©ºæª”å°±çµ¦æ–° idï¼‰
      this.recipes = (parsed.data || []).map((x, i) => {
        // éæ¿¾æ‰å®Œå…¨ç©ºç™½çš„è¡Œ
        const hasData = Object.values(x).some(val => val && String(val).trim());
        if (!hasData) return null;
        
        return {
          ...x,
          id: x.id && String(x.id).trim() ? x.id : this.makeId(i)
        };
      }).filter(Boolean); // ç§»é™¤ null é …ç›®
      
      console.log('æˆåŠŸè¼‰å…¥', this.recipes.length, 'ç­†é£Ÿè­œ');
      
      if (this.recipes.length === 0) {
        const stats = document.getElementById('stats');
        stats.textContent = 'CSV æª”æ¡ˆå·²è¼‰å…¥ï¼Œä½†æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é£Ÿè­œè³‡æ–™';
      }
    } catch (e) {
      console.error('è®€å–æœ¬åœ° recipes.csv å¤±æ•—ï¼š', e);
      
      // æ›´å…·é«”çš„éŒ¯èª¤è™•ç†
      if (e.name === 'NotFoundError') {
        alert('æ‰¾ä¸åˆ° recipes.csv æª”æ¡ˆï¼Œå°‡å»ºç«‹æ–°çš„ç©ºæª”æ¡ˆã€‚');
      } else if (e.name === 'NotAllowedError') {
        alert('æ²’æœ‰æ¬Šé™è®€å– recipes.csvï¼Œè«‹é‡æ–°é¸æ“‡è³‡æ–™å¤¾ã€‚');
      } else {
        alert(`è®€å– recipes.csv å¤±æ•—ï¼š${e.message}ã€‚è«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚`);
      }
      
      this.recipes = [];
    }
  }

  makeId(idx = 0) {
    // ä»¥ç›®å‰é™£åˆ—é•·åº¦ + idx ç”Ÿæˆ
    return 'R' + String(this.recipes.length + idx + 1).padStart(3, '0');
  }

  setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const viewButtons = document.querySelectorAll('.view-btn');

    // æœå°‹è¼¸å…¥ï¼šinput + compositionendï¼ˆä¸­æ–‡è¼¸å…¥æ³•ï¼‰
    if (searchInput) {
      const onSearch = () => this.filterRecipes();
      searchInput.addEventListener('input', onSearch);
      searchInput.addEventListener('compositionend', onSearch);
    } else {
      console.warn('[RecipeApp] æ‰¾ä¸åˆ° #searchInputï¼Œè«‹ç¢ºèª HTML id æ˜¯å¦æ­£ç¢º');
    }

    // é¡åˆ¥ç¯©é¸
    if (categorySelect) {
      categorySelect.addEventListener('change', () => this.filterRecipes());
    } else {
      console.warn('[RecipeApp] æ‰¾ä¸åˆ° #categorySelect');
    }

    // æª¢è¦–åˆ‡æ›
    viewButtons.forEach((btn) => {
      btn.addEventListener('click', (e) => {
        viewButtons.forEach((b) => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        this.currentView = e.currentTarget.dataset.view;
        this.updateViewClass();
      });
    });
  }

  setupNavTabs() {
    this.navButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        this.navButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');

        const pageKey = btn.dataset.page; // "browse" | "add"
        Object.values(this.pages).forEach((p) => p.classList.remove('active'));
        if (this.pages[pageKey]) this.pages[pageKey].classList.add('active');

        if (pageKey === 'add' && this.successMessage) {
          this.successMessage.style.display = 'none';
        }
      });
    });
  }

  setupAddForm() {
    const form = document.getElementById('addRecipeForm');
    this.successMessage = document.getElementById('successMessage');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!__recipesDirHandle || !__imagesDirHandle) {
        alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾ï¼Œè«‹å…ˆæŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ã€‚');
        return;
      }

      const title = document.getElementById('recipeTitle').value.trim();
      const category = document.getElementById('recipeCategory').value.trim();
      const servings = document.getElementById('recipeServings').value.trim();
      const prep = document.getElementById('prepTime').value.trim();
      const cook = document.getElementById('cookTime').value.trim();
      const calories = document.getElementById('calories').value.trim();
      const youtube = document.getElementById('recipeYoutube')?.value?.trim() || '';

      const tagsInput = document.getElementById('tagsInput').value.trim();
      const chips = Array.from(document.querySelectorAll('#tagsDisplay .tag-chip')).map((x) => x.dataset.tag);
      const tags = [...chips, ...(tagsInput ? [tagsInput] : [])].join(';');

      const ingredients = Array.from(document.querySelectorAll('#ingredientsList .ingredient-item input'))
        .map((i) => i.value.trim()).filter(Boolean).join('|');

      const steps = Array.from(document.querySelectorAll('#stepsList .step-item input'))
        .map((i) => i.value.trim()).filter(Boolean).join('>');

      if (!title) { alert('è«‹è¼¸å…¥é£Ÿè­œåç¨±'); return; }
      if (!ingredients) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …é£Ÿæ'); return; }
      if (!steps) { alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æ­¥é©Ÿ'); return; }

      const newId = this.makeId();

      // åƒ…æœ¬åœ°ï¼šä¸Šå‚³åœ–ç‰‡ â†’ images/ ç”¢ç”Ÿæª”å â†’ CSV å­˜ç›¸å°è·¯å¾‘
      let imageUrl = '';
      const imageFile = document.getElementById('recipeImageFile').files[0];
      if (imageFile) {
        try {
          const result = await saveImageToLocalFolder(imageFile, newId);
          if (result.ok) imageUrl = result.relativePath;
        } catch (err) {
          console.error('åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤:', err);
          alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼›ä½ ä»å¯ç¨å¾Œåœ¨ç·¨è¼¯ä¸­è£œä¸Šåœ–ç‰‡ã€‚');
        }
      }

      const newRecipe = {
        id: newId,
        title,
        category,
        tags,
        ingredients,
        steps,
        prep_minutes: prep || '0',
        cook_minutes: cook || '0',
        servings: servings || '',
        calories: calories || '',
        image_url: imageUrl,
        youtube_url: youtube,
      };

      await this.withStableUI(() => {
        this.recipes.unshift(newRecipe);
        this.filteredRecipes = this.recipes;
      });

      // ç«‹åˆ»å¯«å›æœ¬åœ° CSV
      await writeCSVToLocal();

      this.successMessage.style.display = 'block';
      const browseBtn = this.navButtons.find((b) => b.dataset.page === 'browse');
      browseBtn?.click();
      this.clearForm();
    });

    // æ¨™ç±¤ chip
    const tagsInput = document.getElementById('tagsInput');
    const tagsDisplay = document.getElementById('tagsDisplay');
    tagsInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && tagsInput.value.trim()) {
        e.preventDefault();
        const tag = tagsInput.value.trim();
        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.dataset.tag = tag;
        chip.textContent = `#${tag} Ã—`;
        chip.addEventListener('click', () => chip.remove());
        tagsDisplay.appendChild(chip);
        tagsInput.value = '';
      }
    });

    // æ–°å¢é ï¼šåœ–ç‰‡é è¦½
    const addImageInput = document.getElementById('recipeImageFile');
    const addImagePreview = document.getElementById('addImagePreview');
    addImageInput.addEventListener('change', (e) => {
      addImagePreview.innerHTML = '';
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        const img = document.createElement('img');
        img.src = url;
        Object.assign(img.style, {
          maxWidth: '200px', maxHeight: '150px', borderRadius: '8px', objectFit: 'cover'
        });
        addImagePreview.appendChild(img);
      }
    });
  }

  setupEditDrawer() {
    const drawer = document.getElementById('editDrawer');
    const closeBtn = document.getElementById('closeDrawer'); // åŸæœ¬çš„é—œé–‰æŒ‰éˆ•ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
    const closeXBtn = document.getElementById('closeDrawerX'); // æ–°çš„ X æŒ‰éˆ•
    const cancelBtn = document.getElementById('cancelEdit'); // æ–°çš„å–æ¶ˆæŒ‰éˆ•
    const saveBtn = document.getElementById('saveRecipe');
    const deleteBtn = document.getElementById('deleteRecipe');

    const closeDrawer = () => {
      drawer.classList.add('hidden');
      drawer.setAttribute('aria-hidden', 'true');
      this.editTargetId = null;
    };

    // ç¶å®šæ‰€æœ‰é—œé–‰æŒ‰éˆ•
    if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
    if (closeXBtn) closeXBtn.addEventListener('click', closeDrawer);
    if (cancelBtn) cancelBtn.addEventListener('click', closeDrawer);

    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!__recipesDirHandle) { alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾'); return; }
      await this.saveEditedRecipe();
      await writeCSVToLocal(); // å„²å­˜å¾Œç«‹åˆ»å¯«å›
    });

    deleteBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!__recipesDirHandle) { alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾'); return; }
      if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é£Ÿè­œå—ï¼Ÿ')) {
        this.deleteRecipe();
        await writeCSVToLocal(); // åˆªé™¤å¾Œç«‹åˆ»å¯«å›
      }
    });
  }

  editRecipe(id) {
    if (!__recipesDirHandle) { alert('å°šæœªé¸æ“‡è³‡æ–™å¤¾'); return; }

    const recipe = this.recipes.find(r => r.id === id);
    if (!recipe) return;

    this.editTargetId = id;
    const drawer = document.getElementById('editDrawer');
    const form = document.getElementById('editForm');

    form.title.value = recipe.title || '';
    form.category.value = recipe.category || '';
    form.tags.value = recipe.tags || '';
    form.youtube_url.value = recipe.youtube_url || '';
    form.ingredients.value = (recipe.ingredients || '').replace(/\|/g, '\n');
    form.steps.value = (recipe.steps || '').replace(/>/g, '\n');
    form.prep_minutes.value = recipe.prep_minutes || '';
    form.cook_minutes.value = recipe.cook_minutes || '';
    form.servings.value = recipe.servings || '';
    form.calories.value = recipe.calories || '';
    form.image_url.value = recipe.image_url || '';

    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    if (recipe.image_url) {
      this.resolveImageURL(recipe.image_url).then(src => {
        if (!src) return;
        const img = document.createElement('img');
        img.src = src;
        Object.assign(img.style, { maxWidth: '100%', borderRadius: '8px', marginBottom: '8px' });
        preview.appendChild(img);

        const caption = document.createElement('div');
        caption.textContent = 'ç›®å‰çš„åœ–ç‰‡';
        Object.assign(caption.style, { fontSize: '0.9rem', color: '#666' });
        preview.appendChild(caption);
      }).catch(() => { });
    }

    drawer.classList.remove('hidden');
    drawer.setAttribute('aria-hidden', 'false');
  }

  async saveEditedRecipe() {
    const form = document.getElementById('editForm');
    const index = this.recipes.findIndex(r => r.id === this.editTargetId);
    if (index === -1) return;

    let imageUrl = form.image_url.value.trim();

    // æ–°ä¸Šå‚³åœ–ç‰‡ â†’ è¦†è“‹/æ–°å¢
    const imageFile = document.getElementById('imageFile').files[0];
    if (imageFile) {
      try {
        const result = await saveImageToLocalFolder(imageFile, this.editTargetId);
        if (result.ok) imageUrl = result.relativePath;
      } catch (err) {
        console.error('åœ–ç‰‡ä¸Šå‚³éŒ¯èª¤:', err);
        alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼›å°‡æ²¿ç”¨åŸåœ–ç‰‡ç¶²å€/è·¯å¾‘ã€‚');
      }
    }

    this.recipes[index] = {
      ...this.recipes[index],
      title: form.title.value.trim(),
      category: form.category.value.trim(),
      tags: form.tags.value.trim(),
      youtube_url: form.youtube_url.value.trim(),
      ingredients: form.ingredients.value.trim().replace(/\n/g, '|'),
      steps: form.steps.value.trim().replace(/\n/g, '>'),
      prep_minutes: form.prep_minutes.value || '0',
      cook_minutes: form.cook_minutes.value || '0',
      servings: form.servings.value || '',
      calories: form.calories.value || '',
      image_url: imageUrl,
    };

    await this.withStableUI(() => {
      this.filteredRecipes = this.recipes; // ä¸å†å‘¼å« filterRecipes()ï¼Œé¿å…äºŒæ¬¡é‡ç¹ª
    });

    const drawer = document.getElementById('editDrawer');
    drawer.classList.add('hidden');
    drawer.setAttribute('aria-hidden', 'true');
    this.editTargetId = null;
  }

  deleteRecipe() {
    const index = this.recipes.findIndex(r => r.id === this.editTargetId);
    if (index !== -1) {
      this.withStableUI(() => {
        this.recipes.splice(index, 1);
        this.filteredRecipes = this.recipes;
      });
      const drawer = document.getElementById('editDrawer');
      drawer.classList.add('hidden');
      drawer.setAttribute('aria-hidden', 'true');
      this.editTargetId = null;
    }
  }

  // ===== å‹•æ…‹æ¬„ä½ =====
  addIngredient() {
    const wrap = document.getElementById('ingredientsList');
    const div = document.createElement('div');
    div.className = 'ingredient-item';
    div.innerHTML = `
      <input type="text" placeholder="ä¾‹å¦‚ï¼šç•ªèŒ„ 2é¡†" required />
      <button type="button" class="remove-btn">ç§»é™¤</button>`;
    div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
    wrap.appendChild(div);
  }
  removeIngredient(btn) {
    btn.closest('.ingredient-item')?.remove();
  }

  addStep() {
    const wrap = document.getElementById('stepsList');
    const idx = wrap.querySelectorAll('.step-item').length + 1;
    const div = document.createElement('div');
    div.className = 'step-item';
    div.innerHTML = `
      <span style="font-weight:bold;min-width:30px;">${idx}.</span>
      <input type="text" placeholder="è©³ç´°æè¿°æ­¥é©Ÿ" required />
      <button type="button" class="remove-btn">ç§»é™¤</button>`;
    div.querySelector('.remove-btn').addEventListener('click', () => {
      div.remove();
      Array.from(wrap.querySelectorAll('.step-item span')).forEach((s, i) => (s.textContent = (i + 1) + '.'));
    });
    wrap.appendChild(div);
  }
  removeStep(btn) {
    btn.closest('.step-item')?.remove();
  }

  clearForm() {
    document.getElementById('addRecipeForm').reset();
    document.getElementById('tagsDisplay').innerHTML = '';
    document.getElementById('addImagePreview').innerHTML = '';
    document.getElementById('recipeYoutube').value = '';
    document.getElementById('ingredientsList').innerHTML = `
      <div class="ingredient-item">
        <input type="text" placeholder="ä¾‹å¦‚ï¼šç¾©å¤§åˆ©éºµ 200g" required />
        <button type="button" class="remove-btn" onclick="app.removeIngredient(this)">ç§»é™¤</button>
      </div>`;
    document.getElementById('stepsList').innerHTML = `
      <div class="step-item">
        <span style="font-weight: bold; min-width: 30px;">1.</span>
        <input type="text" placeholder="è©³ç´°æè¿°ç¬¬ä¸€å€‹æ­¥é©Ÿ" required />
        <button type="button" class="remove-btn" onclick="app.removeStep(this)">ç§»é™¤</button>
      </div>`;
  }

  updateCategories() {
    const categorySelect = document.getElementById('categorySelect');
    if (!categorySelect) return;
    const categories = [...new Set(
      this.recipes.map(r => (r.category || '').trim()).filter(Boolean)
    )].sort();

    // æ¸…ç†èˆŠé¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹ã€Œå…¨éƒ¨ã€ï¼‰
    categorySelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());

    categories.forEach((category) => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categorySelect.appendChild(option);
    });
  }

  filterRecipes() {
    const ui = this.captureUIState();

    const searchTerm = this.norm(document.getElementById('searchInput')?.value || '');
    const selectedCategoryRaw = document.getElementById('categorySelect')?.value || '';
    const selectedCategory = (selectedCategoryRaw || '').trim(); // åˆ†é¡ç”¨åš´æ ¼ç­‰è™Ÿï¼Œä½†å…ˆ trim

    if (!Array.isArray(this.recipes)) this.recipes = [];

    this.filteredRecipes = this.recipes.filter((r) => {
      const title = this.norm(r?.title);
      const tags = this.norm(r?.tags);
      const ingredients = this.norm(r?.ingredients);
      const category = (r?.category || '').trim();

      const matchesSearch =
        !searchTerm ||
        title.includes(searchTerm) ||
        tags.includes(searchTerm) ||
        ingredients.includes(searchTerm);

      const matchesCategory = !selectedCategory || category === selectedCategory;

      return matchesSearch && matchesCategory;
    });

    this.render();
    this.restoreUIState(ui);
  }

  updateViewClass() {
    const container = document.getElementById('recipesContainer');
    container.className = this.currentView === 'grid' ? 'recipes-grid' : 'recipes-list';
  }

  render() {
    this.updateStats();
    this.renderRecipes();
    this.updateViewClass();
  }

  updateStats() {
    const stats = document.getElementById('stats');
    const total = this.recipes.length;
    const showing = this.filteredRecipes.length;
    stats.textContent = `é¡¯ç¤º ${showing} / ${total} é“é£Ÿè­œ`;
  }

  // åªèµ°æœ¬åœ°è³‡æ–™å¤¾ï¼šæŠŠ CSV å…§çš„ image_urlï¼ˆimages/æª”åæˆ– æª”åï¼‰è½‰ç‚º blob URL
  async resolveImageURL(value) {
    if (!value) return '';
    const v = String(value).trim();
    if (/^(data:|blob:)/i.test(v)) return v; // ä»å…è¨± data/blob
    if (!__imagesDirHandle) return ''; // å°šæœªé¸è³‡æ–™å¤¾ â†’ å…ˆä¸é¡¯ç¤º

    const name = v.replace(/^images\//i, '');
    if (this.imageURLCache.has(name)) return this.imageURLCache.get(name);

    try {
      const fh = await __imagesDirHandle.getFileHandle(name);
      const file = await fh.getFile();
      const url = URL.createObjectURL(file);
      this.imageURLCache.set(name, url);
      return url;
    } catch (e) {
      console.warn('æ‰¾ä¸åˆ°åœ–ç‰‡æ–¼ images/ï¼š', v);
      return '';
    }
  }

  // YouTube URL è½‰æ›ç‚ºåµŒå…¥æ ¼å¼
  getYouTubeEmbedURL(url) {
    if (!url) return '';
    
    // æå– YouTube å½±ç‰‡ ID
    const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
    const match = url.match(regex);
    
    if (match && match[1]) {
      return `https://www.youtube.com/embed/${match[1]}`;
    }
    
    return '';
  }

  renderRecipes() {
    const container = document.getElementById('recipesContainer');
    if (this.filteredRecipes.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="icon">ğŸ”</div>
          <h3>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é£Ÿè­œ</h3>
          <p>è©¦è‘—èª¿æ•´æœå°‹é—œéµå­—æˆ–åˆ†é¡ç¯©é¸</p>
        </div>`;
      return;
    }

    container.innerHTML = this.filteredRecipes.map((recipe) => {
      const totalMin = (parseInt(recipe.prep_minutes || 0, 10) || 0) + (parseInt(recipe.cook_minutes || 0, 10) || 0);
      const tagsHtml = recipe.tags
        ? recipe.tags.split(';').map((tag) => `<span class="tag">${tag.trim()}</span>`).join('')
        : '';

      const youtubeEmbedURL = this.getYouTubeEmbedURL(recipe.youtube_url);
      const youtubeHtml = youtubeEmbedURL 
        ? `<div class="recipe-video">
             <iframe src="${youtubeEmbedURL}" allowfullscreen></iframe>
           </div>`
        : '';

      return `
      <div class="recipe-card">
        <div class="recipe-image">
          ${recipe.image_url ? `<img data-img="${recipe.id}" alt="${recipe.title}">` : 'ğŸ½ï¸'}
        </div>
        <div class="recipe-content">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h3 class="recipe-title">${recipe.title || ''}</h3>
            <button onclick="app.editRecipe('${recipe.id}')" class="btn" style="font-size: 0.8rem; padding: 4px 8px;">ç·¨è¼¯</button>
          </div>
          <div class="recipe-meta">
            <span class="meta-item">â±ï¸ ${totalMin} åˆ†é˜</span>
            <span class="meta-item">ğŸ‘¥ ${recipe.servings || 'ï¼Ÿ'} äººä»½</span>
            ${recipe.calories ? `<span class="meta-item">ğŸ”¥ ${recipe.calories} å¡</span>` : ''}
          </div>
          ${tagsHtml ? `<div class="recipe-tags">${tagsHtml}</div>` : ''}
          ${youtubeHtml}
          <div class="recipe-details">
            <details>
              <summary>ğŸ“ é£Ÿææ¸…å–®</summary>
              <div class="ingredients-list">
                ${(recipe.ingredients || '').split('|').map((i) => `<div>â€¢ ${i.trim()}</div>`).join('')}
              </div>
            </details>
            <details>
              <summary>ğŸ‘¨â€ğŸ³ è£½ä½œæ­¥é©Ÿ</summary>
              <div class="steps-list">
                ${(recipe.steps || '').split('>').map((s) => `<div class="step">${s.trim()}</div>`).join('')}
              </div>
            </details>
          </div>
        </div>
      </div>`;
    }).join('');

    // ç•°æ­¥è£œåœ–ï¼ˆåªèƒ½åœ¨å·²é¸è³‡æ–™å¤¾å¾Œï¼‰
    if (__imagesDirHandle) {
      this.filteredRecipes.forEach(async (recipe) => {
        if (!recipe.image_url) return;
        const imgEl = container.querySelector(`img[data-img="${recipe.id}"]`);
        if (!imgEl) return;
        try {
          const src = await this.resolveImageURL(recipe.image_url);
          if (src) imgEl.src = src;
          imgEl.removeAttribute('data-img');
        } catch (e) {
          console.warn('åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼š', recipe.image_url, e);
        }
      });
    }
  }
}

// ====== å•Ÿå‹• ======
const app = new RecipeApp();
window.app = app;

// ====== æœ¬åœ°æª”æ¡ˆç’°å¢ƒè®Šæ•¸ ======
let __recipesDirHandle = null;
let __imagesDirHandle = null;

async function pickRecipesFolder() {
  if (!window.showDirectoryPicker) { 
    alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´é¸æ“‡è³‡æ–™å¤¾ã€‚è«‹æ”¹ç”¨ Chrome/Edgeã€‚"); 
    return; 
  }
  
  try {
    // å¦‚æœå·²ç¶“æœ‰è³‡æ–™å¤¾ï¼Œå…ˆæª¢æŸ¥æ¬Šé™æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
    if (__recipesDirHandle) {
      try {
        const permission = await __recipesDirHandle.queryPermission({ mode: 'readwrite' });
        if (permission === 'granted') {
          const saveStatus = document.getElementById('saveStatus');
          if (saveStatus) {
            saveStatus.textContent = 'âœ” è³‡æ–™å¤¾æ¬Šé™ä»ç„¶æœ‰æ•ˆ';
            saveStatus.style.color = '#059669';
            setTimeout(() => saveStatus.textContent = '', 2000);
          }
          return; // ä¸éœ€è¦é‡æ–°é¸æ“‡
        }
      } catch (e) {
        console.warn('æª¢æŸ¥è³‡æ–™å¤¾æ¬Šé™å¤±æ•—:', e);
      }
    }
    
    __recipesDirHandle = await window.showDirectoryPicker({ mode: "readwrite" });
    __imagesDirHandle = await __recipesDirHandle.getDirectoryHandle("images", { create: true });
    
    // è¨˜ä½é€™å€‹è³‡æ–™å¤¾
    app.rememberFolder(__recipesDirHandle);
    
    // é¡¯ç¤ºå„²å­˜ç‹€æ…‹
    const saveStatus = document.getElementById('saveStatus');
    if (saveStatus) {
      saveStatus.textContent = 'âœ” è³‡æ–™å¤¾å·²é¸æ“‡ä¸¦è¨˜ä½';
      saveStatus.style.color = '#059669';
    }
    
    await app.afterFolderPicked();
  } catch (e) { 
    if (e.name !== 'AbortError') { // ç”¨æˆ¶å–æ¶ˆä¸ç®—éŒ¯èª¤
      console.error(e);
      const saveStatus = document.getElementById('saveStatus');
      if (saveStatus) {
        saveStatus.textContent = 'âœ– é¸æ“‡è³‡æ–™å¤¾å¤±æ•—';
        saveStatus.style.color = '#dc2626';
      }
    }
  }
}

async function writeFile(handle, data) {
  const w = await handle.createWritable();
  await w.write(data);
  await w.close();
}

function extFromFilename(n) {
  const m = (n || "").match(/\.([a-zA-Z0-9]+)$/);
  return m ? m[1].toLowerCase() : "png";
}

async function saveImageToLocalFolder(file, recipeId) {
  if (!__recipesDirHandle || !__imagesDirHandle) return { ok: false, reason: "NO_DIR" };
  const ext = extFromFilename(file.name);
  const filename = `${recipeId}-${Date.now()}.${ext}`;
  const fh = await __imagesDirHandle.getFileHandle(filename, { create: true });
  await writeFile(fh, await file.arrayBuffer());
  return { ok: true, relativePath: `images/${filename}` };
}

async function writeCSVToLocal() {
  if (!__recipesDirHandle) { 
    alert("å°šæœªé¸æ“‡è³‡æ–™å¤¾ã€‚è«‹å…ˆæŒ‰ã€Œé¸æ“‡è³‡æ–™å¤¾ã€ã€‚");
    return; 
  }
  
  // å®‰å…¨æª¢æŸ¥ï¼šé¿å…ç”¨ç©ºè³‡æ–™è¦†è“‹ç¾æœ‰æª”æ¡ˆ
  try {
    const existingFh = await __recipesDirHandle.getFileHandle('recipes.csv');
    const existingFile = await existingFh.getFile();
    const existingText = await existingFile.text();
    const existingLines = existingText.split('\n').filter(line => line.trim());
    
    // å¦‚æœç¾æœ‰æª”æ¡ˆæœ‰è³‡æ–™ï¼Œä½†æˆ‘å€‘çš„è¨˜æ†¶é«”ä¸­æ²’æœ‰è³‡æ–™ï¼Œç™¼å‡ºè­¦å‘Š
    if (existingLines.length > 1 && (!app.recipes || app.recipes.length === 0)) {
      const confirmOverwrite = confirm(
        `è­¦å‘Šï¼šç¾æœ‰çš„ recipes.csv åŒ…å« ${existingLines.length - 1} ç­†è³‡æ–™ï¼Œ\n` +
        `ä½†ç¨‹å¼è¨˜æ†¶é«”ä¸­æ²’æœ‰è³‡æ–™ã€‚é€™å¯èƒ½æœƒæ¸…ç©ºæ‚¨çš„æª”æ¡ˆã€‚\n\n` +
        `æ˜¯å¦è¦ç¹¼çºŒï¼Ÿå»ºè­°å…ˆé‡æ–°è¼‰å…¥è³‡æ–™ã€‚`
      );
      if (!confirmOverwrite) {
        const saveStatus = document.getElementById('saveStatus');
        if (saveStatus) {
          saveStatus.textContent = 'âš  å„²å­˜å·²å–æ¶ˆä»¥ä¿è­·è³‡æ–™';
          saveStatus.style.color = '#d97706';
          setTimeout(() => saveStatus.textContent = '', 5000);
        }
        return;
      }
    }
  } catch (e) {
    // æª”æ¡ˆä¸å­˜åœ¨æˆ–å…¶ä»–éŒ¯èª¤ï¼Œç¹¼çºŒåŸ·è¡Œ
    console.log('ç„¡æ³•æª¢æŸ¥ç¾æœ‰æª”æ¡ˆï¼Œç¹¼çºŒå¯«å…¥æ–°æª”æ¡ˆ');
  }
  
  const headers = ["id","title","category","tags","ingredients","steps","prep_minutes","cook_minutes","servings","calories","image_url","youtube_url"];
  const esc = (s) => {
    if (s == null) return "";
    s = String(s);
    if (s.includes(",") || s.includes("\"") || s.includes("\n") || s.includes("\r"))
      return `"${s.replace(/"/g, '""')}"`;
    return s;
  };
  
  const lines = [headers.join(",")];
  for (const r of app.recipes || []) { 
    lines.push(headers.map(h => esc(r[h])).join(",")); 
  }

  // åŠ  BOM & CRLF
  const bom = "\uFEFF";
  const csvText = bom + lines.join("\r\n");

  const csvHandle = await __recipesDirHandle.getFileHandle("recipes.csv", { create: true });
  await writeFile(csvHandle, new Blob([csvText], { type: "text/csv;charset=utf-8" }));
  
  // é¡¯ç¤ºå„²å­˜ç‹€æ…‹
  const saveStatus = document.getElementById('saveStatus');
  if (saveStatus) {
    const recipeCount = app.recipes ? app.recipes.length : 0;
    saveStatus.textContent = `âœ” å·²å„²å­˜ ${recipeCount} ç­†è³‡æ–™è‡³æœ¬æ©Ÿ`;
    saveStatus.style.color = '#059669';
    setTimeout(() => {
      saveStatus.textContent = '';
    }, 3000);
  }
}

// ====== é ‚éƒ¨æŒ‰éˆ•ç¶å®šï¼ˆé›¢ç·šé™å®šï¼‰======
document.addEventListener("click", (ev) => {
  const t = ev.target;
  if (!t) return;
  if (t.id === "btnPickFolder") pickRecipesFolder();
  if (t.id === "btnWriteCSV") writeCSVToLocal();
  if (t.id === "btnExport") {
    const headers = ["id","title","category","tags","ingredients","steps","prep_minutes","cook_minutes","servings","calories","image_url","youtube_url"];
    const esc = (s) => {
      if (s == null) return "";
      s = String(s);
      if (s.includes(",") || s.includes("\"") || s.includes("\n") || s.includes("\r"))
        return `"${s.replace(/"/g, '""')}"`;
      return s;
    };
    const lines = [headers.join(",")];
    for (const r of app.recipes) { lines.push(headers.map(h => esc(r[h])).join(",")); }

    const bom = "\uFEFF";
    const csvText = bom + lines.join("\r\n");

    const blob = new Blob([csvText], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "recipes.csv";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
});

// ç·¨è¼¯æŠ½å±œï¼šæ–°åœ–ç‰‡é è¦½
document.addEventListener("change", (ev) => {
  const t = ev.target;
  if (t && t.id === "imageFile") {
    const preview = document.getElementById("imagePreview");
    if (!preview) return;
    preview.innerHTML = "";
    const f = t.files && t.files[0];
    if (!f) return;
    const url = URL.createObjectURL(f);
    const img = document.createElement("img");
    img.src = url;
    Object.assign(img.style, { maxWidth: "100%", borderRadius: "12px" });
    preview.appendChild(img);
    const caption = document.createElement('div');
    caption.textContent = 'æ–°ä¸Šå‚³çš„åœ–ç‰‡é è¦½';
    Object.assign(caption.style, { fontSize: '0.9rem', color: '#666', marginTop: '8px' });
    preview.appendChild(caption);
  }
});

// æš´éœ²å…¨åŸŸ
window.recipes = app.recipes;
window.filteredRecipes = app.filteredRecipes;

(function () {
    function registerSW() {
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./sw.js").catch(console.error);
        }
    }
    function onceReady(fn) {
        if (document.readyState !== "loading") fn();
        else document.addEventListener("DOMContentLoaded", fn);
    }
    onceReady(registerSW);
})();

// å¯åŠæ€§å‹å–„ï¼šç¤ºç¯„å¦‚ä½•åŒæ­¥ aria-hidden
window.drawerA11y = {
    open() {
        const d = document.getElementById('editDrawer');
        d.classList.remove('hidden');
        d.setAttribute('aria-hidden', 'false');
    },
    close() {
        const d = document.getElementById('editDrawer');
        d.classList.add('hidden');
        d.setAttribute('aria-hidden', 'true');
    }
};
</script>

</body>
</html>