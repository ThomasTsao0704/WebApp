<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>æˆ¿è²¸å¯¬é™æœŸå®Œæ•´åˆ†æï½œäº”å¤§æƒ…å¢ƒæ¨¡æ“¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121821;
      --muted: #9bb0c9;
      --accent: #7dc4ff;
      --accent2: #b9ff7d;
      --text: #e6edf6;
      --warn: #ffb84d;
      --danger: #ff6b6b;
      --success: #51cf66;
      --grid: #243242;
      --grace-color: #ffb84d;
      --repay-color: #7dc4ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:15px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .title{font-size:22px;font-weight:700;margin-bottom:14px}
    .subtitle{color:var(--muted);margin-bottom:22px}
    .card{
      background:linear-gradient(180deg,#0f1520 0%,var(--card) 100%);
      border:1px solid #1f2a38;border-radius:16px;padding:16px;margin-bottom:16px
    }
    .grid{display:grid;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:repeat(4,1fr)} }
    @media (min-width:900px){ .grid.stats{grid-template-columns:repeat(3,1fr)} }
    @media (min-width:900px){ .grid.two{grid-template-columns:repeat(2,1fr)} }
    label{display:block;font-weight:600;margin-bottom:6px;font-size:13px}
    input,select{
      width:100%; padding:10px 12px; background:#0b131c;color:var(--text);
      border:1px solid #1f2a38;border-radius:10px;outline:none;font-size:14px
    }
    input:focus,select:focus{border-color:#2e75ff; box-shadow:0 0 0 2px #2e75ff33}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      background:#1b2a41;color:#fff;border:1px solid #2c3f57;
      padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;
      transition:all 0.2s;border:none
    }
    .btn:hover{background:#223452;transform:translateY(-1px)}
    .btn.accent{background:#204d7a;border-color:#2f6ea8}
    .btn.warn{background:#6e4007;border-color:#91560a}
    .btn.success{background:#2d6e3f;border-color:#3d8e4f}
    .btn.danger{background:#6e2020;border-color:#8e3030}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    canvas{background:#0c121a;border-radius:14px;border:1px solid #1f2a38}
    .chart-container{position:relative;height:400px;width:100%}
    @media (max-width:768px){ .chart-container{height:300px} }
    .hint{color:var(--muted);font-size:13px}
    .footer{color:#7e8ea2;margin-top:8px;font-size:12px}
    
    /* åˆ†é ç³»çµ± */
    .tabs{display:flex;gap:8px;margin-bottom:20px;border-bottom:2px solid #1f2a38;overflow-x:auto}
    .tab{
      padding:12px 16px;background:transparent;border:none;color:var(--muted);
      cursor:pointer;font-weight:600;font-size:14px;border-bottom:3px solid transparent;
      transition:all 0.2s;white-space:nowrap
    }
    .tab:hover{color:var(--text);background:rgba(125,196,255,0.05)}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .stat-box{
      background:linear-gradient(135deg,#1a2332 0%,#0f1520 100%);
      border:1px solid #2c3f57;border-radius:12px;padding:14px;
    }
    .stat-label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .stat-value{font-size:20px;font-weight:700;color:var(--text)}
    .stat-sub{font-size:13px;color:var(--muted);margin-top:4px}
    .stat-increase{color:var(--danger);font-weight:600}
    .stat-saving{color:var(--accent2);font-weight:600}
    
    .warning-box{
      background:linear-gradient(135deg,#4a2c0f 0%,#2d1a09 100%);
      border:1px solid #91560a;border-radius:12px;padding:14px;margin-top:12px;
      display:none;
    }
    .warning-box.show{display:block}
    .warning-icon{display:inline-block;margin-right:8px;font-size:18px}
    .warning-text{font-weight:600;color:var(--warn)}
    
    .success-box{
      background:linear-gradient(135deg,#1a3d2e 0%,#0f2419 100%);
      border:1px solid #2d7a52;border-radius:12px;padding:14px;margin-top:12px;
    }
    .success-text{font-weight:600;color:var(--success)}
    
    .legend{display:flex;gap:20px;margin-top:12px;flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:13px}
    .legend-color{width:16px;height:16px;border-radius:4px}
    
    .toggle-section{margin-top:12px;padding-top:12px;border-top:1px solid #1f2a38}
    .checkbox-label{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    input[type="checkbox"]{width:auto;cursor:pointer}
    
    .big-number{font-size:32px;font-weight:700;line-height:1.2}
    .comparison-card{
      background:linear-gradient(135deg,#1a2332 0%,#0f1520 100%);
      border:2px solid #2c3f57;border-radius:12px;padding:20px;margin-bottom:16px
    }
    .vs-divider{
      text-align:center;font-size:24px;font-weight:700;color:var(--muted);
      margin:20px 0;position:relative
    }
    .vs-divider::before,.vs-divider::after{
      content:'';position:absolute;top:50%;width:40%;height:2px;
      background:linear-gradient(to right,transparent,#2c3f57)
    }
    .vs-divider::before{left:0}
    .vs-divider::after{right:0}
    
    .pressure-indicator{
      height:40px;border-radius:10px;position:relative;overflow:hidden;
      background:linear-gradient(to right,var(--success) 0%,var(--warn) 50%,var(--danger) 100%);
      margin:16px 0
    }
    .pressure-marker{
      position:absolute;top:-8px;width:4px;height:56px;background:#fff;
      box-shadow:0 0 10px rgba(255,255,255,0.5);transition:left 0.3s
    }
    .pressure-labels{display:flex;justify-content:space-between;font-size:12px;color:var(--muted)}
    
    /* æ™‚é–“è»¸å‹•ç•« */
    .timeline-display{
      text-align:center;font-size:48px;font-weight:700;margin:20px 0;
      color:var(--accent);text-shadow:0 0 20px rgba(125,196,255,0.5)
    }
    .milestone{
      background:linear-gradient(135deg,#2d4a6e 0%,#1a2d42 100%);
      border:2px solid var(--accent);border-radius:12px;padding:12px;margin:8px 0;
      animation:pulse 2s infinite
    }
    @keyframes pulse{
      0%,100%{box-shadow:0 0 0 rgba(125,196,255,0.4)}
      50%{box-shadow:0 0 20px rgba(125,196,255,0.8)}
    }
    .animation-controls{
      display:flex;gap:10px;justify-content:center;margin:16px 0;flex-wrap:wrap
    }
    .speed-control{
      display:flex;align-items:center;gap:8px;padding:8px 16px;
      background:#1a2332;border-radius:10px;border:1px solid #2c3f57
    }
    
    /* å„€è¡¨æ¿ */
    .gauge-container{
      position:relative;width:250px;height:250px;margin:20px auto
    }
    .gauge-svg{width:100%;height:100%}
    .gauge-bg{fill:none;stroke:#1f2a38;stroke-width:20}
    .gauge-fill{fill:none;stroke-width:20;transition:stroke-dashoffset 0.5s,stroke 0.5s;
      stroke-linecap:round}
    .gauge-text{font-size:48px;font-weight:700;fill:var(--text)}
    .gauge-label{font-size:14px;fill:var(--muted)}
    
    .health-metric{
      background:linear-gradient(135deg,#1a2332 0%,#0f1520 100%);
      border-left:4px solid var(--accent);border-radius:8px;padding:16px;margin:12px 0
    }
    .metric-title{font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between}
    .metric-bar{
      height:24px;background:#0b131c;border-radius:8px;overflow:hidden;position:relative
    }
    .metric-fill{
      height:100%;transition:width 0.5s,background 0.5s;
      display:flex;align-items:center;justify-content:center;
      font-size:12px;font-weight:600
    }
    .metric-info{font-size:13px;color:var(--muted);margin-top:8px}
    
    .dashboard-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">æˆ¿è²¸å¯¬é™æœŸå®Œæ•´åˆ†æç³»çµ±</div>
  <div class="subtitle">äº”å¤§æƒ…å¢ƒæ¨¡æ“¬ï¼šåŸºæœ¬å°æ¯” / å‡æ¯å£“åŠ› / æŠ•è³‡æ©Ÿæœƒ / æ™‚é–“è»¸å‹•ç•« / è²¡å‹™å¥åº·å„€è¡¨æ¿</div>

  <!-- å…±ç”¨åƒæ•¸è¨­å®š -->
  <div class="card">
    <div style="font-weight:700;margin-bottom:12px">åŸºæœ¬åƒæ•¸è¨­å®š</div>
    <div class="grid">
      <div>
        <label>è²¸æ¬¾é‡‘é¡ï¼ˆå…ƒï¼‰</label>
        <input id="loan" type="number" value="10000000" min="100000" step="100000">
      </div>
      <div>
        <label>å¹´åˆ©ç‡ï¼ˆ%ï¼‰</label>
        <input id="rate" type="number" value="2" min="0" max="10" step="0.01">
      </div>
      <div>
        <label>ç¸½å¹´é™ï¼ˆå¹´ï¼‰</label>
        <input id="years" type="number" value="30" min="1" max="40" step="1">
      </div>
      <div>
        <label>å¯¬é™æœŸï¼ˆå¹´ï¼‰</label>
        <input id="grace" type="number" value="5" min="0" max="10" step="1">
      </div>
    </div>
  </div>

  <!-- åˆ†é å°èˆª -->
  <div class="tabs">
    <button class="tab active" data-tab="basic">ğŸ“Š åŸºæœ¬æ¨¡æ“¬</button>
    <button class="tab" data-tab="pressure">ğŸ”¥ å‡æ¯å£“åŠ›</button>
    <button class="tab" data-tab="investment">ğŸ’° æŠ•è³‡æ©Ÿæœƒ</button>
    <button class="tab" data-tab="timeline">ğŸ¬ æ™‚é–“è»¸å‹•ç•«</button>
    <button class="tab" data-tab="dashboard">ğŸ¯ è²¡å‹™å¥åº·</button>
  </div>

  <!-- åˆ†é  1: åŸºæœ¬æ¨¡æ“¬ -->
  <div id="tab-basic" class="tab-content active">
    <div class="card">
      <label class="checkbox-label">
        <input type="checkbox" id="showComparison">
        <span>é¡¯ç¤ºã€Œç„¡å¯¬é™æœŸã€å°æ¯”</span>
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="enableExtraPay">
        <span>å•Ÿç”¨æå‰é‚„æ¬¾æ¨¡æ“¬</span>
      </label>

      <div id="extraPaySection" style="display:none;margin-top:12px">
        <div class="grid" style="grid-template-columns:repeat(2,1fr)">
          <div>
            <label>æ¯å¹´é¡å¤–é‚„æ¬¾ï¼ˆå…ƒï¼‰</label>
            <input id="extraPay" type="number" value="100000" min="0" step="10000">
          </div>
          <div>
            <label>å¾ç¬¬å¹¾å¹´é–‹å§‹é‚„</label>
            <input id="extraStartYear" type="number" value="6" min="1" step="1">
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <button class="btn accent" id="runBasic">ç”Ÿæˆåœ–è¡¨</button>
        <button class="btn" id="downloadBar">ä¸‹è¼‰é•·æ¢åœ–</button>
        <button class="btn" id="downloadLine">ä¸‹è¼‰æŠ˜ç·šåœ–</button>
        <button class="btn" id="exportCsv">åŒ¯å‡º CSV</button>
      </div>
    </div>

    <div id="statsCard" class="card" style="display:none">
      <div style="font-weight:700;margin-bottom:12px">ğŸ“Š é—œéµæ•¸æ“šå°æ¯”</div>
      <div class="grid stats">
        <div class="stat-box">
          <div class="stat-label">å¯¬é™æœŸæœˆç¹³</div>
          <div class="stat-value" id="gracePayment">-</div>
          <div class="stat-sub">ï¼ˆåªç¹³åˆ©æ¯ï¼‰</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">æ”¤é‚„æœŸæœˆç¹³</div>
          <div class="stat-value" id="repayPayment">-</div>
          <div class="stat-sub" id="increasePercent">-</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ç¸½åˆ©æ¯æ”¯å‡º</div>
          <div class="stat-value" id="totalInterest">-</div>
          <div class="stat-sub" id="interestDiff">-</div>
        </div>
      </div>
      <div id="warningBox" class="warning-box">
        <div class="warning-text">
          <span class="warning-icon">âš ï¸</span>
          <span id="warningText"></span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">æ¯æœˆç¹³æ¬¾å°æ¯”é•·æ¢åœ–</div>
        <div class="hint">é¡è‰²å€åˆ†ï¼šå¯¬é™æœŸ vs æ”¤é‚„æœŸ</div>
      </div>
      <div class="chart-container">
        <canvas id="barChart"></canvas>
      </div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background:var(--grace-color)"></div>
          <span>å¯¬é™æœŸï¼ˆåªç¹³åˆ©æ¯ï¼‰</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:var(--repay-color)"></div>
          <span>æ”¤é‚„æœŸï¼ˆæœ¬æ¯æ”¤é‚„ï¼‰</span>
        </div>
        <div class="legend-item" id="noGraceLegend" style="display:none">
          <div class="legend-color" style="background:#9bb0c9"></div>
          <span>ç„¡å¯¬é™æœŸï¼ˆå°æ¯”ï¼‰</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div style="font-weight:700">å‰©é¤˜æœ¬é‡‘æŠ˜ç·šåœ–</div>
        <div class="hint">çœ‹æ¸…æ¥šå¯¬é™æœŸçš„ã€Œæ‹–å»¶æ•ˆæ‡‰ã€</div>
      </div>
      <div class="chart-container">
        <canvas id="lineChart"></canvas>
      </div>
    </div>
  </div>

  <!-- åˆ†é  2: å‡æ¯å£“åŠ›æ¸¬è©¦ -->
  <div id="tab-pressure" class="tab-content">
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">å‡æ¯æƒ…å¢ƒè¨­å®š</div>
      <div class="grid" style="grid-template-columns:repeat(3,1fr)">
        <div>
          <label>æƒ…å¢ƒ 1ï¼šè¼•åº¦å‡æ¯ï¼ˆ%ï¼‰</label>
          <input id="rate1" type="number" value="0.5" min="0" max="5" step="0.25">
        </div>
        <div>
          <label>æƒ…å¢ƒ 2ï¼šä¸­åº¦å‡æ¯ï¼ˆ%ï¼‰</label>
          <input id="rate2" type="number" value="1" min="0" max="5" step="0.25">
        </div>
        <div>
          <label>æƒ…å¢ƒ 3ï¼šé‡åº¦å‡æ¯ï¼ˆ%ï¼‰</label>
          <input id="rate3" type="number" value="2" min="0" max="5" step="0.25">
        </div>
      </div>
      <div style="margin-top:12px">
        <label>ä½ çš„æœˆæ”¶å…¥ï¼ˆå…ƒï¼‰- ç”¨æ–¼è¨ˆç®—è² å‚µæ¯”</label>
        <input id="monthlyIncome" type="number" value="150000" min="0" step="5000">
      </div>
      <button class="btn accent" id="runPressure" style="margin-top:16px">åˆ†æå‡æ¯å½±éŸ¿</button>
    </div>

    <div id="pressureResults" style="display:none">
      <div class="card">
        <div style="font-weight:700;margin-bottom:16px">ğŸ”¥ å‡æ¯å£“åŠ›åˆ†æ</div>
        <div class="comparison-card">
          <div style="color:var(--muted);margin-bottom:8px">ç›®å‰åˆ©ç‡ <span id="currentRate"></span></div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:14px;color:var(--muted)">æ”¤é‚„æœŸæœˆç¹³</div>
              <div class="big-number" id="currentPayment"></div>
            </div>
            <div style="text-align:right">
              <div style="font-size:14px;color:var(--muted)">è² å‚µæ¯”</div>
              <div class="big-number" id="currentRatio"></div>
            </div>
          </div>
        </div>

        <div class="vs-divider">å‡æ¯å¾Œ</div>

        <div id="scenarios"></div>

        <div style="margin-top:20px">
          <div style="font-weight:700;margin-bottom:12px">è²¡å‹™å£“åŠ›æŒ‡æ¨™</div>
          <div class="pressure-indicator">
            <div class="pressure-marker" id="pressureMarker"></div>
          </div>
          <div class="pressure-labels">
            <span>å®‰å…¨ (&lt;30%)</span>
            <span>è­¦æˆ’ (30-50%)</span>
            <span>å±éšª (&gt;50%)</span>
          </div>
        </div>

        <div id="pressureWarning" class="warning-box">
          <div class="warning-text">
            <span class="warning-icon">âš ï¸</span>
            <span id="pressureWarningText"></span>
          </div>
        </div>

        <div id="pressureSuccess" class="success-box" style="display:none">
          <div class="success-text">
            <span style="margin-right:8px">âœ“</span>
            <span id="pressureSuccessText"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:700">å‡æ¯æƒ…å¢ƒæœˆç¹³å°æ¯”</div>
        </div>
        <div class="chart-container">
          <canvas id="pressureChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ†é  3: æŠ•è³‡æ©Ÿæœƒæˆæœ¬ -->
  <div id="tab-investment" class="tab-content">
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">æŠ•è³‡æƒ…å¢ƒè¨­å®š</div>
      <div class="grid" style="grid-template-columns:repeat(2,1fr)">
        <div>
          <label>é æœŸå¹´åŒ–å ±é…¬ç‡ï¼ˆ%ï¼‰</label>
          <input id="returnRate" type="number" value="5" min="0" max="20" step="0.5">
          <div class="hint">ä¾‹å¦‚ï¼šå®šå­˜ 1-2%ã€ETF 5-8%ã€è‚¡ç¥¨ 8-15%</div>
        </div>
        <div>
          <label>æŠ•è³‡æœŸé–“ï¼ˆå¯¬é™æœŸå¹´æ•¸ï¼‰</label>
          <input id="investYears" type="number" value="5" min="1" max="10" step="1" disabled>
          <div class="hint">è‡ªå‹•åŒæ­¥å¯¬é™æœŸå¹´æ•¸</div>
        </div>
      </div>
      <button class="btn accent" id="runInvestment" style="margin-top:16px">è¨ˆç®—æ©Ÿæœƒæˆæœ¬</button>
    </div>

    <div id="investmentResults" style="display:none">
      <div class="card">
        <div style="font-weight:700;margin-bottom:16px">ğŸ’° æŠ•è³‡æ©Ÿæœƒæˆæœ¬åˆ†æ</div>
        
        <div class="comparison-card">
          <div style="font-size:14px;color:var(--muted);margin-bottom:8px">æ–¹æ¡ˆ Aï¼šé¸æ“‡å¯¬é™æœŸ</div>
          <div style="margin-bottom:16px">
            <div style="color:var(--success);margin-bottom:4px">âœ“ å¯¬é™æœŸçœä¸‹çš„éŒ¢æ‹¿å»æŠ•è³‡</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-size:13px;color:var(--muted)">æŠ•è³‡ç´¯ç©é‡‘é¡</div>
                <div class="big-number" style="color:var(--accent2)" id="investTotal"></div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px;color:var(--muted)">å¤šä»˜çš„æˆ¿è²¸åˆ©æ¯</div>
                <div class="big-number" style="color:var(--danger)" id="extraInterest"></div>
              </div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #2c3f57">
              <div style="font-size:13px;color:var(--muted)">æ·¨æ”¶ç›Š</div>
              <div class="big-number" id="netGainA"></div>
            </div>
          </div>
        </div>

        <div class="vs-divider">VS</div>

        <div class="comparison-card">
          <div style="font-size:14px;color:var(--muted);margin-bottom:8px">æ–¹æ¡ˆ Bï¼šä¸é¸å¯¬é™æœŸ</div>
          <div>
            <div style="color:var(--success);margin-bottom:4px">âœ“ ç›´æ¥æœ¬æ¯æ”¤é‚„ï¼Œçœåˆ©æ¯</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div style="font-size:13px;color:var(--muted)">çœä¸‹çš„æˆ¿è²¸åˆ©æ¯</div>
                <div class="big-number" style="color:var(--accent2)" id="savedInterest"></div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px;color:var(--muted)">æ²’æœ‰æŠ•è³‡æ”¶ç›Š</div>
                <div class="big-number" style="color:var(--muted)">0</div>
              </div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #2c3f57">
              <div style="font-size:13px;color:var(--muted)">æ·¨æ”¶ç›Š</div>
              <div class="big-number" id="netGainB"></div>
            </div>
          </div>
        </div>

        <div id="investmentConclusion" class="card" style="background:linear-gradient(135deg,#1a2d42 0%,#0f1923 100%);border:2px solid #2f6ea8;margin-top:20px">
          <div style="font-weight:700;font-size:18px;margin-bottom:12px">ğŸ“Œ çµè«–</div>
          <div id="conclusionText" style="font-size:16px;line-height:1.8"></div>
        </div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:8px">åˆ’ç®—åˆ†ç•Œé»åˆ†æ</div>
          <div class="hint" style="margin-bottom:12px">ç•¶æŠ•è³‡å ±é…¬ç‡é”åˆ°å¤šå°‘æ™‚ï¼Œé¸æ“‡å¯¬é™æœŸæ‰åˆ’ç®—ï¼Ÿ</div>
          <div id="breakEvenPoint" style="font-size:16px;padding:16px;background:#0b131c;border-radius:10px"></div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:700">ç´¯ç©é‡‘é¡å°æ¯”</div>
        </div>
        <div class="chart-container">
          <canvas id="investmentChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- åˆ†é  4: æ™‚é–“è»¸å‹•ç•« -->
  <div id="tab-timeline" class="tab-content">
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">ğŸ¬ 30å¹´é‚„æ¬¾æ­·ç¨‹å‹•ç•«</div>
      <div class="hint" style="margin-bottom:16px">çœ‹æ¸…æ¥šæ¯ä¸€å¹´çš„æœ¬é‡‘å’Œåˆ©æ¯è®ŠåŒ–ï¼Œä»¥åŠé—œéµé‡Œç¨‹ç¢‘</div>
      
      <div class="animation-controls">
        <button class="btn accent" id="playAnimation">â–¶ æ’­æ”¾å‹•ç•«</button>
        <button class="btn" id="pauseAnimation" disabled>â¸ æš«åœ</button>
        <button class="btn" id="resetAnimation">âŸ² é‡è¨­</button>
        <div class="speed-control">
          <label style="margin:0">é€Ÿåº¦ï¼š</label>
          <select id="animSpeed" style="width:auto;padding:4px 8px">
            <option value="2000">æ…¢é€Ÿ</option>
            <option value="1000" selected>æ­£å¸¸</option>
            <option value="500">å¿«é€Ÿ</option>
            <option value="200">æ¥µå¿«</option>
          </select>
        </div>
      </div>

      <div class="timeline-display" id="timelineYear">ç¬¬ 1 å¹´</div>

      <div class="grid stats" style="margin-bottom:16px">
        <div class="stat-box">
          <div class="stat-label">æœ¬å¹´ç¹³æ¬¾</div>
          <div class="stat-value" id="yearPayment">-</div>
          <div class="stat-sub" id="yearBreakdown">-</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">å‰©é¤˜æœ¬é‡‘</div>
          <div class="stat-value" id="yearPrincipal">-</div>
          <div class="stat-sub" id="principalPercent">-</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ç´¯ç©åˆ©æ¯</div>
          <div class="stat-value" id="cumulativeInterest">-</div>
          <div class="stat-sub" id="interestPercent">-</div>
        </div>
      </div>

      <div id="milestoneAlert"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">æœ¬é‡‘ vs åˆ©æ¯é€å¹´è®ŠåŒ–</div>
      <div class="chart-container">
        <canvas id="timelineChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">é‚„æ¬¾é€²åº¦æŠ˜ç·šåœ–</div>
      <div class="chart-container">
        <canvas id="progressChart"></canvas>
      </div>
    </div>
  </div>

  <!-- åˆ†é  5: è²¡å‹™å¥åº·å„€è¡¨æ¿ -->
  <div id="tab-dashboard" class="tab-content">
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px">å€‹äººè²¡å‹™ç‹€æ³è¼¸å…¥</div>
      <div class="grid two">
        <div>
          <label>æœˆæ”¶å…¥ï¼ˆå…ƒï¼‰</label>
          <input id="dashIncome" type="number" value="150000" min="0" step="5000">
        </div>
        <div>
          <label>æ¯æœˆå…¶ä»–æ”¯å‡ºï¼ˆå…ƒï¼‰</label>
          <input id="otherExpense" type="number" value="30000" min="0" step="1000">
          <div class="hint">ç”Ÿæ´»è²»ã€ä¿éšªã€å…¶ä»–è²¸æ¬¾ç­‰</div>
        </div>
      </div>
      <button class="btn accent" id="runDashboard" style="margin-top:16px">ç”Ÿæˆè²¡å‹™å¥åº·å ±å‘Š</button>
    </div>

    <div id="dashboardResults" style="display:none">
      <div class="card">
        <div style="font-weight:700;font-size:18px;margin-bottom:20px;text-align:center">ğŸ¯ è²¡å‹™å¥åº·å„€è¡¨æ¿</div>
        
        <div class="gauge-container">
          <svg class="gauge-svg" viewBox="0 0 200 120">
            <path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100" stroke-width="20"/>
            <path id="gaugeFill" class="gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" 
                  stroke-dasharray="251.2" stroke-dashoffset="251.2"/>
            <text id="gaugeValue" class="gauge-text" x="100" y="85" text-anchor="middle">0%</text>
            <text class="gauge-label" x="100" y="105" text-anchor="middle">è² å‚µæ¯”</text>
          </svg>
        </div>

        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:24px;font-weight:700" id="healthStatus">è©•ä¼°ä¸­...</div>
          <div style="color:var(--muted);margin-top:4px" id="healthDesc">-</div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:16px">è©³ç´°è²¡å‹™æŒ‡æ¨™</div>
        
        <div class="health-metric">
          <div class="metric-title">
            <span>ğŸ’° å¯æ”¯é…æ”¶å…¥</span>
            <span id="disposableIncome">-</span>
          </div>
          <div class="metric-bar">
            <div class="metric-fill" id="disposableBar" style="background:var(--success)"></div>
          </div>
          <div class="metric-info" id="disposableInfo">-</div>
        </div>

        <div class="health-metric">
          <div class="metric-title">
            <span>ğŸ›¡ï¸ ç·Šæ€¥å‚™ç”¨é‡‘</span>
            <span id="emergencyFund">-</span>
          </div>
          <div class="metric-bar">
            <div class="metric-fill" id="emergencyBar"></div>
          </div>
          <div class="metric-info">å»ºè­°æº–å‚™ 6 å€‹æœˆçš„ç¸½æ”¯å‡ºä½œç‚ºç·Šæ€¥å‚™ç”¨é‡‘</div>
        </div>

        <div class="health-metric">
          <div class="metric-title">
            <span>ğŸ“ˆ å¯æ‰¿å—å‡æ¯å¹…åº¦</span>
            <span id="maxRateIncrease">-</span>
          </div>
          <div class="metric-bar">
            <div class="metric-fill" id="rateIncreaseBar"></div>
          </div>
          <div class="metric-info" id="rateIncreaseInfo">-</div>
        </div>

        <div class="health-metric">
          <div class="metric-title">
            <span>âš¡ æå‰é‚„æ¬¾å»ºè­°</span>
            <span id="extraPaySuggestion">-</span>
          </div>
          <div class="metric-bar">
            <div class="metric-fill" id="extraPayBar" style="background:var(--accent2)"></div>
          </div>
          <div class="metric-info" id="extraPayInfo">-</div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:12px">ğŸ’¡ å€‹äººåŒ–å»ºè­°</div>
        <div id="recommendations" style="line-height:1.8"></div>
      </div>
    </div>
  </div>

  <div class="footer">ğŸ’¡ æç¤ºï¼šäº”å€‹åˆ†é å„æœ‰é‡é»ï¼Œå»ºè­°ä¾åºç€è¦½ä»¥ç²å¾—å®Œæ•´çš„è²¡å‹™åˆ†æï¼</div>
</div>

<script>
  function pmt(monthlyRate, nper, pv) {
    if (Math.abs(monthlyRate) < 1e-12) return pv / nper;
    const r = monthlyRate;
    return pv * (r * Math.pow(1 + r, nper)) / (Math.pow(1 + r, nper) - 1);
  }
  function fmt(n) {
    return n.toLocaleString('zh-TW', { maximumFractionDigits: 0 });
  }
  function byId(id){return document.getElementById(id)}

  // åˆ†é åˆ‡æ›
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      byId('tab-' + tab.dataset.tab).classList.add('active');
    });
  });

  function simulate({loan, annualRate, years, graceYears, extraPayAnnual = 0, extraStartYear = 1}) {
    const monthsTotal = years * 12;
    const monthsGrace = Math.min(graceYears * 12, monthsTotal);
    const monthsRepay = Math.max(0, monthsTotal - monthsGrace);
    const mr = annualRate / 100 / 12;

    const interestOnly = loan * mr;
    let baseAmortPay = monthsRepay > 0 ? pmt(mr, monthsRepay, loan) : 0;

    const monthlyPaySeries = [];
    const principalRemaining = new Array(monthsTotal + 1).fill(0);
    principalRemaining[0] = loan;
    
    let totalInterest = 0;
    let actualMonths = 0;
    const yearlyInterest = [];
    const yearlyPrincipal = [];

    for (let m = 1; m <= monthsTotal; m++) {
      const prev = principalRemaining[m-1];
      if (prev <= 0) break;
      
      const interest = prev * mr;
      totalInterest += interest;

      let pay = 0, principalPay = 0;
      if (m <= monthsGrace) {
        pay = interestOnly;
        principalPay = 0;
      } else {
        pay = baseAmortPay;
        principalPay = Math.max(0, pay - interest);
        if (principalPay > prev) principalPay = prev;
      }

      const currentYear = Math.ceil(m / 12);
      if (extraPayAnnual > 0 && currentYear >= extraStartYear && m % 12 === 0) {
        const extra = Math.min(extraPayAnnual, prev - principalPay);
        principalPay += extra;
        pay += extra;
      }

      principalRemaining[m] = Math.max(0, prev - principalPay);
      monthlyPaySeries.push(pay);
      actualMonths = m;
      
      if (principalRemaining[m] <= 0) break;
    }

    const monthlyPayByYear = [];
    const annualTotal = [];
    const principalEndOfYear = [];
    const yearLabels = [];

    for (let y = 1; y <= years; y++) {
      const s = (y-1)*12, e = Math.min(y*12, actualMonths);
      if (s >= actualMonths) break;
      
      const slice = monthlyPaySeries.slice(s, e);
      const meanMonthly = slice.reduce((a,b)=>a+b, 0) / (slice.length || 1);
      const totalYear = slice.reduce((a,b)=>a+b, 0);
      
      // è¨ˆç®—è©²å¹´åº¦çš„åˆ©æ¯å’Œæœ¬é‡‘
      let yearInt = 0, yearPrin = 0;
      for (let m = s; m < e; m++) {
        const prev = principalRemaining[m];
        const interest = prev * mr;
        yearInt += interest;
        const prin = monthlyPaySeries[m] - interest;
        yearPrin += Math.max(0, prin);
      }
      
      yearlyInterest.push(yearInt);
      yearlyPrincipal.push(yearPrin);
      
      monthlyPayByYear.push(meanMonthly);
      annualTotal.push(totalYear);
      principalEndOfYear.push(principalRemaining[e] || 0);
      yearLabels.push(String(y));
    }

    return {
      yearLabels,
      monthlyPayByYear,
      annualTotal,
      principalEndOfYear,
      principalRemaining,
      monthsTotal: actualMonths,
      monthsGrace,
      totalInterest,
      interestOnly,
      baseAmortPay,
      yearlyInterest,
      yearlyPrincipal
    };
  }

  let barChart, lineChart, pressureChart, investmentChart, timelineChart, progressChart;
  let animationInterval = null;
  let currentYear = 0;
  let animationData = null;

  function renderBar(labels, data, graceYears, noGraceData = null) {
    const ctx = byId('barChart').getContext('2d');
    if (barChart) barChart.destroy();
    
    const datasets = [{
      label: 'æ¯æœˆç¹³æ¬¾é‡‘é¡ï¼ˆå…ƒï¼‰',
      data,
      backgroundColor: data.map((_, i) => i < graceYears ? 'rgba(255, 184, 77, 0.8)' : 'rgba(125, 196, 255, 0.8)'),
      borderColor: data.map((_, i) => i < graceYears ? 'rgba(255, 184, 77, 1)' : 'rgba(125, 196, 255, 1)'),
      borderWidth: 1
    }];

    if (noGraceData) {
      datasets.push({
        label: 'ç„¡å¯¬é™æœŸæœˆç¹³',
        data: noGraceData,
        backgroundColor: 'rgba(155, 176, 201, 0.3)',
        borderColor: 'rgba(155, 176, 201, 0.8)',
        borderWidth: 1
      });
    }

    barChart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { grid: { color: 'rgba(36,50,66,0.6)' } },
          y: {
            grid: { color: 'rgba(36,50,66,0.6)' },
            ticks: { callback: v => fmt(v) }
          }
        },
        plugins: {
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}` } },
          legend: { display: noGraceData ? true : false }
        }
      }
    });
  }

  function renderLine(yearsCount, principalRemaining, noGracePrincipal = null) {
    const labels = Array.from({length: yearsCount+1}, (_,i)=> String(i));
    const yearly = [];
    for (let y = 0; y <= yearsCount; y++) {
      yearly.push(principalRemaining[y*12] ?? principalRemaining[principalRemaining.length-1] ?? 0);
    }

    const datasets = [{
      label: 'å‰©é¤˜æœ¬é‡‘ï¼ˆæœ‰å¯¬é™æœŸï¼‰',
      data: yearly,
      borderColor: 'rgba(125, 196, 255, 1)',
      backgroundColor: 'rgba(125, 196, 255, 0.1)',
      tension: 0.3,
      borderWidth: 2,
      pointRadius: 3
    }];

    if (noGracePrincipal) {
      const noGraceYearly = [];
      for (let y = 0; y <= yearsCount; y++) {
        noGraceYearly.push(noGracePrincipal[y*12] ?? noGracePrincipal[noGracePrincipal.length-1] ?? 0);
      }
      datasets.push({
        label: 'å‰©é¤˜æœ¬é‡‘ï¼ˆç„¡å¯¬é™æœŸï¼‰',
        data: noGraceYearly,
        borderColor: 'rgba(155, 176, 201, 0.8)',
        backgroundColor: 'rgba(155, 176, 201, 0.05)',
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 3,
        borderDash: [5, 5]
      });
    }

    const ctx = byId('lineChart').getContext('2d');
    if (lineChart) lineChart.destroy();
    lineChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { grid: { color: 'rgba(36,50,66,0.6)' } },
          y: {
            grid: { color: 'rgba(36,50,66,0.6)' },
            ticks: { callback: v => fmt(v) }
          }
        },
        plugins: {
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}` } },
          legend: { display: noGracePrincipal ? true : false }
        }
      }
    });
  }

  function updateStats(graceRes, noGraceRes) {
    byId('statsCard').style.display = 'block';
    
    byId('gracePayment').textContent = fmt(graceRes.interestOnly);
    byId('repayPayment').textContent = fmt(graceRes.baseAmortPay);
    
    const increase = ((graceRes.baseAmortPay - graceRes.interestOnly) / graceRes.interestOnly * 100).toFixed(1);
    byId('increasePercent').innerHTML = `<span class="stat-increase">â†‘ ${increase}%</span>`;
    
    byId('totalInterest').textContent = fmt(graceRes.totalInterest);
    
    const extraInterest = graceRes.totalInterest - noGraceRes.totalInterest;
    byId('interestDiff').innerHTML = extraInterest > 0 
      ? `æ¯”ç„¡å¯¬é™æœŸå¤šä»˜ <span class="stat-increase">${fmt(extraInterest)}</span>`
      : `èˆ‡ç„¡å¯¬é™æœŸç›¸åŒ`;

    const warningBox = byId('warningBox');
    if (increase > 50) {
      warningBox.classList.add('show');
      byId('warningText').textContent = `æ”¤é‚„æœŸæœˆç¹³æš´å¢ ${increase}%ï¼è«‹ç¢ºä¿æ”¶å…¥è¶³ä»¥è² æ“”ã€‚`;
    } else {
      warningBox.classList.remove('show');
    }
  }

  // å‡æ¯å£“åŠ›æ¸¬è©¦
  function runPressureTest() {
    const loan = Number(byId('loan').value);
    const baseRate = Number(byId('rate').value);
    const years = Number(byId('years').value);
    const grace = Number(byId('grace').value);
    const income = Number(byId('monthlyIncome').value);
    
    const rate1 = Number(byId('rate1').value);
    const rate2 = Number(byId('rate2').value);
    const rate3 = Number(byId('rate3').value);

    const baseRes = simulate({loan, annualRate: baseRate, years, graceYears: grace});
    
    byId('currentRate').textContent = baseRate + '%';
    byId('currentPayment').textContent = fmt(baseRes.baseAmortPay);
    const baseRatio = income > 0 ? (baseRes.baseAmortPay / income * 100).toFixed(1) : 0;
    byId('currentRatio').textContent = baseRatio + '%';

    const scenarios = [
      {label: 'è¼•åº¦å‡æ¯', rate: baseRate + rate1, increase: rate1},
      {label: 'ä¸­åº¦å‡æ¯', rate: baseRate + rate2, increase: rate2},
      {label: 'é‡åº¦å‡æ¯', rate: baseRate + rate3, increase: rate3}
    ];

    let html = '';
    const chartLabels = ['ç›®å‰'];
    const chartData = [baseRes.baseAmortPay];
    const chartRatios = [baseRatio];

    scenarios.forEach(s => {
      const res = simulate({loan, annualRate: s.rate, years, graceYears: grace});
      const ratio = income > 0 ? (res.baseAmortPay / income * 100).toFixed(1) : 0;
      const diff = res.baseAmortPay - baseRes.baseAmortPay;
      const diffPercent = ((diff / baseRes.baseAmortPay) * 100).toFixed(1);
      
      chartLabels.push(s.label);
      chartData.push(res.baseAmortPay);
      chartRatios.push(ratio);

      const colorClass = ratio < 30 ? 'success' : ratio < 50 ? 'warn' : 'danger';
      
      html += `
        <div class="comparison-card" style="border-color:var(--${colorClass})">
          <div style="color:var(--muted);margin-bottom:8px">${s.label}ï¼ˆåˆ©ç‡ ${s.rate}%ï¼Œ+${s.increase}%ï¼‰</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-size:14px;color:var(--muted)">æœˆç¹³é‡‘é¡</div>
              <div class="big-number" style="color:var(--${colorClass})">${fmt(res.baseAmortPay)}</div>
              <div style="font-size:13px;color:var(--${colorClass});margin-top:4px">
                â†‘ ${fmt(diff)} ï¼ˆ+${diffPercent}%ï¼‰
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-size:14px;color:var(--muted)">è² å‚µæ¯”</div>
              <div class="big-number" style="color:var(--${colorClass})">${ratio}%</div>
            </div>
          </div>
        </div>
      `;
    });

    byId('scenarios').innerHTML = html;

    const maxRatio = Math.max(...chartRatios);
    const markerPos = Math.min(maxRatio, 100);
    byId('pressureMarker').style.left = markerPos + '%';

    const warningBox = byId('pressureWarning');
    const successBox = byId('pressureSuccess');
    
    if (maxRatio > 50) {
      warningBox.classList.add('show');
      byId('pressureWarningText').textContent = `æœ€å£æƒ…æ³è² å‚µæ¯”é” ${maxRatio.toFixed(1)}%ï¼Œè²¡å‹™é¢¨éšªæ¥µé«˜ï¼å»ºè­°æ¸›å°‘è²¸æ¬¾é¡åº¦æˆ–å»¶é•·å¹´é™ã€‚`;
      successBox.style.display = 'none';
    } else if (maxRatio > 30) {
      warningBox.classList.add('show');
      byId('pressureWarningText').textContent = `å‡æ¯å¾Œè² å‚µæ¯”å¯èƒ½é” ${maxRatio.toFixed(1)}%ï¼Œéœ€è¬¹æ…è©•ä¼°æ”¶å…¥ç©©å®šæ€§ã€‚`;
      successBox.style.display = 'none';
    } else {
      warningBox.classList.remove('show');
      successBox.style.display = 'block';
      byId('pressureSuccessText').textContent = `å³ä½¿é‡åº¦å‡æ¯ï¼Œè² å‚µæ¯”ä»åœ¨ ${maxRatio.toFixed(1)}%ï¼Œè²¡å‹™ç‹€æ³å¥åº·ï¼`;
    }

    const ctx = byId('pressureChart').getContext('2d');
    if (pressureChart) pressureChart.destroy();
    pressureChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'æœˆç¹³é‡‘é¡ï¼ˆå…ƒï¼‰',
          data: chartData,
          backgroundColor: chartData.map((_, i) => {
            const ratio = chartRatios[i];
            return ratio < 30 ? 'rgba(81, 207, 102, 0.8)' : ratio < 50 ? 'rgba(255, 184, 77, 0.8)' : 'rgba(255, 107, 107, 0.8)';
          }),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            grid: { color: 'rgba(36,50,66,0.6)' },
            ticks: { callback: v => fmt(v) }
          }
        },
        plugins: {
          tooltip: { 
            callbacks: { 
              label: ctx => {
                const ratio = chartRatios[ctx.dataIndex];
                return [`æœˆç¹³ï¼š${fmt(ctx.parsed.y)}`, `è² å‚µæ¯”ï¼š${ratio}%`];
              }
            } 
          },
          legend: { display: false }
        }
      }
    });

    byId('pressureResults').style.display = 'block';
  }

  // æŠ•è³‡æ©Ÿæœƒæˆæœ¬
  function runInvestmentAnalysis() {
    const loan = Number(byId('loan').value);
    const baseRate = Number(byId('rate').value);
    const years = Number(byId('years').value);
    const grace = Number(byId('grace').value);
    const returnRate = Number(byId('returnRate').value);

    byId('investYears').value = grace;

    const graceRes = simulate({loan, annualRate: baseRate, years, graceYears: grace});
    const noGraceRes = simulate({loan, annualRate: baseRate, years, graceYears: 0});

    const monthlySaving = noGraceRes.baseAmortPay - graceRes.interestOnly;
    
    const monthlyReturn = returnRate / 100 / 12;
    const investMonths = grace * 12;
    let investAccum = 0;
    for (let m = 0; m < investMonths; m++) {
      investAccum = (investAccum + monthlySaving) * (1 + monthlyReturn);
    }

    const extraInterestPaid = graceRes.totalInterest - noGraceRes.totalInterest;
    const netGainA = investAccum - extraInterestPaid;
    const netGainB = extraInterestPaid;

    byId('investTotal').textContent = fmt(investAccum);
    byId('extraInterest').textContent = fmt(extraInterestPaid);
    byId('netGainA').textContent = fmt(netGainA);
    byId('netGainA').style.color = netGainA > 0 ? 'var(--accent2)' : 'var(--danger)';

    byId('savedInterest').textContent = fmt(extraInterestPaid);
    byId('netGainB').textContent = fmt(netGainB);

    let conclusion = '';
    if (netGainA > netGainB) {
      const diff = netGainA - netGainB;
      conclusion = `<span style="color:var(--accent2)">âœ“ é¸æ“‡å¯¬é™æœŸè¼ƒåˆ’ç®—</span><br>
        è‹¥å°‡çœä¸‹çš„éŒ¢æŠ•è³‡ï¼ˆå¹´åŒ–å ±é…¬ ${returnRate}%ï¼‰ï¼Œ${grace} å¹´å¾Œå¯å¤šè³º <span style="color:var(--accent2);font-weight:700">${fmt(diff)}</span>ã€‚
        <br><br>ä½†å‰ææ˜¯ï¼š<br>
        â‘  ç¢ºå¯¦æœ‰ç´€å¾‹åœ°å°‡çœä¸‹çš„éŒ¢æ‹¿å»æŠ•è³‡<br>
        â‘¡ å¯¦éš›å ±é…¬ç‡èƒ½é”åˆ°é æœŸæ°´æº–<br>
        â‘¢ æ”¤é‚„æœŸæœˆç¹³è·³å‡æ™‚ä»æœ‰è¶³å¤ æ”¶å…¥`;
    } else {
      const diff = netGainB - netGainA;
      conclusion = `<span style="color:var(--warn)">âš  ä¸é¸å¯¬é™æœŸè¼ƒåˆ’ç®—</span><br>
        ç›´æ¥æœ¬æ¯æ”¤é‚„å¯å°‘ä»˜ <span style="font-weight:700">${fmt(extraInterestPaid)}</span> åˆ©æ¯ï¼Œ
        æ¯”æŠ•è³‡æ–¹æ¡ˆå¤šè³º <span style="color:var(--accent2);font-weight:700">${fmt(diff)}</span>ã€‚
        <br><br>å»ºè­°ï¼šé™¤éæŠ•è³‡å ±é…¬ç‡èƒ½è¶…é <span style="font-weight:700">${calculateBreakEvenRate(monthlySaving, investMonths, extraInterestPaid).toFixed(2)}%</span>ï¼Œå¦å‰‡ä¸å»ºè­°é¸æ“‡å¯¬é™æœŸã€‚`;
    }

    byId('conclusionText').innerHTML = conclusion;

    const breakEven = calculateBreakEvenRate(monthlySaving, investMonths, extraInterestPaid);
    byId('breakEvenPoint').innerHTML = `
      ç•¶æŠ•è³‡å¹´åŒ–å ±é…¬ç‡ <span style="color:var(--accent);font-weight:700;font-size:20px">&gt; ${breakEven.toFixed(2)}%</span> æ™‚ï¼Œé¸æ“‡å¯¬é™æœŸæ‰åˆ’ç®—ã€‚
      <div style="margin-top:8px;color:var(--muted);font-size:14px">
        åƒè€ƒï¼šå®šå­˜ç´„ 1-2%ã€å‚µåˆ¸å‹åŸºé‡‘ 3-4%ã€å¹³è¡¡å‹åŸºé‡‘ 5-6%ã€è‚¡ç¥¨å‹ ETF 6-8%ã€å€‹è‚¡ 8%+
      </div>
    `;

    const labels = [];
    const investData = [];
    const savingData = [];
    
    for (let y = 0; y <= grace; y++) {
      labels.push(y + 'å¹´');
      
      let accum = 0;
      const m = y * 12;
      for (let i = 0; i < m; i++) {
        accum = (accum + monthlySaving) * (1 + monthlyReturn);
      }
      investData.push(accum);
      savingData.push(monthlySaving * m);
    }

    const ctx = byId('investmentChart').getContext('2d');
    if (investmentChart) investmentChart.destroy();
    investmentChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'æŠ•è³‡ç´¯ç©é‡‘é¡',
            data: investData,
            borderColor: 'rgba(185, 255, 125, 1)',
            backgroundColor: 'rgba(185, 255, 125, 0.1)',
            tension: 0.3,
            borderWidth: 3
          },
          {
            label: 'å–®ç´”ç´¯ç©ç¯€çœ',
            data: savingData,
            borderColor: 'rgba(155, 176, 201, 0.8)',
            backgroundColor: 'rgba(155, 176, 201, 0.05)',
            tension: 0.3,
            borderWidth: 2,
            borderDash: [5, 5]
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            grid: { color: 'rgba(36,50,66,0.6)' },
            ticks: { callback: v => fmt(v) }
          }
        },
        plugins: {
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${fmt(ctx.parsed.y)}` } }
        }
      }
    });

    byId('investmentResults').style.display = 'block';
  }

  function calculateBreakEvenRate(monthlySaving, months, targetAmount) {
    let low = 0, high = 50;
    for (let iter = 0; iter < 50; iter++) {
      const mid = (low + high) / 2;
      const mr = mid / 100 / 12;
      let accum = 0;
      for (let m = 0; m < months; m++) {
        accum = (accum + monthlySaving) * (1 + mr);
      }
      if (accum < targetAmount) {
        low = mid;
      } else {
        high = mid;
      }
    }
    return (low + high) / 2;
  }

  // æ™‚é–“è»¸å‹•ç•«
  function initTimelineAnimation() {
    const loan = Number(byId('loan').value);
    const rate = Number(byId('rate').value);
    const years = Number(byId('years').value);
    const grace = Number(byId('grace').value);

    animationData = simulate({loan, annualRate: rate, years, graceYears: grace});
    currentYear = 0;
    
    // åˆå§‹åŒ–åœ–è¡¨
    const ctx1 = byId('timelineChart').getContext('2d');
    if (timelineChart) timelineChart.destroy();
    timelineChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            label: 'æœ¬é‡‘',
            data: [],
            backgroundColor: 'rgba(125, 196, 255, 0.8)',
            stack: 'stack'
          },
          {
            label: 'åˆ©æ¯',
            data: [],
            backgroundColor: 'rgba(255, 184, 77, 0.8)',
            stack: 'stack'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true },
          y: { stacked: true, ticks: { callback: v => fmt(v) } }
        }
      }
    });

    const ctx2 = byId('progressChart').getContext('2d');
    if (progressChart) progressChart.destroy();
    progressChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'é‚„æ¬¾é€²åº¦',
          data: [],
          borderColor: 'rgba(125, 196, 255, 1)',
          backgroundColor: 'rgba(125, 196, 255, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { 
            min: 0,
            max: 100,
            ticks: { callback: v => v + '%' }
          }
        }
      }
    });

    updateTimelineFrame(0);
  }

  function updateTimelineFrame(year) {
    if (!animationData || year >= animationData.yearLabels.length) return;
    
    const loan = Number(byId('loan').value);
    const grace = Number(byId('grace').value);
    
    byId('timelineYear').textContent = `ç¬¬ ${year + 1} å¹´`;
    
    const yearPayment = animationData.annualTotal[year];
    const yearPrin = animationData.yearlyPrincipal[year];
    const yearInt = animationData.yearlyInterest[year];
    const remaining = animationData.principalEndOfYear[year];
    const paidPercent = ((loan - remaining) / loan * 100).toFixed(1);
    
    let cumulInt = 0;
    for (let i = 0; i <= year; i++) {
      cumulInt += animationData.yearlyInterest[i];
    }
    const intPercent = (cumulInt / loan * 100).toFixed(1);
    
    byId('yearPayment').textContent = fmt(yearPayment);
    byId('yearBreakdown').innerHTML = `æœ¬é‡‘ ${fmt(yearPrin)} + åˆ©æ¯ ${fmt(yearInt)}`;
    byId('yearPrincipal').textContent = fmt(remaining);
    byId('principalPercent').innerHTML = `å·²é‚„æ¸… <span style="color:var(--accent2)">${paidPercent}%</span>`;
    byId('cumulativeInterest').textContent = fmt(cumulInt);
    byId('interestPercent').innerHTML = `ä½”åŸè²¸æ¬¾ ${intPercent}%`;
    
    // æª¢æŸ¥é‡Œç¨‹ç¢‘
    let milestone = '';
    if (year + 1 === grace && grace > 0) {
      milestone = '<div class="milestone">ğŸ¯ <b>å¯¬é™æœŸçµæŸ</b> - æœˆç¹³å³å°‡è·³å‡ï¼Œæœ¬é‡‘é–‹å§‹å„Ÿé‚„</div>';
    } else if (paidPercent >= 50 && year > 0 && ((loan - animationData.principalEndOfYear[year-1]) / loan * 100) < 50) {
      milestone = '<div class="milestone">ğŸ‰ <b>é‚„æ¸…ä¸€åŠ</b> - å·²å„Ÿé‚„ 50% æœ¬é‡‘ï¼</div>';
    } else if (remaining < loan * 0.1 && year > 0 && animationData.principalEndOfYear[year-1] >= loan * 0.1) {
      milestone = '<div class="milestone">ğŸ† <b>é€²å…¥å°¾è²</b> - å‰©é¤˜æœ¬é‡‘ä¸åˆ° 10%ï¼</div>';
    }
    byId('milestoneAlert').innerHTML = milestone;
    
    // æ›´æ–°åœ–è¡¨
    timelineChart.data.labels = animationData.yearLabels.slice(0, year + 1);
    timelineChart.data.datasets[0].data = animationData.yearlyPrincipal.slice(0, year + 1);
    timelineChart.data.datasets[1].data = animationData.yearlyInterest.slice(0, year + 1);
    timelineChart.update();
    
    const progressData = [];
    for (let i = 0; i <= year; i++) {
      const rem = animationData.principalEndOfYear[i];
      progressData.push(((loan - rem) / loan * 100));
    }
    progressChart.data.labels = animationData.yearLabels.slice(0, year + 1);
    progressChart.data.datasets[0].data = progressData;
    progressChart.update();
  }

  function playAnimation() {
    if (animationInterval) return;
    
    if (!animationData) initTimelineAnimation();
    
    byId('playAnimation').disabled = true;
    byId('pauseAnimation').disabled = false;
    
    const speed = Number(byId('animSpeed').value);
    
    animationInterval = setInterval(() => {
      currentYear++;
      if (currentYear >= animationData.yearLabels.length) {
        pauseAnimation();
        currentYear = animationData.yearLabels.length - 1;
        return;
      }
      updateTimelineFrame(currentYear);
    }, speed);
  }

  function pauseAnimation() {
    if (animationInterval) {
      clearInterval(animationInterval);
      animationInterval = null;
    }
    byId('playAnimation').disabled = false;
    byId('pauseAnimation').disabled = true;
  }

  function resetAnimation() {
    pauseAnimation();
    currentYear = 0;
    initTimelineAnimation();
  }

  // è²¡å‹™å¥åº·å„€è¡¨æ¿
  function runDashboard() {
    const loan = Number(byId('loan').value);
    const rate = Number(byId('rate').value);
    const years = Number(byId('years').value);
    const grace = Number(byId('grace').value);
    const income = Number(byId('dashIncome').value);
    const otherExpense = Number(byId('otherExpense').value);

    if (income <= 0) {
      alert('è«‹è¼¸å…¥æœˆæ”¶å…¥');
      return;
    }

    const res = simulate({loan, annualRate: rate, years, graceYears: grace});
    const monthlyPayment = res.baseAmortPay;
    
    // è² å‚µæ¯”
    const debtRatio = (monthlyPayment / income * 100).toFixed(1);
    
    // å¯æ”¯é…æ”¶å…¥
    const disposable = income - monthlyPayment - otherExpense;
    const disposablePercent = (disposable / income * 100).toFixed(1);
    
    // ç·Šæ€¥å‚™ç”¨é‡‘å»ºè­°
    const totalMonthlyExpense = monthlyPayment + otherExpense;
    const emergencyFundNeeded = totalMonthlyExpense * 6;
    
    // å¯æ‰¿å—å‡æ¯å¹…åº¦ï¼ˆä½¿è² å‚µæ¯”ä¸è¶…é50%ï¼‰
    const maxAffordablePayment = income * 0.5;
    let maxRate = rate;
    if (monthlyPayment < maxAffordablePayment) {
      // äºŒåˆ†æœå°‹æ‰¾å‡ºæœ€å¤§å¯æ‰¿å—åˆ©ç‡
      let low = rate, high = rate + 10;
      for (let i = 0; i < 30; i++) {
        const mid = (low + high) / 2;
        const testRes = simulate({loan, annualRate: mid, years, graceYears: grace});
        if (testRes.baseAmortPay <= maxAffordablePayment) {
          low = mid;
        } else {
          high = mid;
        }
      }
      maxRate = low;
    }
    const maxIncrease = maxRate - rate;
    
    // æå‰é‚„æ¬¾å»ºè­°
    const extraPayCapacity = Math.max(0, disposable * 0.3);
    
    // æ›´æ–°å„€è¡¨ç›¤
    updateGauge(debtRatio);
    
    let status = '', statusDesc = '', statusColor = '';
    if (debtRatio < 30) {
      status = 'è²¡å‹™å¥åº· âœ“';
      statusDesc = 'è² å‚µæ¯”åœ¨å®‰å…¨ç¯„åœå…§';
      statusColor = 'var(--success)';
    } else if (debtRatio < 50) {
      status = 'éœ€è¦è­¦æˆ’ âš ';
      statusDesc = 'è² å‚µæ¯”åé«˜ï¼Œå»ºè­°æ§åˆ¶æ”¯å‡º';
      statusColor = 'var(--warn)';
    } else {
      status = 'é«˜é¢¨éšª âš ï¸';
      statusDesc = 'è² å‚µæ¯”éé«˜ï¼Œè²¡å‹™å£“åŠ›å¤§';
      statusColor = 'var(--danger)';
    }
    
    byId('healthStatus').textContent = status;
    byId('healthStatus').style.color = statusColor;
    byId('healthDesc').textContent = statusDesc;
    
    // æ›´æ–°æŒ‡æ¨™
    byId('disposableIncome').textContent = fmt(disposable);
    const dispBar = byId('disposableBar');
    dispBar.style.width = Math.min(100, disposablePercent) + '%';
    dispBar.textContent = disposablePercent + '%';
    byId('disposableInfo').textContent = `æ‰£é™¤æˆ¿è²¸å’Œå…¶ä»–æ”¯å‡ºå¾Œï¼Œæ‚¨é‚„æœ‰ ${fmt(disposable)} å…ƒå¯è‡ªç”±é‹ç”¨`;
    
    byId('emergencyFund').textContent = fmt(emergencyFundNeeded);
    const emBar = byId('emergencyBar');
    emBar.style.width = '100%';
    emBar.style.background = 'var(--accent)';
    emBar.textContent = '6 å€‹æœˆ';
    
    byId('maxRateIncrease').textContent = '+' + maxIncrease.toFixed(2) + '%';
    const rateBar = byId('rateIncreaseBar');
    const rateBarWidth = Math.min(100, (maxIncrease / 3) * 100);
    rateBar.style.width = rateBarWidth + '%';
    rateBar.style.background = maxIncrease > 2 ? 'var(--success)' : maxIncrease > 1 ? 'var(--warn)' : 'var(--danger)';
    rateBar.textContent = maxIncrease.toFixed(2) + '%';
    byId('rateIncreaseInfo').textContent = maxIncrease > 2 
      ? 'æ‚¨å¯æ‰¿å—è¼ƒå¤§å¹…åº¦çš„å‡æ¯' 
      : maxIncrease > 1 
      ? 'ä¸­åº¦å‡æ¯å¯èƒ½é€ æˆè²¡å‹™å£“åŠ›' 
      : 'å‡æ¯ç©ºé–“æœ‰é™ï¼Œå»ºè­°æå‰è¦åŠƒ';
    
    byId('extraPaySuggestion').textContent = fmt(extraPayCapacity) + ' / æœˆ';
    const extraBar = byId('extraPayBar');
    const extraBarWidth = Math.min(100, (extraPayCapacity / monthlyPayment) * 100);
    extraBar.style.width = extraBarWidth + '%';
    extraBar.textContent = fmt(extraPayCapacity);
    byId('extraPayInfo').textContent = extraPayCapacity > 0 
      ? `å»ºè­°å°‡å¯æ”¯é…æ”¶å…¥çš„ 30%ï¼ˆ${fmt(extraPayCapacity)}ï¼‰ç”¨æ–¼æå‰é‚„æ¬¾ï¼Œå¯å¤§å¹…æ¸›å°‘åˆ©æ¯` 
      : 'ç›®å‰è²¡å‹™è¼ƒç·Šï¼Œå»ºè­°å…ˆå»ºç«‹ç·Šæ€¥å‚™ç”¨é‡‘';
    
    // å€‹äººåŒ–å»ºè­°
    let recommendations = '';
    if (debtRatio > 50) {
      recommendations += 'ğŸš¨ <b>å„ªå…ˆå»ºè­°ï¼šé™ä½è² å‚µæ¯”</b><br>';
      recommendations += 'â€¢ è€ƒæ…®å»¶é•·è²¸æ¬¾å¹´é™ä»¥é™ä½æœˆç¹³<br>';
      recommendations += 'â€¢ å°‹æ‰¾å¢åŠ æ”¶å…¥çš„æ©Ÿæœƒ<br>';
      recommendations += 'â€¢ æª¢è¦–ä¸¦å‰Šæ¸›éå¿…è¦æ”¯å‡º<br><br>';
    }
    
    if (disposable < emergencyFundNeeded / 6) {
      recommendations += 'ğŸ’° <b>å»ºç«‹ç·Šæ€¥å‚™ç”¨é‡‘</b><br>';
      recommendations += `â€¢ ç›®æ¨™ï¼š${fmt(emergencyFundNeeded)}ï¼ˆ6å€‹æœˆæ”¯å‡ºï¼‰<br>`;
      recommendations += 'â€¢ å„ªå…ˆæ–¼æå‰é‚„æ¬¾æˆ–æŠ•è³‡<br><br>';
    }
    
    if (extraPayCapacity > 10000) {
      recommendations += 'ğŸ“ˆ <b>å–„ç”¨å¤šé¤˜è³‡é‡‘</b><br>';
      recommendations += `â€¢ æ‚¨æ¯æœˆå¯å¤šé‚„ ${fmt(extraPayCapacity)}<br>`;
      recommendations += 'â€¢ å¯è€ƒæ…®æå‰é‚„æ¬¾ä»¥æ¸›å°‘åˆ©æ¯<br>';
      recommendations += `â€¢ æˆ–æŠ•è³‡å ±é…¬ç‡ >${calculateBreakEvenRate(res.interestOnly, grace * 12, res.totalInterest - simulate({loan, annualRate: rate, years, graceYears: 0}).totalInterest).toFixed(1)}% çš„æ¨™çš„<br><br>`;
    }
    
    if (maxIncrease < 1) {
      recommendations += 'âš ï¸ <b>å‡æ¯é¢¨éšªæé†’</b><br>';
      recommendations += `â€¢ æ‚¨åªèƒ½æ‰¿å—å‡æ¯ ${maxIncrease.toFixed(2)}%<br>`;
      recommendations += 'â€¢ å»ºè­°é–å®šå›ºå®šåˆ©ç‡æˆ–åšå¥½å‡æ¯æº–å‚™<br><br>';
    }
    
    if (!recommendations) {
      recommendations = 'âœ“ æ‚¨çš„è²¡å‹™ç‹€æ³è‰¯å¥½ï¼ç¹¼çºŒä¿æŒç©©å¥çš„ç†è²¡ç¿’æ…£ã€‚';
    }
    
    byId('recommendations').innerHTML = recommendations;
    byId('dashboardResults').style.display = 'block';
  }

  function updateGauge(value) {
    const maxAngle = 180;
    const angle = Math.min(value, 100) / 100 * maxAngle;
    const circumference = 251.2;
    const offset = circumference - (angle / 180) * circumference;
    
    const fill = byId('gaugeFill');
    fill.style.strokeDashoffset = offset;
    
    let color = '';
    if (value < 30) color = 'var(--success)';
    else if (value < 50) color = 'var(--warn)';
    else color = 'var(--danger)';
    fill.style.stroke = color;
    
    byId('gaugeValue').textContent = value + '%';
  }

  function downloadCanvasPNG(canvasId, filename){
    const link = document.createElement('a');
    link.download = filename;
    link.href = byId(canvasId).toDataURL('image/png');
    link.click();
  }

  function exportCSV(rows, filename){
    const content = rows.map(r => r.map(v => {
      const s = (v ?? '').toString();
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');
    const blob = new Blob(["\ufeff" + content], {type:'text/csv;charset=utf-8;'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function runBasic() {
    const loan  = Number(byId('loan').value);
    const rate  = Number(byId('rate').value);
    const years = Number(byId('years').value);
    const grace = Number(byId('grace').value);
    const showComp = byId('showComparison').checked;
    const enableExtra = byId('enableExtraPay').checked;
    const extraPay = enableExtra ? Number(byId('extraPay').value) : 0;
    const extraStart = enableExtra ? Number(byId('extraStartYear').value) : 1;

    if (!(loan > 0 && rate >= 0 && years > 0 && grace >= 0 && grace <= years)) {
      alert('è«‹ç¢ºèªåƒæ•¸ç¯„åœ');
      return;
    }

    const graceRes = simulate({loan, annualRate: rate, years, graceYears: grace, extraPayAnnual: extraPay, extraStartYear: extraStart});
    const noGraceRes = simulate({loan, annualRate: rate, years, graceYears: 0});

    renderBar(graceRes.yearLabels, graceRes.monthlyPayByYear, grace, showComp ? noGraceRes.monthlyPayByYear : null);
    renderLine(years, graceRes.principalRemaining, showComp ? noGraceRes.principalRemaining : null);
    updateStats(graceRes, noGraceRes);

    byId('noGraceLegend').style.display = showComp ? 'flex' : 'none';

    window.__lastCSV = [
      ['å¹´ä»½','æœ‰å¯¬é™-æœˆç¹³','æœ‰å¯¬é™-å¹´ç¹³','æœ‰å¯¬é™-å¹´æœ«æœ¬é‡‘','ç„¡å¯¬é™-æœˆç¹³','ç„¡å¯¬é™-å¹´ç¹³','ç„¡å¯¬é™-å¹´æœ«æœ¬é‡‘'],
      ...graceRes.yearLabels.map((y, i) => [
        y,
        Math.round(graceRes.monthlyPayByYear[i]),
        Math.round(graceRes.annualTotal[i]),
        Math.round(graceRes.principalEndOfYear[i]),
        Math.round(noGraceRes.monthlyPayByYear[i] || 0),
        Math.round(noGraceRes.annualTotal[i] || 0),
        Math.round(noGraceRes.principalEndOfYear[i] || 0)
      ])
    ];
  }

  byId('enableExtraPay').addEventListener('change', (e) => {
    byId('extraPaySection').style.display = e.target.checked ? 'block' : 'none';
  });

  byId('runBasic').addEventListener('click', runBasic);
  byId('runPressure').addEventListener('click', runPressureTest);
  byId('runInvestment').addEventListener('click', runInvestmentAnalysis);
  byId('playAnimation').addEventListener('click', playAnimation);
  byId('pauseAnimation').addEventListener('click', pauseAnimation);
  byId('resetAnimation').addEventListener('click', resetAnimation);
  byId('runDashboard').addEventListener('click', runDashboard);
  
  byId('downloadBar').addEventListener('click', ()=>downloadCanvasPNG('barChart','æ¯æœˆç¹³æ¬¾å°æ¯”.png'));
  byId('downloadLine').addEventListener('click', ()=>downloadCanvasPNG('lineChart','å‰©é¤˜æœ¬é‡‘.png'));
  byId('exportCsv').addEventListener('click', ()=>{
    const rows = window.__lastCSV || [];
    if (!rows.length) return alert('è«‹å…ˆç”Ÿæˆåœ–è¡¨');
    exportCSV(rows, 'æˆ¿è²¸å¯¬é™æœŸæ¨¡æ“¬.csv');
  });

  byId('grace').addEventListener('input', () => {
    byId('investYears').value = byId('grace').value;
  });

  byId('animSpeed').addEventListener('change', () => {
    if (animationInterval) {
      pauseAnimation();
      playAnimation();
    }
  });

  runBasic();
</script>
</body>
</html>
