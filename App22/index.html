<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>員工班表管理系統</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei','Arial',sans-serif; margin:0; padding:10px; background:#f8f9fa; min-height:100vh; }
        .container { max-width:1200px; min-width:380px; margin:0 auto; background:#fff; border-radius:15px; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
        .header { text-align:center; margin-bottom:20px; }
        .header h1 { color:#333; font-size:2.5rem; margin:0 0 10px 0; background:linear-gradient(45deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
        .save-status { text-align:center; padding:8px; border-radius:6px; margin-bottom:15px; font-size:.9rem; opacity:0; transition:opacity .3s ease; }
        .save-status.saved { background:#d4edda; color:#155724; opacity:1; }
        .save-status.saving { background:#fff3cd; color:#856404; opacity:1; }
        .date-selector { display:flex; justify-content:center; gap:15px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
        .date-selector select { padding:8px 12px; border:2px solid #667eea; border-radius:10px; font-size:1rem; background:#fff; cursor:pointer; }
        .date-selector label { font-weight:600; color:#333; }
        .employee-management { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
        .controls { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
        .control-btn { padding:8px 16px; border:none; border-radius:20px; background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; font-weight:500; cursor:pointer; transition:transform .2s ease; font-size:.9rem; }
        .control-btn:hover { transform:translateY(-2px); }
        .control-btn.edit-mode { background:linear-gradient(45deg,#28a745,#20c997); }
        .control-btn.danger { background:linear-gradient(45deg,#dc3545,#c82333); }
        .control-btn.success { background:linear-gradient(45deg,#28a745,#20c997); }
        .employee-modal { display:none; position:fixed; z-index:2000; inset:0; background-color:rgba(0,0,0,.5); }
        .employee-modal-content { background:#fff; margin:5% auto; padding:30px; border-radius:15px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto; text-align:left; }
        .employee-modal h3 { margin:0 0 25px; color:#333; text-align:center; font-size:1.3rem; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; margin-bottom:8px; font-weight:600; color:#333; }
        .form-group input[type="text"] { width:100%; padding:10px; border:2px solid #e9ecef; border-radius:8px; font-size:1rem; }
        .form-group input[type="text"]:focus { outline:none; border-color:#667eea; }
        .radio-group { display:flex; gap:15px; align-items:center; }
        .radio-option { display:flex; align-items:center; gap:5px; cursor:pointer; }
        .radio-option input[type="radio"] { margin:0; }
        .modal-buttons { display:flex; gap:10px; justify-content:center; margin-top:25px; }
        .modal-btn { padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:500; }
        .modal-btn.primary { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; }
        .modal-btn.secondary { background:#6c757d; color:#fff; }
        .shift-input-row { display:grid; grid-template-columns:2fr 1fr 1fr 60px 80px; gap:10px; align-items:center; margin-top:10px; }
        .shift-input-row input, .shift-input-row select { padding:8px; border:2px solid #e9ecef; border-radius:6px; font-size:.9rem; }
        .shift-input-row button { padding:8px 12px; font-size:.8rem; }
        .shift-item { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#f8f9fa; border-radius:8px; margin-bottom:8px; border-left:4px solid #667eea; }
        .shift-item-info { flex:1; }
        .shift-name { font-weight:600; color:#333; font-size:1rem; }
        .shift-details { font-size:.85rem; color:#666; margin-top:2px; }
        .shift-item-actions { display:flex; align-items:center; gap:10px; }
        .color-indicator { width:24px; height:24px; border-radius:6px; border:2px solid #ddd; }
        .delete-shift { background:#dc3545; color:#fff; border:none; border-radius:6px; padding:6px 12px; font-size:.8rem; cursor:pointer; }
        .protected-badge { background:#28a745; color:#fff; border-radius:4px; padding:2px 8px; font-size:.7rem; }
        .legend { display:flex; justify-content:center; gap:15px; margin-bottom:30px; flex-wrap:wrap; }
        .legend-item { display:flex; align-items:center; gap:6px; background:#f8f9fa; padding:6px 12px; border-radius:15px; font-size:.9rem; }
        .legend-color { width:16px; height:16px; border-radius:50%; border:1px solid #ddd; }
        .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#e9ecef; border-radius:15px; padding:8px; margin-bottom:30px; min-width:350px; overflow-x:auto; position:relative; }
        .day-header { background:linear-gradient(45deg,#667eea,#764ba2); color:#fff; padding:8px; text-align:center; font-weight:600; border-radius:8px; font-size:.9rem; }
        .weekend-header { background:linear-gradient(45deg,#ff6b6b,#ee5a52)!important; }
        .day-cell { background:#fff; border-radius:6px; padding:4px; min-height:140px; min-width:45px; position:relative; transition:transform .2s ease, box-shadow .2s ease; }
        .day-header-info { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
        .day-number { font-weight:600; font-size:1rem; color:#333; }
        .holiday-name { font-size:.7rem; color:#dc3545; font-weight:600; text-align:right; line-height:1.2; max-width:60px; }
        .weekend-cell .day-number { color:#ff6b6b; }
        .empty-cell { background:#f8f9fa; opacity:.5; }
        .staff-schedule { display:flex; flex-direction:column; gap:2px; }
        .staff-item { padding:2px 4px; border-radius:4px; font-size:.7rem; font-weight:500; text-align:center; cursor:default; transition:all .2s ease; position:relative; }
        .staff-item.editable { cursor:pointer; border:1px dashed #007bff; }
        .staff-item.editable:hover { border:1px solid #007bff; box-shadow:0 0 8px rgba(0,123,255,.3); }
        .staff-item.editing { outline:2px solid #007bff; outline-offset:1px; }
        .work-day { background:#d4edda; color:#155724; }
        .holiday { background:#f8d7da; color:#721c24; }
        .night-shift { background:#cce7ff; color:#004085; }
        .off-day { background:#f8f9fa; color:#6c757d; }
        .edit-dropdown { position:absolute; top:100%; left:0; right:0; background:#fff; border:2px solid #007bff; border-radius:6px; z-index:2000; box-shadow:0 8px 32px rgba(0,0,0,.3); }
        .edit-option { padding:8px 10px; cursor:pointer; font-size:.75rem; border-bottom:1px solid #eee; }
        .edit-option:last-child { border-bottom:none; }
        .edit-option:hover { background:#f8f9fa; }
        .edit-option.off-day-option { background:#f8f9fa; color:#6c757d; }
        .edit-option.holiday-option { background:#f8d7da; color:#721c24; }
        .edit-option.night-shift-option { background:#cce7ff; color:#004085; }
        .edit-option.work-day-option { background:#d4edda; color:#155724; }
        .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; margin-top:20px; }
        .stat-card { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:15px; border-radius:12px; text-align:center; }
        .stat-number { font-size:1.8rem; font-weight:bold; margin-bottom:3px; }
        .stat-label { opacity:.9; font-size:.9rem; }
        .employee-summary { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-top:30px; }
        .employee-card { background:#f8f9fa; border-radius:12px; padding:20px; border-left:4px solid #667eea; position:relative; }
        .employee-card .delete-employee { position:absolute; top:10px; right:10px; background:#dc3545; color:#fff; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer; font-size:14px; display:none; }
        .employee-name { font-size:1.2rem; font-weight:600; color:#333; margin-bottom:10px; }
        .employee-stats { display:flex; justify-content:space-between; font-size:.9rem; color:#666; }
        .edit-hint { background:#e7f3ff; border:1px solid #b3d7ff; border-radius:8px; padding:10px; margin-bottom:20px; text-align:center; color:#0066cc; font-size:.9rem; }
        .modal { display:none; position:fixed; z-index:2000; inset:0; background-color:rgba(0,0,0,.5); }
        .modal-content { background:#fff; margin:15% auto; padding:20px; border-radius:10px; width:300px; text-align:center; }
        .modal button { margin:5px; padding:8px 16px; border:none; border-radius:5px; cursor:pointer; }
        .modal .btn-confirm { background:#dc3545; color:#fff; }
        .modal .btn-cancel { background:#6c757d; color:#fff; }

        @media (max-width: 768px) {
            body { padding:5px; }
            .container { padding:8px; margin:0; min-width:360px; border-radius:10px; }
            .calendar-grid { min-width:350px; padding:6px; gap:1px; }
            .header h1 { font-size:1.8rem; }
            .day-cell { min-height:120px; min-width:45px; padding:3px; }
            .staff-item { font-size:.65rem; padding:1px 3px; }
            .controls, .employee-management, .date-selector { flex-direction:column; align-items:center; }
            .holiday-name { font-size:.6rem; max-width:40px; }
            .shift-input-row { grid-template-columns:1fr; gap:8px; }
            .calendar-grid::before { content:"可左右滑動查看完整週班表"; position:absolute; top:-20px; left:50%; transform:translateX(-50%); font-size:.75rem; color:#666; background:rgba(255,255,255,.9); padding:2px 6px; border-radius:8px; white-space:nowrap; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header"><h1>員工班表管理系統</h1></div>
    <div class="save-status" id="saveStatus">資料已儲存</div>

    <div class="date-selector">
        <label for="yearSelect">年份：</label>
        <select id="yearSelect" onchange="updateCalendar()">
            <option value="2024">2024年</option>
            <option value="2025">2025年</option>
            <option value="2026">2026年</option>
        </select>
        <label for="monthSelect">月份：</label>
        <select id="monthSelect" onchange="updateCalendar()">
            <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
            <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
            <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
            <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
        </select>
    </div>

    <div class="employee-management">
        <button class="control-btn success" onclick="showEmployeeModal()">新增員工</button>
        <button class="control-btn" onclick="showShiftSettingsModal()">班別設定</button>
        <button class="control-btn" onclick="document.getElementById('importFile').click()">匯入班表</button>
    </div>

    <div class="controls">
        <button class="control-btn" id="editBtn" onclick="toggleEditMode()">編輯模式</button>
        <button class="control-btn success" onclick="loadTaiwanHolidays()">套用台灣假日</button>
        <button class="control-btn" onclick="exportSchedule()">匯出班表</button>

        <!-- ✅ 勾選1：過濾預設班別（正職上班／兼職休息） -->
        <label style="display:flex;align-items:center;gap:6px;font-size:.9rem;cursor:pointer;">
            <input type="checkbox" id="filterDefaults" checked>
            匯出時過濾預設班別（正職「上班」/ 兼職「休息」）
        </label>

        <!-- ✅ 勾選2：隱藏 類型/區域 兩欄 -->
        <label style="display:flex;align-items:center;gap:6px;font-size:.9rem;cursor:pointer;">
            <input type="checkbox" id="hideTypeArea" checked>
            匯出時隱藏「類型／區域」欄
        </label>

        <button class="control-btn danger" onclick="clearAllSchedule()">清空班表</button>
    </div>

    <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importSchedule(event)">
    <div class="edit-hint" id="editHint" style="display:none;">編輯模式已啟用，點擊員工排班項目修改班別</div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#d4edda;"></div><span>正常班</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#cce7ff;"></div><span>夜班</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#f8d7da;"></div><span>休假</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#f8f9fa;"></div><span>休息</span></div>
    </div>

    <div class="calendar-grid" id="calendar"></div>
    <div class="employee-summary" id="employeeSummary"></div>
    <div class="stats" id="stats"></div>
</div>

<!-- 班別設定模態框 -->
<div id="shiftSettingsModal" class="employee-modal">
    <div class="employee-modal-content">
        <h3>班別設定管理</h3>
        <div class="form-group">
            <label>新增班別：</label>
            <div class="shift-input-row">
                <input type="text" id="newShiftName" placeholder="班別名稱（如：早班、晚班、值班）" maxlength="20">
                <select id="newShiftType"><option value="fullTime">正職</option><option value="partTime">兼職</option></select>
                <select id="newShiftArea"><option value="front">外場</option><option value="back">內場</option></select>
                <input type="color" id="newShiftColor" value="#667eea">
                <button class="modal-btn primary" onclick="addNewShift()">新增</button>
            </div>
        </div>
        <div class="form-group">
            <label>現有班別：</label>
            <div id="allShiftsList" style="max-height:400px; overflow-y:auto;"></div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn primary" onclick="saveShiftSettings()">儲存設定</button>
            <button class="modal-btn secondary" onclick="closeShiftSettingsModal()">取消</button>
        </div>
    </div>
</div>

<!-- 員工資料卡模態框 -->
<div id="employeeModal" class="employee-modal">
    <div class="employee-modal-content">
        <h3>新增員工資料</h3>
        <div class="form-group">
            <label for="employeeName">員工姓名：</label>
            <input type="text" id="employeeName" placeholder="請輸入姓名" maxlength="20">
        </div>
        <div class="form-group">
            <label>員工類型：</label>
            <div class="radio-group">
                <div class="radio-option"><input type="radio" id="fullTime" name="employeeType" value="fullTime" checked><label for="fullTime">正職</label></div>
                <div class="radio-option"><input type="radio" id="partTime" name="employeeType" value="partTime"><label for="partTime">兼職</label></div>
            </div>
        </div>
        <div class="form-group">
            <label>工作區域：</label>
            <div class="radio-group">
                <div class="radio-option"><input type="radio" id="frontArea" name="workArea" value="front" checked><label for="frontArea">外場</label></div>
                <div class="radio-option"><input type="radio" id="backArea" name="workArea" value="back"><label for="backArea">內場</label></div>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn primary" onclick="addEmployeeFromModal()">確定新增</button>
            <button class="modal-btn secondary" onclick="closeEmployeeModal()">取消</button>
        </div>
    </div>
</div>

<!-- 確認刪除模態框 -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <p id="confirmMessage">確定要執行此操作嗎？</p>
        <button class="btn-confirm" onclick="confirmAction()">確定</button>
        <button class="btn-cancel" onclick="closeModal()">取消</button>
    </div>
</div>

<script>
/** =================== 全域狀態 =================== **/
let scheduleData = {};
const today = new Date();
let currentYear = today.getFullYear();
let currentMonth = today.getMonth() + 1;
let isEditMode = false;
let currentEditElement = null;
let pendingAction = null;
let pendingActionData = null;
let saveTimeout = null;

let shiftSettings = {
    allShifts: [
        { name: '上班', type: 'fullTime', area: 'front', color: '#28a745', category: 'work' },
        { name: '休假', type: 'fullTime', area: 'front', color: '#dc3545', category: 'holiday' },
        { name: '特休', type: 'fullTime', area: 'front', color: '#dc3545', category: 'holiday' },
        { name: '上班', type: 'fullTime', area: 'back', color: '#28a745', category: 'work' },
        { name: '休假', type: 'fullTime', area: 'back', color: '#dc3545', category: 'holiday' },
        { name: '特休', type: 'fullTime', area: 'back', color: '#dc3545', category: 'holiday' },
        { name: '休息', type: 'partTime', area: 'front', color: '#6c757d', category: 'off' },
        { name: '17:00-23:00', type: 'partTime', area: 'front', color: '#007bff', category: 'night' },
        { name: '18:00-24:00', type: 'partTime', area: 'front', color: '#007bff', category: 'night' },
        { name: '休息', type: 'partTime', area: 'back', color: '#6c757d', category: 'off' },
        { name: '17:00-23:00', type: 'partTime', area: 'back', color: '#007bff', category: 'night' },
        { name: '18:00-24:00', type: 'partTime', area: 'back', color: '#007bff', category: 'night' }
    ]
};

const weekdays = ['日','一','二','三','四','五','六'];

const holidays = { 2024: {}, 2025: {}, 2026: {} };
const taiwanHolidaysData = {
    2024: {'1/1':'元旦','2/10':'除夕','2/11':'春節','2/12':'初二','2/13':'初三','2/14':'初四','2/28':'和平紀念日','4/4':'兒童節','4/5':'清明節','5/1':'勞動節','6/10':'端午節','9/17':'中秋節','10/10':'國慶日'},
    2025: {'1/1':'元旦','1/28':'除夕','1/29':'春節','1/30':'初二','1/31':'初三','2/1':'初四','2/28':'和平紀念日','4/4':'兒童節','4/5':'清明節','5/1':'勞動節','5/31':'端午節','10/6':'中秋節','10/10':'國慶日'},
    2026: {'1/1':'元旦','2/16':'除夕','2/17':'春節','2/18':'初二','2/19':'初三','2/20':'初四','2/28':'和平紀念日','4/4':'兒童節','4/5':'清明節','5/1':'勞動節','6/19':'端午節','9/25':'中秋節','10/10':'國慶日'}
};

/** =================== 匯出選項判斷 =================== **/
function shouldFilterDefaults() {
    const el = document.getElementById('filterDefaults');
    return !!(el && el.checked);
}
function shouldHideTypeArea() {
    const el = document.getElementById('hideTypeArea');
    return !!(el && el.checked);
}

/** =================== 儲存/載入 =================== **/
function showSaveStatus(status) {
    const s = document.getElementById('saveStatus');
    s.className = `save-status ${status}`;
    if (status === 'saved') setTimeout(() => { s.className = 'save-status'; }, 2000);
}
function autoSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    showSaveStatus('saving');
    saveTimeout = setTimeout(() => { saveToStorage(); showSaveStatus('saved'); }, 1000);
}
function saveToStorage() {
    try {
        localStorage.setItem('employeeScheduleData', JSON.stringify(scheduleData));
        localStorage.setItem('lastSaveTime', new Date().toISOString());
    } catch (e) { console.error('儲存失敗', e); alert('儲存失敗，請檢查瀏覽器設定'); }
}
function loadFromStorage() {
    try {
        const saved = localStorage.getItem('employeeScheduleData');
        if (saved) { scheduleData = JSON.parse(saved); return true; }
        return false;
    } catch (e) { console.error('載入失敗', e); return false; }
}
function initializeDefaultData() {
    scheduleData = { employees: [], schedules: {} };
    saveToStorage();
}

/** =================== 班別設定 =================== **/
function showShiftSettingsModal(){ loadShiftSettings(); updateShiftDisplay(); document.getElementById('shiftSettingsModal').style.display='block'; }
function closeShiftSettingsModal(){ document.getElementById('shiftSettingsModal').style.display='none'; document.getElementById('newShiftName').value=''; document.getElementById('newShiftType').value='fullTime'; document.getElementById('newShiftArea').value='front'; document.getElementById('newShiftColor').value='#667eea'; }
function updateShiftDisplay(){
    const c=document.getElementById('allShiftsList'); c.innerHTML='';
    shiftSettings.allShifts.forEach((shift,idx)=>{
        const item=document.createElement('div'); item.className='shift-item'; item.style.borderLeftColor=shift.color;
        const typeText=shift.type==='fullTime'?'正職':'兼職';
        const areaText=shift.area==='front'?'外場':'內場';
        const info=document.createElement('div'); info.className='shift-item-info'; info.innerHTML=`<div class="shift-name">${shift.name}</div><div class="shift-details">${typeText} | ${areaText}</div>`;
        const actions=document.createElement('div'); actions.className='shift-item-actions';
        const color=document.createElement('div'); color.className='color-indicator'; color.style.background=shift.color; actions.appendChild(color);
        if (canDeleteShift(shift)) {
            const del=document.createElement('button'); del.className='delete-shift'; del.textContent='刪除'; del.onclick=()=>deleteShift(idx); actions.appendChild(del);
        } else {
            const tag=document.createElement('span'); tag.className='protected-badge'; tag.textContent='預設'; actions.appendChild(tag);
        }
        item.appendChild(info); item.appendChild(actions); c.appendChild(item);
    });
}
function canDeleteShift(shift){ return !['上班','休息'].includes(shift.name); }
function addNewShift(){
    const name=document.getElementById('newShiftName').value.trim();
    const type=document.getElementById('newShiftType').value;
    const area=document.getElementById('newShiftArea').value;
    const color=document.getElementById('newShiftColor').value;
    if(!name){ alert('請輸入班別名稱！'); return; }
    const exists=shiftSettings.allShifts.some(s=>s.name===name && s.type===type && s.area===area);
    if(exists){ alert('此班別已存在！'); return; }
    let category='work';
    if(name.includes('休')||name.includes('假')) category='holiday';
    else if(name.includes('夜')||name.includes(':')||name.includes('-')) category='night';
    else if(name.includes('休息')||name.includes('無')) category='off';
    shiftSettings.allShifts.push({name,type,area,color,category});
    document.getElementById('newShiftName').value=''; document.getElementById('newShiftColor').value='#667eea';
    updateShiftDisplay();
}
function deleteShift(i){ const s=shiftSettings.allShifts[i]; if(!canDeleteShift(s)) return alert('無法刪除基本班別！'); if(confirm(`確定要刪除班別「${s.name}」嗎？`)){ shiftSettings.allShifts.splice(i,1); updateShiftDisplay(); } }
function saveShiftSettings(){ try{ localStorage.setItem('shiftSettings', JSON.stringify(shiftSettings)); closeShiftSettingsModal(); alert('班別設定已儲存！'); }catch(e){ alert('儲存失敗'); } }
function loadShiftSettings(){ try{ const saved=localStorage.getItem('shiftSettings'); if(saved){ shiftSettings=JSON.parse(saved);} }catch(e){ console.error('載入班別設定失敗',e); } }

/** =================== 台灣假日 =================== **/
function loadTaiwanHolidays(){ holidays[2024]={...taiwanHolidaysData[2024]}; holidays[2025]={...taiwanHolidaysData[2025]}; holidays[2026]={...taiwanHolidaysData[2026]}; updateCalendar(); alert('已成功套用台灣國定假日！'); }

/** =================== 匯入 =================== **/
function importSchedule(e){
    const file=e.target.files[0]; if(!file) return;
    if(!file.name.endsWith('.csv')) return alert('請選擇CSV檔案！');
    const reader=new FileReader();
    reader.onload=function(ev){
        try{ parseAndImportCSV(ev.target.result); }catch(err){ alert('檔案讀取失敗：'+err.message); }
    };
    reader.readAsText(file,'utf-8'); e.target.value='';
}

function parseAndImportCSV(csvContent){
    const lines=csvContent.split('\n').filter(line=>line.trim());
    if(lines.length<2){ alert('CSV檔案格式不正確'); return; }
    const headers=lines[0].split(',').map(h=>h.trim());

    // 允許兩種表頭：含「姓名,類型,區域, M/D…」或僅「姓名, M/D…」
    const hasTypeArea = (headers[1]==='類型' && headers[2]==='區域');
    const dataStartIdx = hasTypeArea ? 3 : 1;

    if (headers.length < dataStartIdx + 1) {
        alert('CSV檔案格式不正確，缺少日期欄'); return;
    }

    const dateColumns = headers.slice(dataStartIdx);
    let targetYear=currentYear, targetMonth=null;

    if (dateColumns.length>0) {
        const firstDate=dateColumns[0];
        const m = firstDate.match(/(\d+)\/(\d+)/);
        if (m) { targetMonth=parseInt(m[1]); } else { alert('日期格式不正確'); return; }
    }

    const newEmployees=[]; const newSchedules={}; const scheduleKey=`${targetYear}-${targetMonth}`; newSchedules[scheduleKey]={};

    for(let i=1;i<lines.length;i++){
        const cells=lines[i].split(',').map(c=>c.trim());
        if (cells.length < dataStartIdx + 1) continue;

        const employeeName=cells[0];
        if(!employeeName) continue;

        const existingEmployee = scheduleData.employees && scheduleData.employees.find(emp=>emp.姓名===employeeName);

        const employeeTypeText = hasTypeArea ? cells[1] : '';
        const employeeAreaText = hasTypeArea ? cells[2] : '';

        const employeeType = hasTypeArea
            ? (employeeTypeText==='兼職' ? 'partTime' : 'fullTime')
            : (existingEmployee?.類型 || 'fullTime');

        const employeeArea = hasTypeArea
            ? (employeeAreaText==='內場' ? 'back' : 'front')
            : (existingEmployee?.區域 || 'front');

        if (!existingEmployee) {
            newEmployees.push({ 姓名: employeeName, 類型: employeeType, 區域: employeeArea });
        }

        newSchedules[scheduleKey][employeeName] = {};
        for (let j=dataStartIdx; j<cells.length && j<headers.length; j++){
            const dateStr=headers[j];
            const dayMatch=dateStr.match(/\d+\/(\d+)/);
            if(dayMatch){
                const day=parseInt(dayMatch[1]);
                const cellValue=cells[j];
                let scheduleValue=null;
                // 預設班別（上班/休息）不寫入（以 null 表示）
                if (cellValue && cellValue!=='上班' && cellValue!=='休息' && cellValue!=='') {
                    scheduleValue=cellValue;
                }
                newSchedules[scheduleKey][employeeName][day]=scheduleValue;
            }
        }
    }

    const confirmMessage=`即將匯入：${newEmployees.length}位新員工，${targetYear}年${targetMonth}月班表\n確定要繼續嗎？`;
    if(confirm(confirmMessage)){
        if(!scheduleData.employees) scheduleData.employees=[];
        newEmployees.forEach(ne=>scheduleData.employees.push(ne));
        if(!scheduleData.schedules) scheduleData.schedules={};
        Object.assign(scheduleData.schedules,newSchedules);

        currentYear=targetYear; currentMonth=targetMonth;
        document.getElementById('yearSelect').value=currentYear;
        document.getElementById('monthSelect').value=currentMonth;

        ensureScheduleData(currentYear,currentMonth);
        updateCalendar(); autoSave();
        alert(`匯入成功！已匯入 ${newEmployees.length} 位員工`);
    }
}

/** =================== 其他核心 =================== **/
function getScheduleOptions(employeeType, employeeArea='front'){
    const list=shiftSettings.allShifts.filter(s=>s.type===employeeType && s.area===employeeArea);
    const opts=[];
    const def=list.find(s=>s.name===(employeeType==='fullTime'?'上班':'休息'));
    if(def){ opts.push({value:null,label:def.name,class:getShiftTypeClass(def.category)+'-option'}); }
    list.forEach(s=>{ if(s.name!==(employeeType==='fullTime'?'上班':'休息')) opts.push({value:s.name,label:s.name,class:getShiftTypeClass(s.category)+'-option'}); });
    return opts;
}
function getShiftTypeClass(t){ switch(t){ case 'work':return 'work-day'; case 'holiday':return 'holiday'; case 'night':return 'night-shift'; case 'off':return 'off-day'; default:return 'work-day'; } }
function sortEmployees(emps){
    const order={'front-fullTime':1,'front-partTime':2,'back-fullTime':3,'back-partTime':4};
    return emps.sort((a,b)=>{ const ka=`${a.區域}-${a.類型}`; const kb=`${b.區域}-${b.類型}`; return (order[ka]||999)-(order[kb]||999); });
}
function ensureScheduleData(y,m){
    const key=`${y}-${m}`;
    if(!scheduleData.schedules) scheduleData.schedules={};
    if(!scheduleData.schedules[key]) scheduleData.schedules[key]={};
    const dim=getDaysInMonth(y,m);
    if(scheduleData.employees){
        scheduleData.employees.forEach(emp=>{
            if(!scheduleData.schedules[key][emp.姓名]) scheduleData.schedules[key][emp.姓名]={};
            for(let d=1; d<=dim; d++){
                if(!scheduleData.schedules[key][emp.姓名].hasOwnProperty(d)){
                    scheduleData.schedules[key][emp.姓名][d]=null;
                }
            }
        });
    }
}
function getDaysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function getFirstDayOfWeek(y,m){ return new Date(y,m-1,1).getDay(); }
function getHolidayName(y,m,d){ const k=`${m}/${d}`; return holidays[y] && holidays[y][k] ? holidays[y][k] : null; }
function isWeekend(y,m,d){ const dt=new Date(y,m-1,d); const w=dt.getDay(); return w===0||w===6; }

function getStaffClass(val, type){
    if(val===null) return type==='fullTime'?'work-day':'off-day';
    const shift=shiftSettings.allShifts.find(s=>s.name===val);
    if(shift) return getShiftTypeClass(shift.category);
    if(val.includes('休')||val.includes('假')) return 'holiday';
    if(val.includes(':')||val.includes('-')||val.includes('夜')) return 'night-shift';
    return 'work-day';
}
function getStaffDisplay(name,val,type){
    if(val===null){ const dn=type==='fullTime'?'班':''; return `${name} ${dn}`; }
    let t=val;
    if(val.includes('17:00-23:00')) t='17-23';
    else if(val.includes('18:00-24:00')) t='18-24';
    else if(val==='休假') t='休';
    else if(val==='特休') t='特';
    else if(val.length>4) t=val.substring(0,4);
    return `${name} ${t}`;
}

/** =================== UI互動 =================== **/
function updateCalendar(){
    currentYear=parseInt(document.getElementById('yearSelect').value);
    currentMonth=parseInt(document.getElementById('monthSelect').value);
    ensureScheduleData(currentYear,currentMonth);
    generateCalendar(); generateEmployeeSummary(); generateStats();
}
function toggleEditMode(){
    isEditMode=!isEditMode;
    const btn=document.getElementById('editBtn'); const hint=document.getElementById('editHint');
    if(isEditMode){ btn.textContent='完成編輯'; btn.classList.add('edit-mode'); hint.style.display='block'; }
    else { btn.textContent='編輯模式'; btn.classList.remove('edit-mode'); hint.style.display='none'; closeEditDropdown(); }
    generateCalendar(); generateEmployeeSummary();
}
function showEmployeeModal(){ document.getElementById('employeeModal').style.display='block'; document.getElementById('employeeName').focus(); }
function closeEmployeeModal(){ document.getElementById('employeeModal').style.display='none'; document.getElementById('employeeName').value=''; document.getElementById('fullTime').checked=true; document.getElementById('frontArea').checked=true; }
function addEmployeeFromModal(){
    const name=document.getElementById('employeeName').value.trim();
    const type=document.querySelector('input[name="employeeType"]:checked').value;
    const area=document.querySelector('input[name="workArea"]:checked').value;
    if(!name) return alert('請輸入員工姓名！');
    if(scheduleData.employees && scheduleData.employees.find(emp=>emp.姓名===name)) return alert('員工姓名已存在！');
    const ne={'姓名':name,'類型':type,'區域':area};
    if(!scheduleData.employees) scheduleData.employees=[];
    scheduleData.employees.push(ne);
    Object.keys(scheduleData.schedules).forEach(k=>{
        const [y,m]=k.split('-').map(Number); const dim=getDaysInMonth(y,m);
        scheduleData.schedules[k][name]={};
        for(let d=1; d<=dim; d++){ scheduleData.schedules[k][name][d]=null; }
    });
    closeEmployeeModal(); updateCalendar(); autoSave();
    const t=type==='fullTime'?'正職':'兼職'; const a=area==='front'?'外場':'內場';
    alert(`已新增員工：${name}（${a}${t}）`);
}
function removeEmployee(name){
    pendingAction='removeEmployee'; pendingActionData=name;
    document.getElementById('confirmMessage').textContent=`確定要刪除員工「${name}」嗎？`;
    document.getElementById('confirmModal').style.display='block';
}
function createEditDropdown(el, name, day){
    closeEditDropdown();
    const emp=scheduleData.employees.find(e=>e.姓名===name); if(!emp) return;
    const dd=document.createElement('div'); dd.className='edit-dropdown';
    const opts=getScheduleOptions(emp.類型, emp.區域);
    opts.forEach(o=>{
        const op=document.createElement('div'); op.className=`edit-option ${o.class}`; op.textContent=o.label;
        op.addEventListener('click',(e)=>{ e.stopPropagation(); updateSchedule(name,day,o.value); });
        dd.appendChild(op);
    });
    el.appendChild(dd); el.classList.add('editing'); currentEditElement=el;
}
function closeEditDropdown(){
    if(currentEditElement){
        const dd=currentEditElement.querySelector('.edit-dropdown'); if(dd) dd.remove();
        currentEditElement.classList.remove('editing'); currentEditElement=null;
    }
}
function updateSchedule(name, day, val){
    const key=`${currentYear}-${currentMonth}`;
    if(!scheduleData.schedules[key]) scheduleData.schedules[key]={};
    if(!scheduleData.schedules[key][name]) scheduleData.schedules[key][name]={};
    scheduleData.schedules[key][name][day]=val;
    generateCalendar(); generateEmployeeSummary(); generateStats(); autoSave(); closeEditDropdown();
}

function generateCalendar(){
    const c=document.getElementById('calendar'); c.innerHTML='';
    weekdays.forEach((d,i)=>{ const h=document.createElement('div'); h.className='day-header'; if(i===0||i===6) h.classList.add('weekend-header'); h.textContent=d; c.appendChild(h); });
    const dim=getDaysInMonth(currentYear,currentMonth);
    const first=getFirstDayOfWeek(currentYear,currentMonth);
    for(let i=0;i<first;i++){ const e=document.createElement('div'); e.className='day-cell empty-cell'; c.appendChild(e); }
    for(let day=1; day<=dim; day++){
        const cell=document.createElement('div'); cell.className='day-cell';
        if(isWeekend(currentYear,currentMonth,day)) cell.classList.add('weekend-cell');
        const head=document.createElement('div'); head.className='day-header-info';
        const dn=document.createElement('div'); dn.className='day-number'; dn.textContent=day; head.appendChild(dn);
        const hname=getHolidayName(currentYear,currentMonth,day); if(hname){ const he=document.createElement('div'); he.className='holiday-name'; he.textContent=hname; head.appendChild(he); }
        cell.appendChild(head);
        const list=document.createElement('div'); list.className='staff-schedule';
        if(scheduleData.employees){
            const sorted=sortEmployees([...scheduleData.employees]);
            const key=`${currentYear}-${currentMonth}`;
            sorted.forEach(emp=>{
                const val = scheduleData.schedules[key] && scheduleData.schedules[key][emp.姓名] ? scheduleData.schedules[key][emp.姓名][day] : null;
                const item=document.createElement('div'); item.className=`staff-item ${getStaffClass(val, emp.類型)}`;
                item.textContent=getStaffDisplay(emp.姓名, val, emp.類型);
                if(isEditMode){ item.classList.add('editable'); item.addEventListener('click',(e)=>{ e.stopPropagation(); createEditDropdown(item, emp.姓名, day); }); }
                list.appendChild(item);
            });
        }
        cell.appendChild(list); c.appendChild(cell);
    }
}

function generateEmployeeSummary(){
    const wrap=document.getElementById('employeeSummary'); wrap.innerHTML='';
    if(!scheduleData.employees) return;
    const dim=getDaysInMonth(currentYear,currentMonth);
    const sorted=sortEmployees([...scheduleData.employees]);
    const key=`${currentYear}-${currentMonth}`;
    sorted.forEach(emp=>{
        let work=0, hol=0, night=0, off=0;
        for(let d=1; d<=dim; d++){
            const v = scheduleData.schedules[key] && scheduleData.schedules[key][emp.姓名] ? scheduleData.schedules[key][emp.姓名][d] : null;
            if(v===null){ if(emp.類型==='fullTime') work++; else off++; }
            else if(v==='休假' || v==='特休'){ hol++; }
            else if(v && (v.includes('17:00-23:00') || v.includes('18:00-24:00') || v.includes('17:00-24:00'))){ night++; }
            else if(v==='休息'){ off++; }
            else { work++; }
        }
        const card=document.createElement('div'); card.className='employee-card';
        if(isEditMode){
            card.classList.add('edit-mode');
            const del=document.createElement('button'); del.className='delete-employee'; del.textContent='×'; del.onclick=()=>removeEmployee(emp.姓名); card.appendChild(del);
            card.addEventListener('mouseenter',()=>{ del.style.display='flex'; });
            card.addEventListener('mouseleave',()=>{ del.style.display='none'; });
        }
        const tt=emp.類型==='fullTime'?'正職':'兼職';
        const at=emp.區域==='front'?'外場':'內場';
        card.innerHTML+=`
            <div class="employee-name">${emp.姓名} (${at}${tt})</div>
            <div class="employee-stats">
                <span>工作: ${work+night}天</span>
                <span>班次: ${night}天</span>
                <span>休假: ${hol}天</span>
                <span>休息: ${off}天</span>
            </div>`;
        wrap.appendChild(card);
    });
}

function generateStats(){
    const s=document.getElementById('stats'); s.innerHTML='';
    if(!scheduleData.employees) return;
    const dim=getDaysInMonth(currentYear,currentMonth);
    const key=`${currentYear}-${currentMonth}`;
    let totHol=0, totNight=0, totWork=0, totOff=0;
    scheduleData.employees.forEach(emp=>{
        for(let d=1; d<=dim; d++){
            const v = scheduleData.schedules[key] && scheduleData.schedules[key][emp.姓名] ? scheduleData.schedules[key][emp.姓名][d] : null;
            if(v===null || v===undefined || v===''){ if(emp.類型==='fullTime') totWork++; else totOff++; }
            else if(v==='休假' || v==='特休'){ totHol++; }
            else if(v && (v.includes('17:00-23:00') || v.includes('18:00-24:00') || v.includes('17:00-24:00'))){ totNight++; }
            else if(v==='休息'){ totOff++; }
            else { totWork++; }
        }
    });
    const arr=[
        {label:'總員工數',value:scheduleData.employees.length},
        {label:'總工作天數',value:totWork+totNight},
        {label:'總班次數',value:totNight},
        {label:'總休假天數',value:totHol},
        {label:'總休息天數',value:totOff}
    ];
    arr.forEach(st=>{ const c=document.createElement('div'); c.className='stat-card'; c.innerHTML=`<div class="stat-number">${st.value}</div><div class="stat-label">${st.label}</div>`; s.appendChild(c); });
}

/** =================== 匯出 =================== **/
function exportSchedule(){
    const csv=generateCSV(shouldFilterDefaults(), shouldHideTypeArea());
    const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); const url=URL.createObjectURL(blob);
    a.setAttribute('href',url);
    a.setAttribute('download',`班表_${currentYear}年${currentMonth}月_${new Date().toISOString().slice(0,10)}.csv`);
    a.style.visibility='hidden'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// filterDefaults: 是否將 正職(null/上班) 與 兼職(null/休息) 輸出成空白
// hideTypeArea: 是否隱藏「類型 / 區域」兩欄
function generateCSV(filterDefaults=false, hideTypeArea=false){
    if(!scheduleData.employees) return '';
    const headers=['姓名'];
    if(!hideTypeArea){ headers.push('類型','區域'); }
    const dim=getDaysInMonth(currentYear,currentMonth);
    for(let d=1; d<=dim; d++) headers.push(`${currentMonth}/${d}`);
    let csv=headers.join(',')+'\n';

    const key=`${currentYear}-${currentMonth}`;
    const sorted=sortEmployees([...scheduleData.employees]);
    sorted.forEach(emp=>{
        const typeText=emp.類型==='fullTime'?'正職':'兼職';
        const areaText=emp.區域==='front'?'外場':'內場';
        const row=[emp.姓名];
        if(!hideTypeArea){ row.push(typeText, areaText); }
        for(let d=1; d<=dim; d++){
            let val = scheduleData.schedules[key]?.[emp.姓名]?.[d] ?? null;
            if(filterDefaults){
                if(emp.類型==='fullTime' && (val===null || val==='上班')) val='';
                else if(emp.類型==='partTime' && (val===null || val==='休息')) val='';
            }else{
                if(val===null || val===undefined || val===''){
                    val = (emp.類型==='fullTime' ? '上班' : '休息');
                }
            }
            row.push(val ?? '');
        }
        csv += row.join(',')+'\n';
    });
    return csv;
}

/** =================== 清空/確認 =================== **/
function clearAllSchedule(){
    pendingAction='clear';
    document.getElementById('confirmMessage').textContent='確定要清空所有班表資料嗎？';
    document.getElementById('confirmModal').style.display='block';
}
function confirmAction(){
    if(pendingAction==='removeEmployee'){
        const idx=scheduleData.employees.findIndex(emp=>emp.姓名===pendingActionData);
        if(idx>-1){
            const name=scheduleData.employees[idx].姓名;
            scheduleData.employees.splice(idx,1);
            Object.keys(scheduleData.schedules).forEach(k=>{ if(scheduleData.schedules[k][name]) delete scheduleData.schedules[k][name]; });
            generateCalendar(); generateEmployeeSummary(); generateStats(); autoSave();
            alert(`已刪除員工：${pendingActionData}`);
        }
    }else if(pendingAction==='clear'){
        const key=`${currentYear}-${currentMonth}`; const dim=getDaysInMonth(currentYear,currentMonth);
        if(scheduleData.schedules[key] && scheduleData.employees){
            scheduleData.employees.forEach(emp=>{
                for(let d=1; d<=dim; d++){
                    if(scheduleData.schedules[key][emp.姓名]) scheduleData.schedules[key][emp.姓名][d]=null;
                }
            });
        }
        generateCalendar(); generateEmployeeSummary(); generateStats(); autoSave(); alert('班表已清空！');
    }
    closeModal();
}
function closeModal(){ document.getElementById('confirmModal').style.display='none'; pendingAction=null; pendingActionData=null; }

document.addEventListener('click',(e)=>{
    if(isEditMode && !e.target.closest('.edit-dropdown')) closeEditDropdown();
    if(e.target.id==='confirmModal') closeModal();
    if(e.target.id==='employeeModal') closeEmployeeModal();
    if(e.target.id==='shiftSettingsModal') closeShiftSettingsModal();
});

/** =================== 初始化 =================== **/
document.addEventListener('DOMContentLoaded', function(){
    localStorage.removeItem('employeeScheduleData');
    localStorage.removeItem('lastSaveTime');
    document.getElementById('yearSelect').value=currentYear;
    document.getElementById('monthSelect').value=currentMonth;
    loadShiftSettings();
    if(!loadFromStorage()) initializeDefaultData();
    ensureScheduleData(currentYear,currentMonth);
    updateCalendar();
    setInterval(()=>{ if(!saveTimeout) saveToStorage(); }, 600000);
});
</script>
</body>
</html>
