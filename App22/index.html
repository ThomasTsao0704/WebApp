<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥ç­è¡¨ç®¡ç†ç³»çµ±</title>
    <style>
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            min-width: 380px;
            margin: 0 auto;
            background: #fff;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg,#667eea,#764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ç”¨æˆ¶è§’è‰²åˆ‡æ› */
        .role-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #667eea;
        }
        
        .role-badge {
            background: linear-gradient(45deg,#667eea,#764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .role-badge.employee {
            background: linear-gradient(45deg,#28a745,#20c997);
        }
        
        /* ç®¡ç†è€…å°ˆç”¨åŠŸèƒ½ */
        .admin-only {
            display: none;
        }
        
        .admin-mode .admin-only {
            display: inline-block;
        }
        
        .employee-mode .admin-only {
            display: none;
        }
        
        /* å°èˆªæ¨™ç±¤ */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            gap: 5px;
        }
        
        .nav-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .nav-tab.active {
            background: linear-gradient(45deg,#667eea,#764ba2);
            color: white;
        }
        
        /* å…§å®¹å€åŸŸ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ç­è¡¨æ¨™é¡Œå€ */
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .schedule-header h3 {
            margin: 0;
            color: white;
            font-weight: 600;
            font-size: 1.4rem;
        }
        
        .main-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .date-control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .date-control-group label {
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .date-control-group select {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
            font-weight: 500;
        }
        
        /* åŠŸèƒ½é¢æ¿ */
        .function-panel {
            background: white;
            border: 2px solid #e0e6ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .function-group {
            margin-bottom: 25px;
        }
        
        .function-group:last-child {
            margin-bottom: 0;
        }
        
        .group-label {
            display: block;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 8px;
            display: inline-block;
        }
        
        /* åŠŸèƒ½æŒ‰éˆ• */
        .function-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(45deg,#667eea,#764ba2);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all .3s ease;
            font-size: 1rem;
            min-height: 45px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .control-btn.danger {
            background: linear-gradient(45deg,#dc3545,#c82333);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        
        .control-btn.danger:hover {
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }
        
        .control-btn.success {
            background: linear-gradient(45deg,#28a745,#20c997);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .control-btn.success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .control-btn.small {
            padding: 8px 15px;
            font-size: 0.85rem;
            min-height: 36px;
        }
        
        .btn-icon {
            font-size: 1.2em;
        }
        
        /* åŒ¯å‡ºé¸é … */
        .export-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 18px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid transparent;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            user-select: none;
        }
        
        .option-item:hover {
            background: linear-gradient(135deg, #e7f3ff 0%, #d4e6ff 100%);
            border-color: #667eea;
            transform: translateY(-1px);
        }
        
        .option-item input[type="checkbox"] {
            margin: 0;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        
        /* ç·¨è¼¯æç¤º */
        .edit-hint {
            display: none;
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
            border: 2px solid #b3d7ff;
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 25px;
            text-align: center;
            color: #0066cc;
            font-size: 1rem;
            font-weight: 600;
            animation: slideIn 0.4s ease;
            box-shadow: 0 2px 10px rgba(179, 215, 255, 0.3);
        }
        
        .hint-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* å“¡å·¥ç®¡ç† */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .employee-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #667eea;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .employee-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .employee-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .employee-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
        }
        
        .employee-card:hover .employee-actions {
            display: flex;
            gap: 5px;
        }
        
        /* ç­è¡¨é¡¯ç¤º */
        .calendar-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e9ecef;
            border-radius: 12px;
            padding: 8px;
            min-width: 350px;
            overflow-x: auto;
        }
        
        .day-header {
            background: linear-gradient(45deg,#667eea,#764ba2);
            color: #fff;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .weekend-header {
            background: linear-gradient(45deg,#ff6b6b,#ee5a52) !important;
        }
        
        .day-cell {
            background: #fff;
            border-radius: 6px;
            padding: 8px;
            min-height: 120px;
            position: relative;
        }
        
        .day-number {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            margin-bottom: 8px;
        }
        
        .weekend-cell .day-number {
            color: #ff6b6b;
        }
        
        .empty-cell {
            background: #f8f9fa;
            opacity: 0.5;
        }
        
        .holiday-name {
            font-size: 0.7rem;
            color: #dc3545;
            font-weight: 600;
            text-align: right;
            line-height: 1.2;
            max-width: 60px;
        }
        
        .staff-schedule {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .staff-item {
            padding: 3px 5px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            cursor: default;
            transition: all 0.2s ease;
            position: relative;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .staff-item.editable {
            cursor: pointer !important;
            border: 1px dashed #007bff !important;
            transition: all 0.2s ease;
        }
        
        /* å–ä»£åŸæœ¬çš„ hoverï¼šä¸å†ç¸®æ”¾ï¼Œé¿å…æ¸¸æ¨™æŠ–å‹•å°è‡´èª¤è§¸ */
        .staff-item.editable:hover {
            border: 1px solid #007bff !important;
            box-shadow: 0 0 8px rgba(0,123,255,.3) !important;
        }
        
        /* ä¸‹æ‹‰é–‹å•Ÿæ™‚ï¼Œé–å®šå¤–è§€ï¼ˆé¿å… hover è®ŠåŒ–é€ æˆ reflowï¼‰ */
        .staff-item.editable.open {
            border: 1px solid #007bff !important;
            box-shadow: 0 0 8px rgba(0,123,255,.3) !important;
        }
        
        .work-day { background: #d4edda; color: #155724; }
        .holiday { background: #f8d7da; color: #721c24; }
        .night-shift { background: #cce7ff; color: #004085; }
        .off-day { background: #f8f9fa; color: #6c757d; }
        
        /* Portal ç‰ˆä¸‹æ‹‰ï¼ˆfixed å®šä½ï¼Œé¿å…è¢«å®¹å™¨ overflow å½±éŸ¿ï¼‰ */
        .edit-dropdown {
            position: fixed;          /* â† ç”±åŸæœ¬ absolute æ”¹ç‚º fixed */
            left: 0; top: 0;          /* ç”± JS è¨ˆç®—å¯¦éš›åº§æ¨™ */
            width: 240px;             /* çµ±ä¸€å¯¬åº¦ï¼Œé¿å… hover æŠ–å‹• */
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 8px;
            z-index: 9999;
            box-shadow: 0 8px 20px rgba(0,0,0,0.16);
            max-height: 260px;
            overflow-y: auto;
            pointer-events: auto;
        }
        
        /* ä¸‹æ‹‰é …ç›® hover ä¸å†å½±éŸ¿çˆ¶å…ƒç´  */
        .edit-option {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color .15s ease;
        }
        .edit-option:last-child { border-bottom: none; }
        .edit-option:hover { background: #f8f9fa; }
        
        /* æ¨¡æ…‹æ¡† */
        .employee-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            inset: 0;
            background-color: rgba(0,0,0,.5);
        }
        
        .employee-modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* è¡¨å–® */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
        }
        
        .modal-btn.primary {
            background: linear-gradient(45deg,#667eea,#764ba2);
            color: #fff;
        }
        
        .modal-btn.secondary {
            background: #6c757d;
            color: #fff;
        }
        
        .modal-btn.danger {
            background: linear-gradient(45deg,#dc3545,#c82333);
            color: #fff;
        }
        
        /* çµ±è¨ˆ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color: #fff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        /* ç­åˆ¥è¨­å®š */
        .shift-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .shift-form .full-width {
            grid-column: 1 / -1;
        }
        
        .shift-card {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .shift-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .shift-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .shift-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: #333;
        }
        
        .shift-code {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .shift-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
            color: #666;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .shift-form {
                grid-template-columns: 1fr;
            }
            
            .role-switcher {
                position: static;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .calendar-grid {
                min-width: 350px;
            }
            
            .schedule-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
                text-align: center;
            }
            
            .main-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .date-control-group {
                justify-content: center;
            }
            
            .function-panel {
                padding: 20px 15px;
            }
            
            .function-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-options {
                flex-direction: column;
                align-items: stretch;
            }
            
            .option-item {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .schedule-header {
                padding: 15px;
            }
            
            .function-panel {
                padding: 15px 10px;
            }
            
            .date-control-group {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .date-control-group select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="header">
            <h1>å“¡å·¥ç­è¡¨ç®¡ç†ç³»çµ±</h1>
            <div class="role-switcher">
                <span>ç•¶å‰èº«ä»½ï¼š</span>
                <span class="role-badge" id="roleBadge">ç®¡ç†è€…</span>
                <button class="control-btn small" onclick="toggleRole()">åˆ‡æ›èº«ä»½</button>
            </div>
        </div>

        <!-- å°èˆªæ¨™ç±¤ -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('schedule')">æŸ¥çœ‹ç­è¡¨</button>
            <button class="nav-tab admin-only" onclick="showTab('employee')">å“¡å·¥ç®¡ç†</button>
            <button class="nav-tab admin-only" onclick="showTab('shift')">ç­åˆ¥è¨­å®š</button>
            <button class="nav-tab" onclick="showTab('stats')">çµ±è¨ˆå ±è¡¨</button>
        </div>

        <!-- ç­è¡¨æŸ¥çœ‹æ¨™ç±¤ -->
        <div id="scheduleTab" class="tab-content active">
            <!-- æ¨™é¡Œèˆ‡ä¸»è¦æ§åˆ¶å€ -->
            <div class="schedule-header">
                <h3>ğŸ“Š ç­è¡¨æŸ¥çœ‹</h3>
                <div class="main-controls">
                    <div class="date-control-group">
                        <label>é¸æ“‡å¹´æœˆï¼š</label>
                        <select id="yearSelect" onchange="changeYearMonth()">
                            <option value="2024">2024å¹´</option>
                            <option value="2025">2025å¹´</option>
                            <option value="2026">2026å¹´</option>
                        </select>
                        <select id="monthSelect" onchange="changeYearMonth()">
                            <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <button class="control-btn success admin-only" id="editModeBtn" onclick="toggleEditMode()">
                        <span class="btn-icon">âœï¸</span> ç·¨è¼¯æ¨¡å¼
                    </button>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æ“ä½œé¢æ¿ -->
            <div class="function-panel">
                <div class="function-group">
                    <span class="group-label">ğŸ“‹ ç­è¡¨æ“ä½œ</span>
                    <div class="function-buttons">
                        <button class="control-btn admin-only" onclick="document.getElementById('importFile').click()">
                            <span class="btn-icon">ğŸ“</span> åŒ¯å…¥ç­è¡¨
                        </button>
                        <button class="control-btn admin-only" onclick="exportSchedule()">
                            <span class="btn-icon">ğŸ’¾</span> åŒ¯å‡ºç­è¡¨
                        </button>
                        <button class="control-btn danger admin-only" onclick="clearAllSchedule()">
                            <span class="btn-icon">ğŸ—‘ï¸</span> æ¸…ç©ºç­è¡¨
                        </button>
                    </div>
                </div>
                
                <div class="function-group">
                    <span class="group-label">âš™ï¸ åŒ¯å‡ºè¨­å®š</span>
                    <div class="export-options">
                        <label class="option-item">
                            <input type="checkbox" id="filterDefaults" checked>
                            <span>éæ¿¾é è¨­ç­åˆ¥</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" id="hideTypeArea" checked>
                            <span>éš±è—é¡å‹æ¬„ä½</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- éš±è—çš„æª”æ¡ˆè¼¸å…¥ -->
            <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importSchedule(event)">
            
            <!-- ç·¨è¼¯æç¤º -->
            <div id="editHint" class="edit-hint">
                <span class="hint-icon">âœï¸</span>
                ç·¨è¼¯æ¨¡å¼å·²å•Ÿç”¨ï¼Œé»æ“Šå“¡å·¥æ’ç­é …ç›®ä¿®æ”¹ç­åˆ¥
            </div>
            
            <div class="calendar-container">
                <div class="calendar-grid" id="calendar"></div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†æ¨™ç±¤ -->
        <div id="employeeTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>å“¡å·¥ç®¡ç†</h3>
                <button class="control-btn success admin-only" onclick="showEmployeeModal()">æ–°å¢å“¡å·¥</button>
            </div>
            <div class="employee-grid" id="employeeGrid"></div>
        </div>

        <!-- ç­åˆ¥è¨­å®šæ¨™ç±¤ -->
        <div id="shiftTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>ç­åˆ¥è¨­å®š</h3>
                <button class="control-btn success admin-only" onclick="showShiftSettingsModal()">æ–°å¢ç­åˆ¥</button>
            </div>
            <div id="shiftsList"></div>
        </div>

        <!-- çµ±è¨ˆå ±è¡¨æ¨™ç±¤ -->
        <div id="statsTab" class="tab-content">
            <h3>çµ±è¨ˆå ±è¡¨</h3>
            <div class="stats" id="stats"></div>
        </div>

        <!-- å“¡å·¥è³‡æ–™æ¨¡æ…‹æ¡† -->
        <div id="employeeModal" class="employee-modal">
            <div class="employee-modal-content">
                <h3>æ–°å¢å“¡å·¥è³‡æ–™</h3>
                <div class="form-group">
                    <label for="employeeName">å“¡å·¥å§“åï¼š</label>
                    <input type="text" id="employeeName" placeholder="è«‹è¼¸å…¥å§“å" maxlength="20">
                </div>
                <div class="form-group">
                    <label>å“¡å·¥é¡å‹ï¼š</label>
                    <div style="display: flex; gap: 20px;">
                        <label><input type="radio" id="fullTime" name="employeeType" value="fullTime" checked> æ­£è·</label>
                        <label><input type="radio" id="partTime" name="employeeType" value="partTime"> å…¼è·</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>å·¥ä½œå€åŸŸï¼š</label>
                    <div style="display: flex; gap: 20px;">
                        <label><input type="radio" id="frontArea" name="workArea" value="front" checked> å¤–å ´</label>
                        <label><input type="radio" id="backArea" name="workArea" value="back"> å…§å ´</label>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="modal-btn primary" onclick="addEmployeeFromModal()">ç¢ºå®šæ–°å¢</button>
                    <button class="modal-btn secondary" onclick="closeEmployeeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç­åˆ¥è¨­å®šæ¨¡æ…‹æ¡† -->
        <div id="shiftSettingsModal" class="employee-modal">
            <div class="employee-modal-content">
                <h3>ç­åˆ¥è¨­å®šç®¡ç†</h3>
                <div class="shift-form">
                    <div class="form-group">
                        <label for="shiftCode">ç­åˆ¥ä»£ç¢¼ï¼š</label>
                        <input type="text" id="shiftCode" placeholder="å¦‚ï¼šDAY01, NIGHT02" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label for="shiftName">ç­åˆ¥åç¨±ï¼š</label>
                        <input type="text" id="shiftName" placeholder="å¦‚ï¼šæ—©ç­ã€æ™šç­ã€å€¼ç­" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label>é–‹å§‹æ™‚é–“ï¼š</label>
                        <input type="time" id="startTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ™‚é–“ï¼š</label>
                        <input type="time" id="endTime" value="18:00">
                    </div>
                    <div class="form-group">
                        <label for="shiftType">å“¡å·¥é¡å‹ï¼š</label>
                        <select id="shiftType">
                            <option value="fullTime">æ­£è·</option>
                            <option value="partTime">å…¼è·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="shiftArea">å·¥ä½œå€åŸŸï¼š</label>
                        <select id="shiftArea">
                            <option value="front">å¤–å ´</option>
                            <option value="back">å…§å ´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="shiftColor">é¡¯ç¤ºé¡è‰²ï¼š</label>
                        <input type="color" id="shiftColor" value="#667eea">
                    </div>
                    <div class="form-group">
                        <label for="abbreviation">ç°¡ç¨±ï¼š</label>
                        <input type="text" id="abbreviation" placeholder="ç”¨æ–¼ç­è¡¨é¡¯ç¤ºçš„ç°¡ç¨±" maxlength="4">
                    </div>
                    <div class="form-group full-width">
                        <button class="modal-btn primary" onclick="addEnhancedShift()">æ–°å¢ç­åˆ¥</button>
                        <button class="modal-btn secondary" onclick="closeShiftSettingsModal()">å–æ¶ˆ</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>ç¾æœ‰ç­åˆ¥ï¼š</label>
                    <div id="allShiftsList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- ç¢ºèªåˆªé™¤æ¨¡æ…‹æ¡† -->
        <div id="confirmModal" class="employee-modal">
            <div class="employee-modal-content" style="max-width: 400px; text-align: center;">
                <h3>ç¢ºèªæ“ä½œ</h3>
                <p id="confirmMessage" style="margin: 20px 0; font-size: 1.1rem;">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="modal-btn danger" onclick="confirmAction()">ç¢ºå®š</button>
                    <button class="modal-btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¾›ä¸‹æ‹‰é¸å–®æ›è¼‰ï¼ˆé¿å…è¢«æ ¼å­/å®¹å™¨è£åˆ‡ï¼‰ -->
    <div id="dropdown-portal"></div>

    <script>
        // å…¨åŸŸç‹€æ…‹
        let scheduleData = {};
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth() + 1;
        let isEditMode = false;
        let currentEditElement = null;
        let currentDropdown = null;
        let repositionHandlersBound = false;
        let pendingAction = null;
        let pendingActionData = null;
        let saveTimeout = null;
        let currentRole = 'admin';

        // ç­åˆ¥è¨­å®š
        let shiftSettings = {
            allShifts: [
                // æ­£è·å¤–å ´ç­åˆ¥
                { name: 'æ—©ç­', type: 'fullTime', area: 'front', color: '#28a745', category: 'work', code: 'DAY01', startTime: '09:00', endTime: '18:00', abbreviation: 'æ—©' },
                { name: 'æ™šç­', type: 'fullTime', area: 'front', color: '#6f42c1', category: 'work', code: 'LATE01', startTime: '14:00', endTime: '23:00', abbreviation: 'æ™š' },
                { name: 'ä¼‘å‡', type: 'fullTime', area: 'front', color: '#dc3545', category: 'holiday', code: 'HOL01', startTime: '00:00', endTime: '00:00', abbreviation: 'ä¼‘' },
                // æ­£è·å…§å ´ç­åˆ¥
                { name: 'æ—©ç­', type: 'fullTime', area: 'back', color: '#28a745', category: 'work', code: 'DAY02', startTime: '09:00', endTime: '18:00', abbreviation: 'æ—©' },
                { name: 'æ™šç­', type: 'fullTime', area: 'back', color: '#6f42c1', category: 'work', code: 'LATE02', startTime: '14:00', endTime: '23:00', abbreviation: 'æ™š' },
                { name: 'ä¼‘å‡', type: 'fullTime', area: 'back', color: '#dc3545', category: 'holiday', code: 'HOL02', startTime: '00:00', endTime: '00:00', abbreviation: 'ä¼‘' },
                // å…¼è·å¤–å ´ç­åˆ¥
                { name: '17:00-23:00', type: 'partTime', area: 'front', color: '#007bff', category: 'night', code: 'PT01', startTime: '17:00', endTime: '23:00', abbreviation: '17-23' },
                { name: '18:00-24:00', type: 'partTime', area: 'front', color: '#17a2b8', category: 'night', code: 'PT02', startTime: '18:00', endTime: '24:00', abbreviation: '18-24' },
                // å…¼è·å…§å ´ç­åˆ¥
                { name: '17:00-23:00', type: 'partTime', area: 'back', color: '#007bff', category: 'night', code: 'PT03', startTime: '17:00', endTime: '23:00', abbreviation: '17-23' },
                { name: '18:00-24:00', type: 'partTime', area: 'back', color: '#17a2b8', category: 'night', code: 'PT04', startTime: '18:00', endTime: '24:00', abbreviation: '18-24' }
            ]
        };

        const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        const holidays = { 2024: {}, 2025: {}, 2026: {} };
        const taiwanHolidaysData = {
            2024: {'1/1':'å…ƒæ—¦','2/10':'é™¤å¤•','2/11':'æ˜¥ç¯€','2/12':'åˆäºŒ','2/13':'åˆä¸‰','2/14':'åˆå››','2/28':'å’Œå¹³ç´€å¿µæ—¥','4/4':'å…’ç«¥ç¯€','4/5':'æ¸…æ˜ç¯€','5/1':'å‹å‹•ç¯€','6/10':'ç«¯åˆç¯€','9/17':'ä¸­ç§‹ç¯€','10/10':'åœ‹æ…¶æ—¥'},
            2025: {'1/1':'å…ƒæ—¦','1/28':'é™¤å¤•','1/29':'æ˜¥ç¯€','1/30':'åˆäºŒ','1/31':'åˆä¸‰','2/1':'åˆå››','2/28':'å’Œå¹³ç´€å¿µæ—¥','4/4':'å…’ç«¥ç¯€','4/5':'æ¸…æ˜ç¯€','5/1':'å‹å‹•ç¯€','5/31':'ç«¯åˆç¯€','10/6':'ä¸­ç§‹ç¯€','10/10':'åœ‹æ…¶æ—¥'},
            2026: {'1/1':'å…ƒæ—¦','2/16':'é™¤å¤•','2/17':'æ˜¥ç¯€','2/18':'åˆäºŒ','2/19':'åˆä¸‰','2/20':'åˆå››','2/28':'å’Œå¹³ç´€å¿µæ—¥','4/4':'å…’ç«¥ç¯€','4/5':'æ¸…æ˜ç¯€','5/1':'å‹å‹•ç¯€','6/19':'ç«¯åˆç¯€','9/25':'ä¸­ç§‹ç¯€','10/10':'åœ‹æ…¶æ—¥'}
        };

        // è‡ªå‹•è¼‰å…¥å°ç£å‡æ—¥
        function loadTaiwanHolidays() {
            holidays[2024] = {...taiwanHolidaysData[2024]};
            holidays[2025] = {...taiwanHolidaysData[2025]};
            holidays[2026] = {...taiwanHolidaysData[2026]};
        }

        function getHolidayName(year, month, day) {
            const key = `${month}/${day}`;
            return holidays[year] && holidays[year][key] ? holidays[year][key] : null;
        }

        // ä¸‹æ‹‰é¸å–®ç›¸é—œåŠŸèƒ½ï¼ˆä¿®å¾©ç‰ˆï¼‰
        function bindGlobalRepositionHandlers() {
            if (repositionHandlersBound) return;
            repositionHandlersBound = true;
            window.addEventListener('scroll', repositionDropdown, true);
            window.addEventListener('resize', repositionDropdown, true);
        }

        function unbindGlobalRepositionHandlers() {
            if (!repositionHandlersBound) return;
            repositionHandlersBound = false;
            window.removeEventListener('scroll', repositionDropdown, true);
            window.removeEventListener('resize', repositionDropdown, true);
        }

        function repositionDropdown() {
            if (!currentEditElement || !currentDropdown) return;
            const rect = currentEditElement.getBoundingClientRect();
            const dd = currentDropdown;

            const marginY = 6;
            const portalWidth = 240;
            const viewportW = window.innerWidth;
            const viewportH = window.innerHeight;

            let left = rect.left;
            // å³é‚Šç•Œæº¢å‡ºå°±å‘å·¦æ”¶
            if (left + portalWidth > viewportW - 8) left = Math.max(8, viewportW - portalWidth - 8);

            // åŸºæœ¬æ”¾åœ¨å…ƒç´ ä¸‹æ–¹
            let top = rect.bottom + marginY;

            // ä¸‹æ–¹ç©ºé–“ä¸è¶³å°±ç¿»åˆ°ä¸Šæ–¹
            const ddHeight = Math.min(260, dd.scrollHeight + 4);
            if (top + ddHeight > viewportH - 8) {
                top = Math.max(8, rect.top - marginY - ddHeight);
            }

            dd.style.left = `${Math.round(left)}px`;
            dd.style.top  = `${Math.round(top)}px`;
            dd.style.width = `${portalWidth}px`;
        }

        function buildDropdownOptionsFor(employee) {
            const options = getScheduleOptions(employee.é¡å‹, employee.å€åŸŸ);
            const frag = document.createDocumentFragment();

            if (!options.length) {
                const noOpt = document.createElement('div');
                noOpt.className = 'edit-option';
                noOpt.textContent = 'æ²’æœ‰å¯ç”¨çš„ç­åˆ¥';
                noOpt.style.color = '#666';
                noOpt.style.textAlign = 'center';
                frag.appendChild(noOpt);
                return frag;
            }

            options.forEach(opt => {
                const el = document.createElement('div');
                el.className = 'edit-option';
                el.textContent = opt.label;
                el.addEventListener('pointerdown', (e) => {
                    e.stopPropagation();
                    // ç”¨ data ç¶å®šåœ¨ dropdown ä»¥å–å¾— day/name
                    const name = currentDropdown?.dataset?.empName;
                    const day  = Number(currentDropdown?.dataset?.day);
                    updateSchedule(name, day, opt.value);
                    closeEditDropdown();
                }, { passive: true });
                frag.appendChild(el);
            });

            return frag;
        }

        function editSchedule(element, employeeName, day, eventFromListener) {
            // è‹¥å·²é–‹å•ŸåŒä¸€å€‹å°±åˆ‡æ›æˆé—œé–‰
            if (currentEditElement === element && currentDropdown) {
                closeEditDropdown();
                return;
            }

            closeEditDropdown();

            // æ¨™è¨˜é–‹å•Ÿä¸­é–å®šå¤–è§€
            element.classList.add('open');
            currentEditElement = element;

            // æº–å‚™ dropdownï¼ˆæ›åœ¨ portalï¼‰
            const portal = document.getElementById('dropdown-portal') || document.body;
            const dropdown = document.createElement('div');
            dropdown.className = 'edit-dropdown';
            dropdown.dataset.empName = employeeName;
            dropdown.dataset.day = String(day);

            // å…§å®¹
            const employee = scheduleData.employees.find(emp => emp.å§“å === employeeName);
            dropdown.appendChild(buildDropdownOptionsFor(employee));

            // æ›ä¸Šå»å…ˆä¸å¯è¦‹ï¼Œè¨ˆç®—ä½ç½®å¾Œå†é¡¯ç¤º
            dropdown.style.visibility = 'hidden';
            portal.appendChild(dropdown);
            currentDropdown = dropdown;

            // å®šä½
            repositionDropdown();
            dropdown.style.visibility = 'visible';

            // ç¶å®šå…¨åŸŸé—œé–‰ï¼šé»å¤–é¢å°±é—œ
            document.addEventListener('pointerdown', onDocPointerDown, true);
            bindGlobalRepositionHandlers();
        }

        function onDocPointerDown(e) {
            if (!currentDropdown) return;
            const path = e.composedPath ? e.composedPath() : [];
            const clickedInsideDropdown = path.includes(currentDropdown);
            const clickedOnInvoker = path.includes(currentEditElement);
            if (!clickedInsideDropdown && !clickedOnInvoker) {
                closeEditDropdown();
            }
        }

        function closeEditDropdown() {
            if (currentDropdown && currentDropdown.parentNode) {
                currentDropdown.parentNode.removeChild(currentDropdown);
            }
            currentDropdown = null;

            if (currentEditElement) {
                currentEditElement.classList.remove('open');
                currentEditElement = null;
            }
            document.removeEventListener('pointerdown', onDocPointerDown, true);
            unbindGlobalRepositionHandlers();
        }

        // è§’è‰²åˆ‡æ›åŠŸèƒ½
        function toggleRole() {
            currentRole = currentRole === 'admin' ? 'employee' : 'admin';
            updateRoleDisplay();
        }

        function updateRoleDisplay() {
            const container = document.getElementById('mainContainer');
            const badge = document.getElementById('roleBadge');
            
            if (currentRole === 'admin') {
                container.className = 'container admin-mode';
                badge.textContent = 'ç®¡ç†è€…';
                badge.className = 'role-badge';
            } else {
                container.className = 'container employee-mode';
                badge.textContent = 'å“¡å·¥';
                badge.className = 'role-badge employee';
            }
        }

        // å¹´æœˆåˆ‡æ›åŠŸèƒ½
        function changeYearMonth() {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            updateCalendar();
        }

        // æ¨™ç±¤åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // è¼‰å…¥å°æ‡‰å…§å®¹
            switch(tabName) {
                case 'schedule':
                    updateCalendar();
                    break;
                case 'employee':
                    updateEmployeeGrid();
                    break;
                case 'shift':
                    updateShiftDisplay();
                    break;
                case 'stats':
                    updateStats();
                    break;
            }
        }

        // å“¡å·¥ç®¡ç†åŠŸèƒ½
        function showEmployeeModal() {
            if (currentRole !== 'admin') {
                alert('åªæœ‰ç®¡ç†è€…å¯ä»¥æ–°å¢å“¡å·¥');
                return;
            }
            document.getElementById('employeeModal').style.display = 'block';
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
            document.getElementById('employeeName').value = '';
            document.getElementById('fullTime').checked = true;
            document.getElementById('frontArea').checked = true;
        }

        function addEmployeeFromModal() {
            const name = document.getElementById('employeeName').value.trim();
            const type = document.querySelector('input[name="employeeType"]:checked').value;
            const area = document.querySelector('input[name="workArea"]:checked').value;

            if (!name) {
                alert('è«‹è¼¸å…¥å“¡å·¥å§“åï¼');
                return;
            }

            if (scheduleData.employees && scheduleData.employees.find(emp => emp.å§“å === name)) {
                alert('å“¡å·¥å§“åå·²å­˜åœ¨ï¼');
                return;
            }

            const newEmployee = {
                'å§“å': name,
                'é¡å‹': type,
                'å€åŸŸ': area
            };

            if (!scheduleData.employees) scheduleData.employees = [];
            scheduleData.employees.push(newEmployee);

            // ç‚ºæ–°å“¡å·¥åˆå§‹åŒ–æ‰€æœ‰æœˆä»½çš„ç­è¡¨
            Object.keys(scheduleData.schedules || {}).forEach(key => {
                const [year, month] = key.split('-').map(Number);
                const daysInMonth = getDaysInMonth(year, month);
                if (!scheduleData.schedules[key][name]) {
                    scheduleData.schedules[key][name] = {};
                }
                for (let d = 1; d <= daysInMonth; d++) {
                    scheduleData.schedules[key][name][d] = null;
                }
            });

            closeEmployeeModal();
            updateEmployeeGrid();
            autoSave();
            
            const typeText = type === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
            const areaText = area === 'front' ? 'å¤–å ´' : 'å…§å ´';
            alert(`å·²æ–°å¢å“¡å·¥ï¼š${name}ï¼ˆ${areaText}${typeText}ï¼‰`);
        }

        function updateEmployeeGrid() {
            const grid = document.getElementById('employeeGrid');
            grid.innerHTML = '';

            if (!scheduleData.employees || scheduleData.employees.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>';
                return;
            }

            scheduleData.employees.forEach((employee, index) => {
                const card = document.createElement('div');
                card.className = 'employee-card';
                
                const typeText = employee.é¡å‹ === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
                const areaText = employee.å€åŸŸ === 'front' ? 'å¤–å ´' : 'å…§å ´';
                
                card.innerHTML = `
                    <div class="employee-name">${employee.å§“å}</div>
                    <div class="employee-info">é¡å‹ï¼š${typeText}</div>
                    <div class="employee-info">å€åŸŸï¼š${areaText}</div>
                `;

                if (currentRole === 'admin') {
                    const actions = document.createElement('div');
                    actions.className = 'employee-actions';
                    actions.innerHTML = `<button class="control-btn small danger" onclick="removeEmployee(${index})">åˆªé™¤</button>`;
                    card.appendChild(actions);
                }
                
                grid.appendChild(card);
            });
        }

        function removeEmployee(index) {
            if (currentRole !== 'admin') {
                alert('åªæœ‰ç®¡ç†è€…å¯ä»¥åˆªé™¤å“¡å·¥');
                return;
            }
            
            const employee = scheduleData.employees[index];
            pendingAction = 'removeEmployee';
            pendingActionData = index;
            document.getElementById('confirmMessage').textContent = `ç¢ºå®šè¦åˆªé™¤å“¡å·¥ã€Œ${employee.å§“å}ã€å—ï¼Ÿ`;
            document.getElementById('confirmModal').style.display = 'block';
        }

        // ç­è¡¨æŸ¥çœ‹åŠŸèƒ½
        function updateCalendar() {
            ensureScheduleData(currentYear, currentMonth);
            generateCalendar();
        }

        function ensureScheduleData(year, month) {
            const key = `${year}-${month}`;
            if (!scheduleData.schedules) scheduleData.schedules = {};
            if (!scheduleData.schedules[key]) scheduleData.schedules[key] = {};
            
            const daysInMonth = getDaysInMonth(year, month);
            if (scheduleData.employees) {
                scheduleData.employees.forEach(emp => {
                    if (!scheduleData.schedules[key][emp.å§“å]) {
                        scheduleData.schedules[key][emp.å§“å] = {};
                    }
                    for (let d = 1; d <= daysInMonth; d++) {
                        if (!scheduleData.schedules[key][emp.å§“å].hasOwnProperty(d)) {
                            scheduleData.schedules[key][emp.å§“å][d] = null;
                        }
                    }
                });
            }
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            // å‰µå»ºæ˜ŸæœŸæ¨™é¡Œ
            weekdays.forEach((day, index) => {
                const header = document.createElement('div');
                header.className = 'day-header';
                if (index === 0 || index === 6) {
                    header.classList.add('weekend-header');
                }
                header.textContent = day;
                calendar.appendChild(header);
            });

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDayOfWeek = getFirstDayOfWeek(currentYear, currentMonth);

            // æ·»åŠ ç©ºç™½æ ¼å­
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty-cell';
                calendar.appendChild(emptyCell);
            }

            // æ·»åŠ æ—¥æœŸæ ¼å­
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (isWeekend(currentYear, currentMonth, day)) {
                    dayCell.classList.add('weekend-cell');
                }

                // æ—¥æœŸæ¨™é ­
                const dayHeaderInfo = document.createElement('div');
                dayHeaderInfo.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;';
                
                // æ—¥æœŸæ•¸å­—
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayHeaderInfo.appendChild(dayNumber);

                // å‡æ—¥åç¨±
                const holidayName = getHolidayName(currentYear, currentMonth, day);
                if (holidayName) {
                    const holidayElement = document.createElement('div');
                    holidayElement.className = 'holiday-name';
                    holidayElement.textContent = holidayName;
                    dayHeaderInfo.appendChild(holidayElement);
                }

                dayCell.appendChild(dayHeaderInfo);

                // å“¡å·¥ç­è¡¨
                const staffSchedule = document.createElement('div');
                staffSchedule.className = 'staff-schedule';

                const scheduleKey = `${currentYear}-${currentMonth}`;
                if (scheduleData.employees) {
                    const sortedEmployees = sortEmployees([...scheduleData.employees]);
                    sortedEmployees.forEach(employee => {
                        const schedule = scheduleData.schedules[scheduleKey]?.[employee.å§“å]?.[day];
                        const staffItem = document.createElement('div');
                        staffItem.className = `staff-item ${getStaffClass(schedule, employee.é¡å‹)}`;
                        staffItem.textContent = getStaffDisplay(employee.å§“å, schedule, employee.é¡å‹);
                        
                        if (isEditMode && currentRole === 'admin') {
                            staffItem.classList.add('editable');
                            
                            // ä½¿ç”¨ pointerdown æ›¿ä»£ click
                            staffItem.addEventListener('pointerdown', function(e) {
                                e.stopPropagation();
                                editSchedule(staffItem, employee.å§“å, day, e);
                            }, { passive: true });
                        }
                        
                        staffSchedule.appendChild(staffItem);
                    });
                }

                dayCell.appendChild(staffSchedule);
                calendar.appendChild(dayCell);
            }
        }

        function toggleEditMode() {
            if (currentRole !== 'admin') {
                alert('åªæœ‰ç®¡ç†è€…å¯ä»¥ç·¨è¼¯ç­è¡¨');
                return;
            }
            
            isEditMode = !isEditMode;
            const btn = document.getElementById('editModeBtn');
            const hint = document.getElementById('editHint');
            
            // å…ˆé—œé–‰ä»»ä½•ç¾æœ‰çš„ç·¨è¼¯ä¸‹æ‹‰é¸å–®
            closeEditDropdown();
            
            if (isEditMode) {
                btn.innerHTML = '<span class="btn-icon">âœ…</span> å®Œæˆç·¨è¼¯';
                btn.style.background = 'linear-gradient(45deg,#28a745,#20c997)';
                hint.style.display = 'block';
            } else {
                btn.innerHTML = '<span class="btn-icon">âœï¸</span> ç·¨è¼¯æ¨¡å¼';
                btn.style.background = 'linear-gradient(45deg,#28a745,#20c997)';
                hint.style.display = 'none';
            }
            
            // é‡æ–°ç”Ÿæˆç­è¡¨ä»¥æ‡‰ç”¨ç·¨è¼¯æ¨¡å¼æ¨£å¼
            generateCalendar();
        }

        function updateSchedule(employeeName, day, value) {
            const scheduleKey = `${currentYear}-${currentMonth}`;
            if (!scheduleData.schedules[scheduleKey]) {
                scheduleData.schedules[scheduleKey] = {};
            }
            if (!scheduleData.schedules[scheduleKey][employeeName]) {
                scheduleData.schedules[scheduleKey][employeeName] = {};
            }
            
            scheduleData.schedules[scheduleKey][employeeName][day] = value;
            generateCalendar();
            autoSave();
        }

        function getScheduleOptions(employeeType, employeeArea) {
            // å¾enhancedShiftSettingsç²å–ç¬¦åˆæ¢ä»¶çš„ç­åˆ¥
            const shifts = shiftSettings.allShifts.filter(s => 
                s.type === employeeType && s.area === employeeArea
            );
            
            const options = [];
            
            // é è¨­é¸é …ï¼ˆä¸Šç­/ä¼‘æ¯ï¼‰
            const defaultName = employeeType === 'fullTime' ? 'ä¸Šç­' : 'ä¼‘æ¯';
            options.push({ value: null, label: defaultName });
            
            // å…¶ä»–ç­åˆ¥é¸é …
            shifts.forEach(shift => {
                // æ’é™¤é è¨­ç­åˆ¥ï¼ˆä¸Šç­/ä¼‘æ¯ï¼‰é¿å…é‡è¤‡
                if (shift.name !== 'ä¸Šç­' && shift.name !== 'ä¼‘æ¯') {
                    options.push({ 
                        value: shift.name, 
                        label: shift.name,
                        color: shift.color 
                    });
                }
            });
            
            return options;
        }

        function getStaffClass(schedule, employeeType) {
            if (schedule === null) {
                return employeeType === 'fullTime' ? 'work-day' : 'off-day';
            }
            
            // å¾shiftSettingsæŸ¥æ‰¾ç­åˆ¥
            const shift = shiftSettings.allShifts.find(s => s.name === schedule);
            if (shift) {
                return getShiftTypeClass(shift.category);
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°å°æ‡‰ç­åˆ¥ï¼Œä½¿ç”¨é è¨­åˆ¤æ–·è¦å‰‡
            if (schedule.includes('ä¼‘') || schedule.includes('å‡')) return 'holiday';
            if (schedule.includes(':') || schedule.includes('-') || schedule.includes('å¤œ') || schedule.includes('æ™š')) return 'night-shift';
            return 'work-day';
        }

        function getShiftTypeClass(category) {
            switch (category) {
                case 'work': return 'work-day';
                case 'holiday': return 'holiday';
                case 'night': return 'night-shift';
                case 'off': return 'off-day';
                default: return 'work-day';
            }
        }

        function getStaffDisplay(name, schedule, employeeType) {
            if (schedule === null) {
                const defaultText = employeeType === 'fullTime' ? 'ç­' : '';
                return `${name} ${defaultText}`;
            }
            
            // å¾shiftSettingsæŸ¥æ‰¾ç­åˆ¥
            const shift = shiftSettings.allShifts.find(s => s.name === schedule);
            if (shift && shift.abbreviation) {
                return `${name} ${shift.abbreviation}`;
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°å°æ‡‰ç­åˆ¥ï¼Œä½¿ç”¨é è¨­ç¸®å¯«è¦å‰‡
            let displayText = schedule;
            if (schedule.includes('17:00-23:00')) displayText = '17-23';
            else if (schedule.includes('18:00-24:00')) displayText = '18-24';
            else if (schedule === 'ä¼‘å‡') displayText = 'ä¼‘';
            else if (schedule === 'ç‰¹ä¼‘') displayText = 'ç‰¹';
            else if (schedule.length > 4) displayText = schedule.substring(0, 4);
            
            return `${name} ${displayText}`;
        }

        function sortEmployees(employees) {
            const order = {'front-fullTime': 1, 'front-partTime': 2, 'back-fullTime': 3, 'back-partTime': 4};
            return employees.sort((a, b) => {
                const keyA = `${a.å€åŸŸ}-${a.é¡å‹}`;
                const keyB = `${b.å€åŸŸ}-${b.é¡å‹}`;
                return (order[keyA] || 999) - (order[keyB] || 999);
            });
        }

        // ç­åˆ¥è¨­å®šåŠŸèƒ½
        function showShiftSettingsModal() {
            if (currentRole !== 'admin') {
                alert('åªæœ‰ç®¡ç†è€…å¯ä»¥è¨­å®šç­åˆ¥');
                return;
            }
            loadShiftSettings();
            updateShiftDisplay();
            document.getElementById('shiftSettingsModal').style.display = 'block';
        }

        function closeShiftSettingsModal() {
            document.getElementById('shiftSettingsModal').style.display = 'none';
            clearShiftForm();
        }

        function clearShiftForm() {
            document.getElementById('shiftCode').value = '';
            document.getElementById('shiftName').value = '';
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '18:00';
            document.getElementById('shiftType').value = 'fullTime';
            document.getElementById('shiftArea').value = 'front';
            document.getElementById('shiftColor').value = '#667eea';
            document.getElementById('abbreviation').value = '';
        }

        function addEnhancedShift() {
            const code = document.getElementById('shiftCode').value.trim();
            const name = document.getElementById('shiftName').value.trim();
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const type = document.getElementById('shiftType').value;
            const area = document.getElementById('shiftArea').value;
            const color = document.getElementById('shiftColor').value;
            const abbreviation = document.getElementById('abbreviation').value.trim();

            if (!code || !name) {
                alert('è«‹è¼¸å…¥ç­åˆ¥ä»£ç¢¼å’Œåç¨±ï¼');
                return;
            }

            const exists = shiftSettings.allShifts.some(s => s.code === code);
            if (exists) {
                alert('ç­åˆ¥ä»£ç¢¼å·²å­˜åœ¨ï¼');
                return;
            }

            let category = 'work';
            if (name.includes('ä¼‘') || name.includes('å‡')) category = 'holiday';
            else if (name.includes('å¤œ') || name.includes('æ™š')) category = 'night';
            else if (name.includes('ä¼‘æ¯')) category = 'off';

            const newShift = {
                code,
                name,
                startTime,
                endTime,
                type,
                area,
                color,
                category,
                abbreviation: abbreviation || name.charAt(0)
            };

            shiftSettings.allShifts.push(newShift);
            updateShiftDisplay();
            clearShiftForm();
            saveShiftSettings();
            alert('ç­åˆ¥æ–°å¢æˆåŠŸï¼');
        }

        function updateShiftDisplay() {
            const container = document.getElementById('allShiftsList');
            container.innerHTML = '';

            shiftSettings.allShifts.forEach((shift, index) => {
                const card = document.createElement('div');
                card.className = 'shift-card';
                card.style.borderLeftColor = shift.color;

                const timeDisplay = `${shift.startTime} - ${shift.endTime}`;
                const typeText = shift.type === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
                const areaText = shift.area === 'front' ? 'å¤–å ´' : 'å…§å ´';

                card.innerHTML = `
                    <div class="shift-card-header">
                        <div class="shift-title">${shift.name}</div>
                        <span class="shift-code">${shift.code}</span>
                    </div>
                    <div class="shift-details">
                        <div><strong>æ™‚é–“ï¼š</strong>${timeDisplay}</div>
                        <div><strong>é¡å‹ï¼š</strong>${typeText}</div>
                        <div><strong>å€åŸŸï¼š</strong>${areaText}</div>
                        <div><strong>ç°¡ç¨±ï¼š</strong>${shift.abbreviation}</div>
                    </div>
                `;

                if (canDeleteShift(shift)) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'control-btn small danger';
                    deleteBtn.textContent = 'åˆªé™¤';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '10px';
                    deleteBtn.style.right = '10px';
                    deleteBtn.onclick = () => deleteShift(index);
                    card.appendChild(deleteBtn);
                }

                container.appendChild(card);
            });
        }

        function canDeleteShift(shift) {
            return !['ä¸Šç­', 'ä¼‘æ¯'].includes(shift.name);
        }

        function deleteShift(index) {
            const shift = shiftSettings.allShifts[index];
            if (!canDeleteShift(shift)) {
                alert('ç„¡æ³•åˆªé™¤åŸºæœ¬ç­åˆ¥ï¼');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ç­åˆ¥ã€Œ${shift.name}ã€å—ï¼Ÿ`)) {
                shiftSettings.allShifts.splice(index, 1);
                updateShiftDisplay();
                saveShiftSettings();
                alert('ç­åˆ¥å·²åˆªé™¤ï¼');
            }
        }

        function loadShiftSettings() {
            try {
                const saved = localStorage.getItem('shiftSettings');
                if (saved) {
                    shiftSettings = JSON.parse(saved);
                }
            } catch (e) {
                console.error('è¼‰å…¥ç­åˆ¥è¨­å®šå¤±æ•—', e);
            }
        }

        function saveShiftSettings() {
            try {
                localStorage.setItem('shiftSettings', JSON.stringify(shiftSettings));
            } catch (e) {
                alert('å„²å­˜å¤±æ•—');
            }
        }

        // çµ±è¨ˆåŠŸèƒ½
        function updateStats() {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = '';

            if (!scheduleData.employees || scheduleData.employees.length === 0) {
                statsContainer.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1 / -1;">ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>';
                return;
            }

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const scheduleKey = `${currentYear}-${currentMonth}`;
            
            let totalWork = 0, totalNight = 0, totalHoliday = 0, totalOff = 0;

            scheduleData.employees.forEach(employee => {
                for (let day = 1; day <= daysInMonth; day++) {
                    const schedule = scheduleData.schedules[scheduleKey]?.[employee.å§“å]?.[day];
                    if (schedule === null) {
                        if (employee.é¡å‹ === 'fullTime') totalWork++;
                        else totalOff++;
                    } else {
                        const shift = shiftSettings.allShifts.find(s => s.name === schedule);
                        if (shift) {
                            switch (shift.category) {
                                case 'work': totalWork++; break;
                                case 'night': totalNight++; break;
                                case 'holiday': totalHoliday++; break;
                                case 'off': totalOff++; break;
                            }
                        }
                    }
                }
            });

            const stats = [
                { label: 'ç¸½å“¡å·¥æ•¸', value: scheduleData.employees.length },
                { label: 'ç¸½å·¥ä½œå¤©æ•¸', value: totalWork + totalNight },
                { label: 'ç¸½å¤œç­å¤©æ•¸', value: totalNight },
                { label: 'ç¸½ä¼‘å‡å¤©æ•¸', value: totalHoliday },
                { label: 'ç¸½ä¼‘æ¯å¤©æ•¸', value: totalOff }
            ];

            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsContainer.appendChild(card);
            });
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportSchedule() {
            const csv = generateCSV(shouldFilterDefaults(), shouldHideTypeArea());
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `ç­è¡¨_${currentYear}å¹´${currentMonth}æœˆ_${new Date().toISOString().slice(0,10)}.csv`);
            a.style.visibility = 'hidden';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function shouldFilterDefaults() {
            const el = document.getElementById('filterDefaults');
            return !!(el && el.checked);
        }

        function shouldHideTypeArea() {
            const el = document.getElementById('hideTypeArea');
            return !!(el && el.checked);
        }

        function generateCSV(filterDefaults = false, hideTypeArea = false) {
            if (!scheduleData.employees || scheduleData.employees.length === 0) return '';

            const headers = ['å§“å'];
            if (!hideTypeArea) {
                headers.push('é¡å‹', 'å€åŸŸ');
            }

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            for (let d = 1; d <= daysInMonth; d++) {
                headers.push(`${currentMonth}/${d}`);
            }

            let csv = headers.join(',') + '\n';
            const scheduleKey = `${currentYear}-${currentMonth}`;

            const sortedEmployees = sortEmployees([...scheduleData.employees]);
            sortedEmployees.forEach(emp => {
                const typeText = emp.é¡å‹ === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
                const areaText = emp.å€åŸŸ === 'front' ? 'å¤–å ´' : 'å…§å ´';
                
                const row = [emp.å§“å];
                if (!hideTypeArea) {
                    row.push(typeText, areaText);
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    let val = scheduleData.schedules[scheduleKey]?.[emp.å§“å]?.[d] ?? null;
                    
                    if (filterDefaults) {
                        if (emp.é¡å‹ === 'fullTime' && (val === null || val === 'ä¸Šç­')) {
                            val = '';
                        } else if (emp.é¡å‹ === 'partTime' && (val === null || val === 'ä¼‘æ¯')) {
                            val = '';
                        }
                    } else {
                        if (val === null || val === undefined || val === '') {
                            val = (emp.é¡å‹ === 'fullTime' ? 'ä¸Šç­' : 'ä¼‘æ¯');
                        }
                    }
                    row.push(val ?? '');
                }
                csv += row.join(',') + '\n';
            });

            return csv;
        }

        // åŒ¯å…¥åŠŸèƒ½
        function importSchedule(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                alert('è«‹é¸æ“‡CSVæª”æ¡ˆï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseAndImportCSV(e.target.result);
                } catch (err) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + err.message);
                }
            };
            reader.readAsText(file, 'utf-8');
            event.target.value = '';
        }

        function parseAndImportCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                alert('CSVæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const hasTypeArea = (headers[1] === 'é¡å‹' && headers[2] === 'å€åŸŸ');
            const dataStartIdx = hasTypeArea ? 3 : 1;

            if (headers.length < dataStartIdx + 1) {
                alert('CSVæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘æ—¥æœŸæ¬„');
                return;
            }

            const dateColumns = headers.slice(dataStartIdx);
            let targetYear = currentYear, targetMonth = null;

            if (dateColumns.length > 0) {
                const firstDate = dateColumns[0];
                const match = firstDate.match(/(\d+)\/(\d+)/);
                if (match) {
                    targetMonth = parseInt(match[1]);
                } else {
                    alert('æ—¥æœŸæ ¼å¼ä¸æ­£ç¢º');
                    return;
                }
            }

            const newEmployees = [];
            const newSchedules = {};
            const scheduleKey = `${targetYear}-${targetMonth}`;
            newSchedules[scheduleKey] = {};

            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(',').map(c => c.trim());
                if (cells.length < dataStartIdx + 1) continue;

                const employeeName = cells[0];
                if (!employeeName) continue;

                const existingEmployee = scheduleData.employees?.find(emp => emp.å§“å === employeeName);
                const employeeTypeText = hasTypeArea ? cells[1] : '';
                const employeeAreaText = hasTypeArea ? cells[2] : '';
                const employeeType = hasTypeArea ? (employeeTypeText === 'å…¼è·' ? 'partTime' : 'fullTime') : (existingEmployee?.é¡å‹ || 'fullTime');
                const employeeArea = hasTypeArea ? (employeeAreaText === 'å…§å ´' ? 'back' : 'front') : (existingEmployee?.å€åŸŸ || 'front');

                if (!existingEmployee) {
                    newEmployees.push({
                        å§“å: employeeName,
                        é¡å‹: employeeType,
                        å€åŸŸ: employeeArea
                    });
                }

                newSchedules[scheduleKey][employeeName] = {};

                for (let j = dataStartIdx; j < cells.length && j < headers.length; j++) {
                    const dateStr = headers[j];
                    const dayMatch = dateStr.match(/\d+\/(\d+)/);
                    if (dayMatch) {
                        const day = parseInt(dayMatch[1]);
                        const cellValue = cells[j];
                        let scheduleValue = null;

                        if (cellValue && cellValue !== 'ä¸Šç­' && cellValue !== 'ä¼‘æ¯' && cellValue !== '') {
                            scheduleValue = cellValue;
                        }
                        newSchedules[scheduleKey][employeeName][day] = scheduleValue;
                    }
                }
            }

            const confirmMessage = `å³å°‡åŒ¯å…¥ï¼š${newEmployees.length}ä½æ–°å“¡å·¥ï¼Œ${targetYear}å¹´${targetMonth}æœˆç­è¡¨\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`;
            if (confirm(confirmMessage)) {
                if (!scheduleData.employees) scheduleData.employees = [];
                newEmployees.forEach(emp => scheduleData.employees.push(emp));
                
                if (!scheduleData.schedules) scheduleData.schedules = {};
                Object.assign(scheduleData.schedules, newSchedules);

                currentYear = targetYear;
                currentMonth = targetMonth;
                document.getElementById('yearSelect').value = currentYear;
                document.getElementById('monthSelect').value = currentMonth;

                ensureScheduleData(currentYear, currentMonth);
                updateCalendar();
                updateEmployeeGrid();
                autoSave();
                alert(`åŒ¯å…¥æˆåŠŸï¼å·²åŒ¯å…¥ ${newEmployees.length} ä½å“¡å·¥`);
            }
        }

        // æ¸…ç©ºç­è¡¨åŠŸèƒ½
        function clearAllSchedule() {
            if (currentRole !== 'admin') {
                alert('åªæœ‰ç®¡ç†è€…å¯ä»¥æ¸…ç©ºç­è¡¨');
                return;
            }
            
            pendingAction = 'clearSchedule';
            document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç­è¡¨è³‡æ–™å—ï¼Ÿ';
            document.getElementById('confirmModal').style.display = 'block';
        }

        // ç¢ºèªæ¨¡æ…‹æ¡†åŠŸèƒ½
        function confirmAction() {
            if (pendingAction === 'removeEmployee') {
                const index = pendingActionData;
                const employee = scheduleData.employees[index];
                const name = employee.å§“å;
                
                scheduleData.employees.splice(index, 1);
                
                // å¾æ‰€æœ‰ç­è¡¨ä¸­ç§»é™¤è©²å“¡å·¥
                Object.keys(scheduleData.schedules || {}).forEach(key => {
                    if (scheduleData.schedules[key][name]) {
                        delete scheduleData.schedules[key][name];
                    }
                });
                
                updateEmployeeGrid();
                autoSave();
                alert(`å·²åˆªé™¤å“¡å·¥ï¼š${name}`);
                
            } else if (pendingAction === 'clearSchedule') {
                const scheduleKey = `${currentYear}-${currentMonth}`;
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                
                if (scheduleData.schedules?.[scheduleKey] && scheduleData.employees) {
                    scheduleData.employees.forEach(emp => {
                        for (let d = 1; d <= daysInMonth; d++) {
                            if (scheduleData.schedules[scheduleKey][emp.å§“å]) {
                                scheduleData.schedules[scheduleKey][emp.å§“å][d] = null;
                            }
                        }
                    });
                }
                
                updateCalendar();
                autoSave();
                alert('ç­è¡¨å·²æ¸…ç©ºï¼');
            }
            
            closeModal();
        }

        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
            pendingActionData = null;
        }

        // è¼”åŠ©å‡½æ•¸
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function getFirstDayOfWeek(year, month) {
            return new Date(year, month - 1, 1).getDay();
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6;
        }

        // å„²å­˜åŠŸèƒ½
        function autoSave() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToStorage();
            }, 1000);
        }

        function saveToStorage() {
            try {
                localStorage.setItem('employeeScheduleData', JSON.stringify(scheduleData));
                localStorage.setItem('lastSaveTime', new Date().toISOString());
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—', e);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('employeeScheduleData');
                if (saved) {
                    scheduleData = JSON.parse(saved);
                    return true;
                }
                return false;
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—', e);
                return false;
            }
        }

        function initializeDefaultData() {
            scheduleData = {
                employees: [
                    { å§“å: 'Stu', é¡å‹: 'fullTime', å€åŸŸ: 'front' },
                    { å§“å: 'Dan', é¡å‹: 'fullTime', å€åŸŸ: 'front' },
                    { å§“å: 'å°æ›¹', é¡å‹: 'partTime', å€åŸŸ: 'front' },
                    { å§“å: 'æ™¨æ™¨', é¡å‹: 'partTime', å€åŸŸ: 'front' },
                    { å§“å: 'James', é¡å‹: 'partTime', å€åŸŸ: 'front' },
                    { å§“å: 'ç‘¤ç‘¤', é¡å‹: 'fullTime', å€åŸŸ: 'back' },
                    { å§“å: 'ä¿Šä¿Š', é¡å‹: 'fullTime', å€åŸŸ: 'back' },
                    { å§“å: 'è‡³è»’', é¡å‹: 'partTime', å€åŸŸ: 'back' },
                    { å§“å: 'æ›¹æ›¹', é¡å‹: 'partTime', å€åŸŸ: 'back' }
                ],
                schedules: {}
            };
            saveToStorage();
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        document.addEventListener('pointerdown', (e) => {
            if (e.target.id === 'confirmModal') closeModal();
            if (e.target.id === 'employeeModal') closeEmployeeModal();
            if (e.target.id === 'shiftSettingsModal') closeShiftSettingsModal();
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateRoleDisplay();
            loadShiftSettings();
            loadTaiwanHolidays();
            
            if (!loadFromStorage()) {
                initializeDefaultData();
            }
            
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;
            
            ensureScheduleData(currentYear, currentMonth);
            updateCalendar();
        });
    </script>
</body>
</html>