<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å…¬å‘Šæ¬„æ—¥èªŒï¼ˆå«ç®¡ç†å“¡ç™»å…¥ï¼‰</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);min-height:100vh;color:#374151}
    .container{max-width:1024px;margin:0 auto;padding:2rem 1rem}
    .title-section{text-align:center;margin-bottom:2rem}
    .title-section h1{font-size:2.5rem;font-weight:700;color:#1f2937;margin-bottom:.5rem}
    .title-section p{color:#6b7280;font-size:1.1rem}
    .card{background:#fff;border-radius:.75rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1);margin-bottom:1.5rem;padding:1.5rem;transition:box-shadow .3s ease}
    .card:hover{box-shadow:0 20px 25px -5px rgba(0,0,0,.1)}
    .status-indicator{font-size:.875rem}.status-connected{color:#10b981}.status-disconnected{color:#ef4444}
    .input-group{margin-bottom:1rem}
    .input-group label{display:block;font-size:.875rem;font-weight:500;color:#374151;margin-bottom:.5rem}
    .input-field{width:100%;padding:.75rem;border:1px solid #d1d5db;border-radius:.5rem;font-size:1rem;transition:border-color .2s,box-shadow .2s}
    .input-field:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .input-field:disabled{background:#f9fafb;cursor:not-allowed}
    .flex-row{display:flex;gap:.75rem;align-items:center}
    .flex-1{flex:1}
    .btn{padding:.75rem 1.5rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:.5rem;transition:background-color .2s,opacity .2s}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover:not(:disabled){background:#2563eb}
    .btn-success{background:#10b981;color:#fff}.btn-success:hover:not(:disabled){background:#059669}
    .btn-danger{background:#ef4444;color:#fff}.btn-danger:hover:not(:disabled){background:#dc2626}
    .btn-secondary{background:#6b7280;color:#fff}.btn-secondary:hover:not(:disabled){background:#4b5563}
    .info-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:.5rem;padding:1rem;margin-top:1rem}
    .info-box p{font-size:.875rem;color:#1e40af;line-height:1.5}
    .filter-buttons{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
    .filter-btn{padding:.5rem 1rem;border:none;border-radius:.5rem;font-weight:500;cursor:pointer}
    .filter-btn.active{background:#3b82f6;color:#fff;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .filter-btn:not(.active){background:#f3f4f6;color:#374151}
    .filter-btn:not(.active):hover{background:#e5e7eb}
    .operations-section{display:flex;flex-direction:column;gap:1rem}
    .operations-row{display:flex;justify-content:space-between;align-items:center;gap:1rem}
    .textarea{resize:vertical;min-height:100px}
    .log-item{background:#fff;border-radius:.75rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);padding:1.5rem;margin-bottom:1rem}
    .log-item:hover{box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    .log-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
    .log-title{font-size:1.25rem;font-weight:600;color:#1f2937;margin-bottom:.5rem}
    .log-meta{display:flex;align-items:center;gap:1rem;font-size:.875rem;color:#6b7280;margin-bottom:.75rem}
    .meta-item{display:flex;align-items:center;gap:.25rem}
    .category-badge{padding:.25rem .75rem;border-radius:9999px;font-size:.75rem;font-weight:500;border:1px solid}
    .category-important{background:#fef2f2;color:#991b1b;border-color:#fecaca}
    .category-general{background:#eff6ff;color:#1e40af;border-color:#bfdbfe}
    .category-meeting{background:#f0fdf4;color:#166534;border-color:#bbf7d0}
    .category-feature{background:#faf5ff;color:#7c2d12;border-color:#e9d5ff}
    .category-other{background:#f9fafb;color:#374151;border-color:#e5e7eb}
    .log-actions{display:flex;gap:.5rem;margin-left:1rem}
    .action-btn{padding:.5rem;border:none;border-radius:.5rem;cursor:pointer}
    .edit-btn{color:#3b82f6;background:#eff6ff}
    .delete-btn{color:#ef4444;background:#fef2f2}
    .empty-state{text-align:center;padding:3rem 1rem;color:#6b7280;font-size:1.125rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
    .stat-item{text-align:center}.stat-number{font-size:2rem;font-weight:700;margin-bottom:.25rem}.stat-label{font-size:.875rem;color:#6b7280}
    .stat-blue{color:#3b82f6}.stat-green{color:#10b981}.stat-red{color:#ef4444}.stat-purple{color:#8b5cf6}
    .loading{opacity:.6;pointer-events:none}
    .hidden{display:none}
    .tag{font-size:.8rem;padding:.25rem .5rem;border-radius:.5rem; background:#f3f4f6;border:1px solid #e5e7eb;color:#374151}
    @media (max-width:768px){
      .container{padding:1rem .5rem}
      .title-section h1{font-size:2rem}
      .operations-row{flex-direction:column;align-items:stretch}
      .filter-buttons{justify-content:center}
      .flex-row{flex-direction:column;align-items:stretch}
      .log-header{flex-direction:column;gap:1rem}
      .log-actions{margin-left:0;justify-content:flex-end}
      .stats-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ¨™é¡Œå€åŸŸ -->
    <div class="title-section">
      <h1>ğŸ“‹ å…¬å‘Šæ¬„æ—¥èªŒ</h1>
      <p>è¨˜éŒ„æ¯æ—¥é‡è¦äº‹é …èˆ‡å…¬å‘Š</p>
    </div>

    <!-- é€£ç·š + ç™»å…¥ -->
    <div class="card">
      <h3>ğŸ“Š Google Sheets é€£æ¥è¨­å®š
        <span id="connectionStatus" class="status-indicator status-disconnected">â— æœªé€£æ¥</span>
      </h3>

      <div class="input-group">
        <label for="gasUrl">Google Apps Script URL</label>
        <div class="flex-row">
          <input type="text" id="gasUrl" class="input-field flex-1" placeholder="è«‹è¼¸å…¥ /exec çµå°¾çš„ Web App URL">
          <button id="connectBtn" class="btn btn-primary">é€£æ¥</button>
          <button id="disconnectBtn" class="btn btn-secondary hidden">ä¸­æ–·é€£æ¥</button>
        </div>
      </div>

      <!-- ç®¡ç†å“¡ç™»å…¥å€ -->
      <div class="input-group">
        <label>ğŸ” ç®¡ç†å“¡ç™»å…¥ <span id="authStatus" class="tag">æœªç™»å…¥</span></label>
        <div class="flex-row">
          <input type="text" id="username" class="input-field" placeholder="å¸³è™Ÿ">
          <input type="password" id="password" class="input-field" placeholder="å¯†ç¢¼">
        </div>
        <div class="flex-row" style="margin-top:.5rem;">
          <button id="loginBtn" class="btn btn-success">ç™»å…¥</button>
          <button id="logoutBtn" class="btn btn-danger" disabled>ç™»å‡º</button>
          <span id="roleHint" class="tag">æ¬Šé™ï¼š-</span>
        </div>
      </div>

      <div id="setupInfo" class="info-box">
        <p><strong>è¨­å®šèªªæ˜ï¼š</strong><br>1. å»ºç«‹/æ‰“é–‹ GAS å°ˆæ¡ˆ â†’ è²¼ä¸Š Code.gsï¼ˆå«ç®¡ç†å“¡ç™»å…¥ç‰ˆï¼‰<br>2. éƒ¨ç½²ç‚º Web æ‡‰ç”¨ç¨‹å¼ â†’ æ¬Šé™ã€Œä»»ä½•äººã€<br>3. è¤‡è£½ /exec URL è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†</p>
        <div style="margin-top:1rem;">
          <button id="diagnosisBtn" class="btn btn-secondary" style="font-size:.875rem;">ğŸ” é‹è¡Œè¨ºæ–·æ¸¬è©¦</button>
          <button id="urlHelpBtn" class="btn btn-secondary" style="font-size:.875rem; margin-left:.5rem;">â“ URLæ ¼å¼èªªæ˜</button>
        </div>
      </div>
    </div>

    <!-- æ“ä½œå€åŸŸ -->
    <div class="card">
      <div class="operations-section">
        <div class="operations-row">
          <div class="filter-buttons" id="filterButtons">
            <button class="filter-btn active" data-filter="å…¨éƒ¨">å…¨éƒ¨</button>
            <button class="filter-btn" data-filter="é‡è¦">é‡è¦</button>
            <button class="filter-btn" data-filter="ä¸€èˆ¬">ä¸€èˆ¬</button>
            <button class="filter-btn" data-filter="æœƒè­°">æœƒè­°</button>
            <button class="filter-btn" data-filter="åŠŸèƒ½">åŠŸèƒ½</button>
            <button class="filter-btn" data-filter="å…¶ä»–">å…¶ä»–</button>
          </div>
          <button id="addLogBtn" class="btn btn-success"><span>â•</span> æ–°å¢æ—¥èªŒ</button>
        </div>
        <p id="permissionHint" class="hidden" style="color:#ef4444;font-size:.9rem;">ç›®å‰æ¬Šé™ä¸è¶³ï¼ˆéœ€ owner/admin/editor æ‰èƒ½æ–°å¢æˆ–ç·¨è¼¯/åˆªé™¤ï¼‰ã€‚</p>
      </div>
    </div>

    <!-- æ–°å¢è¡¨å–® -->
    <div id="addForm" class="card hidden">
      <h3>æ–°å¢æ—¥èªŒæ¢ç›®</h3>
      <div class="input-group">
        <label for="newTitle">æ¨™é¡Œ</label>
        <input type="text" id="newTitle" class="input-field" placeholder="è«‹è¼¸å…¥æ—¥èªŒæ¨™é¡Œ...">
      </div>
      <div class="input-group">
        <label for="newContent">å…§å®¹</label>
        <textarea id="newContent" class="input-field textarea" placeholder="è«‹è¼¸å…¥æ—¥èªŒå…§å®¹..."></textarea>
      </div>
      <div class="input-group">
        <label for="newCategory">åˆ†é¡</label>
        <select id="newCategory" class="input-field">
          <option value="é‡è¦">é‡è¦</option>
          <option value="ä¸€èˆ¬" selected>ä¸€èˆ¬</option>
          <option value="æœƒè­°">æœƒè­°</option>
          <option value="åŠŸèƒ½">åŠŸèƒ½</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
      <div class="flex-row">
        <button id="saveLogBtn" class="btn btn-primary"><span>ğŸ’¾</span> å„²å­˜</button>
        <button id="cancelAddBtn" class="btn btn-secondary"><span>âŒ</span> å–æ¶ˆ</button>
      </div>
    </div>

    <!-- æ—¥èªŒåˆ—è¡¨ -->
    <div id="logsList"></div>

    <!-- çµ±è¨ˆ -->
    <div class="card">
      <h3>çµ±è¨ˆä¿¡æ¯ <span id="syncStatus" class="status-indicator hidden">â— åŒæ­¥ä¸­...</span></h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div id="totalLogs" class="stat-number stat-blue">0</div>
          <div class="stat-label">ç¸½æ¢ç›®</div>
        </div>
        <div class="stat-item">
          <div id="todayLogs" class="stat-number stat-green">0</div>
          <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
        </div>
        <div class="stat-item">
          <div id="importantLogs" class="stat-number stat-red">0</div>
          <div class="stat-label">é‡è¦äº‹é …</div>
        </div>
        <div class="stat-item">
          <div id="categoryCount" class="stat-number stat-purple">5</div>
          <div class="stat-label">åˆ†é¡æ•¸é‡</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===================== å…¨åŸŸç‹€æ…‹ ===================== */
    let logs = [];
    let currentFilter = 'å…¨éƒ¨';
    let isConnected = false;
    let gasUrl = '';
    let editingId = null;

    // Auth ç‹€æ…‹
    let TOKEN = null;
    let CURRENT_USER = null; // { username, role }

    /* ===================== åˆå§‹åŒ– ===================== */
    document.addEventListener('DOMContentLoaded', () => {
      // å¾ localStorage é‚„åŸè¨­å®š
      gasUrl = localStorage.getItem('gasUrl') || '';
      TOKEN  = localStorage.getItem('token')  || null;
      CURRENT_USER = JSON.parse(localStorage.getItem('user') || 'null');

      if (gasUrl) document.getElementById('gasUrl').value = gasUrl;

      initializeApp();
      bindEvents();

      if (gasUrl) connectToGoogleSheets(true); // silent é¦–æ¬¡é€£ç·š
    });

    function initializeApp() {
      updateLogsList();
      updateStats();
      reflectAuthToUI();
    }

    function bindEvents() {
      // é€£ç·š
      document.getElementById('connectBtn').addEventListener('click', () => connectToGoogleSheets(false));
      document.getElementById('disconnectBtn').addEventListener('click', disconnectFromGoogleSheets);

      // è¨ºæ–· / URL help
      document.getElementById('diagnosisBtn').addEventListener('click', runDiagnosisTest);
      document.getElementById('urlHelpBtn').addEventListener('click', showUrlHelp);

      // ç¯©é¸ & æ–°å¢
      document.getElementById('filterButtons').addEventListener('click', (e) => {
        if (e.target.classList.contains('filter-btn')) setFilter(e.target.dataset.filter);
      });
      document.getElementById('addLogBtn').addEventListener('click', () => {
        if (!canWrite()) { showPermissionHint(); return; }
        showAddForm();
      });
      document.getElementById('saveLogBtn').addEventListener('click', saveNewLog);
      document.getElementById('cancelAddBtn').addEventListener('click', hideAddForm);

      // ç™»å…¥ / ç™»å‡º
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    }

    /* ===================== æ¬Šé™åˆ¤æ–· ===================== */
    const WRITE_ROLES = ['owner','admin','editor'];
    function canWrite() {
      return CURRENT_USER && WRITE_ROLES.includes(CURRENT_USER.role);
    }
    function showPermissionHint() {
      const el = document.getElementById('permissionHint');
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('hidden'), 2500);
    }

    /* ===================== Google Sheetsï¼ˆå« Authï¼‰ ===================== */
    async function connectToGoogleSheets(silent=false) {
      const urlInput = document.getElementById('gasUrl');
      gasUrl = urlInput.value.trim() || gasUrl;

      if (!gasUrl) { alert('è«‹å…ˆè¼¸å…¥ Google Apps Script URL'); return; }
      if (!/script\.google\.com\/macros\/s\/.+\/exec$/.test(gasUrl)) {
        const go = confirm('çœ‹èµ·ä¾†ä¸æ˜¯ /exec çµå°¾çš„ Web App URLï¼Œä»è¦å˜—è©¦é€£ç·šå—ï¼Ÿ');
        if (!go) return;
      }

      setLoading(true);
      try {
        const response = await fetch(`${gasUrl}?action=test`, { method:'GET', mode:'cors' });
        if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText}`);
        const data = await response.json().catch(()=>({}));
        if (data && data.success) {
          isConnected = true;
          localStorage.setItem('gasUrl', gasUrl);
          updateConnectionStatus();

          // å˜—è©¦æ¢å¾©ç™»å…¥ç‹€æ…‹
          if (TOKEN) {
            await whoAmI(true); // éœé»˜æª¢æŸ¥ token
          }
          await loadLogsFromSheet();
          if (!silent) alert('æˆåŠŸé€£æ¥åˆ° Google Sheetsï¼');
        } else {
          throw new Error(data.message || 'GAS å›æ‡‰é success');
        }
      } catch (err) {
        console.error('é€£æ¥éŒ¯èª¤:', err);
        alert(`é€£æ¥å¤±æ•—ï¼š${err.message}\n\nè«‹æª¢æŸ¥ï¼š\n1) Web App æ¬Šé™\n2) URL æ˜¯å¦ /exec\n3) é‡æ–°éƒ¨ç½²æ˜¯å¦æ›äº† URL`);
        isConnected = false;
        updateConnectionStatus();
      } finally {
        setLoading(false);
      }
    }

    function disconnectFromGoogleSheets() {
      isConnected = false; gasUrl = '';
      document.getElementById('gasUrl').value = '';
      localStorage.removeItem('gasUrl');
      updateConnectionStatus();
    }

    function updateConnectionStatus() {
      const statusElement = document.getElementById('connectionStatus');
      const setupInfo = document.getElementById('setupInfo');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const gasUrlInput = document.getElementById('gasUrl');

      if (isConnected) {
        statusElement.textContent = 'â— å·²é€£æ¥';
        statusElement.className = 'status-indicator status-connected';
        setupInfo.classList.add('hidden');
        connectBtn.textContent = 'é‡æ–°è¼‰å…¥';
        disconnectBtn.classList.remove('hidden');
        gasUrlInput.disabled = true;
      } else {
        statusElement.textContent = 'â— æœªé€£æ¥';
        statusElement.className = 'status-indicator status-disconnected';
        setupInfo.classList.remove('hidden');
        connectBtn.textContent = 'é€£æ¥';
        disconnectBtn.classList.add('hidden');
        gasUrlInput.disabled = false;
      }
    }

    // === å¾Œç«¯å‘¼å«ï¼ˆè‡ªå‹•å¸¶ tokenï¼‰ ===
    async function saveLogToSheet(logData) {
      if (!isConnected) return false;
      if (!canWrite()) { showPermissionHint(); return false; }
      try {
        const res = await fetch(gasUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'addLog', token:TOKEN, data:logData })
        }).then(r=>r.json());
        return !!res.success;
      } catch (e) { console.error(e); return false; }
    }

    async function loadLogsFromSheet() {
      if (!isConnected) return;
      setLoading(true);
      try {
        const res = await fetch(`${gasUrl}?action=getLogs`, { method:'GET', mode:'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json().catch(()=>({}));
        if (data && data.success) {
          logs = Array.isArray(data.logs) ? data.logs : [];
          updateLogsList(); updateStats();
        } else {
          throw new Error(data.message || 'GAS å›å‚³å¤±æ•—');
        }
      } catch (e) {
        console.error('è¼‰å…¥éŒ¯èª¤:', e);
        alert(`å¾ Google Sheets è¼‰å…¥å¤±æ•—ï¼š${e.message}`);
      } finally {
        setLoading(false);
      }
    }

    async function updateLogInSheet(logData) {
      if (!isConnected) return false;
      if (!canWrite()) { showPermissionHint(); return false; }
      try {
        const res = await fetch(gasUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'updateLog', token:TOKEN, data:logData })
        }).then(r=>r.json());
        return !!res.success;
      } catch (e) { console.error(e); return false; }
    }

    async function deleteLogFromSheet(logId) {
      if (!isConnected) return false;
      if (!canWrite()) { showPermissionHint(); return false; }
      try {
        const res = await fetch(gasUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'deleteLog', token:TOKEN, data:{ id:logId } })
        }).then(r=>r.json());
        return !!res.success;
      } catch (e) { console.error(e); return false; }
    }

    /* ===================== Auth API ===================== */
    async function login() {
      if (!isConnected) { alert('è«‹å…ˆå®Œæˆé€£ç·šè¨­å®š'); return; }
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) { alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼'); return; }

      setLoading(true);
      try {
        const res = await fetch(gasUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'adminLogin', data:{ username, password } })
        }).then(r=>r.json());

        if (res.success) {
          TOKEN = res.token;
          CURRENT_USER = res.user;
          localStorage.setItem('token', TOKEN);
          localStorage.setItem('user', JSON.stringify(CURRENT_USER));
          reflectAuthToUI();
          alert(`ç™»å…¥æˆåŠŸï¼š${CURRENT_USER.username}ï¼ˆ${CURRENT_USER.role}ï¼‰`);
        } else {
          alert('ç™»å…¥å¤±æ•—ï¼š' + (res.message || ''));
        }
      } catch (e) {
        console.error(e);
        alert('ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);
      } finally {
        setLoading(false);
      }
    }

    async function logout() {
      if (!TOKEN) { clearAuth(); return; }
      try {
        await fetch(gasUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'adminLogout', token:TOKEN })
        });
      } catch(e){ console.warn('logout å‘¼å«å¤±æ•—ï¼Œå·²æœ¬åœ°æ¸…é™¤'); }
      clearAuth();
      reflectAuthToUI();
      alert('å·²ç™»å‡º');
    }

    async function whoAmI(silent=false) {
      if (!TOKEN) { clearAuth(); reflectAuthToUI(); return; }
      try {
        const res = await fetch(gasUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'whoami', token:TOKEN })
        }).then(r=>r.json());
        if (res.success) {
          CURRENT_USER = res.user;
          localStorage.setItem('user', JSON.stringify(CURRENT_USER));
          reflectAuthToUI();
        } else {
          clearAuth();
          reflectAuthToUI();
          if (!silent) alert('ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
        }
      } catch (e) {
        console.error('whoami éŒ¯èª¤', e);
        if (!silent) alert('é©—è­‰ç™»å…¥ç‹€æ…‹å¤±æ•—');
      }
    }

    function clearAuth() {
      TOKEN = null; CURRENT_USER = null;
      localStorage.removeItem('token');
      localStorage.removeItem('user');
    }

    function reflectAuthToUI() {
      const authStatus = document.getElementById('authStatus');
      const roleHint = document.getElementById('roleHint');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const addBtn = document.getElementById('addLogBtn');

      if (CURRENT_USER) {
        authStatus.textContent = `å·²ç™»å…¥ï¼š${CURRENT_USER.username}`;
        roleHint.textContent = `æ¬Šé™ï¼š${CURRENT_USER.role}`;
        logoutBtn.disabled = false;
        loginBtn.disabled = true;
        addBtn.disabled = !canWrite();
      } else {
        authStatus.textContent = 'æœªç™»å…¥';
        roleHint.textContent = 'æ¬Šé™ï¼š-';
        logoutBtn.disabled = true;
        loginBtn.disabled = false;
        addBtn.disabled = true; // æœªç™»å…¥ä¸å¯æ–°å¢
      }

      // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆæ§åˆ¶ ç·¨è¼¯/åˆªé™¤ æŒ‰éˆ•é¡¯ç¤ºï¼‰
      updateLogsList();
    }

    /* ===================== è¨ºæ–· & å°å·¥å…· ===================== */
    async function runDiagnosisTest() {
      const testUrl = document.getElementById('gasUrl').value.trim();
      if (!testUrl) { alert('è«‹å…ˆè¼¸å…¥ Google Apps Script URL'); return; }
      const results = [];
      results.push('ğŸ” è¨ºæ–·æ¸¬è©¦é–‹å§‹...\n');

      if (testUrl.includes('script.google.com/macros/s/') && testUrl.endsWith('/exec')) {
        results.push('âœ… URLæ ¼å¼æ­£ç¢º');
      } else {
        results.push('âŒ URLæ ¼å¼ä¸æ­£ç¢º');
        results.push('   æ­£ç¢ºæ ¼å¼ï¼šhttps://script.google.com/macros/s/[ID]/exec');
      }

      results.push('\nğŸŒ æ¸¬è©¦ç¶²è·¯é€£æ¥...');
      try {
        const response = await fetch(testUrl + '?action=test', { method: 'GET', mode: 'cors' });
        results.push(`âœ… HTTPç‹€æ…‹ï¼š${response.status} ${response.statusText}`);
        if (response.ok) {
          const data = await response.json().catch(() => ({}));
          if (data.success) {
            results.push('âœ… Apps Scriptå›æ‡‰æ­£å¸¸');
            results.push(`âœ… ç‰ˆæœ¬ï¼š${data.version || 'unknown'}`);
          } else {
            results.push('âŒ Apps Scriptå›æ‡‰ç•°å¸¸ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
          }
        } else {
          results.push('âŒ HTTPè«‹æ±‚å¤±æ•—');
        }
      } catch (error) {
        results.push('âŒ é€£æ¥å¤±æ•—ï¼š' + error.message);
        if (error.message.includes('CORS')) results.push('   ğŸ’¡ å¯èƒ½æ˜¯CORSå•é¡Œï¼Œè«‹æª¢æŸ¥éƒ¨ç½²è¨­å®š');
      }

      results.push('\nğŸ“¤ æ¸¬è©¦POSTè«‹æ±‚...');
      try {
        const response = await fetch(testUrl, {
          method:'POST', mode:'cors',
          headers:{ 'Content-Type':'text/plain' },
          body: JSON.stringify({ action:'test', data:{ test:true } })
        });
        results.push(response.ok ? 'âœ… POSTè«‹æ±‚æˆåŠŸ' : `âŒ POSTè«‹æ±‚å¤±æ•—ï¼š${response.status}`);
      } catch (error) {
        results.push('âŒ POSTè«‹æ±‚éŒ¯èª¤ï¼š' + error.message);
      }

      results.push('\nğŸ“‹ è¨ºæ–·å®Œæˆï¼\nå¦‚é‡ âŒ è«‹æª¢æŸ¥ï¼š\n1) Web æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²èˆ‡æ¬Šé™\n2) URL æ˜¯å¦ä»¥ /exec çµå°¾\n3) é‡æ–°éƒ¨ç½²å¾Œæ›´æ–°æœ€æ–° URL');
      alert(results.join('\n'));
    }

    function showUrlHelp() {
      alert(`ğŸ“š Google Apps Script URL æ ¼å¼èªªæ˜

âœ… æ­£ç¢ºï¼š https://script.google.com/macros/s/AKfycby.../exec
âŒ éŒ¯èª¤ï¼š
â€¢ https://script.google.com/d/[ID]/editï¼ˆç·¨è¼¯é ï¼‰
â€¢ https://script.google.com/home/projects/[ID]ï¼ˆå°ˆæ¡ˆé ï¼‰

å–å¾—æ–¹å¼ï¼š
1. GAS â†’ éƒ¨ç½² â†’ ç®¡ç†éƒ¨ç½²
2. è¤‡è£½ã€ŒWeb æ‡‰ç”¨ç¨‹å¼ã€URLï¼ˆ/exec çµå°¾ï¼‰
3. æ¬Šé™é¸ã€Œä»»ä½•äººã€`);
    }

    /* ===================== UIï¼šåˆ—è¡¨ & è¡¨å–® ===================== */
    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
      updateLogsList();
    }

    function showAddForm() {
      document.getElementById('addForm').classList.remove('hidden');
      document.getElementById('newTitle').focus();
    }
    function hideAddForm() { document.getElementById('addForm').classList.add('hidden'); clearAddForm(); }
    function clearAddForm() {
      document.getElementById('newTitle').value = '';
      document.getElementById('newContent').value = '';
      document.getElementById('newCategory').value = 'ä¸€èˆ¬';
    }

    async function saveNewLog() {
      if (!canWrite()) { showPermissionHint(); return; }
      const title = document.getElementById('newTitle').value.trim();
      const content = document.getElementById('newContent').value.trim();
      const category = document.getElementById('newCategory').value;
      if (!title || !content) { alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹'); return; }

      const now = new Date();
      const log = {
        id: Date.now(),
        title, content, category,
        date: todayStr(),
        time: now.toTimeString().split(' ')[0].slice(0, 5)
      };

      logs.unshift(log); updateLogsList(); updateStats(); hideAddForm();

      if (isConnected) {
        setLoading(true);
        const ok = await saveLogToSheet(log);
        if (!ok) alert('ä¿å­˜åˆ° Google Sheets å¤±æ•—ï¼Œä½†æœ¬åœ°å·²ä¿å­˜');
        setLoading(false);
      }
    }

    function startEdit(logId) {
      if (!canWrite()) { showPermissionHint(); return; }
      editingId = logId;
      const log = logs.find(l => l.id === logId);
      if (!log) return;
      const el = document.querySelector(`[data-log-id="${logId}"]`);
      el.outerHTML = createEditForm(log); // ç›´æ¥æ›¿æ›
      // é‡æ–°æ›äº‹ä»¶
      document.querySelector(`[data-log-id="${logId}"] .save-edit-btn`).addEventListener('click', () => saveEdit(logId));
      document.querySelector(`[data-log-id="${logId}"] .cancel-edit-btn`).addEventListener('click', () => cancelEdit());
    }

    async function saveEdit(logId) {
      if (!canWrite()) { showPermissionHint(); return; }
      const el = document.querySelector(`[data-log-id="${logId}"]`);
      const title = el.querySelector('.edit-title').value.trim();
      const content = el.querySelector('.edit-content').value.trim();
      const category = el.querySelector('.edit-category').value;
      if (!title || !content) { alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹'); return; }

      const idx = logs.findIndex(l => l.id === logId);
      if (idx !== -1) logs[idx] = { ...logs[idx], title, content, category };

      editingId = null; updateLogsList(); updateStats();

      if (isConnected) {
        setLoading(true);
        const ok = await updateLogInSheet(logs[idx]);
        if (!ok) alert('æ›´æ–°åˆ° Google Sheets å¤±æ•—ï¼Œä½†æœ¬åœ°å·²æ›´æ–°');
        setLoading(false);
      }
    }

    function cancelEdit() { editingId = null; updateLogsList(); }

    async function deleteLog(logId) {
      if (!canWrite()) { showPermissionHint(); return; }
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ—¥èªŒå—ï¼Ÿ')) return;
      logs = logs.filter(l => l.id !== logId);
      updateLogsList(); updateStats();
      if (isConnected) {
        setLoading(true);
        const ok = await deleteLogFromSheet(logId);
        if (!ok) alert('å¾ Google Sheets åˆªé™¤å¤±æ•—ï¼Œä½†æœ¬åœ°å·²åˆªé™¤');
        setLoading(false);
      }
    }

    /* ===================== æ¸²æŸ“ ===================== */
    function updateLogsList() {
      const container = document.getElementById('logsList');
      const filtered = currentFilter === 'å…¨éƒ¨' ? logs : logs.filter(l => l.category === currentFilter);

      if (filtered.length === 0) {
        container.innerHTML = `<div class="card"><div class="empty-state">ç›®å‰æ²’æœ‰æ—¥èªŒæ¢ç›®</div></div>`;
        return;
      }
      container.innerHTML = filtered.map(log =>
        editingId === log.id ? createEditForm(log) : createLogItem(log)
      ).join('');

      // æ›æŒ‰éˆ•äº‹ä»¶
      container.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.closest('[data-log-id]').dataset.logId);
          startEdit(id);
        });
        // æ¬Šé™æ§åˆ¶
        if (!canWrite()) btn.setAttribute('disabled','disabled');
      });
      container.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.closest('[data-log-id]').dataset.logId);
          deleteLog(id);
        });
        if (!canWrite()) btn.setAttribute('disabled','disabled');
      });

      // æ–°å¢æŒ‰éˆ•ç‹€æ…‹
      document.getElementById('addLogBtn').disabled = !canWrite();
    }

    function createLogItem(log) {
      const categoryClass = `category-${
        log.category === 'é‡è¦' ? 'important' :
        log.category === 'ä¸€èˆ¬' ? 'general' :
        log.category === 'æœƒè­°' ? 'meeting' :
        log.category === 'åŠŸèƒ½' ? 'feature' : 'other'
      }`;
      return `
      <div class="log-item" data-log-id="${log.id}">
        <div class="log-header">
          <div class="flex-1">
            <h3 class="log-title">${escapeHtml(log.title)}</h3>
            <div class="log-meta">
              <div class="meta-item"><span>ğŸ“…</span><span>${formatDate(log.date)}</span></div>
              <div class="meta-item"><span>ğŸ•</span><span>${log.time}</span></div>
              <span class="category-badge ${categoryClass}">${log.category}</span>
            </div>
          </div>
          <div class="log-actions">
            <button class="action-btn edit-btn" title="ç·¨è¼¯">âœï¸</button>
            <button class="action-btn delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button>
          </div>
        </div>
        <p class="log-content">${escapeHtml(log.content)}</p>
      </div>`;
    }

    function createEditForm(log) {
      return `
      <div class="log-item" data-log-id="${log.id}">
        <div class="input-group"><input type="text" class="input-field edit-title" value="${escapeAttr(log.title)}"></div>
        <div class="input-group"><textarea class="input-field textarea edit-content">${escapeHtml(log.content)}</textarea></div>
        <div class="input-group">
          <select class="input-field edit-category">
            <option value="é‡è¦" ${log.category === 'é‡è¦' ? 'selected' : ''}>é‡è¦</option>
            <option value="ä¸€èˆ¬" ${log.category === 'ä¸€èˆ¬' ? 'selected' : ''}>ä¸€èˆ¬</option>
            <option value="æœƒè­°" ${log.category === 'æœƒè­°' ? 'selected' : ''}>æœƒè­°</option>
            <option value="åŠŸèƒ½" ${log.category === 'åŠŸèƒ½' ? 'selected' : ''}>åŠŸèƒ½</option>
            <option value="å…¶ä»–" ${log.category === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
          </select>
        </div>
        <div class="flex-row">
          <button class="btn btn-success save-edit-btn"><span>ğŸ’¾</span> å„²å­˜</button>
          <button class="btn btn-secondary cancel-edit-btn"><span>âŒ</span> å–æ¶ˆ</button>
        </div>
      </div>`;
    }

    function updateStats() {
      const today = todayStr();
      document.getElementById('totalLogs').textContent = logs.length;
      document.getElementById('todayLogs').textContent = logs.filter(l => l.date === today).length;
      document.getElementById('importantLogs').textContent = logs.filter(l => l.category === 'é‡è¦').length;
    }

    /* ===================== è¼”åŠ©å·¥å…· ===================== */
    function setLoading(loading) {
      const syncStatus = document.getElementById('syncStatus');
      if (loading) { syncStatus.classList.remove('hidden'); document.body.classList.add('loading'); }
      else { syncStatus.classList.add('hidden'); document.body.classList.remove('loading'); }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      if (dateStr === todayStr()) return 'ä»Šå¤©';
      if (dateStr === dayOffsetStr(-1)) return 'æ˜¨å¤©';
      return `${date.getMonth()+1}/${date.getDate()}`;
    }
    function escapeHtml(t){const d=document.createElement('div');d.textContent=t??'';return d.innerHTML;}
    function escapeAttr(t){return String(t??'').replace(/"/g,'&quot;');}
    function todayStr(){return new Date().toISOString().split('T')[0];}
    function dayOffsetStr(d){const dt=new Date(Date.now()+d*86400000);return dt.toISOString().split('T')[0];}
  </script>
</body>
</html>
