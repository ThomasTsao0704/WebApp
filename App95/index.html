<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ“Œ æ™ºèƒ½ä¾¿åˆ©è²¼ä½ˆå‘Šæ¬„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      /* é€™è£¡æ›æˆä½ çš„ç„¡ç¸«è²¼åœ–è·¯å¾‘ï¼ˆPNG/JPG/WebP çš†å¯ï¼‰ */
      --cork-url: url("./assets/cork1.png");
      --cork-base: #b7814d;
      /* ç´ åº•è‰²ï¼Œé˜²æ­¢åœ–ç‰‡æœªè¼‰å…¥æ™‚çªå…€ */
      --vignette: rgba(0, 0, 0, .18);
      /* å››å‘¨æš—è§’å¼·åº¦ */
      --sheen: rgba(255, 255, 255, .18);
      /* ä¸Šæ–¹æŸ”å…‰ */
    }


    * {
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Microsoft JhengHei', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      touch-action: pan-y;
    }

    .cork-board {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: var(--cork-base);
      background-image: var(--cork-url);
      background-repeat: repeat;
      background-size: 256px 256px;
      /* ä¾ä½ çš„è²¼åœ–å°ºå¯¸èª¿æ•´ï¼ˆå»ºè­° 128/256/512ï¼‰ */
    }


    /* æŸ”å’Œä¸Šæ–¹å…‰å¸¶ï¼ˆå¢åŠ ç«‹é«”æ„Ÿï¼‰ */
    .cork-board::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(to bottom, var(--sheen) 0%, transparent 35%),
        radial-gradient(120% 120% at 50% -10%, rgba(255, 255, 255, .25), transparent 60%);
      mix-blend-mode: soft-light;
    }

    /* å››å‘¨æ·¡æ·¡æš—è§’ï¼‹è¶…æ·¡é›œè¨Šï¼Œé¿å…å¹³é‹ªå¤ªè¦å‰‡ */
    .cork-board::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(120% 120% at 50% 50%, transparent 60%, var(--vignette) 100%),
        repeating-linear-gradient(0deg, rgba(0, 0, 0, .01) 0 2px, transparent 2px 4px),
        repeating-linear-gradient(90deg, rgba(0, 0, 0, .01) 0 2px, transparent 2px 4px);
      opacity: .55;
      /* é›œè¨Šèˆ‡æš—è§’çš„æ•´é«”é€æ˜åº¦ */
      mix-blend-mode: multiply;
      /* è®“æ•ˆæœæ›´è‡ªç„¶ */
    }

    /* æ‡¸æµ®æŒ‰éˆ• */
    .floating-btn {
      position: fixed;
      z-index: 100;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, .15);
      border-radius: 50%;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .2s ease;
    }

    .floating-btn:active {
      transform: scale(0.92);
      background: rgba(255, 255, 255, 0.95);
    }

    .menu-btn {
      top: 16px;
      left: 16px;
    }

    .add-btn {
      top: 16px;
      right: 16px;
      background: rgba(59, 130, 246, 0.9);
      color: white;
    }

    .add-btn:active {
      background: rgba(59, 130, 246, 1);
    }

    /* å´æ¬„ */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 150;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s;
    }

    .menu-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .menu-panel {
      position: fixed;
      top: 0;
      left: -100%;
      width: 85%;
      max-width: 340px;
      height: 100vh;
      background: #fff;
      z-index: 160;
      transition: left .3s;
      overflow-y: auto;
    }

    .menu-panel.active {
      left: 0;
    }

    /* ç•«å¸ƒå€åŸŸ - ç¾åœ¨å¾é ‚éƒ¨é–‹å§‹ */
    .canvas-wrapper {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .zoom-container {
      position: absolute;
      top: 0;
      left: 0;
      width: var(--canvas-w);
      height: var(--canvas-h);
      transform-origin: 0 0;
      transition: transform .08s ease-out;
      will-change: transform;
    }

    .notes-grid {
      position: absolute;
      inset: 0;
      width: var(--canvas-w);
      height: var(--canvas-h);
    }

    /* ä¾¿åˆ©è²¼ */
    .sticky-note {
      position: absolute;
      box-shadow: 3px 3px 10px rgba(0, 0, 0, .3);
      touch-action: none;
      border-radius: .5rem;
      font-family: 'Comic Sans MS', cursive;
    }

    .sticky-note:active {
      box-shadow: 6px 6px 15px rgba(0, 0, 0, .4);
    }

    .resizer {
      width: 44px;
      height: 44px;
      background: rgba(0, 0, 0, .3);
      position: absolute;
      right: -10px;
      bottom: -10px;
      border-radius: 50%;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .touch-target {
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tag-badge {
      display: inline-block;
      background: rgba(0, 0, 0, .2);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      margin: 2px;
    }

    /* ç¸®æ”¾æ§åˆ¶ */
    .zoom-controls {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 90;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .zoom-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, .18);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      user-select: none;
    }

    .zoom-btn:active {
      transform: scale(.92);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .5
      }
    }

    .animate-pulse-custom {
      animation: pulse 1s infinite;
    }

    @media (max-width:640px) {
      .sticky-note {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div class="cork-board">

    <!-- å·¦ä¸Šè§’æ‡¸æµ®é¸å–®æŒ‰éˆ• -->
    <button onclick="toggleMenu()" class="floating-btn menu-btn" title="é¸å–®">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>

    <!-- å³ä¸Šè§’æ‡¸æµ®å¿«é€Ÿæ–°å¢æŒ‰éˆ• -->
    <button onclick="showQuickAdd()" class="floating-btn add-btn" title="å¿«é€Ÿæ–°å¢">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
    </button>

    <!-- å´é‚Šé¸å–® -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    <div id="menuPanel" class="menu-panel">
      <div class="p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">é¸å–®</h2>
          <button onclick="toggleMenu()" class="touch-target p-2 hover:bg-gray-100 rounded-lg">âœ•</button>
        </div>

        <!-- æœå°‹åŠŸèƒ½ -->
        <div class="mb-6">
          <h3 class="font-bold text-gray-700 mb-2">ğŸ” æœå°‹</h3>
          <input id="searchInput" type="text" placeholder="æœå°‹ä¾¿åˆ©è²¼..."
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" />
        </div>

        <div class="mb-6">
          <h3 class="font-bold text-gray-700 mb-3">ğŸ¨ æ–°å¢ä¾¿åˆ©è²¼</h3>
          <div class="space-y-2">
            <button onclick="addNote('normal'); toggleMenu();"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg text-left">ğŸ”µ ä¸€èˆ¬è¨Šæ¯</button>
            <button onclick="addNote('info'); toggleMenu();"
              class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-left">ğŸŸ¢ é€šçŸ¥è¨Šæ¯</button>
            <button onclick="addNote('important'); toggleMenu();"
              class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-lg text-left">ğŸŸ¡
              é‡è¦æé†’</button>
            <button onclick="addNote('warning'); toggleMenu();"
              class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg text-left">ğŸ”´ è­¦ç¤ºæé†’</button>
          </div>
        </div>

        <div class="mb-6">
          <h3 class="font-bold text-gray-700 mb-3">ğŸ” ç¯©é¸</h3>
          <select id="filterLevel"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg mb-2 focus:outline-none focus:border-blue-500">
            <option value="all">å…¨éƒ¨ç­‰ç´š</option>
            <option value="normal">ä¸€èˆ¬è¨Šæ¯</option>
            <option value="info">é€šçŸ¥è¨Šæ¯</option>
            <option value="important">é‡è¦æé†’</option>
            <option value="warning">è­¦ç¤ºæé†’</option>
          </select>
          <select id="filterTag"
            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
            <option value="all">å…¨éƒ¨æ¨™ç±¤</option>
          </select>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
          <h3 class="font-bold text-gray-700 mb-2">ğŸ“ˆ çµ±è¨ˆ</h3>
          <div class="text-sm space-y-1">
            <div>ç¸½ä¾¿åˆ©è²¼ï¼š<span id="totalCount" class="font-bold">0</span></div>
            <div>ğŸ”µ <span id="normalCount">0</span> | ğŸŸ¢ <span id="infoCount">0</span></div>
            <div>ğŸŸ¡ <span id="importantCount">0</span> | ğŸ”´ <span id="warningCount">0</span></div>
          </div>
        </div>

        <div class="space-y-2">
          <button onclick="showStats(); toggleMenu();"
            class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-left">ğŸ“Š è©³ç´°çµ±è¨ˆ</button>
          <button onclick="exportNotes()"
            class="w-full px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg text-left">ğŸ’¾ åŒ¯å‡ºè³‡æ–™</button>
          <button onclick="importNotes()"
            class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-left">ğŸ“‚ åŒ¯å…¥è³‡æ–™</button>
          <button onclick="clearAllNotes()"
            class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg text-left">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        </div>
      </div>
    </div>

    <!-- å›ºå®šç•«å¸ƒ -->
    <div class="canvas-wrapper">
      <div id="zoomContainer" class="zoom-container">
        <div id="notesGrid" class="notes-grid"></div>
      </div>
    </div>

    <!-- ç¸®æ”¾æ§åˆ¶ -->
    <div class="zoom-controls">
      <div class="zoom-btn" onclick="zoomIn()" title="æ”¾å¤§">â•</div>
      <div class="zoom-btn" onclick="fitNotes()" title="é©æ‡‰ç‰ˆé¢" style="font-size:16px;">âŠ¡</div>
      <div class="zoom-btn" onclick="zoomOut()" title="ç¸®å°">â–</div>
    </div>

    <!-- å¿«é€Ÿæ–°å¢ -->
    <div id="quickAddModal" class="fixed inset-0 bg-black/50 flex items-end justify-center z-50 hidden">
      <div class="bg-white rounded-t-2xl w-full p-6 pb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">å¿«é€Ÿæ–°å¢</h2>
          <button onclick="closeQuickAdd()" class="touch-target p-2">âœ•</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <button onclick="addNote('normal'); closeQuickAdd();"
            class="bg-blue-500 text-white px-4 py-6 rounded-lg text-center">ğŸ”µ<br>ä¸€èˆ¬è¨Šæ¯</button>
          <button onclick="addNote('info'); closeQuickAdd();"
            class="bg-green-500 text-white px-4 py-6 rounded-lg text-center">ğŸŸ¢<br>é€šçŸ¥è¨Šæ¯</button>
          <button onclick="addNote('important'); closeQuickAdd();"
            class="bg-yellow-500 text-white px-4 py-6 rounded-lg text-center">ğŸŸ¡<br>é‡è¦æé†’</button>
          <button onclick="addNote('warning'); closeQuickAdd();"
            class="bg-red-500 text-white px-4 py-6 rounded-lg text-center">ğŸ”´<br>è­¦ç¤ºæé†’</button>
        </div>
      </div>
    </div>

    <!-- å¯†ç¢¼åˆªé™¤ -->
    <div id="passwordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 shadow-2xl max-w-md w-full mx-4">
        <h2 class="text-xl font-bold mb-4">ğŸ”’ åˆªé™¤é‡è¦æé†’</h2>
        <p class="text-gray-600 mb-4">æ­¤ç‚ºé‡è¦æé†’ï¼Œè«‹è¼¸å…¥å¯†ç¢¼æ‰èƒ½åˆªé™¤ï¼š</p>
        <input id="passwordInput" type="password" placeholder="è¼¸å…¥å¯†ç¢¼"
          class="w-full border-2 border-gray-300 rounded px-4 py-3 mb-4 focus:outline-none focus:border-yellow-500" />
        <div class="flex gap-3">
          <button onclick="confirmPasswordDelete()"
            class="flex-1 bg-yellow-500 text-white py-3 rounded font-bold">ç¢ºèªåˆªé™¤</button>
          <button onclick="closePasswordModal()"
            class="flex-1 bg-gray-400 text-white py-3 rounded font-bold">å–æ¶ˆ</button>
        </div>
        <p class="text-xs text-gray-500 mt-3 text-center">æç¤ºï¼šé è¨­å¯†ç¢¼æ˜¯ 1234</p>
      </div>
    </div>

        <!-- ç·¨è¼¯ -->
    <div id="editModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">âœï¸ ç·¨è¼¯ä¾¿åˆ©è²¼</h2>
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">å…§å®¹</label>
          <textarea id="editContent" rows="6"
            class="w-full border-2 border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-blue-500 resize-y"
            placeholder="è¼¸å…¥ä¾¿åˆ©è²¼å…§å®¹..."></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">é¸æ“‡é¡è‰²</label>
          <div class="grid grid-cols-4 gap-2">
            <div class="w-full h-12 bg-blue-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-blue-200')"></div>
            <div class="w-full h-12 bg-green-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-green-200')"></div>
            <div class="w-full h-12 bg-yellow-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-yellow-200')"></div>
            <div class="w-full h-12 bg-red-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-red-200')"></div>
            <div class="w-full h-12 bg-purple-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-purple-200')"></div>
            <div class="w-full h-12 bg-pink-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-pink-200')"></div>
            <div class="w-full h-12 bg-orange-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-orange-200')"></div>
            <div class="w-full h-12 bg-gray-200 rounded cursor-pointer border-2 border-gray-300"
              onclick="changeNoteColor('bg-gray-200')"></div>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
          <input id="editTags" type="text"
            class="w-full border-2 border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-blue-500" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">åˆ°æœŸæ—¥</label>
          <input id="editDueDate" type="datetime-local"
            class="w-full border-2 border-gray-300 rounded px-4 py-3 focus:outline-none focus:border-blue-500" />
        </div>
        <div class="flex gap-3">
          <button onclick="saveEdit()" class="flex-1 bg-blue-500 text-white py-3 rounded font-bold">å„²å­˜</button>
          <button onclick="closeEditModal()" class="flex-1 bg-gray-400 text-white py-3 rounded font-bold">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆ -->
    <div id="statsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">ğŸ“Š çµ±è¨ˆè³‡è¨Š</h2>
        <div id="statsContent" class="space-y-3"></div>
        <button onclick="closeStatsModal()"
          class="mt-4 w-full bg-blue-500 text-white py-3 rounded font-bold">é—œé–‰</button>
      </div>
    </div>

  </div>

  <script>
    // ===== Config =====
    // ç•«å¸ƒå¤§å°ç‚ºè¦–çª—çš„å€æ•¸ï¼ˆå¯èª¿æ•´æ­¤ä¿‚æ•¸ï¼‰
    const CANVAS_MULTIPLIER = 3; // ç•«å¸ƒæ˜¯è¦–çª—å¤§å°çš„3å€
    let CANVAS_W = window.innerWidth * CANVAS_MULTIPLIER;
    let CANVAS_H = window.innerHeight * CANVAS_MULTIPLIER;
    let MIN_SCALE = 0.1; // å‹•æ…‹è¨ˆç®—çš„æœ€å°ç¸®æ”¾
    const MAX_SCALE = 5;

    // è¨ˆç®—åˆé©çš„æœ€å°ç¸®æ”¾æ¯”ä¾‹ï¼ˆå‰›å¥½èƒ½çœ‹åˆ°æ•´å€‹ç•«å¸ƒï¼‰
    function calculateMinScale() {
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const scaleX = vw / CANVAS_W;
      const scaleY = vh / CANVAS_H;
      MIN_SCALE = Math.min(scaleX, scaleY);
    }

    // å‹•æ…‹æ›´æ–°ç•«å¸ƒå¤§å°
    function updateCanvasSize() {
      const oldW = CANVAS_W;
      const oldH = CANVAS_H;
      CANVAS_W = window.innerWidth * CANVAS_MULTIPLIER;
      CANVAS_H = window.innerHeight * CANVAS_MULTIPLIER;

      // é‡æ–°è¨ˆç®—æœ€å°ç¸®æ”¾
      calculateMinScale();

      // æ›´æ–° DOM å…ƒç´ å°ºå¯¸
      const zoomContainer = el('zoomContainer');
      const notesGrid = el('notesGrid');
      if (zoomContainer) {
        zoomContainer.style.width = CANVAS_W + 'px';
        zoomContainer.style.height = CANVAS_H + 'px';
      }
      if (notesGrid) {
        notesGrid.style.width = CANVAS_W + 'px';
        notesGrid.style.height = CANVAS_H + 'px';
      }

      // èª¿æ•´ä¾¿åˆ©è²¼ä½ç½®ï¼ˆæŒ‰æ¯”ä¾‹ç¸®æ”¾ï¼‰
      if (oldW > 0 && oldH > 0) {
        const scaleX = CANVAS_W / oldW;
        const scaleY = CANVAS_H / oldH;
        notes.forEach(n => {
          n.x = clamp(n.x * scaleX, 0, CANVAS_W - n.width);
          n.y = clamp(n.y * scaleY, 0, CANVAS_H - n.height);
        });
        saveNotes();
      }
    }

    const levelConfig = {
      normal: { color: 'bg-blue-200', label: 'ä¸€èˆ¬è¨Šæ¯', icon: 'ğŸ”µ', deleteRule: 'direct' },
      info: { color: 'bg-green-200', label: 'é€šçŸ¥è¨Šæ¯', icon: 'ğŸŸ¢', deleteRule: 'direct' },
      important: { color: 'bg-yellow-300', label: 'é‡è¦æé†’', icon: 'âš ï¸', deleteRule: 'password' },
      warning: { color: 'bg-red-300', label: 'è­¦ç¤ºæé†’', icon: 'ğŸš¨', deleteRule: 'doubleConfirm' },
    };

    let notes = [];
    let deleteConfirm = null, noteToDelete = null, deleteConfirmTimeout = null;
    let editingNote = null;

    // ç¸®æ”¾/å¹³ç§»ç‹€æ…‹
    let scale = 1, translateX = 0, translateY = 0;
    let isPanning = false, panStartX = 0, panStartY = 0;
    let initialPinchDistance = 0, initialScale = 1;

    // ===== UI toggles =====
    function toggleMenu() {
      const o = document.getElementById('menuOverlay');
      const p = document.getElementById('menuPanel');
      o.classList.toggle('active');
      p.classList.toggle('active');
    }
    function showQuickAdd() { document.getElementById('quickAddModal').classList.remove('hidden'); }
    function closeQuickAdd() { document.getElementById('quickAddModal').classList.add('hidden'); }

    // ===== persistence =====
    function loadNotes() {
      const saved = localStorage.getItem('stickyNotes');
      if (saved) {
        notes = JSON.parse(saved);
        notes.forEach(n => {
          if (!n.width) n.width = 200;
          if (!n.height) n.height = 180;
          if (typeof n.rotation !== 'number') n.rotation = (Math.random() > 0.5 ? 1 : -1);
          n.x = clamp(n.x, 0, CANVAS_W - (n.width || 200));
          n.y = clamp(n.y, 0, CANVAS_H - (n.height || 180));
        });
      } else {
        notes = [
          { id: 1, content: 'é€™æ˜¯ä¸€èˆ¬è¨Šæ¯\nå¯ä»¥ç›´æ¥åˆªé™¤', level: 'normal', x: 20, y: 20, width: 200, height: 180, color: 'bg-blue-200', tags: ['ç¯„ä¾‹'], dueDate: null, rotation: 1 },
          { id: 2, content: 'é€™æ˜¯é‡è¦æé†’\néœ€è¦å¯†ç¢¼åˆªé™¤', level: 'important', x: 260, y: 20, width: 200, height: 180, color: 'bg-yellow-300', tags: ['é‡è¦'], dueDate: null, rotation: -1 },
        ];
      }
      renderNotes(); updateStats(); updateTagFilter(); fitNotes();
    }
    function saveNotes() { localStorage.setItem('stickyNotes', JSON.stringify(notes)); updateStats(); updateTagFilter(); }

    // ===== helpers =====
    function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
    function el(id) { return document.getElementById(id); }

    // ===== stats & filters =====
    function updateStats() {
      el('totalCount').textContent = notes.length;
      el('normalCount').textContent = notes.filter(n => n.level === 'normal').length;
      el('infoCount').textContent = notes.filter(n => n.level === 'info').length;
      el('importantCount').textContent = notes.filter(n => n.level === 'important').length;
      el('warningCount').textContent = notes.filter(n => n.level === 'warning').length;
    }
    function updateTagFilter() {
      const all = new Set();
      notes.forEach(n => (n.tags || []).forEach(t => all.add(t)));
      const select = el('filterTag');
      const cur = select.value;
      select.innerHTML = '<option value="all">å…¨éƒ¨æ¨™ç±¤</option>';
      [...all].forEach(tag => {
        const o = document.createElement('option');
        o.value = tag;
        o.textContent = tag;
        select.appendChild(o);
      });
      select.value = cur;
    }

    // ===== render =====
    function renderNotes() {
      const grid = el('notesGrid');
      grid.innerHTML = '';
      const term = el('searchInput').value.toLowerCase();
      const level = el('filterLevel').value;
      const tag = el('filterTag').value;
      const filtered = notes.filter(n => {
        const s = n.content.toLowerCase().includes(term);
        const l = level === 'all' || n.level === level;
        const t = tag === 'all' || (n.tags || []).includes(tag);
        return s && l && t;
      });
      filtered.forEach(n => grid.appendChild(createNoteElement(n)));
    }

    function createNoteElement(note) {
      const div = document.createElement('div');
      div.className = `sticky-note ${note.color || levelConfig[note.level].color} p-3`;
      div.dataset.noteId = note.id;
      div.style.left = note.x + 'px';
      div.style.top = note.y + 'px';
      div.style.width = note.width + 'px';
      div.style.height = note.height + 'px';
      div.style.transform = `rotate(${(typeof note.rotation === 'number' ? note.rotation : 0)}deg)`;

      // Level badge
      const label = document.createElement('div');
      label.className = 'absolute top-2 left-2 flex items-center gap-1 bg-white/80 px-2 py-1 rounded text-xs font-bold';
      label.innerHTML = `${levelConfig[note.level].icon} <span>${levelConfig[note.level].label}</span>`;
      div.appendChild(label);

      // Buttons
      const btns = document.createElement('div');
      btns.className = 'absolute top-2 right-2 flex gap-1';
      const editBtn = document.createElement('button');
      editBtn.className = 'touch-target bg-blue-500 text-white rounded-full opacity-90';
      editBtn.innerHTML = 'âš™ï¸';
      editBtn.onclick = (e) => { e.stopPropagation(); openEditModal(note); };
      btns.appendChild(editBtn);
      const delBtn = document.createElement('button');
      delBtn.className = `touch-target ${deleteConfirm === note.id ? 'bg-red-600 animate-pulse-custom' : 'bg-red-500'} text-white rounded-full opacity-90`;
      delBtn.innerHTML = 'âœ•';
      delBtn.onclick = (e) => { e.stopPropagation(); handleDeleteAttempt(note); };
      btns.appendChild(delBtn);
      div.appendChild(btns);

      // Tags
      if (note.tags && note.tags.length) {
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'absolute top-12 left-2 flex flex-wrap gap-1';
        note.tags.forEach(t => {
          const s = document.createElement('span');
          s.className = 'tag-badge';
          s.textContent = '#' + t;
          tagsDiv.appendChild(s);
        });
        div.appendChild(tagsDiv);
      }

      // Content
      const content = document.createElement('div');
      content.className = 'w-full h-full overflow-auto break-words whitespace-pre-wrap text-gray-800 p-2 pt-14 pb-10';
      content.style.fontFamily = 'Comic Sans MS, cursive';
      content.textContent = note.content;
      content.contentEditable = false;
      div.appendChild(content);

      // Due date
      if (note.dueDate) {
        const due = new Date(note.dueDate);
        const overdue = due < new Date();
        const dueDiv = document.createElement('div');
        dueDiv.className = `absolute bottom-10 left-2 text-xs ${overdue ? 'text-white bg-red-600' : 'text-gray-700 bg-white/80'} px-2 py-1 rounded`;
        dueDiv.textContent = `ğŸ“… ${due.toLocaleDateString()} ${due.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
        div.appendChild(dueDiv);
      }

      // Resizer
      const resizer = document.createElement('div');
      resizer.className = 'resizer';
      resizer.innerHTML = 'â‡²';
      let resizeStart = null;
      resizer.addEventListener('touchstart', (e) => {
        e.stopPropagation();
        e.preventDefault();
        const t = e.touches[0];
        resizeStart = { x: t.clientX, y: t.clientY, w: note.width, h: note.height };
      }, { passive: false });
      document.addEventListener('touchmove', (e) => {
        if (!resizeStart) return;
        const t = e.touches[0];
        const dx = (t.clientX - resizeStart.x) / scale;
        const dy = (t.clientY - resizeStart.y) / scale;
        note.width = clamp(resizeStart.w + dx, 120, CANVAS_W - note.x);
        note.height = clamp(resizeStart.h + dy, 120, CANVAS_H - note.y);
        div.style.width = note.width + 'px';
        div.style.height = note.height + 'px';
      }, { passive: false });
      document.addEventListener('touchend', () => {
        if (resizeStart) {
          resizeStart = null;
          saveNotes();
        }
      });
      div.appendChild(resizer);

      // Pin dot
      const pin = document.createElement('div');
      pin.className = 'absolute -top-2 left-1/2 transform -translate-x-1/2 w-5 h-5 bg-red-500 rounded-full shadow-md border-2 border-red-600';
      div.appendChild(pin);

      // Drag
      let drag = null;
      const onStart = (e) => {
        if (e.target.tagName === 'BUTTON' || e.target === resizer) return;
        if (e.target === content && content.contentEditable === 'true') return;
        const t = e.touches[0];
        drag = { sx: t.clientX, sy: t.clientY, ix: note.x, iy: note.y, moved: false };
        div.style.zIndex = '1000';
      };
      const onMove = (e) => {
        if (!drag) return;
        e.preventDefault();
        e.stopPropagation();
        const t = e.touches[0];
        const dx = (t.clientX - drag.sx) / scale;
        const dy = (t.clientY - drag.sy) / scale;
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) drag.moved = true;
        note.x = clamp(drag.ix + dx, 0, CANVAS_W - note.width);
        note.y = clamp(drag.iy + dy, 0, CANVAS_H - note.height);
        div.style.left = note.x + 'px';
        div.style.top = note.y + 'px';
      };
      const onEnd = (e) => {
        if (!drag) return;
        if (!drag.moved && e.target === content) {
          content.contentEditable = true;
          content.focus();
        }
        div.style.zIndex = '';
        if (drag.moved) saveNotes();
        drag = null;
      };
      div.addEventListener('touchstart', onStart, { passive: false });
      div.addEventListener('touchmove', onMove, { passive: false });
      div.addEventListener('touchend', onEnd);

      // Content edit
      content.onblur = () => {
        content.contentEditable = false;
        updateNoteContent(note.id, content.textContent);
        saveNotes();
      };
      return div;
    }

    // ===== CRUD =====
    function addNote(level = 'normal') {
      const vw = window.innerWidth, vh = window.innerHeight;
      const visibleLeft = (-translateX) / scale, visibleTop = (-translateY) / scale, visibleW = vw / scale, visibleH = vh / scale;
      const w = 200, h = 200; const margin = 60;
      const nx = clamp(visibleLeft + Math.random() * (Math.max(visibleW - w - margin, 0)) + 30, 0, CANVAS_W - w);
      const ny = clamp(visibleTop + Math.random() * (Math.max(visibleH - h - margin, 0)) + 30, 0, CANVAS_H - h);
      const n = {
        id: Date.now(),
        content: `é€™æ˜¯${levelConfig[level].label}\né»æ“Šç·¨è¼¯å…§å®¹...`,
        level,
        x: nx,
        y: ny,
        width: w,
        height: h,
        color: levelConfig[level].color,
        tags: [],
        dueDate: null,
        rotation: (Math.random() > 0.5 ? 1 : -1)
      };
      notes.push(n);
      saveNotes();
      renderNotes();
    }

    function handleDeleteAttempt(note) {
      const rule = levelConfig[note.level].deleteRule;
      if (rule === 'direct') {
        deleteNote(note.id);
      } else if (rule === 'password') {
        noteToDelete = note;
        el('passwordModal').classList.remove('hidden');
        el('passwordInput').value = '';
      } else if (rule === 'doubleConfirm') {
        if (deleteConfirm === note.id) {
          deleteNote(note.id);
          deleteConfirm = null;
          if (deleteConfirmTimeout) clearTimeout(deleteConfirmTimeout);
        } else {
          deleteConfirm = note.id;
          renderNotes();
          if (deleteConfirmTimeout) clearTimeout(deleteConfirmTimeout);
          deleteConfirmTimeout = setTimeout(() => {
            deleteConfirm = null;
            renderNotes();
          }, 2500);
        }
      }
    }

    function confirmPasswordDelete() {
      const pwd = el('passwordInput').value;
      if (pwd === '1234') {
        deleteNote(noteToDelete.id);
        closePasswordModal();
      } else {
        alert('å¯†ç¢¼éŒ¯èª¤ï¼æç¤ºï¼šé è¨­å¯†ç¢¼æ˜¯ 1234');
      }
    }

    function closePasswordModal() {
      el('passwordModal').classList.add('hidden');
      noteToDelete = null;
    }

    function deleteNote(id) {
      notes = notes.filter(n => n.id !== id);
      saveNotes();
      renderNotes();
    }

    function updateNoteContent(id, content) {
      const n = notes.find(x => x.id === id);
      if (n) n.content = content;
    }

    function openEditModal(note) {
      editingNote = note;
      el('editTags').value = (note.tags || []).join(', ');
      el('editDueDate').value = note.dueDate || '';
      el('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      el('editModal').classList.add('hidden');
    }

    function changeNoteColor(color) {
      if (editingNote) editingNote.color = color;
    }

    function saveEdit() {
      if (!editingNote) return;
      const tags = el('editTags').value.split(',').map(t => t.trim()).filter(Boolean);
      editingNote.tags = tags;
      editingNote.dueDate = el('editDueDate').value || null;
      saveNotes();
      renderNotes();
      closeEditModal();
    }

    el('searchInput').addEventListener('input', renderNotes);
    el('filterLevel').addEventListener('change', renderNotes);
    el('filterTag').addEventListener('change', renderNotes);

    // ===== export/import =====
    function showStats() {
      const total = notes.length;
      const byLevel = {
        normal: notes.filter(n => n.level === 'normal').length,
        info: notes.filter(n => n.level === 'info').length,
        important: notes.filter(n => n.level === 'important').length,
        warning: notes.filter(n => n.level === 'warning').length
      };
      const allTags = {};
      notes.forEach(n => (n.tags || []).forEach(t => allTags[t] = (allTags[t] || 0) + 1));
      const overdue = notes.filter(n => n.dueDate && new Date(n.dueDate) < new Date()).length;
      const pct = (x, t) => t > 0 ? ((x / t * 100).toFixed(1) + '%') : '0.0%';
      const html = `
        <div class="space-y-4">
          <div class="bg-blue-50 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2">ğŸ“Š ç¸½é«”çµ±è¨ˆ</h3>
            <div class="text-sm space-y-1">
              <div>ç¸½ä¾¿åˆ©è²¼æ•¸ï¼š<span class="font-bold">${total}</span></div>
              <div>å·²éæœŸï¼š<span class="font-bold text-red-600">${overdue}</span></div>
            </div>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2">ğŸ“ˆ ç­‰ç´šåˆ†å¸ƒ</h3>
            <div class="space-y-2 text-sm">
              <div>ğŸ”µ ä¸€èˆ¬è¨Šæ¯ï¼š${byLevel.normal} (${pct(byLevel.normal, total)})</div>
              <div>ğŸŸ¢ é€šçŸ¥è¨Šæ¯ï¼š${byLevel.info} (${pct(byLevel.info, total)})</div>
              <div>ğŸŸ¡ é‡è¦æé†’ï¼š${byLevel.important} (${pct(byLevel.important, total)})</div>
              <div>ğŸ”´ è­¦ç¤ºæé†’ï¼š${byLevel.warning} (${pct(byLevel.warning, total)})</div>
            </div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2">ğŸ·ï¸ æ¨™ç±¤ä½¿ç”¨</h3>
            <div class="flex flex-wrap gap-2">
              ${Object.entries(allTags).map(([tag, count]) => `<span class="bg-purple-200 px-3 py-1 rounded-full text-sm">#${tag} (${count})</span>`).join('') || '<span class="text-gray-500 text-sm">å°šç„¡æ¨™ç±¤</span>'}
            </div>
          </div>
        </div>`;
      el('statsContent').innerHTML = html;
      el('statsModal').classList.remove('hidden');
    }

    function closeStatsModal() {
      el('statsModal').classList.add('hidden');
    }

    function exportNotes() {
      const dataStr = JSON.stringify(notes, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sticky-notes-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      alert('âœ… è³‡æ–™å·²åŒ¯å‡ºï¼');
    }

    function importNotes() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!Array.isArray(imported)) throw new Error('æ ¼å¼éŒ¯èª¤');
            if (confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${imported.length} å€‹ä¾¿åˆ©è²¼å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚`)) {
              imported.forEach(n => {
                if (!n.width) n.width = 200;
                if (!n.height) n.height = 180;
                if (typeof n.rotation !== 'number') n.rotation = (Math.random() > 0.5 ? 1 : -1);
                n.x = clamp(n.x, 0, CANVAS_W - (n.width || 200));
                n.y = clamp(n.y, 0, CANVAS_H - (n.height || 180));
              });
              notes = imported;
              saveNotes();
              renderNotes();
              fitNotes();
              alert('âœ… åŒ¯å…¥æˆåŠŸï¼');
            }
          } catch (err) {
            alert('âŒ åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function clearAllNotes() {
      if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ä¾¿åˆ©è²¼å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        notes = [];
        saveNotes();
        renderNotes();
        fitCanvas();
        alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰ä¾¿åˆ©è²¼');
      }
    }

    // ===== pan/zoom with boundaries =====
    const zoomContainer = el('zoomContainer');

    function updateZoom() {
      // é™åˆ¶å¹³ç§»ç¯„åœï¼Œç¢ºä¿ä¸æœƒç§»å‹•è¶…å‡ºç•«å¸ƒç¯„åœ
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const scaledW = CANVAS_W * scale;
      const scaledH = CANVAS_H * scale;

      // è¨ˆç®—æœ€å¤§æœ€å°å¹³ç§»å€¼
      const maxTransX = 0;
      const minTransX = vw - scaledW;
      const maxTransY = 0;
      const minTransY = vh - scaledH;

      // å¦‚æœç¸®æ”¾å¾Œçš„ç•«å¸ƒå°æ–¼è¦–çª—ï¼Œå…è¨±å±…ä¸­
      if (scaledW < vw) {
        translateX = (vw - scaledW) / 2;
      } else {
        translateX = clamp(translateX, minTransX, maxTransX);
      }

      if (scaledH < vh) {
        translateY = (vh - scaledH) / 2;
      } else {
        translateY = clamp(translateY, minTransY, maxTransY);
      }

      zoomContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function zoomIn() {
      scale = Math.min(scale * 1.3, MAX_SCALE);
      updateZoom();
    }

    function zoomOut() {
      scale = Math.max(scale / 1.3, MIN_SCALE);
      updateZoom();
    }

    // é©æ‡‰ï¼šé¡¯ç¤ºæ‰€æœ‰ä¾¿åˆ©è²¼
    function fitNotes() {
      if (!notes.length) {
        fitCanvas();
        return;
      }
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      notes.forEach(n => {
        minX = Math.min(minX, n.x);
        minY = Math.min(minY, n.y);
        maxX = Math.max(maxX, n.x + n.width);
        maxY = Math.max(maxY, n.y + n.height);
      });
      const pad = 50;
      minX = clamp(minX - pad, 0, CANVAS_W);
      minY = clamp(minY - pad, 0, CANVAS_H);
      maxX = clamp(maxX + pad, 0, CANVAS_W);
      maxY = clamp(maxY + pad, 0, CANVAS_H);
      const contentW = Math.max(1, maxX - minX);
      const contentH = Math.max(1, maxY - minY);
      const vw = window.innerWidth, vh = window.innerHeight;
      const sx = vw / contentW, sy = vh / contentH;
      scale = Math.min(sx, sy, 1);
      scale = Math.max(scale, MIN_SCALE);
      const scaledW = contentW * scale, scaledH = contentH * scale;
      const cx = (vw - scaledW) / 2, cy = (vh - scaledH) / 2;
      translateX = cx - minX * scale;
      translateY = cy - minY * scale;
      updateZoom();
    }

    // é¡¯ç¤ºæ•´å€‹å›ºå®šç•«å¸ƒ
    function fitCanvas() {
      const vw = window.innerWidth, vh = window.innerHeight;
      const sx = vw / CANVAS_W, sy = vh / CANVAS_H;
      scale = Math.min(sx, sy);
      translateX = (vw - CANVAS_W * scale) / 2;
      translateY = (vh - CANVAS_H * scale) / 2;
      updateZoom();
    }

    // è§¸æ§
    const wrapper = document.querySelector('.canvas-wrapper');
    if (wrapper) {
      wrapper.addEventListener('touchstart', (e) => {
        if (e.target.closest('.sticky-note')) return;
        if (e.touches.length === 2) {
          e.preventDefault();
          const [t1, t2] = e.touches;
          initialPinchDistance = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
          initialScale = scale;
        }
        else if (e.touches.length === 1) {
          isPanning = true;
          panStartX = e.touches[0].clientX - translateX;
          panStartY = e.touches[0].clientY - translateY;
        }
      }, { passive: false });

      wrapper.addEventListener('touchmove', (e) => {
        if (e.target.closest('.sticky-note')) return;
        if (e.touches.length === 2) {
          e.preventDefault();
          const [t1, t2] = e.touches;
          const d = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
          const k = d / initialPinchDistance;
          scale = clamp(initialScale * k, MIN_SCALE, MAX_SCALE);
          updateZoom();
        }
        else if (e.touches.length === 1 && isPanning) {
          e.preventDefault();
          translateX = e.touches[0].clientX - panStartX;
          translateY = e.touches[0].clientY - panStartY;
          updateZoom();
        }
      }, { passive: false });

      wrapper.addEventListener('touchend', (e) => {
        if (e.touches.length < 2) initialPinchDistance = 0;
        if (e.touches.length === 0) isPanning = false;
      });
    }

    document.addEventListener('touchmove', (e) => {
      if (e.target.closest('.sticky-note')) e.preventDefault();
    }, { passive: false });

    // åˆå§‹è¼‰å…¥
    document.addEventListener('DOMContentLoaded', () => {
      updateCanvasSize();
      loadNotes();
      fitNotes();
    });

    if (document.readyState !== 'loading') {
      updateCanvasSize();
      loadNotes();
      fitNotes();
    }

    window.addEventListener('resize', () => {
      updateCanvasSize();
      renderNotes();
      fitNotes();
    });
  </script>
</body>

</html>
