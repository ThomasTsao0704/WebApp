<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“Œ æ™ºèƒ½ä¾¿åˆ©è²¼ä½ˆå‘Šæ¬„ Proï¼ˆçµ•å°å®šä½è¦†è“‹ç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            font-family: 'Microsoft JhengHei', sans-serif;
        }

        .cork-board {
            background: #8B6F47;
            background-image:
                repeating-linear-gradient(90deg, #7A5C3A 0px, #7A5C3A 2px, transparent 2px, transparent 100px),
                repeating-linear-gradient(0deg, #7A5C3A 0px, #7A5C3A 2px, transparent 2px, transparent 100px);
            min-height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* é ‚éƒ¨å·¥å…·åˆ—è‡ªå‹•éš±è— */
        .toolbar {
            position: fixed;
            top: -120px;
            left: 0;
            right: 0;
            transition: top 0.3s ease-in-out;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .toolbar.visible {
            top: 0;
        }

        /* å·¦å´é¢æ¿è‡ªå‹•æ»‘é–‹/éš±è— */
        .side-panel {
            position: fixed;
            left: -320px;
            top: 50%;
            transform: translateY(-50%);
            transition: left 0.3s ease-in-out;
            z-index: 90;
            background: white;
            width: 320px;
            border-radius: 0 12px 12px 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
        }

        .side-panel.visible {
            left: 0;
        }

        .side-panel-content {
            padding: 16px;
            padding-top: 20px;
        }

        .sticky-note {
            position: absolute;
            /* ğŸ”´ æ”¹ç‚ºçµ•å°å®šä½ */
            font-family: 'Comic Sans MS', cursive;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.2s, transform 0.2s;
            flex-shrink: 0;
            cursor: grab;
            border-radius: 0.5rem;
            user-select: none;
        }

        .sticky-note:hover {
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.4);
            transform: scale(1.02);
        }

        .sticky-note.highlight {
            animation: highlight 1s ease-in-out;
        }

        @keyframes highlight {

            0%,
            100% {
                box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .animate-pulse-custom {
            animation: pulse 1s infinite;
        }

        .resizer {
            width: 15px;
            height: 15px;
            background: rgba(0, 0, 0, 0.3);
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: se-resize;
            border-radius: 0 0 4px 0;
        }

        .tag-badge {
            display: inline-block;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin: 2px;
        }

        /* ğŸ”´ ä¾¿åˆ©è²¼èˆå°ï¼šæ”¹ç‚ºç›¸å°å®šä½å®¹å™¨ï¼Œç§»é™¤ flex å½±éŸ¿ */
        .notes-grid {
            position: relative;
            /* è®“å­å…ƒç´ ï¼ˆsticky-noteï¼‰ç”¨ left/top å®šä½ */
            width: 100%;
            min-height: 60vh;
            padding: 20px;
            box-sizing: border-box;
            /* ç§»é™¤ display:flex ç›¸é—œå±¬æ€§ */
            /* display: flex;
         flex-wrap: wrap;
         gap: 20px;
         justify-content: flex-start;
         align-items: flex-start; */
        }

        #notesContainer {
            padding-top: 120px !important;
        }
    </style>
</head>

<body>
    <div class="cork-board">
        <!-- é ‚éƒ¨å·¥å…·åˆ—ï¼ˆè‡ªå‹•éš±è—ï¼‰ -->
        <div class="toolbar shadow-lg" id="topToolbar">
            <div class="flex items-center justify-between py-3 px-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“Œ æ™ºèƒ½ä¾¿åˆ©è²¼ä½ˆå‘Šæ¬„ Pro</h1>
                    <p class="text-xs text-gray-600 mt-1">é›™æ“Šç·¨è¼¯ | èª¿æ•´å¤§å° | è‡ªå‹•å„²å­˜</p>
                </div>
                <div class="flex items-center gap-3">
                    <input id="searchInput" type="text" placeholder="ğŸ” æœå°‹ä¾¿åˆ©è²¼..."
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 w-64" />
                    <select id="filterLevel"
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="all">å…¨éƒ¨ç­‰ç´š</option>
                        <option value="normal">ä¸€èˆ¬è¨Šæ¯</option>
                        <option value="info">é€šçŸ¥è¨Šæ¯</option>
                        <option value="important">é‡è¦æé†’</option>
                        <option value="warning">è­¦ç¤ºæé†’</option>
                    </select>
                    <select id="filterTag"
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="all">å…¨éƒ¨æ¨™ç±¤</option>
                    </select>
                    <button onclick="showStats()"
                        class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg"
                        title="çµ±è¨ˆè³‡è¨Š">ğŸ“Š</button>
                    <button onclick="exportNotes()"
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg" title="åŒ¯å‡ºè³‡æ–™">ğŸ’¾</button>
                    <button onclick="importNotes()"
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg" title="åŒ¯å…¥è³‡æ–™">ğŸ“‚</button>
                    <button onclick="clearAllNotes()"
                        class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg" title="æ¸…ç©ºå…¨éƒ¨">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>

        <!-- å·¦å´é¢æ¿ï¼ˆè‡ªå‹•æ»‘é–‹/éš±è—ï¼‰ -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-content">
                <h3 class="font-bold text-gray-800 mb-3 text-lg">ğŸ¨ æ–°å¢ä¾¿åˆ©è²¼</h3>
                <div class="space-y-2 mb-4">
                    <button onclick="addNote('normal')"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm">ğŸ”µ
                        ä¸€èˆ¬è¨Šæ¯</button>
                    <button onclick="addNote('info')"
                        class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm">ğŸŸ¢
                        é€šçŸ¥è¨Šæ¯</button>
                    <button onclick="addNote('important')"
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm">ğŸŸ¡
                        é‡è¦æé†’</button>
                    <button onclick="addNote('warning')"
                        class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm">ğŸ”´
                        è­¦ç¤ºæé†’</button>
                </div>

                <div class="border-t pt-3">
                    <h4 class="text-xs font-bold text-gray-600 mb-2">ğŸ“ˆ å¿«é€Ÿçµ±è¨ˆ</h4>
                    <div class="text-xs text-gray-700 space-y-1">
                        <div>ç¸½ä¾¿åˆ©è²¼æ•¸ï¼š<span id="totalCount" class="font-bold">0</span></div>
                        <div>ä¸€èˆ¬è¨Šæ¯ï¼š<span id="normalCount" class="font-bold text-blue-600">0</span></div>
                        <div>é€šçŸ¥è¨Šæ¯ï¼š<span id="infoCount" class="font-bold text-green-600">0</span></div>
                        <div>é‡è¦æé†’ï¼š<span id="importantCount" class="font-bold text-yellow-600">0</span></div>
                        <div>è­¦ç¤ºæé†’ï¼š<span id="warningCount" class="font-bold text-red-600">0</span></div>
                    </div>
                </div>

                <div class="border-t pt-3 mt-3">
                    <h4 class="text-xs font-bold text-gray-600 mb-2">âŒ¨ï¸ å¿«æ·éµ</h4>
                    <div class="text-xs text-gray-600 space-y-1">
                        <div>Ctrl + Sï¼šå„²å­˜</div>
                        <div>Ctrl + Fï¼šæœå°‹</div>
                        <div>Deleteï¼šåˆªé™¤é¸ä¸­</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¾¿åˆ©è²¼å®¹å™¨ -->
        <div id="notesContainer" class="relative w-full" style="padding:150px 20px 50px 20px;">
            <div class="notes-grid" id="notesGrid"><!-- ä¾¿åˆ©è²¼å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ --></div>
        </div>

        <!-- å¯†ç¢¼è¼¸å…¥å½ˆçª— -->
        <div id="passwordModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 shadow-2xl max-w-md w-full mx-4">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ”’ åˆªé™¤é‡è¦æé†’</h2>
                <p class="text-gray-600 mb-4">æ­¤ç‚ºé‡è¦æé†’ï¼Œè«‹è¼¸å…¥å¯†ç¢¼æ‰èƒ½åˆªé™¤ï¼š</p>
                <input id="passwordInput" type="password" placeholder="è¼¸å…¥å¯†ç¢¼"
                    class="w-full border-2 border-gray-300 rounded px-4 py-2 mb-4 focus:outline-none focus:border-yellow-500" />
                <div class="flex gap-3">
                    <button onclick="confirmPasswordDelete()"
                        class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded font-bold transition-colors">ç¢ºèªåˆªé™¤</button>
                    <button onclick="closePasswordModal()"
                        class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded font-bold transition-colors">å–æ¶ˆ</button>
                </div>
                <p class="text-xs text-gray-500 mt-3 text-center">æç¤ºï¼šé è¨­å¯†ç¢¼æ˜¯ 1234</p>
            </div>
        </div>

        <!-- ç·¨è¼¯ä¾¿åˆ©è²¼å½ˆçª— -->
        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 shadow-2xl max-w-2xl w-full mx-4">
                <h2 class="text-xl font-bold mb-4 text-gray-800">âœï¸ ç·¨è¼¯ä¾¿åˆ©è²¼</h2>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">é¸æ“‡é¡è‰²</label>
                    <div class="flex gap-2">
                        <div class="w-8 h-8 bg-blue-200   rounded cursor-pointer border-2 border-gray-300 hover:border-blue-500"
                            onclick="changeNoteColor('bg-blue-200')"></div>
                        <div class="w-8 h-8 bg-green-200  rounded cursor-pointer border-2 border-gray-300 hover:border-green-500"
                            onclick="changeNoteColor('bg-green-200')"></div>
                        <div class="w-8 h-8 bg-yellow-200 rounded cursor-pointer border-2 border-gray-300 hover:border-yellow-500"
                            onclick="changeNoteColor('bg-yellow-200')"></div>
                        <div class="w-8 h-8 bg-red-200    rounded cursor-pointer border-2 border-gray-300 hover:border-red-500"
                            onclick="changeNoteColor('bg-red-200')"></div>
                        <div class="w-8 h-8 bg-purple-200 rounded cursor-pointer border-2 border-gray-300 hover:border-purple-500"
                            onclick="changeNoteColor('bg-purple-200')"></div>
                        <div class="w-8 h-8 bg-pink-200   rounded cursor-pointer border-2 border-gray-300 hover:border-pink-500"
                            onclick="changeNoteColor('bg-pink-200')"></div>
                        <div class="w-8 h-8 bg-orange-200 rounded cursor-pointer border-2 border-gray-300 hover:border-orange-500"
                            onclick="changeNoteColor('bg-orange-200')"></div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
                    <input id="editTags" type="text" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œ, å¾…è¾¦, é‡è¦"
                        class="w-full border-2 border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500" />
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">åˆ°æœŸæ—¥</label>
                    <input id="editDueDate" type="datetime-local"
                        class="w-full border-2 border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-blue-500" />
                </div>
                <div class="flex gap-3">
                    <button onclick="saveEdit()"
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded font-bold transition-colors">å„²å­˜</button>
                    <button onclick="closeEditModal()"
                        class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 rounded font-bold transition-colors">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆå½ˆçª— -->
        <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 shadow-2xl max-w-2xl w-full mx-4">
                <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š çµ±è¨ˆè³‡è¨Š</h2>
                <div id="statsContent" class="space-y-3"></div>
                <button onclick="closeStatsModal()"
                    class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded font-bold transition-colors">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        const levelConfig = {
            normal: { color: 'bg-blue-200', label: 'ä¸€èˆ¬è¨Šæ¯', icon: 'ğŸ”µ', deleteRule: 'direct' },
            important: { color: 'bg-yellow-300', label: 'é‡è¦æé†’', icon: 'âš ï¸', deleteRule: 'password' },
            warning: { color: 'bg-red-300', label: 'è­¦ç¤ºæé†’', icon: 'ğŸš¨', deleteRule: 'doubleConfirm' },
            info: { color: 'bg-green-200', label: 'é€šçŸ¥è¨Šæ¯', icon: 'ğŸŸ¢', deleteRule: 'direct' }
        };

        let notes = [];
        let deleteConfirm = null;
        let noteToDelete = null;
        let deleteConfirmTimeout = null;
        let editingNote = null;
        let resizingNote = null;
        let selectedNote = null;
        let currentlyDraggingId = null;
        let mouseX = 0, mouseY = 0;

        /* ===== äº’å‹•å€åŸŸï¼šåƒ…è² è²¬å·¥å…·åˆ—èˆ‡å´é‚Šæ¬„é¡¯ç¤º ===== */
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX; mouseY = e.clientY;
            handleToolbarVisibility();
            handleSidePanelVisibility();

            // èª¿æ•´å¤§å°
            if (resizingNote) {
                const dx = e.clientX - resizingNote.startX;
                const dy = e.clientY - resizingNote.startY;
                const newW = Math.max(150, (resizingNote.startWidth || 256) + dx);
                const newH = Math.max(150, (resizingNote.startHeight || 256) + dy);
                resizingNote.note.width = newW;
                resizingNote.note.height = newH;
                renderNotes();
            }
        });
        document.addEventListener('mouseup', () => {
            if (resizingNote) { resizingNote = null; saveNotes(); }
        });

        function handleToolbarVisibility() {
            const toolbar = document.getElementById('topToolbar');
            if (mouseY < 80) toolbar.classList.add('visible');
            else if (mouseY > 150) toolbar.classList.remove('visible');
        }
        function handleSidePanelVisibility() {
            const panel = document.getElementById('sidePanel');
            if (mouseX < 80) panel.classList.add('visible');
            else if (mouseX > 340) panel.classList.remove('visible');
        }

        /* ===== è³‡æ–™è¼‰å…¥ï¼å„²å­˜ ===== */
        function loadNotes() {
            const saved = localStorage.getItem('stickyNotes');
            if (saved) {
                notes = JSON.parse(saved);
                // å…¼å®¹èˆŠè³‡æ–™ï¼šè£œä¸Šé è¨­å¯¬é«˜èˆ‡ rotation
                notes.forEach(n => {
                    if (!n.width) n.width = 256;
                    if (!n.height) n.height = 256;
                    if (typeof n.rotation !== 'number') n.rotation = (Math.random() > 0.5 ? 1 : -1);
                });
            } else {
                notes = [
                    { id: 1, content: 'é€™æ˜¯ä¸€èˆ¬è¨Šæ¯\nå¯ä»¥ç›´æ¥åˆªé™¤', level: 'normal', x: 100, y: 50, width: 256, height: 256, color: 'bg-blue-200', tags: ['ç¯„ä¾‹'], dueDate: null, rotation: 1 },
                    { id: 2, content: 'é€™æ˜¯é‡è¦æé†’\néœ€è¦è¼¸å…¥å¯†ç¢¼æ‰èƒ½åˆªé™¤', level: 'important', x: 400, y: 80, width: 256, height: 256, color: 'bg-yellow-300', tags: ['é‡è¦'], dueDate: null, rotation: -1 },
                    { id: 3, content: 'é€™æ˜¯è­¦ç¤ºæé†’\néœ€è¦ç¢ºèªå…©æ¬¡æ‰èƒ½åˆªé™¤', level: 'warning', x: 700, y: 110, width: 256, height: 256, color: 'bg-red-300', tags: ['è­¦ç¤º'], dueDate: null, rotation: 1 }
                ];
            }
            renderNotes();
            updateStats();
            updateTagFilter();
        }
        function saveNotes() {
            localStorage.setItem('stickyNotes', JSON.stringify(notes));
            updateStats();
            updateTagFilter();
        }

        /* ===== UI æ›´æ–° ===== */
        function updateStats() {
            document.getElementById('totalCount').textContent = notes.length;
            document.getElementById('normalCount').textContent = notes.filter(n => n.level === 'normal').length;
            document.getElementById('infoCount').textContent = notes.filter(n => n.level === 'info').length;
            document.getElementById('importantCount').textContent = notes.filter(n => n.level === 'important').length;
            document.getElementById('warningCount').textContent = notes.filter(n => n.level === 'warning').length;
        }
        function updateTagFilter() {
            const allTags = new Set();
            notes.forEach(n => (n.tags || []).forEach(t => allTags.add(t)));
            const select = document.getElementById('filterTag');
            const current = select.value;
            select.innerHTML = '<option value="all">å…¨éƒ¨æ¨™ç±¤</option>';
            [...allTags].forEach(tag => {
                const opt = document.createElement('option');
                opt.value = tag; opt.textContent = tag;
                select.appendChild(opt);
            });
            select.value = current;
        }

        /* ===== æ¸²æŸ“ä¾¿åˆ©è²¼ï¼ˆçµ•å°å®šä½ï¼‰ ===== */
        function renderNotes() {
            const grid = document.getElementById('notesGrid');
            if (!grid) return;

            // ä¿ç•™æ­£åœ¨æ‹–æ›³çš„ DOMï¼ˆé¿å…é–ƒçˆï¼‰
            let draggingEl = null;
            if (currentlyDraggingId) draggingEl = grid.querySelector(`[data-note-id="${currentlyDraggingId}"]`);

            grid.innerHTML = '';

            const term = document.getElementById('searchInput').value.toLowerCase();
            const level = document.getElementById('filterLevel').value;
            const tag = document.getElementById('filterTag').value;

            const filtered = notes.filter(n => {
                const s = n.content.toLowerCase().includes(term);
                const l = level === 'all' || n.level === level;
                const t = tag === 'all' || ((n.tags || []).includes(tag));
                return s && l && t;
            });

            filtered.forEach(note => {
                if (currentlyDraggingId === note.id && draggingEl) {
                    grid.appendChild(draggingEl);
                } else {
                    grid.appendChild(createNoteElement(note));
                }
            });
        }

        function createNoteElement(note) {
            const div = document.createElement('div');
            div.className = `sticky-note ${note.color || levelConfig[note.level].color} p-4`;
            div.dataset.noteId = note.id;

            // çµ•å°å®šä½èˆ‡å°ºå¯¸
            div.style.left = `${note.x}px`;
            div.style.top = `${note.y}px`;
            div.style.width = `${note.width || 256}px`;
            div.style.height = `${note.height || 256}px`;
            // åªç”¨è³‡æ–™è£¡çš„ rotationï¼Œä¸å†æ¯æ¬¡ render éš¨æ©Ÿä»¥å…è¦–è¦ºæ¼‚ç§»
            const rot = (typeof note.rotation === 'number') ? note.rotation : 0;
            div.style.transform = `rotate(${rot}deg)`;

            // åˆ°æœŸæç¤ºï¼ˆé€¾æœŸæ©«å¹…ï¼‰
            if (note.dueDate) {
                const due = new Date(note.dueDate);
                if (due < new Date()) {
                    const overdueLabel = document.createElement('div');
                    overdueLabel.className = 'absolute top-0 left-0 right-0 bg-red-600 text-white text-xs text-center py-1 rounded-t';
                    overdueLabel.textContent = 'â° å·²éæœŸ';
                    div.appendChild(overdueLabel);
                }
            }

            // ç­‰ç´šæ¨™ç±¤
            const label = document.createElement('div');
            label.className = 'absolute top-2 left-2 flex items-center gap-1 bg-white bg-opacity-70 px-2 py-1 rounded text-xs font-bold';
            label.innerHTML = `${levelConfig[note.level].icon} <span>${levelConfig[note.level].label}</span>`;
            div.appendChild(label);

            // å³ä¸Šè§’æŒ‰éˆ•ç¾¤
            const buttons = document.createElement('div');
            buttons.className = 'absolute top-2 right-2 flex gap-1';

            const editBtn = document.createElement('button');
            editBtn.className = 'bg-blue-500 hover:bg-blue-600 text-white rounded-full p-1 opacity-70 hover:opacity-100 transition-all';
            editBtn.innerHTML = 'âš™ï¸';
            editBtn.title = 'ç·¨è¼¯è¨­å®š';
            editBtn.onclick = (e) => { e.stopPropagation(); openEditModal(note); };
            buttons.appendChild(editBtn);

            const delBtn = document.createElement('button');
            delBtn.className = `${deleteConfirm === note.id ? 'bg-red-600 animate-pulse-custom' : 'bg-red-500 hover:bg-red-600'} text-white rounded-full p-1 opacity-70 hover:opacity-100 transition-all`;
            delBtn.innerHTML = 'âœ•';
            delBtn.onclick = (e) => { e.stopPropagation(); handleDeleteAttempt(note); };
            delBtn.title = (levelConfig[note.level].deleteRule === 'password')
                ? 'éœ€è¦å¯†ç¢¼æ‰èƒ½åˆªé™¤'
                : (levelConfig[note.level].deleteRule === 'doubleConfirm')
                    ? (deleteConfirm === note.id ? 'å†é»ä¸€æ¬¡ç¢ºèªåˆªé™¤' : 'é»å…©æ¬¡ç¢ºèªåˆªé™¤')
                    : 'é»æ“Šåˆªé™¤';
            buttons.appendChild(delBtn);

            div.appendChild(buttons);

            // æ¨™ç±¤é¡¯ç¤º
            if (note.tags && note.tags.length > 0) {
                const tagsDiv = document.createElement('div');
                tagsDiv.className = 'absolute top-10 left-2 flex flex-wrap gap-1';
                note.tags.forEach(t => {
                    const s = document.createElement('span');
                    s.className = 'tag-badge';
                    s.textContent = '#' + t;
                    tagsDiv.appendChild(s);
                });
                div.appendChild(tagsDiv);
            }

            // å…§å®¹å€
            const content = document.createElement('div');
            content.className = 'w-full h-full overflow-auto break-words whitespace-pre-wrap text-gray-800 p-2 pt-12 pb-8';
            content.style.fontFamily = 'Comic Sans MS, cursive';
            content.textContent = note.content;
            content.contentEditable = false;
            div.appendChild(content);

            // åˆ°æœŸæ—¥é¡¯ç¤º
            if (note.dueDate) {
                const dueDiv = document.createElement('div');
                dueDiv.className = 'absolute bottom-8 left-2 text-xs text-gray-600 bg-white bg-opacity-70 px-2 py-1 rounded';
                const date = new Date(note.dueDate);
                dueDiv.textContent = `ğŸ“… ${date.toLocaleDateString()} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                div.appendChild(dueDiv);
            }

            // èª¿æ•´å¤§å°æ§åˆ¶é»
            const resizer = document.createElement('div');
            resizer.className = 'resizer';
            resizer.onmousedown = (e) => {
                e.stopPropagation();
                resizingNote = { note, startX: e.clientX, startY: e.clientY, startWidth: note.width, startHeight: note.height };
            };
            div.appendChild(resizer);

            // åœ–é‡˜
            const pin = document.createElement('div');
            pin.className = 'absolute -top-3 left-1/2 transform -translate-x-1/2 w-6 h-6 bg-red-500 rounded-full shadow-md border-2 border-red-600';
            div.appendChild(pin);

            // æ‹–æ›³
            let isDragging = false, startX, startY, initialLeft, initialTop;
            const handleDragStart = (e) => {
                if (e.target.tagName === 'BUTTON' || e.target === resizer) return;
                if (e.target === content && content.contentEditable === 'true') return;
                isDragging = true;
                currentlyDraggingId = note.id;
                startX = e.clientX; startY = e.clientY;
                initialLeft = note.x; initialTop = note.y;
                div.style.cursor = 'grabbing';
                div.style.zIndex = '1000';
                e.preventDefault(); e.stopPropagation();
            };
            const handleDragMove = (e) => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                note.x = Math.max(0, initialLeft + dx);
                note.y = Math.max(0, initialTop + dy);
                div.style.left = note.x + 'px';
                div.style.top = note.y + 'px';
                e.preventDefault();
            };
            const handleDragEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                currentlyDraggingId = null;
                div.style.cursor = 'grab';
                div.style.zIndex = '';
                saveNotes();
            };
            div.addEventListener('mousedown', handleDragStart);
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);

            // é›™æ“Šç·¨è¼¯
            content.ondblclick = (e) => { e.stopPropagation(); content.contentEditable = true; content.focus(); };
            content.onblur = () => { content.contentEditable = false; updateNoteContent(note.id, content.textContent); saveNotes(); };

            return div;
        }

        /* ===== CRUD / ç·¨è¼¯ ===== */
        function addNote(level = 'normal') {
            const newNote = {
                id: Date.now(),
                content: `é€™æ˜¯${levelConfig[level].label}\né›™æ“Šç·¨è¼¯å…§å®¹...\n\nå¯ä»¥èª¿æ•´å¤§å°ã€è¨­å®šæ¨™ç±¤ã€åˆ°æœŸæ—¥ç­‰`,
                level,
                x: Math.random() * (window.innerWidth - 400) + 100,
                y: Math.random() * 500 + 150,
                width: 256, height: 256,
                color: levelConfig[level].color,
                tags: [],
                dueDate: null,
                rotation: (Math.random() > 0.5 ? 1 : -1)    // åªåœ¨å»ºç«‹æ™‚æ±ºå®šä¸€æ¬¡
            };
            notes.push(newNote);
            saveNotes();
            renderNotes();
        }

        function handleDeleteAttempt(note) {
            const rule = levelConfig[note.level].deleteRule;
            if (rule === 'direct') {
                deleteNote(note.id);
            } else if (rule === 'password') {
                noteToDelete = note;
                document.getElementById('passwordModal').classList.remove('hidden');
                const input = document.getElementById('passwordInput');
                input.value = ''; input.focus();
            } else if (rule === 'doubleConfirm') {
                if (deleteConfirm === note.id) {
                    deleteNote(note.id);
                    deleteConfirm = null;
                    if (deleteConfirmTimeout) clearTimeout(deleteConfirmTimeout);
                } else {
                    deleteConfirm = note.id;
                    renderNotes();
                    if (deleteConfirmTimeout) clearTimeout(deleteConfirmTimeout);
                    deleteConfirmTimeout = setTimeout(() => { deleteConfirm = null; renderNotes(); }, 3000);
                }
            }
        }
        function confirmPasswordDelete() {
            const password = document.getElementById('passwordInput').value;
            if (password === '1234') { deleteNote(noteToDelete.id); closePasswordModal(); }
            else alert('å¯†ç¢¼éŒ¯èª¤ï¼æç¤ºï¼šé è¨­å¯†ç¢¼æ˜¯ 1234');
        }
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            noteToDelete = null;
        }
        function deleteNote(id) { notes = notes.filter(n => n.id !== id); saveNotes(); renderNotes(); }
        function updateNoteContent(id, content) { const n = notes.find(x => x.id === id); if (n) n.content = content; }

        function openEditModal(note) {
            editingNote = note;
            document.getElementById('editTags').value = (note.tags || []).join(', ');
            document.getElementById('editDueDate').value = note.dueDate || '';
            document.getElementById('editModal').classList.remove('hidden');
        }
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); editingNote = null; }
        function changeNoteColor(color) { if (editingNote) editingNote.color = color; }
        function saveEdit() {
            if (!editingNote) return;
            const tags = document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(Boolean);
            editingNote.tags = tags;
            editingNote.dueDate = document.getElementById('editDueDate').value || null;
            saveNotes(); renderNotes(); closeEditModal();
        }

        /* ===== æœå°‹èˆ‡ç¯©é¸ ===== */
        document.getElementById('searchInput').addEventListener('input', renderNotes);
        document.getElementById('filterLevel').addEventListener('change', renderNotes);
        document.getElementById('filterTag').addEventListener('change', renderNotes);

        /* ===== çµ±è¨ˆ ===== */
        function showStats() {
            const total = notes.length;
            const byLevel = {
                normal: notes.filter(n => n.level === 'normal').length,
                info: notes.filter(n => n.level === 'info').length,
                important: notes.filter(n => n.level === 'important').length,
                warning: notes.filter(n => n.level === 'warning').length
            };
            const allTags = {};
            notes.forEach(n => (n.tags || []).forEach(t => allTags[t] = (allTags[t] || 0) + 1));
            const overdue = notes.filter(n => n.dueDate && new Date(n.dueDate) < new Date()).length;
            const upcoming = notes.filter(n => n.dueDate && (new Date(n.dueDate) - new Date()) > 0 && (new Date(n.dueDate) - new Date()) < 24 * 60 * 60 * 1000).length;

            const html = `
        <div class="space-y-4">
          <div class="bg-blue-50 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2">ğŸ“Š ç¸½é«”çµ±è¨ˆ</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>ç¸½ä¾¿åˆ©è²¼æ•¸ï¼š<span class="font-bold">${total}</span></div>
              <div>å·²éæœŸï¼š<span class="font-bold text-red-600">${overdue}</span></div>
              <div>24å°æ™‚å…§åˆ°æœŸï¼š<span class="font-bold text-orange-600">${upcoming}</span></div>
            </div>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2">ğŸ“ˆ ç­‰ç´šåˆ†å¸ƒ</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><span>ğŸ”µ ä¸€èˆ¬è¨Šæ¯</span>  <span class="font-bold">${byLevel.normal}    (${pct(byLevel.normal, total)})</span></div>
              <div class="flex justify-between"><span>ğŸŸ¢ é€šçŸ¥è¨Šæ¯</span>  <span class="font-bold">${byLevel.info}      (${pct(byLevel.info, total)})</span></div>
              <div class="flex justify-between"><span>ğŸŸ¡ é‡è¦æé†’</span>  <span class="font-bold">${byLevel.important} (${pct(byLevel.important, total)})</span></div>
              <div class="flex justify-between"><span>ğŸ”´ è­¦ç¤ºæé†’</span>  <span class="font-bold">${byLevel.warning}   (${pct(byLevel.warning, total)})</span></div>
            </div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg">
            <h3 class="font-bold text-lg mb-2">ğŸ·ï¸ æ¨™ç±¤ä½¿ç”¨</h3>
            <div class="flex flex-wrap gap-2">
              ${Object.entries(allTags).map(([tag, count]) =>
                `<span class="bg-purple-200 px-3 py-1 rounded-full text-sm">#${tag} (${count})</span>`
            ).join('') || '<span class="text-gray-500 text-sm">å°šç„¡æ¨™ç±¤</span>'
                }
            </div>
          </div>
        </div>`;
            document.getElementById('statsContent').innerHTML = html;
            document.getElementById('statsModal').classList.remove('hidden');

            function pct(x, t) { return t > 0 ? ((x / t * 100).toFixed(1) + '%') : '0.0%'; }
        }
        function closeStatsModal() { document.getElementById('statsModal').classList.add('hidden'); }

        /* ===== åŒ¯å‡º / åŒ¯å…¥ / æ¸…ç©º ===== */
        function exportNotes() {
            const dataStr = JSON.stringify(notes, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `sticky-notes-${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
            alert('âœ… è³‡æ–™å·²åŒ¯å‡ºï¼');
        }
        function importNotes() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const imported = JSON.parse(ev.target.result);
                        if (!Array.isArray(imported)) throw new Error('æ ¼å¼éŒ¯èª¤');
                        if (confirm(`ç¢ºå®šè¦åŒ¯å…¥ ${imported.length} å€‹ä¾¿åˆ©è²¼å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚`)) {
                            // å…¼å®¹ï¼šè£œé½Šå¿…è¦æ¬„ä½
                            imported.forEach(n => {
                                if (!n.width) n.width = 256;
                                if (!n.height) n.height = 256;
                                if (typeof n.rotation !== 'number') n.rotation = (Math.random() > 0.5 ? 1 : -1);
                                if (!n.color) n.color = levelConfig[n.level]?.color || 'bg-yellow-200';
                            });
                            notes = imported;
                            saveNotes(); renderNotes();
                            alert('âœ… åŒ¯å…¥æˆåŠŸï¼');
                        }
                    } catch (err) { alert('âŒ åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        function clearAllNotes() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ä¾¿åˆ©è²¼å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼') &&
                confirm('ğŸš¨ æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦åˆªé™¤å…¨éƒ¨è³‡æ–™å—ï¼Ÿ')) {
                notes = []; saveNotes(); renderNotes();
                alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰ä¾¿åˆ©è²¼');
            }
        }

        /* ===== å¿«æ·éµèˆ‡å°åŠŸèƒ½ ===== */
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') { e.preventDefault(); saveNotes(); alert('âœ… å·²å„²å­˜ï¼'); }
            if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
            if (e.key === 'Delete' && selectedNote) { handleDeleteAttempt(selectedNote); }
        });
        document.getElementById('passwordInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') confirmPasswordDelete(); });

        /* ===== åˆ°æœŸæé†’ï¼ˆé€šçŸ¥ï¼‰ ===== */
        function checkDueDates() {
            const now = new Date();
            notes.forEach(n => {
                if (!n.dueDate) return;
                const diff = new Date(n.dueDate) - now;
                if (diff > 0 && diff < 5 * 60 * 1000 && !n.reminded) {
                    if (Notification.permission === 'granted') {
                        new Notification('ğŸ“Œ ä¾¿åˆ©è²¼æé†’', { body: `ã€Œ${n.content.substring(0, 30)}...ã€å³å°‡åˆ°æœŸï¼`, icon: 'ğŸ“Œ' });
                    }
                    n.reminded = true; saveNotes();
                }
            });
        }
        if (Notification.permission === 'default') Notification.requestPermission();
        setInterval(checkDueDates, 60000);

        /* ===== åˆå§‹åŒ– ===== */
        document.addEventListener('DOMContentLoaded', () => { loadNotes(); checkDueDates(); });
        if (document.readyState !== 'loading') { loadNotes(); checkDueDates(); }
    </script>
</body>

</html>
