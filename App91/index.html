<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TWSE è™•ç½®è‚¡å¡ç‰‡é¢æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121821;
      --muted: #9bb0c9;
      --accent: #ffd24d;
      --text: #e6edf6;
      --up: #ef4444;
      --down: #22c55e;
      --chip: #1f2a37;
    }
    body{background:var(--bg);color:var(--text);font-family:system-ui;}
    .card{background:var(--card);}
    .chip{background:var(--chip); color:#c7d2fe}
    .ring-soft{box-shadow: 0 0 0 1px rgba(255,255,255,.06), 0 8px 24px rgba(0,0,0,.35);}
    .badge { background: var(--accent); color: #000; }
    .heart-btn { transition: transform .15s ease; }
    .heart-btn:active { transform: scale(.9); }
    .heart-btn.fav { color: #ec4899; }
    .grid-wrap { 
      display:grid; 
      grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); 
      gap: 16px;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
  </style>
</head>
<body>
  <header class="px-4 py-3 sticky top-0 z-10 backdrop-blur bg-black/30 border-b border-white/10">
    <div class="max-w-[1400px] mx-auto flex items-center justify-between">
      <h1 class="text-xl font-semibold">é›†ä¸­å¸‚å ´ï½œå…¬å¸ƒè™•ç½®æœ‰åƒ¹è­‰åˆ¸</h1>
      <div class="flex items-center gap-4">
        <button id="refreshBtn" class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-sm">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
        <div class="text-sm text-gray-300" id="metaInfo">è¼‰å…¥ä¸­â€¦</div>
      </div>
    </div>
  </header>

  <main class="grid-wrap" id="cards"></main>

  <template id="card-tpl">
    <div class="card ring-soft rounded-2xl p-4">
      <div class="flex items-start justify-between gap-3">
        <div class="truncate">
          <div class="text-lg font-bold leading-6 truncate">
            <span class="stock-name">â€”</span>
            <span class="text-gray-400 ml-1 text-base stock-code">â€”</span>
          </div>
          <div class="text-xs text-gray-400 mt-0.5">
            å…¬å¸ƒï¼š<span class="announce-date">â€”</span>
          </div>
        </div>
        <button class="heart-btn text-gray-500 hover:text-pink-400" title="åŠ å…¥æœ€æ„›" data-code="">
          â¤
        </button>
      </div>

      <div class="mt-3 flex items-center gap-2">
        <span class="price text-2xl font-bold">â€”</span>
        <span class="chg text-sm font-semibold">â€”</span>
        <span class="ml-auto badge px-2 py-0.5 rounded-full text-xs font-bold hidden" data-badge="interval"></span>
      </div>

      <p class="text-gray-300 text-sm mt-1 status-line">
        <span class="reason-text">â€”</span>
      </p>

      <div class="text-center mt-2">
        <span class="inline-block badge px-3 py-1 rounded text-xs font-bold countdown-badge">â€”</span>
      </div>

      <div class="border-t border-white/10 my-3"></div>

      <div class="flex items-center gap-1.5 text-xs flex-wrap">
        <span class="chip px-2 py-0.5 rounded" title="èè³‡">è³‡</span>
        <span class="chip px-2 py-0.5 rounded" title="èåˆ¸">åˆ¸</span>
        <span class="chip px-2 py-0.5 rounded" title="ç•¶æ²–">æ²–</span>
        <span class="ml-auto text-gray-400 text-right">
          æˆäº¤å€¼ï¼š<span class="turnover">â€”</span><br>
          é€±è½‰ç‡ï¼š<span class="tratio">â€”</span>
        </span>
      </div>

      <div class="mt-3 text-xs text-gray-400 space-y-1">
        <div><strong>è™•ç½®åŸå› ï¼š</strong><span class="condition">â€”</span></div>
        <div><strong>è™•ç½®æœŸé–“ï¼š</strong><span class="period">â€”</span></div>
        <div><strong>è™•ç½®æªæ–½ï¼š</strong><span class="measure">â€”</span></div>
      </div>
    </div>
  </template>

  <script>
    const PUNISH_API = 'https://cors-proxy.s01yg3642.workers.dev/?url=' +
      encodeURIComponent('https://openapi.twse.com.tw/v1/announcement/punish');

    // ===== æœ¬åœ°å­˜å„²æœ€æ„› =====
    const FAV_KEY = 'twse_fav_stocks';
    const getFavorites = () => JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    const toggleFavorite = (code) => {
      const favs = getFavorites();
      const idx = favs.indexOf(code);
      if (idx > -1) favs.splice(idx, 1);
      else favs.push(code);
      localStorage.setItem(FAV_KEY, JSON.stringify(favs));
      return favs.includes(code);
    };

    // ===== å·¥å…·å‡½å¼ =====
    const rocToAD = (roc) => {
      if (!roc || typeof roc !== 'string') return null;
      const [y,m,d] = roc.split('/').map(v => parseInt(v,10));
      if (!y || !m || !d) return null;
      const yyyy = y + 1911;
      return `${yyyy}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    };

    const daysBetween = (d1, d2) => {
      const ms = (new Date(d2).setHours(0,0,0,0)) - (new Date(d1).setHours(0,0,0,0));
      return Math.round(ms / 86400000);
    };

    const parsePeriod = (periodRaw) => {
      if (!periodRaw || !periodRaw.includes('ï½')) return {start:null,end:null,raw:periodRaw||''};
      const [s,e] = periodRaw.split('ï½').map(s => s.trim());
      return { start: rocToAD(s), end: rocToAD(e), raw: periodRaw };
    };

    const inferIntervalBadge = (measure) => {
      if (!measure) return null;
      const text = String(measure);
      if (text.includes('20') && text.includes('åˆ†é˜')) return '20åˆ†ç›¤';
      if (text.includes('äº”åˆ†é˜') || (text.includes('5') && text.includes('åˆ†é˜'))) return '5åˆ†ç›¤';
      if (/äººå·¥ç®¡åˆ¶|æ’®åˆ/i.test(text)) return 'äººå·¥ç®¡åˆ¶';
      return null;
    };

    const makeCountdownText = (start, end) => {
      if (!start || !end) return 'æœŸé–“æœªæ˜';
      const today = new Date();
      const dStart = new Date(start);
      const dEnd = new Date(end);
      const toStart = daysBetween(today, dStart);
      const toEnd = daysBetween(today, dEnd);

      if (toEnd < 0) return 'âœ… å·²å‡ºé—œ';
      if (toEnd === 0) return 'ğŸ‰ æœ¬æ—¥å‡ºé—œ';
      if (toStart > 0) return `â³ ${toStart} æ—¥å¾Œé–‹å§‹`;
      return `â±ï¸ ${toEnd} æ—¥å¾Œå‡ºé—œ`;
    };

    // ===== æ¨¡æ“¬å³æ™‚è¡Œæƒ…ï¼ˆè«‹æ›¿æ›ç‚ºçœŸå¯¦ APIï¼‰=====
    const fetchMarketData = async (codes) => {
      // é€™è£¡ä½ å¯ä»¥å‘¼å«çœŸå¯¦çš„å°è‚¡ API
      // ä¾‹å¦‚ï¼šhttps://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_2330.tw
      // æˆ–ä½¿ç”¨å…¶ä»–è³‡æ–™ä¾†æº
      
      // ç›®å‰è¿”å›æ¨¡æ“¬æ•¸æ“š
      const mockData = {};
      for (const code of codes) {
        if (Math.random() > 0.3) { // 70% æœ‰æ•¸æ“š
          mockData[code] = {
            price: (Math.random() * 200 + 50).toFixed(2),
            chg: (Math.random() * 10 - 5).toFixed(2),
            chgPct: (Math.random() * 10 - 5).toFixed(2),
            turnover: (Math.random() * 5).toFixed(2) + 'å„„',
            tratio: (Math.random() * 2).toFixed(2) + '%'
          };
        }
      }
      return mockData;
    };

    // ===== ä¸»æµç¨‹ =====
    async function loadData() {
      const meta = document.getElementById('metaInfo');
      const wrap = document.getElementById('cards');
      const tpl = document.getElementById('card-tpl');
      
      wrap.innerHTML = '<div class="col-span-full text-center py-16 loading text-gray-400">è¼‰å…¥ä¸­...</div>';

      let rows = [];
      try {
        const res = await fetch(PUNISH_API, { cache: 'no-store' });
        rows = await res.json();
        if (!Array.isArray(rows)) rows = [];
        meta.textContent = `å…± ${rows.length} æª”ï¼ˆ${new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'})})`;
      } catch (err) {
        console.error(err);
        meta.textContent = 'è¼‰å…¥å¤±æ•—';
        wrap.innerHTML = '<div class="col-span-full text-center py-16 text-red-400">âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦</div>';
        return;
      }

      // æ­£è¦åŒ–æ¬„ä½ï¼ˆAPI å¯¦éš›è¿”å›çš„æ¬„ä½ï¼‰
      const norm = rows.map(x => {
        const announce = x.Date || '';
        const code = String(x.Code || '').trim();
        const name = x.Name || '';
        const reason = x.ReasonsOfDisposition || '';
        const period = x.DispositionPeriod || '';
        const measure = x.DispositionMeasures || '';

        const {start, end, raw} = parsePeriod(period);
        const badge = inferIntervalBadge(measure);
        const cdText = makeCountdownText(start, end);

        // å¾ Date è½‰æ›å…¬å¸ƒæ—¥æœŸ
        let announceAD = '';
        if (announce.length === 7) { // 1141001 æ ¼å¼
          const y = parseInt(announce.substring(0, 3));
          const m = announce.substring(3, 5);
          const d = announce.substring(5, 7);
          announceAD = `${y + 1911}-${m}-${d}`;
        }

        return {
          announce_roc: announce,
          announce_ad: announceAD,
          code, name, reason, period_raw: raw, start, end, measure, 
          intervalBadge: badge, countdownText: cdText
        };
      });

      // ä¾å‡ºé—œæ—¥æ’åº
      norm.sort((a, b) => {
        const aEnd = a.end ? new Date(a.end).getTime() : Infinity;
        const bEnd = b.end ? new Date(b.end).getTime() : Infinity;
        return aEnd - bEnd;
      });

      // ç²å–æ‰€æœ‰è‚¡ç¥¨ä»£ç¢¼çš„è¡Œæƒ…
      const codes = norm.map(r => r.code).filter(Boolean);
      const marketData = await fetchMarketData(codes);
      const favorites = getFavorites();

      // æ¸…ç©ºå®¹å™¨
      wrap.innerHTML = '';

      // ç¹ªè£½å¡ç‰‡
      for (const row of norm) {
        const $ = tpl.content.cloneNode(true);
        
        $.querySelector('.stock-name').textContent = row.name || 'â€”';
        $.querySelector('.stock-code').textContent = row.code || 'â€”';
        $.querySelector('.announce-date').textContent = row.announce_ad || 'â€”';
        $.querySelector('.reason-text').textContent = row.reason || 'â€”';
        $.querySelector('.measure').textContent = row.measure || 'â€”';
        $.querySelector('.period').textContent = row.period_raw || 'â€”';

        // å€’æ•¸èˆ‡å¾½ç« 
        const cb = $.querySelector('.countdown-badge');
        cb.textContent = row.countdownText;
        
        if (row.intervalBadge) {
          const ib = $.querySelector('[data-badge="interval"]');
          ib.textContent = row.intervalBadge;
          ib.classList.remove('hidden');
        }

        // è¡Œæƒ…æ•¸æ“š
        const extra = marketData[row.code] || null;
        const priceEl = $.querySelector('.price');
        const chgEl = $.querySelector('.chg');
        const tEl = $.querySelector('.turnover');
        const rEl = $.querySelector('.tratio');

        if (extra) {
          priceEl.textContent = extra.price;
          tEl.textContent = extra.turnover;
          rEl.textContent = extra.tratio;

          const chgNum = parseFloat(extra.chg);
          const arrow = chgNum >= 0 ? 'â–²' : 'â–¼';
          chgEl.textContent = `${arrow}${Math.abs(chgNum)} (${Math.abs(parseFloat(extra.chgPct)).toFixed(2)}%)`;

          if (chgNum > 0) {
            priceEl.style.color = 'var(--up)';
            chgEl.style.color = 'var(--up)';
          } else if (chgNum < 0) {
            priceEl.style.color = 'var(--down)';
            chgEl.style.color = 'var(--down)';
          }
        } else {
          priceEl.textContent = 'â€”';
          chgEl.textContent = 'ç„¡è¡Œæƒ…';
          tEl.textContent = 'â€”';
          rEl.textContent = 'â€”';
        }

        // æœ€æ„›æŒ‰éˆ•
        const heartBtn = $.querySelector('.heart-btn');
        heartBtn.dataset.code = row.code;
        if (favorites.includes(row.code)) {
          heartBtn.classList.add('fav');
        }

        wrap.appendChild($);
      }

      if (!norm.length) {
        wrap.innerHTML = `
          <div class="col-span-full text-center text-gray-400 py-16">
            ç›®å‰æ²’æœ‰è™•ç½®è‚¡ç¥¨è³‡æ–™
          </div>`;
      }
    }

    // ===== äº‹ä»¶ç›£è½ =====
    document.getElementById('cards').addEventListener('click', (e) => {
      const btn = e.target.closest('.heart-btn');
      if (btn) {
        const code = btn.dataset.code;
        const isFav = toggleFavorite(code);
        btn.classList.toggle('fav', isFav);
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadData();
    });

    // åˆå§‹è¼‰å…¥
    loadData();
  </script>
</body>
</html>