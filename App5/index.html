<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ«ƒè²·ä¸­å¿ƒå€Ÿåˆ¸è²»ç‡ç›£æ§å¹³å°</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{text-align:center;margin-bottom:24px;color:#fff}
    .header h1{font-size:2rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .header p{opacity:.9}
    .update-time{background:rgba(255,255,255,.2);padding:6px 14px;border-radius:20px;display:inline-block;margin-top:10px;backdrop-filter:blur(10px)}
    .controls{background:#fff;padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);margin-bottom:20px;display:flex;gap:10px;justify-content:flex-end}
    button{padding:10px 14px;border:2px solid #e1e5e9;border-radius:8px;font-size:14px;cursor:pointer;transition:.2s}
    .btn-primary{background:#667eea;color:#fff;border-color:#667eea;font-weight:600}
    .btn-primary:hover{background:#5a6fd8;transform:translateY(-1px)}
    .btn-soft{background:#fff;color:#333}
    .table-section{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);overflow:hidden}
    .section-header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:16px 20px;font-weight:600}
    .table-container{max-height:70vh;overflow-y:auto}
    table{width:100%;border-collapse:collapse}
    th{background:#f8f9fa;padding:12px 10px;text-align:left;font-weight:600;color:#666;font-size:12px;letter-spacing:.5px;position:sticky;top:0;z-index:1}
    td{padding:12px 10px;border-bottom:1px solid #eee}
    tr:hover{background:#f8f9ff;cursor:pointer}
    .fee-high{color:#e74c3c;font-weight:600}.fee-medium{color:#f39c12;font-weight:600}.fee-low{color:#27ae60;font-weight:600}
    .alert{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:10px 14px;border-radius:8px;margin:14px 0;display:none}
    .selected-row{background:#e3f2fd!important;border-left:4px solid #667eea}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px}
    .stat{background:#fff;border-radius:12px;padding:16px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .stat .v{font-size:1.4rem;font-weight:700}
    @media (max-width:768px){.stats{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š æ«ƒè²·ä¸­å¿ƒå€Ÿåˆ¸è²»ç‡ç›£æ§å¹³å°</h1>
      <p>åƒ…é¡¯ç¤º API å›å‚³è³‡æ–™ï¼ˆç„¡ç¯©é¸/æœå°‹ï¼‰</p>
      <div class="update-time" id="lastUpdate">æœ€å¾Œæ›´æ–°ï¼šâ€”</div>
    </div>

    <div class="controls">
      <button id="btnRefresh" class="btn-primary">ğŸ”„ æ›´æ–°è³‡æ–™</button>
      <button id="btnExport" class="btn-soft">ğŸ’¾ åŒ¯å‡º CSV</button>
    </div>

    <div id="alertMsg" class="alert"></div>

    <div class="table-section">
      <div class="section-header">
        å€Ÿåˆ¸è²»ç‡ç¸½è¦½ï¼ˆ<span id="totalCount">0</span> ç­†ï¼‰
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:110px">è­‰åˆ¸ä»£è™Ÿ</th>
              <th>è­‰åˆ¸åç¨±</th>
              <th style="width:130px">å€Ÿåˆ¸è²»ç‡(%)</th>
              <th style="width:160px">å¯å€Ÿåˆ¸å¼µæ•¸</th>
              <th style="width:160px">æ›´æ–°æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="5" style="text-align:center;color:#666;padding:24px">è¼‰å…¥è³‡æ–™ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="stats">
      <div class="stat"><div class="v" id="statTotal">-</div><div>è‚¡ç¥¨æ•¸</div></div>
      <div class="stat"><div class="v" id="statMin">-</div><div>æœ€ä½è²»ç‡</div></div>
      <div class="stat"><div class="v" id="statMax">-</div><div>æœ€é«˜è²»ç‡</div></div>
      <div class="stat"><div class="v" id="statAvg">-</div><div>å¹³å‡è²»ç‡</div></div>
    </div>
  </div>

  <script>
    // ===== å…¨åŸŸç‹€æ…‹ =====
    let allData = [];
    let selectedStock = null;

    // ===== å°å·¥å…· =====
    const twNum = new Intl.NumberFormat('zh-TW');
    const showAlert = (msg, type='info') => {
      const el = document.getElementById('alertMsg');
      el.textContent = msg;
      el.style.display = 'block';
      el.style.background = type==='success' ? '#e8f5e9' : (type==='warning' ? '#fff3cd' : '#fff3cd');
      el.style.borderColor = type==='success' ? '#a5d6a7' : '#ffeaa7';
      setTimeout(()=> el.style.display='none', 2500);
    };
    const updateClock = () => {
      const s = new Date().toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
      document.getElementById('lastUpdate').textContent = `æœ€å¾Œæ›´æ–°ï¼š${s}`;
    };
    const getFeeClass = f => f>2 ? 'fee-high' : f>1 ? 'fee-medium' : 'fee-low';

    // ===== APIï¼šå¯å€Ÿåˆ¸ï¼ˆTWSE TWT96Uï¼‰=====
    async function fetchAvailableShares() {
      const url = 'https://openapi.twse.com.tw/v1/SBL/TWT96U';
      try {
        const res = await fetch(url, { cache:'no-store' });
        if (!res.ok) throw new Error(`TWT96U HTTP ${res.status}`);
        const data = await res.json();
        // ä¸åŒç‰ˆæœ¬æ¬„ä½åç¨±å¯èƒ½ä¸åŒï¼Œåšå¥å£¯æ˜ å°„
        const K = (o, keys) => keys.find(k => k in o);
        const map = new Map();
        for (const row of data) {
          const codeKey = K(row, ['Code','è­‰åˆ¸ä»£è™Ÿ','SecurityCode']);
          const nameKey = K(row, ['Name','è­‰åˆ¸åç¨±','SecurityName']);
          const volKey  = K(row, ['ç•¶æ—¥å¯å€Ÿåˆ¸è³£å‡ºæ•¸é‡','Current Day Available Volume for SBL Short Sales','available_volume','æœ¬æ—¥å¯å€Ÿåˆ¸è³£å‡ºé™é¡']);
          if (!codeKey || !volKey) continue;
          const code = String(row[codeKey]).trim();
          const name = (row[nameKey] ?? '').trim();
          const vol  = Number(String(row[volKey]).replace(/,/g,'')) || 0;
          map.set(code, { code, name, availableShares: vol });
        }
        return map;
      } catch (e) {
        console.error(e);
        // å‚™æ´ï¼šå…¬é–‹ä»£ç†ï¼ˆåƒ…æ¸¬è©¦ç”¨ï¼‰
        const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://openapi.twse.com.tw/v1/SBL/TWT96U');
        const res2 = await fetch(proxy);
        if (!res2.ok) throw new Error('TWT96U proxy failed');
        const data = await res2.json();
        const K = (o, keys) => keys.find(k => k in o);
        const map = new Map();
        for (const row of data) {
          const codeKey = K(row, ['Code','è­‰åˆ¸ä»£è™Ÿ','SecurityCode']);
          const nameKey = K(row, ['Name','è­‰åˆ¸åç¨±','SecurityName']);
          const volKey  = K(row, ['ç•¶æ—¥å¯å€Ÿåˆ¸è³£å‡ºæ•¸é‡','Current Day Available Volume for SBL Short Sales','available_volume','æœ¬æ—¥å¯å€Ÿåˆ¸è³£å‡ºé™é¡']);
          if (!codeKey || !volKey) continue;
          const code = String(row[codeKey]).trim();
          const name = (row[nameKey] ?? '').trim();
          const vol  = Number(String(row[volKey]).replace(/,/g,'')) || 0;
          map.set(code, { code, name, availableShares: vol });
        }
        return map;
      }
    }

    // ===== APIï¼šæ¨™å€Ÿè²»ç‡ï¼ˆFinMind TaiwanStockSecuritiesLendingï¼‰=====
    async function fetchBorrowFees() {
      const base = 'https://api.finmindtrade.com/api/v4/data';
      // å˜—è©¦æœ€è¿‘ 0~7 å¤©ï¼ˆé‡å‡æ—¥å¾€å‰æ‰¾ï¼‰
      for (let i = 0; i < 8; i++) {
        const d = new Date(); d.setDate(d.getDate() - i);
        const date = d.toISOString().slice(0,10);
        try {
          const url = `${base}?dataset=TaiwanStockSecuritiesLending&date=${date}`;
          const r = await fetch(url, { cache:'no-store' });
          if (!r.ok) continue;
          const j = await r.json();
          const rows = Array.isArray(j.data) ? j.data : (Array.isArray(j.Data) ? j.Data : []);
          if (!rows.length) continue;

          // ä»¥æˆäº¤é‡åŠ æ¬Šå¹³å‡è²»ç‡
          const K = (o, keys) => keys.find(k => k in o);
          const byCode = new Map();
          for (const row of rows) {
            const codeKey = K(row, ['stock_id','code']);
            const feeKey  = K(row, ['fee_rate','rate','sbl_rate']);
            const volKey  = K(row, ['volume','deal_volume','qty','quantity','trade_volume']);
            if (!codeKey || !feeKey) continue;
            const code = String(row[codeKey]).trim();
            const fee  = Number(row[feeKey]);
            const vol  = Number(row[volKey] ?? 1) || 1;
            if (!byCode.has(code)) byCode.set(code, { wFee:0, w:0, date });
            const acc = byCode.get(code);
            acc.wFee += fee * vol;
            acc.w += vol;
          }
          const map = new Map();
          for (const [code, v] of byCode) {
            map.set(code, { fee: Number((v.w ? v.wFee / v.w : 0).toFixed(3)), date: v.date });
          }
          return map; // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰è³‡æ–™çš„æ—¥å­å³å›å‚³
        } catch (e) {
          console.warn('fee try failed', e);
        }
      }
      return new Map();
    }

    // ===== è³‡æ–™æ•´ä½µ & é¡¯ç¤º =====
    async function loadData() {
      try {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;padding:24px">è¼‰å…¥è³‡æ–™ä¸­â€¦</td></tr>`;
        const [availMap, feeMap] = await Promise.all([fetchAvailableShares(), fetchBorrowFees()]);
        const codes = new Set([...availMap.keys(), ...feeMap.keys()]);

        const rows = [];
        let feeDateUsed = null;
        for (const code of codes) {
          const a = availMap.get(code) || { code, name:'', availableShares:0 };
          const f = feeMap.get(code) || null;
          if (f && !feeDateUsed) feeDateUsed = f.date;
          rows.push({
            code,
            name: a.name || '',
            borrowFee: f ? f.fee : null,
            availableShares: a.availableShares || 0,
            updateTime: (f?.date || new Date().toISOString().slice(0,10)) + ' 00:00'
          });
        }

        // åªé¡¯ç¤º API åŸå§‹è³‡æ–™ï¼ˆä¸åšä»»ä½•ç¯©é¸/æœå°‹ï¼‰
        // é€™é‚Šç‚ºäº†ç©©å®šè§€çœ‹ï¼Œä»åšã€Œä¾ä»£è™Ÿæ’åºã€ï¼›è‹¥ä½ è¦å®Œå…¨ä¿æŒä¾†æºé †åºï¼Œç§»é™¤ä¸‹ä¸€è¡Œå³å¯ã€‚
        rows.sort((a,b)=> a.code.localeCompare(b.code, 'zh-Hant'));

        allData = rows;
        renderTable(allData);
        updateStats(allData);
        updateClock();

        const nFee = allData.filter(x=>x.borrowFee!=null).length;
        showAlert(`è³‡æ–™è¼‰å…¥æˆåŠŸï¼ˆå…± ${allData.length} æª”ï¼›æœ‰è²»ç‡ ${nFee} æª”ï¼‰`, 'success');
      } catch (e) {
        console.error(e);
        showAlert('è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦æˆ–æª¢æŸ¥ç¶²è·¯/CORS è¨­å®š', 'warning');
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="5" style="text-align:center;color:#c00;padding:24px">è¼‰å…¥å¤±æ•—</td></tr>`;
      }
    }

    function renderTable(rows) {
      const tbody = document.getElementById('tableBody');
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#666;padding:24px">æ²’æœ‰è³‡æ–™</td></tr>`;
        return;
      }
      tbody.innerHTML = rows.map(it => `
        <tr onclick="selectStock('${it.code}')" ${selectedStock && selectedStock.code===it.code ? 'class="selected-row"' : ''}>
          <td>${it.code}</td>
          <td>${it.name || '-'}</td>
          <td>${it.borrowFee!=null ? `<span class="${getFeeClass(it.borrowFee)}">${it.borrowFee}</span>` : '-'}</td>
          <td>${twNum.format(Math.round((it.availableShares||0)/1000))} å¼µ</td>
          <td>${it.updateTime}</td>
        </tr>
      `).join('');
      document.getElementById('totalCount').textContent = rows.length;
    }

    function updateStats(rows) {
      const fees = rows.map(r=>r.borrowFee).filter(v=>v!=null && !Number.isNaN(v));
      const min = fees.length ? Math.min(...fees) : null;
      const max = fees.length ? Math.max(...fees) : null;
      const avg = fees.length ? fees.reduce((s,v)=>s+v,0)/fees.length : null;
      document.getElementById('statTotal').textContent = rows.length;
      document.getElementById('statMin').textContent = min!=null ? min.toFixed(2)+'%' : '-';
      document.getElementById('statMax').textContent = max!=null ? max.toFixed(2)+'%' : '-';
      document.getElementById('statAvg').textContent = avg!=null ? avg.toFixed(2)+'%' : '-';
    }

    // ä¿ç•™å¯é¸åˆ—é«˜äº®ï¼ˆä¸å½±éŸ¿è³‡æ–™ä¾†æºï¼‰
    function selectStock(code) {
      selectedStock = allData.find(x => x.code === code) || null;
      renderTable(allData);
      if (selectedStock) showAlert(`å·²é¸ä¸­ï¼š${selectedStock.name || ''}ï¼ˆ${selectedStock.code}ï¼‰`);
    }
    window.selectStock = selectStock;

    // åŒ¯å‡º
    function exportCSV() {
      const headers = ['è­‰åˆ¸ä»£è™Ÿ','è­‰åˆ¸åç¨±','å€Ÿåˆ¸è²»ç‡(%)','å¯å€Ÿåˆ¸å¼µæ•¸','æ›´æ–°æ™‚é–“'];
      const csv = [
        headers.join(','),
        ...allData.map(it => [
          it.code,
          `"${it.name ?? ''}"`,
          it.borrowFee ?? '',
          it.availableShares ?? 0,
          `"${it.updateTime ?? ''}"`
        ].join(','))
      ].join('\n');
      const blob = new Blob(['\uFEFF'+csv], { type:'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `å€Ÿåˆ¸è²»ç‡_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click(); a.remove();
      showAlert('CSV æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
    }

    // ç¶å®š
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnRefresh').addEventListener('click', loadData);
      document.getElementById('btnExport').addEventListener('click', exportCSV);
      loadData(); // é¦–æ¬¡è¼‰å…¥
    });
  </script>
</body>
</html>
