<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ‡‰ä»˜ç¾è‚¡ç•¶æ²–åˆ¸å·®å€Ÿåˆ¸è²»ç‡ï¼ˆTWSE + TPEx åˆä½µï¼‰</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
           background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; color: #fff; margin-bottom: 16px; }
    .header h1 { font-size: 1.9rem; text-shadow: 2px 2px 4px rgba(0,0,0,.3); }
    .header p { opacity: .9; margin-top: 6px; }
    .update-time { display: inline-block; margin-top: 10px; padding: 6px 14px; border-radius: 20px;
                   background: rgba(255,255,255,.2); backdrop-filter: blur(10px); }
    .controls { display: flex; gap: 10px; justify-content: flex-end; margin: 14px 0; }
    button { padding: 10px 14px; font-size: 14px; border-radius: 8px; cursor: pointer; border: 2px solid #e1e5e9; transition: .2s; }
    .btn-primary { background: #667eea; color: #fff; border-color: #667eea; font-weight: 600; }
    .btn-primary:hover { background: #5a6fd8; transform: translateY(-1px); }
    .btn-soft { background: #fff; color: #333; }
    .alert { display: none; margin: 12px 0; padding: 10px 14px; border-radius: 8px; border: 1px solid #ffeaa7; background: #fff3cd; color: #856404; }
    .card { display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; margin: 10px 0 14px; }
    .kpi { background: #fff; border-radius: 12px; padding: 14px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .kpi .v { font-size: 1.4rem; font-weight: 700; }
    .table-section { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: hidden; }
    .section-header { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; padding: 14px 16px; font-weight: 600; }
    .table-container { max-height: 70vh; overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { position: sticky; top: 0; background: #f8f9fa; color: #666; font-size: 12px; letter-spacing: .5px;
         text-align: left; padding: 12px 10px; z-index: 1; }
    td { padding: 12px 10px; border-bottom: 1px solid #eee; }
    tr:hover { background: #f8f9ff; }
    .src { font-size: 12px; color: #666; }
    @media (max-width: 768px) { .header h1 { font-size: 1.6rem; } .card { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š æ‡‰ä»˜ç¾è‚¡ç•¶æ—¥æ²–éŠ·åˆ¸å·®å€Ÿåˆ¸è²»ç‡ï¼ˆåˆä½µï¼šTWSE + TPExï¼‰</h1>
      <p>ç›´æ¥è§£æå…©ç«™ã€Œç•¶æœˆã€HTML è¡¨æ ¼ä¸¦åˆä½µé¡¯ç¤ºï¼›ç„¡ç¯©é¸/æœå°‹</p>
      <div class="update-time" id="lastUpdate">æœ€å¾Œæ›´æ–°ï¼šâ€”</div>
    </div>

    <div class="controls">
      <button id="btnRefresh" class="btn-primary">ğŸ”„ æ›´æ–°è³‡æ–™</button>
      <button id="btnExport" class="btn-soft">ğŸ’¾ åŒ¯å‡º CSV</button>
    </div>

    <div id="alertMsg" class="alert"></div>

    <div class="card">
      <div class="kpi"><div class="v" id="kpiRows">-</div><div>ç¸½ç­†æ•¸</div></div>
      <div class="kpi"><div class="v" id="kpiCodes">-</div><div>æ¶µè“‹ä»£è™Ÿæ•¸</div></div>
    </div>

    <div class="table-section">
      <div class="section-header">
        åˆä½µç¸½è¦½ï¼ˆ<span id="totalCount">0</span> ç­†ï¼‰
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:120px">åˆ¸å·®æ—¥æœŸ</th>
              <th style="width:90px">ä¾†æº</th>
              <th style="width:110px">è­‰åˆ¸ä»£è™Ÿ</th>
              <th>è­‰åˆ¸åç¨±</th>
              <th style="width:160px">å€Ÿåˆ¸è‚¡æ•¸(è‚¡)</th>
              <th style="width:160px">å€Ÿåˆ¸è²»ç‡(%)</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="6" style="text-align:center;color:#666;padding:24px">è¼‰å…¥ç•¶æœˆè³‡æ–™ä¸­â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== å°å·¥å…· =====
    const nf = new Intl.NumberFormat('zh-TW');
    const alertEl = document.getElementById('alertMsg');
    const showAlert = (msg, type='info') => {
      alertEl.textContent = msg;
      alertEl.style.display = 'block';
      alertEl.style.background = type==='success' ? '#e8f5e9' : '#fff3cd';
      alertEl.style.borderColor = type==='success' ? '#a5d6a7' : '#ffeaa7';
      setTimeout(()=> alertEl.style.display = 'none', 2500);
    };
    const updateClock = () => {
      document.getElementById('lastUpdate').textContent =
        'æœ€å¾Œæ›´æ–°ï¼š' + new Date().toLocaleString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    };
    const toNum = v => Number(String(v ?? '').replace(/[,%\s,]/g,'').trim()) || 0;
    const trim = s => String(s ?? '').trim();

    // ===== å…©ç«™ URLï¼ˆç•¶æœˆ HTMLï¼‰=====
    const URL_TPEX = 'https://www.tpex.org.tw/www/zh-tw/intraday/fee?id=&response=html';
    const URL_TWSE = 'https://www.twse.com.tw/rwd/zh/dayTrading/BFIF8U?response=html';

    // CORSï¼šå…ˆç›´æ¥å–ï¼Œå¤±æ•—å†ç”¨ alloriginsï¼ˆåƒ…é–‹ç™¼æ¸¬è©¦ï¼‰
    async function fetchHTML(url) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.text();
      } catch (e) {
        const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
        const r2 = await fetch(proxy, { cache: 'no-store' });
        if (!r2.ok) throw new Error(`Proxy HTTP ${r2.status}`);
        return await r2.text();
      }
    }

    // è§£æï¼šæ‰¾å«ã€Œåˆ¸å·®æ—¥æœŸã€è¡¨é ­çš„ç¬¬ä¸€å€‹è¡¨æ ¼
    function parseFeeTable(htmlText, source) {
      const doc = new DOMParser().parseFromString(htmlText, 'text/html');
      const tables = Array.from(doc.querySelectorAll('table'));
      let target = null, headers = [];

      for (const t of tables) {
        const ths = Array.from(t.querySelectorAll('thead tr th, tr th')).map(th => trim(th.textContent));
        if (ths.join(',').includes('åˆ¸å·®æ—¥æœŸ') && ths.some(h => /å€Ÿåˆ¸[è‚¡|æ•¸]|å€Ÿåˆ¸è‚¡æ•¸|æŠ•è³‡äººå€Ÿåˆ¸è‚¡æ•¸/.test(h))) {
          target = t; headers = ths; break;
        }
      }
      if (!target) return [];

      const idx = (regex) => headers.findIndex(h => regex.test(h));
      const iDate = idx(/åˆ¸å·®æ—¥æœŸ/);
      const iCode = idx(/è­‰åˆ¸ä»£è™Ÿ/);
      const iName = idx(/è­‰åˆ¸åç¨±/);
      const iQty  = idx(/å€Ÿåˆ¸è‚¡æ•¸|æŠ•è³‡äººå€Ÿåˆ¸è‚¡æ•¸/);
      const iFee  = idx(/å€Ÿåˆ¸è²»ç‡|æŠ•è³‡äººå€Ÿåˆ¸è²»ç‡/);

      const rows = [];
      const trs = Array.from(target.querySelectorAll('tbody tr')).length
        ? Array.from(target.querySelectorAll('tbody tr'))
        : Array.from(target.querySelectorAll('tr')).slice(1); // æœ‰äº›é é¢æ²’æœ‰ <thead>/<tbody> åˆ†é›¢

      for (const tr of trs) {
        const tds = Array.from(tr.children).map(td => trim(td.textContent));
        if (!tds.length) continue;
        const code = tds[iCode] || '';
        if (/èªªæ˜|åˆè¨ˆ|ç¸½ç­†æ•¸/.test(code)) continue; // è·³éèªªæ˜åˆ—
        const date = tds[iDate] || '';
        const name = tds[iName] || '';
        const qty  = toNum(tds[iQty]);
        // å¯èƒ½å«ç™¾åˆ†æ¯”ç¬¦è™Ÿ
        const fee  = String(tds[iFee] ?? '').replace('%','').trim();
        const feeNum = fee === '' ? null : Number(fee);

        // è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥ï¼šæœ‰ä»£è™Ÿä¸”æœ‰æ—¥æœŸæ‰ç®—
        if (!code || !date) continue;
        rows.push({ date, source, code, name, qty, fee: feeNum });
      }
      return rows;
    }

    // æŠ“å…©ç«™ä¸¦åˆä½µ
    async function loadData() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666;padding:24px">è¼‰å…¥ç•¶æœˆè³‡æ–™ä¸­â€¦</td></tr>`;

      try {
        const [tpexHTML, twseHTML] = await Promise.all([
          fetchHTML(URL_TPEX),
          fetchHTML(URL_TWSE),
        ]);

        const tpexRows = parseFeeTable(tpexHTML, 'TPEx');
        const twseRows = parseFeeTable(twseHTML, 'TWSE');

        // åˆä½µ
        let rows = [...tpexRows, ...twseRows];

        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#c00;padding:24px">ç•¶æœˆæŸ¥ç„¡è³‡æ–™ï¼ˆæˆ–å°šæœªå…¬å¸ƒï¼‰ã€‚</td></tr>`;
          document.getElementById('totalCount').textContent = '0';
          document.getElementById('kpiRows').textContent = '0';
          document.getElementById('kpiCodes').textContent = '0';
          updateClock();
          return;
        }

        // ä¾æ—¥æœŸ(æ–°â†’èˆŠ)ã€ä¾†æºã€ä»£è™Ÿæ’åºï¼ˆROC å¹´æœˆæ—¥å­—ä¸²ä¹Ÿèƒ½å­—å…¸æ’åºï¼‰
        rows.sort((a,b) => (
          b.date.localeCompare(a.date) ||
          a.source.localeCompare(b.source) ||
          a.code.localeCompare(b.code, 'zh-Hant')
        ));

        // æ¸²æŸ“
        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.date}</td>
            <td class="src">${r.source}</td>
            <td>${r.code}</td>
            <td>${r.name || '-'}</td>
            <td>${nf.format(r.qty)}</td>
            <td>${r.fee != null ? r.fee + '%' : '-'}</td>
          </tr>
        `).join('');

        // KPI
        document.getElementById('totalCount').textContent = rows.length;
        document.getElementById('kpiRows').textContent = rows.length;
        document.getElementById('kpiCodes').textContent = new Set(rows.map(r=>r.code)).size;

        updateClock();
        showAlert(`è¼‰å…¥æˆåŠŸï¼ˆTWSE ${twseRows.length} ç­†ï¼ŒTPEx ${tpexRows.length} ç­†ï¼›åˆè¨ˆ ${rows.length}ï¼‰`, 'success');
        window.__ROWS__ = rows; // åŒ¯å‡ºç”¨
      } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#c00;padding:24px">è¼‰å…¥å¤±æ•—</td></tr>`;
      }
    }

    // åŒ¯å‡ºç›®å‰è¡¨æ ¼ç‚º CSV
    function exportCSV() {
      const rows = window.__ROWS__ || [];
      const header = ['åˆ¸å·®æ—¥æœŸ','ä¾†æº','è­‰åˆ¸ä»£è™Ÿ','è­‰åˆ¸åç¨±','å€Ÿåˆ¸è‚¡æ•¸(è‚¡)','å€Ÿåˆ¸è²»ç‡(%)'].join(',');
      const csvRows = rows.map(r => [
        r.date, r.source, r.code,
        `"${(r.name || '').replace(/"/g,'""')}"`,
        r.qty, (r.fee != null ? r.fee : '')
      ].join(','));
      const csv = [header, ...csvRows].join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ç•¶æ²–åˆ¸å·®_åˆä½µ_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      showAlert('CSV æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
    }

    // ç¶å®šèˆ‡å•Ÿå‹•
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnRefresh').addEventListener('click', loadData);
      document.getElementById('btnExport').addEventListener('click', exportCSV);
      loadData();
    });
  </script>
</body>
</html>
