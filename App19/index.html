<!doctype html>

<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>採購資料庫 · PWA（管理分頁版 + 採購車）</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <style>
    :root{--radius:12px;--border:#e5e7eb;--muted:#6b7280;--bg:#fafafa;--primary:#111}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    h1{font-size:1.25rem;margin:8px 0 6px}
    .sub{color:var(--muted);margin:0 0 12px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:12px;align-items:center}
    .tab{padding:10px 14px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button{padding:10px;border:1px solid var(--border);border-radius:10px}
    input{flex:1;min-width:120px}
    button{cursor:pointer;background:var(--primary);color:#fff}
    button.secondary{background:#fff;color:#111}
    button.ghost{background:transparent;color:#111;border-color:transparent}
    button[disabled]{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    tr:hover{background:#f7f7f7}
    .actions button{padding:6px 10px;font-size:.9rem}
    .muted{color:var(--muted);font-size:.92rem}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.85rem;color:#333;background:#fafafa}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:999px;border:1px solid var(--border);font-size:.85rem;background:#fff}
    .badge.readonly{background:#fff}
    .badge.admin{background:#eefbf1;border-color:#b7ebc6}
    .hidden{display:none !important}
    dialog{border:none;border-radius:16px;padding:0;width:min(90vw,420px)}
    .dlg{padding:18px}
    .dlg h3{margin:0 0 10px}
    .dlg .row{margin-top:8px}
    .dlg footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .overlay::backdrop{background:rgba(0,0,0,.4)}
    /* 採購分頁：左右欄 */
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid{grid-template-columns:1.3fr .9fr} }
    .num{width:96px;text-align:right}
    .qty{width:84px;text-align:right}
    .tot{font-weight:600}
    .no-wrap{white-space:nowrap}
    /* iOS 安裝提示卡 */
    #iosTip{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 16px;max-width:90%;box-shadow:0 4px 10px rgba(0,0,0,.15);z-index:9999;font-size:.9rem;}
    #iosTip button{margin-left:8px;padding:4px 8px;border-radius:8px;border:1px solid var(--border);background:#f0f0f0;color:#111;cursor:pointer}
      /* iOS 安裝提示小條 */
    .banner{display:flex;gap:10px;align-items:center;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:#fffef5}
    .banner small{color:#8a6d3b}
  </style>
  <!-- iOS PWA meta（啟動畫面與圖示支援） -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
<div class="wrap">
  <!-- iOS 安裝提示（可關閉，關閉後不再顯示） -->
  <div id="iosTip" class="banner hidden" role="status" aria-live="polite">
    <div>📲 iPhone/iPad：請點右上「分享」→ <b>加入主畫面</b> 以安裝 App。</div>
    <span class="right"></span>
    <button id="installBtn" class="secondary hidden">安裝 App</button>
    <button id="iosTipClose" class="secondary">不再顯示</button>
  </div>
  <h1>採購資料庫</h1>
  <p class="sub">PWA 單機可安裝版。未登入＝唯讀；登入後可編輯與使用管理分頁。預設 PIN：<span class="tag">0000</span>。</p>  <div class="tabs">
    <button class="tab" data-tab="data">📄 資料</button>
    <button class="tab" data-tab="cart">🧺 採購</button>
    <button class="tab hidden" data-tab="admin" id="adminTab">🛠 管理</button>
    <span class="right"></span>
    <button id="installBtn" class="secondary hidden">安裝 App</button>
    <span id="modeBadge" class="badge readonly">🔒 唯讀模式</span>
    <button id="loginBtn" class="secondary">管理者登入</button>
    <button id="logoutBtn" class="secondary hidden">登出</button>
  </div>  <!-- iOS 提示卡 -->  <div id="iosTip" class="hidden">
    📱 在 Safari 中，點擊「分享」 → 「加入主畫面」即可安裝。
    <button id="closeIosTip">知道了</button>
  </div>  <!-- 其餘內容維持不變 -->...

<script>
// ---- PWA: register SW ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}

// ---- PWA 安裝提示 & iOS 導引 ----
const installBtn = document.querySelector('#installBtn');
const iosTip = document.querySelector('#iosTip');
const iosTipClose = document.querySelector('#iosTipClose');
let deferredPrompt = null;

// 可安裝事件（Android/Chrome）
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn?.classList.remove('hidden');
});

installBtn?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  installBtn.disabled = true;
  try {
    await deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') installBtn.classList.add('hidden');
    else installBtn.disabled = false;
  } finally { deferredPrompt = null; }
});

// 安裝完成
window.addEventListener('appinstalled', () => {
  installBtn?.classList.add('hidden');
});

// iOS/Safari 偵測
function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); }
function isStandalone(){ return window.matchMedia && window.matchMedia('(display-mode: standalone)').matches; }

(function showIOSTipOnce(){
  try{
    const dismissed = localStorage.getItem('installTipDismissed') === '1';
    if (isIOS() && !isStandalone() && !dismissed) {
      iosTip?.classList.remove('hidden');
    }
  }catch{}
})();

iosTipClose?.addEventListener('click', ()=>{
  iosTip?.classList.add('hidden');
  try{ localStorage.setItem('installTipDismissed','1'); }catch{}
}););
}

// PWA 安裝提示
const installBtn = document.querySelector('#installBtn');
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.remove('hidden');
});

installBtn?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  installBtn.disabled = true;
  try {
    await deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      installBtn.classList.add('hidden');
    } else {
      installBtn.disabled = false;
    }
  } finally {
    deferredPrompt = null;
  }
});

window.addEventListener('appinstalled', () => {
  installBtn?.classList.add('hidden');
  localStorage.setItem('pwa-installed','1');
});

// iOS 檢測
function isIos(){ return /iphone|ipad|ipod/i.test(window.navigator.userAgent); }
function isInStandaloneMode(){ return ('standalone' in window.navigator) && window.navigator.standalone; }
if(isIos() && !isInStandaloneMode() && !localStorage.getItem('iosTipClosed')){
  document.querySelector('#iosTip').classList.remove('hidden');
}

document.querySelector('#closeIosTip')?.addEventListener('click', ()=>{
  document.querySelector('#iosTip').classList.add('hidden');
  localStorage.setItem('iosTipClosed','1');
});
</script></body>
</html>
