<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¢å¼·ç‰ˆå“¡å·¥ç­è¡¨ç®¡ç†ç³»çµ±ï¼ˆé›²ç«¯ï¼‹å‡æ—¥ï¼‹å·¥æ™‚ï¼‹ç­åˆ¥CRUDï¼‰</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:'Microsoft YaHei','Arial',sans-serif;margin:0;padding:10px;background:#f8f9fa;min-height:100vh}
    .container{max-width:1200px;min-width:380px;margin:0 auto;background:#fff;border-radius:15px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .header{text-align:center;margin-bottom:20px;position:relative}
    .header h1{color:#333;font-size:2.2rem;margin:0 0 10px;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .role-switcher{position:absolute;top:0;right:0;display:flex;align-items:center;gap:10px;background:#f8f9fa;padding:8px 12px;border-radius:20px;border:2px solid #667eea}
    .role-badge{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;padding:4px 12px;border-radius:15px;font-size:.8rem;font-weight:600}
    .role-badge.employee{background:linear-gradient(45deg,#28a745,#20c997)}
    .admin-only{display:none}
    .admin-mode .admin-only{display:inline-block}
    .nav-tabs{display:flex;background:#f8f9fa;border-radius:10px;padding:5px;margin-bottom:20px;gap:5px}
    .nav-tab{flex:1;padding:10px;background:transparent;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:.2s}
    .nav-tab.active{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .schedule-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:14px;color:#fff;box-shadow:0 4px 15px rgba(102,126,234,.3)}
    .schedule-header h3{margin:0;font-weight:600;font-size:1.2rem}
    .main-controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .date-control-group{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.2);padding:8px 12px;border-radius:10px}
    .date-control-group select,.date-control-group input,.date-control-group button{padding:8px 10px;border:none;border-radius:8px;font-size:.9rem}
    .control-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;font-weight:600;cursor:pointer;transition:.2s;box-shadow:0 2px 8px rgba(102,126,234,.3)}
    .control-btn:hover{transform:translateY(-1px)}
    .control-btn.success{background:linear-gradient(45deg,#28a745,#20c997)}
    .control-btn.danger{background:linear-gradient(45deg,#dc3545,#c82333)}
    .control-btn.secondary{background:#6c757d}
    .function-panel{background:#fff;border:2px solid #e0e6ff;border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .function-group{margin-bottom:16px}
    .group-label{display:inline-block;font-weight:700;color:#333;margin-bottom:12px;font-size:1rem;border-bottom:3px solid #667eea;padding-bottom:6px}
    .function-buttons{display:flex;gap:10px;flex-wrap:wrap}
    .export-options{display:flex;gap:10px;flex-wrap:wrap}
    .option-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);border:2px solid transparent;border-radius:10px;user-select:none}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .legend .tag{padding:4px 8px;border-radius:8px;font-size:.8rem;color:#fff}
    .tag.work{background:#28a745}.tag.night{background:#0d6efd}.tag.holiday{background:#dc3545}.tag.off{background:#6c757d}
    .calendar-container{background:#f8f9fa;border-radius:14px;padding:16px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;background:#e9ecef;border-radius:12px;padding:8px;min-width:350px;overflow-x:auto}
    .day-header{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;padding:10px;text-align:center;font-weight:600;border-radius:6px;font-size:.9rem}
    .weekend-header{background:linear-gradient(45deg,#ff6b6b,#ee5a52)!important}
    .day-cell{background:#fff;border-radius:6px;padding:8px;min-height:120px;position:relative}
    .day-number{font-weight:600;font-size:1rem;color:#333;margin-bottom:8px}
    .holiday-name{font-size:.7rem;color:#dc3545;font-weight:600;text-align:right;line-height:1.2;max-width:72px}
    .staff-schedule{display:flex;flex-direction:column;gap:2px}
    .staff-item{padding:3px 5px;border-radius:4px;font-size:.75rem;font-weight:500;text-align:center;position:relative}
    .staff-item.editable{cursor:pointer;border:1px dashed #0d6efd}
    .work-day{background:#d4edda;color:#155724}
    .night-shift{background:#cce7ff;color:#004085}
    .holiday{background:#f8d7da;color:#721c24}
    .off-day{background:#f1f3f5;color:#6c757d}
    .edit-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #0d6efd;border-radius:6px;z-index:1000;box-shadow:0 4px 8px rgba(0,0,0,.2);max-height:220px;overflow:auto}
    .edit-option{padding:8px;cursor:pointer;border-bottom:1px solid #eee}
    .edit-option:last-child{border-bottom:none}
    .employee-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px;margin-top:12px}
    .employee-card{background:#f8f9fa;border-radius:12px;padding:16px;border-left:4px solid #667eea;position:relative}
    .employee-name{font-size:1.1rem;font-weight:600;color:#333;margin-bottom:6px}
    .shift-card{background:#fff;border:1px solid #e9ecef;border-radius:10px;padding:12px;margin-bottom:10px;position:relative}
    .shift-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .shift-title{font-weight:600;font-size:1.05rem;color:#333}
    .shift-code{background:#667eea;color:#fff;padding:2px 8px;border-radius:4px;font-size:.75rem;font-weight:600}
    .shift-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.85rem;color:#555;margin-bottom:8px}
    .shift-actions{display:flex;gap:8px}
    .form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .form-group{margin-bottom:10px}
    .form-group label{display:block;margin-bottom:4px;font-weight:600;color:#333}
    .form-group input,.form-group select{width:100%;padding:8px;border:2px solid #e9ecef;border-radius:6px;font-size:.9rem}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px;border-radius:12px;text-align:center}
    .stat-number{font-size:1.6rem;font-weight:700;margin-bottom:2px}
    table.table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border:1px solid #e9ecef;padding:8px;text-align:center}
    .table th{background:#f1f3ff}
    #editHint{display:none;color:#0d6efd;margin-left:8px;font-size:.9rem}
    @media (max-width:768px){
      .schedule-header{flex-direction:column;align-items:stretch;gap:10px}
      .form-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <div class="header">
      <h1>å¢å¼·ç‰ˆå“¡å·¥ç­è¡¨ç®¡ç†ç³»çµ±</h1>
      <div class="role-switcher">
        <span>ç•¶å‰èº«ä»½ï¼š</span>
        <span class="role-badge" id="roleBadge">ç®¡ç†è€…</span>
        <button class="control-btn" onclick="toggleRole()">åˆ‡æ›èº«ä»½</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab(event,'schedule')">æŸ¥çœ‹ç­è¡¨</button>
      <button class="nav-tab admin-only" onclick="showTab(event,'employee')">å“¡å·¥ç®¡ç†</button>
      <button class="nav-tab admin-only" onclick="showTab(event,'shift')">ç­åˆ¥è¨­å®š</button>
      <button class="nav-tab" onclick="showTab(event,'stats')">çµ±è¨ˆå ±è¡¨</button>
      <button class="nav-tab admin-only" onclick="showTab(event,'settings')">è¨­å®š</button>
    </div>

    <!-- ç­è¡¨æŸ¥çœ‹ -->
    <div id="scheduleTab" class="tab-content active">
      <div class="schedule-header">
        <h3>ğŸ“Š ç­è¡¨æŸ¥çœ‹ <span id="editHint">ï¼ˆé»å“¡å·¥è† å›Šå¯åˆ‡æ›ç­åˆ¥ï¼›é»ç©ºç™½è™•å¯æ”¶èµ·é¸å–®ï¼‰</span></h3>
        <div class="main-controls">
          <div class="date-control-group">
            <label>é¸æ“‡å¹´æœˆï¼š</label>
            <select id="yearSelect" onchange="changeYearMonth()"></select>
            <select id="monthSelect" onchange="changeYearMonth()"></select>
          </div>
          <button class="control-btn success admin-only" id="editModeBtn" onclick="toggleEditMode()">âœï¸ ç·¨è¼¯æ¨¡å¼</button>
          <button class="control-btn" onclick="refreshHolidays()">ğŸ—“ï¸ é‡æ–°è¼‰å…¥å‡æ—¥</button>
        </div>
      </div>

      <div class="function-panel">
        <div class="function-group">
          <span class="group-label">ğŸ“‹ ç­è¡¨æ“ä½œ</span>
          <div class="function-buttons">
            <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importSchedule(event)"/>
            <button class="control-btn admin-only" onclick="document.getElementById('importFile').click()">ğŸ“ åŒ¯å…¥ç­è¡¨</button>
            <button class="control-btn admin-only" onclick="exportSchedule()">ğŸ’¾ åŒ¯å‡ºç­è¡¨</button>
            <button class="control-btn danger admin-only" onclick="clearAllSchedule()">ğŸ—‘ï¸ æ¸…ç©ºç­è¡¨</button>
            <button class="control-btn admin-only" onclick="saveToCloud()">â˜ï¸ å„²å­˜è‡³é›²ç«¯</button>
            <button class="control-btn" onclick="loadFromCloud()">â˜ï¸ å¾é›²ç«¯è¼‰å…¥</button>
          </div>
        </div>

        <div class="function-group">
          <span class="group-label">âš™ï¸ åŒ¯å‡ºè¨­å®š</span>
          <div class="export-options">
            <label class="option-item"><input type="checkbox" id="filterDefaults" checked> éæ¿¾é è¨­ç­åˆ¥ï¼ˆæ­£è·ä¸Šç­/å…¼è·ä¼‘æ¯ï¼‰</label>
            <label class="option-item"><input type="checkbox" id="hideTypeArea" checked> éš±è—é¡å‹èˆ‡å€åŸŸæ¬„</label>
          </div>
          <div class="legend">
            <span class="tag work">å·¥ä½œ</span>
            <span class="tag night">å¤œç­</span>
            <span class="tag holiday">ä¼‘å‡/ç¯€æ—¥</span>
            <span class="tag off">ä¼‘æ¯</span>
          </div>
        </div>
      </div>

      <div class="calendar-container">
        <div id="calendar" class="calendar-grid"></div>
      </div>
    </div>

    <!-- å“¡å·¥ç®¡ç† -->
    <div id="employeeTab" class="tab-content">
      <div class="function-panel">
        <div class="function-buttons">
          <button class="control-btn admin-only" onclick="showAddEmployeeModal()">â• æ–°å¢å“¡å·¥</button>
        </div>
        <div id="employeeGrid" class="employee-grid"></div>
      </div>
    </div>

    <!-- ç­åˆ¥è¨­å®š -->
    <div id="shiftTab" class="tab-content">
      <div class="function-panel">
        <div class="function-buttons">
          <button class="control-btn admin-only" onclick="showAddShiftForm()">â• æ–°å¢ç­åˆ¥</button>
        </div>
        <div id="shiftsList"></div>

        <!-- æ–°å¢/ç·¨è¼¯ ç­åˆ¥è¡¨å–® -->
        <div id="addShiftForm" style="display:none;margin-top:12px">
          <div class="form-row">
            <div class="form-group">
              <label for="shiftCode">ç­åˆ¥ä»£ç¢¼</label>
              <input id="shiftCode" placeholder="å¦‚ DAY01"/>
            </div>
            <div class="form-group">
              <label for="shiftName">ç­åˆ¥åç¨±</label>
              <input id="shiftName" placeholder="å¦‚ æ—©ç­"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="startTime">é–‹å§‹æ™‚é–“</label>
              <input id="startTime" type="time" value="09:00"/>
            </div>
            <div class="form-group">
              <label for="endTime">çµæŸæ™‚é–“</label>
              <input id="endTime" type="time" value="18:00"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="shiftType">é¡å‹</label>
              <select id="shiftType">
                <option value="fullTime">æ­£è·</option>
                <option value="partTime">å…¼è·</option>
              </select>
            </div>
            <div class="form-group">
              <label for="shiftArea">å€åŸŸ</label>
              <select id="shiftArea">
                <option value="front">å¤–å ´</option>
                <option value="back">å…§å ´</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="shiftColor">é¡è‰²</label>
              <input id="shiftColor" type="color" value="#667eea"/>
            </div>
            <div class="form-group">
              <label for="abbreviation">ç°¡ç¨±ï¼ˆé¡¯ç¤ºæ–¼æœˆæ›†ï¼‰</label>
              <input id="abbreviation" placeholder="å¦‚ï¼šæ—©ã€æ™šã€17-23"/>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="category">åˆ†é¡</label>
              <select id="category">
                <option value="work">å·¥ä½œ</option>
                <option value="night">å¤œç­</option>
                <option value="holiday">ä¼‘å‡</option>
                <option value="off">ä¼‘æ¯</option>
              </select>
            </div>
            <div class="form-group">
              <label>é¡¯ç¤ºè¨­å®š</label>
              <div style="display:flex;gap:10px">
                <select id="showTime">
                  <option value="true">é¡¯ç¤ºæ™‚é–“</option>
                  <option value="false">ä¸é¡¯ç¤ºæ™‚é–“</option>
                </select>
                <select id="showInCalendar">
                  <option value="true">é¡¯ç¤ºæ–¼æœˆæ›†</option>
                  <option value="false">ä¸é¡¯ç¤ºæ–¼æœˆæ›†</option>
                </select>
              </div>
            </div>
          </div>
          <div class="function-buttons" style="margin-top:8px">
            <button class="control-btn success admin-only" onclick="submitShiftForm()">ğŸ’¾ å„²å­˜ç­åˆ¥</button>
            <button class="control-btn secondary admin-only" onclick="hideAddShiftForm()">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- çµ±è¨ˆå ±è¡¨ -->
    <div id="statsTab" class="tab-content">
      <div class="function-panel">
        <span class="group-label">ğŸ“ˆ æœ¬æœˆçµ±è¨ˆ</span>
        <div id="statsCards" class="stats"></div>
      </div>
      <div class="function-panel">
        <span class="group-label">â±ï¸ å€‹äººå·¥æ™‚ï¼ˆå°æ™‚ï¼‰</span>
        <table class="table" id="hoursTable">
          <thead>
            <tr><th>å§“å</th><th>å¹´æœˆ</th><th>ç¸½å·¥æ™‚</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div id="settingsTab" class="tab-content">
      <div class="function-panel">
        <span class="group-label">ğŸ—“ï¸ å‡æ—¥ä¾†æº</span>
        <div class="form-row">
          <div class="form-group">
            <label for="holidaySourceMode">ä¾†æºæ¨¡å¼</label>
            <select id="holidaySourceMode">
              <option value="builtin">å…§å»ºå°ç£å‡æ—¥</option>
              <option value="ics">ICSï¼ˆè‡ªè¨‚ iCalï¼‰</option>
            </select>
          </div>
          <div class="form-group">
            <label for="icsUrlInput">ICS é€£çµï¼ˆå…¬é–‹å¯å–ï¼‰</label>
            <input id="icsUrlInput" placeholder="https://.../calendar.ics"/>
          </div>
        </div>
        <div class="function-buttons">
          <button class="control-btn" onclick="saveHolidaySettings()">ğŸ’¾ å„²å­˜å‡æ—¥è¨­å®š</button>
          <button class="control-btn" onclick="refreshHolidays()">ğŸ”„ ç«‹å³é‡æ–°è¼‰å…¥</button>
        </div>
      </div>

      <div class="function-panel">
        <span class="group-label">â˜ï¸ é›²ç«¯ï¼ˆGoogle Apps Script Web Appï¼‰</span>
        <div class="form-row">
          <div class="form-group">
            <label for="gasUrlInput">Web App URL</label>
            <input id="gasUrlInput" placeholder="https://script.google.com/macros/s/....../exec"/>
          </div>
        </div>
        <div class="function-buttons">
          <button class="control-btn" onclick="saveCloudSettings()">ğŸ’¾ å„²å­˜é›²ç«¯è¨­å®š</button>
          <button class="control-btn admin-only" onclick="saveToCloud()">â˜ï¸ ç«‹å³ä¸Šå‚³</button>
          <button class="control-btn" onclick="loadFromCloud()">â˜ï¸ ç«‹å³ä¸‹è¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/**********************
 * Config & State
 **********************/
const YEARS = [2024, 2025, 2026, 2027, 2028];
const DEFAULT_FULLTIME_NULL_HOURS = 8;

let currentRole = 'admin';
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;
let isEditMode = false;
let currentEditElement = null;

const settings = {
  holidaySource: { mode: 'builtin', icsUrl: '' },
  cloud: { gasUrl: 'YOUR_GAS_WEBAPP_URL' },
};

// ä¸»è³‡æ–™
let scheduleData = { employees: [], schedules: {} };
let enhancedShiftSettings = {
  allShifts: [
    { code:'DAY01', name:'æ—©ç­', startTime:'09:00', endTime:'18:00', type:'fullTime', area:'front', color:'#28a745', category:'work', displaySettings:{showInCalendar:true, showTime:true, abbreviation:'æ—©'} },
    { code:'LATE01', name:'æ™šç­', startTime:'14:00', endTime:'23:00', type:'fullTime', area:'front', color:'#6f42c1', category:'work', displaySettings:{showInCalendar:true, showTime:true, abbreviation:'æ™š'} },
    { code:'HOL01', name:'ä¼‘å‡', startTime:'00:00', endTime:'00:00', type:'fullTime', area:'front', color:'#dc3545', category:'holiday', displaySettings:{showInCalendar:true, showTime:false, abbreviation:'ä¼‘'} },
    { code:'PT01', name:'17:00-23:00', startTime:'17:00', endTime:'23:00', type:'partTime', area:'front', color:'#0d6efd', category:'night', displaySettings:{showInCalendar:true, showTime:true, abbreviation:'17-23'} },
    { code:'PT02', name:'18:00-24:00', startTime:'18:00', endTime:'24:00', type:'partTime', area:'front', color:'#17a2b8', category:'night', displaySettings:{showInCalendar:true, showTime:true, abbreviation:'18-24'} }
  ]
};

// å…§å»ºå°ç£å‡æ—¥
const holidays = { 2024:{}, 2025:{}, 2026:{} };
const taiwanHolidaysData = {
  2024:{'1/1':'å…ƒæ—¦','2/10':'é™¤å¤•','2/11':'æ˜¥ç¯€','2/12':'åˆäºŒ','2/13':'åˆä¸‰','2/14':'åˆå››','2/28':'å’Œå¹³ç´€å¿µæ—¥','4/4':'å…’ç«¥ç¯€','4/5':'æ¸…æ˜ç¯€','5/1':'å‹å‹•ç¯€','6/10':'ç«¯åˆç¯€','9/17':'ä¸­ç§‹ç¯€','10/10':'åœ‹æ…¶æ—¥'},
  2025:{'1/1':'å…ƒæ—¦','1/28':'é™¤å¤•','1/29':'æ˜¥ç¯€','1/30':'åˆäºŒ','1/31':'åˆä¸‰','2/1':'åˆå››','2/28':'å’Œå¹³ç´€å¿µæ—¥','4/4':'å…’ç«¥ç¯€','4/5':'æ¸…æ˜ç¯€','5/31':'ç«¯åˆç¯€','10/6':'ä¸­ç§‹ç¯€','10/10':'åœ‹æ…¶æ—¥'},
  2026:{'1/1':'å…ƒæ—¦','2/16':'é™¤å¤•','2/17':'æ˜¥ç¯€','2/18':'åˆäºŒ','2/19':'åˆä¸‰','2/20':'åˆå››','2/28':'å’Œå¹³ç´€å¿µæ—¥','4/4':'å…’ç«¥ç¯€','4/5':'æ¸…æ˜ç¯€','5/1':'å‹å‹•ç¯€','6/19':'ç«¯åˆç¯€','9/25':'ä¸­ç§‹ç¯€','10/10':'åœ‹æ…¶æ—¥'}
};
const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];

/**********************
 * Init
 **********************/
(function init(){
  const ySel = document.getElementById('yearSelect');
  YEARS.forEach(y=>{const o=document.createElement('option');o.value=y;o.textContent=y+'å¹´';ySel.appendChild(o)});
  const mSel = document.getElementById('monthSelect');
  for(let m=1;m<=12;m++){const o=document.createElement('option');o.value=m;o.textContent=m+'æœˆ';mSel.appendChild(o)}
  if(!YEARS.includes(currentYear)) currentYear = YEARS[0];
  ySel.value=currentYear; mSel.value=currentMonth;

  loadLocal();
  updateRoleDisplay();
  loadTaiwanHolidaysBuiltin();
  refreshHolidays();

  ensureScheduleData(currentYear,currentMonth);
  updateCalendar();
  updateEmployeeGrid();
  updateShiftsList();
  updateStats();

  // é»ç©ºç™½è™•å¯æ”¶èµ·ä¸‹æ‹‰
  document.addEventListener('click', (e)=>{
    if(!currentEditElement) return;
    if(!currentEditElement.contains(e.target)) closeEditDropdown();
  }, true);
})();

function loadLocal(){
  try{
    const s = localStorage.getItem('scheduleData'); if(s) scheduleData = JSON.parse(s);
    const sh = localStorage.getItem('enhancedShiftSettings'); if(sh) enhancedShiftSettings = JSON.parse(sh);
    const cfg = localStorage.getItem('settings'); if(cfg) Object.assign(settings, JSON.parse(cfg));
    // render settings
    const modeEl=document.getElementById('holidaySourceMode');
    const icsEl=document.getElementById('icsUrlInput');
    const gasEl=document.getElementById('gasUrlInput');
    if(modeEl) modeEl.value=settings.holidaySource.mode;
    if(icsEl) icsEl.value=settings.holidaySource.icsUrl||'';
    if(gasEl) gasEl.value=settings.cloud.gasUrl||'';
  }catch(e){ console.warn('loadLocal error',e); }
}
function saveLocal(){
  localStorage.setItem('scheduleData', JSON.stringify(scheduleData));
  localStorage.setItem('enhancedShiftSettings', JSON.stringify(enhancedShiftSettings));
  localStorage.setItem('settings', JSON.stringify(settings));
}

/**********************
 * Role & Tabs
 **********************/
function toggleRole(){
  currentRole = currentRole==='admin' ? 'employee' : 'admin';
  updateRoleDisplay();
}
function updateRoleDisplay(){
  const container=document.getElementById('mainContainer');
  const badge=document.getElementById('roleBadge');
  if(currentRole==='admin'){
    if(container) container.className='container admin-mode';
    if(badge){badge.textContent='ç®¡ç†è€…';badge.className='role-badge'}
    document.querySelectorAll('.admin-only').forEach(el=>el.style.display='inline-block');
  }else{
    if(container) container.className='container employee-mode';
    if(badge){badge.textContent='å“¡å·¥';badge.className='role-badge employee'}
    document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');
    if(isEditMode){ isEditMode=false; const btn=document.getElementById('editModeBtn'); if(btn){btn.textContent='âœï¸ ç·¨è¼¯æ¨¡å¼'; btn.classList.remove('success')} document.getElementById('editHint').style.display='none'; }
  }
}
function showTab(ev,name){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el=>el.classList.remove('active'));
  document.getElementById(name+'Tab').classList.add('active');
  ev.target.classList.add('active');
  if(name==='schedule') updateCalendar();
  if(name==='employee') updateEmployeeGrid();
  if(name==='shift') updateShiftsList();
  if(name==='stats') updateStats();
}

/**********************
 * Holidays
 **********************/
function loadTaiwanHolidaysBuiltin(){
  holidays[2024] = {...taiwanHolidaysData[2024]};
  holidays[2025] = {...taiwanHolidaysData[2025]};
  holidays[2026] = {...taiwanHolidaysData[2026]};
}
function saveHolidaySettings(){
  settings.holidaySource.mode = document.getElementById('holidaySourceMode').value;
  settings.holidaySource.icsUrl = document.getElementById('icsUrlInput').value.trim();
  saveLocal();
  alert('å‡æ—¥è¨­å®šå·²å„²å­˜');
}
async function refreshHolidays(){
  if(settings.holidaySource.mode==='ics' && settings.holidaySource.icsUrl){
    try{
      const text = await (await fetch(settings.holidaySource.icsUrl)).text();
      parseICSAndApply(text);
      updateCalendar();
      alert('ICS å‡æ—¥å·²é‡æ–°è¼‰å…¥');
    }catch(err){
      console.error(err);
      alert('è¼‰å…¥ ICS å¤±æ•—ï¼Œå·²ä½¿ç”¨å…§å»ºå‡æ—¥');
      loadTaiwanHolidaysBuiltin();
      updateCalendar();
    }
  }else{
    loadTaiwanHolidaysBuiltin();
    updateCalendar();
  }
}
function parseICSAndApply(icsText){
  const lines = icsText.replace(/\r/g,'').split('\n');
  let cur=null; const events=[];
  for(const raw of lines){
    const line=raw.trim();
    if(line==='BEGIN:VEVENT'){cur={};continue;}
    if(line==='END:VEVENT'){ if(cur) events.push(cur); cur=null; continue;}
    if(!cur) continue;
    const idx=line.indexOf(':'); if(idx<0) continue;
    const key=line.slice(0,idx).toUpperCase();
    const val=line.slice(idx+1);
    if(key.startsWith('DTSTART')) cur.DTSTART=val;
    if(key.startsWith('SUMMARY')) cur.SUMMARY=decodeURIComponent(val);
  }
  for(const y of YEARS){ holidays[y]={}; }
  for(const ev of events){
    const dt=(ev.DTSTART||'').replace(/T.*$/,'');
    if(/^[0-9]{8}$/.test(dt)){
      const y=+dt.slice(0,4), m=+dt.slice(4,6), d=+dt.slice(6,8);
      const label=(ev.SUMMARY||'å‡æ—¥').replace(/\\,/,',');
      if(holidays[y]) holidays[y][`${m}/${d}`]=label;
    }
  }
}
function getHolidayName(year,m,d){
  const key=`${m}/${d}`;
  return holidays[year] && holidays[year][key] ? holidays[year][key] : null;
}

/**********************
 * Calendar & Edit
 **********************/
function changeYearMonth(){
  currentYear = parseInt(document.getElementById('yearSelect').value);
  currentMonth = parseInt(document.getElementById('monthSelect').value);
  updateCalendar();
}
function getDaysInMonth(y,m){ return new Date(y,m,0).getDate(); }
function getFirstDayOfWeek(y,m){ return new Date(y,m-1,1).getDay(); }

function ensureScheduleData(y,m){
  const key=`${y}-${m}`;
  if(!scheduleData.schedules[key]) scheduleData.schedules[key]={};
  const days=getDaysInMonth(y,m);
  scheduleData.employees.forEach(emp=>{
    if(!scheduleData.schedules[key][emp.å§“å]) scheduleData.schedules[key][emp.å§“å]={};
    for(let d=1; d<=days; d++) if(!(d in scheduleData.schedules[key][emp.å§“å])) scheduleData.schedules[key][emp.å§“å][d]=null;
  });
}
function updateCalendar(){ ensureScheduleData(currentYear,currentMonth); generateCalendar(); }

function generateCalendar(){
  const calendar=document.getElementById('calendar');
  calendar.innerHTML='';
  ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach((day,idx)=>{
    const h=document.createElement('div');
    h.className='day-header'+((idx===0||idx===6)?' weekend-header':'');
    h.textContent=day; calendar.appendChild(h);
  });
  const days=getDaysInMonth(currentYear,currentMonth);
  const firstDow=getFirstDayOfWeek(currentYear,currentMonth);
  for(let i=0;i<firstDow;i++){ const e=document.createElement('div'); e.className='day-cell'; e.style.opacity='.4'; calendar.appendChild(e); }

  const scheduleKey=`${currentYear}-${currentMonth}`;
  for(let day=1; day<=days; day++){
    const cell=document.createElement('div'); cell.className='day-cell';
    const head=document.createElement('div'); head.style.cssText='display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;';
    const dn=document.createElement('div'); dn.className='day-number'; dn.textContent=day; head.appendChild(dn);
    const hname=getHolidayName(currentYear,currentMonth,day);
    if(hname){ const he=document.createElement('div'); he.className='holiday-name'; he.textContent=hname; head.appendChild(he); }
    cell.appendChild(head);

    const wrap=document.createElement('div'); wrap.className='staff-schedule';
    scheduleData.employees.forEach(emp=>{
      const val=scheduleData.schedules[scheduleKey]?.[emp.å§“å]?.[day];
      const item=document.createElement('div'); item.className=`staff-item ${getStaffClass(val, emp.é¡å‹)}`;
      item.textContent=getStaffDisplay(emp.å§“å, val, emp.é¡å‹);
      if(isEditMode && currentRole==='admin'){
        item.classList.add('editable');
        item.addEventListener('click',(e)=>{ e.stopPropagation(); editSchedule(e.currentTarget, emp.å§“å, day); });
      }
      wrap.appendChild(item);
    });
    cell.appendChild(wrap);
    calendar.appendChild(cell);
  }
}
function toggleEditMode(){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥ç·¨è¼¯ç­è¡¨'); return; }
  isEditMode=!isEditMode;
  const btn=document.getElementById('editModeBtn');
  const hint=document.getElementById('editHint');
  closeEditDropdown();
  if(isEditMode){ if(btn){btn.textContent='âœ… å®Œæˆç·¨è¼¯'; btn.classList.add('success')} if(hint) hint.style.display='block'; }
  else{ if(btn){btn.textContent='âœï¸ ç·¨è¼¯æ¨¡å¼'; btn.classList.remove('success')} if(hint) hint.style.display='none'; }
  generateCalendar();
}
function editSchedule(element, employeeName, day){
  closeEditDropdown();
  const emp=scheduleData.employees.find(e=>e.å§“å===employeeName); if(!emp) return;
  const dropdown=document.createElement('div'); dropdown.className='edit-dropdown';

  const def=document.createElement('div'); def.className='edit-option';
  def.textContent=(emp.é¡å‹==='fullTime'?'ä¸Šç­(é è¨­)':'ä¼‘æ¯(é è¨­)');
  def.onclick=(e)=>{ e.stopPropagation(); updateSchedule(employeeName,day,null); closeEditDropdown(); };
  dropdown.appendChild(def);

  const options=getScheduleOptions(emp.é¡å‹, emp.å€åŸŸ);
  if(options.length===0){
    const no=document.createElement('div'); no.className='edit-option'; no.textContent='æ²’æœ‰å¯ç”¨çš„ç­åˆ¥'; dropdown.appendChild(no);
  }else{
    options.forEach(op=>{
      const d=document.createElement('div'); d.className='edit-option'; d.textContent=op.label;
      d.onclick=(e)=>{ e.stopPropagation(); updateSchedule(employeeName,day,op.value); closeEditDropdown(); };
      dropdown.appendChild(d);
    });
  }
  element.style.position='relative';
  element.appendChild(dropdown);
  currentEditElement=element;
  element.style.outline='2px solid #0d6efd'; element.style.outlineOffset='1px';
}
function closeEditDropdown(){
  if(currentEditElement){
    const dd=currentEditElement.querySelector('.edit-dropdown'); if(dd) dd.remove();
    currentEditElement.style.outline=''; currentEditElement=null;
  }
}
function updateSchedule(name,day,value){
  const key=`${currentYear}-${currentMonth}`;
  if(!scheduleData.schedules[key]) scheduleData.schedules[key]={};
  if(!scheduleData.schedules[key][name]) scheduleData.schedules[key][name]={};
  scheduleData.schedules[key][name][day]=value;
  saveLocal();
  generateCalendar();
}
function getScheduleOptions(type,area){
  return enhancedShiftSettings.allShifts
    .filter(s=>s.type===type && s.area===area && s.displaySettings?.showInCalendar!==false)
    .map(s=>{
      const timeDisp = s.displaySettings?.showTime ? ` ${s.startTime}-${s.endTime}` : '';
      return {label:`${s.name}${timeDisp}`, value:s.name};
    });
}
function getStaffClass(schedule, employeeType){
  if(schedule===null) return employeeType==='fullTime' ? 'work-day' : 'off-day';
  const sh=enhancedShiftSettings.allShifts.find(s=>s.name===schedule);
  if(sh){ return ({work:'work-day', night:'night-shift', holiday:'holiday', off:'off-day'})[sh.category] || 'work-day'; }
  if(/ä¼‘|å‡/.test(schedule)) return 'holiday';
  if(/:|-|å¤œ|æ™š/.test(schedule)) return 'night-shift';
  return 'work-day';
}
function getStaffDisplay(name, schedule, employeeType){
  if(schedule===null) return `${name} ${employeeType==='fullTime'?'ç­':''}`;
  const sh=enhancedShiftSettings.allShifts.find(s=>s.name===schedule);
  const abbr=sh?.displaySettings?.abbreviation || (schedule.length>4 ? schedule.slice(0,4) : schedule);
  return `${name} ${abbr}`;
}

/**********************
 * Import/Export CSV
 **********************/
function exportSchedule(){
  const csv = generateCSV(
    document.getElementById('filterDefaults')?.checked ?? true,
    document.getElementById('hideTypeArea')?.checked ?? true
  );
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`ç­è¡¨_${currentYear}å¹´${currentMonth}æœˆ_${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(url);
}
function generateCSV(filterDefaults=false, hideTypeArea=false){
  if(scheduleData.employees.length===0) return '';
  const headers=['å§“å'];
  if(!hideTypeArea){ headers.push('é¡å‹','å€åŸŸ'); }
  const days=getDaysInMonth(currentYear,currentMonth);
  for(let d=1; d<=days; d++) headers.push(`${currentMonth}/${d}`);
  let csv=headers.join(',')+'\n';
  const key=`${currentYear}-${currentMonth}`;
  scheduleData.employees.forEach(emp=>{
    const typeText=emp.é¡å‹==='fullTime'?'æ­£è·':'å…¼è·';
    const areaText=emp.å€åŸŸ==='front'?'å¤–å ´':'å…§å ´';
    const row=[emp.å§“å];
    if(!hideTypeArea){ row.push(typeText, areaText); }
    for(let d=1; d<=days; d++){
      let val = scheduleData.schedules[key]?.[emp.å§“å]?.[d] ?? null;
      if(filterDefaults){
        if(emp.é¡å‹==='fullTime' && (val===null || val==='ä¸Šç­')) val='';
        else if(emp.é¡å‹==='partTime' && (val===null || val==='ä¼‘æ¯')) val='';
      }else{
        if(val===null) val=(emp.é¡å‹==='fullTime'?'ä¸Šç­':'ä¼‘æ¯');
      }
      row.push(val ?? '');
    }
    csv += row.join(',')+'\n';
  });
  return csv;
}
function importSchedule(ev){
  const file=ev.target.files[0]; if(!file) return;
  if(!file.name.endsWith('.csv')){ alert('è«‹é¸æ“‡CSVæª”æ¡ˆ'); return; }
  const fr=new FileReader();
  fr.onload=(e)=>{ try{ parseAndImportCSV(e.target.result); }catch(err){ alert('è®€å–å¤±æ•—ï¼š'+err.message); } };
  fr.readAsText(file,'utf-8'); ev.target.value='';
}
function parseAndImportCSV(text){
  const lines=text.split('\n').filter(x=>x.trim());
  if(lines.length<2){ alert('CSV æ ¼å¼ä¸æ­£ç¢º'); return; }
  const headers=lines[0].split(',').map(h=>h.trim());
  const hasTypeArea=(headers[1]==='é¡å‹' && headers[2]==='å€åŸŸ');
  const startIdx=hasTypeArea?3:1;
  const dateCols=headers.slice(startIdx);
  let targetMonth=null;
  if(dateCols.length>0){
    const m=dateCols[0].match(/(\d+)\/(\d+)/);
    if(m) targetMonth=parseInt(m[1]); else { alert('æ—¥æœŸæ ¼å¼ä¸æ­£ç¢º'); return; }
  }
  const targetYear=currentYear;
  const key=`${targetYear}-${targetMonth}`;
  if(!scheduleData.schedules[key]) scheduleData.schedules[key]={};
  const newEmployees=[];
  for(let i=1;i<lines.length;i++){
    const cells=lines[i].split(',').map(c=>c.trim());
    if(cells.length<startIdx+1) continue;
    const name=cells[0]; if(!name) continue;
    const exist=scheduleData.employees.find(e=>e.å§“å===name);
    const type=hasTypeArea ? (cells[1]==='å…¼è·'?'partTime':'fullTime') : (exist?.é¡å‹||'fullTime');
    const area=hasTypeArea ? (cells[2]==='å…§å ´'?'back':'front') : (exist?.å€åŸŸ||'front');
    if(!exist){ scheduleData.employees.push({å§“å:name, é¡å‹:type, å€åŸŸ:area}); newEmployees.push(name); }
    if(!scheduleData.schedules[key][name]) scheduleData.schedules[key][name]={};
    for(let j=startIdx;j<cells.length && j<headers.length;j++){
      const m=headers[j].match(/\d+\/(\d+)/); if(!m) continue;
      const d=parseInt(m[1]);
      const v=cells[j];
      let val=null;
      if(v && !['ä¸Šç­','ä¼‘æ¯'].includes(v)) val=v;
      scheduleData.schedules[key][name][d]=val;
    }
  }
  currentMonth=targetMonth; const ms=document.getElementById('monthSelect'); if(ms) ms.value=currentMonth;
  saveLocal();
  ensureScheduleData(currentYear,currentMonth);
  updateCalendar(); updateEmployeeGrid();
  alert(`åŒ¯å…¥æˆåŠŸï¼æ–°å“¡å·¥ ${newEmployees.length} ä½`);
}

/**********************
 * Employees
 **********************/
function showAddEmployeeModal(){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥æ–°å¢å“¡å·¥'); return; }
  const name=prompt('è¼¸å…¥å“¡å·¥å§“å'); if(!name) return;
  const type=confirm('æ­£è·è«‹æŒ‰ã€Œç¢ºå®šã€ï¼Œå…¼è·æŒ‰ã€Œå–æ¶ˆã€') ? 'fullTime' : 'partTime';
  const area=confirm('å¤–å ´è«‹æŒ‰ã€Œç¢ºå®šã€ï¼Œå…§å ´æŒ‰ã€Œå–æ¶ˆã€') ? 'front' : 'back';
  addEmployee(name.trim(), type, area);
}
function addEmployee(name,type,area){
  if(!name){ alert('å§“åå¿…å¡«'); return; }
  if(scheduleData.employees.find(e=>e.å§“å===name)){ alert('å“¡å·¥å§“åå·²å­˜åœ¨'); return; }
  scheduleData.employees.push({å§“å:name, é¡å‹:type, å€åŸŸ:area});
  Object.keys(scheduleData.schedules).forEach(k=>{
    const [y,m]=k.split('-').map(Number);
    const days=getDaysInMonth(y,m);
    scheduleData.schedules[k][name]={};
    for(let d=1; d<=days; d++) scheduleData.schedules[k][name][d]=null;
  });
  saveLocal(); updateEmployeeGrid(); alert(`å·²æ–°å¢ï¼š${name}`);
}
function updateEmployeeGrid(){
  const grid=document.getElementById('employeeGrid'); if(!grid) return;
  grid.innerHTML='';
  if(scheduleData.employees.length===0){
    grid.innerHTML='<p style="text-align:center;color:#666;grid-column:1/-1;">ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>';
    return;
  }
  scheduleData.employees.forEach((emp,idx)=>{
    const card=document.createElement('div'); card.className='employee-card';
    const typeText=emp.é¡å‹==='fullTime'?'æ­£è·':'å…¼è·';
    const areaText=emp.å€åŸŸ==='front'?'å¤–å ´':'å…§å ´';
    card.innerHTML=`<div class="employee-name">${emp.å§“å}</div><div>é¡å‹ï¼š${typeText}</div><div>å€åŸŸï¼š${areaText}</div>`;
    if(currentRole==='admin'){
      const del=document.createElement('button');
      del.className='control-btn danger admin-only';
      del.style.position='absolute'; del.style.top='10px'; del.style.right='10px';
      del.textContent='åˆªé™¤';
      del.onclick=()=>removeEmployee(idx);
      card.appendChild(del);
    }
    grid.appendChild(card);
  });
}
function removeEmployee(index){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥åˆªé™¤å“¡å·¥'); return; }
  const e=scheduleData.employees[index];
  if(!confirm(`ç¢ºå®šåˆªé™¤ ${e.å§“å}ï¼Ÿ`)) return;
  scheduleData.employees.splice(index,1);
  Object.keys(scheduleData.schedules).forEach(k=>{ delete scheduleData.schedules[k][e.å§“å]; });
  saveLocal(); updateEmployeeGrid(); updateCalendar();
}

/**********************
 * Shifts CRUD
 **********************/
let editingShiftIndex=null;
function showAddShiftForm(shIdx=null){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥è¨­å®šç­åˆ¥'); return; }
  document.getElementById('addShiftForm').style.display='block';
  if(shIdx===null){
    editingShiftIndex=null; clearShiftForm();
  }else{
    editingShiftIndex=shIdx;
    const s=enhancedShiftSettings.allShifts[shIdx];
    document.getElementById('shiftCode').value=s.code;
    document.getElementById('shiftName').value=s.name;
    document.getElementById('startTime').value=s.startTime;
    document.getElementById('endTime').value=s.endTime;
    document.getElementById('shiftType').value=s.type;
    document.getElementById('shiftArea').value=s.area;
    document.getElementById('shiftColor').value=s.color;
    document.getElementById('abbreviation').value=s.displaySettings?.abbreviation||'';
    document.getElementById('showTime').value=String(!!s.displaySettings?.showTime);
    document.getElementById('showInCalendar').value=String(!!s.displaySettings?.showInCalendar);
    document.getElementById('category').value=s.category;
  }
}
function hideAddShiftForm(){ document.getElementById('addShiftForm').style.display='none'; clearShiftForm(); editingShiftIndex=null; }
function clearShiftForm(){
  ['shiftCode','shiftName','abbreviation'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('startTime').value='09:00';
  document.getElementById('endTime').value='18:00';
  document.getElementById('shiftType').value='fullTime';
  document.getElementById('shiftArea').value='front';
  document.getElementById('shiftColor').value='#667eea';
  document.getElementById('showTime').value='true';
  document.getElementById('showInCalendar').value='true';
  document.getElementById('category').value='work';
}
function $(id){ return document.getElementById(id).value.trim(); }
function submitShiftForm(){
  const code=$('shiftCode'), name=$('shiftName');
  const start=$('startTime'), end=$('endTime'), type=$('shiftType'), area=$('shiftArea'), color=$('shiftColor');
  const abbr=$('abbreviation'), showTime=(document.getElementById('showTime').value==='true'), showIn=(document.getElementById('showInCalendar').value==='true'), category=$('category');
  if(!code || !name){ alert('è«‹è¼¸å…¥ç­åˆ¥ä»£ç¢¼èˆ‡åç¨±'); return; }
  const obj={code,name,startTime:start,endTime:end,type,area,color,category,displaySettings:{showInCalendar:showIn, showTime, abbreviation:abbr||name.charAt(0)}};
  const existsIdx=enhancedShiftSettings.allShifts.findIndex(s=>s.code===code);
  if(editingShiftIndex===null){
    if(existsIdx>=0){ alert('ç­åˆ¥ä»£ç¢¼å·²å­˜åœ¨'); return; }
    enhancedShiftSettings.allShifts.push(obj);
  }else{
    if(existsIdx>=0 && existsIdx!==editingShiftIndex){ alert('æ–°ä»£ç¢¼èˆ‡ç¾æœ‰é‡è¤‡'); return; }
    enhancedShiftSettings.allShifts[editingShiftIndex]=obj;
  }
  saveLocal(); updateShiftsList(); hideAddShiftForm(); alert('ç­åˆ¥å·²å„²å­˜');
}
function updateShiftsList(){
  const cont=document.getElementById('shiftsList'); if(!cont) return;
  cont.innerHTML='';
  enhancedShiftSettings.allShifts.forEach((s,idx)=>{
    const card=document.createElement('div'); card.className='shift-card'; card.style.borderLeft=`4px solid ${s.color}`;
    const timeDisp=s.displaySettings.showTime ? `${s.startTime} - ${s.endTime}` : 'ç„¡æ™‚é–“é¡¯ç¤º';
    card.innerHTML =
      `<div class='shift-card-header'>
        <div class='shift-title'>${s.name}</div>
        <span class='shift-code'>${s.code}</span>
      </div>
      <div class='shift-details'>
        <div><b>æ™‚é–“ï¼š</b>${timeDisp}</div>
        <div><b>é¡å‹ï¼š</b>${s.type==='fullTime'?'æ­£è·':'å…¼è·'}</div>
        <div><b>å€åŸŸï¼š</b>${s.area==='front'?'å¤–å ´':'å…§å ´'}</div>
        <div><b>ç°¡ç¨±ï¼š</b>${s.displaySettings.abbreviation||''}</div>
        <div><b>åˆ†é¡ï¼š</b>${({work:'å·¥ä½œ',night:'å¤œç­',holiday:'ä¼‘å‡',off:'ä¼‘æ¯'})[s.category]||s.category}</div>
      </div>`;
    const actions=document.createElement('div'); actions.className='shift-actions';
    const editBtn=document.createElement('button'); editBtn.className='control-btn'; editBtn.textContent='ç·¨è¼¯'; editBtn.onclick=()=>showAddShiftForm(idx);
    const delBtn=document.createElement('button'); delBtn.className='control-btn danger'; delBtn.textContent='åˆªé™¤'; delBtn.onclick=()=>deleteShift(idx);
    actions.appendChild(editBtn); actions.appendChild(delBtn); card.appendChild(actions); cont.appendChild(card);
  });
}
function deleteShift(index){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥åˆªé™¤ç­åˆ¥'); return; }
  const s=enhancedShiftSettings.allShifts[index];
  if(!confirm(`ç¢ºå®šåˆªé™¤ç­åˆ¥ã€Œ${s.name}ã€ï¼Ÿ`)) return;
  enhancedShiftSettings.allShifts.splice(index,1);
  saveLocal(); updateShiftsList();
}

/**********************
 * Stats
 **********************/
function updateStats(){
  const cont=document.getElementById('statsCards'); if(!cont){ return; }
  cont.innerHTML='';
  if(scheduleData.employees.length===0){ cont.innerHTML='<p style="text-align:center;color:#666;">ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>'; return; }

  const key=`${currentYear}-${currentMonth}`;
  const days=getDaysInMonth(currentYear,currentMonth);
  let totalWork=0, totalNight=0, totalHoliday=0, totalOff=0;

  scheduleData.employees.forEach(emp=>{
    for(let d=1; d<=days; d++){
      const sch=scheduleData.schedules[key]?.[emp.å§“å]?.[d];
      if(sch===null){
        if(emp.é¡å‹==='fullTime') totalWork++;
        else totalOff++;
      }else{
        const sh=enhancedShiftSettings.allShifts.find(x=>x.name===sch);
        if(sh){
          if(sh.category==='work') totalWork++;
          else if(sh.category==='night') totalNight++;
          else if(sh.category==='holiday') totalHoliday++;
          else if(sh.category==='off') totalOff++;
        }
      }
    }
  });

  const stats=[
    {label:'ç¸½å“¡å·¥æ•¸', value:scheduleData.employees.length},
    {label:'ç¸½å·¥ä½œå¤©æ•¸', value:totalWork+totalNight},
    {label:'ç¸½å¤œç­å¤©æ•¸', value:totalNight},
    {label:'ç¸½ä¼‘å‡å¤©æ•¸', value:totalHoliday},
    {label:'ç¸½ä¼‘æ¯å¤©æ•¸', value:totalOff},
  ];
  stats.forEach(st=>{
    const c=document.createElement('div'); c.className='stat-card';
    c.innerHTML=`<div class='stat-number'>${st.value}</div><div>${st.label}</div>`;
    cont.appendChild(c);
  });

  const tbody=document.querySelector('#hoursTable tbody');
  if(tbody){
    tbody.innerHTML='';
    scheduleData.employees.forEach(emp=>{
      const hours=calcMonthlyHours(emp,currentYear,currentMonth);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${emp.å§“å}</td><td>${currentYear}/${currentMonth}</td><td>${hours.toFixed(1)}</td>`;
      tbody.appendChild(tr);
    });
  }
}
function calcMonthlyHours(emp,y,m){
  const key=`${y}-${m}`; const days=getDaysInMonth(y,m); let sum=0;
  for(let d=1; d<=days; d++){
    const sch=scheduleData.schedules[key]?.[emp.å§“å]?.[d];
    if(sch===null){ if(emp.é¡å‹==='fullTime') sum+=DEFAULT_FULLTIME_NULL_HOURS; continue; }
    const sh=enhancedShiftSettings.allShifts.find(x=>x.name===sch);
    if(!sh){
      const mm=sch.match(/(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/);
      if(mm){
        const sH=+mm[1], sM=+mm[2], eH=+mm[3], eM=+mm[4];
        let h=eH+eM/60 - (sH+sM/60);
        if(h<0) h+=24;
        sum+=h;
      }
      continue;
    }
    sum+=diffHours(sh.startTime, sh.endTime);
  }
  return sum;
}
function diffHours(t1,t2){
  const [h1,m1]=t1.split(':').map(Number);
  const [h2,m2]=t2.split(':').map(Number);
  let h=h2+m2/60 - (h1+m1/60);
  if(h<0) h+=24;
  return h;
}

/**********************
 * Cloud (GAS)
 **********************/
function saveCloudSettings(){
  const v=document.getElementById('gasUrlInput').value.trim();
  if(v) settings.cloud.gasUrl=v;
  saveLocal();
  alert('é›²ç«¯è¨­å®šå·²å„²å­˜');
}
async function saveToCloud(){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥å„²å­˜é›²ç«¯'); return; }
  const url=settings.cloud.gasUrl;
  if(!url || url==='YOUR_GAS_WEBAPP_URL'){ alert('è«‹å…ˆæ–¼ã€Œè¨­å®šã€å¡«å…¥ GAS Web App URL'); return; }
  const payload={ scheduleData, enhancedShiftSettings, settings };
  try{
    const res=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
    if(!res.ok) throw new Error(await res.text());
    alert('å·²å„²å­˜è‡³é›²ç«¯');
  }catch(err){
    console.error(err);
    alert('é›²ç«¯å„²å­˜å¤±æ•—ï¼š'+err.message);
  }
}
async function loadFromCloud(){
  const url=settings.cloud.gasUrl;
  if(!url || url==='YOUR_GAS_WEBAPP_URL'){ alert('è«‹å…ˆæ–¼ã€Œè¨­å®šã€å¡«å…¥ GAS Web App URL'); return; }
  try{
    const res=await fetch(url); // doGet ç›´æ¥å›å‚³ JSON
    if(!res.ok) throw new Error(await res.text());
    const data=await res.json();
    if(data.scheduleData) scheduleData=data.scheduleData;
    if(data.enhancedShiftSettings) enhancedShiftSettings=data.enhancedShiftSettings;
    if(data.settings) Object.assign(settings, data.settings);
    saveLocal();
    ensureScheduleData(currentYear,currentMonth);
    updateCalendar(); updateEmployeeGrid(); updateShiftsList(); updateStats();
    // åŒæ­¥è¨­å®š UI
    const modeEl=document.getElementById('holidaySourceMode'); if(modeEl) modeEl.value=settings.holidaySource.mode;
    const icsEl=document.getElementById('icsUrlInput'); if(icsEl) icsEl.value=settings.holidaySource.icsUrl||'';
    const gasEl=document.getElementById('gasUrlInput'); if(gasEl) gasEl.value=settings.cloud.gasUrl||'';
    alert('é›²ç«¯è³‡æ–™å·²è¼‰å…¥');
  }catch(err){
    console.error(err);
    alert('é›²ç«¯è¼‰å…¥å¤±æ•—ï¼š'+err.message);
  }
}

/**********************
 * Clear current month
 **********************/
function clearAllSchedule(){
  if(currentRole!=='admin'){ alert('åªæœ‰ç®¡ç†è€…å¯ä»¥æ¸…ç©ºç­è¡¨'); return; }
  if(!confirm('ç¢ºå®šè¦æ¸…ç©ºç•¶æœˆæ‰€æœ‰ç­è¡¨è³‡æ–™å—ï¼Ÿ')) return;
  const key=`${currentYear}-${currentMonth}`;
  const days=getDaysInMonth(currentYear,currentMonth);
  if(scheduleData.schedules[key] && scheduleData.employees){
    scheduleData.employees.forEach(emp=>{
      for(let d=1; d<=days; d++){
        if(scheduleData.schedules[key][emp.å§“å]){
          scheduleData.schedules[key][emp.å§“å][d]=null;
        }
      }
    });
  }
  saveLocal(); updateCalendar(); alert('ç­è¡¨å·²æ¸…ç©º');
}
  </script>
</body>
</html>
