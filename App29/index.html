<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å“¡å·¥ç­è¡¨ç®¡ç†ç³»çµ±ï¼ˆæ”¹é€²ç‰ˆï¼‰</title>
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWToOW3peePrOihqOeuoeeQhuezuzrkBCIsCiAgInNob3J0X25hbWUiOiAi55+t6KGo566h55CGIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjhmOWZhIiwKICAiaWNvbnMiOiBbXQp9" />
    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(45deg, #667eea, #764ba2);
            --secondary-color: #f8f9fa;
            --text-color: #333;
            --border-color: #e9ecef;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        /* æ·±è‰²æ¨¡å¼ */
        @media (prefers-color-scheme: dark) {
            :root {
                --secondary-color: #2d2d2d;
                --text-color: #ffffff;
                --border-color: #404040;
                --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            body {
                background: #1a1a1a;
                color: var(--text-color);
            }

            .container {
                background: var(--secondary-color);
                border: 1px solid var(--border-color);
            }

            .day-cell {
                background: #3a3a3a;
                border: 1px solid #555;
            }

            .calendar-grid {
                background: #333;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SF Pro Display', 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background: #f8f9fa;
            min-height: 100vh;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1200px;
            min-width: 380px;
            margin: 0 auto;
            background: #fff;
            border-radius: 15px;
            padding: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        /* è¼‰å…¥è¦†è“‹å±¤ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* é€šçŸ¥ç³»çµ± */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .notification {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--info-color);
            animation: slideInRight 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .notification.success { border-left-color: var(--success-color); }
        .notification.warning { border-left-color: var(--warning-color); }
        .notification.error { border-left-color: var(--danger-color); }

        .notification-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.6;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* æ¨™é¡Œå€åŸŸ */
        .header {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0 0 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .role-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--secondary-color);
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid var(--primary-color);
        }

        .role-badge {
            background: var(--primary-gradient);
            color: #fff;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-badge.employee {
            background: linear-gradient(45deg, var(--success-color), #20c997);
        }

        .conn-pill {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .conn-ok {
            background: #e9f9ee;
            color: #1e7e34;
            border-color: var(--success-color);
        }

        .conn-bad {
            background: #fff3cd;
            color: #856404;
            border-color: var(--warning-color);
        }

        .conn-off {
            background: #fdecea;
            color: #721c24;
            border-color: var(--danger-color);
        }

        /* ç®¡ç†å“¡æ¨¡å¼æ§åˆ¶ */
        .admin-only {
            display: none;
        }

        .admin-mode .admin-only {
            display: inline-block;
        }

        .employee-mode .admin-only {
            display: none;
        }

        /* æ¨™ç±¤é  */
        .nav-tabs {
            display: flex;
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            gap: 5px;
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 1rem;
            color: var(--text-color);
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-tab.active {
            background: var(--primary-gradient);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç­è¡¨æ¨™é¡Œå€åŸŸ */
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 15px;
            color: #fff;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .schedule-header h3 {
            margin: 0;
            color: #fff;
            font-weight: 600;
            font-size: 1.4rem;
        }

        .main-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .date-control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .date-control-group label {
            font-weight: 600;
            color: #fff;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .date-control-group select {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .date-control-group select:focus {
            outline: 2px solid var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* åŠŸèƒ½é¢æ¿ */
        .function-panel {
            background: #fff;
            border: 2px solid #e0e6ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .group-label {
            display: inline-block;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 8px;
        }

        .function-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .control-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            background: var(--primary-gradient);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            min-height: 45px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .control-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .control-btn:hover:before {
            left: 100%;
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.small {
            padding: 8px 15px;
            font-size: 0.85rem;
            min-height: 36px;
        }

        .control-btn.success {
            background: linear-gradient(45deg, var(--success-color), #20c997);
        }

        .control-btn.danger {
            background: linear-gradient(45deg, var(--danger-color), #c82333);
        }

        .control-btn.warning {
            background: linear-gradient(45deg, var(--warning-color), #e0a800);
            color: #000;
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-icon {
            font-size: 1.2em;
        }

        /* é¸é …æ§åˆ¶ */
        .export-options {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px 18px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, #e9ecef 100%);
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .option-item:hover {
            background: linear-gradient(135deg, #e7f3ff 0%, #d4e6ff 100%);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .option-item input {
            margin: 0;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        /* ç·¨è¼¯æç¤º */
        .edit-hint {
            display: none;
            background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
            border: 2px solid #b3d7ff;
            border-radius: var(--border-radius);
            padding: 15px 25px;
            margin-bottom: 25px;
            text-align: center;
            color: #0066cc;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(179, 215, 255, 0.3);
        }

        /* è¡Œäº‹æ›†å®¹å™¨ */
        .calendar-container {
            background: var(--secondary-color);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            overflow-x: auto;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e9ecef;
            border-radius: var(--border-radius);
            padding: 8px;
            min-width: 350px;
        }

        .day-header {
            background: var(--primary-gradient);
            color: #fff;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .weekend-header {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important;
        }

        .day-cell {
            background: #fff;
            border-radius: 6px;
            padding: 8px;
            min-height: 120px;
            position: relative;
            transition: all 0.2s ease;
        }

        .day-cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .day-number {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .weekend-cell .day-number {
            color: #ff6b6b;
        }

        .empty-cell {
            background: var(--secondary-color);
            opacity: 0.5;
        }

        .holiday-name {
            font-size: 0.7rem;
            color: var(--danger-color);
            font-weight: 600;
            text-align: right;
            line-height: 1.2;
            max-width: 60px;
        }

        .staff-schedule {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .staff-item {
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            cursor: default;
            transition: all 0.2s ease;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .staff-item.editable {
            cursor: pointer !important;
            border: 1px dashed #007bff !important;
        }

        .staff-item.editable:hover,
        .staff-item.editable.open {
            border: 1px solid #007bff !important;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3) !important;
            transform: scale(1.02);
        }

        /* ç­åˆ¥é¡å‹æ¨£å¼ */
        .work-day {
            background: #d4edda;
            color: #155724;
        }

        .holiday {
            background: #f8d7da;
            color: #721c24;
        }

        .night-shift {
            background: #cce7ff;
            color: #004085;
        }

        .off-day {
            background: var(--secondary-color);
            color: #6c757d;
        }

        /* ä¸‹æ‹‰é¸å–® */
        .edit-dropdown {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 8px;
            z-index: 9999;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.16);
            max-height: 260px;
            overflow-y: auto;
        }

        .edit-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .edit-option:last-child {
            border-bottom: none;
        }

        .edit-option:hover {
            background: var(--secondary-color);
        }

        /* æ¨¡æ…‹æ¡† */
        .employee-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .employee-modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin: 5px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .modal-btn.primary {
            background: var(--primary-gradient);
            color: #fff;
        }

        .modal-btn.secondary {
            background: #6c757d;
            color: #fff;
        }

        .modal-btn.danger {
            background: linear-gradient(45deg, var(--danger-color), #c82333);
            color: #fff;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* å“¡å·¥ç¶²æ ¼ */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .employee-card {
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            position: relative;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .employee-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 12px;
        }

        .employee-info {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .employee-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: none;
            gap: 5px;
        }

        .employee-card:hover .employee-actions {
            display: flex;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 1rem;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 5px;
                border-radius: 10px;
            }

            .role-switcher {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
                flex-wrap: wrap;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .schedule-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
                text-align: center;
            }

            .main-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .function-buttons {
                flex-direction: column;
            }

            .export-options {
                flex-direction: column;
                gap: 10px;
            }

            .calendar-grid {
                grid-template-columns: repeat(7, minmax(45px, 1fr));
                gap: 1px;
            }

            .staff-item {
                font-size: 0.6rem;
                padding: 2px 3px;
                min-height: 22px;
            }

            .day-cell {
                min-height: 80px;
                padding: 4px;
            }

            .employee-grid {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .control-btn {
                min-height: 48px; /* è§¸æ§å‹å–„ */
                font-size: 0.9rem;
            }

            .form-group input,
            .form-group select {
                font-size: 16px; /* é¿å… iOS ç¸®æ”¾ */
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }

        /* åˆ—å°æ¨£å¼ */
        @media print {
            .role-switcher,
            .function-panel,
            .nav-tabs,
            .admin-only {
                display: none !important;
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            .calendar-grid {
                break-inside: avoid;
            }
        }

        /* ç„¦é»å¯è¦‹æ€§ */
        button:focus-visible,
        select:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* å‹•ç•«æ€§èƒ½å„ªåŒ– */
        .calendar-grid,
        .employee-grid,
        .stats {
            contain: layout style paint;
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-message" id="loadingMessage">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <div class="notification-container" id="notificationContainer"></div>

    <div class="container" id="mainContainer">
        <div class="header">
            <h1>å“¡å·¥ç­è¡¨ç®¡ç†ç³»çµ±</h1>
            <div class="role-switcher">
                <span>ç•¶å‰èº«ä»½ï¼š</span>
                <span class="role-badge" id="roleBadge">ç®¡ç†è€…</span>
                <span id="connPill" class="conn-pill conn-off">æœªé€£ç·š</span>
                <button class="control-btn small" onclick="toggleRole()">åˆ‡æ›èº«ä»½</button>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('schedule', event)">æŸ¥çœ‹ç­è¡¨</button>
            <button class="nav-tab admin-only" onclick="showTab('employee', event)">å“¡å·¥ç®¡ç†</button>
            <button class="nav-tab admin-only" onclick="showTab('shift', event)">ç­åˆ¥è¨­å®š</button>
            <button class="nav-tab" onclick="showTab('stats', event)">çµ±è¨ˆå ±è¡¨</button>
        </div>

        <!-- ç­è¡¨æ¨™ç±¤é  -->
        <div id="scheduleTab" class="tab-content active">
            <div class="schedule-header">
                <h3>ğŸ“Š ç­è¡¨æŸ¥çœ‹</h3>
                <div class="main-controls">
                    <div class="date-control-group">
                        <label>é¸æ“‡å¹´æœˆï¼š</label>
                        <select id="yearSelect" onchange="changeYearMonth()">
                            <option>2024</option>
                            <option>2025</option>
                            <option>2026</option>
                        </select>
                        <select id="monthSelect" onchange="changeYearMonth()">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <button class="control-btn success admin-only" id="editModeBtn" onclick="toggleEditMode()">
                        <span class="btn-icon">âœï¸</span> ç·¨è¼¯æ¨¡å¼
                    </button>
                </div>
            </div>

            <div class="function-panel">
                <div class="function-buttons">
                    <button class="control-btn admin-only" onclick="document.getElementById('importFile').click()">
                        <span class="btn-icon">ğŸ“</span> åŒ¯å…¥ç­è¡¨ï¼ˆCSVï¼‰
                    </button>
                    <button class="control-btn admin-only" onclick="exportSchedule()">
                        <span class="btn-icon">ğŸ’¾</span> åŒ¯å‡ºç­è¡¨ï¼ˆCSVï¼‰
                    </button>
                    <button class="control-btn admin-only" onclick="saveAllToCloud()">
                        <span class="btn-icon">â˜ï¸</span> æœ¬æœˆä¸€éµä¸Šå‚³
                    </button>
                    <button class="control-btn danger admin-only" onclick="clearAllScheduleCloud()">
                        <span class="btn-icon">ğŸ—‘ï¸</span> æ¸…ç©ºæœ¬æœˆ
                    </button>
                    <button class="control-btn warning admin-only" onclick="backupData()">
                        <span class="btn-icon">ğŸ’¾</span> å»ºç«‹å‚™ä»½
                    </button>
                </div>
                <div class="export-options" style="margin-top:15px">
                    <label class="option-item">
                        <input type="checkbox" id="filterDefaults" checked>
                        <span>éæ¿¾é è¨­ç­åˆ¥</span>
                    </label>
                    <label class="option-item">
                        <input type="checkbox" id="hideTypeArea" checked>
                        <span>éš±è—é¡å‹æ¬„ä½</span>
                    </label>
                    <label class="option-item">
                        <input type="checkbox" id="autoSave">
                        <span>è‡ªå‹•ä¿å­˜</span>
                    </label>
                </div>
            </div>

            <input type="file" id="importFile" accept=".csv" style="display:none" onchange="importSchedule(event)">
            <div id="editHint" class="edit-hint">
                <span class="btn-icon">âœï¸</span> ç·¨è¼¯æ¨¡å¼é–‹å•Ÿï¼šé»é¸å“¡å·¥æ’ç­é€²è¡Œä¿®æ”¹
            </div>
            
            <div class="calendar-container">
                <div class="calendar-grid" id="calendar"></div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†æ¨™ç±¤é  -->
        <div id="employeeTab" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3>å“¡å·¥ç®¡ç†</h3>
                <button class="control-btn success admin-only" onclick="showEmployeeModal()">
                    <span class="btn-icon">ğŸ‘¥</span> æ–°å¢å“¡å·¥
                </button>
            </div>
            <div class="employee-grid" id="employeeGrid"></div>
        </div>

        <!-- ç­åˆ¥è¨­å®šæ¨™ç±¤é  -->
        <div id="shiftTab" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3>ç­åˆ¥è¨­å®š</h3>
                <button class="control-btn success admin-only" onclick="showShiftSettingsModal()">
                    <span class="btn-icon">â°</span> æ–°å¢ç­åˆ¥
                </button>
            </div>
            <div id="shiftsList"></div>
        </div>

        <!-- çµ±è¨ˆå ±è¡¨æ¨™ç±¤é  -->
        <div id="statsTab" class="tab-content">
            <h3>çµ±è¨ˆå ±è¡¨</h3>
            <div class="stats" id="stats"></div>
        </div>

        <!-- å“¡å·¥æ¨¡æ…‹æ¡† -->
        <div id="employeeModal" class="employee-modal">
            <div class="employee-modal-content">
                <h3>æ–°å¢å“¡å·¥è³‡æ–™</h3>
                <div class="form-group">
                    <label>å“¡å·¥å§“åï¼š</label>
                    <input type="text" id="employeeName" maxlength="20" placeholder="è«‹è¼¸å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>å“¡å·¥é¡å‹ï¼š</label>
                    <div style="display:flex;gap:20px;">
                        <label><input type="radio" name="employeeType" value="fullTime" checked> æ­£è·</label>
                        <label><input type="radio" name="employeeType" value="partTime"> å…¼è·</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>å·¥ä½œå€åŸŸï¼š</label>
                    <div style="display:flex;gap:20px;">
                        <label><input type="radio" name="workArea" value="front" checked> å¤–å ´</label>
                        <label><input type="radio" name="workArea" value="back"> å…§å ´</label>
                    </div>
                </div>
                <div style="text-align:center;margin-top:20px;">
                    <button class="modal-btn primary" onclick="addEmployeeFromModal()">ç¢ºå®šæ–°å¢</button>
                    <button class="modal-btn secondary" onclick="closeEmployeeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- ç­åˆ¥è¨­å®šæ¨¡æ…‹æ¡† -->
        <div id="shiftSettingsModal" class="employee-modal">
            <div class="employee-modal-content">
                <h3>ç­åˆ¥è¨­å®šç®¡ç†</h3>
                <div class="form-group">
                    <label>ç­åˆ¥ä»£ç¢¼ï¼š</label>
                    <input type="text" id="shiftCode" maxlength="10" placeholder="å¦‚ï¼šDAY01">
                </div>
                <div class="form-group">
                    <label>ç­åˆ¥åç¨±ï¼š</label>
                    <input type="text" id="shiftName" maxlength="20" placeholder="å¦‚ï¼šæ—©ç­ã€æ™šç­ã€å€¼ç­">
                </div>
                <div class="form-group">
                    <label>é–‹å§‹æ™‚é–“ï¼š</label>
                    <input type="time" id="startTime" value="09:00">
                </div>
                <div class="form-group">
                    <label>çµæŸæ™‚é–“ï¼š</label>
                    <input type="time" id="endTime" value="18:00">
                </div>
                <div class="form-group">
                    <label>å“¡å·¥é¡å‹ï¼š</label>
                    <select id="shiftType">
                        <option value="fullTime">æ­£è·</option>
                        <option value="partTime">å…¼è·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å·¥ä½œå€åŸŸï¼š</label>
                    <select id="shiftArea">
                        <option value="front">å¤–å ´</option>
                        <option value="back">å…§å ´</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¡¯ç¤ºé¡è‰²ï¼š</label>
                    <input type="color" id="shiftColor" value="#667eea">
                </div>
                <div class="form-group">
                    <label>ç°¡ç¨±ï¼š</label>
                    <input type="text" id="abbreviation" maxlength="4" placeholder="ç”¨æ–¼ç­è¡¨é¡¯ç¤ºçš„ç°¡ç¨±">
                </div>
                <div style="text-align:center;margin-top:10px;">
                    <button class="modal-btn primary" onclick="addEnhancedShift()">æ–°å¢ç­åˆ¥</button>
                    <button class="modal-btn secondary" onclick="closeShiftSettingsModal()">å–æ¶ˆ</button>
                </div>
                <div class="form-group" style="margin-top:20px;">
                    <label>ç¾æœ‰ç­åˆ¥ï¼š</label>
                    <div id="allShiftsList" style="max-height:400px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- ç¢ºèªå°è©±æ¡† -->
        <div id="confirmModal" class="employee-modal">
            <div class="employee-modal-content" style="max-width:420px;text-align:center;">
                <h3>ç¢ºèªæ“ä½œ</h3>
                <p id="confirmMessage" style="margin:20px 0;font-size:1.05rem;">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
                <div style="display:flex;gap:10px;justify-content:center;">
                    <button class="modal-btn danger" onclick="confirmAction()">ç¢ºå®š</button>
                    <button class="modal-btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dropdown-portal"></div>

    <script>
        /* ========= è¨­å®šèˆ‡é…ç½® ========= */
        const CONFIG = {
            GAS_URL: 'https://script.google.com/macros/s/AKfycbz0fOrHTZSIZhCquU1-PJSRQzojlHrvazwcE8ccVOYc2QKInnadW1toPBJ5JHlKKYiq/exec',
            API_KEY: ['1300E8N6COIZYJ97YJFFD2A5L1IC4SZ7', 'ID2UTUS031MF9VULRB24OFOIGOW72FFA'], // è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›APIå¯†é‘°
            FETCH_TIMEOUT_MS: 10000,
            RETRIES: 2,
            AUTO_SAVE_DELAY: 3000,
            CACHE_DURATION: 300000 // 5åˆ†é˜
        };

        /* ========= å…¨åŸŸç‹€æ…‹ç®¡ç† ========= */
        class StateManager {
            constructor() {
                this.scheduleData = { employees: [], schedules: {} };
                this.shiftSettings = { allShifts: [] };
                this.cache = new Map();
                this.isOnline = navigator.onLine;
                this.pendingOperations = this.loadPendingOperations();
                this.init();
            }

            init() {
                // ç›£è½ç¶²è·¯ç‹€æ…‹
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncPendingOperations();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });
            }

            loadPendingOperations() {
                try {
                    return JSON.parse(localStorage.getItem('pendingOps') || '[]');
                } catch {
                    return [];
                }
            }

            addPendingOperation(operation) {
                this.pendingOperations.push({
                    ...operation,
                    timestamp: Date.now(),
                    id: Date.now() + Math.random()
                });
                localStorage.setItem('pendingOps', JSON.stringify(this.pendingOperations));
            }

            async syncPendingOperations() {
                if (this.pendingOperations.length === 0) return;

                showNotification('æ­£åœ¨åŒæ­¥é›¢ç·šæ“ä½œ...', 'info');
                
                for (const op of [...this.pendingOperations]) {
                    try {
                        await callApi(op.action, op.data);
                        this.pendingOperations = this.pendingOperations.filter(p => p.id !== op.id);
                    } catch (error) {
                        console.error('åŒæ­¥æ“ä½œå¤±æ•—:', error);
                        break; // åœæ­¢åŒæ­¥ï¼Œä¿ç•™å‰©é¤˜æ“ä½œ
                    }
                }

                localStorage.setItem('pendingOps', JSON.stringify(this.pendingOperations));
                
                if (this.pendingOperations.length === 0) {
                    showNotification('æ‰€æœ‰é›¢ç·šæ“ä½œå·²åŒæ­¥å®Œæˆ', 'success');
                }
            }

            setCache(key, data) {
                this.cache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }

            getCache(key) {
                const cached = this.cache.get(key);
                if (cached && (Date.now() - cached.timestamp) < CONFIG.CACHE_DURATION) {
                    return cached.data;
                }
                return null;
            }

            clearCache(pattern = null) {
                if (pattern) {
                    for (const key of this.cache.keys()) {
                        if (key.includes(pattern)) {
                            this.cache.delete(key);
                        }
                    }
                } else {
                    this.cache.clear();
                }
            }
        }

        /* ========= è¼‰å…¥ç®¡ç†å™¨ ========= */
        class LoadingManager {
            constructor() {
                this.activeRequests = 0;
                this.overlay = document.getElementById('loadingOverlay');
                this.message = document.getElementById('loadingMessage');
            }

            show(message = 'è¼‰å…¥ä¸­...') {
                this.activeRequests++;
                this.message.textContent = message;
                this.overlay.style.display = 'flex';
            }

            hide() {
                this.activeRequests = Math.max(0, this.activeRequests - 1);
                if (this.activeRequests === 0) {
                    this.overlay.style.display = 'none';
                }
            }

            setMessage(message) {
                this.message.textContent = message;
            }
        }

        /* ========= é€šçŸ¥ç³»çµ± ========= */
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <button class="notification-close" onclick="this.parentElement.remove()">Ã—</button>
                <div>${message}</div>
            `;

            container.appendChild(notification);

            // è‡ªå‹•ç§»é™¤
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);

            // é»æ“Šç§»é™¤
            notification.addEventListener('click', () => notification.remove());

            return notification;
        }

        /* ========= éŒ¯èª¤è¿½è¹¤ ========= */
        class ErrorTracker {
            static track(error, context = {}) {
                const errorInfo = {
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    context
                };

                // è¨˜éŒ„åˆ°æ§åˆ¶å°
                console.error('è¿½è¹¤éŒ¯èª¤:', errorInfo);

                // å„²å­˜åˆ°æœ¬åœ°ï¼ˆä¾›èª¿è©¦ç”¨ï¼‰
                try {
                    const errors = JSON.parse(localStorage.getItem('errorLog') || '[]');
                    errors.push(errorInfo);
                    if (errors.length > 50) errors.shift(); // åªä¿ç•™æœ€è¿‘50å€‹
                    localStorage.setItem('errorLog', JSON.stringify(errors));
                } catch (e) {
                    console.error('ç„¡æ³•å„²å­˜éŒ¯èª¤è¨˜éŒ„:', e);
                }

                // é¡¯ç¤ºç”¨æˆ¶å‹å–„çš„éŒ¯èª¤è¨Šæ¯
                showNotification(
                    `æ“ä½œå¤±æ•—ï¼š${error.message}`,
                    'error',
                    8000
                );
            }
        }

        /* ========= é˜²æŠ–å‹•å‡½æ•¸ ========= */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /* ========= API å‘¼å«ç®¡ç† ========= */
        function setConnPill(state, msg) {
            const pill = document.getElementById('connPill');
            pill.textContent = msg || (state === 'ok' ? 'å·²é€£ç·š' : state === 'bad' ? 'é€£ç·šä¸ç©©' : 'æœªé€£ç·š');
            pill.className = 'conn-pill ' + (state === 'ok' ? 'conn-ok' : state === 'bad' ? 'conn-bad' : 'conn-off');
        }

        async function callApi(action, data = {}, method = 'POST', retry = 0) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), CONFIG.FETCH_TIMEOUT_MS);
            
            try {
                loadingManager.show(`åŸ·è¡Œ ${action}...`);
                
                // æª¢æŸ¥å¿«å–
                if (method === 'GET') {
                    const cacheKey = `${action}_${JSON.stringify(data)}`;
                    const cached = stateManager.getCache(cacheKey);
                    if (cached) {
                        loadingManager.hide();
                        return cached;
                    }
                }

                const url = method === 'GET'
                    ? `${CONFIG.GAS_URL}?action=${encodeURIComponent(action)}&apikey=${encodeURIComponent(CONFIG.API_KEY)}&` + new URLSearchParams(data)
                    : CONFIG.GAS_URL;

                const requestData = {
                    action,
                    data,
                    apikey: CONFIG.API_KEY,
                    user: currentRole,
                    timestamp: Date.now()
                };

                const response = await fetch(url, {
                    method,
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: method === 'POST' ? JSON.stringify(requestData) : undefined,
                    signal: controller.signal
                });

                if (!response.ok) {
                    const errorText = await response.text().catch(() => '');
                    throw new Error(`HTTP ${response.status}: ${errorText.slice(0, 200)}`);
                }

                const result = await response.json();
                
                if (!result.ok) {
                    throw new Error(result.message || `API ${action} å¤±æ•—`);
                }

                // æ›´æ–°é€£ç·šç‹€æ…‹
                setConnPill('ok', 'å·²é€£ç·š');

                // å¿«å– GET è«‹æ±‚çµæœ
                if (method === 'GET') {
                    const cacheKey = `${action}_${JSON.stringify(data)}`;
                    stateManager.setCache(cacheKey, result);
                }

                return result;

            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('è«‹æ±‚é€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                }

                // é‡è©¦é‚è¼¯
                if (retry < CONFIG.RETRIES && !error.message.includes('Unauthorized')) {
                    setConnPill('bad', `é‡è©¦ä¸­... (${retry + 1}/${CONFIG.RETRIES})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * (retry + 1)));
                    return callApi(action, data, method, retry + 1);
                }

                // é›¢ç·šè™•ç†
                if (!stateManager.isOnline && method === 'POST') {
                    stateManager.addPendingOperation({ action, data });
                    showNotification('å·²å„²å­˜åˆ°é›¢ç·šä½‡åˆ—ï¼Œå°‡åœ¨é€£ç·šå¾Œè‡ªå‹•åŒæ­¥', 'warning');
                    throw new Error('ç›®å‰é›¢ç·šï¼Œæ“ä½œå·²åŠ å…¥åŒæ­¥ä½‡åˆ—');
                }

                setConnPill('off', 'é€£ç·šå¤±æ•—');
                ErrorTracker.track(error, { action, data, retry });
                throw error;

            } finally {
                clearTimeout(timeout);
                loadingManager.hide();
            }
        }

        /* ========= åˆå§‹åŒ– ========= */
        const stateManager = new StateManager();
        const loadingManager = new LoadingManager();

        // å…¶ä»–å…¨åŸŸè®Šæ•¸
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth() + 1;
        let isEditMode = false;
        let currentRole = 'admin';
        let currentEditElement = null;
        let currentDropdown = null;
        let repositionHandlersBound = false;
        let pendingAction = null;
        let pendingActionData = null;

        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const holidays = { 2024: {}, 2025: {}, 2026: {} };

        // å°ç£å‡æ—¥è³‡æ–™
        const taiwanHolidaysData = {
            2024: { '1/1': 'å…ƒæ—¦', '2/10': 'é™¤å¤•', '2/11': 'æ˜¥ç¯€', '2/12': 'åˆäºŒ', '2/13': 'åˆä¸‰', '2/14': 'åˆå››', '2/28': 'å’Œå¹³ç´€å¿µæ—¥', '4/4': 'å…’ç«¥ç¯€', '4/5': 'æ¸…æ˜ç¯€', '5/1': 'å‹å‹•ç¯€', '6/10': 'ç«¯åˆç¯€', '9/17': 'ä¸­ç§‹ç¯€', '10/10': 'åœ‹æ…¶æ—¥' },
            2025: { '1/1': 'å…ƒæ—¦', '1/28': 'é™¤å¤•', '1/29': 'æ˜¥ç¯€', '1/30': 'åˆäºŒ', '1/31': 'åˆä¸‰', '2/1': 'åˆå››', '2/28': 'å’Œå¹³ç´€å¿µæ—¥', '4/4': 'å…’ç«¥ç¯€', '4/5': 'æ¸…æ˜ç¯€', '5/1': 'å‹å‹•ç¯€', '5/31': 'ç«¯åˆç¯€', '10/6': 'ä¸­ç§‹ç¯€', '10/10': 'åœ‹æ…¶æ—¥' },
            2026: { '1/1': 'å…ƒæ—¦', '2/16': 'é™¤å¤•', '2/17': 'æ˜¥ç¯€', '2/18': 'åˆäºŒ', '2/19': 'åˆä¸‰', '2/20': 'åˆå››', '2/28': 'å’Œå¹³ç´€å¿µæ—¥', '4/4': 'å…’ç«¥ç¯€', '4/5': 'æ¸…æ˜ç¯€', '5/1': 'å‹å‹•ç¯€', '6/19': 'ç«¯åˆç¯€', '9/25': 'ä¸­ç§‹ç¯€', '10/10': 'åœ‹æ…¶æ—¥' }
        };

        /* ========= è¼”åŠ©å‡½æ•¸ ========= */
        function loadTaiwanHolidays() {
            Object.assign(holidays[2024], taiwanHolidaysData[2024]);
            Object.assign(holidays[2025], taiwanHolidaysData[2025]);
            Object.assign(holidays[2026], taiwanHolidaysData[2026]);
        }

        function getHolidayName(year, month, day) {
            const key = `${month}/${day}`;
            return holidays[year] && holidays[year][key] ? holidays[year][key] : null;
        }

        function getDaysInMonth(year, month) { 
            return new Date(year, month, 0).getDate(); 
        }

        function getFirstDayOfWeek(year, month) { 
            return new Date(year, month - 1, 1).getDay(); 
        }

        function isWeekend(year, month, day) { 
            const date = new Date(year, month - 1, day); 
            const dayOfWeek = date.getDay(); 
            return dayOfWeek === 0 || dayOfWeek === 6; 
        }

        function sortEmployees(employees) {
            const order = { 
                'front-fullTime': 1, 
                'front-partTime': 2, 
                'back-fullTime': 3, 
                'back-partTime': 4 
            };
            return employees.sort((a, b) => 
                (order[`${a.å€åŸŸ}-${a.é¡å‹}`] || 9) - (order[`${b.å€åŸŸ}-${b.é¡å‹}`] || 9)
            );
        }

        function getShiftTypeClass(category) {
            switch (category) {
                case 'work': return 'work-day';
                case 'holiday': return 'holiday';
                case 'night': return 'night-shift';
                case 'off': return 'off-day';
                default: return 'work-day';
            }
        }

        function getStaffClass(schedule, type) {
            if (schedule === null) {
                return type === 'fullTime' ? 'work-day' : 'off-day';
            }
            
            const shift = stateManager.shiftSettings.allShifts.find(s => s.name === schedule);
            if (shift) {
                return getShiftTypeClass(shift.category);
            }
            
            if (/ä¼‘|å‡/.test(schedule)) return 'holiday';
            if (/:|-|å¤œ|æ™š/.test(schedule)) return 'night-shift';
            return 'work-day';
        }

        function getStaffDisplay(name, schedule, type) {
            if (schedule === null) {
                return `${name} ${type === 'fullTime' ? 'ç­' : ''}`;
            }
            
            const shift = stateManager.shiftSettings.allShifts.find(s => s.name === schedule);
            if (shift && shift.abbreviation) {
                return `${name} ${shift.abbreviation}`;
            }
            
            let displayText = schedule;
            if (displayText === 'ä¼‘å‡') displayText = 'ä¼‘';
            else if (displayText === 'ç‰¹ä¼‘') displayText = 'ç‰¹';
            else if (displayText.includes('17:00-23:00')) displayText = '17-23';
            else if (displayText.includes('18:00-24:00')) displayText = '18-24';
            else if (displayText.length > 4) displayText = displayText.slice(0, 4);
            
            return `${name} ${displayText}`;
        }

        /* ========= è‡ªå‹•ä¿å­˜åŠŸèƒ½ ========= */
        const debouncedAutoSave = debounce(async () => {
            if (!document.getElementById('autoSave').checked) return;
            
            try {
                await saveAllToCloud();
                showNotification('è‡ªå‹•ä¿å­˜æˆåŠŸ', 'success', 3000);
            } catch (error) {
                console.error('è‡ªå‹•ä¿å­˜å¤±æ•—:', error);
            }
        }, CONFIG.AUTO_SAVE_DELAY);

        /* ========= UI æ§åˆ¶å‡½æ•¸ ========= */
        function toggleRole() {
            currentRole = currentRole === 'admin' ? 'employee' : 'admin';
            updateRoleDisplay();
        }

        function updateRoleDisplay() {
            const container = document.getElementById('mainContainer');
            const badge = document.getElementById('roleBadge');
            
            if (currentRole === 'admin') {
                container.className = 'container admin-mode';
                badge.textContent = 'ç®¡ç†è€…';
                badge.className = 'role-badge';
            } else {
                container.className = 'container employee-mode';
                badge.textContent = 'å“¡å·¥';
                badge.className = 'role-badge employee';
            }
        }

        function showTab(name, event) {
            // ç§»é™¤æ‰€æœ‰ active é¡åˆ¥
            document.querySelectorAll('.tab-content').forEach(tab => 
                tab.classList.remove('active')
            );
            document.querySelectorAll('.nav-tab').forEach(tab => 
                tab.classList.remove('active')
            );

            // æ·»åŠ  active é¡åˆ¥
            document.getElementById(name + 'Tab').classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // æ ¹æ“šæ¨™ç±¤é è¼‰å…¥å…§å®¹
            switch (name) {
                case 'employee':
                    updateEmployeeGrid();
                    break;
                case 'shift':
                    updateShiftDisplay();
                    break;
                case 'stats':
                    updateStats();
                    break;
            }
        }

        async function changeYearMonth() {
            currentYear = parseInt(document.getElementById('yearSelect').value, 10);
            currentMonth = parseInt(document.getElementById('monthSelect').value, 10);
            await loadMonth(currentYear, currentMonth);
        }

        /* ========= è³‡æ–™è¼‰å…¥ ========= */
        async function loadMonth(year, month) {
            try {
                const data = await callApi('getMonth', { year, month }, 'GET');
                
                stateManager.scheduleData = {
                    employees: data.employees || [],
                    schedules: { [`${year}-${month}`]: data.schedules || {} }
                };
                stateManager.shiftSettings = { 
                    allShifts: data.shifts || [] 
                };
                
                updateCalendar();
                updateEmployeeGrid();
                
                showNotification(`å·²è¼‰å…¥ ${year}å¹´${month}æœˆ è³‡æ–™`, 'success', 3000);
                
            } catch (error) {
                ErrorTracker.track(error, { year, month });
                throw error;
            }
        }

        /* ========= ç­è¡¨é¡¯ç¤ºèˆ‡ç·¨è¼¯ ========= */
        function ensureScheduleData(year, month) {
            const key = `${year}-${month}`;
            if (!stateManager.scheduleData.schedules[key]) {
                stateManager.scheduleData.schedules[key] = {};
            }
            
            const daysInMonth = getDaysInMonth(year, month);
            stateManager.scheduleData.employees.forEach(employee => {
                if (!stateManager.scheduleData.schedules[key][employee.å§“å]) {
                    stateManager.scheduleData.schedules[key][employee.å§“å] = {};
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    if (!stateManager.scheduleData.schedules[key][employee.å§“å].hasOwnProperty(day)) {
                        stateManager.scheduleData.schedules[key][employee.å§“å][day] = null;
                    }
                }
            });
        }

        function updateCalendar() {
            ensureScheduleData(currentYear, currentMonth);
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            // å‰µå»ºæ˜ŸæœŸæ¨™é¡Œ
            weekdays.forEach((weekday, index) => {
                const header = document.createElement('div');
                header.className = 'day-header' + (index === 0 || index === 6 ? ' weekend-header' : '');
                header.textContent = weekday;
                calendar.appendChild(header);
            });

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDayOfWeek = getFirstDayOfWeek(currentYear, currentMonth);

            // å‰µå»ºç©ºç™½æ ¼å­
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty-cell';
                calendar.appendChild(emptyCell);
            }

            const scheduleKey = `${currentYear}-${currentMonth}`;

            // å‰µå»ºæ—¥æœŸæ ¼å­
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (isWeekend(currentYear, currentMonth, day)) {
                    dayCell.classList.add('weekend-cell');
                }

                // æ—¥æœŸæ¨™é¡Œå€åŸŸ
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                headerDiv.appendChild(dayNumber);

                // å‡æ—¥åç¨±
                const holidayName = getHolidayName(currentYear, currentMonth, day);
                if (holidayName) {
                    const holidayElement = document.createElement('div');
                    holidayElement.className = 'holiday-name';
                    holidayElement.textContent = holidayName;
                    headerDiv.appendChild(holidayElement);
                }

                dayCell.appendChild(headerDiv);

                // å“¡å·¥æ’ç­å€åŸŸ
                const staffSchedule = document.createElement('div');
                staffSchedule.className = 'staff-schedule';

                const sortedEmployees = sortEmployees([...stateManager.scheduleData.employees]);
                sortedEmployees.forEach(employee => {
                    const schedule = stateManager.scheduleData.schedules[scheduleKey]?.[employee.å§“å]?.[day] ?? null;
                    
                    const staffItem = document.createElement('div');
                    staffItem.className = `staff-item ${getStaffClass(schedule, employee.é¡å‹)}`;
                    staffItem.textContent = getStaffDisplay(employee.å§“å, schedule, employee.é¡å‹);

                    // ç·¨è¼¯æ¨¡å¼
                    if (isEditMode && currentRole === 'admin') {
                        staffItem.classList.add('editable');
                        staffItem.addEventListener('pointerdown', (event) => {
                            event.stopPropagation();
                            editSchedule(staffItem, employee.å§“å, day);
                        }, { passive: true });
                    }

                    staffSchedule.appendChild(staffItem);
                });

                dayCell.appendChild(staffSchedule);
                calendar.appendChild(dayCell);
            }
        }

        function toggleEditMode() {
            if (currentRole !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†è€…å¯ä»¥ç·¨è¼¯ç­è¡¨', 'warning');
                return;
            }

            isEditMode = !isEditMode;
            const editButton = document.getElementById('editModeBtn');
            const editHint = document.getElementById('editHint');
            
            closeEditDropdown();

            if (isEditMode) {
                editButton.innerHTML = '<span class="btn-icon">âœ…</span> å®Œæˆç·¨è¼¯';
                editButton.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                editHint.style.display = 'block';
            } else {
                editButton.innerHTML = '<span class="btn-icon">âœï¸</span> ç·¨è¼¯æ¨¡å¼';
                editButton.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                editHint.style.display = 'none';
            }

            updateCalendar();
        }

        /* ========= ä¸‹æ‹‰é¸å–®ç·¨è¼¯ ========= */
        function bindGlobalRepositionHandlers() {
            if (repositionHandlersBound) return;
            repositionHandlersBound = true;
            window.addEventListener('scroll', repositionDropdown, true);
            window.addEventListener('resize', repositionDropdown, true);
        }

        function unbindGlobalRepositionHandlers() {
            if (!repositionHandlersBound) return;
            repositionHandlersBound = false;
            window.removeEventListener('scroll', repositionDropdown, true);
            window.removeEventListener('resize', repositionDropdown, true);
        }

        function repositionDropdown() {
            if (!currentEditElement || !currentDropdown) return;

            const rect = currentEditElement.getBoundingClientRect();
            const marginY = 6;
            const dropdownWidth = 240;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            let left = rect.left;
            if (left + dropdownWidth > viewportWidth - 8) {
                left = Math.max(8, viewportWidth - dropdownWidth - 8);
            }

            let top = rect.bottom + marginY;
            const dropdownHeight = Math.min(260, currentDropdown.scrollHeight + 4);
            if (top + dropdownHeight > viewportHeight - 8) {
                top = Math.max(8, rect.top - marginY - dropdownHeight);
            }

            currentDropdown.style.left = `${Math.round(left)}px`;
            currentDropdown.style.top = `${Math.round(top)}px`;
            currentDropdown.style.width = `${dropdownWidth}px`;
        }

        function buildDropdownOptionsFor(employee) {
            const options = getScheduleOptions(employee.é¡å‹, employee.å€åŸŸ);
            const fragment = document.createDocumentFragment();

            if (!options.length) {
                const noOptionsElement = document.createElement('div');
                noOptionsElement.className = 'edit-option';
                noOptionsElement.textContent = 'æ²’æœ‰å¯ç”¨çš„ç­åˆ¥';
                noOptionsElement.style.color = '#666';
                noOptionsElement.style.textAlign = 'center';
                fragment.appendChild(noOptionsElement);
                return fragment;
            }

            options.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'edit-option';
                optionElement.textContent = option.label;
                
                optionElement.addEventListener('pointerdown', async (event) => {
                    event.stopPropagation();
                    const employeeName = currentDropdown?.dataset?.empName;
                    const day = Number(currentDropdown?.dataset?.day);
                    
                    if (employeeName && day) {
                        await updateScheduleCell(employeeName, day, option.value);
                        closeEditDropdown();
                    }
                }, { passive: true });

                fragment.appendChild(optionElement);
            });

            return fragment;
        }

        function editSchedule(element, employeeName, day) {
            if (currentEditElement === element && currentDropdown) {
                closeEditDropdown();
                return;
            }

            closeEditDropdown();
            element.classList.add('open');
            currentEditElement = element;

            const portal = document.getElementById('dropdown-portal') || document.body;
            const dropdown = document.createElement('div');
            dropdown.className = 'edit-dropdown';
            dropdown.dataset.empName = employeeName;
            dropdown.dataset.day = String(day);

            const employee = stateManager.scheduleData.employees.find(emp => emp.å§“å === employeeName);
            if (employee) {
                dropdown.appendChild(buildDropdownOptionsFor(employee));
            }

            dropdown.style.visibility = 'hidden';
            portal.appendChild(dropdown);
            currentDropdown = dropdown;

            repositionDropdown();
            dropdown.style.visibility = 'visible';

            document.addEventListener('pointerdown', onDocumentPointerDown, true);
            bindGlobalRepositionHandlers();
        }

        function onDocumentPointerDown(event) {
            if (!currentDropdown) return;

            const path = event.composedPath ? event.composedPath() : [];
            const clickedInside = path.includes(currentDropdown);
            const clickedOnInvoker = path.includes(currentEditElement);

            if (!clickedInside && !clickedOnInvoker) {
                closeEditDropdown();
            }
        }

        function closeEditDropdown() {
            if (currentDropdown && currentDropdown.parentNode) {
                currentDropdown.parentNode.removeChild(currentDropdown);
            }
            currentDropdown = null;

            if (currentEditElement) {
                currentEditElement.classList.remove('open');
                currentEditElement = null;
            }

            document.removeEventListener('pointerdown', onDocumentPointerDown, true);
            unbindGlobalRepositionHandlers();
        }

        /* ========= æ’ç¨‹æ“ä½œ ========= */
        async function updateScheduleCell(employeeName, day, value) {
            const scheduleKey = `${currentYear}-${currentMonth}`;
            const previousValue = stateManager.scheduleData.schedules[scheduleKey][employeeName][day] ?? null;

            // ç«‹å³æ›´æ–° UI
            stateManager.scheduleData.schedules[scheduleKey][employeeName][day] = value ?? null;
            updateCalendar();

            try {
                await callApi('updateSchedule', {
                    year: currentYear,
                    month: currentMonth,
                    name: employeeName,
                    day,
                    value
                });

                // è§¸ç™¼è‡ªå‹•ä¿å­˜
                debouncedAutoSave();

            } catch (error) {
                // å›æ»¾ UI è®Šæ›´
                stateManager.scheduleData.schedules[scheduleKey][employeeName][day] = previousValue;
                updateCalendar();
                throw error;
            }
        }

        function getScheduleOptions(employeeType, employeeArea) {
            const shifts = stateManager.shiftSettings.allShifts.filter(shift => 
                shift.type === employeeType && shift.area === employeeArea
            );

            const options = [{
                value: null,
                label: employeeType === 'fullTime' ? 'ä¸Šç­' : 'ä¼‘æ¯'
            }];

            shifts.forEach(shift => {
                if (shift.name !== 'ä¸Šç­' && shift.name !== 'ä¼‘æ¯') {
                    options.push({
                        value: shift.name,
                        label: shift.name
                    });
                }
            });

            return options;
        }

        /* ========= æ‰¹æ¬¡æ“ä½œ ========= */
        async function saveAllToCloud() {
            if (currentRole !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†è€…å¯ä»¥åŸ·è¡Œæ­¤æ“ä½œ', 'warning');
                return;
            }

            const scheduleKey = `${currentYear}-${currentMonth}`;
            const payload = {
                employees: stateManager.scheduleData.employees,
                shifts: stateManager.shiftSettings.allShifts,
                year: currentYear,
                month: currentMonth,
                schedules: stateManager.scheduleData.schedules[scheduleKey]
            };

            await callApi('saveAll', payload);
            await loadMonth(currentYear, currentMonth);
            showNotification('æœ¬æœˆè³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯', 'success');
        }

        async function clearAllScheduleCloud() {
            if (currentRole !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†è€…å¯ä»¥æ¸…ç©ºç­è¡¨', 'warning');
                return;
            }

            if (!confirm(`ç¢ºå®šæ¸…ç©º ${currentYear} å¹´ ${currentMonth} æœˆçš„ç­è¡¨å—ï¼Ÿ`)) {
                return;
            }

            await callApi('clearMonth', { year: currentYear, month: currentMonth });
            await loadMonth(currentYear, currentMonth);
            showNotification('å·²æ¸…ç©ºæœ¬æœˆç­è¡¨', 'success');
        }

        async function backupData() {
            if (currentRole !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†è€…å¯ä»¥å»ºç«‹å‚™ä»½', 'warning');
                return;
            }

            await callApi('backup', {});
            showNotification('è³‡æ–™å‚™ä»½å·²å»ºç«‹', 'success');
        }

        /* ========= å“¡å·¥ç®¡ç† ========= */
        function showEmployeeModal() {
            if (currentRole !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†è€…å¯ä»¥æ–°å¢å“¡å·¥', 'warning');
                return;
            }
            document.getElementById('employeeModal').style.display = 'block';
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').style.display = 'none';
            document.getElementById('employeeName').value = '';
            document.querySelector('input[name="employeeType"][value="fullTime"]').checked = true;
            document.querySelector('input[name="workArea"][value="front"]').checked = true;
        }

        async function addEmployeeFromModal() {
            const name = document.getElementById('employeeName').value.trim();
            const type = document.querySelector('input[name="employeeType"]:checked').value;
            const area = document.querySelector('input[name="workArea"]:checked').value;

            if (!name) {
                showNotification('è«‹è¼¸å…¥å“¡å·¥å§“å', 'warning');
                return;
            }

            try {
                await callApi('addEmployee', { name, type, area });
                closeEmployeeModal();
                await loadMonth(currentYear, currentMonth);
                showNotification(`å“¡å·¥ ${name} æ–°å¢æˆåŠŸ`, 'success');
            } catch (error) {
                // éŒ¯èª¤å·²ç”± ErrorTracker è™•ç†
            }
        }

        function updateEmployeeGrid() {
            const grid = document.getElementById('employeeGrid');
            grid.innerHTML = '';

            if (!stateManager.scheduleData.employees.length) {
                grid.innerHTML = '<p style="text-align:center;color:#666;grid-column:1/-1;">ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>';
                return;
            }

            stateManager.scheduleData.employees.forEach(employee => {
                const card = document.createElement('div');
                card.className = 'employee-card';

                const typeText = employee.é¡å‹ === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
                const areaText = employee.å€åŸŸ === 'front' ? 'å¤–å ´' : 'å…§å ´';

                card.innerHTML = `
                    <div class="employee-name">${employee.å§“å}</div>
                    <div class="employee-info">é¡å‹ï¼š${typeText}</div>
                    <div class="employee-info">å€åŸŸï¼š${areaText}</div>
                `;

                if (currentRole === 'admin') {
                    const actions = document.createElement('div');
                    actions.className = 'employee-actions';
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'control-btn small danger';
                    deleteButton.textContent = 'åˆªé™¤';
                    deleteButton.onclick = () => removeEmployeeConfirm(employee.å§“å);
                    
                    actions.appendChild(deleteButton);
                    card.appendChild(actions);
                }

                grid.appendChild(card);
            });
        }

        function removeEmployeeConfirm(employeeName) {
            pendingAction = 'removeEmployee';
            pendingActionData = employeeName;
            document.getElementById('confirmMessage').textContent = `ç¢ºå®šè¦åˆªé™¤å“¡å·¥ã€Œ${employeeName}ã€å—ï¼Ÿ`;
            document.getElementById('confirmModal').style.display = 'block';
        }

        async function removeEmployeeCloud(employeeName) {
            await callApi('removeEmployee', { name: employeeName });
            await loadMonth(currentYear, currentMonth);
            showNotification(`å“¡å·¥ ${employeeName} å·²åˆªé™¤`, 'success');
        }

        /* ========= ç­åˆ¥ç®¡ç† ========= */
        function showShiftSettingsModal() {
            if (currentRole !== 'admin') {
                showNotification('åªæœ‰ç®¡ç†è€…å¯ä»¥è¨­å®šç­åˆ¥', 'warning');
                return;
            }
            updateShiftDisplay();
            document.getElementById('shiftSettingsModal').style.display = 'block';
        }

        function closeShiftSettingsModal() {
            document.getElementById('shiftSettingsModal').style.display = 'none';
            clearShiftForm();
        }

        function clearShiftForm() {
            document.getElementById('shiftCode').value = '';
            document.getElementById('shiftName').value = '';
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '18:00';
            document.getElementById('shiftType').value = 'fullTime';
            document.getElementById('shiftArea').value = 'front';
            document.getElementById('shiftColor').value = '#667eea';
            document.getElementById('abbreviation').value = '';
        }

        async function addEnhancedShift() {
            const shiftData = {
                code: document.getElementById('shiftCode').value.trim(),
                name: document.getElementById('shiftName').value.trim(),
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                type: document.getElementById('shiftType').value,
                area: document.getElementById('shiftArea').value,
                color: document.getElementById('shiftColor').value,
                abbreviation: document.getElementById('abbreviation').value.trim()
            };

            if (!shiftData.code || !shiftData.name) {
                showNotification('è«‹è¼¸å…¥ç­åˆ¥ä»£ç¢¼èˆ‡åç¨±', 'warning');
                return;
            }

            try {
                await callApi('addShift', shiftData);
                await loadMonth(currentYear, currentMonth);
                clearShiftForm();
                showNotification(`ç­åˆ¥ ${shiftData.name} æ–°å¢æˆåŠŸ`, 'success');
            } catch (error) {
                // éŒ¯èª¤å·²ç”± ErrorTracker è™•ç†
            }
        }

        function updateShiftDisplay() {
            const list = document.getElementById('allShiftsList');
            list.innerHTML = '';

            if (!stateManager.shiftSettings.allShifts.length) {
                list.innerHTML = '<p style="color:#666;">ç›®å‰å°šç„¡ç­åˆ¥ï¼Œè«‹æ–°å¢ã€‚</p>';
                return;
            }

            stateManager.shiftSettings.allShifts.forEach(shift => {
                const card = document.createElement('div');
                card.className = 'shift-card';
                card.style.cssText = `
                    border-left: 4px solid ${shift.color || '#667eea'};
                    background: #f8f9fa;
                    padding: 15px;
                    margin-bottom: 10px;
                    border-radius: 8px;
                    position: relative;
                `;

                const timeRange = `${shift.startTime} - ${shift.endTime}`;
                const typeText = shift.type === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
                const areaText = shift.area === 'front' ? 'å¤–å ´' : 'å…§å ´';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: #333;">${shift.name}</div>
                        <span style="background: #e9ecef; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">${shift.code}</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #666; line-height: 1.4;">
                        <div><strong>æ™‚é–“ï¼š</strong>${timeRange}</div>
                        <div><strong>é¡å‹ï¼š</strong>${typeText}</div>
                        <div><strong>å€åŸŸï¼š</strong>${areaText}</div>
                        <div><strong>ç°¡ç¨±ï¼š</strong>${shift.abbreviation || ''}</div>
                    </div>
                `;

                if (!['ä¸Šç­', 'ä¼‘æ¯'].includes(shift.name) && currentRole === 'admin') {
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'control-btn small danger';
                    deleteButton.textContent = 'åˆªé™¤';
                    deleteButton.style.cssText = 'position: absolute; top: 10px; right: 10px;';
                    deleteButton.onclick = () => deleteShiftCloud(shift.code);
                    card.appendChild(deleteButton);
                }

                list.appendChild(card);
            });
        }

        async function deleteShiftCloud(shiftCode) {
            if (!confirm(`ç¢ºå®šåˆªé™¤ç­åˆ¥ ${shiftCode}ï¼Ÿ`)) return;

            try {
                await callApi('deleteShift', { code: shiftCode });
                await loadMonth(currentYear, currentMonth);
                showNotification(`ç­åˆ¥ ${shiftCode} å·²åˆªé™¤`, 'success');
            } catch (error) {
                // éŒ¯èª¤å·²ç”± ErrorTracker è™•ç†
            }
        }

        /* ========= åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½ ========= */
        function exportSchedule() {
            const csv = generateCSV(
                document.getElementById('filterDefaults').checked,
                document.getElementById('hideTypeArea').checked
            );
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ç­è¡¨_${currentYear}å¹´${currentMonth}æœˆ_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            
            showNotification('ç­è¡¨å·²åŒ¯å‡º', 'success');
        }

        function generateCSV(filterDefaults = false, hideTypeArea = false) {
            if (!stateManager.scheduleData.employees.length) return '';

            const headers = ['å§“å'];
            if (!hideTypeArea) {
                headers.push('é¡å‹', 'å€åŸŸ');
            }

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            for (let day = 1; day <= daysInMonth; day++) {
                headers.push(`${currentMonth}/${day}`);
            }

            const scheduleKey = `${currentYear}-${currentMonth}`;
            let csv = headers.join(',') + '\n';

            const sortedEmployees = sortEmployees([...stateManager.scheduleData.employees]);
            
            sortedEmployees.forEach(employee => {
                const typeText = employee.é¡å‹ === 'fullTime' ? 'æ­£è·' : 'å…¼è·';
                const areaText = employee.å€åŸŸ === 'front' ? 'å¤–å ´' : 'å…§å ´';
                
                const row = [employee.å§“å];
                if (!hideTypeArea) {
                    row.push(typeText, areaText);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    let value = stateManager.scheduleData.schedules[scheduleKey]?.[employee.å§“å]?.[day] ?? null;
                    
                    if (filterDefaults) {
                        if (employee.é¡å‹ === 'fullTime' && (value === null || value === 'ä¸Šç­')) {
                            value = '';
                        } else if (employee.é¡å‹ === 'partTime' && (value === null || value === 'ä¼‘æ¯')) {
                            value = '';
                        }
                    } else {
                        if (value === null || value === '') {
                            value = (employee.é¡å‹ === 'fullTime' ? 'ä¸Šç­' : 'ä¼‘æ¯');
                        }
                    }
                    
                    row.push(value ?? '');
                }

                csv += row.join(',') + '\n';
            });

            return csv;
        }

        function importSchedule(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                showNotification('è«‹é¸æ“‡ CSV æª”æ¡ˆ', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parseAndAdoptCSV(e.target.result);
                } catch (error) {
                    showNotification(`CSV è®€å–å¤±æ•—ï¼š${error.message}`, 'error');
                }
            };
            reader.readAsText(file, 'utf-8');
            event.target.value = '';
        }

        function parseAndAdoptCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('CSV æ ¼å¼ä¸æ­£ç¢º');
            }

            const headers = lines[0].split(',').map(header => header.trim());
            const hasTypeArea = (headers[1] === 'é¡å‹' && headers[2] === 'å€åŸŸ');
            const dataStartIndex = hasTypeArea ? 3 : 1;
            const dateColumns = headers.slice(dataStartIndex);
            
            let targetYear = currentYear;
            let targetMonth = null;

            if (dateColumns.length > 0) {
                const match = dateColumns[0].match(/(\d+)\/(\d+)/);
                if (match) {
                    targetMonth = parseInt(match[1], 10);
                } else {
                    throw new Error('æ—¥æœŸæ¬„ä½æ ¼å¼éŒ¯èª¤');
                }
            }

            const scheduleKey = `${targetYear}-${targetMonth}`;
            const existingEmployees = Object.fromEntries(
                stateManager.scheduleData.employees.map(emp => [emp.å§“å, emp])
            );

            const newEmployees = [...stateManager.scheduleData.employees];
            const schedules = { [scheduleKey]: {} };

            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(',').map(cell => cell.trim());
                if (cells.length < dataStartIndex + 1) continue;

                const employeeName = cells[0];
                if (!employeeName) continue;

                let employeeType = 'fullTime';
                let employeeArea = 'front';

                if (hasTypeArea) {
                    employeeType = cells[1] === 'å…¼è·' ? 'partTime' : 'fullTime';
                    employeeArea = cells[2] === 'å…§å ´' ? 'back' : 'front';
                } else if (existingEmployees[employeeName]) {
                    employeeType = existingEmployees[employeeName].é¡å‹;
                    employeeArea = existingEmployees[employeeName].å€åŸŸ;
                } else {
                    newEmployees.push({ å§“å: employeeName, é¡å‹: employeeType, å€åŸŸ: employeeArea });
                }

                schedules[scheduleKey][employeeName] = {};

                for (let j = dataStartIndex; j < cells.length && j < headers.length; j++) {
                    const dayMatch = headers[j].match(/\d+\/(\d+)/);
                    if (!dayMatch) continue;

                    const day = parseInt(dayMatch[1], 10);
                    const cellValue = cells[j];
                    let scheduleValue = null;

                    if (cellValue && !['ä¸Šç­', 'ä¼‘æ¯', ''].includes(cellValue)) {
                        scheduleValue = cellValue;
                    }

                    schedules[scheduleKey][employeeName][day] = scheduleValue;
                }
            }

            // æ›´æ–°å‰ç«¯ç‹€æ…‹
            stateManager.scheduleData.employees = newEmployees;
            stateManager.scheduleData.schedules[scheduleKey] = schedules[scheduleKey];
            
            currentYear = targetYear;
            currentMonth = targetMonth;
            
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;

            ensureScheduleData(currentYear, currentMonth);
            updateCalendar();
            updateEmployeeGrid();

            showNotification('CSV å·²è¼‰å…¥ï¼Œè«‹æŒ‰ã€Œæœ¬æœˆä¸€éµä¸Šå‚³ã€åŒæ­¥è‡³é›²ç«¯', 'success');
        }

        /* ========= çµ±è¨ˆåŠŸèƒ½ ========= */
        function updateStats() {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = '';

            if (!stateManager.scheduleData.employees.length) {
                statsContainer.innerHTML = '<p style="text-align:center;color:#666;grid-column:1/-1;">ç›®å‰æ²’æœ‰å“¡å·¥è³‡æ–™</p>';
                return;
            }

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const scheduleKey = `${currentYear}-${currentMonth}`;
            
            let totalWork = 0;
            let totalNight = 0;
            let totalHoliday = 0;
            let totalOff = 0;

            stateManager.scheduleData.employees.forEach(employee => {
                for (let day = 1; day <= daysInMonth; day++) {
                    const schedule = stateManager.scheduleData.schedules[scheduleKey]?.[employee.å§“å]?.[day] ?? null;
                    
                    if (schedule === null) {
                        if (employee.é¡å‹ === 'fullTime') {
                            totalWork++;
                        } else {
                            totalOff++;
                        }
                    } else {
                        const shift = stateManager.shiftSettings.allShifts.find(s => s.name === schedule);
                        if (shift) {
                            switch (shift.category) {
                                case 'work': totalWork++; break;
                                case 'night': totalNight++; break;
                                case 'holiday': totalHoliday++; break;
                                case 'off': totalOff++; break;
                            }
                        }
                    }
                }
            });

            const stats = [
                { label: 'ç¸½å“¡å·¥æ•¸', value: stateManager.scheduleData.employees.length },
                { label: 'ç¸½å·¥ä½œå¤©æ•¸', value: totalWork + totalNight },
                { label: 'ç¸½å¤œç­å¤©æ•¸', value: totalNight },
                { label: 'ç¸½ä¼‘å‡å¤©æ•¸', value: totalHoliday },
                { label: 'ç¸½ä¼‘æ¯å¤©æ•¸', value: totalOff },
                { label: 'å¹³å‡å·¥ä½œå¤©/äºº', value: Math.round((totalWork + totalNight) / Math.max(1, stateManager.scheduleData.employees.length)) }
            ];

            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                statsContainer.appendChild(card);
            });
        }

        /* ========= æ¨¡æ…‹æ¡†æ§åˆ¶ ========= */
        function closeModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingAction = null;
            pendingActionData = null;
        }

        function confirmAction() {
            if (pendingAction === 'removeEmployee') {
                removeEmployeeCloud(pendingActionData).finally(() => closeModal());
            } else {
                closeModal();
            }
        }

        /* ========= äº‹ä»¶è™•ç† ========= */
        function handleModalClick(event) {
            const modals = ['confirmModal', 'employeeModal', 'shiftSettingsModal'];
            modals.forEach(modalId => {
                if (event.target.id === modalId) {
                    const closeFunction = modalId === 'confirmModal' ? closeModal :
                                       modalId === 'employeeModal' ? closeEmployeeModal :
                                       closeShiftSettingsModal;
                    closeFunction();
                }
            });
        }

        function handleKeyPress(event) {
            // ESC éµé—œé–‰æ¨¡æ…‹æ¡†
            if (event.key === 'Escape') {
                closeModal();
                closeEmployeeModal();
                closeShiftSettingsModal();
                closeEditDropdown();
            }
        }

        /* ========= é›¢ç·šæ”¯æ´ ========= */
        function setupOfflineSupport() {
            // è¨»å†Š Service Workerï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker è¨»å†ŠæˆåŠŸ');
                    })
                    .catch(error => {
                        console.log('Service Worker è¨»å†Šå¤±æ•—:', error);
                    });
            }

            // ç›£è½é€£ç·šç‹€æ…‹è®ŠåŒ–
            window.addEventListener('online', () => {
                showNotification('ç¶²è·¯é€£ç·šå·²æ¢å¾©', 'success');
                setConnPill('ok', 'å·²é€£ç·š');
            });

            window.addEventListener('offline', () => {
                showNotification('ç¶²è·¯é€£ç·šä¸­æ–·ï¼Œæ“ä½œå°‡åœ¨é€£ç·šå¾Œè‡ªå‹•åŒæ­¥', 'warning');
                setConnPill('off', 'é›¢ç·š');
            });
        }

        /* ========= æ•ˆèƒ½å„ªåŒ– ========= */
        function setupPerformanceOptimizations() {
            // è™›æ“¬åŒ–å¤§å‹æ¸…å–®ï¼ˆç•¶å“¡å·¥æ•¸é‡è¶…é 50 æ™‚ï¼‰
            if (stateManager.scheduleData.employees.length > 50) {
                console.log('å•Ÿç”¨è™›æ“¬åŒ–åˆ—è¡¨');
                // é€™è£¡å¯ä»¥å¯¦ä½œè™›æ“¬æ»¾å‹•é‚è¼¯
            }

            // é˜²æŠ–å‹•çš„è¦–çª—å¤§å°èª¿æ•´
            const debouncedResize = debounce(() => {
                repositionDropdown();
            }, 250);

            window.addEventListener('resize', debouncedResize);
        }

        /* ========= å¯è¨ªå•æ€§å¢å¼· ========= */
        function setupAccessibility() {
            // ç‚ºå‹•æ…‹å…ƒç´ æ·»åŠ  ARIA æ¨™ç±¤
            document.addEventListener('focus', (event) => {
                if (event.target.classList.contains('staff-item') && event.target.classList.contains('editable')) {
                    event.target.setAttribute('aria-label', `ç·¨è¼¯ ${event.target.textContent} çš„æ’ç­`);
                }
            }, true);

            // éµç›¤å°èˆªæ”¯æ´
            document.addEventListener('keydown', (event) => {
                if (event.target.classList.contains('staff-item') && event.target.classList.contains('editable')) {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        event.target.click();
                    }
                }
            });
        }

        /* ========= é–‹ç™¼è€…å·¥å…· ========= */
        function setupDeveloperTools() {
            // åªåœ¨é–‹ç™¼æ¨¡å¼ä¸‹é¡¯ç¤º
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                console.log('é–‹ç™¼æ¨¡å¼ï¼šå•Ÿç”¨é¡å¤–çš„èª¿è©¦åŠŸèƒ½');
                
                // å…¨åŸŸé™¤éŒ¯å‡½æ•¸
                window.debugSchedule = {
                    getState: () => stateManager,
                    getCache: () => stateManager.cache,
                    clearCache: () => stateManager.clearCache(),
                    getPendingOps: () => stateManager.pendingOperations,
                    getErrorLog: () => JSON.parse(localStorage.getItem('errorLog') || '[]'),
                    clearErrorLog: () => localStorage.removeItem('errorLog')
                };
            }
        }

        /* ========= è‡ªå‹•å‚™ä»½ ========= */
        function setupAutoBackup() {
            // æ¯å°æ™‚è‡ªå‹•å‚™ä»½ä¸€æ¬¡ï¼ˆåƒ…ç®¡ç†å“¡æ¨¡å¼ï¼‰
            setInterval(async () => {
                if (currentRole === 'admin' && stateManager.isOnline) {
                    try {
                        await callApi('backup', {});
                        console.log('è‡ªå‹•å‚™ä»½å®Œæˆ');
                    } catch (error) {
                        console.error('è‡ªå‹•å‚™ä»½å¤±æ•—:', error);
                    }
                }
            }, 3600000); // 1å°æ™‚
        }

        /* ========= æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ========= */
        async function initializeApp() {
            try {
                // è¨­å®šåŸºæœ¬åŠŸèƒ½
                loadTaiwanHolidays();
                updateRoleDisplay();
                setupOfflineSupport();
                setupPerformanceOptimizations();
                setupAccessibility();
                setupDeveloperTools();
                setupAutoBackup();

                // è¨­å®šæ—¥æœŸé¸æ“‡å™¨
                document.getElementById('yearSelect').value = currentYear;
                document.getElementById('monthSelect').value = currentMonth;

                // è¼‰å…¥åˆå§‹è³‡æ–™
                await loadMonth(currentYear, currentMonth);
                
                showNotification('ç³»çµ±åˆå§‹åŒ–å®Œæˆ', 'success', 3000);

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showNotification(
                    'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢',
                    'error',
                    10000
                );

                // å»ºç«‹ç©ºç™½ç‹€æ…‹é¿å…ç™½å±
                stateManager.scheduleData = {
                    employees: [],
                    schedules: { [`${currentYear}-${currentMonth}`]: {} }
                };
                stateManager.shiftSettings = { allShifts: [] };
                updateCalendar();
            }
        }

        /* ========= äº‹ä»¶ç›£è½å™¨è¨­å®š ========= */
        function setupEventListeners() {
            // æ¨¡æ…‹æ¡†é»æ“Šäº‹ä»¶
            document.addEventListener('pointerdown', handleModalClick);
            
            // éµç›¤äº‹ä»¶
            document.addEventListener('keydown', handleKeyPress);
            
            // é˜²æ­¢æ„å¤–é›¢é–‹é é¢
            window.addEventListener('beforeunload', (event) => {
                if (stateManager.pendingOperations.length > 0) {
                    event.preventDefault();
                    event.returnValue = 'æ‚¨æœ‰æœªåŒæ­¥çš„æ“ä½œï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                }
            });

            // å¯è¦‹æ€§è®ŠåŒ–è™•ç†ï¼ˆé é¢åˆ‡æ›æ™‚æš«åœ/æ¢å¾©ï¼‰
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // é é¢éš±è—æ™‚æš«åœä¸€äº›æ“ä½œ
                    console.log('é é¢å·²éš±è—');
                } else {
                    // é é¢é‡æ–°å¯è¦‹æ™‚æ¢å¾©æ“ä½œ
                    console.log('é é¢é‡æ–°å¯è¦‹');
                    repositionDropdown();
                }
            });
        }

        /* ========= DOM å…§å®¹è¼‰å…¥å®Œæˆ ========= */
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeApp();
        });

        /* ========= å…¨åŸŸéŒ¯èª¤è™•ç† ========= */
        window.addEventListener('error', (event) => {
            ErrorTracker.track(new Error(event.message), {
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            ErrorTracker.track(event.reason, {
                type: 'unhandledPromiseRejection'
            });
        });

        /* ========= åŒ¯å‡ºå…¨åŸŸå‡½æ•¸ä¾› HTML ä½¿ç”¨ ========= */
        window.toggleRole = toggleRole;
        window.showTab = showTab;
        window.changeYearMonth = changeYearMonth;
        window.toggleEditMode = toggleEditMode;
        window.exportSchedule = exportSchedule;
        window.importSchedule = importSchedule;
        window.saveAllToCloud = saveAllToCloud;
        window.clearAllScheduleCloud = clearAllScheduleCloud;
        window.backupData = backupData;
        window.showEmployeeModal = showEmployeeModal;
        window.closeEmployeeModal = closeEmployeeModal;
        window.addEmployeeFromModal = addEmployeeFromModal;
        window.showShiftSettingsModal = showShiftSettingsModal;
        window.closeShiftSettingsModal = closeShiftSettingsModal;
        window.addEnhancedShift = addEnhancedShift;
        window.closeModal = closeModal;
        window.confirmAction = confirmAction;
    </script>
</body>

</html>
